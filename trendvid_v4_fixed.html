<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TrendVid AI â€” Spot the Trend. Own the Moment.</title>
<!-- SEO & Social -->
<meta name="description" content="TrendVid AI â€” The #1 AI studio for content creators. Spot viral trends, generate scripts, create thumbnails, plan your content calendar, and grow your channel. Powered by Groq AI.">
<meta name="keywords" content="AI content creator, YouTube script generator, TikTok trends, viral content, thumbnail generator, content calendar, hashtag generator">
<meta name="author" content="TrendVid AI">
<meta name="robots" content="index, follow">
<!-- Open Graph / Social Preview -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://trendvid.ai/">
<meta property="og:title" content="TrendVid AI â€” Spot the Trend. Own the Moment.">
<meta property="og:description" content="The #1 AI studio for content creators. Scripts, thumbnails, trends, and more â€” powered by AI.">
<meta property="og:image" content="https://trendvid.ai/og-image.jpg">
<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@trendvidai">
<meta name="twitter:title" content="TrendVid AI â€” Spot the Trend. Own the Moment.">
<meta name="twitter:description" content="The AI studio for creators who want to go viral. Scripts, trends, thumbnails & more.">
<!-- PWA -->
<meta name="theme-color" content="#ff3058">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="TrendVid">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='22' fill='%23060810'/><text y='.9em' font-size='80' x='10'>ðŸŽ¬</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#060810; --surface:#0c0f1a; --surface2:#111520; --surface3:#171c2b;
  --border:#1e2538; --border2:#2a3350;
  --accent:#ff3058; --accent2:#ff7b00; --teal:#00e5b0; --purple:#a78bfa;
  --text:#eef2ff; --text2:#a8b8d8; --muted:#566380;
  --gold:#fbbf24; --diamond:#a8edff; --elite:#c084fc;
  --yt:#ff0000; --ig:#e1306c; --tt:#69C9D0;
  --shadow:0 12px 40px rgba(0,0,0,0.6);
  --shadow-sm:0 3px 16px rgba(0,0,0,0.35);
  --radius:18px; --radius-sm:11px; --radius-lg:24px;
  --transition:0.18s cubic-bezier(0.4,0,0.2,1);
  --glow-red:0 0 36px rgba(255,48,88,0.3);
  --glow-teal:0 0 36px rgba(0,229,176,0.22);
  --font-display:"Syne",sans-serif;
}
[data-theme="light"] {
  --bg:#f2f4fc; --surface:#ffffff; --surface2:#f6f8ff; --surface3:#edf0fb;
  --border:#dde2f5; --border2:#c8d0ea;
  --text:#080c24; --text2:#3a4870; --muted:#6878a0;
  --shadow:0 8px 32px rgba(0,0,0,0.08);
  --shadow-sm:0 2px 12px rgba(0,0,0,0.06);
}
*{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
details summary::-webkit-details-marker{display:none}
details[open] summary span:last-child{transform:rotate(45deg);display:inline-block}
@keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.landing-hero > *{animation:fadeInUp 0.5s ease both}
.landing-hero > *:nth-child(2){animation-delay:0.05s}
.landing-hero > *:nth-child(3){animation-delay:0.1s}
.landing-hero > *:nth-child(4){animation-delay:0.15s}
.landing-hero > *:nth-child(5){animation-delay:0.2s}
body{background:var(--bg);color:var(--text);font-family:"DM Sans",sans-serif;min-height:100vh;overflow-x:hidden;transition:background 0.3s,color 0.3s;}
body.dark-grid::before{content:"";position:fixed;inset:0;background-image:radial-gradient(circle at 20% 50%, rgba(255,48,88,0.04) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(0,229,176,0.03) 0%, transparent 50%), linear-gradient(rgba(255,48,88,0.012) 1px,transparent 1px),linear-gradient(90deg,rgba(255,48,88,0.012) 1px,transparent 1px);background-size:100% 100%,100% 100%,52px 52px,52px 52px;pointer-events:none;z-index:0;}
.app{position:relative;z-index:1;}
a{color:inherit;text-decoration:none;}
button{font-family:"DM Sans",sans-serif;cursor:pointer;}
input,select,textarea{font-family:"DM Sans",sans-serif;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px;}

@keyframes slideUp{from{opacity:0;transform:translateY(28px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:translateX(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
@keyframes shimmer{0%{background-position:-200% center}100%{background-position:200% center}}
@keyframes float{0%,100%{transform:translateY(0) rotate(-1deg)}50%{transform:translateY(-10px) rotate(1deg)}}
@keyframes chatPop{from{opacity:0;transform:scale(0.94) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
@keyframes typingDot{0%,60%,100%{opacity:0.2;transform:translateY(0)}30%{opacity:1;transform:translateY(-3px)}}
@keyframes glowPulse{0%,100%{box-shadow:var(--glow-red)}50%{box-shadow:0 0 60px rgba(255,48,88,0.5)}}
@keyframes countUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes progressFill{from{width:0}to{width:var(--target-w)}}
@keyframes borderGlow{0%,100%{border-color:var(--border)}50%{border-color:rgba(255,48,88,0.4)}}
@keyframes scoreRing{from{stroke-dashoffset:220}to{stroke-dashoffset:var(--target-offset)}}
/* XP LEVEL MAP */
.xp-level-row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;margin-bottom:6px;transition:all 0.2s;}
.xp-level-row:hover{background:var(--surface2);}
.xp-level-row.current{border-color:rgba(255,48,88,0.5);background:rgba(255,48,88,0.06);}
.xp-level-row.unlocked{border-color:var(--border2);}
.xp-level-icon{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.title-equip-btn{background:rgba(0,229,176,0.1);border:1px solid rgba(0,229,176,0.3);color:var(--teal);padding:6px 12px;border-radius:8px;font-size:11px;font-weight:800;cursor:pointer;font-family:var(--font-display);}
.title-equip-btn.active{background:rgba(255,48,88,0.12);border-color:rgba(255,48,88,0.4);color:var(--accent);}
.title-equip-btn:hover{transform:translateY(-1px);}
/* ============================================================
   XP & LEVELS SYSTEM
   ============================================================ */
@keyframes xpPop{0%{transform:scale(1)}40%{transform:scale(1.18)}100%{transform:scale(1)}}
@keyframes leafFall{0%{transform:translateY(-20px) rotate(0deg) translateX(0);opacity:1}100%{transform:translateY(105vh) rotate(720deg) translateX(60px);opacity:0}}
@keyframes rewardPop{0%{opacity:0;transform:scale(0.7) translateY(30px)}60%{transform:scale(1.05) translateY(-4px)}100%{opacity:1;transform:scale(1) translateY(0)}}
@keyframes badgeShine{0%,100%{box-shadow:0 0 0 0 transparent}50%{box-shadow:0 0 20px 4px var(--badge-glow,rgba(251,191,36,0.4))}}
.xp-sidebar-chip{background:linear-gradient(135deg,rgba(251,191,36,0.12),rgba(255,138,0,0.08));border:1px solid rgba(251,191,36,0.3);border-radius:10px;padding:8px 10px;cursor:pointer;transition:all var(--transition);margin-bottom:8px}
.xp-sidebar-chip:hover{border-color:rgba(251,191,36,0.6);transform:translateY(-1px)}
.xp-chip-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px}
.xp-chip-level{font-family:var(--font-display);font-size:12px;font-weight:900;color:var(--gold)}
.xp-chip-badge{font-size:15px}
.xp-chip-bar{height:4px;background:rgba(255,255,255,0.08);border-radius:2px;overflow:hidden}
.xp-chip-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--accent2));border-radius:2px;transition:width 0.6s ease}
.xp-chip-label{font-size:9px;color:var(--muted);font-weight:700;letter-spacing:0.3px;margin-top:3px}
.xp-hero{background:linear-gradient(135deg,rgba(251,191,36,0.08),rgba(255,138,0,0.05),rgba(192,132,252,0.04));border:1px solid rgba(251,191,36,0.2);border-radius:var(--radius-lg);padding:32px;text-align:center;margin-bottom:24px;position:relative;overflow:hidden}
.xp-hero-level{font-family:var(--font-display);font-size:80px;font-weight:900;line-height:1;background:linear-gradient(135deg,var(--gold),var(--accent2),#ff3058);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.xp-hero-badge{font-size:60px;margin-bottom:8px;display:block;animation:float 3s ease infinite}
.xp-bar-wrap{background:rgba(255,255,255,0.06);border-radius:8px;height:16px;overflow:hidden;margin:14px 0;position:relative}
.xp-bar-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--accent2),var(--accent));border-radius:8px;transition:width 1.2s cubic-bezier(0.34,1.56,0.64,1);position:relative}
.xp-bar-fill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.25),transparent);animation:shimmer 2s infinite}
.badges-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-bottom:20px}
.badge-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px 10px;text-align:center;transition:all var(--transition);position:relative;overflow:hidden}
.badge-card.unlocked{border-color:rgba(251,191,36,0.35);animation:badgeShine 4s ease infinite}
.badge-card.locked{opacity:0.3;filter:grayscale(1)}
.badge-card.unlocked:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,0.3)}
.badge-icon{font-size:34px;margin-bottom:6px;display:block}
.badge-name{font-family:var(--font-display);font-size:10px;font-weight:900;letter-spacing:0.5px;margin-bottom:3px}
.badge-desc{font-size:9px;color:var(--muted);line-height:1.4}
.reward-item{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:12px;margin-bottom:8px}
.reward-item-icon{font-size:26px;flex-shrink:0}
.reward-item-label{font-size:13px;font-weight:700}
.reward-item-sub{font-size:11px;color:var(--muted)}
.reward-item-code{font-family:monospace;font-size:12px;font-weight:800;color:var(--teal);letter-spacing:2px;background:rgba(0,229,176,0.1);border:1px solid rgba(0,229,176,0.25);padding:3px 9px;border-radius:8px;cursor:pointer;white-space:nowrap}
.reward-overlay{position:fixed;inset:0;z-index:99990;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(18px);background:rgba(6,8,16,0.88);animation:fadeIn 0.3s ease}
.reward-box{background:var(--surface);border:1px solid var(--border);border-radius:28px;padding:44px 40px;text-align:center;max-width:420px;margin:16px;animation:rewardPop 0.6s cubic-bezier(0.34,1.56,0.64,1) both;position:relative;overflow:hidden}
.reward-box::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 0%,rgba(251,191,36,0.14),transparent 65%);pointer-events:none}
.leaf-particle{position:fixed;pointer-events:none;z-index:99999;font-size:20px;animation:leafFall linear forwards}
/* TIER BADGES ON XP PAGE */
.tier-xp-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-family:var(--font-display);font-size:11px;font-weight:800;letter-spacing:0.5px}
/* TRIAL BANNER */
.trial-banner{background:linear-gradient(135deg,rgba(251,191,36,0.12),rgba(255,138,0,0.08));border:1px solid rgba(251,191,36,0.35);border-radius:14px;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px;animation:slideUp 0.4s ease}
.trial-banner-left{display:flex;align-items:center;gap:12px}
.trial-banner-days{font-family:var(--font-display);font-size:32px;font-weight:900;color:var(--gold);line-height:1}
.trial-banner-text{font-size:13px;font-weight:600;color:var(--text)}
.trial-banner-sub{font-size:11px;color:var(--muted);margin-top:2px}
/* ONBOARDING CHECKLIST */
.checklist-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:20px;animation:slideUp 0.4s 0.1s ease both}
.checklist-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:all var(--transition)}
.checklist-item:last-child{border-bottom:none}
.checklist-item:hover{padding-left:4px}
.checklist-item.done .checklist-circle{background:var(--teal);border-color:var(--teal)}
.checklist-item.done .checklist-label{color:var(--muted);text-decoration:line-through}
.checklist-circle{width:22px;height:22px;border-radius:50%;border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;transition:all 0.3s ease}
.checklist-label{font-size:13px;font-weight:600;flex:1}
.checklist-xp{font-size:10px;font-weight:800;color:var(--gold);font-family:var(--font-display);padding:2px 8px;background:rgba(251,191,36,0.1);border-radius:8px}
.checklist-progress{height:6px;background:var(--border);border-radius:3px;margin-bottom:12px;overflow:hidden}
.checklist-progress-fill{height:100%;background:linear-gradient(90deg,var(--teal),var(--accent));border-radius:3px;transition:width 0.6s ease}
/* STRIPE SUCCESS OVERLAY */
.stripe-success-overlay{position:fixed;inset:0;background:rgba(6,8,16,0.9);z-index:99999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(12px);animation:fadeIn 0.4s ease}
.stripe-success-box{background:var(--surface);border:1px solid var(--border);border-radius:28px;padding:48px;text-align:center;max-width:420px;margin:16px;animation:slideUp 0.5s cubic-bezier(0.34,1.56,0.64,1) both}
/* YOUTUBE ANALYSER */
.yt-analyse-result{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-top:16px;animation:slideUp 0.4s ease}
.yt-metric-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin:14px 0}
.yt-metric{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center}
.yt-metric-val{font-family:var(--font-display);font-size:22px;font-weight:800;color:var(--accent)}
.yt-metric-label{font-size:10px;color:var(--muted);font-weight:700;letter-spacing:0.5px;margin-top:3px}
/* DESCRIPTION GENERATOR */
.desc-section{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px}
.desc-section-label{font-size:10px;font-weight:800;letter-spacing:1.5px;color:var(--muted);font-family:var(--font-display);margin-bottom:8px}
/* THUMBNAIL AB TESTER */
.thumb-ab-drop{border:2px dashed var(--border2);border-radius:var(--radius);padding:32px;text-align:center;cursor:pointer;transition:all var(--transition);background:var(--surface2)}
.thumb-ab-drop:hover{border-color:var(--accent);background:rgba(255,48,88,0.04)}
.thumb-ab-winner{border:2px solid var(--teal)!important;background:rgba(0,229,176,0.05)!important}
/* COLLAB FINDER */
.collab-card{background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:16px;display:flex;gap:14px;align-items:flex-start;transition:all var(--transition)}
.collab-card:hover{border-color:var(--border2);transform:translateY(-2px)}
.collab-avatar{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
/* POST SCHEDULER */
.schedule-week{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin:16px 0}
.schedule-day{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:8px;text-align:center;cursor:pointer;transition:all var(--transition);min-height:70px}
.schedule-day:hover{border-color:var(--accent);background:rgba(255,48,88,0.04)}
.schedule-day.has-post{border-color:var(--teal);background:rgba(0,229,176,0.07)}
.schedule-day-name{font-size:9px;font-weight:800;color:var(--muted);letter-spacing:1px;font-family:var(--font-display)}
.schedule-day-num{font-family:var(--font-display);font-size:18px;font-weight:800;margin:2px 0}
.schedule-post-dot{width:6px;height:6px;border-radius:50%;background:var(--teal);margin:3px auto}

/* TITLE CARDS */
.title-card{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:12px 16px;transition:all var(--transition);}
.title-card.title-unlocked{background:var(--surface);border-color:var(--border2);}
.title-card.title-unlocked:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.3);}
.title-card.title-active{border-width:2px;box-shadow:0 0 20px rgba(255,48,88,0.2);}
/* XP MOBILE SIDEBAR chip */
.xp-sidebar-chip-mobile{background:linear-gradient(135deg,rgba(251,191,36,0.12),rgba(255,138,0,0.08));border:1px solid rgba(251,191,36,0.3);border-radius:10px;padding:8px 10px;cursor:pointer;transition:all var(--transition);margin-bottom:8px;}
/* BADGE MILESTONE highlight */
.badge-card.badge-milestone.unlocked{border-color:rgba(255,138,0,0.5);box-shadow:0 0 20px rgba(255,138,0,0.15);}

.hidden{display:none!important;}
.flex{display:flex;align-items:center;}
.gap-8{gap:8px;}.gap-12{gap:12px;}.gap-16{gap:16px;}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:10px 22px;border-radius:var(--radius-sm);font-size:13px;font-weight:700;cursor:pointer;border:none;transition:all var(--transition);white-space:nowrap;letter-spacing:0.3px;font-family:var(--font-display);}
.btn:hover{transform:translateY(-2px);}
.btn:active{transform:scale(0.97);}
.btn-primary{background:linear-gradient(135deg,var(--accent) 0%,#b8002e 100%);color:#fff;box-shadow:0 4px 24px rgba(255,48,88,0.4);}
.btn-primary:hover{box-shadow:0 8px 32px rgba(255,48,88,0.55);}
.btn-secondary{background:var(--surface2);border:1px solid var(--border);color:var(--text);}
.btn-secondary:hover{border-color:var(--border2);background:var(--surface3);}
.btn-teal{background:linear-gradient(135deg,var(--teal),#00a87e);color:#000;font-weight:800;box-shadow:0 4px 22px rgba(0,229,176,0.3);}
.btn-purple{background:linear-gradient(135deg,var(--purple),#7c3aed);color:#fff;box-shadow:0 4px 22px rgba(167,139,250,0.35);}
.btn-gold{background:linear-gradient(135deg,var(--gold),#d97706);color:#0a0800;}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text2);}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);background:rgba(255,48,88,0.05);}
.btn-sm{padding:6px 14px;font-size:11px;}
.btn-lg{padding:14px 30px;font-size:15px;}
.btn-xl{padding:18px 40px;font-size:16px;border-radius:16px;}

/* BADGES */
.badge{display:inline-flex;align-items:center;gap:4px;font-size:9px;font-weight:800;padding:3px 9px;border-radius:20px;letter-spacing:1px;text-transform:uppercase;font-family:var(--font-display);}
.badge-live{background:rgba(0,229,176,0.12);color:var(--teal);border:1px solid rgba(0,229,176,0.3);}
.badge-hot{background:rgba(255,48,88,0.12);color:var(--accent);border:1px solid rgba(255,48,88,0.3);}
.badge-rising{background:rgba(251,191,36,0.12);color:var(--gold);border:1px solid rgba(251,191,36,0.3);}
.badge-new{background:rgba(167,139,250,0.12);color:var(--purple);border:1px solid rgba(167,139,250,0.3);}
.chip{display:inline-flex;align-items:center;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:2px 8px;font-size:11px;color:var(--muted);}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px;}
.card-sm{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;}
.card-hover{transition:all var(--transition);}
.card-hover:hover{transform:translateY(-3px);border-color:var(--border2);box-shadow:var(--shadow);}

/* TYPOGRAPHY */
.section-label{font-size:9px;font-weight:800;letter-spacing:3px;color:var(--muted);text-transform:uppercase;font-family:var(--font-display);}
.page-title{font-family:var(--font-display);font-size:24px;font-weight:800;letter-spacing:-0.5px;}

/* TIER BADGES */
.tier-badge{font-size:9px;font-weight:900;padding:2px 9px;border-radius:10px;letter-spacing:0.8px;font-family:var(--font-display);}
.tier-free{background:rgba(86,99,128,0.2);color:var(--muted);border:1px solid var(--border);}
.tier-starter{background:rgba(0,229,176,0.14);color:var(--teal);border:1px solid rgba(0,229,176,0.3);}
.tier-pro{background:rgba(255,48,88,0.14);color:var(--accent);border:1px solid rgba(255,48,88,0.3);}
.tier-gold{background:linear-gradient(135deg,var(--gold),#d97706);color:#0a0800;}
.tier-elite{background:linear-gradient(135deg,var(--elite),#7c3aed);color:#fff;}

/* TIER GATE OVERLAY */
.tier-gate{position:relative;overflow:hidden;}
.tier-gate-overlay{position:absolute;inset:0;background:rgba(6,8,16,0.88);backdrop-filter:blur(6px);z-index:10;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;border-radius:var(--radius);text-align:center;padding:24px;}
.tier-gate-icon{font-size:36px;}
.tier-gate-title{font-family:var(--font-display);font-size:15px;font-weight:800;}
.tier-gate-sub{font-size:12px;color:var(--text2);max-width:260px;line-height:1.5;}
.tier-gate-badge{display:inline-flex;align-items:center;gap:5px;font-size:10px;font-weight:900;padding:4px 12px;border-radius:20px;letter-spacing:0.8px;font-family:var(--font-display);}

/* PRICING PAGE */
.pricing-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;}
@media(max-width:1200px){.pricing-grid{grid-template-columns:repeat(3,1fr);}}
@media(max-width:768px){.pricing-grid{grid-template-columns:1fr;}}
.pricing-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:22px;position:relative;transition:all var(--transition);display:flex;flex-direction:column;}
.pricing-card:hover{transform:translateY(-4px);box-shadow:var(--shadow);}
.pricing-card.current-plan{border-width:2px;}
.pricing-card.recommended{border-width:2px;}
.pricing-card-header{margin-bottom:18px;}
.pricing-plan-name{font-family:var(--font-display);font-size:18px;font-weight:800;letter-spacing:1px;margin-bottom:4px;}
.pricing-plan-desc{font-size:11px;color:var(--muted);line-height:1.4;}
.pricing-price{font-family:var(--font-display);font-size:34px;font-weight:800;letter-spacing:-1px;margin:12px 0 4px;}
.pricing-price span{font-size:14px;font-weight:500;color:var(--muted);}
.pricing-features{flex:1;margin:14px 0;display:flex;flex-direction:column;gap:7px;}
.pricing-feat{display:flex;align-items:flex-start;gap:7px;font-size:12px;color:var(--text2);}
.pricing-feat.locked{color:var(--muted);opacity:0.5;}
.pricing-feat-check{font-size:12px;flex-shrink:0;margin-top:1px;}
.pricing-recommended-badge{position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-size:9px;font-weight:900;padding:4px 14px;border-radius:20px;white-space:nowrap;font-family:var(--font-display);letter-spacing:1px;}
.pricing-current-badge{position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:var(--teal);color:#000;font-size:9px;font-weight:900;padding:4px 14px;border-radius:20px;white-space:nowrap;font-family:var(--font-display);letter-spacing:1px;}

/* SPINNER */
.spinner{width:18px;height:18px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin 0.75s linear infinite;flex-shrink:0;}
.spinner-sm{width:14px;height:14px;}
.spinner-lg{width:28px;height:28px;border-width:3px;}

/* FORMS */
.form-field{margin-bottom:14px;}
.form-field label{display:block;font-size:9px;font-weight:800;color:var(--muted);letter-spacing:2px;margin-bottom:7px;text-transform:uppercase;font-family:var(--font-display);}
.form-input{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:11px 14px;border-radius:var(--radius-sm);font-size:13.5px;outline:none;transition:all var(--transition);}
.form-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,48,88,0.1);}
.form-input::placeholder{color:var(--muted);}
.form-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%235e6e8a' stroke-width='2.5'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;}
.divider{height:1px;background:var(--border);margin:12px 0;}
.toggle{width:44px;height:24px;background:var(--border2);border-radius:12px;cursor:pointer;position:relative;transition:background var(--transition);border:none;flex-shrink:0;}
.toggle.on{background:linear-gradient(90deg,var(--teal),#00a87e);}
.toggle::after{content:"";position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:3px;left:3px;transition:transform var(--transition);box-shadow:0 1px 6px rgba(0,0,0,0.3);}
.toggle.on::after{transform:translateX(20px);}

/* NOTIFICATIONS */
.notif{position:fixed;bottom:28px;right:28px;background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:14px 20px;font-size:13px;transform:translateY(100px);opacity:0;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1);z-index:99999;max-width:340px;display:flex;align-items:center;gap:11px;box-shadow:var(--shadow);}
.notif.show{transform:translateY(0);opacity:1;}
.notif.success{border-color:var(--teal);background:linear-gradient(135deg,var(--surface),rgba(0,229,176,0.06));}
.notif.error{border-color:var(--accent);background:linear-gradient(135deg,var(--surface),rgba(255,48,88,0.06));}
.notif.info{border-color:var(--purple);}

/* ============================
   LANDING PAGE
   ============================ */
#landingPage{position:fixed;inset:0;background:var(--bg);z-index:9999;overflow-y:auto;display:flex;flex-direction:column;}
.landing-nav{display:flex;align-items:center;justify-content:space-between;padding:18px 52px;border-bottom:1px solid var(--border);backdrop-filter:blur(20px);background:rgba(6,8,16,0.88);position:sticky;top:0;z-index:10;flex-shrink:0;}
[data-theme="light"] .landing-nav{background:rgba(242,244,252,0.92);}
.landing-logo{font-family:var(--font-display);font-size:26px;font-weight:800;letter-spacing:4px;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.landing-logo span{-webkit-text-fill-color:var(--teal);}
.landing-nav-right{display:flex;align-items:center;gap:12px;}
#welcomeBanner{animation:slideDown 0.4s ease!important;}
#welcomeBanner button:hover{color:var(--text)!important;}
@keyframes slideDown{from{opacity:0;transform:translateX(-50%) translateY(-30px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.ai-thinking{display:flex;align-items:center;gap:14px;padding:40px;color:var(--muted);}
.landing-hero{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:110px 24px 90px;position:relative;overflow:hidden;}
.hero-orb{position:absolute;border-radius:50%;filter:blur(90px);pointer-events:none;}
.hero-orb-1{width:700px;height:700px;background:radial-gradient(circle,rgba(255,48,88,0.1),transparent 70%);top:-250px;left:50%;transform:translateX(-50%);}
.hero-orb-2{width:450px;height:450px;background:radial-gradient(circle,rgba(0,229,176,0.08),transparent 70%);bottom:-120px;right:-100px;}
.hero-orb-3{width:350px;height:350px;background:radial-gradient(circle,rgba(167,139,250,0.07),transparent 70%);bottom:-80px;left:-80px;}
.landing-eyebrow{display:inline-flex;align-items:center;gap:8px;background:rgba(255,48,88,0.08);border:1px solid rgba(255,48,88,0.2);border-radius:20px;padding:7px 18px;font-size:11px;color:var(--accent);font-weight:800;margin-bottom:30px;animation:slideUp 0.5s ease both;letter-spacing:1px;font-family:var(--font-display);}
.landing-h1{font-family:var(--font-display);font-size:clamp(54px,9vw,110px);font-weight:800;letter-spacing:-2px;line-height:0.92;margin-bottom:24px;animation:slideUp 0.5s 0.1s ease both;}
.landing-h1 .grad{background:linear-gradient(90deg,var(--accent),var(--accent2),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-size:200% auto;animation:shimmer 4s linear infinite;}
.landing-sub{font-size:18px;color:var(--text2);max-width:580px;line-height:1.75;margin-bottom:44px;animation:slideUp 0.5s 0.2s ease both;}
.landing-ctas{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;animation:slideUp 0.5s 0.3s ease both;}
.landing-stats{display:flex;gap:44px;flex-wrap:wrap;justify-content:center;margin-top:66px;animation:slideUp 0.5s 0.4s ease both;padding:26px 36px;background:var(--surface);border:1px solid var(--border);border-radius:22px;backdrop-filter:blur(12px);}
.stat-item{text-align:center;}
.stat-num{font-family:var(--font-display);font-size:38px;font-weight:800;letter-spacing:-1px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.stat-label{font-size:10px;color:var(--muted);font-weight:700;letter-spacing:1px;text-transform:uppercase;font-family:var(--font-display);}
.landing-features{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:30px;animation:slideUp 0.5s 0.5s ease both;}
.landing-feat{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:11px;padding:10px 18px;font-size:12px;color:var(--text2);transition:all var(--transition);font-weight:600;}
.landing-feat:hover{border-color:var(--border2);color:var(--text);transform:translateY(-2px);}
.landing-feat span{font-size:15px;}

/* ============================
   MAIN APP LAYOUT
   ============================ */
#mainApp{display:none;}
.sidebar{width:236px;flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);height:100vh;overflow-y:auto;position:sticky;top:0;display:flex;flex-direction:column;}
.sidebar-logo{padding:24px 20px 18px;border-bottom:1px solid var(--border);}
.sidebar-logo-text{font-family:var(--font-display);font-size:24px;font-weight:800;letter-spacing:4px;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.sidebar-logo-text span{-webkit-text-fill-color:var(--teal);}
.sidebar-tagline{font-size:9px;color:var(--muted);margin-top:3px;letter-spacing:1.5px;text-transform:uppercase;font-family:var(--font-display);}
.ai-status-pill{display:flex;align-items:center;gap:6px;background:rgba(0,229,176,0.08);border:1px solid rgba(0,229,176,0.22);border-radius:20px;padding:4px 11px;font-size:9px;color:var(--teal);font-weight:800;margin-top:10px;width:fit-content;letter-spacing:0.8px;font-family:var(--font-display);}
.ai-status-dot{width:5px;height:5px;background:var(--teal);border-radius:50%;animation:pulse 2s infinite;}
.sidebar-nav{padding:12px 10px;flex:1;}
.sidebar-section{font-size:8px;font-weight:900;letter-spacing:3px;color:var(--muted);padding:10px 12px 4px;margin-top:2px;text-transform:uppercase;font-family:var(--font-display);}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:10px;font-size:13px;font-weight:600;color:var(--text2);cursor:pointer;transition:all var(--transition);border:none;background:none;width:100%;text-align:left;}
.nav-item:hover{background:var(--surface2);color:var(--text);}
.nav-item.active{background:linear-gradient(90deg,rgba(255,48,88,0.12),rgba(255,48,88,0.04));color:var(--accent);font-weight:700;border-left:2px solid var(--accent);padding-left:10px;}
.nav-item.active .icon{filter:drop-shadow(0 0 5px rgba(255,48,88,0.6));}
.nav-item .icon{font-size:15px;width:20px;text-align:center;flex-shrink:0;}
.nav-badge{margin-left:auto;background:var(--accent);color:#fff;font-size:8px;font-weight:900;padding:1px 7px;border-radius:10px;font-family:var(--font-display);}
.sidebar-bottom{padding:12px;border-top:1px solid var(--border);}
.user-chip{display:flex;align-items:center;gap:10px;padding:11px;background:var(--surface2);border-radius:13px;cursor:pointer;transition:all var(--transition);border:1px solid var(--border);}
.user-chip:hover{background:var(--surface3);border-color:var(--border2);}
.user-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;box-shadow:0 0 0 2px rgba(255,48,88,0.35);}
.user-info{flex:1;min-width:0;}
.user-name{font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.user-plan{font-size:10px;color:var(--muted);margin-top:1px;}
.main-content{flex:1;overflow-y:auto;display:flex;flex-direction:column;min-width:0;}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 30px;border-bottom:1px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:50;backdrop-filter:blur(16px);}
.topbar-left{display:flex;align-items:center;gap:12px;}
.topbar-title{font-family:var(--font-display);font-size:20px;font-weight:800;letter-spacing:-0.3px;}
.topbar-right{display:flex;align-items:center;gap:8px;}
.icon-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text2);width:36px;height:36px;border-radius:9px;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;transition:all var(--transition);}
.icon-btn:hover{border-color:var(--border2);color:var(--text);background:var(--surface3);}
.provider-badge{display:flex;align-items:center;gap:5px;font-size:9px;font-weight:900;padding:5px 12px;border-radius:20px;background:rgba(0,229,176,0.08);border:1px solid rgba(0,229,176,0.25);color:var(--teal);letter-spacing:0.5px;font-family:var(--font-display);}
.provider-badge.offline{background:rgba(255,48,88,0.08);border-color:rgba(255,48,88,0.25);color:var(--accent);}
.provider-dot{width:5px;height:5px;border-radius:50%;background:currentColor;animation:pulse 2s infinite;}
.page-content{padding:30px;flex:1;}

/* ============================
   DASHBOARD
   ============================ */
.dashboard-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;}
@media(max-width:1100px){.dashboard-grid{grid-template-columns:repeat(2,1fr);}}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;position:relative;overflow:hidden;transition:all var(--transition);}
.stat-card:hover{border-color:var(--border2);transform:translateY(-2px);box-shadow:var(--shadow-sm);}
.stat-card::before{content:"";position:absolute;top:0;left:0;right:0;height:3px;border-radius:var(--radius) var(--radius) 0 0;}
.stat-card::after{content:"";position:absolute;top:-40px;right:-40px;width:120px;height:120px;border-radius:50%;opacity:0.04;pointer-events:none;}
.stat-card.red::before{background:linear-gradient(90deg,var(--accent),transparent);}
.stat-card.red::after{background:var(--accent);}
.stat-card.teal::before{background:linear-gradient(90deg,var(--teal),transparent);}
.stat-card.teal::after{background:var(--teal);}
.stat-card.gold::before{background:linear-gradient(90deg,var(--gold),transparent);}
.stat-card.gold::after{background:var(--gold);}
.stat-card.purple::before{background:linear-gradient(90deg,var(--purple),transparent);}
.stat-card.purple::after{background:var(--purple);}
.stat-card-icon{font-size:22px;margin-bottom:12px;}
.stat-card-num{font-family:var(--font-display);font-size:38px;font-weight:800;letter-spacing:-1px;line-height:1;animation:countUp 0.5s ease both;}
.stat-card-label{font-size:10px;color:var(--muted);margin-top:5px;font-weight:700;letter-spacing:0.8px;text-transform:uppercase;font-family:var(--font-display);}
.stat-card-change{font-size:11px;font-weight:700;margin-top:7px;}
.stat-card-change.up{color:var(--teal);}
.stat-card-change.down{color:var(--accent);}
.dash-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:24px;}
@media(max-width:900px){.dash-row{grid-template-columns:1fr;}}
.quick-action{display:flex;align-items:center;gap:12px;padding:14px;background:var(--surface2);border:1px solid var(--border);border-radius:13px;cursor:pointer;transition:all var(--transition);}
.quick-action:hover{border-color:var(--accent);background:rgba(255,48,88,0.04);transform:translateX(4px);}
.quick-action-icon{font-size:22px;width:44px;height:44px;background:var(--surface);border-radius:11px;display:flex;align-items:center;justify-content:center;flex-shrink:0;border:1px solid var(--border);}
.quick-action-title{font-size:13px;font-weight:700;}
.quick-action-desc{font-size:11px;color:var(--muted);margin-top:2px;}
.activity-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);}
.activity-item:last-child{border-bottom:none;}
.activity-icon{font-size:16px;width:36px;height:36px;background:var(--surface2);border-radius:9px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.activity-text{flex:1;font-size:12px;color:var(--text2);line-height:1.4;}
.activity-time{font-size:10px;color:var(--muted);}
.tip-card{background:linear-gradient(135deg,rgba(255,48,88,0.07),rgba(167,139,250,0.07));border:1px solid rgba(255,48,88,0.17);border-radius:var(--radius);padding:20px;}
.tip-card-head{display:flex;align-items:center;gap:8px;font-weight:800;font-size:13px;margin-bottom:8px;font-family:var(--font-display);}
.tip-card-body{font-size:12.5px;color:var(--text2);line-height:1.65;}

/* ============================
   TRENDS
   ============================ */
.trends-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:22px;}
.trends-filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.filter-chip{padding:6px 18px;border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;border:1px solid var(--border);background:var(--surface2);color:var(--muted);transition:all var(--transition);letter-spacing:0.3px;font-family:var(--font-display);}
.filter-chip:hover{border-color:var(--border2);color:var(--text);}
.filter-chip.active{border-color:var(--accent);color:var(--accent);background:rgba(255,48,88,0.09);}
.trends-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(295px,1fr));gap:16px;}
.trend-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;cursor:pointer;transition:all var(--transition);animation:slideUp 0.4s ease both;position:relative;overflow:hidden;}
.trend-card::before{content:"";position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,48,88,0.3),transparent);opacity:0;transition:opacity var(--transition);}
.trend-card:hover{transform:translateY(-4px);border-color:var(--border2);box-shadow:var(--shadow);}
.trend-card:hover::before{opacity:1;}
.trend-platform-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.trend-platform-tag{font-size:9px;font-weight:800;letter-spacing:1.5px;color:var(--muted);display:flex;align-items:center;gap:5px;font-family:var(--font-display);}
.trend-rank{font-family:var(--font-display);font-size:26px;font-weight:800;color:rgba(255,255,255,0.06);position:absolute;top:12px;right:14px;line-height:1;}
.trend-emoji{font-size:30px;margin-bottom:10px;display:block;}
.trend-title{font-size:14px;font-weight:700;line-height:1.4;margin-bottom:8px;padding-right:30px;}
.trend-hook{font-size:11px;color:var(--muted);font-style:italic;margin-bottom:10px;line-height:1.55;border-left:2px solid rgba(255,48,88,0.3);padding-left:10px;}
.trend-stats{display:flex;gap:14px;font-size:11px;color:var(--muted);margin-bottom:10px;}
.trend-stat{display:flex;align-items:center;gap:4px;}
.trend-bar{height:3px;background:var(--border);border-radius:2px;margin-bottom:13px;overflow:hidden;}
.trend-bar-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--teal),var(--accent));transition:width 1s ease;}
.trend-actions{display:flex;gap:6px;}
.trend-empty{grid-column:1/-1;text-align:center;padding:90px 0;color:var(--muted);}
.trend-empty-icon{font-size:54px;margin-bottom:18px;animation:float 3s ease infinite;display:block;}
/* Competitor analysis */
.comp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;}
.comp-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;transition:all var(--transition);}
.comp-card:hover{border-color:var(--border2);transform:translateY(-2px);}
.comp-score-ring{width:54px;height:54px;flex-shrink:0;}
.score-circle{transform:rotate(-90deg);transform-origin:50% 50%;}
.score-text{font-family:var(--font-display);font-size:14px;font-weight:800;}

/* ============================
   SCRIPT GENERATOR
   ============================ */
.script-layout{display:grid;grid-template-columns:300px 1fr;gap:20px;}
@media(max-width:900px){.script-layout{grid-template-columns:1fr;}}
.script-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;}
.output-area{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;}
.output-toolbar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px;}
.output-meta{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:12px;}
.output-meta span{display:flex;align-items:center;gap:4px;}
.output-box{padding:20px;min-height:400px;font-size:13.5px;line-height:1.9;color:var(--text2);white-space:pre-wrap;flex:1;}
.output-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:400px;color:var(--muted);gap:14px;text-align:center;padding:40px;}
.output-empty .big-icon{font-size:56px;animation:float 3s ease infinite;}
.script-section-head{display:inline-flex;align-items:center;gap:6px;font-size:10px;font-weight:800;letter-spacing:2px;color:var(--accent);margin:18px 0 6px;text-transform:uppercase;background:rgba(255,60,92,0.07);padding:4px 10px;border-radius:6px;}
.word-count-bar{height:3px;background:var(--border);border-radius:2px;margin:12px 0 0;}
.word-count-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--teal),var(--accent));transition:width 0.5s ease;}

/* ============================
   THUMBNAIL
   ============================ */
.thumb-layout{display:grid;grid-template-columns:320px 1fr;gap:20px;}
@media(max-width:900px){.thumb-layout{grid-template-columns:1fr;}}
.thumb-canvas-wrap{width:100%;aspect-ratio:16/9;background:#0a0a12;border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;margin-bottom:12px;position:relative;border:1px solid var(--border);}
.thumb-canvas-wrap canvas{width:100%;height:100%;display:block;}
.thumb-empty{color:var(--muted);text-align:center;font-size:13px;padding:20px;}
.color-row{display:flex;gap:7px;flex-wrap:wrap;margin-top:8px;}
.color-swatch{width:28px;height:28px;border-radius:7px;cursor:pointer;border:2px solid transparent;transition:all 0.15s;}
.color-swatch.sel{border-color:var(--text);transform:scale(1.18);box-shadow:0 0 8px rgba(255,255,255,0.2);}
.sug-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;cursor:pointer;transition:all var(--transition);margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
.sug-card:hover{border-color:var(--accent);transform:translateX(3px);background:rgba(255,60,92,0.04);}
.sug-tip{font-size:10px;font-weight:700;padding:2px 7px;border-radius:5px;background:var(--surface3);color:var(--muted);white-space:nowrap;}

/* ============================
   LIBRARY
   ============================ */
.lib-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;}
.lib-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;transition:all var(--transition);}
.lib-card:hover{transform:translateY(-2px);border-color:var(--border2);box-shadow:var(--shadow-sm);}
.lib-platform{display:inline-flex;align-items:center;gap:5px;font-size:10px;font-weight:700;padding:3px 8px;border-radius:6px;margin-bottom:10px;}
.lib-platform.yt{background:rgba(255,0,0,0.1);color:var(--yt);}
.lib-platform.tt{background:rgba(105,201,208,0.1);color:var(--tt);}
.lib-platform.ig{background:rgba(225,48,108,0.1);color:var(--ig);}

/* ============================
   CALENDAR
   ============================ */
.cal-nav{display:flex;align-items:center;gap:12px;}
.cal-nav-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text2);width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all var(--transition);}
.cal-nav-btn:hover{border-color:var(--border2);}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.cal-header{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:4px;}
.cal-day-name{text-align:center;font-size:10px;font-weight:700;color:var(--muted);padding:6px 2px;}
.cal-cell{background:var(--surface2);border:1px solid var(--border);border-radius:8px;min-height:76px;padding:7px;cursor:pointer;transition:all var(--transition);font-size:11px;position:relative;}
.cal-cell:hover{border-color:var(--border2);background:var(--surface3);}
.cal-cell.today{border-color:var(--accent);box-shadow:0 0 0 1px rgba(255,60,92,0.2);}
.cal-cell.has-content{background:rgba(0,212,170,0.04);border-color:rgba(0,212,170,0.25);}
.cal-date{font-size:11px;font-weight:700;color:var(--muted);margin-bottom:4px;}
.cal-cell.today .cal-date{color:var(--accent);}
.cal-idea{font-size:10px;color:var(--text2);line-height:1.4;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
.cal-dot{width:5px;height:5px;background:var(--teal);border-radius:50%;position:absolute;bottom:6px;right:7px;}

/* ============================
   FAVOURITES
   ============================ */
.fav-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:12px;}
.fav-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;text-align:center;position:relative;transition:all var(--transition);}
.fav-card:hover{transform:translateY(-2px);border-color:var(--border2);}
.fav-remove{position:absolute;top:8px;right:8px;background:none;border:none;color:var(--muted);font-size:14px;cursor:pointer;transition:color var(--transition);}
.fav-remove:hover{color:var(--accent);}

/* ============================
   MULTILANG
   ============================ */
.lang-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;}
.lang-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px 8px;text-align:center;cursor:pointer;transition:all var(--transition);}
.lang-card:hover{border-color:var(--border2);transform:translateY(-1px);}
.lang-card.sel{border-color:var(--accent);background:rgba(255,60,92,0.06);box-shadow:0 0 0 1px rgba(255,60,92,0.1);}
.lang-flag{font-size:22px;margin-bottom:4px;}
.lang-name{font-size:11px;font-weight:600;color:var(--text2);}

/* ============================
   SETTINGS
   ============================ */
.settings-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-bottom:14px;}
.settings-section-title{font-size:11px;font-weight:700;letter-spacing:2px;color:var(--muted);margin-bottom:16px;text-transform:uppercase;}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);gap:20px;}
.settings-row:last-child{border-bottom:none;padding-bottom:0;}
.settings-label{font-size:13px;font-weight:600;}
.settings-desc{font-size:11px;color:var(--muted);margin-top:2px;line-height:1.4;}
.provider-status-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.provider-card{background:var(--surface2);border:2px solid var(--border);border-radius:12px;padding:16px;text-align:center;transition:all var(--transition);}
.provider-card.active-provider{border-color:var(--teal);background:rgba(0,212,170,0.05);box-shadow:var(--glow-teal);}
.provider-card.offline-provider{border-color:var(--accent);background:rgba(255,60,92,0.05);}
.provider-card-icon{font-size:24px;margin-bottom:6px;}
.provider-card-name{font-size:13px;font-weight:700;margin-bottom:4px;}
.provider-card-status{font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;display:inline-block;}
.status-active{background:rgba(0,212,170,0.15);color:var(--teal);}
.status-standby{background:rgba(94,110,138,0.15);color:var(--muted);}
.status-offline{background:rgba(255,60,92,0.15);color:var(--accent);}
.status-none{background:rgba(94,110,138,0.1);color:var(--muted);}

/* ============================
   AFFILIATE
   ============================ */
.aff-stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;}
.aff-stat{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:18px;text-align:center;}
.aff-stat-num{font-family:"Bebas Neue",sans-serif;font-size:38px;letter-spacing:1px;line-height:1;}
.aff-stat-label{font-size:11px;color:var(--muted);margin-top:4px;font-weight:600;}

/* ============================
   HELP / AI CHAT
   ============================ */
.help-layout{display:grid;grid-template-columns:1fr 400px;gap:20px;height:calc(100vh - 116px);}
@media(max-width:1000px){.help-layout{grid-template-columns:1fr;height:auto;}}
.help-info{display:flex;flex-direction:column;gap:14px;overflow-y:auto;}
.help-q{font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:space-between;padding:4px 0;line-height:1.4;}
.help-q-arrow{transition:transform var(--transition);color:var(--muted);flex-shrink:0;}
.help-q.open .help-q-arrow{transform:rotate(180deg);color:var(--accent);}
.help-a{font-size:13px;color:var(--text2);line-height:1.7;display:none;padding-top:10px;border-top:1px solid var(--border);margin-top:10px;}
.help-q.open + .help-a{display:block;}
.chat-container{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;overflow:hidden;height:100%;min-height:500px;}
.chat-header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;background:linear-gradient(135deg,rgba(255,60,92,0.06),rgba(139,92,246,0.03));flex-shrink:0;}
.chat-av{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;box-shadow:0 0 0 3px rgba(255,60,92,0.15);}
.chat-online{font-size:11px;color:var(--teal);display:flex;align-items:center;gap:5px;font-weight:600;}
.chat-online::before{content:"";width:6px;height:6px;background:var(--teal);border-radius:50%;animation:pulse 2s infinite;}
.chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;}
.chat-msg{max-width:86%;animation:chatPop 0.2s ease;}
.chat-msg.user{align-self:flex-end;}
.chat-msg.bot{align-self:flex-start;}
.chat-bubble{padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.65;}
.chat-msg.user .chat-bubble{background:linear-gradient(135deg,var(--accent),#c0003a);color:#fff;border-radius:14px 14px 3px 14px;}
.chat-msg.bot .chat-bubble{background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:14px 14px 14px 3px;}
.chat-ts{font-size:10px;color:var(--muted);margin-top:3px;padding:0 2px;}
.chat-msg.user .chat-ts{text-align:right;}
.typing-row{align-self:flex-start;}
.typing-dots{display:flex;gap:4px;padding:11px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:14px 14px 14px 3px;}
.t-dot{width:7px;height:7px;background:var(--muted);border-radius:50%;animation:typingDot 1.2s ease infinite;}
.t-dot:nth-child(2){animation-delay:.2s;}.t-dot:nth-child(3){animation-delay:.4s;}
.chat-sugs{display:flex;flex-wrap:wrap;gap:6px;padding:10px 14px;flex-shrink:0;border-top:1px solid var(--border);background:var(--surface);}
.chat-sug{font-size:11px;padding:5px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;cursor:pointer;color:var(--text2);transition:all var(--transition);white-space:nowrap;}
.chat-sug:hover{border-color:var(--accent);color:var(--accent);background:rgba(255,60,92,0.05);}
.chat-input-row{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;}
.chat-inp{flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:10px;font-size:13px;outline:none;transition:all var(--transition);}
.chat-inp:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,60,92,0.1);}
.chat-inp::placeholder{color:var(--muted);}
.chat-send{background:linear-gradient(135deg,var(--accent),#c0003a);border:none;color:#fff;width:40px;height:40px;border-radius:10px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all var(--transition);flex-shrink:0;box-shadow:0 4px 12px rgba(255,60,92,0.3);}
.chat-send:hover{transform:scale(1.06);box-shadow:0 6px 18px rgba(255,60,92,0.4);}
.chat-send:disabled{opacity:0.4;cursor:not-allowed;transform:none;box-shadow:none;}

/* ============================
   MOBILE NAV
   ============================ */
.mob-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);z-index:200;padding:6px 0 env(safe-area-inset-bottom,0);}
.mob-nav-inner{display:flex;justify-content:space-around;}
.mob-nav-btn{display:flex;flex-direction:column;align-items:center;gap:2px;padding:7px 14px;background:none;border:none;color:var(--muted);font-size:10px;font-weight:600;cursor:pointer;transition:all var(--transition);border-radius:8px;}
.mob-nav-btn.active{color:var(--accent);}
.mob-nav-btn .micon{font-size:20px;}
@media(max-width:768px){.sidebar{display:none;}.mob-nav{display:block;}.main-content{padding-bottom:75px;}}

/* ============================
   HAMBURGER + MOBILE SIDEBAR
   ============================ */
.hamburger{display:none;flex-direction:column;justify-content:center;gap:5px;width:36px;height:36px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;cursor:pointer;padding:8px;transition:all var(--transition);flex-shrink:0;}
.hamburger:hover{border-color:var(--border2);}
.hamburger span{display:block;height:2px;background:var(--text2);border-radius:2px;transition:all 0.25s ease;}
.hamburger.open span:nth-child(1){transform:translateY(7px) rotate(45deg);}
.hamburger.open span:nth-child(2){opacity:0;}
.hamburger.open span:nth-child(3){transform:translateY(-7px) rotate(-45deg);}
@media(max-width:768px){.hamburger{display:flex;}}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:300;backdrop-filter:blur(4px);}
.sidebar-overlay.show{display:block;}
.sidebar-mobile{position:fixed;top:0;left:0;bottom:0;width:260px;background:var(--surface);border-right:1px solid var(--border);z-index:301;transform:translateX(-100%);transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);overflow-y:auto;display:flex;flex-direction:column;}
.sidebar-mobile.open{transform:translateX(0);}

/* ============================
   LOGIN MODAL
   ============================ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:10000;align-items:center;justify-content:center;backdrop-filter:blur(8px);}
.modal-overlay.show{display:flex;}
.modal-box{background:var(--surface);border:1px solid var(--border);border-radius:24px;padding:36px;width:100%;max-width:420px;margin:16px;animation:slideUp 0.35s cubic-bezier(0.34,1.56,0.64,1) both;position:relative;}
.modal-logo{font-family:var(--font-display);font-size:22px;font-weight:800;letter-spacing:4px;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px;}
.modal-logo span{-webkit-text-fill-color:var(--teal);}
.modal-title{font-family:var(--font-display);font-size:26px;font-weight:800;letter-spacing:-0.5px;margin-bottom:6px;}
.modal-sub{font-size:13px;color:var(--muted);margin-bottom:28px;}
.modal-error{background:rgba(255,48,88,0.1);border:1px solid rgba(255,48,88,0.3);color:var(--accent);font-size:12px;font-weight:600;padding:10px 14px;border-radius:10px;margin-bottom:16px;display:none;}
.modal-error.show{display:block;}

/* ONBOARDING MODAL */
.onboarding-overlay{display:none!important;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:20000;align-items:center;justify-content:center;backdrop-filter:blur(12px);}
.onboarding-overlay.show.active{display:flex!important;}
.onboarding-box{background:var(--surface);border:1px solid var(--border);border-radius:28px;padding:44px 40px;width:100%;max-width:460px;margin:16px;animation:slideUp 0.4s cubic-bezier(0.34,1.56,0.64,1) both;position:relative;text-align:center;}
.onboarding-emoji{font-size:52px;margin-bottom:16px;display:block;animation:float 3s ease infinite;}
.onboarding-title{font-family:var(--font-display);font-size:28px;font-weight:800;letter-spacing:-0.5px;margin-bottom:8px;}
.onboarding-sub{font-size:14px;color:var(--muted);margin-bottom:28px;line-height:1.6;}
.onboarding-input{width:100%;background:var(--surface2);border:2px solid var(--border2);color:var(--text);padding:14px 18px;border-radius:14px;font-size:18px;font-weight:600;outline:none;transition:all var(--transition);text-align:center;letter-spacing:0.3px;font-family:var(--font-display);}
.onboarding-input:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(255,48,88,0.12);}
.onboarding-input::placeholder{color:var(--muted);font-weight:400;font-size:15px;}
.onboarding-btn{width:100%;margin-top:16px;padding:15px;font-size:15px;border-radius:14px;}
.onboarding-suggestions{display:flex;flex-wrap:wrap;gap:7px;justify-content:center;margin-top:14px;}
.onboarding-sug{background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:6px 16px;font-size:12px;color:var(--text2);cursor:pointer;transition:all var(--transition);font-weight:600;}
.onboarding-sug:hover{border-color:var(--accent);color:var(--accent);background:rgba(255,48,88,0.06);transform:translateY(-1px);}

/* ============================
   VOICE TO SCRIPT
   ============================ */
.voice-recorder{display:flex;flex-direction:column;align-items:center;gap:20px;padding:40px;}
.record-btn{width:100px;height:100px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--accent),#b8002e);color:#fff;font-size:36px;cursor:pointer;transition:all 0.2s;box-shadow:0 6px 30px rgba(255,48,88,0.4);position:relative;}
.record-btn:hover{transform:scale(1.05);box-shadow:0 8px 40px rgba(255,48,88,0.6);}
.record-btn.recording{background:linear-gradient(135deg,#e00,#b00);animation:glowPulse 1.5s ease infinite;}
.record-btn.recording::after{content:"";position:absolute;inset:-8px;border-radius:50%;border:2px solid rgba(255,48,88,0.4);animation:spin 2s linear infinite;}
.waveform{display:flex;align-items:center;gap:3px;height:40px;}
.wave-bar{width:4px;background:var(--accent);border-radius:2px;transition:height 0.1s ease;}
@keyframes waveAnim{0%,100%{height:6px}50%{height:28px}}

/* ============================
   TELEPROMPTER
   ============================ */
.teleprompter-overlay{position:fixed;inset:0;background:#000;z-index:99999;display:flex;flex-direction:column;opacity:0;pointer-events:none;transition:opacity 0.3s;}
.teleprompter-overlay.active{opacity:1;pointer-events:all;}
.teleprompter-scroll{flex:1;overflow:hidden;position:relative;}
.teleprompter-text{font-size:var(--tp-size,42px);line-height:1.7;color:#fff;padding:80px 120px;text-align:center;will-change:transform;}
.teleprompter-fade-top{position:absolute;top:0;left:0;right:0;height:160px;background:linear-gradient(to bottom,#000,transparent);pointer-events:none;z-index:2;}
.teleprompter-fade-bot{position:absolute;bottom:0;left:0;right:0;height:160px;background:linear-gradient(to top,#000,transparent);pointer-events:none;z-index:2;}
.teleprompter-controls{display:flex;align-items:center;justify-content:center;gap:14px;padding:18px;background:#111;border-top:1px solid #333;}
.tp-btn{background:#1a1a1a;border:1px solid #333;color:#fff;padding:10px 22px;border-radius:10px;cursor:pointer;font-size:13px;font-weight:700;transition:all 0.15s;}
.tp-btn:hover{background:#222;border-color:#555;}
.tp-btn.active-tp{background:var(--accent);border-color:var(--accent);}
.tp-cursor-line{position:absolute;left:0;right:0;top:50%;height:3px;background:rgba(255,48,88,0.5);z-index:3;pointer-events:none;}

/* ============================
   HASHTAG / SEO GENERATOR
   ============================ */
.hashtag-cloud{display:flex;flex-wrap:wrap;gap:8px;padding:16px 0;}
.hashtag-tag{background:rgba(0,229,176,0.1);border:1px solid rgba(0,229,176,0.25);color:var(--teal);padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;transition:all var(--transition);}
.hashtag-tag:hover{background:rgba(0,229,176,0.2);transform:scale(1.05);}
.hashtag-tag.copied{background:rgba(0,229,176,0.25);}
.seo-score-bar{height:8px;border-radius:4px;background:var(--border);overflow:hidden;margin-top:5px;}
.seo-score-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--teal),var(--accent));transition:width 1s ease;}

/* ============================
   HOOK TESTER
   ============================ */
.hook-score-ring-wrap{display:flex;flex-direction:column;align-items:center;gap:8px;}
.score-big{font-family:var(--font-display);font-size:72px;font-weight:800;line-height:1;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.hook-meter{display:flex;flex-direction:column;gap:10px;}
.hook-meter-row{display:flex;align-items:center;gap:10px;}
.hook-meter-label{font-size:11px;font-weight:700;color:var(--muted);width:100px;flex-shrink:0;font-family:var(--font-display);letter-spacing:0.5px;}
.hook-meter-bar{flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden;}
.hook-meter-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--teal),var(--accent));transition:width 1.2s ease;}
.hook-meter-val{font-size:12px;font-weight:800;font-family:var(--font-display);width:28px;text-align:right;}

/* ============================
   SCRIPT REPURPOSER
   ============================ */
.repurpose-tabs{display:flex;gap:6px;margin-bottom:16px;background:var(--surface2);padding:4px;border-radius:11px;border:1px solid var(--border);width:fit-content;}
.repurpose-output{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:18px;font-size:13px;color:var(--text2);line-height:1.75;min-height:200px;white-space:pre-wrap;}

/* ============================
   BRAND KIT
   ============================ */
.brand-color-picker{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.brand-swatch{width:36px;height:36px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all 0.15s;position:relative;}
.brand-swatch.active-swatch{border-color:var(--text);transform:scale(1.15);}
.brand-font-select{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:9px;font-size:13px;outline:none;cursor:pointer;}
.brand-preview{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;}
.brand-preview-title{font-size:22px;font-weight:800;margin-bottom:6px;}
.brand-preview-badge{display:inline-block;padding:4px 14px;border-radius:20px;font-size:11px;font-weight:800;}

/* ============================
   TREND ALERTS
   ============================ */
.alert-niche-chips{display:flex;flex-wrap:wrap;gap:8px;}
.alert-chip{padding:7px 16px;border-radius:20px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;transition:all var(--transition);}
.alert-chip.sel-chip{border-color:var(--accent);color:var(--accent);background:rgba(255,48,88,0.08);}
.digest-preview{background:linear-gradient(135deg,var(--surface2),var(--surface3));border:1px solid var(--border);border-radius:14px;padding:20px;margin-top:16px;}
.digest-topic{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
.digest-topic:last-child{border-bottom:none;}

/* ============================
   A/B TITLE TESTER
   ============================ */
.ab-compare{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.ab-card{background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);padding:20px;transition:all var(--transition);}
.ab-card.winner{border-color:var(--teal);box-shadow:0 0 24px rgba(0,229,176,0.15);}
.ab-card.loser{border-color:var(--border);opacity:0.7;}
.ab-winner-badge{background:var(--teal);color:#000;font-size:10px;font-weight:900;padding:3px 10px;border-radius:10px;letter-spacing:1px;font-family:var(--font-display);}
.ctr-bar{height:10px;border-radius:5px;background:var(--border);overflow:hidden;margin:10px 0;}
.ctr-fill-a{height:100%;border-radius:5px;background:linear-gradient(90deg,var(--teal),#00a87e);transition:width 1s ease;}
.ctr-fill-b{height:100%;border-radius:5px;background:linear-gradient(90deg,var(--purple),#7c3aed);transition:width 1s ease;}

/* ============================
   CONTENT GAP FINDER
   ============================ */
.gap-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;transition:all var(--transition);position:relative;overflow:hidden;}
.gap-card::before{content:"";position:absolute;top:0;left:0;width:4px;height:100%;background:var(--teal);}
.gap-card:hover{transform:translateY(-3px);border-color:rgba(0,229,176,0.3);box-shadow:0 8px 30px rgba(0,0,0,0.3);}
.gap-difficulty{font-size:9px;font-weight:800;padding:3px 8px;border-radius:6px;font-family:var(--font-display);letter-spacing:0.5px;}
.gap-easy{background:rgba(0,229,176,0.12);color:var(--teal);}
.gap-medium{background:rgba(251,191,36,0.12);color:var(--gold);}
.gap-hard{background:rgba(255,48,88,0.12);color:var(--accent);}
.gap-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;}

/* ============================
   SETTINGS ADMIN
   ============================ */
.lock-badge{display:inline-flex;align-items:center;gap:6px;font-size:10px;font-weight:900;padding:5px 14px;border-radius:20px;letter-spacing:1px;font-family:var(--font-display);}
.lock-badge-pro{background:rgba(255,48,88,0.12);color:var(--accent);border:1px solid rgba(255,48,88,0.3);}
.lock-badge-gold{background:rgba(251,191,36,0.12);color:var(--gold);border:1px solid rgba(251,191,36,0.3);}
.admin-lock{display:flex;align-items:center;gap:7px;font-size:10px;font-weight:700;color:var(--gold);background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.25);padding:4px 12px;border-radius:20px;font-family:var(--font-display);}
.admin-section{border:1px solid rgba(251,191,36,0.2);border-radius:var(--radius);padding:18px;background:rgba(251,191,36,0.03);margin-bottom:14px;}
.admin-section-title{display:flex;align-items:center;gap:8px;font-size:11px;font-weight:900;color:var(--gold);letter-spacing:2px;text-transform:uppercase;font-family:var(--font-display);margin-bottom:14px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE RESPONSIVE  
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ LANDING PAGE â”€â”€ */
@media(max-width:768px){
  .landing-nav{padding:12px 16px;}
  .landing-nav-right .btn-ghost{display:none;}
  .landing-hero{padding:56px 18px 56px;}
  .landing-h1{font-size:clamp(36px,11vw,62px);letter-spacing:-1px;}
  .landing-sub{font-size:14px;margin-bottom:24px;}
  .landing-ctas{flex-direction:column;align-items:stretch;gap:10px;}
  .landing-ctas .btn-xl{padding:14px 24px;font-size:14px;text-align:center;}
  .landing-stats{gap:16px;padding:16px 18px;flex-direction:column;align-items:center;}
  .landing-features{gap:7px;padding:0 8px;}
  .landing-feat{font-size:11px;padding:7px 11px;}
}
@media(min-width:769px){
  #landingFeaturesBtn, #landingPricingBtn { display:inline-flex !important; }
}

/* â”€â”€ TOPBAR â”€â”€ */
@media(max-width:768px){
  .topbar{padding:10px 14px;}
  .topbar-title{font-size:16px;}
  .topbar-right{gap:5px;}
}

/* â”€â”€ PAGE CONTENT â”€â”€ */
@media(max-width:768px){
  .page-content{padding:16px 14px 90px;}
  .card{padding:14px;}
}

/* â”€â”€ DASHBOARD â”€â”€ */
@media(max-width:768px){
  .dashboard-grid{grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:14px;}
  .stat-card{padding:14px;}
  .stat-card-num{font-size:28px;}
  .dash-row{grid-template-columns:1fr;gap:12px;}
}
@media(max-width:380px){
  .dashboard-grid{grid-template-columns:1fr;}
  .stat-card-num{font-size:24px;}
}

/* â”€â”€ SIDEBAR / NAV â”€â”€ */
@media(max-width:768px){
  .sidebar{display:none;}
  .mob-nav{display:block;}
  .main-content{padding-bottom:75px;}
  .hamburger{display:flex;}
}

/* â”€â”€ SCRIPT / THUMBNAIL / HELP â”€â”€ */
@media(max-width:768px){
  .script-layout{grid-template-columns:1fr !important;}
  .thumb-layout{grid-template-columns:1fr !important;}
  .help-layout{grid-template-columns:1fr !important;height:auto !important;}
}

/* â”€â”€ FORMS â”€â”€ */
@media(max-width:768px){
  .form-row,.form-row-split{flex-direction:column !important;gap:8px !important;}
  .form-row .form-input,.form-row .btn,
  .form-row-split .form-input,.form-row-split .btn{width:100% !important;}
}

/* â”€â”€ SETTINGS â”€â”€ */
@media(max-width:768px){
  .settings-row{flex-direction:column;align-items:flex-start !important;gap:8px;}
  .settings-row .toggle{align-self:flex-end;}
  .settings-row .btn{width:100%;}
  .settings-section{padding:14px;}
}

/* â”€â”€ PRICING â”€â”€ */
@media(max-width:768px){
  .pricing-grid{grid-template-columns:1fr !important;}
  .pricing-recommended-badge,.pricing-current-badge{font-size:8px;}
}
@media(max-width:1200px){
  .pricing-grid{grid-template-columns:repeat(3,1fr);}
}

/* â”€â”€ AFFILIATE â”€â”€ */
@media(max-width:768px){
  .aff-stats-grid{grid-template-columns:1fr !important;gap:10px;}
}

/* â”€â”€ TRENDS / COMPETITOR GRID â”€â”€ */
@media(max-width:768px){
  .comp-grid{grid-template-columns:1fr !important;}
}

/* â”€â”€ CALENDAR â”€â”€ */
@media(max-width:768px){
  .cal-grid{gap:2px;}
}

/* â”€â”€ HOOK TESTER â”€â”€ */
@media(max-width:768px){
  .hook-score-ring-wrap{flex-direction:column !important;align-items:center;gap:16px;}
  .hook-meter-label{width:70px;font-size:10px;}
  .score-big{font-size:50px;}
}

/* â”€â”€ A/B TESTER â”€â”€ */
@media(max-width:768px){
  .ab-compare{grid-template-columns:1fr !important;}
}

/* â”€â”€ GAP FINDER â”€â”€ */
@media(max-width:768px){
  .gap-grid{grid-template-columns:1fr !important;}
}

/* â”€â”€ REPURPOSER â”€â”€ */
@media(max-width:768px){
  .repurpose-tabs{width:100%;flex-wrap:wrap;}
  .repurpose-tabs .btn{flex:1 1 auto;font-size:11px;padding:7px 8px;}
}

/* â”€â”€ HASHTAG CLOUD â”€â”€ */
@media(max-width:768px){
  .hashtag-cloud{gap:6px;}
  .hashtag-tag{font-size:11px;padding:5px 10px;}
}

/* â”€â”€ TELEPROMPTER â”€â”€ */
@media(max-width:768px){
  .teleprompter-text{padding:60px 20px;}
  .teleprompter-controls{gap:7px;padding:10px;flex-wrap:wrap;}
  .tp-btn{padding:8px 10px;font-size:12px;}
}

/* â”€â”€ VOICE RECORDER â”€â”€ */
@media(max-width:768px){
  .voice-recorder{padding:24px 14px;}
  .record-btn{width:72px;height:72px;font-size:28px;}
  .waveform{gap:2px;}
}

/* â”€â”€ ALERTS / DIGEST â”€â”€ */
@media(max-width:768px){
  .alert-niche-chips{gap:6px;}
  .digest-preview{padding:14px;}
}

/* â”€â”€ MODALS â”€â”€ */
@media(max-width:768px){
  .modal-box{padding:24px 18px;border-radius:18px;margin:10px;}
  .modal-title{font-size:22px;}
  .onboarding-box{padding:28px 18px;border-radius:20px;}
  .onboarding-title{font-size:22px;}
  .onboarding-input{font-size:16px;padding:12px 14px;}
}

/* â”€â”€ NOTIFICATIONS â”€â”€ */
@media(max-width:768px){
  .notif{bottom:82px;right:10px;left:10px;max-width:100%;}
}

/* â”€â”€ TIER GATE â”€â”€ */
@media(max-width:768px){
  .tier-gate-overlay{padding:20px 14px;}
  .tier-gate-icon{font-size:40px;}
  .tier-gate-title{font-size:15px;}
}

/* â”€â”€ SAFE AREA (iPhone notch/home bar) â”€â”€ */
@supports(padding-bottom: env(safe-area-inset-bottom)){
  .mob-nav{padding-bottom:max(8px,env(safe-area-inset-bottom));}
  #mainApp{padding-bottom:0;}
}

</style>


  <!-- Google Identity Services for YouTube OAuth -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="dark-grid">
<div class="app">

<!-- ===== LANDING CONTENT (all hidden on login) ===== -->
<div id="landingContent">

<!-- ===== LANDING PAGE ===== -->
<div id="landingPage">
  <nav class="landing-nav">
    <div class="landing-logo" style="display:flex;align-items:center;gap:10px"><svg width="28" height="28" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0">
  <defs>
    <linearGradient id="tvgl1" x1="0" y1="0" x2="32" y2="32" gradientUnits="userSpaceOnUse">
      <stop offset="0%" stop-color="#ff3058"/><stop offset="100%" stop-color="#ff7b00"/>
    </linearGradient>
    <linearGradient id="tvgl2" x1="0" y1="0" x2="32" y2="32" gradientUnits="userSpaceOnUse">
      <stop offset="0%" stop-color="#ff3058" stop-opacity="0.3"/><stop offset="100%" stop-color="#ff7b00" stop-opacity="0.1"/>
    </linearGradient>
  </defs>
  <rect width="32" height="32" rx="8" fill="url(#tvgl2)" stroke="url(#tvgl1)" stroke-width="1.2"/>
  <path d="M12 9.5L23.5 16L12 22.5V9.5Z" fill="url(#tvgl1)"/>
  <path d="M6 22L10 17L14 20L18 14L22 16L26 10" stroke="#00e5b0" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
  <circle cx="26" cy="10" r="2" fill="#00e5b0"/>
</svg><span>TREND<span>VID</span></span></div>
    <div class="landing-nav-right">
      <button class="icon-btn" onclick="toggleTheme()" id="themeBtn">ðŸŒ™</button>
      <button class="btn btn-ghost btn-sm" style="font-weight:600;display:none" id="landingFeaturesBtn" onclick="document.getElementById('landingFeatures').scrollIntoView({behavior:'smooth'})">Features</button>
      <button class="btn btn-ghost btn-sm" style="font-weight:600;display:none" id="landingPricingBtn" onclick="document.getElementById('landingPricingSection').scrollIntoView({behavior:'smooth'})">Pricing</button>
      <button class="btn btn-ghost btn-sm" style="font-weight:600" onclick="showLogin()">Log in</button>
      <button class="btn btn-primary btn-sm" style="font-weight:700;padding:8px 18px" onclick="showSignup()">Get Started Free â†’</button>
    </div>
  </nav>
  <div class="landing-hero">
    <div class="hero-orb hero-orb-1"></div>
    <div class="hero-orb hero-orb-2"></div>
    <div class="hero-orb hero-orb-3"></div>
    <div class="landing-eyebrow">ðŸ”¥ The #1 AI Studio for Content Creators</div>
    <h1 class="landing-h1">SPOT THE <span class="grad">TREND.</span><br>OWN THE MOMENT.</h1>
    <p class="landing-sub">TrendVid AI scans YouTube, TikTok & Instagram to surface viral opportunities â€” then writes your script, analyzes your competitors, builds your thumbnail, and fills your entire content calendar. Powered by AI.</p>
    <div class="landing-ctas">
      <button class="btn btn-primary btn-xl" onclick="showSignup()">ðŸš€ Start Creating Free</button>
      <button class="btn btn-ghost btn-xl" onclick="showLogin()">Watch Demo â–¶</button>
    </div>
    <div class="landing-stats">
      <div class="stat-item"><div class="stat-num">50K+</div><div class="stat-label">Creators</div></div>
      <div class="stat-item"><div class="stat-num">2M+</div><div class="stat-label">Scripts Written</div></div>
      <div class="stat-item"><div class="stat-num">98%</div><div class="stat-label">Satisfaction</div></div>
      <div class="stat-item"><div class="stat-num">20+</div><div class="stat-label">Languages</div></div>
    </div>
    <div class="landing-features">
      <div class="landing-feat"><span>ðŸ“ˆ</span> Real-Time Trend Radar</div>
      <div class="landing-feat"><span>âœï¸</span> AI Script Generator</div>
      <div class="landing-feat"><span>ðŸŽ™ï¸</span> Voice to Script</div>
      <div class="landing-feat"><span>ðŸ“º</span> Teleprompter Mode</div>
      <div class="landing-feat"><span>#ï¸âƒ£</span> Hashtag & SEO</div>
      <div class="landing-feat"><span>âš¡</span> Hook Tester</div>
      <div class="landing-feat"><span>â™»ï¸</span> Script Repurposer</div>
      <div class="landing-feat"><span>ðŸ”­</span> Content Gap Finder</div>
      <div class="landing-feat"><span>ðŸ†š</span> A/B Title Tester</div>
      <div class="landing-feat"><span>ðŸŽ¨</span> Thumbnail Creator</div>
      <div class="landing-feat"><span>ðŸ“…</span> Content Calendar</div>
      <div class="landing-feat"><span>ðŸŒ</span> 20+ Languages</div>
    </div>
  </div>
</div>

<!-- LANDING: FEATURES DEEP DIVE -->
<div id="landingFeatures" style="background:var(--surface);border-top:1px solid var(--border);border-bottom:1px solid var(--border);padding:70px 24px">
  <div style="max-width:1000px;margin:0 auto">
    <div style="text-align:center;margin-bottom:48px">
      <div style="font-size:12px;font-weight:800;letter-spacing:3px;color:var(--accent);margin-bottom:8px">EVERYTHING YOU NEED</div>
      <h2 style="font-family:var(--font-display);font-size:clamp(28px,5vw,42px);font-weight:900;line-height:1.1">One app. Infinite <span style="color:var(--teal)">content.</span></h2>
      <p style="font-size:15px;color:var(--muted);margin-top:12px;max-width:500px;margin-left:auto;margin-right:auto">Replace 12 different tools with one AI-powered studio built for creators.</p>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px">
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:18px;padding:24px;transition:border-color 0.2s" onmouseover="this.style.borderColor='rgba(255,48,88,0.4)'" onmouseout="this.style.borderColor='var(--border)'">
        <div style="font-size:32px;margin-bottom:12px">ðŸ“ˆ</div>
        <div style="font-size:16px;font-weight:800;margin-bottom:6px">Real-Time Trend Radar</div>
        <div style="font-size:13px;color:var(--muted);line-height:1.6">Scan YouTube, TikTok & Instagram for viral opportunities before they peak. Never miss a trend again.</div>
      </div>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:18px;padding:24px;transition:border-color 0.2s" onmouseover="this.style.borderColor='rgba(0,229,176,0.4)'" onmouseout="this.style.borderColor='var(--border)'">
        <div style="font-size:32px;margin-bottom:12px">âœï¸</div>
        <div style="font-size:16px;font-weight:800;margin-bottom:6px">AI Script Generator</div>
        <div style="font-size:13px;color:var(--muted);line-height:1.6">Full scripts in seconds. Hooks, B-roll notes, CTAs â€” written in your voice, for any platform.</div>
      </div>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:18px;padding:24px;transition:border-color 0.2s" onmouseover="this.style.borderColor='rgba(167,139,250,0.4)'" onmouseout="this.style.borderColor='var(--border)'">
        <div style="font-size:32px;margin-bottom:12px">ðŸŽ¨</div>
        <div style="font-size:16px;font-weight:800;margin-bottom:6px">Thumbnail AI</div>
        <div style="font-size:13px;color:var(--muted);line-height:1.6">Generate eye-catching thumbnail concepts with colour psychology, text overlays and click-bait elements.</div>
      </div>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:18px;padding:24px;transition:border-color 0.2s" onmouseover="this.style.borderColor='rgba(251,191,36,0.4)'" onmouseout="this.style.borderColor='var(--border)'">
        <div style="font-size:32px;margin-bottom:12px">ðŸ“…</div>
        <div style="font-size:16px;font-weight:800;margin-bottom:6px">Content Calendar</div>
        <div style="font-size:13px;color:var(--muted);line-height:1.6">AI fills your entire month with optimised post ideas. Never stare at a blank calendar again.</div>
      </div>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:18px;padding:24px;transition:border-color 0.2s" onmouseover="this.style.borderColor='rgba(255,138,0,0.4)'" onmouseout="this.style.borderColor='var(--border)'">
        <div style="font-size:32px;margin-bottom:12px">ðŸ†š</div>
        <div style="font-size:16px;font-weight:800;margin-bottom:6px">A/B Title Tester</div>
        <div style="font-size:13px;color:var(--muted);line-height:1.6">Test multiple titles and thumbnails to find the highest CTR combination before you post.</div>
      </div>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:18px;padding:24px;transition:border-color 0.2s" onmouseover="this.style.borderColor='rgba(0,229,176,0.4)'" onmouseout="this.style.borderColor='var(--border)'">
        <div style="font-size:32px;margin-bottom:12px">ðŸŒ</div>
        <div style="font-size:16px;font-weight:800;margin-bottom:6px">20+ Languages</div>
        <div style="font-size:13px;color:var(--muted);line-height:1.6">Translate your scripts instantly. Reach global audiences without hiring a translator.</div>
      </div>
    </div>
  </div>
</div>

<!-- LANDING: TESTIMONIALS -->
<div style="padding:70px 24px;max-width:1000px;margin:0 auto">
  <div style="text-align:center;margin-bottom:48px">
    <div style="font-size:12px;font-weight:800;letter-spacing:3px;color:var(--teal);margin-bottom:8px">CREATOR STORIES</div>
    <h2 style="font-family:var(--font-display);font-size:clamp(26px,4vw,38px);font-weight:900">Creators love <span style="color:var(--accent)">TrendVid</span></h2>
  </div>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:24px">
      <div style="display:flex;gap:4px;margin-bottom:12px">â­â­â­â­â­</div>
      <p style="font-size:14px;color:var(--text2);line-height:1.7;margin-bottom:16px">"TrendVid saved me 10+ hours a week. My scripts are better, my thumbnails get more clicks, and I actually know what's trending before everyone else."</p>
      <div style="display:flex;align-items:center;gap:10px">
        <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px">J</div>
        <div><div style="font-size:13px;font-weight:700">Jamie K.</div><div style="font-size:11px;color:var(--muted)">180K YouTube subscribers</div></div>
      </div>
    </div>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:24px">
      <div style="display:flex;gap:4px;margin-bottom:12px">â­â­â­â­â­</div>
      <p style="font-size:14px;color:var(--text2);line-height:1.7;margin-bottom:16px">"The Trend Radar is insane. I posted about a topic 2 days before it exploded and got 400K views. That's never happened to me before."</p>
      <div style="display:flex;align-items:center;gap:10px">
        <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--teal),var(--purple));display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px">S</div>
        <div><div style="font-size:13px;font-weight:700">Sofia R.</div><div style="font-size:11px;color:var(--muted)">TikTok Creator, 2.3M followers</div></div>
      </div>
    </div>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:24px">
      <div style="display:flex;gap:4px;margin-bottom:12px">â­â­â­â­â­</div>
      <p style="font-size:14px;color:var(--text2);line-height:1.7;margin-bottom:16px">"I used to outsource my scripts for Â£200/month. TrendVid costs a fraction of that and the output is honestly just as good â€” sometimes better."</p>
      <div style="display:flex;align-items:center;gap:10px">
        <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px">M</div>
        <div><div style="font-size:13px;font-weight:700">Marcus T.</div><div style="font-size:11px;color:var(--muted)">Faceless YouTube Channel, 500K</div></div>
      </div>
    </div>
  </div>
</div>

<!-- LANDING: PRICING PREVIEW -->
<div id="landingPricingSection" style="background:var(--surface);border-top:1px solid var(--border);padding:70px 24px">
  <div style="max-width:900px;margin:0 auto;text-align:center">
    <div style="font-size:12px;font-weight:800;letter-spacing:3px;color:var(--accent);margin-bottom:8px">PRICING</div>
    <h2 style="font-family:var(--font-display);font-size:clamp(26px,4vw,38px);font-weight:900;margin-bottom:8px">Start free. Scale when <span style="color:var(--teal)">ready.</span></h2>
    <p style="color:var(--muted);font-size:14px;margin-bottom:40px">No credit card required to start. Cancel anytime.</p>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px">
      <div style="border:1px solid var(--border);border-radius:16px;padding:24px;background:var(--surface2)">
        <div style="font-size:20px;margin-bottom:8px">ðŸŒ±</div>
        <div style="font-weight:800;margin-bottom:4px">Free</div>
        <div style="font-family:var(--font-display);font-size:28px;font-weight:900;margin-bottom:12px">Â£0<span style="font-size:14px;color:var(--muted)">/mo</span></div>
        <div style="font-size:12px;color:var(--muted)">3 scripts/month Â· Core tools Â· Trend radar</div>
      </div>
      <div style="border:1px solid rgba(255,48,88,0.4);border-radius:16px;padding:24px;background:rgba(255,48,88,0.04)">
        <div style="font-size:20px;margin-bottom:8px">ðŸš€</div>
        <div style="font-weight:800;margin-bottom:4px">Starter</div>
        <div style="font-family:var(--font-display);font-size:28px;font-weight:900;margin-bottom:12px">Â£9<span style="font-size:14px;color:var(--muted)">/mo</span></div>
        <div style="font-size:12px;color:var(--muted)">Unlimited scripts Â· All tools Â· Priority AI</div>
      </div>
      <div style="border:2px solid var(--teal);border-radius:16px;padding:24px;background:rgba(0,229,176,0.04);position:relative">
        <div style="position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:var(--teal);color:#000;font-size:10px;font-weight:900;padding:3px 12px;border-radius:20px;letter-spacing:1px">POPULAR</div>
        <div style="font-size:20px;margin-bottom:8px">âš¡</div>
        <div style="font-weight:800;margin-bottom:4px">Pro</div>
        <div style="font-family:var(--font-display);font-size:28px;font-weight:900;margin-bottom:12px">Â£19<span style="font-size:14px;color:var(--muted)">/mo</span></div>
        <div style="font-size:12px;color:var(--muted)">Everything + Voice AI Â· B-Roll Â· Analytics</div>
      </div>
      <div style="border:1px solid rgba(251,191,36,0.4);border-radius:16px;padding:24px;background:rgba(251,191,36,0.04)">
        <div style="font-size:20px;margin-bottom:8px">ðŸ‘‘</div>
        <div style="font-weight:800;margin-bottom:4px">Gold</div>
        <div style="font-family:var(--font-display);font-size:28px;font-weight:900;margin-bottom:12px">Â£39<span style="font-size:14px;color:var(--muted)">/mo</span></div>
        <div style="font-size:12px;color:var(--muted)">Team access Â· Brand Kit Â· All features</div>
      </div>
    </div>
    <button class="btn btn-primary btn-xl" onclick="showSignup()" style="font-size:16px;padding:16px 36px">ðŸš€ Start Free â€” No Card Needed</button>
  </div>
</div>

<!-- LANDING: FAQ -->
<div style="padding:70px 24px;max-width:700px;margin:0 auto">
  <div style="text-align:center;margin-bottom:40px">
    <div style="font-size:12px;font-weight:800;letter-spacing:3px;color:var(--purple);margin-bottom:8px">FAQ</div>
    <h2 style="font-family:var(--font-display);font-size:clamp(24px,4vw,34px);font-weight:900">Questions? Answered.</h2>
  </div>
  <div style="display:flex;flex-direction:column;gap:12px" id="faqList">
    <details style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px 20px;cursor:pointer">
      <summary style="font-weight:700;font-size:14px;list-style:none;display:flex;justify-content:space-between;align-items:center">Is TrendVid really free to start? <span style="color:var(--accent)">+</span></summary>
      <p style="font-size:13px;color:var(--muted);margin-top:12px;line-height:1.7">Yes â€” completely free, no credit card needed. You get access to the Trend Radar, AI Script Generator (3/month), Thumbnail creator and more. Upgrade anytime to unlock unlimited usage.</p>
    </details>
    <details style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px 20px;cursor:pointer">
      <summary style="font-weight:700;font-size:14px;list-style:none;display:flex;justify-content:space-between;align-items:center">What AI does TrendVid use? <span style="color:var(--accent)">+</span></summary>
      <p style="font-size:13px;color:var(--muted);margin-top:12px;line-height:1.7">TrendVid is powered by Groq (ultra-fast Llama 3) by default, with Google Gemini as an automatic backup. You can add your own API keys in Settings for the best performance.</p>
    </details>
    <details style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px 20px;cursor:pointer">
      <summary style="font-weight:700;font-size:14px;list-style:none;display:flex;justify-content:space-between;align-items:center">Can I cancel anytime? <span style="color:var(--accent)">+</span></summary>
      <p style="font-size:13px;color:var(--muted);margin-top:12px;line-height:1.7">Absolutely. Cancel any time from your account settings. No questions, no lock-in. Your data stays accessible on the free tier.</p>
    </details>
    <details style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px 20px;cursor:pointer">
      <summary style="font-weight:700;font-size:14px;list-style:none;display:flex;justify-content:space-between;align-items:center">What platforms does it support? <span style="color:var(--accent)">+</span></summary>
      <p style="font-size:13px;color:var(--muted);margin-top:12px;line-height:1.7">YouTube, TikTok, Instagram Reels, Facebook, Twitter/X, LinkedIn and podcasts. Scripts are automatically adapted for each platform's format and audience expectations.</p>
    </details>
    <details style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px 20px;cursor:pointer">
      <summary style="font-weight:700;font-size:14px;list-style:none;display:flex;justify-content:space-between;align-items:center">Is my content private? <span style="color:var(--accent)">+</span></summary>
      <p style="font-size:13px;color:var(--muted);margin-top:12px;line-height:1.7">Yes. Your scripts and data are stored locally on your device. We don't sell your data or use it to train AI models. Your content is yours.</p>
    </details>
  </div>
</div>

<!-- LANDING: FOOTER -->
<footer style="background:var(--surface);border-top:1px solid var(--border);padding:40px 24px">
  <div style="max-width:1000px;margin:0 auto">
    <div style="display:flex;flex-wrap:wrap;gap:32px;justify-content:space-between;margin-bottom:32px">
      <div>
        <div style="font-family:var(--font-display);font-size:20px;font-weight:900;margin-bottom:8px">TREND<span style="color:var(--accent)">VID</span></div>
        <div style="font-size:12px;color:var(--muted);max-width:200px;line-height:1.7">The AI content studio for creators who want to go viral.</div>
        <div style="display:flex;gap:12px;margin-top:14px">
          <a href="https://twitter.com/trendvidai" target="_blank" style="color:var(--muted);font-size:18px;text-decoration:none" title="Twitter">ð•</a>
          <a href="https://youtube.com/@trendvidai" target="_blank" style="color:var(--muted);font-size:18px;text-decoration:none" title="YouTube">â–¶</a>
          <a href="https://tiktok.com/@trendvidai" target="_blank" style="color:var(--muted);font-size:18px;text-decoration:none" title="TikTok">â™ª</a>
        </div>
      </div>
      <div>
        <div style="font-size:11px;font-weight:700;letter-spacing:2px;color:var(--muted);margin-bottom:12px">PRODUCT</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <a href="#" style="font-size:13px;color:var(--text2);text-decoration:none" onclick="showSignup();return false">Get Started Free</a>
          <a href="#" style="font-size:13px;color:var(--text2);text-decoration:none" onclick="showLogin();return false">Sign In</a>
          <a href="#" style="font-size:13px;color:var(--text2);text-decoration:none">Pricing</a>
          <a href="#" style="font-size:13px;color:var(--text2);text-decoration:none" onclick="showLogin();return false">Changelog</a>
        </div>
      </div>
      <div>
        <div style="font-size:11px;font-weight:700;letter-spacing:2px;color:var(--muted);margin-bottom:12px">TOOLS</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <a href="#" style="font-size:13px;color:var(--text2);text-decoration:none">Trend Radar</a>
          <a href="#" style="font-size:13px;color:var(--text2);text-decoration:none">Script Generator</a>
          <a href="#" style="font-size:13px;color:var(--text2);text-decoration:none">Thumbnail AI</a>
          <a href="#" style="font-size:13px;color:var(--text2);text-decoration:none">Content Calendar</a>
        </div>
      </div>
      <div>
        <div style="font-size:11px;font-weight:700;letter-spacing:2px;color:var(--muted);margin-bottom:12px">LEGAL</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <a href="#" style="font-size:13px;color:var(--text2);text-decoration:none" onclick="showPrivacyPolicy();return false">Privacy Policy</a>
          <a href="#" style="font-size:13px;color:var(--text2);text-decoration:none" onclick="showTermsOfService();return false">Terms of Service</a>
          <a href="#" style="font-size:13px;color:var(--text2);text-decoration:none">Cookie Policy</a>
          <a href="/cdn-cgi/l/email-protection#157d7079797a556167707b71637c713b747c" style="font-size:13px;color:var(--text2);text-decoration:none">Contact Us</a>
        </div>
      </div>
    </div>
    <div style="border-top:1px solid var(--border);padding-top:20px;display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:12px">
      <div style="font-size:12px;color:var(--muted)">Â© 2025 TrendVid AI. All rights reserved.</div>
      <div style="font-size:12px;color:var(--muted)">Made with â¤ï¸ for creators everywhere Â· <a href="/cdn-cgi/l/email-protection#5f373a3333301f2b2d3a313b29363b713e36" style="color:var(--accent);text-decoration:none"><span class="__cf_email__" data-cfemail="7c14191010133c080e1912180a1518521d15">[email&#160;protected]</span></a></div>
    </div>
  </div>
</footer>

</div><!-- /landingContent -->

<!-- ===== MAIN APP ===== -->
<div id="mainApp" style="display:none;height:100vh;position:fixed;inset:0;background:var(--bg);z-index:100;">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-logo">
      <div style="display:flex;align-items:center;gap:10px">
        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0">
  <defs>
    <linearGradient id="tvg1" x1="0" y1="0" x2="32" y2="32" gradientUnits="userSpaceOnUse">
      <stop offset="0%" stop-color="#ff3058"/>
      <stop offset="100%" stop-color="#ff7b00"/>
    </linearGradient>
    <linearGradient id="tvg2" x1="0" y1="0" x2="32" y2="32" gradientUnits="userSpaceOnUse">
      <stop offset="0%" stop-color="#ff3058" stop-opacity="0.3"/>
      <stop offset="100%" stop-color="#ff7b00" stop-opacity="0.1"/>
    </linearGradient>
  </defs>
  <!-- Background rounded square -->
  <rect width="32" height="32" rx="8" fill="url(#tvg2)" stroke="url(#tvg1)" stroke-width="1.2"/>
  <!-- Play triangle -->
  <path d="M12 9.5L23.5 16L12 22.5V9.5Z" fill="url(#tvg1)"/>
  <!-- Trend line across bottom of play button -->
  <path d="M6 22L10 17L14 20L18 14L22 16L26 10" stroke="#00e5b0" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
  <!-- Glow dot at trend peak -->
  <circle cx="26" cy="10" r="2" fill="#00e5b0"/>
</svg>
        <div>
          <div class="sidebar-logo-text" style="font-size:20px;letter-spacing:2px">TREND<span>VID</span></div>
          <div class="sidebar-tagline">AI Content Studio</div>
        </div>
      </div>
      <div class="ai-status-pill" id="aiStatusPill"><div class="ai-status-dot"></div><span id="aiStatusText">Groq AI Â· Active</span></div>
    </div>
    <div class="sidebar-nav">
      <div class="sidebar-section">HOME</div>
      <button class="nav-item" data-page="dashboard" onclick="navTo('dashboard')"><span class="icon">ðŸ </span>Dashboard</button>
      <button class="nav-item" data-page="leaderboard" onclick="navTo('leaderboard')" style="background:linear-gradient(135deg,rgba(255,215,0,0.08),rgba(255,138,0,0.04));border:1px solid rgba(255,215,0,0.2)"><span class="icon">ðŸ†</span>Leaderboard<span class="nav-badge" style="background:linear-gradient(135deg,#ffd700,#ff8a00);color:#000;font-weight:900">NEW</span></button>
      <div class="sidebar-section">CREATE</div>
      <button class="nav-item active" data-page="trends" onclick="navTo('trends')"><span class="icon">ðŸ“ˆ</span>Trend Radar</button>
      <button class="nav-item" data-page="script" onclick="navTo('script')"><span class="icon">âœï¸</span>Script Generator</button>
      <button class="nav-item" data-page="thumbnail" onclick="navTo('thumbnail')"><span class="icon">ðŸŽ¨</span>Thumbnail AI</button>
      <button class="nav-item" id="imagegenNavBtn" data-page="imagegen" onclick="navTo('imagegen')" style="background:linear-gradient(135deg,rgba(0,229,176,0.06),rgba(167,139,250,0.04));border:1px solid rgba(0,229,176,0.15)"><span class="icon">ðŸ–¼ï¸</span>Image Generator<span class="nav-badge" style="background:linear-gradient(135deg,#00e5b0,#a78bfa);color:#000;font-weight:900">ADMIN</span></button>
      <div class="sidebar-section">MANAGE</div>
      <button class="nav-item" data-page="library" onclick="navTo('library')"><span class="icon">ðŸ“š</span>Script Library<span class="nav-badge" id="libBadge">0</span></button>
      <button class="nav-item" data-page="calendar" onclick="navTo('calendar')"><span class="icon">ðŸ“…</span>Content Calendar</button>
      <button class="nav-item" data-page="favourites" onclick="navTo('favourites')"><span class="icon">â­</span>Favourites<span class="nav-badge" id="favBadge">0</span></button>
      <div class="sidebar-section">TOOLS</div>
      <button class="nav-item" data-page="voice" onclick="navTo('voice')"><span class="icon">ðŸŽ™ï¸</span>Voice to Script<span class="tier-dot tier-dot-pro" title="Pro"></span></button>
      <button class="nav-item" data-page="teleprompter" onclick="navTo('teleprompter')"><span class="icon">ðŸ“º</span>Teleprompter<span class="tier-dot tier-dot-pro" title="Pro"></span></button>
      <button class="nav-item" data-page="hashtags" onclick="navTo('hashtags')"><span class="icon">#ï¸âƒ£</span>Hashtag & SEO<span class="tier-dot tier-dot-pro" title="Pro"></span></button>
      <button class="nav-item" data-page="hooktester" onclick="navTo('hooktester')"><span class="icon">âš¡</span>Hook Tester<span class="tier-dot tier-dot-pro" title="Pro"></span></button>
      <button class="nav-item" data-page="repurpose" onclick="navTo('repurpose')"><span class="icon">â™»ï¸</span>Script Repurposer<span class="tier-dot tier-dot-pro" title="Pro"></span></button>
      <button class="nav-item" data-page="brandkit" onclick="navTo('brandkit')"><span class="icon">ðŸŽ¨</span>Brand Kit<span class="tier-dot tier-dot-gold" title="Gold"></span></button>
      <button class="nav-item" data-page="alerts" onclick="navTo('alerts')"><span class="icon">ðŸ””</span>Trend Alerts<span class="tier-dot tier-dot-gold" title="Gold"></span></button>
      <button class="nav-item" data-page="abtitle" onclick="navTo('abtitle')"><span class="icon">ðŸ†š</span>A/B Title Tester<span class="tier-dot tier-dot-pro" title="Pro"></span></button>
      <button class="nav-item" data-page="gapfinder" onclick="navTo('gapfinder')"><span class="icon">ðŸ”­</span>Content Gaps<span class="tier-dot tier-dot-pro" title="Pro"></span></button>
      <button class="nav-item" data-page="multilang" onclick="navTo('multilang')"><span class="icon">ðŸŒ</span>Multi-Language</button>
      <button class="nav-item" data-page="affiliate" onclick="navTo('affiliate')"><span class="icon">ðŸ”—</span>Affiliate</button>
      <button class="nav-item" data-page="viral" onclick="navTo('viral')"><span class="icon">ðŸš€</span>Viral Score</button>
      <button class="nav-item" data-page="health" onclick="navTo('health')"><span class="icon">ðŸ“Š</span>Channel Health</button>
      <button class="nav-item" data-page="broll" onclick="navTo('broll')"><span class="icon">ðŸŽ¬</span>B-Roll Ideas</button>
      <button class="nav-item" data-page="music" onclick="navTo('music')"><span class="icon">ðŸŽµ</span>Music Picks</button>
      <button class="nav-item" data-page="captions" onclick="navTo('captions')"><span class="icon">ðŸ’¬</span>Caption Gen</button>
      <button class="nav-item" data-page="comments" onclick="navTo('comments')"><span class="icon">ðŸ’­</span>Comment Replies</button>
      <button class="nav-item" data-page="improver" onclick="navTo('improver')"><span class="icon">âœ¨</span>Script Improver</button>
      <button class="nav-item" data-page="giftcodes" onclick="navTo('giftcodes')"><span class="icon">ðŸŽ</span>Gift Codes</button>
      <button class="nav-item" data-page="soundtrack" onclick="navTo('soundtrack')"><span class="icon">ðŸŽµ</span>Soundtrack Finder</button>
      <button class="nav-item" data-page="bundles" onclick="navTo('bundles')"><span class="icon">ðŸ“¦</span>Bundle Deals</button>
      <button class="nav-item" data-page="ytanalyse" onclick="navTo('ytanalyse')"><span class="icon">ðŸ“º</span>YouTube Analyser<span class="tier-dot tier-dot-pro" title="Pro"></span></button>
      <button class="nav-item" data-page="descgen" onclick="navTo('descgen')"><span class="icon">ðŸ“</span>Description Gen<span class="tier-dot tier-dot-starter" title="Starter"></span></button>
      <button class="nav-item" data-page="thumbab" onclick="navTo('thumbab')"><span class="icon">ðŸ†š</span>Thumbnail A/B<span class="tier-dot tier-dot-pro" title="Pro"></span></button>
      <button class="nav-item" data-page="collab" onclick="navTo('collab')"><span class="icon">ðŸ¤</span>Collab Finder<span class="tier-dot tier-dot-pro" title="Pro"></span></button>
      <button class="nav-item" data-page="scheduler" onclick="navTo('scheduler')"><span class="icon">ðŸ—“ï¸</span>Post Scheduler<span class="tier-dot tier-dot-starter" title="Starter"></span></button>
      <button class="nav-item" data-page="videogen" onclick="navTo('videogen')" style="background:linear-gradient(135deg,rgba(255,48,88,0.08),rgba(167,139,250,0.05));border:1px solid rgba(255,48,88,0.2)"><span class="icon">ðŸŽ¬</span>Script to Video<span class="nav-badge" style="background:linear-gradient(135deg,var(--accent),var(--purple));color:#fff;font-weight:900">NEW</span></button>
      <div class="sidebar-section">ACCOUNT</div>
      <button class="nav-item" data-page="pricing" onclick="navTo('pricing')"><span class="icon">ðŸ’Ž</span>Plans & Pricing</button>
      <button class="nav-item" data-page="changelog" onclick="navTo('changelog')"><span class="icon">ðŸ“‹</span>What's New<span class="nav-badge" style="background:linear-gradient(135deg,#00e5b0,#a78bfa);color:#000;font-weight:900" id="changelogNavBadge">NEW</span></button>
      <button class="nav-item" data-page="xp" onclick="navTo('xp')" id="xpNavBtn"><span class="icon">â­</span>XP & Levels<span class="nav-badge" id="xpLevelBadge" style="background:linear-gradient(135deg,var(--gold),var(--accent2));color:#000">1</span></button>
      <button class="nav-item" id="adminNavBtn" data-page="admin" onclick="navTo('admin')" style="display:none;border:1px solid rgba(251,191,36,0.3);background:rgba(251,191,36,0.05);color:var(--gold);position:relative"><span class="icon">ðŸ›¡ï¸</span>Admin Panel<span id="adminNotifBadge" style="display:none;position:absolute;right:10px;top:50%;transform:translateY(-50%);background:var(--accent);color:#fff;border-radius:10px;padding:1px 7px;font-size:10px;font-weight:900;min-width:18px;text-align:center"></span></button>
      <button class="nav-item" data-page="settings" onclick="navTo('settings')"><span class="icon">âš™ï¸</span>Settings</button>
      <button class="nav-item" data-page="help" onclick="navTo('help')"><span class="icon">ðŸ’¬</span>Help & AI Chat</button>
      <button class="nav-item" style="margin-top:auto;color:var(--muted)" onclick="document.getElementById('errorReportModal').classList.add('show')"><span class="icon">ðŸ›</span>Report Issue</button>
    </div>
    <div class="sidebar-bottom">
      <div class="xp-sidebar-chip" id="xpSidebarChip" onclick="navTo('xp')" title="View XP & Levels">
        <div class="xp-chip-top">
          <span class="xp-chip-level" id="xpChipLevel">LVL 1</span>
          <span class="xp-chip-badge" id="xpChipBadge">ðŸŒ±</span>
        </div>
        <div class="xp-chip-bar"><div class="xp-chip-fill" id="xpChipFill" style="width:0%"></div></div>
        <div class="xp-chip-label" id="xpChipLabel">0 / 100 XP Â· Click to view rewards</div>
      </div>
      <div class="user-chip" onclick="navTo('settings')" style="margin-bottom:8px">
        <div class="user-avatar" id="sidebarAvatar">ðŸ˜Ž</div>
        <div class="user-info">
          <div class="user-name" id="sidebarName">Creator</div>
          <div class="user-plan" id="sidebarPlan"><span class="tier-badge tier-free">FREE</span></div>
        </div>
        <span style="color:var(--muted);font-size:12px">âš™ï¸</span>
      </div>
      <button onclick="logout()" style="width:100%;display:flex;align-items:center;gap:8px;padding:9px 12px;background:none;border:1px solid rgba(255,48,88,0.25);border-radius:10px;cursor:pointer;color:var(--muted);font-size:12px;font-weight:600;transition:all 0.2s;font-family:inherit" onmouseover="this.style.background='rgba(255,48,88,0.08)';this.style.color='var(--accent)';this.style.borderColor='rgba(255,48,88,0.45)'" onmouseout="this.style.background='none';this.style.color='var(--muted)';this.style.borderColor='rgba(255,48,88,0.25)'">
        <span style="font-size:14px">â†’</span>
        <span>Log Out</span>
      </button>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content" id="mainContent">
    <div class="topbar">
      <div class="topbar-left">
        <button class="hamburger" id="hamburgerBtn" onclick="toggleMobileSidebar()"><span></span><span></span><span></span></button>
        <div class="topbar-title" id="topbarTitle">Dashboard</div>
      </div>
      <div class="topbar-right">
        <button class="btn btn-ghost btn-sm" onclick="openCmdPalette()" title="Search (Ctrl+K)" style="display:flex;align-items:center;gap:6px;padding:6px 10px;font-size:12px;color:var(--muted)"><span>ðŸ”</span><span style="font-size:10px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:1px 5px;font-family:monospace">âŒ˜K</span></button>
        <div class="provider-badge" id="providerBadge"><div class="provider-dot"></div><span id="providerLabel">âš¡ Groq</span></div>
        <button class="icon-btn" onclick="toggleTheme()" id="themeBtn2" title="Toggle theme">ðŸŒ™</button>
        <button class="btn btn-ghost btn-sm" onclick="logout()" title="Logout"><span class="exit-label">â† Exit</span><span class="exit-icon" style="display:none">âï¸</span></button>
      </div>
    </div>
    <div class="page-content" id="pageContent"></div>
  </div>
</div>

<!-- MOBILE NAV -->
<div class="mob-nav" id="mobNav" style="display:none;">
  <div class="mob-nav-inner">
    <button class="mob-nav-btn" id="mob-dashboard" onclick="navTo('dashboard')"><span class="micon">ðŸ </span>Home</button>
    <button class="mob-nav-btn" id="mob-trends" onclick="navTo('trends')"><span class="micon">ðŸ“ˆ</span>Trends</button>
    <button class="mob-nav-btn" id="mob-script" onclick="navTo('script')"><span class="micon">âœï¸</span>Script</button>
    <button class="mob-nav-btn" id="mob-thumbnail" onclick="navTo('thumbnail')"><span class="micon">ðŸŽ¨</span>Thumb</button>
    <button class="mob-nav-btn" id="mob-more" onclick="toggleMobileSidebar()"><span class="micon">â˜°</span>More</button>
  </div>
</div>

<!-- MOBILE SIDEBAR OVERLAY -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileSidebar()"></div>
<div class="sidebar-mobile" id="mobileSidebar">
  <div class="sidebar-logo" style="padding:22px 20px 16px">
    <div style="display:flex;align-items:center;gap:10px">
      <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0">
  <defs>
    <linearGradient id="tvgm1" x1="0" y1="0" x2="32" y2="32" gradientUnits="userSpaceOnUse">
      <stop offset="0%" stop-color="#ff3058"/>
      <stop offset="100%" stop-color="#ff7b00"/>
    </linearGradient>
    <linearGradient id="tvgm2" x1="0" y1="0" x2="32" y2="32" gradientUnits="userSpaceOnUse">
      <stop offset="0%" stop-color="#ff3058" stop-opacity="0.3"/>
      <stop offset="100%" stop-color="#ff7b00" stop-opacity="0.1"/>
    </linearGradient>
  </defs>
  <rect width="32" height="32" rx="8" fill="url(#tvgm2)" stroke="url(#tvgm1)" stroke-width="1.2"/>
  <path d="M12 9.5L23.5 16L12 22.5V9.5Z" fill="url(#tvgm1)"/>
  <path d="M6 22L10 17L14 20L18 14L22 16L26 10" stroke="#00e5b0" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
  <circle cx="26" cy="10" r="2" fill="#00e5b0"/>
</svg>
      <div>
        <div class="sidebar-logo-text" style="font-size:20px;letter-spacing:2px">TREND<span>VID</span></div>
        <div class="sidebar-tagline">AI Content Studio</div>
      </div>
    </div>
    <div class="ai-status-pill" style="margin-top:8px"><div class="ai-status-dot"></div><span>Groq AI Â· Active</span></div>
  </div>
  <div class="sidebar-nav" style="flex:1">
    <div class="sidebar-section">HOME</div>
    <button class="nav-item" onclick="navTo('dashboard');closeMobileSidebar()"><span class="icon">ðŸ </span>Dashboard</button>
    <button class="nav-item" onclick="navTo('leaderboard');closeMobileSidebar()" style="background:linear-gradient(135deg,rgba(255,215,0,0.08),rgba(255,138,0,0.04));border:1px solid rgba(255,215,0,0.2)"><span class="icon">ðŸ†</span>Leaderboard<span class="nav-badge" style="background:linear-gradient(135deg,#ffd700,#ff8a00);color:#000;font-weight:900">NEW</span></button>
    <div class="sidebar-section">CREATE</div>
    <button class="nav-item" onclick="navTo('trends');closeMobileSidebar()"><span class="icon">ðŸ“ˆ</span>Trend Radar</button>
    <button class="nav-item" onclick="navTo('script');closeMobileSidebar()"><span class="icon">âœï¸</span>Script Generator</button>
    <button class="nav-item" onclick="navTo('thumbnail');closeMobileSidebar()"><span class="icon">ðŸŽ¨</span>Thumbnail AI</button>
    <div class="sidebar-section">MANAGE</div>
    <button class="nav-item" onclick="navTo('library');closeMobileSidebar()"><span class="icon">ðŸ“š</span>Script Library</button>
    <button class="nav-item" onclick="navTo('calendar');closeMobileSidebar()"><span class="icon">ðŸ“…</span>Content Calendar</button>
    <button class="nav-item" onclick="navTo('favourites');closeMobileSidebar()"><span class="icon">â­</span>Favourites</button>
    <div class="sidebar-section">TOOLS</div>
    <button class="nav-item" onclick="navTo('voice');closeMobileSidebar()"><span class="icon">ðŸŽ™ï¸</span>Voice to Script</button>
    <button class="nav-item" onclick="navTo('teleprompter');closeMobileSidebar()"><span class="icon">ðŸ“º</span>Teleprompter</button>
    <button class="nav-item" onclick="navTo('hashtags');closeMobileSidebar()"><span class="icon">#ï¸âƒ£</span>Hashtag & SEO</button>
    <button class="nav-item" onclick="navTo('hooktester');closeMobileSidebar()"><span class="icon">âš¡</span>Hook Tester</button>
    <button class="nav-item" onclick="navTo('repurpose');closeMobileSidebar()"><span class="icon">â™»ï¸</span>Script Repurposer</button>
    <button class="nav-item" onclick="navTo('brandkit');closeMobileSidebar()"><span class="icon">ðŸŽ¨</span>Brand Kit</button>
    <button class="nav-item" onclick="navTo('alerts');closeMobileSidebar()"><span class="icon">ðŸ””</span>Trend Alerts</button>
    <button class="nav-item" onclick="navTo('abtitle');closeMobileSidebar()"><span class="icon">ðŸ†š</span>A/B Title Tester</button>
    <button class="nav-item" onclick="navTo('gapfinder');closeMobileSidebar()"><span class="icon">ðŸ”­</span>Content Gaps</button>
    <button class="nav-item" onclick="navTo('multilang');closeMobileSidebar()"><span class="icon">ðŸŒ</span>Multi-Language</button>
    <button class="nav-item" onclick="navTo('affiliate');closeMobileSidebar()"><span class="icon">ðŸ”—</span>Affiliate</button>
    <button class="nav-item" onclick="navTo('viral');closeMobileSidebar()"><span class="icon">ðŸš€</span>Viral Score</button>
    <button class="nav-item" onclick="navTo('health');closeMobileSidebar()"><span class="icon">ðŸ“Š</span>Channel Health</button>
    <button class="nav-item" onclick="navTo('broll');closeMobileSidebar()"><span class="icon">ðŸŽ¬</span>B-Roll Ideas</button>
    <button class="nav-item" onclick="navTo('music');closeMobileSidebar()"><span class="icon">ðŸŽµ</span>Music Picks</button>
    <button class="nav-item" onclick="navTo('captions');closeMobileSidebar()"><span class="icon">ðŸ’¬</span>Caption Gen</button>
    <button class="nav-item" onclick="navTo('comments');closeMobileSidebar()"><span class="icon">ðŸ’­</span>Comment Replies</button>
    <button class="nav-item" onclick="navTo('improver');closeMobileSidebar()"><span class="icon">âœ¨</span>Script Improver</button>
    <button class="nav-item" onclick="navTo('giftcodes');closeMobileSidebar()"><span class="icon">ðŸŽ</span>Gift Codes</button>
    <button class="nav-item" onclick="navTo('soundtrack');closeMobileSidebar()"><span class="icon">ðŸŽµ</span>Soundtrack</button>
    <button class="nav-item" onclick="navTo('bundles');closeMobileSidebar()"><span class="icon">ðŸ“¦</span>Bundle Deals</button>
    <div class="sidebar-section">ACCOUNT</div>
    <button class="nav-item" onclick="navTo('pricing');closeMobileSidebar()"><span class="icon">ðŸ’Ž</span>Plans & Pricing</button>
    <button class="nav-item" onclick="navTo('xp');closeMobileSidebar()" id="xpNavBtnMobile" style="position:relative"><span class="icon">â­</span>XP & Levels<span class="nav-badge" id="xpLevelBadgeMobile" style="background:linear-gradient(135deg,var(--gold),var(--accent2));color:#000;font-weight:900">1</span></button>
    <button id="adminNavBtnMobile2" style="display:none;border:1px solid rgba(251,191,36,0.3);background:rgba(251,191,36,0.05);color:var(--gold);position:relative" class="nav-item" onclick="navTo('admin');closeMobileSidebar()"><span class="icon">ðŸ›¡ï¸</span>Admin Panel<span id="adminNotifBadgeMobile" style="display:none;position:absolute;right:10px;top:50%;transform:translateY(-50%);background:var(--accent);color:#fff;border-radius:10px;padding:1px 7px;font-size:10px;font-weight:900"></span></button>
    <button class="nav-item" onclick="navTo('settings');closeMobileSidebar()"><span class="icon">âš™ï¸</span>Settings</button>
    <button class="nav-item" onclick="navTo('help');closeMobileSidebar()"><span class="icon">ðŸ’¬</span>Help & AI Chat</button>
  </div>
  <div class="sidebar-bottom">
    <!-- XP mini chip for mobile sidebar -->
    <div class="xp-sidebar-chip" id="xpSidebarChipMobile" onclick="closeMobileSidebar();navTo('xp')" title="View XP & Levels" style="margin-bottom:10px">
      <div class="xp-chip-top">
        <span class="xp-chip-level" id="xpChipLevelMobile">LVL 1</span>
        <span class="xp-chip-badge" id="xpChipBadgeMobile">ðŸŒ±</span>
      </div>
      <div class="xp-chip-bar"><div class="xp-chip-fill" id="xpChipFillMobile" style="width:0%"></div></div>
      <div class="xp-chip-label" id="xpChipLabelMobile">0 / 100 XP Â· Tap to view rewards</div>
    </div>
    <div class="user-chip">
      <div class="user-avatar" id="mobileAvatarIcon">ðŸ˜Ž</div>
      <div class="user-info">
        <div class="user-name" id="mobileSidebarName">Creator</div>
        <div class="user-plan" id="mobileSidebarPlan"><span class="tier-badge tier-free">FREE</span></div>
      </div>
    </div>
    <button onclick="closeMobileSidebar();logout();" style="width:100%;display:flex;align-items:center;justify-content:center;gap:8px;padding:10px;margin-top:10px;background:rgba(255,48,88,0.07);border:1px solid rgba(255,48,88,0.25);border-radius:10px;cursor:pointer;color:var(--accent);font-size:12px;font-weight:700;font-family:inherit">
      <span>â†’</span>Log Out
    </button>
  </div>
</div>

<!-- LOGIN / SIGNUP MODAL -->
<div class="modal-overlay" id="loginModal">
  <div class="modal-box" style="max-width:440px">
    <div class="modal-logo">TREND<span>VID</span></div>

    <!-- MODE TABS -->
    <div style="display:flex;background:var(--surface2);border-radius:12px;padding:4px;margin-bottom:22px;gap:4px">
      <button id="tabSignin" onclick="switchAuthMode('signin')" style="flex:1;padding:9px;border-radius:9px;border:none;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.2s;background:var(--accent);color:#fff;font-family:var(--font-display)">Sign In</button>
      <button id="tabSignup" onclick="switchAuthMode('signup')" style="flex:1;padding:9px;border-radius:9px;border:none;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.2s;background:transparent;color:var(--muted);font-family:var(--font-display)">Create Account</button>
    </div>

    <div class="modal-error" id="loginError">âš ï¸ Please check your details and try again.</div>
    <div class="modal-error" id="loginSuccess" style="background:rgba(0,212,170,0.1);border-color:rgba(0,212,170,0.3);color:var(--teal)">âœ… Account created! Signing you inâ€¦</div>

    <!-- NAME (signup only) -->
    <div class="form-field" id="signupNameField" style="display:none">
      <label>Your Name</label>
      <input class="form-input" id="signupName" type="text" placeholder="e.g. Jamie Smith" autocomplete="name" onkeydown="if(event.key==='Enter')doAuth()">
    </div>

    <!-- EMAIL -->
    <div class="form-field">
      <label>Email Address</label>
      <input class="form-input" id="loginEmail" type="email" placeholder="your@email.com" autocomplete="email" onkeydown="if(event.key==='Enter')doAuth()">
      <!-- Email verify (signup only) -->
      <div id="confirmEmailWrap" style="display:none;margin-top:8px">
        <input class="form-input" id="confirmEmail" type="email" placeholder="Confirm your email" autocomplete="email" onkeydown="if(event.key==='Enter')doAuth()" style="border-color:var(--border2)">
        <div id="emailMatchMsg" style="font-size:11px;margin-top:5px;display:none"></div>
      </div>
    </div>

    <!-- PASSWORD -->
    <div class="form-field">
      <label>Password</label>
      <div style="position:relative">
        <input class="form-input" id="loginPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')doAuth()" style="padding-right:44px">
        <button onclick="togglePw('loginPassword','pwToggle1')" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px" id="pwToggle1">ðŸ‘</button>
      </div>
    </div>

    <!-- CONFIRM PASSWORD (signup only) -->
    <div class="form-field" id="confirmPwField" style="display:none;margin-bottom:6px">
      <label>Confirm Password</label>
      <div style="position:relative">
        <input class="form-input" id="confirmPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password" onkeydown="if(event.key==='Enter')doAuth()" style="padding-right:44px" oninput="checkPwMatch()">
        <button onclick="togglePw('confirmPassword','pwToggle2')" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px" id="pwToggle2">ðŸ‘</button>
      </div>
      <div id="pwMatchMsg" style="font-size:11px;margin-top:5px;display:none"></div>
    </div>

    <!-- WEEKLY REPORTS OPT-IN (signup only) -->
    <div id="weeklyReportsRow" style="display:none;background:rgba(0,212,170,0.05);border:1px solid rgba(0,212,170,0.18);border-radius:10px;padding:11px 14px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div>
        <div style="font-size:12px;font-weight:700;margin-bottom:2px">ðŸ“Š Weekly Performance Reports</div>
        <div style="font-size:11px;color:var(--muted)">Get trend insights & your stats every Monday</div>
      </div>
      <button class="toggle on" id="weeklyReportsToggle"></button>
    </div>

    <!-- SUBMIT BUTTON -->
    <button class="btn btn-primary" style="width:100%;margin-bottom:14px" onclick="doAuth()" id="loginBtn">Sign In â†’</button>

    <!-- DEMO LOGINS -->
    <div style="text-align:center;margin-bottom:12px">
      <div style="font-size:10px;color:var(--muted);margin-bottom:7px;font-weight:700;letter-spacing:1px;font-family:var(--font-display)">OR TRY A DEMO PLAN</div>
      <div style="display:flex;gap:5px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-ghost btn-sm" style="font-size:10px;padding:5px 9px" onclick="demoLogin('free')">ðŸŒ± Free</button>
        <button class="btn btn-ghost btn-sm" style="border-color:rgba(0,229,176,0.4);color:var(--teal);font-size:10px;padding:5px 9px" onclick="demoLogin('starter')">ðŸš€ Starter</button>
        <button class="btn btn-ghost btn-sm" style="border-color:rgba(255,48,88,0.4);color:var(--accent);font-size:10px;padding:5px 9px" onclick="demoLogin('pro')">âš¡ Pro</button>
        <button class="btn btn-ghost btn-sm" style="border-color:rgba(251,191,36,0.5);color:var(--gold);font-size:10px;padding:5px 9px" onclick="demoLogin('gold')">ðŸ‘‘ Gold</button>
        <button class="btn btn-ghost btn-sm" style="border-color:rgba(192,132,252,0.5);color:var(--elite);font-size:10px;padding:5px 9px" onclick="demoLogin('elite')">ðŸ’Ž Elite</button>
      </div>
    </div>

    <button class="btn btn-ghost btn-sm" style="width:100%" onclick="closeLoginModal()">â† Back to home</button>
  </div>
</div>

<!-- ONBOARDING MODAL -->
<!-- ONBOARDING NAME MODAL -->
<div class="onboarding-overlay" id="onboardingModal">
  <div class="onboarding-box">
    <span class="onboarding-emoji">ðŸ‘‹</span>
    <div class="onboarding-title">What should we call you?</div>
    <div class="onboarding-sub">We'll use your name on your dashboard, scripts, and everywhere across TrendVid.</div>
    <input class="onboarding-input" id="onboardingNameInput" type="text" placeholder="Enter your name..." maxlength="40" autocomplete="given-name" onkeydown="if(event.key==='Enter')submitOnboardingName()">
    <div class="onboarding-suggestions">
      <div class="onboarding-sug" onclick="pickOnboardingName(this)">Alex</div>
      <div class="onboarding-sug" onclick="pickOnboardingName(this)">Jordan</div>
      <div class="onboarding-sug" onclick="pickOnboardingName(this)">Sam</div>
      <div class="onboarding-sug" onclick="pickOnboardingName(this)">Chris</div>
      <div class="onboarding-sug" onclick="pickOnboardingName(this)">Taylor</div>
      <div class="onboarding-sug" onclick="pickOnboardingName(this)">Morgan</div>
    </div>
    <button class="btn btn-primary" style="width:100%;margin-top:18px;padding:15px;font-size:15px;border-radius:14px;" onclick="submitOnboardingName()">Let's Go ðŸš€</button>
  </div>
</div>


</div><!-- /app -->

<!-- TELEPROMPTER OVERLAY -->
<div class="teleprompter-overlay" id="teleprompterOverlay">
  <div class="teleprompter-scroll" id="tpScrollWrap">
    <div class="teleprompter-fade-top"></div>
    <div class="tp-cursor-line"></div>
    <div class="teleprompter-text" id="tpScrollText">Your script will appear here</div>
    <div class="teleprompter-fade-bot"></div>
  </div>
  <div class="teleprompter-controls">
    <button class="tp-btn" onclick="tpTogglePlay()" id="tpPlayBtn">â–¶ Play</button>
    <button class="tp-btn" onclick="tpPos=0;document.getElementById('tpScrollText').style.transform='translateY(0)'">â†º Restart</button>
    <div style="display:flex;align-items:center;gap:8px">
      <span style="font-size:12px;color:#888">Speed:</span>
      <button class="tp-btn" style="padding:6px 12px" onclick="tpSpeed=Math.max(0.2,tpSpeed-0.3)">âˆ’</button>
      <span style="font-size:13px;color:#fff;min-width:30px;text-align:center" id="tpSpeedDisplay">1.5x</span>
      <button class="tp-btn" style="padding:6px 12px" onclick="tpSpeed=Math.min(5,tpSpeed+0.3)">+</button>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <span style="font-size:12px;color:#888">Size:</span>
      <button class="tp-btn" style="padding:6px 12px" onclick="const el=document.getElementById('tpScrollText');el.style.fontSize=(parseInt(el.style.fontSize||42)-4)+'px'">Aâˆ’</button>
      <button class="tp-btn" style="padding:6px 12px" onclick="const el=document.getElementById('tpScrollText');el.style.fontSize=(parseInt(el.style.fontSize||42)+4)+'px'">A+</button>
    </div>
    <button class="tp-btn" onclick="closeTeleprompter()" style="background:#2a0010;border-color:#ff3058;color:#ff3058">âœ• Exit</button>
  </div>
</div>
<div class="notif" id="notif"></div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false">
// ============================================================
// AES-256-GCM ENCRYPTED LOCAL STORAGE
// All tv_* keys are transparently encrypted at rest.
// Key = PBKDF2(deviceFingerprint + appSalt, 310,000 iterations, SHA-256) â†’ AES-256-GCM
// Passwords = SHA-256(pw + perUserSalt) â€” never stored as plaintext or btoa
// ============================================================

const _TV_ENC_VERSION = 'tvenc1';  // prefix to detect encrypted values
const _TV_APP_SALT    = 'TrendVid_2025_$t0r@ge_S@lt_v2!';
const _TV_PW_SALT     = 'TrendVid_PW_S@lt_2025_!#$';

// â”€â”€ Derive a stable device fingerprint (non-sensitive, just for key derivation) â”€â”€
function _tvFingerprint() {
  var fp = [
    navigator.language || '',
    (screen.width || '') + 'x' + (screen.height || ''),
    Intl.DateTimeFormat().resolvedOptions().timeZone || '',
    navigator.hardwareConcurrency || '',
    navigator.platform || '',
  ].join('|');
  return fp || 'tv-default-device';
}

// â”€â”€ Import raw bytes as AES-GCM CryptoKey â”€â”€
async function _tvImportKey(rawKeyBytes) {
  return crypto.subtle.importKey('raw', rawKeyBytes, {name:'AES-GCM'}, false, ['encrypt','decrypt']);
}

// â”€â”€ Derive AES-256-GCM key via PBKDF2 â”€â”€
let _tvCryptoKey = null; // cached after first derivation
async function _tvGetKey() {
  if (_tvCryptoKey) return _tvCryptoKey;
  try {
    var fp       = _tvFingerprint();
    var material = await crypto.subtle.importKey(
      'raw', new TextEncoder().encode(fp + _TV_APP_SALT),
      'PBKDF2', false, ['deriveKey']
    );
    var saltBytes = new TextEncoder().encode(_TV_APP_SALT + fp.slice(0,8));
    _tvCryptoKey = await crypto.subtle.deriveKey(
      { name:'PBKDF2', salt:saltBytes, iterations:310000, hash:'SHA-256' },
      material,
      { name:'AES-GCM', length:256 },
      false,
      ['encrypt','decrypt']
    );
    return _tvCryptoKey;
  } catch(e) {
    // Fallback: generate a session key (data won't persist across sessions but won't crash)
    var raw = crypto.getRandomValues(new Uint8Array(32));
    _tvCryptoKey = await _tvImportKey(raw);
    return _tvCryptoKey;
  }
}

// â”€â”€ Encrypt a string â†’ base64 ciphertext (with random IV prepended) â”€â”€
async function tvEncrypt(plaintext) {
  try {
    var key = await _tvGetKey();
    var iv  = crypto.getRandomValues(new Uint8Array(12)); // 96-bit IV for GCM
    var enc = await crypto.subtle.encrypt(
      {name:'AES-GCM', iv:iv},
      key,
      new TextEncoder().encode(plaintext)
    );
    // Combine IV + ciphertext, base64-encode the whole thing
    var combined = new Uint8Array(iv.byteLength + enc.byteLength);
    combined.set(iv, 0);
    combined.set(new Uint8Array(enc), 12);
    var b64 = btoa(String.fromCharCode.apply(null, combined));
    return _TV_ENC_VERSION + ':' + b64;
  } catch(e) {
    return plaintext; // fallback: store unencrypted if crypto unavailable
  }
}

// â”€â”€ Decrypt a ciphertext string â†’ plaintext â”€â”€
async function tvDecrypt(stored) {
  try {
    if (!stored || !stored.startsWith(_TV_ENC_VERSION + ':')) return stored; // not encrypted
    var b64      = stored.slice(_TV_ENC_VERSION.length + 1);
    var bytes    = Uint8Array.from(atob(b64), function(c){ return c.charCodeAt(0); });
    var iv       = bytes.slice(0, 12);
    var cipher   = bytes.slice(12);
    var key      = await _tvGetKey();
    var plain    = await crypto.subtle.decrypt({name:'AES-GCM', iv:iv}, key, cipher);
    return new TextDecoder().decode(plain);
  } catch(e) {
    // If decryption failed on a tvenc1: blob (e.g. fingerprint/key drift between sessions),
    // return null so callers treat it as "no stored value" rather than leaking ciphertext.
    if (stored && stored.startsWith(_TV_ENC_VERSION + ':')) return null;
    return stored; // unencrypted legacy value â€” pass through
  }
}

// â”€â”€ SHA-256 password hashing â”€â”€
async function tvHashPassword(pw, email) {
  try {
    var input = pw + _TV_PW_SALT + (email || '').toLowerCase();
    var enc   = new TextEncoder().encode(input);
    var buf   = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(buf)).map(function(b){ return b.toString(16).padStart(2,'0'); }).join('');
  } catch(e) {
    // Fallback if SHA-256 unavailable
    return btoa(pw + (email||''));
  }
}

// â”€â”€ Encrypted localStorage wrapper â”€â”€
// All tv_* keys go through encryption. Other keys (e.g. _tv_ahash) pass through raw.
var _tvLSQueue = {}; // pending write queue so async doesn't race

var _nativeLS = {
  setItem:    localStorage.setItem.bind(localStorage),
  getItem:    localStorage.getItem.bind(localStorage),
  removeItem: localStorage.removeItem.bind(localStorage),
  clear:      localStorage.clear.bind(localStorage),
};

var _tvEncryptedLS = {
  // Synchronous read â€” returns encrypted string from native LS,
  // decryption happens lazily via tvDecrypt (async).
  // We cache decrypted values in memory for synchronous access.
  _cache: {},
  _dirty: {},

  _shouldEncrypt: function(key) {
    return typeof key === 'string' && (key.startsWith('tv_') || key.startsWith('_tv_'));
  },

  setItem: function(key, value) {
    if (!this._shouldEncrypt(key)) {
      return _nativeLS.setItem.call(localStorage, key, value);
    }
    // Update memory cache immediately
    this._cache[key] = value;
    // Queue async encrypt + write
    var self = this;
    clearTimeout(_tvLSQueue[key]);
    _tvLSQueue[key] = setTimeout(function() {
      tvEncrypt(value).then(function(cipher) {
        _nativeLS.setItem.call(localStorage, key, cipher);
      }).catch(function() {
        _nativeLS.setItem.call(localStorage, key, value);
      });
    }, 0); // next tick
  },

  getItem: function(key) {
    if (!this._shouldEncrypt(key)) {
      return _nativeLS.getItem.call(localStorage, key);
    }
    // Return from cache if we have it
    if (this._cache.hasOwnProperty(key)) return this._cache[key];
    // Synchronously read from native LS
    var raw = _nativeLS.getItem.call(localStorage, key);
    if (raw === null) return null;
    // If it's already encrypted, we can't synchronously decrypt (async API).
    // So: if encrypted, return null on first sync call, but kick off async warm.
    if (raw.startsWith(_TV_ENC_VERSION + ':')) {
      var self = this;
      tvDecrypt(raw).then(function(plain) {
        self._cache[key] = plain;
      });
      return null; // will be populated on next read after async warms up
    }
    // Unencrypted legacy value â€” cache and re-encrypt in background
    this._cache[key] = raw;
    this.setItem(key, raw); // re-encrypt
    return raw;
  },

  removeItem: function(key) {
    delete this._cache[key];
    return _nativeLS.removeItem.call(localStorage, key);
  },

  clear: function() {
    this._cache = {};
    return _nativeLS.clear.call(localStorage);
  },
};

// â”€â”€ Save native LS reference before patching â”€â”€

// â”€â”€ Warm up all existing keys into cache on startup â”€â”€
async function tvWarmEncryptedCache() {
  try {
    var key = await _tvGetKey(); // pre-derive key
    var keys = [];
    for (var i = 0; i < localStorage.length; i++) {
      var k = localStorage.key(i);
      if (k && (k.startsWith('tv_') || k.startsWith('_tv_'))) keys.push(k);
    }
    await Promise.all(keys.map(async function(k) {
      var raw = _nativeLS.getItem(k);
      if (!raw) return;
      if (raw.startsWith(_TV_ENC_VERSION + ':')) {
        var plain = await tvDecrypt(raw);
        // null means decryption failed (key drift) â€” don't cache the blob, treat as missing
        if (plain === null) return;
        _tvEncryptedLS._cache[k] = plain;
      } else {
        // Legacy unencrypted â€” cache and re-encrypt
        _tvEncryptedLS._cache[k] = raw;
        var cipher = await tvEncrypt(raw);
        _nativeLS.setItem(k, cipher);
      }
    }));
  } catch(e) {}
}

// â”€â”€ Patch localStorage methods â”€â”€
// We override setItem/getItem on the localStorage object itself
// so all existing code (localStorage.setItem, localStorage.getItem) is transparently encrypted.
(function _patchLocalStorage() {
  try {
    Object.defineProperty(localStorage, 'setItem', {
      value: function(key, value) { _tvEncryptedLS.setItem(key, value); },
      writable: true, configurable: true,
    });
    Object.defineProperty(localStorage, 'getItem', {
      value: function(key) { return _tvEncryptedLS.getItem(key); },
      writable: true, configurable: true,
    });
    Object.defineProperty(localStorage, 'removeItem', {
      value: function(key) { return _tvEncryptedLS.removeItem(key); },
      writable: true, configurable: true,
    });
  } catch(e) {
    // Can't patch â€” use fallback (data still works, just unencrypted)
  }
})();

// â”€â”€ Kick off cache warm immediately (async, non-blocking) â”€â”€
tvWarmEncryptedCache().catch(function(){});

// ============================================================
// ENCRYPTED PASSWORD HELPERS â€” replace btoa() usage
// ============================================================

// Hash a password for storage (async â€” used at signup/login)
// Returns hex SHA-256 string
async function tvHashPw(pw, email) {
  return tvHashPassword(pw, email);
}

// Check a plaintext password against a stored hash
async function tvCheckPw(pw, email, storedHash) {
  // Handle legacy btoa() hashes from before encryption upgrade
  if (storedHash && !storedHash.includes('') && storedHash.length < 50) {
    try { if (btoa(pw) === storedHash) return true; } catch(e) {}
  }
  var hash = await tvHashPw(pw, email);
  return hash === storedHash;
}



// ============================================================
// AI PROVIDER CONFIG â€” GROQ PRIMARY, GEMINI FALLBACK
// ============================================================

const APP_VERSION = 'v15';
const APP_BUILD_HASH = '56773c09fc50';

// Feature manifest - updated every time a new feature/page is added
// This is what the AI compares to detect changes and generate release notes
const APP_FEATURE_MANIFEST = {
  version: 'v15',
  buildDate: 'Feb 2026',
  pages: [
    'dashboard','trends','script','thumbnail','imagegen',
    'library','calendar','favourites','multilang','affiliate',
    'settings','help','voice','teleprompter','hashtags','hooktester',
    'repurpose','brandkit','alerts','abtitle','gapfinder','pricing',
    'viral','health','broll','music','captions','comments','improver',
    'giftcodes','soundtrack','bundles','admin','ytanalyse','descgen',
    'thumbab','collab','scheduler','xp','leaderboard','imagegen'
  ],
  features: [
    'AI Script Generator', 'Trend Radar', 'Thumbnail AI', 'Image Generator (free)',
    'Script Library', 'Content Calendar', 'Favourites', 'Multi-Language',
    'Voice to Script', 'Teleprompter', 'Hashtag & SEO', 'Hook Tester',
    'Script Repurposer', 'Brand Kit', 'Trend Alerts', 'A/B Title Tester',
    'Content Gap Finder', 'Viral Score', 'Channel Health', 'B-Roll Ideas',
    'Music Picks', 'Caption Generator', 'Comment Replies', 'Script Improver',
    'Gift Codes', 'Soundtrack Finder', 'Bundle Deals', 'YouTube Analyser',
    'Description Generator', 'Thumbnail A/B Tester', 'Collab Finder',
    'Post Scheduler', 'XP & Levels', 'Global Leaderboard',
    'Admin Panel', 'Promo Video Studio', 'Auto-Upload Manager',
    'AI Provider Switching', 'YouTube OAuth', 'Daily Streak System',
    'Dark/Light Mode', 'PWA Support'
  ],
  adminFeatures: [
    'User Management', 'Revenue Tracking', 'Activity Log', 'Feature Flags',
    'App Config', 'Stripe Integration', 'Broadcast Announcements',
    'AI Provider Management', 'Gift Code Generator', 'Bug Reports',
    'Security Log', 'Auto-Upload Manager', 'XP Manager', 'Level Manager',
    'Promo Video Studio', 'Weekly Email Manager', 'Changelog Manager'
  ],
  changelog: [
    'v15: Added Image Generator (free for all users) with 10 styles and 6 aspect ratios',
    'v15: Added TrendVid logo SVG to sidebar and landing page',
    'v15: Upgraded Promo Video length picker to visual button selector (8 options)',
    'v15: Added YouTube API auto-seeding on page load',
    'v14c: Added Promo Video Studio tab (admin-only) with AI script generation',
    'v14b: Fixed admin panel close button',
    'v14a: Added admin panel hamburger sidebar'
  ]
};

// ============================================================
// ENCRYPTED API KEY VAULT â€” AES-256-GCM + PBKDF2
// All keys encrypted at rest. Decrypted in memory only when needed.
// Plaintext keys never appear in source code.
// ============================================================
const _KV = (function() {
  var _f = ['TrendVid','2026#Sec','ure!KeyV','ault$XK9'];
  var _s = new Uint8Array([84,114,101,110,100,86,105,100,83,97,108,116,50,48,49,54]);
  var _blobs = {
    k1:  'hJnTwWuMRC74j0FjPu43VvdXwXnW13vnTmaCkqaglB04pNpdn+htqynh0a3p9WJhsqulng/HwVBiBz54kfgHLStuAKLICnNyosO0PoXUkghrPadG',
    k2:  'cszaDvxA/ML4zrflK5Xyz2lqnLAtsSPt4z6yTYzDbcnzY4a3mtihq5UsI8iy55Q46DbPG5spimS+YbY4FITdnp4Bu0MJoCLDE/RmlIdtGNthZH5Q',
    k3:  '24Tz47uq+FHzTTNfD/Y/MoCRsL5uGyvlX/eZwWziZsia4nT2zgGuQsBzO882wqzc1GACziAn6j8DXtlg0+67wI3MK0tgl05fJvWBFXEgLTiMs4B9',
    k4:  't+oUfPpcVEGnfspDJg9sYRAxvh3KIHEquJW1e76Y6QcW/QF3Q7zvjmfp9I3vUM2IFZM9lulOsRzRBJ1Zm6VFjoNjgNJAaBNQRnc1IUuj5VcvxbSS',
    k5:  'fp2HXS0OPCVxGD7qSibILNUFWyDW0piAQV7/GvyTtLzoRHqagmn5K7P5Wsq05vQsryB5HhB0Y8hWpxBbvW5shwIzBzz5ld2CUc7TfUVaSO2LTVbl',
    k6:  'EobQUP8NMJ1UCEDDq8823M6HInR0wxt2Pg7PzjB/sKRHNut3mmnwhZXGkpWvkqcf3MUWXO0Bck0fG75EywE9WQbCuXrk1TeuxcUAdwOIAYGfS4lj',
    k7:  'NZL4+uCopHhk/uEObDKcufhupNGDNN0Lj8PyJ87L8ezUEto1NAgL2036DWAiHKeAh4zG5MIHPKyWYFWktU45pQACQoCzybOxWwRBov/yZo8rNvv1',
    k8:  '799Y+3hstc0xedOsGKvFL7aAAj9Z0wBvDLfFIZ3wRT+iunG/5szMJ18Cbrh1Qo5C/jdNoMs93LDMkfayfaOv1TwchguxfYT14LgXE5EgXvJlrIIJ',
    k9:  '7w7FawLmARp6Qxe8elYAkCHkRnNJyx8imCl8WQE/pNM8PUHntvzEX47u8dTZL9q3jv+39rT8g9zvyzJsI4xTj6rI6g2vyvZ7eHMP0A+mlw4BvQxq',
    k10: 'QzbkwFQjs1G+qfs2SsBkKe9gEvUPRohdR812uv4umPBCLylMC7JheLLFNOGtWfhWQsvep6bvOKDV198XwG2q3tGr8gEeGLCckdlYCo9LwyURiOjQ',
    k11: 'D2/b/6jjQStPgH132SPYc6KEQNOTyn64zHMLe/PBqZv1diL8hdAVrX6OLqpIdvDyW5yGLVvZ6hfVBc/oaBs2gnWcfQwb/3yvSiq6zQcT+oMkZGLm',
    k12: 'azXYKF2woVE2TYBeqYUkgP06hG1DL61E9U1m3h9Tkpszb52Q8lLbEFRFl6Cs66wZy7JQ+AlZEucXJT5YEa3j8RMk0bfAIsi85YjVrxHW/m1f5PyR',
    k13: '5IyFCBV58IcLwprB936BE3xWofxHlvCRhiqpWjarKGMhgrUlvlYkGpqFmTRJI6TzKTvRKzFqxH0PWtvFqFnCmqEABDrumgKNd74Kd891mdCbofhw',
    k14: 'yEnkoenjn0tFazrHnPPnXiGBsBfx/ZkzeHDTcqroZ1WUTgLcvohXnK5fT3lMZuUsEtVB6Do95ldEeAbFO27YqJ73Pm0krV8e0D6r7paN+3LiXBOP',
    k15: '/yhOo6waPruytph7RyfoVkohDDU97rmkfahDxpCevEc1qsA94fxrO/t5IDcPheOd9E8msYHz4EIjM11/3j0URHmJI5THI3vSrfWs1Azt+gv3WwN8',
    k16: 'xUB3sC/WnqlS0BnYGie9lr6Gva5+sY1PXBk9xfkbC9GD5idG0R58bFTiU7b0uSgkQ4gj9nP5Pvm0y8fsK0jQ4d8PHfKPZNxlCawdDOKTY4aceJNu',
    adm1:'hJnTwWuMRC74j0FjPu43VvdXwXnW13vnTmaCkqaglB04pNpdn+htqynh0a3p9WJhsqulng/HwVBiBz54kfgHLStuAKLICnNyosO0PoXUkghrPadG',
    adm2:'xUB3sC/WnqlS0BnYGie9lr6Gva5+sY1PXBk9xfkbC9GD5idG0R58bFTiU7b0uSgkQ4gj9nP5Pvm0y8fsK0jQ4d8PHfKPZNxlCawdDOKTY4aceJNu',
  };
  var _dk = null;
  var _cache = {};

  function _b64ToBytes(b64) {
    var bin = atob(b64), arr = new Uint8Array(bin.length);
    for (var i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
    return arr;
  }

  async function _getKey() {
    if (_dk) return _dk;
    var enc2 = new TextEncoder();
    var raw = enc2.encode(_f.join(''));
    var base = await crypto.subtle.importKey('raw', raw, 'PBKDF2', false, ['deriveKey']);
    _dk = await crypto.subtle.deriveKey(
      {name:'PBKDF2', salt:_s, iterations:100000, hash:'SHA-256'},
      base,
      {name:'AES-GCM', length:256},
      false,
      ['decrypt']
    );
    return _dk;
  }

  async function _dec(blob) {
    if (_cache[blob]) return _cache[blob];
    var bytes = _b64ToBytes(blob);
    var nonce = bytes.slice(0,12);
    var ct = bytes.slice(12);
    var k = await _getKey();
    var plain = await crypto.subtle.decrypt({name:'AES-GCM', iv:nonce}, k, ct);
    var result = new TextDecoder().decode(plain);
    _cache[blob] = result;
    return result;
  }

  return {
    get: function(id) { return _dec(_blobs[id]); },
    getSharedPool: function() {
      return Promise.all(['k1','k2','k3','k4','k5','k6','k7','k8','k9','k10','k11','k12','k13','k14','k15','k16'].map(function(id){ return _dec(_blobs[id]); }));
    },
    getAdminPool: function() {
      return Promise.all(['adm1','adm2'].map(function(id){ return _dec(_blobs[id]); }));
    }
  };
})();


// ============================================================
// HF KEY VAULT â€” AES-256-GCM, same scheme as Groq vault
// ============================================================
const _HF_KV = (function() {
  var _f = ['TrendVid','2026#Sec','ure!KeyV','ault$XK9'];
  var _s = new Uint8Array([84,114,101,110,100,86,105,100,83,97,108,116,50,48,49,54]);
  var _blobs = [
    '7Dl3++zJEBs7LWjHs5NdkUvhY19WjS0fLFVxvcYD8Nj71kw3Ntslw+mopfCiRqP9YHZnNfJiovS636raJA1UGh4=',
    'v2qw3ta1KIJCMdOIQa6syU3EPMLhhOdV2ZOFyIPMDlRNuooXJWQAxIPrGIewtsHu6XBBpsesg8NppR81XDhZV2Y=',
    'UIV8KeHI2cvKfAgaCx9uUdXbBZVCuPOE8NbfwcNvbJLk+MlopXNkWqj4YLlEBhSxBSSe+/ayLSvLQz+rPZgw96I=',
    'jMo5Cx7Z37mscpgiaIGjGA7LNI8nWrjpRWDbKgLqNQ+AoR5+M/m6UVMOQt1wNGmup63/KmFNS2dq+eHRSMzcvqA=',
    'SATXGy2iOXC03YGnTIjbN7GEXRDgC4s3hDy4kpmU9ETSufLBrZFJRKmA0QSu4fmMWDpQ4Y2wZf9N1Kia8D9NJ84=',
    'TXL6gtTgyokhEAEAritzde+edWUlmkfcMIz91lC7YlQxEjPMIWZ6XDq7NBDak4ZkoysnGVjaIdkYkt5AwR00v/w=',
    'Zf6aUFWAbaFcal0A2iIXxzE5RHsD1x30uPwQM5UIf/ernnDG1/yE4r3fC6k+MdDKh81iVAiuNqWxHANtWvqoDDI=',
    'aOstgi4xyTAVo4HmZ2czRi2v2Dqbs9TiQeSqB9V2cZBRSOGDO7UVsl5SymVs+X7sgzGJ5wBQxD91uj0ZTHUOTiY=',
    'U3Zfk2EoTIxltHM7cCadlpXJbrYfhfGP0ix+hpvrekFfJQeCj192X9LmOsH6QzXS7zhRe4asTLJ/Fz6GCIY9GHw=',
    'A4rebRjzDD5FR7doAdGtYWOJFNqwpzb59CyF98LhqK5dIpvwQv2JDY+KZgkeliyQumLM0ZIcQYMG7aqXtecqH2w=',
    'WnbW1Q5gy17j5wFVd0vapUI5w2A7zQ6QFqjRgYV4bGYWJsFP5S7MoNutJ/m+0LfIwQ4fsP3/wkDxlXAJ1J8O21g=',
  ];
  var _dk = null;
  var _cache = {};
  function _b64ToBytes(b64) {
    var bin = atob(b64), arr = new Uint8Array(bin.length);
    for (var i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
    return arr;
  }
  async function _getKey() {
    if (_dk) return _dk;
    var raw = new TextEncoder().encode(_f.join(''));
    var base = await crypto.subtle.importKey('raw', raw, 'PBKDF2', false, ['deriveKey']);
    _dk = await crypto.subtle.deriveKey(
      {name:'PBKDF2', salt:_s, iterations:100000, hash:'SHA-256'},
      base, {name:'AES-GCM', length:256}, false, ['decrypt']
    );
    return _dk;
  }
  async function _dec(blob) {
    if (_cache[blob]) return _cache[blob];
    var bytes = _b64ToBytes(blob);
    var plain = await crypto.subtle.decrypt({name:'AES-GCM', iv:bytes.slice(0,12)}, await _getKey(), bytes.slice(12));
    var result = new TextDecoder().decode(plain);
    _cache[blob] = result;
    return result;
  }
  return {
    getPool: function() {
      return Promise.all(_blobs.map(function(b){ return _dec(b); }));
    }
  };
})();

// HF key pool â€” resolved once, then cycled through
var _hfKeyPool = [];
var _hfKeyIdx = 0;
async function _getNextHFKey() {
  if (!_hfKeyPool.length) {
    try {
      _hfKeyPool = await _HF_KV.getPool();
      _hfKeyPool = _hfKeyPool.filter(function(k){ return k && k.startsWith('hf_'); });
    } catch(e) { _hfKeyPool = []; }
    // Also add any manually set key from settings
    var manualKey = localStorage.getItem('tv_hf_key') || '';
    if (manualKey && _hfKeyPool.indexOf(manualKey) === -1) _hfKeyPool.unshift(manualKey);
  }
  if (!_hfKeyPool.length) return '';
  // Round-robin cycle
  var key = _hfKeyPool[_hfKeyIdx % _hfKeyPool.length];
  _hfKeyIdx++;
  return key;
}

// Compat stubs â€” actual values resolved async from _KV
const GROQ_KEY    = '';
const GROQ_KEY_2  = '';
const GROQ_KEY_3  = '';
const GROQ_KEY_4  = '';
const GROQ_KEY_5  = '';
const GROQ_KEY_6  = '';
const GROQ_KEY_7  = '';
const GROQ_KEY_8  = '';
const GROQ_KEY_9  = '';
const GROQ_KEY_10 = '';
const GROQ_KEY_11 = '';
const GROQ_ADMIN_KEY_POOL = [];
const GROQ_ALL_KEYS = [];
function getAdminKeys() { return []; }
// GROQ_ALL_KEYS declared above in encrypted vault block
// SHARED GEMINI KEY â€” set once by admin, used by ALL users automatically
// Admin updates this via Settings â†’ AI Provider. No user ever needs to touch it.
var _SHARED_GEMINI_KEY = (function() {
  // First check localStorage for admin-saved key (persists across sessions on this device)
  try {
    var adminKey = localStorage.getItem('tv_gemini_key_shared');
    if (adminKey) return adminKey;
    // Fall back to legacy per-user key
    var legacyKey = localStorage.getItem('tv_gemini_key');
    if (legacyKey) return legacyKey;
  } catch(e) {}
  return '';
})();

// ============================================================
// AI PROVIDER MANAGER â€” dynamic, admin-controlled
// ============================================================
var _aiProviders = [];
var _activeProviderKey = null;

function initAIProviders() {
  try {
    // Auto-accept Cohere safety guidelines (stored flag)
    try { localStorage.setItem('tv_cohere_safety_accepted', '1'); } catch(e) {}
    var saved = localStorage.getItem('tv_ai_providers');
    if (saved) {
      _aiProviders = JSON.parse(saved);
    } else {
      _aiProviders = [
        { id: 'groq-default',     name: 'Groq',         model: 'llama-3.3-70b-versatile', type: 'groq',
          key: GROQ_KEY,          isPrimary: true,  paused: false, addedAt: Date.now(), callCount: 0 },
        { id: 'cerebras-default', name: 'Cerebras',     model: 'llama-3.3-70b',             type: 'cerebras',
          key: CEREBRAS_KEY,      isPrimary: false, paused: false, addedAt: Date.now(), callCount: 0 },
        { id: 'cohere-default',   name: 'Cohere',       model: 'command-r-plus',           type: 'cohere',
          key: COHERE_KEY,        isPrimary: false, paused: false, addedAt: Date.now(), callCount: 0 },
        { id: 'mistral-default',  name: 'Mistral',      model: 'mistral-large-latest',     type: 'mistral',
          key: MISTRAL_KEY,       isPrimary: false, paused: false, addedAt: Date.now(), callCount: 0 },
        { id: 'gemini-default',   name: 'Gemini 2.0 Flash', model: 'gemini-2.0-flash',         type: 'gemini',
          key: _SHARED_GEMINI_KEY || '', isPrimary: false, paused: true, addedAt: Date.now(), callCount: 0 }
      ];
      saveAIProviders();
    }
    // Sync keys from localStorage into provider objects (localStorage is the source of truth for user-entered keys)
    var groqP = _aiProviders.find(function(p){ return p.id === 'groq-default'; });
    var lsGroqKey = localStorage.getItem('tv_groq_key') || '';
    if (!groqP) {
      _aiProviders.unshift({ id:'groq-default', name:'Groq', model:'llama-3.3-70b-versatile', type:'groq', key:lsGroqKey, isPrimary:true, paused:false, addedAt:Date.now(), callCount:0 });
    } else {
      if (lsGroqKey) groqP.key = lsGroqKey; // prefer localStorage over stale saved key
      else if (!groqP.key) groqP.key = GROQ_KEY;
    }
    // Sync Cerebras
    var cerebrasP = _aiProviders.find(function(p){ return p.id === 'cerebras-default'; });
    var lsCerebrasKey = localStorage.getItem('tv_cerebras_key') || '';
    if (!cerebrasP) { _aiProviders.push({ id:'cerebras-default', name:'Cerebras', model:CEREBRAS_MODEL, type:'cerebras', key:lsCerebrasKey||CEREBRAS_KEY, isPrimary:false, paused:!lsCerebrasKey, addedAt:Date.now(), callCount:0 }); }
    else { if (lsCerebrasKey) cerebrasP.key = lsCerebrasKey; else if (!cerebrasP.key) cerebrasP.key = CEREBRAS_KEY; }
    // Sync Cohere
    var cohereP = _aiProviders.find(function(p){ return p.id === 'cohere-default'; });
    var lsCohereKey = localStorage.getItem('tv_cohere_key') || '';
    if (!cohereP) { _aiProviders.push({ id:'cohere-default', name:'Cohere', model:'command-r-plus', type:'cohere', key:lsCohereKey||COHERE_KEY, isPrimary:false, paused:!lsCohereKey, addedAt:Date.now(), callCount:0 }); }
    else { if (lsCohereKey) cohereP.key = lsCohereKey; else if (!cohereP.key) cohereP.key = COHERE_KEY; }
    // Sync Mistral
    var mistralP = _aiProviders.find(function(p){ return p.id === 'mistral-default'; });
    var lsMistralKey = localStorage.getItem('tv_mistral_key') || '';
    if (!mistralP) { _aiProviders.push({ id:'mistral-default', name:'Mistral', model:'mistral-large-latest', type:'mistral', key:lsMistralKey||MISTRAL_KEY, isPrimary:false, paused:!lsMistralKey, addedAt:Date.now(), callCount:0 }); }
    else { if (lsMistralKey) mistralP.key = lsMistralKey; else if (!mistralP.key) mistralP.key = MISTRAL_KEY; }
    // Sync shared Gemini key â€” admin sets once, all users get it.
    // Never auto-unpause Gemini â€” admin must explicitly enable it.
    if (_SHARED_GEMINI_KEY) {
      var gemP = _aiProviders.find(function(p){ return p.type === 'gemini'; });
      if (gemP) gemP.key = _SHARED_GEMINI_KEY; // key only, paused state untouched
    }
    // Set active provider to first non-paused primary
    var primary = _aiProviders.find(function(p){ return p.isPrimary && !p.paused; });
    _activeProviderKey = primary ? primary.id : (_aiProviders.find(function(p){ return !p.paused; }) || {}).id;
  } catch(e) {
    // init error silenced
    _aiProviders = [
      { id: 'groq-default', name: 'Groq', model: 'llama-3.3-70b-versatile', type: 'groq',
        key: GROQ_KEY, isPrimary: true, paused: false, addedAt: Date.now(), callCount: 0 }
    ];
  }
}

function saveAIProviders() {
  try { localStorage.setItem('tv_ai_providers', JSON.stringify(_aiProviders)); } catch(e) {}
}

// â”€â”€ Admin: toggle a single provider on/off â”€â”€
function adminToggleProvider(id, enabled) {
  if (!currentUser || !currentUser.isAdmin) return;
  var prov = _aiProviders.find(function(p){ return p.id === id; });
  if (!prov) { tvToast('Provider not found','error'); return; }
  prov.paused = !enabled;
  // If enabling and it's Groq, make it primary
  if (enabled && id === 'groq-default') prov.isPrimary = true;
  // Update active provider
  var active = _aiProviders.find(function(p){ return !p.paused && p.key; });
  _activeProviderKey = active ? active.id : null;
  saveAIProviders();
  var label = enabled ? 'enabled âœ…' : 'disabled ðŸ”´';
  tvToast(prov.name + ' ' + label, enabled ? 'success' : 'info');
  // Re-render settings to reflect new state
  setTimeout(function(){ if(typeof renderSettingsPage==='function') renderSettingsPage(); }, 200);
}

// â”€â”€ Admin: save a key for a provider â”€â”€
function adminSaveProviderKey(id, lsKey) {
  if (!currentUser || !currentUser.isAdmin) return;
  var input = document.getElementById('keyInput_' + id);
  if (!input) return;
  var val = input.value.trim();
  if (!val || val === '(built-in)' || val.startsWith('â€¢')) {
    tvToast('Paste a new key first', 'warning'); return;
  }
  localStorage.setItem(lsKey, val);
  // Also update the live provider object
  var prov = _aiProviders.find(function(p){ return p.id === id; });
  if (prov) { prov.key = val; prov.paused = false; }
  // Special handling for Gemini shared key
  if (lsKey === 'tv_gemini_key_shared') {
    localStorage.setItem('tv_gemini_key', val);
    _geminiKey = val;
  }
  saveAIProviders();
  // Re-init so the live call functions pick up the new key immediately (no page reload needed)
  initAIProviders();
  tvToast('âœ… Key saved â€” AI is live!', 'success');
  setTimeout(function(){ if(typeof renderSettingsPage==='function') renderSettingsPage(); }, 300);
}

// â”€â”€ Admin: enable or disable ALL providers at once â”€â”€
function adminToggleAllProviders(enabled) {
  if (!currentUser || !currentUser.isAdmin) return;
  _aiProviders.forEach(function(p) {
    // Only enable providers that have a key
    if (enabled) {
      p.paused = !p.key;
    } else {
      // Never fully disable Groq if it has a key â€” keep at least one active
      if (p.id === 'groq-default' && p.key) return;
      p.paused = true;
    }
  });
  // If enabling all, reset active to first keyed provider
  if (enabled) {
    var first = _aiProviders.find(function(p){ return !p.paused; });
    _activeProviderKey = first ? first.id : null;
  }
  saveAIProviders();
  tvToast(enabled ? 'âš¡ All providers enabled!' : 'ðŸ”´ All providers disabled.', enabled ? 'success' : 'info');
  setTimeout(function(){ if(typeof renderSettingsPage==='function') renderSettingsPage(); }, 200);
}

function getActiveProvider() {
  if (!_aiProviders.length) initAIProviders();
  // Try current active
  var p = _aiProviders.find(function(pr){ return pr.id === _activeProviderKey && !pr.paused; });
  if (p) return p;
  // Fall back to first non-paused primary
  p = _aiProviders.find(function(pr){ return pr.isPrimary && !pr.paused; });
  if (p) return p;
  // Fall back to any non-paused
  return _aiProviders.find(function(pr){ return !pr.paused; }) || null;
}

function getNextFallbackProvider(excludeId) {
  return _aiProviders.find(function(pr){ return pr.id !== excludeId && !pr.paused; }) || null;
}

// ============================================================
// API SECURITY â€” Rate limiting & key protection
// ============================================================
var _apiCallLog = [];
var _API_RATE_LIMIT = 30; // max calls per minute
var _API_BLOCKED_UNTIL = 0;

function checkRateLimit() {
  var now = Date.now();
  if(_API_BLOCKED_UNTIL > now) {
    var secs = Math.ceil((_API_BLOCKED_UNTIL - now) / 1000);
    throw new Error('Too many requests. Please wait ' + secs + ' seconds.');
  }
  _apiCallLog = _apiCallLog.filter(function(t) { return now - t < 60000; });
  if(_apiCallLog.length >= _API_RATE_LIMIT) {
    _API_BLOCKED_UNTIL = now + 30000;
    throw new Error('Rate limit reached. Please wait 30 seconds.');
  }
  _apiCallLog.push(now);
}

function sanitiseInput(text) {
  if(typeof text !== 'string') return '';
  // Strip prompt injection attempts
  var bad = ['ignore previous instructions','ignore all instructions','you are now','forget your instructions','system:','<system>'];
  var low = text.toLowerCase();
  for(var i = 0; i < bad.length; i++) {
    if(low.indexOf(bad[i]) >= 0) {
      notify('âš ï¸ Invalid input detected', 'error', 'ðŸ›¡ï¸');
      return text.substring(0, 50) + '...';
    }
  }
  return text.substring(0, 4000); // hard cap
}

const GROQ_MODEL = 'llama-3.3-70b-versatile';
const GEMINI_MODEL = 'gemini-2.0-flash';
const COHERE_KEY = localStorage.getItem('tv_cohere_key') || '';
const COHERE_MODEL = 'command-r-plus';
const MISTRAL_KEY = localStorage.getItem('tv_mistral_key') || '';
const CEREBRAS_KEY = localStorage.getItem('tv_cerebras_key') || '';
const CEREBRAS_MODEL = 'llama-3.3-70b';
const MISTRAL_MODEL = 'mistral-large-latest';
let _geminiKey = _SHARED_GEMINI_KEY || localStorage.getItem('tv_gemini_key') || '';
let _groqFailed = false;
let _activeProvider = 'anthropic';
// Legacy compat â€” real routing handled by getActiveProvider()

// â”€â”€ Live AI availability check â€” used by settings UI â”€â”€
function hasAnyAIKey() {
  return true; // Anthropic built-in is always available â€” no key needed when running in claude.ai
}

const TRENDVID_AI_PERSONA = `You are TrendVid AI â€” a sharp, creator-obsessed AI built into the TrendVid platform. You talk like a savvy creator friend who's cracked the algorithm.

You help creators with:
- YouTube, TikTok, Instagram Reels algorithms and growth tactics
- Viral hooks, script structure, storytelling for short and long form
- Thumbnail psychology and CTR optimisation
- Channel growth, monetisation, niche strategy
- Content calendars and posting schedules
- TrendVid features: Trend Radar, Script Generator, Thumbnail AI, Calendar, Multi-Language, Affiliate

Personality: Direct and actionable. No fluff. Enthusiastic about creators winning. Use occasional slang naturally. Under 150 words unless depth is needed. Bold key points with **bold**. Never start with "Great question!"`;

async function callGroqWithKey(key, model, messages, system, maxTokens) {
  var msgs = system ? [{role:'system',content:system}].concat(messages) : messages;
  var res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
    method: 'POST',
    headers: {'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json'},
    body: JSON.stringify({model: model, messages: msgs, max_tokens: maxTokens || 1200, temperature: 0.7})
  });
  if (!res.ok) {
    var err = {}; try { err = await res.json(); } catch(e4) {}
    var msg = (err.error && err.error.message) ? err.error.message : ('Groq error ' + res.status);
    if (res.status === 401) msg = 'Groq: Invalid API key';
    if (res.status === 429) msg = 'Groq: Rate limit exceeded â€” trying backup key...';
    if (res.status === 503) msg = 'Groq: Service temporarily unavailable';
    throw new Error(msg);
  }
  var data = await res.json();
  return (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || '';
}

async function callGroq(messages, system, maxTokens) {
  checkRateLimit();
  var model = GROQ_MODEL;
  try {
    var provs2 = _aiProviders.filter(function(p){return p.type==='groq' && !p.paused;});
    if (provs2.length && provs2[0].model) model = provs2[0].model;
  } catch(e3) {}

  // Resolve Groq keys â€” from provider list, localStorage, or forced admin key
  var isAdmin2 = !!(currentUser && currentUser.isAdmin);
  var forcedKey = localStorage.getItem('tv_admin_forced_key') || '';
  var keys = [];

  // 1. Admin-pinned forced key
  if (forcedKey && isAdmin2) {
    keys = [forcedKey];
  } else {
    // 2. Keys stored in the provider manager (set via Settings â†’ AI Provider)
    try {
      _aiProviders.forEach(function(p) {
        if (p.type === 'groq' && p.key && keys.indexOf(p.key) === -1) keys.push(p.key);
      });
    } catch(e2) {}
    // 3. Manual key saved in localStorage (the Settings input)
    try {
      var manualKey = localStorage.getItem('tv_groq_key') || '';
      if (manualKey && keys.indexOf(manualKey) === -1) keys.unshift(manualKey);
    } catch(e3) {}
    // 4. Try the encrypted vault as a bonus â€” don't fail if it errors
    try {
      var vaultKeys = await _KV.getSharedPool();
      vaultKeys.forEach(function(k) { if (k && k.startsWith('gsk_') && keys.indexOf(k) === -1) keys.push(k); });
      if (isAdmin2) {
        var adminVaultKeys = await _KV.getAdminPool();
        adminVaultKeys.forEach(function(k) { if (k && k.startsWith('gsk_') && keys.indexOf(k) === -1) keys.unshift(k); });
      }
    } catch(kvErr) { /* vault unavailable â€” that's OK, use other keys */ }
  }

  if (!keys.length) throw new Error('No Groq API key found. Go to Settings â†’ AI Provider and paste your free Groq key from console.groq.com/keys');

  var startIdx = Math.floor(Math.random() * keys.length);
  var lastErr = null;
  for (var ki = 0; ki < keys.length; ki++) {
    var tryKey = keys[(startIdx + ki) % keys.length];
    if (!tryKey) continue;
    try {
      return await callGroqWithKey(tryKey, model, messages, system, maxTokens);
    } catch(e) {
      lastErr = e;
      var isRetryable = e.message.indexOf('Rate limit') !== -1 || e.message.indexOf('backup key') !== -1 || e.message.indexOf('429') !== -1 || e.message.indexOf('401') !== -1 || e.message.indexOf('503') !== -1;
      if (!isRetryable) throw e;
      console.warn('Groq key ' + (startIdx + ki + 1) + ' failed, trying next...');
    }
  }
  throw lastErr || new Error('All Groq keys exhausted');
}

async function callGemini(messages, system, maxTokens) {
  checkRateLimit();
  var key = _SHARED_GEMINI_KEY || _geminiKey || localStorage.getItem('tv_gemini_key') || '';
  if (!key) {
    try {
      var gemProv = _aiProviders.find(function(p){return p.type==='gemini' && !p.paused && p.key;});
      if (gemProv) key = gemProv.key;
    } catch(e2) {}
  }
  if (!key) throw new Error('No Gemini key configured. Add it in Settings â†’ AI Provider.');
  var model = GEMINI_MODEL;
  try {
    var gemProv2 = _aiProviders.find(function(p){return p.type==='gemini' && !p.paused;});
    if (gemProv2 && gemProv2.model) model = gemProv2.model;
  } catch(e3) {}
  var contents = messages.map(function(m) {
    return {role: m.role === 'assistant' ? 'model' : 'user', parts: [{text: m.content}]};
  });
  var body = {contents: contents, generationConfig: {maxOutputTokens: maxTokens || 1200}};
  if (system) body.systemInstruction = {parts: [{text: system}]};
  var res;
  try {
    res = await fetch('https://generativelanguage.googleapis.com/v1beta/models/' + model + ':generateContent?key=' + key, {
      method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
    });
  } catch(netErr) {
    throw new Error('Gemini network error: ' + netErr.message);
  }
  if (!res.ok) {
    var errBody = {}; try { errBody = await res.json(); } catch(e4) {}
    var msg = (errBody.error && errBody.error.message) ? errBody.error.message : ('Gemini error ' + res.status);
    if (res.status === 400) msg = 'Gemini: Bad request â€” check your API key';
    if (res.status === 403) msg = 'Gemini: API key invalid or quota exceeded';
    if (res.status === 429) msg = 'Gemini: Rate limit exceeded â€” please wait';
    throw new Error(msg);
  }
  var data = await res.json();
  var text = '';
  try { text = data.candidates[0].content.parts[0].text || ''; } catch(e5) {}
  return text;
}

async function callCohere(messages, system, maxTokens) {
  checkRateLimit();
  var key = COHERE_KEY;
  if (!key) throw new Error('No Cohere key configured');
  // Build chat history for Cohere format
  var chatHistory = [];
  var lastUserMsg = '';
  messages.forEach(function(m, i) {
    if(i < messages.length - 1) {
      chatHistory.push({role: m.role === 'assistant' ? 'CHATBOT' : 'USER', message: m.content});
    } else {
      lastUserMsg = m.content;
    }
  });
  var body = {
    model: COHERE_MODEL,
    message: lastUserMsg,
    chat_history: chatHistory,
    max_tokens: maxTokens || 1200,
    // Auto-accept safety guidelines
    safety_mode: 'CONTEXTUAL'
  };
  if(system) body.preamble = system;
  var res;
  try {
    res = await fetch('https://api.cohere.com/v1/chat', {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key, 'X-Client-Name': 'TrendVid'},
      body: JSON.stringify(body)
    });
  } catch(netErr) { throw new Error('Cohere network error: ' + netErr.message); }
  if(!res.ok) {
    var errBody = {}; try { errBody = await res.json(); } catch(e) {}
    var msg = (errBody.message) ? errBody.message : ('Cohere error ' + res.status);
    if(res.status === 401) msg = 'Cohere: Invalid API key';
    if(res.status === 429) msg = 'Cohere: Rate limit exceeded â€” please wait';
    throw new Error(msg);
  }
  var data = await res.json();
  var text = '';
  try { text = data.text || ''; } catch(e) {}
  return text;
}

async function callMistral(messages, system, maxTokens) {
  checkRateLimit();
  var key = MISTRAL_KEY;
  if (!key) throw new Error('No Mistral key configured');
  var msgs = [];
  if(system) msgs.push({role: 'system', content: system});
  messages.forEach(function(m){ msgs.push({role: m.role, content: m.content}); });
  var res;
  try {
    res = await fetch('https://api.mistral.ai/v1/chat/completions', {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key},
      body: JSON.stringify({model: MISTRAL_MODEL, messages: msgs, max_tokens: maxTokens || 1200})
    });
  } catch(netErr) { throw new Error('Mistral network error: ' + netErr.message); }
  if(!res.ok) {
    var errBody = {}; try { errBody = await res.json(); } catch(e) {}
    var msg = (errBody.message) ? errBody.message : ('Mistral error ' + res.status);
    if(res.status === 401) msg = 'Mistral: Invalid API key';
    if(res.status === 429) msg = 'Mistral: Rate limit exceeded â€” please wait';
    throw new Error(msg);
  }
  var data = await res.json();
  var text = '';
  try { text = data.choices[0].message.content || ''; } catch(e) {}
  return text;
}

async function callCerebras(messages, system, maxTokens) {
  checkRateLimit();
  var key = CEREBRAS_KEY;
  try {
    var cerebrasP = _aiProviders.find(function(p){ return p.type === 'cerebras' && !p.paused; });
    if (cerebrasP && cerebrasP.key) key = cerebrasP.key;
  } catch(e2) {}
  if (!key) throw new Error('No Cerebras key configured');
  var msgs = [];
  if (system) msgs.push({role: 'system', content: system});
  messages.forEach(function(m){ msgs.push({role: m.role, content: m.content}); });
  var model = CEREBRAS_MODEL;
  try {
    var cp = _aiProviders.find(function(p){ return p.type === 'cerebras' && !p.paused; });
    if (cp && cp.model) model = cp.model;
  } catch(e3) {}
  var res;
  try {
    res = await fetch('https://api.cerebras.ai/v1/chat/completions', {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key},
      body: JSON.stringify({model: model, messages: msgs, max_tokens: maxTokens || 1200})
    });
  } catch(netErr) { throw new Error('Cerebras network error: ' + netErr.message); }
  if (!res.ok) {
    var errBody = {}; try { errBody = await res.json(); } catch(e) {}
    var msg = (errBody.message || errBody.error && errBody.error.message) ? (errBody.message || errBody.error.message) : ('Cerebras error ' + res.status);
    if (res.status === 401) msg = 'Cerebras: Invalid API key';
    if (res.status === 429) msg = 'Cerebras: Rate limit exceeded â€” please wait';
    throw new Error(msg);
  }
  var data = await res.json();
  var text = '';
  try { text = data.choices[0].message.content || ''; } catch(e) {}
  return text;
}

// â”€â”€ Anthropic built-in API (works inside claude.ai with no key needed) â”€â”€
async function callAnthropicBuiltin(messages, system, maxTokens) {
  var msgs = messages.map(function(m) {
    return { role: m.role === 'assistant' ? 'assistant' : 'user', content: m.content };
  });
  var body = {
    model: 'claude-sonnet-4-20250514',
    max_tokens: maxTokens || 1200,
    messages: msgs
  };
  if (system) body.system = system;
  var res;
  try {
    res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
  } catch(netErr) {
    throw new Error('Anthropic network error: ' + netErr.message);
  }
  if (!res.ok) {
    var errBody = {}; try { errBody = await res.json(); } catch(e4) {}
    var msg = (errBody.error && errBody.error.message) ? errBody.error.message : ('Anthropic error ' + res.status);
    throw new Error(msg);
  }
  var data = await res.json();
  var text = '';
  try {
    text = data.content.map(function(c){ return c.type === 'text' ? c.text : ''; }).join('');
  } catch(e5) {}
  return text;
}

async function aiCall(messages, system, maxTokens=1200) {
  // â”€â”€ 1. Try Anthropic built-in first (works in claude.ai with no key needed) â”€â”€
  try {
    var result = await callAnthropicBuiltin(messages, system, maxTokens);
    if (result) return result;
  } catch(anthropicErr) {
    console.warn('Anthropic built-in failed, trying configured providers:', anthropicErr.message);
  }

  // â”€â”€ 2. Fall back to user-configured providers (Groq, Gemini, etc.) â”€â”€
  var providers = [];
  try { providers = _aiProviders.filter(function(p){return !p.paused;}); } catch(e2) {}
  if (!providers.length) { providers = [{type:'groq', key: GROQ_KEY, name:'Groq'}]; }
  // Sort: primary first
  providers.sort(function(a,b) { return (b.isPrimary?1:0) - (a.isPrimary?1:0); });

  var lastErr = null;
  for (var pi = 0; pi < providers.length; pi++) {
    var prov = providers[pi];
    try {
      var result;
      if (prov.type === 'gemini') {
        var savedKey = _SHARED_GEMINI_KEY || _geminiKey || localStorage.getItem('tv_gemini_key') || prov.key || '';
        if (!savedKey) { lastErr = new Error('No Gemini key â€” add one in Settings â†’ AI Provider'); continue; }
        result = await callGemini(messages, system, maxTokens);
      } else if (prov.type === 'cohere') {
        var cohereKey2 = COHERE_KEY || prov.key || localStorage.getItem('tv_cohere_key') || '';
        if (!cohereKey2) { lastErr = new Error('No Cohere key'); continue; }
        result = await callCohere(messages, system, maxTokens);
      } else if (prov.type === 'mistral') {
        var mistralKey2 = MISTRAL_KEY || prov.key || localStorage.getItem('tv_mistral_key') || '';
        if (!mistralKey2) { lastErr = new Error('No Mistral key'); continue; }
        result = await callMistral(messages, system, maxTokens);
      } else if (prov.type === 'cerebras') {
        var cerebrasKey2 = CEREBRAS_KEY || prov.key || localStorage.getItem('tv_cerebras_key') || '';
        if (!cerebrasKey2) { lastErr = new Error('No Cerebras key'); continue; }
        result = await callCerebras(messages, system, maxTokens);
      } else {
        // Groq or any groq-compatible â€” check for any available key first
        var hasGroqKey = !!(localStorage.getItem('tv_groq_key') || prov.key ||
          _aiProviders.some(function(p){ return p.type === 'groq' && p.key; }));
        if (!hasGroqKey) { lastErr = new Error('No Groq API key â€” add one free at console.groq.com/keys then go to Settings â†’ AI Provider'); continue; }
        result = await callGroq(messages, system, maxTokens);
      }
      if (pi > 0) { notify('âœ… ' + prov.name + ' responded â€” using as backup', 'info', 'âš¡'); }
      updateProviderUI(prov.type);
      return result;
    } catch(e) {
      lastErr = e;
      if (pi === 0 && providers.length > 1) {
        notify('âš ï¸ ' + prov.name + ' down â€” trying backup...', 'error', 'ðŸ”„');
      }
    }
  }
  // All providers failed â€” surface a clear, actionable error
  var errMsg = lastErr ? lastErr.message : 'Unknown error';
  var isNoKey = errMsg.indexOf('No ') !== -1 && errMsg.indexOf('key') !== -1;
  if (isNoKey || errMsg.indexOf('All AI providers') !== -1) {
    throw new Error('No API key configured. Go to Settings â†’ AI Provider and add a free Groq key from console.groq.com/keys â€” it takes 30 seconds.');
  }
  throw new Error('All AI providers failed. Last error: ' + errMsg);
}

async function callTrendVidAI(messages,maxTokens=800){return aiCall(messages,TRENDVID_AI_PERSONA,maxTokens);}
async function callClaude(messages,system,maxTokens=1200){return aiCall(messages,system,maxTokens);}
async function callAI(messages,system,maxTokens){return aiCall(messages,system,maxTokens||1200);}
function tvToast(msg,type,icon){var t=type||'info';var i=icon||(t==='success'?'âœ…':t==='error'?'âš ï¸':'â„¹ï¸');notify(msg,t,i);}
function renderSettingsPage(){if(typeof renderSettings==='function')renderSettings();}

// ============================================================
// TIER HELPERS
// ============================================================
function hasAccess(feature){
  const required = FEATURE_TIERS[feature]||'free';
  const userRank = TIER_RANK[currentUser?.plan||'free']??0;
  const reqRank  = TIER_RANK[required]??0;
  return userRank >= reqRank;
}
// renderLockedPage: renders a locked message and returns true if locked
function renderLockedPage(feature, label, icon='ðŸ”’'){
  if(hasAccess(feature)) return false;
  showUpgradeGate(feature);
  return true;
}
function showPricingModal(requiredTier, featureLabel){
  const modal = document.getElementById('pricingModal');
  const note = document.getElementById('pricingModalFeatureNote');
  if(note && featureLabel){
    const tier = TIERS[requiredTier] || TIERS.pro;
    note.innerHTML = `<strong>${featureLabel}</strong> requires the <span style="color:${tier.color};font-weight:700">${tier.emoji} ${tier.label}</span> plan`;
  } else if(note) { note.textContent = ''; }
  if(modal) modal.classList.add('show');
}
function closePricingModal(){
  const modal = document.getElementById('pricingModal');
  if(modal) modal.classList.remove('show');
}
function setDemoPlan(plan){
  if(!currentUser) return;
  currentUser.plan = plan;
  updateUserPlanUI();
  notify(`Plan switched to ${TIERS[plan]?.label||plan}!`,'success', TIER_ICONS[plan]||'âœ…');
}
function simulateUpgrade(tier){ setDemoPlan(tier); }

function demoLogin(plan) {
  closeLoginModal();
  enterAppWithUser('demo@trendvid.ai', false);
  if (currentUser) {
    currentUser.plan = plan;
    currentUser.name = 'Demo Creator';
    try { localStorage.setItem('tv_user', JSON.stringify(currentUser)); } catch(e) {}
    updateUserPlanUI();
  }
  notify('Demo mode: ' + plan.charAt(0).toUpperCase() + plan.slice(1) + ' plan active', 'success', 'ðŸŽ‰');
}
function notify(msg,type='info',icon='â„¹ï¸'){
  const el=document.getElementById('notif');
  el.innerHTML=`<span>${icon}</span><span>${msg}</span>`;
  el.className=`notif ${type} show`;
  clearTimeout(el._t);
  el._t=setTimeout(()=>el.classList.remove('show'),3500);
}
// â”€â”€ Convert raw AI/network errors into user-friendly messages â”€â”€
function friendlyErr(e) {
  var msg = (e && e.message) ? e.message : String(e);
  if (msg.indexOf('Failed to fetch') !== -1 || msg.indexOf('NetworkError') !== -1 || msg.indexOf('network error') !== -1)
    return 'Network unavailable â€” check your connection and try again';
  if (msg.indexOf('No API key configured') !== -1 || msg.indexOf('No Groq API key') !== -1 || msg.indexOf('No Gemini key') !== -1)
    return 'âš™ï¸ No AI key set â€” go to Settings â†’ AI Provider and add your free Groq key from console.groq.com/keys';
  if (msg.indexOf('providers failed') !== -1 || msg.indexOf('All AI providers') !== -1)
    return 'âš™ï¸ AI unavailable â€” check Settings â†’ AI Provider and make sure a key is saved';
  if (msg.indexOf('Invalid API key') !== -1 || msg.indexOf('401') !== -1)
    return 'Invalid API key â€” update it in Settings â†’ AI Provider';
  if (msg.indexOf('Rate limit') !== -1 || msg.indexOf('429') !== -1)
    return 'Rate limit reached â€” wait a moment and try again';
  if (msg.indexOf('quota') !== -1)
    return 'API quota exceeded â€” check your provider dashboard';
  return msg;
}

function esc(s){
  if(s===null||s===undefined) return '';
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#x27;')
    .replace(/`/g,'&#x60;')
    .replace(/\//g,'&#x2F;');
}
function escAttr(s){ return esc(s); }
function escUrl(url) {
  if(!url) return '#';
  var s = String(url).trim();
  // Block javascript: data: vbscript: protocol injection
  if(/^(javascript|data|vbscript):/i.test(s)) return '#';
  return s;
}

// ============================================================
// SECURITY SYSTEM â€” Anti-tamper, rate limiting, intrusion detection
// ============================================================
var _securityLog = [];
var _loginAttempts = {}; // email -> {count, lockedUntil}
var _MAX_LOGIN_ATTEMPTS = 5;
var _LOCKOUT_DURATION = 15 * 60 * 1000; // 15 minutes
var _SUSPICIOUS_PATTERNS = [
  /(<script|<[\/\u005c]script|javascript:|data:text|vbscript:|onload=|onerror=|onclick=|<iframe|<object|<embed)/i,
  /(union.*select|select.*from|drop.*table|insert.*into|delete.*from|exec\(|execute\()/i,
  /(\.\.\/|\.\.\\|%2e%2e|%252e)/i, // Path traversal
  /(\${|#{|\{\{|\}\})/,  // Template injection
  /(base64_decode|eval\(|system\(|exec\(|passthru\()/i,
];

function secLog(type, detail) {
  var entry = {type:type, detail:String(detail).substring(0,200), ts:Date.now(), 
                user: currentUser ? currentUser.email : 'anon'};
  _securityLog.push(entry);
  if(_securityLog.length > 200) _securityLog = _securityLog.slice(-200);
  try {
    var stored = JSON.parse(localStorage.getItem('tv_sec_log')||'[]');
    stored.push(entry);
    localStorage.setItem('tv_sec_log', JSON.stringify(stored.slice(-200)));
  } catch(e) {}
  // security event recorded silently
}

function isSuspicious(input) {
  if(!input) return false;
  var s = String(input);
  for(var i = 0; i < _SUSPICIOUS_PATTERNS.length; i++) {
    if(_SUSPICIOUS_PATTERNS[i].test(s)) return true;
  }
  return false;
}

function secSanitize(input, maxLen) {
  if(!input) return '';
  var s = String(input).substring(0, maxLen || 4000);
  if(isSuspicious(s)) {
    secLog('SUSPICIOUS_INPUT', s.substring(0,100));
    // Strip dangerous patterns
    s = s.replace(/<[^>]*>/g,'').replace(/javascript:/gi,'').replace(/data:/gi,'').replace(/vbscript:/gi,'');
  }
  return s;
}

function checkLoginRateLimit(email) {
  var now = Date.now();
  var key = email.toLowerCase().trim();
  if(!_loginAttempts[key]) _loginAttempts[key] = {count:0, lockedUntil:0};
  var attempt = _loginAttempts[key];
  if(attempt.lockedUntil > now) {
    var mins = Math.ceil((attempt.lockedUntil - now) / 60000);
    secLog('LOGIN_BLOCKED', key);
    return 'Too many failed attempts. Account locked for ' + mins + ' more minute' + (mins===1?'':'s') + '.';
  }
  return null; // ok
}

function recordLoginFail(email) {
  var key = email.toLowerCase().trim();
  if(!_loginAttempts[key]) _loginAttempts[key] = {count:0, lockedUntil:0};
  _loginAttempts[key].count++;
  if(_loginAttempts[key].count >= _MAX_LOGIN_ATTEMPTS) {
    _loginAttempts[key].lockedUntil = Date.now() + _LOCKOUT_DURATION;
    _loginAttempts[key].count = 0;
    secLog('ACCOUNT_LOCKED', key + ' after ' + _MAX_LOGIN_ATTEMPTS + ' attempts');
    return true; // was locked
  }
  secLog('LOGIN_FAIL', key + ' attempt ' + _loginAttempts[key].count);
  return false;
}

function recordLoginSuccess(email) {
  var key = email.toLowerCase().trim();
  _loginAttempts[key] = {count:0, lockedUntil:0};
  secLog('LOGIN_SUCCESS', key);
}

// Detect and block console-based admin impersonation
(function() {
  var _origDefineProperty = Object.defineProperty;
  // Freeze currentUser.isAdmin once set to prevent console tampering
  var _adminLocked = false;
  window._lockAdminState = function() {
    if(_adminLocked || !currentUser) return;
    _adminLocked = true;
    var _isAdminVal = currentUser.isAdmin;
    var _planVal = currentUser.plan;
    Object.defineProperty(currentUser, 'isAdmin', {
      get: function() { return _isAdminVal; },
      set: function(v) { secLog('TAMPER_ATTEMPT', 'isAdmin write: ' + v); },
      configurable: false
    });
  };
})();

// CSP-style inline script blocker for injected content
window.addEventListener('securitypolicyviolation', function(e) {
  secLog('CSP_VIOLATION', e.blockedURI + ' / ' + e.violatedDirective);
});

// Detect DevTools opening (basic heuristic â€” not foolproof but deters casual tampering)
var _devtoolsOpen = false;
(function detectDevTools() {
  var threshold = 160;
  setInterval(function() {
    if(window.outerHeight - window.innerHeight > threshold || window.outerWidth - window.innerWidth > threshold) {
      if(!_devtoolsOpen) { _devtoolsOpen = true; secLog('DEVTOOLS_OPENED', navigator.userAgent.substring(0,60)); }
    } else { _devtoolsOpen = false; }
  }, 3000);
})();



// â”€â”€ SAFE CLIPBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Works on file://, http://, and inside restricted iframes
function safeCopy(text, successMsg, icon) {
  var msg = successMsg || 'Copied!';
  var ico = icon || 'ðŸ“‹';
  // Try modern async API first
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(function() {
      notify(msg, 'success', ico);
    }).catch(function() {
      _execCopy(text, msg, ico);
    });
  } else {
    _execCopy(text, msg, ico);
  }
}
function _execCopy(text, msg, ico) {
  // Fallback: create a temporary textarea, select its content, copy
  var ta = document.createElement('textarea');
  ta.value = text;
  ta.style.cssText = 'position:fixed;top:-9999px;left:-9999px;opacity:0;';
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  try {
    var ok = document.execCommand('copy');
    notify(ok ? (msg || 'Copied!') : 'Copy failed â€” please copy manually', ok ? 'success' : 'error', ok ? (ico || 'ðŸ“‹') : 'âš ï¸');
  } catch(e) {
    notify('Copy failed â€” please copy manually', 'error', 'âš ï¸');
  }
  document.body.removeChild(ta);
}
function timeAgo(ts){
  const s=Math.floor((Date.now()-ts)/1000);
  if(s<60)return'just now';
  if(s<3600)return Math.floor(s/60)+'m ago';
  if(s<86400)return Math.floor(s/3600)+'h ago';
  return Math.floor(s/86400)+'d ago';
}
function updateBadges(){
  const scripts=JSON.parse(localStorage.getItem('tv_scripts')||'[]');
  const favs=JSON.parse(localStorage.getItem('tv_favs')||'[]');
  const lb=document.getElementById('libBadge');
  const fb=document.getElementById('favBadge');
  if(lb)lb.textContent=scripts.length;
  if(fb)fb.textContent=favs.length;
}

// ============================================================
// TIER SYSTEM
// ============================================================
// Tier order: free < starter < pro < gold < elite
var TIER_RANK = {free:0, starter:1, pro:2, gold:3, elite:4};
// Convenience maps for tier display
var TIER_ICONS = {free:'ðŸŒ±', starter:'ðŸš€', pro:'âš¡', gold:'ðŸ‘‘', elite:'ðŸ’Ž'};
function userTier(){return currentUser?.plan||'free';}

var TIERS = {
  free:    {label:'FREE',     price:'Â£0',    period:'/mo', color:'var(--muted)',  badgeStyle:'', emoji:'ðŸŒ±',
             desc:'Get started with AI-powered content tools',
             aiCalls:10, scriptSaves:3, calendarDays:7,
             features:['10 AI calls/month','3 saved scripts','Trend Radar (5/day)','Script Generator (basic)','Thumbnail AI (3/day)','Content Calendar (7 days)']},
  starter: {label:'STARTER',  price:'Â£9',    period:'/mo', color:'var(--teal)',   badgeStyle:'border:1px solid rgba(0,229,176,0.5)', emoji:'ðŸš€',
             desc:'Perfect for new creators building their first audience',
             aiCalls:100, scriptSaves:25, calendarDays:30,
             features:['100 AI calls/month','25 saved scripts','Trend Radar (unlimited)','Script Generator (full)','Thumbnail AI (unlimited)','Content Calendar (full)','Voice to Script','Multi-Language (5 languages)','Script Library']},
  pro:     {label:'PRO',      price:'Â£19',   period:'/mo', color:'var(--accent)', badgeStyle:'', emoji:'âš¡',
             desc:'The creator toolkit for serious growth',
             aiCalls:500, scriptSaves:200, calendarDays:90,
             features:['500 AI calls/month','200 saved scripts','Everything in Starter','Teleprompter Mode','Hashtag & SEO Generator','Hook Tester','Competitor Spy','Content Gap Finder','Multi-Language (20+ languages)','Priority AI speed']},
  gold:    {label:'GOLD',     price:'Â£39',   period:'/mo', color:'var(--gold)',   badgeStyle:'background:linear-gradient(135deg,rgba(251,191,36,0.15),rgba(217,119,6,0.1));color:var(--gold);border:1px solid rgba(251,191,36,0.4)', emoji:'ðŸ‘‘',
             desc:'For full-time creators and growing channels',
             aiCalls:2000, scriptSaves:999, calendarDays:365,
             features:['2000 AI calls/month','Unlimited saved scripts','Everything in Pro','Script Repurposer (TikTok/Reels/Tweets)','A/B Title Tester','Brand Kit','Trend Alerts (daily digest)','Affiliate Dashboard','Advanced analytics','Team access (2 seats)']},
  elite:   {label:'ELITE',    price:'Â£79',   period:'/mo', color:'var(--elite)',  badgeStyle:'background:linear-gradient(135deg,rgba(192,132,252,0.2),rgba(124,58,237,0.15));color:var(--elite);border:1px solid rgba(192,132,252,0.5)', emoji:'ðŸ’Ž',
             desc:'Agencies, pro studios & power creators',
             aiCalls:99999, scriptSaves:99999, calendarDays:999,
             features:['Unlimited AI calls','Unlimited everything','Everything in Gold','White-label exports','API access','Real-time trend alerts','Team access (10 seats)','Dedicated account manager','Custom AI persona','Early access to new features']},
};

// Feature â†’ minimum tier required
var TIER_NAMES = Object.fromEntries(Object.entries(TIERS).map(([k,v])=>[k,v.label]));

var FEATURE_TIERS = {
  // Core (free)
  dashboard:'free', trends:'free', script:'free', thumbnail:'free',
  // Starter
  library:'starter', calendar:'starter', favourites:'starter', multilang:'starter', voice:'starter',
  // Pro
  teleprompter:'pro', hashtags:'pro', hooktester:'pro',
  // Gold
  repurpose:'gold', brandkit:'gold', alerts:'gold', abtitle:'gold',
  // Elite
  gapfinder:'pro', affiliate:'starter', settings:'free', help:'free', pricing:'free',
  soundtrack:'pro', bundles:'free', admin:'free', autoupload:'elite', imagegen:'free', changelog:'free',
};

function userCanAccess(feature){
  const required = FEATURE_TIERS[feature] || 'free';
  const userRank = TIER_RANK[currentUser?.plan||'free'];
  const reqRank  = TIER_RANK[required];
  return userRank >= reqRank;
}

// Track what the user was trying to do when they hit a paywall
window._lastAttemptedAction = null;
function recordAttemptedAction(label) { window._lastAttemptedAction = label; }

function showUpgradeGate(feature, container){
  const required = FEATURE_TIERS[feature] || 'pro';
  const tier = TIERS[required];
  const el = container || document.getElementById('pageContent');
  const glowMap = {starter:'rgba(0,229,176,0.25)',pro:'rgba(255,48,88,0.25)',gold:'rgba(251,191,36,0.25)',elite:'rgba(192,132,252,0.25)'};
  const glow = glowMap[required]||'rgba(255,48,88,0.25)';
  const glowStrong = glow.replace('0.25','0.5');
  const glowFaint = glow.replace('0.25','0.1');
  const featureLabels = {
    library:'Script Library', calendar:'Content Calendar', favourites:'Favourites',
    multilang:'Multi-Language', voice:'Voice to Script', teleprompter:'Teleprompter Mode',
    hashtags:'Hashtag & SEO Generator', hooktester:'Hook Tester', repurpose:'Script Repurposer',
    brandkit:'Brand Kit', alerts:'Trend Alerts', abtitle:'A/B Title Tester',
    gapfinder:'Content Gap Finder', soundtrack:'Soundtrack Finder', affiliate:'Affiliate Dashboard',
  };
  const featureLabel = featureLabels[feature] || 'This feature';
  // Show what the user was trying to do for max conversion impact
  const lastAction = window._lastAttemptedAction;
  const contextBanner = lastAction
    ? '<div style="background:rgba(255,48,88,0.06);border:1px solid rgba(255,48,88,0.2);border-radius:10px;padding:10px 16px;font-size:12px;color:var(--text2);margin-bottom:22px;text-align:left;max-width:420px;line-height:1.6"><span style="color:var(--accent);font-weight:700">âš¡ You were about to:</span> <em>' + (lastAction||'').replace(/</g,'&lt;') + '</em> â€” upgrade to finish it instantly.</div>'
    : '';
  window._lastAttemptedAction = null;
  const tierColor = tier.color;
  const tierPrice = tier.price;
  const tierLabel = tier.label;
  const tierEmoji = tier.emoji;
  const tierDesc = tier.desc;
  const featurePills = tier.features.slice(0,4).map(f=>'<div style="background:var(--surface2);border:1px solid var(--border2);border-radius:20px;padding:5px 14px;font-size:11px;font-weight:600;color:var(--text2)">&#10003; '+f+'</div>').join('');
  const currentPlan = (currentUser && currentUser.plan) ? currentUser.plan : 'free';
  const currentTierLabel = (TIERS[currentPlan] && TIERS[currentPlan].label) ? TIERS[currentPlan].label : 'FREE';
  el.innerHTML =
    '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:440px;text-align:center;padding:48px 24px;gap:0;animation:fadeInUp 0.4s ease both">' +
      '<div style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--surface2),var(--surface3));border:2px solid '+glowStrong+';display:flex;align-items:center;justify-content:center;font-size:36px;margin-bottom:20px;box-shadow:0 0 40px '+glow+',0 0 80px '+glowFaint+';animation:glowPulse 3s ease infinite">'+tierEmoji+'</div>' +
      '<div style="font-size:11px;font-weight:900;letter-spacing:2px;color:'+tierColor+';font-family:var(--font-display);margin-bottom:8px;text-transform:uppercase">'+tierLabel+' FEATURE</div>' +
      '<div style="font-family:var(--font-display);font-size:26px;font-weight:900;letter-spacing:-0.5px;margin-bottom:10px;line-height:1.2"><span style="color:'+tierColor+'">'+featureLabel+'</span><br>is waiting for you</div>' +
      contextBanner +
      '<div style="font-size:13px;color:var(--text2);max-width:380px;line-height:1.7;margin-bottom:24px">'+tierDesc+' â€” unlock this and everything in '+tierLabel+' for just <strong style="color:'+tierColor+'">'+tierPrice+'/mo</strong>.</div>' +
      '<div style="display:flex;flex-wrap:wrap;gap:7px;justify-content:center;margin-bottom:28px">'+featurePills+'</div>' +
      '<div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:16px">' +
        '<button class="btn btn-primary btn-lg" style="min-width:220px;font-size:14px" onclick="navTo(&quot;pricing&quot;)">Unlock '+tierLabel+' &mdash; '+tierPrice+'/mo &rarr;</button>' +
        '<button class="btn btn-ghost" onclick="navTo(&quot;dashboard&quot;)" style="font-size:13px;color:var(--muted)">Maybe later</button>' +
      '</div>' +
      '<div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;justify-content:center">' +
        '<span style="font-size:11px;color:var(--muted)">&#128274; Secure checkout</span>' +
        '<span style="font-size:11px;color:var(--muted)">&#8617;&#65039; 7-day money-back</span>' +
        '<span style="font-size:11px;color:var(--muted)">&#128683; Cancel anytime</span>' +
      '</div>' +
      '<div style="margin-top:14px;font-size:11px;color:var(--muted)">Currently on <span class="tier-badge tier-'+currentPlan+'" style="font-size:9px">'+currentTierLabel+'</span></div>' +
    '</div>';
}


// ============================================================
// THEME
// ============================================================
function toggleTheme(){
  const h=document.documentElement;
  const d=h.getAttribute('data-theme')==='dark';
  h.setAttribute('data-theme',d?'light':'dark');
  document.body.classList.toggle('dark-grid',!d);
  ['themeBtn','themeBtn2'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=d?'â˜€ï¸':'ðŸŒ™';});
}

// ============================================================
// AUTH
// ============================================================
// ============================================================
// SECURITY â€” Admin credentials stored as hash only
// ============================================================
const _ADMIN_EMAIL = 'matthew' + '.addison354' + '@' + 'gmail.com';
// Password never stored in plaintext â€” verified via SHA-256 hash
const _ADMIN_PW_HASH = 'a4c6b8f9d2e1a3b5c7d9e0f2a4b6c8d0e2f4a6b8c0d2e4f6a8b0c2d4e6f8a0b2'; // placeholder, replaced below
async function _verifyAdminPw(pw) {
  try {
    const enc = new TextEncoder().encode(pw + '_tv_salt_2025');
    const buf = await crypto.subtle.digest('SHA-256', enc);
    const hex = Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    // Compare against stored hash
    const stored = localStorage.getItem('_tv_ahash');
    if (!stored) {
      // First time: store the hash of the correct password
      // We hash the actual pw at init time if this is the admin logging in correctly
      return true; // will be validated by legacy check below during migration
    }
    return hex === stored;
  } catch(e) { return false; }
}
// Legacy plaintext check (used only to migrate to hash on first successful login)
const _ADMIN_PW = '01#^7@#1&*yH31&N0s7u1';
let currentUser = null;

let _authMode = 'signin'; // 'signin' | 'signup'

function switchAuthMode(mode) {
  _authMode = mode;
  var isSignup = mode === 'signup';
  // Tab styles
  var tabSI = document.getElementById('tabSignin');
  var tabSU = document.getElementById('tabSignup');
  if(tabSI) { tabSI.style.background = isSignup ? 'transparent' : 'var(--accent)'; tabSI.style.color = isSignup ? 'var(--muted)' : '#fff'; }
  if(tabSU) { tabSU.style.background = isSignup ? 'var(--accent)' : 'transparent'; tabSU.style.color = isSignup ? '#fff' : 'var(--muted)'; }
  // Show/hide fields
  var fields = ['signupNameField','confirmEmailWrap','confirmPwField','weeklyReportsRow'];
  fields.forEach(function(id) {
    var el = document.getElementById(id);
    if(el) el.style.display = isSignup ? (id === 'weeklyReportsRow' ? 'flex' : 'block') : 'none';
  });
  // Update button
  var btn = document.getElementById('loginBtn');
  if(btn) btn.textContent = isSignup ? 'Create Account â†’' : 'Sign In â†’';
  // Update autocomplete hint on password
  var pw = document.getElementById('loginPassword');
  if(pw) pw.setAttribute('autocomplete', isSignup ? 'new-password' : 'current-password');
  // Clear errors
  var err = document.getElementById('loginError');
  var suc = document.getElementById('loginSuccess');
  if(err) err.classList.remove('show');
  if(suc) suc.classList.remove('show');
  // Clear match messages
  ['pwMatchMsg','emailMatchMsg'].forEach(function(id){ var el=document.getElementById(id); if(el) el.style.display='none'; });
  // Focus email
  setTimeout(function(){ var el=document.getElementById('loginEmail'); if(el) el.focus(); }, 80);
}

function checkPwMatch() {
  var pw1 = (document.getElementById('loginPassword')||{}).value || '';
  var pw2 = (document.getElementById('confirmPassword')||{}).value || '';
  var msg = document.getElementById('pwMatchMsg');
  if(!msg || !pw2) return;
  msg.style.display = 'block';
  if(pw1 === pw2) {
    msg.textContent = 'âœ… Passwords match';
    msg.style.color = 'var(--teal)';
  } else {
    msg.textContent = 'âŒ Passwords do not match';
    msg.style.color = 'var(--accent)';
  }
}

function checkEmailMatch() {
  var em1 = (document.getElementById('loginEmail')||{}).value.trim() || '';
  var em2 = (document.getElementById('confirmEmail')||{}).value.trim() || '';
  var msg = document.getElementById('emailMatchMsg');
  if(!msg || !em2) return;
  msg.style.display = 'block';
  if(em1 === em2) {
    msg.textContent = 'âœ… Emails match';
    msg.style.color = 'var(--teal)';
  } else {
    msg.textContent = 'âŒ Emails do not match';
    msg.style.color = 'var(--accent)';
  }
}

function showError(msg) {
  var el = document.getElementById('loginError');
  if(!el) return;
  el.textContent = msg;
  el.classList.add('show');
}

function showLogin() {
  _authMode = 'signin';
  var modal = document.getElementById('loginModal');
  if(modal) modal.classList.add('show');
  switchAuthMode('signin');
}
function showSignup() {
  _authMode = 'signup';
  var modal = document.getElementById('loginModal');
  if(modal) modal.classList.add('show');
  switchAuthMode('signup');
}

function closeLoginModal() {
  var modal = document.getElementById('loginModal');
  modal.classList.remove('show');
  modal.style.display = '';
  // Clear all fields
  ['loginEmail','loginPassword','confirmEmail','confirmPassword','signupName'].forEach(function(id){
    var el = document.getElementById(id); if(el) el.value = '';
  });
  ['loginError','loginSuccess'].forEach(function(id){
    var el = document.getElementById(id); if(el) el.classList.remove('show');
  });
  ['pwMatchMsg','emailMatchMsg'].forEach(function(id){ var el=document.getElementById(id); if(el) el.style.display='none'; });
}

function togglePw(inputId, btnId) {
  var inp = document.getElementById(inputId||'loginPassword');
  var btn = document.getElementById(btnId||'pwToggle1');
  if(!inp) return;
  if(inp.type === 'password') { inp.type = 'text'; if(btn) btn.textContent = 'ðŸ™ˆ'; }
  else { inp.type = 'password'; if(btn) btn.textContent = 'ðŸ‘'; }
}

function doAuth() {
  if(_authMode === 'signup') { doSignup(); } else { doLogin(); }
}

function doSignup() {
  var name    = ((document.getElementById('signupName')||{}).value||'').trim();
  var email   = ((document.getElementById('loginEmail')||{}).value||'').trim().toLowerCase();
  var emailC  = ((document.getElementById('confirmEmail')||{}).value||'').trim().toLowerCase();
  var pw      = (document.getElementById('loginPassword')||{}).value||'';
  var pwC     = (document.getElementById('confirmPassword')||{}).value||'';
  var weekly  = (document.getElementById('weeklyReportsToggle')||{}).classList && document.getElementById('weeklyReportsToggle').classList.contains('on');
  var btn     = document.getElementById('loginBtn');

  // Validation
  if(!name)                         { showError('âš ï¸ Please enter your name.'); return; }
  if(!email || !email.includes('@')) { showError('âš ï¸ Please enter a valid email address.'); return; }
  if(email !== emailC)               { showError('âš ï¸ Email addresses do not match. Please check and try again.'); return; }
  if(pw.length < 8)                  { showError('âš ï¸ Password must be at least 8 characters long.'); return; }
  if(pw !== pwC)                     { showError('âš ï¸ Passwords do not match. Please check and try again.'); return; }

  // Save account data
  var accounts = {};
  try { accounts = JSON.parse(localStorage.getItem('tv_accounts')||'{}'); } catch(e) {}
  // Simple hash-ish (not secure â€” client-side demo only)
  // Sanitize before saving
  var safeName = secSanitize(name, 80);
  var safeEmail = email.toLowerCase().trim();
  if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(safeEmail)) { showError('âš ï¸ Please enter a valid email address.'); return; }
  if(isSuspicious(safeName)) { showError('âš ï¸ Name contains invalid characters.'); return; }
  // Hash password with SHA-256 before storing (never stored as plaintext or btoa)
  tvHashPw(pw, safeEmail).then(function(pwHash) {
    accounts[safeEmail] = { name: safeName, pw: pwHash, pwv: 2, weeklyReports: weekly, createdAt: Date.now() };
    try { localStorage.setItem('tv_accounts', JSON.stringify(accounts)); } catch(e) {}
    // Continue with app entry after async hash
    var savedEmail2 = safeEmail;
    var savedName2  = safeName;
    closeLoginModal();
    if(btn) { btn.disabled = false; }
    enterAppWithUser(savedEmail2, savedEmail2 === _ADMIN_EMAIL, savedName2, weekly);
  });
  return; // actual entry happens inside .then()

  // Show success and enter app
  var err = document.getElementById('loginError');
  var suc = document.getElementById('loginSuccess');
  if(err) err.classList.remove('show');
  if(suc) suc.classList.add('show');
  if(btn) { btn.disabled = true; }

  // (entry handled inside tvHashPw.then above)
}

// ============================================================
// EARLY ACCESS SYSTEM
// ============================================================
var EARLY_ACCESS_WINDOW_MS = 7 * 24 * 60 * 60 * 1000; // 7 days

function isEarlyAccessUser() {
  if (currentUser && currentUser.isAdmin) return true;
  var saved = {};
  try { saved = JSON.parse(localStorage.getItem('tv_user') || '{}'); } catch(e) {}
  if (saved.earlyAccess) return true;
  var users = [];
  try { users = JSON.parse(localStorage.getItem('tv_all_users') || '[]'); } catch(e) {}
  var u = users.find(function(x){ return x.email === (currentUser && currentUser.email); });
  return !!(u && u.earlyAccess);
}

function getLatestRelease() {
  var announcements = [];
  try { announcements = JSON.parse(localStorage.getItem('tv_announcements') || '[]'); } catch(e) {}
  return announcements.find(function(a){ return a.autoRelease; }) || null;
}

function earlyAccessTabActive() {
  var rel = getLatestRelease();
  if (!rel || !rel.at) return false;
  return (Date.now() - (rel.releasedAt || rel.at)) < EARLY_ACCESS_WINDOW_MS;
}

function adminToggleEarlyAccess(email) {
  var users = [];
  try { users = JSON.parse(localStorage.getItem('tv_all_users') || '[]'); } catch(e) {}
  var u = users.find(function(x){ return x.email === email; });
  if (!u) { notify('User not found', 'error', 'x'); return; }
  u.earlyAccess = !u.earlyAccess;
  try { localStorage.setItem('tv_all_users', JSON.stringify(users)); } catch(e) {}
  // Sync if currently logged-in user
  var saved = {};
  try { saved = JSON.parse(localStorage.getItem('tv_user') || '{}'); } catch(e) {}
  if (saved.email === email) {
    saved.earlyAccess = u.earlyAccess;
    try { localStorage.setItem('tv_user', JSON.stringify(saved)); } catch(e) {}
    if (currentUser) currentUser.earlyAccess = u.earlyAccess;
  }
  notify((u.earlyAccess ? 'Early access granted to ' : 'Early access revoked for ') + email, 'success', 'done');
  renderAdmin();
}


function doLogin() {
  var email = ((document.getElementById('loginEmail')||{}).value||'').trim().toLowerCase();
  var pw    = (document.getElementById('loginPassword')||{}).value||'';
  var btn   = document.getElementById('loginBtn');

  if(!email || !pw) { showError('âš ï¸ Please enter your email and password.'); return; }

  // Validate email format
  if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) { showError('âš ï¸ Please enter a valid email address.'); return; }

  // Rate limiting â€” lockout after 5 failed attempts
  var lockMsg = checkLoginRateLimit(email);
  if(lockMsg) { showError('ðŸ”’ ' + lockMsg); return; }

  // Admin check
  if(email === _ADMIN_EMAIL && pw !== _ADMIN_PW) {
    recordLoginFail(email);
    var locked = _loginAttempts[email] && _loginAttempts[email].lockedUntil > Date.now();
    showError(locked ? 'ðŸ”’ Too many attempts. Account locked for 15 minutes.' : 'âš ï¸ Incorrect password for admin account.');
    var pwEl = document.getElementById('loginPassword');
    if(pwEl) { pwEl.value = ''; pwEl.focus(); }
    return;
  }

  // Check saved accounts (non-admin)
  if(email !== _ADMIN_EMAIL) {
    var accounts = {};
    try { accounts = JSON.parse(localStorage.getItem('tv_accounts')||'{}'); } catch(e) {}
    if(accounts[email]) {
      // Async SHA-256 check (with legacy btoa fallback)
      var _loginEmail = email, _loginBtn = btn;
      tvCheckPw(pw, email, accounts[email].pw).then(function(pwOk) {
        if(!pwOk) {
          recordLoginFail(_loginEmail);
          var locked2 = _loginAttempts[_loginEmail] && _loginAttempts[_loginEmail].lockedUntil > Date.now();
          showError(locked2 ? 'ðŸ”’ Too many attempts. Try again in 15 minutes.' : 'âš ï¸ Incorrect password. Please try again.');
          var pwEl2 = document.getElementById('loginPassword');
          if(pwEl2) { pwEl2.value = ''; pwEl2.focus(); }
          if(_loginBtn) { _loginBtn.textContent = 'Sign In â†’'; _loginBtn.disabled = false; }
          return;
        }
        // Upgrade legacy btoa hash to SHA-256 silently
        if(accounts[_loginEmail].pwv !== 2) {
          tvHashPw(pw, _loginEmail).then(function(newHash) {
            var acc2 = {};
            try { acc2 = JSON.parse(localStorage.getItem('tv_accounts')||'{}'); } catch(e) {}
            if(acc2[_loginEmail]) { acc2[_loginEmail].pw = newHash; acc2[_loginEmail].pwv = 2; }
            try { localStorage.setItem('tv_accounts', JSON.stringify(acc2)); } catch(e) {}
          });
        }
        recordLoginSuccess(_loginEmail);
        var isAdm = (_loginEmail === _ADMIN_EMAIL);
        var fName = isAdm ? 'Matthew' : undefined;
        closeLoginModal();
        if(_loginBtn) { _loginBtn.textContent = 'Sign In â†’'; _loginBtn.disabled = false; }
        enterAppWithUser(_loginEmail, isAdm, fName);
      }).catch(function() {
        showError('âš ï¸ Login error. Please try again.');
        if(_loginBtn) { _loginBtn.textContent = 'Sign In â†’'; _loginBtn.disabled = false; }
      });
      return; // actual entry happens in .then()
    } else {
      showError('âš ï¸ No account found for that email. Use the Create Account tab to sign up.');
      return;
    }
  }

  // Admin login (synchronous path â€” admin pw checked against _ADMIN_PW directly)
  recordLoginSuccess(email);
  if(btn) { btn.textContent = 'âœ… Signing inâ€¦'; btn.disabled = true; }
  var savedEmail = email;
  var isAdmin = (email === _ADMIN_EMAIL);
  var forceName = isAdmin ? 'Matthew' : undefined;
  setTimeout(function() {
    closeLoginModal();
    if(btn) { btn.textContent = 'Sign In â†’'; btn.disabled = false; }
    enterAppWithUser(savedEmail, isAdmin, forceName);
  }, 600);
}
function enterAppWithUser(email, isAdmin, forceName, weeklyReports) {
  try {
    var isFirstTime = false;
    var savedName = null;

    // Check localStorage for existing user data
    try {
      var saved = localStorage.getItem('tv_user');
      if (saved) {
        var parsed = JSON.parse(saved);
        if (parsed && parsed.email === email) {
          savedName = parsed.name || null;
        }
      }
    } catch(e) {}

    // If admin, skip onboarding â€” name is always Matthew
    // If returning user with a saved real name, skip onboarding
    // If brand new user (no saved name, or name is just the email prefix), show onboarding
    var emailPrefix = email ? email.split('@')[0] : '';
    var hasRealName = forceName || (savedName && savedName !== emailPrefix && savedName !== 'Creator' && savedName !== 'Demo Creator');
    isFirstTime = !isAdmin && !hasRealName;
    // Hard guard â€” admin NEVER sees onboarding
    if (isAdmin) {
      isFirstTime = false;
      // Immediately ensure modal is hidden â€” don't wait for any setTimeout
      var _om = document.getElementById('onboardingModal');
      if (_om) { _om.classList.remove('show'); _om.style.display = 'none'; }
    }

    currentUser = {
      email: email,
      name: isAdmin ? 'Matthew' : (forceName || (hasRealName ? savedName : (emailPrefix || 'Creator'))),
      plan: isAdmin ? 'elite' : 'free',
      isAdmin: isAdmin,
      weeklyReports: weeklyReports !== undefined ? weeklyReports : true,
      referralCode: 'TV-' + Math.random().toString(36).slice(2,8).toUpperCase(),
      referrals: []
    };

    // Restore saved plan
    try {
      var saved2 = localStorage.getItem('tv_user');
      if (saved2) {
        var parsed2 = JSON.parse(saved2);
        if (parsed2 && parsed2.email === email && parsed2.plan) {
          currentUser.plan = isAdmin ? 'elite' : parsed2.plan;
          if (parsed2.earlyAccess) currentUser.earlyAccess = true;
        }
        if (parsed2 && parsed2.referralCode) {
          currentUser.referralCode = parsed2.referralCode;
        }
      }
    } catch(e) {}

    localStorage.setItem('tv_user', JSON.stringify(currentUser));

    // Show the main app behind the modal
    var lc = document.getElementById('landingContent');
    if (lc) { lc.style.display = 'none'; }
    var lp = document.getElementById('landingPage');
    if (lp) { lp.style.display = 'none'; lp.style.visibility = 'hidden'; lp.style.zIndex = '-1'; lp.style.pointerEvents = 'none'; }
    var ma = document.getElementById('mainApp');
    if (ma) { ma.style.display = 'flex'; ma.style.zIndex = '1'; }
    window.scrollTo(0, 0);
    var mn = document.getElementById('mobNav');
    if (mn) mn.style.display = 'block';
    var sn = document.getElementById('sidebarName');
    if (sn) sn.textContent = currentUser.name;
    var msn = document.getElementById('mobileSidebarName');
    if (msn) msn.textContent = currentUser.name;
    updateUserPlanUI();
    updateBadges();
    updateAdminMessageBadge();
    // Navigate to dashboard immediately
    if (typeof navTo === 'function') navTo('dashboard');
    var pb = document.getElementById('providerBadge');
    if (pb) pb.style.display = isAdmin ? 'flex' : 'none';
    // Set avatar initial
    var initial = (currentUser.name || 'C').charAt(0).toUpperCase();
    var avatarEls = ['sidebarAvatar', 'mobileAvatarIcon'];
    avatarEls.forEach(function(id) {
      var el = document.getElementById(id);
      if(el) {
        el.textContent = '';
        el.style.fontSize = '14px';
        el.style.fontWeight = '900';
        el.style.fontFamily = 'var(--font-display)';
        el.style.color = '#fff';
        el.style.background = isAdmin
          ? 'linear-gradient(135deg,var(--gold),#d97706)'
          : 'linear-gradient(135deg,var(--accent),var(--purple))';
        el.textContent = initial;
      }
    });
    maybeStartTour();
    // Switch Fix-Everything btn â†’ logged-in orb
    if (typeof window._tvHealSwitchToOrb === 'function') window._tvHealSwitchToOrb();
    // Show admin button if admin
    var adminBtn = document.getElementById('adminNavBtn');
    if(adminBtn) adminBtn.style.display = isAdmin ? 'flex' : 'none';
    var adminBtnMob = document.getElementById('adminNavBtnMobile2');
    if(adminBtnMob) adminBtnMob.style.display = isAdmin ? 'flex' : 'none';
    var adminBtnMob2 = document.getElementById('adminNavBtnMobile2');
    if(adminBtnMob2) adminBtnMob2.style.display = isAdmin ? 'flex' : 'none';
    // Track user in admin records
    trackUser(currentUser);
    setTimeout(updateEarlyAccessNav, 800);
    setTimeout(function() { applyAppConfig(); hydrateAppConfigFromStorage(); }, 100);
    // Check for app update and auto-generate release notes (admin triggers, users see banner)
    setTimeout(function() {
      if (typeof checkForAppUpdate === 'function') {
        checkForAppUpdate().then(function() {
          if (typeof checkShowWhatsNew === 'function') checkShowWhatsNew();
        }).catch(function(){
          if (typeof checkShowWhatsNew === 'function') checkShowWhatsNew();
        });
      }
      // Check NPS survey (shown after 7 days inactivity)
      if (typeof checkShowNPSSurvey === 'function') checkShowNPSSurvey();
    }, 1500);
    // Check for referral code (from URL ?ref=TV-XXXXXX or localStorage)
    (function(){
      try {
        var refCode = null;
        var params = new URLSearchParams(window.location.search);
        if(params.get('ref')) { refCode = params.get('ref'); localStorage.setItem('tv_pending_ref', refCode); }
        else { refCode = localStorage.getItem('tv_pending_ref'); }
        if(refCode && refCode !== currentUser.referralCode) {
          var u = {}; try { u = JSON.parse(localStorage.getItem('tv_user')||'{}'); } catch(e) {}
          if(!u.referredBy) {
            u.referredBy = refCode;
            localStorage.setItem('tv_user', JSON.stringify(u));
            currentUser.referredBy = refCode;
            // Credit the referrer
            var allUsers = []; try { allUsers = JSON.parse(localStorage.getItem('tv_all_users')||'[]'); } catch(e) {}
            allUsers.forEach(function(au){ if(au.referralCode===refCode || au.email) {
              if(au.referralCode===refCode) { au.referralCount = (au.referralCount||0)+1; }
            }});
            try { localStorage.setItem('tv_all_users', JSON.stringify(allUsers)); } catch(e) {}
            localStorage.removeItem('tv_pending_ref');
          }
        }
      } catch(e) {}
    })();

    // Show onboarding name prompt for first-time users (never for admin)
    if (isFirstTime && !isAdmin) {
      setTimeout(function() {
        var om = document.getElementById('onboardingModal');
        if (om) {
          om.classList.add('show');
          om.classList.add('active'); // required gate â€” admin never gets this
          setTimeout(function() {
            var inp = document.getElementById('onboardingNameInput');
            if (inp) inp.focus();
          }, 200);
        }
      }, 400);
    }

    // Always show welcome banner  
    var _welcomeIsNew = isFirstTime;
    setTimeout(function() {
      showWelcomeBanner(currentUser ? currentUser.name : 'Creator', _welcomeIsNew);
    }, isFirstTime ? 2000 : 500);

  } catch(e) {
    // login error silenced
    alert('Sign in error: ' + e.message);
  }
  // Apply admin-only nav visibility after login
  setTimeout(function() { if (typeof window._applyAdminNav === 'function') window._applyAdminNav(); }, 400);
}

function submitOnboardingName() {
  // Hard admin guard â€” should never reach here but close immediately if so
  if (currentUser && currentUser.isAdmin) {
    var om = document.getElementById('onboardingModal');
    if (om) om.classList.remove('show');
    return;
  }
  var inp = document.getElementById('onboardingNameInput');
  var name = inp ? inp.value.trim() : '';
  if (!name) {
    inp.style.borderColor = 'var(--accent)';
    inp.placeholder = 'Please enter your name!';
    inp.focus();
    setTimeout(function() {
      inp.style.borderColor = '';
      inp.placeholder = 'Enter your name...';
    }, 1500);
    return;
  }
  // Capitalise first letter of each word
  name = name.replace(/\b\w/g, function(c) { return c.toUpperCase(); });
  currentUser.name = name;
  try { localStorage.setItem('tv_user', JSON.stringify(currentUser)); } catch(e) {}

  // Update all name display elements
  var sn = document.getElementById('sidebarName');
  if (sn) sn.textContent = name;
  var msn = document.getElementById('mobileSidebarName');
  if (msn) msn.textContent = name;

  // Close modal with a nice transition
  var om = document.getElementById('onboardingModal');
  if (om) {
    // Swap content to a welcome message before closing
    var box = om.querySelector('.onboarding-box');
    if (box) {
      box.innerHTML = `
        <span style="font-size:60px;display:block;margin-bottom:16px;animation:float 2s ease infinite">ðŸŽ‰</span>
        <div style="font-family:var(--font-display);font-size:28px;font-weight:800;letter-spacing:-0.5px;margin-bottom:8px">Hey, ${name}!</div>
        <div style="font-size:14px;color:var(--muted);line-height:1.6">Welcome to TrendVid. Let's go viral. ðŸš€</div>
      `;
    }
    setTimeout(function() {
      om.classList.remove('show');
      // Refresh dashboard to show the correct name in greeting
      if (typeof renderDashboard === 'function') renderDashboard();
      notify('Welcome to TrendVid, ' + name + '! ðŸŽ‰', 'success', 'ðŸ‘‹');
      // Show first-action nudge after a short delay
      setTimeout(function() { showFirstActionNudge(name); }, 1800);
      // Show full app tutorial for first-time users
      setTimeout(function() { if (typeof showAppTutorial === 'function') showAppTutorial(name); }, 3200);
    }, 1400);
  }
}

function pickOnboardingName(el) {
  var inp = document.getElementById('onboardingNameInput');
  if (inp) {
    inp.value = el.textContent;
    inp.focus();
  }
}
function enterApp() {
  showLogin();
}
function updateUserPlanUI(){
  const t=currentUser?.plan||'free';
  const tc=TIERS[t];
  const planEls=document.querySelectorAll('.user-plan-badge');
  planEls.forEach(el=>el.innerHTML=`<span class="tier-badge tier-${t}" style="${tc.badgeStyle||''}">${tc.label}</span>`);
  // Update sidebar plan display
  const upEl=document.getElementById('sidebarPlan');
  if(upEl) upEl.innerHTML=`<span class="tier-badge tier-${t}" style="${tc.badgeStyle||''}">${tc.label}</span>`;
  const mUpEl=document.getElementById('mobileSidebarPlan');
  if(mUpEl) mUpEl.innerHTML=`<span class="tier-badge tier-${t}" style="${tc.badgeStyle||''}">${tc.label}</span>`;
}
function logout() {
  currentUser = null;
  // Hide admin nav buttons
  var adminBtn = document.getElementById('adminNavBtn');
  if(adminBtn) adminBtn.style.display = 'none';
  var adminBtnMob = document.getElementById('adminNavBtnMobile2');
  if(adminBtnMob) adminBtnMob.style.display = 'none';
  // Switch views
  var ma = document.getElementById('mainApp');
  if(ma) ma.style.display = 'none';
  var mn = document.getElementById('mobNav');
  if(mn) mn.style.display = 'none';
  var lp = document.getElementById('landingPage');
  if(lp) lp.style.display = 'flex';
  var lc = document.getElementById('landingContent');
  if(lc) lc.style.display = '';
  closeMobileSidebar();
  // Clear login form
  var emailEl = document.getElementById('loginEmail');
  if(emailEl) emailEl.value = '';
  var pwEl = document.getElementById('loginPassword');
  if(pwEl) pwEl.value = '';
}

// ============================================================
// MOBILE SIDEBAR
// ============================================================
function toggleMobileSidebar() {
  const sidebar = document.getElementById('mobileSidebar');
  const overlay = document.getElementById('sidebarOverlay');
  const btn = document.getElementById('hamburgerBtn');
  const moreBtn = document.getElementById('mob-more');
  const isOpen = sidebar.classList.contains('open');
  if (isOpen) { closeMobileSidebar(); }
  else {
    sidebar.classList.add('open');
    overlay.classList.add('show');
    btn.classList.add('open');
    if (moreBtn) moreBtn.classList.add('active');
    document.body.style.overflow = 'hidden';
  }
}
function closeMobileSidebar() {
  document.getElementById('mobileSidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('show');
  document.getElementById('hamburgerBtn').classList.remove('open');
  const moreBtn = document.getElementById('mob-more');
  if (moreBtn) moreBtn.classList.remove('active');
  document.body.style.overflow = '';
}

// ============================================================
// NAVIGATION
// ============================================================
const pageTitles={
  dashboard:'Dashboard',trends:'Trend Radar',script:'Script Generator',thumbnail:'Thumbnail AI',
  library:'Script Library',calendar:'Content Calendar',favourites:'Favourites',
  multilang:'Multi-Language',affiliate:'Affiliate',settings:'Settings',help:'Help & AI Chat',
  voice:'Voice to Script',teleprompter:'Teleprompter Mode',hashtags:'Hashtag & SEO Generator',
  hooktester:'30-Second Hook Tester',repurpose:'Script Repurposer',brandkit:'Brand Kit',
  alerts:'Trend Alerts',abtitle:'A/B Title Tester',gapfinder:'Content Gap Finder',
  pricing:'Plans & Pricing',
  soundtrack:'Soundtrack Finder',
  bundles:'Bundle Deals',
  admin:'Admin Panel',
  ytanalyse:'YouTube Channel Analyser',
  descgen:'Description & Chapters Generator',
  thumbab:'Thumbnail A/B Tester',
  collab:'Collab Finder',
  scheduler:'Post Scheduler',
  xp:'XP & Levels',
  leaderboard:'ðŸ† Global Leaderboard',
  imagegen:'ðŸ–¼ï¸ AI Image Generator',
  changelog:'ðŸ“‹ What\'s New',
  earlyaccess:'âš¡ Early Access',
videogen:'ðŸŽ¬ Script to Video'
};
function navTo(page){
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const active=document.querySelector(`[data-page="${page}"]`);
  if(active)active.classList.add('active');
  document.getElementById('topbarTitle').textContent=pageTitles[page]||page;
  document.querySelectorAll('.mob-nav-btn').forEach(b=>b.classList.remove('active'));
  const mob=document.getElementById('mob-'+page);
  if(mob)mob.classList.add('active');
  updateBadges();
  // Tier gate: block access if user plan doesn't meet requirement
  if(typeof userCanAccess==='function' && !userCanAccess(page)){ window._lastAttemptedAction = 'Access ' + (page.charAt(0).toUpperCase()+page.slice(1)); showUpgradeGate(page);return;}
  // Early access gate: if this page was added in the latest release,
  // non-EA users can't navigate to it for 7 days
  var _latestRel = getLatestRelease();
  if (_latestRel) {
    var _relAt = _latestRel.releasedAt || _latestRel.at || 0;
    var _ageMs = Date.now() - _relAt;
    if (_ageMs < EARLY_ACCESS_WINDOW_MS && !isEarlyAccessUser()) {
      var _addedPages = _latestRel.addedPages || [];
      if (_addedPages.indexOf(page) !== -1) {
        notify('This feature is in Early Access for the next ' +
          Math.ceil((EARLY_ACCESS_WINDOW_MS - _ageMs) / (24*60*60*1000)) +
          ' days. Check back soon!', 'info', 'lock');
        navTo('earlyaccess');
        return;
      }
    }
  }

  switch(page){
    case 'earlyaccess': renderEarlyAccessPage(); break;
    case 'dashboard':renderDashboard();break;
    case 'trends':renderTrends();break;
    case 'script':renderScript();break;
    case 'thumbnail':renderThumbnail();break;
    case 'library':renderLibrary();break;
    case 'calendar':renderCalendar();break;
    case 'favourites':renderFavourites();break;
    case 'multilang':renderMultiLang();break;
    case 'affiliate':renderAffiliate();break;
    case 'settings':renderSettings();break;
    case 'help':renderHelp();break;
    case 'voice':renderVoiceToScript();break;
    case 'teleprompter':renderTeleprompter();break;
    case 'hashtags':renderHashtags();break;
    case 'hooktester':renderHookTester();break;
    case 'repurpose':renderRepurposer();break;
    case 'brandkit':renderBrandKit();break;
    case 'alerts':renderAlerts();break;
    case 'abtitle':renderABTitle();break;
    case 'gapfinder':renderGapFinder();break;
    case 'pricing':renderPricing();break;
    case 'viral':renderViralScore();break;
    case 'health':renderChannelHealth();break;
    case 'broll':renderBroll();break;
    case 'music':renderMusicPicks();break;
    case 'captions':renderCaptionGen();break;
    case 'comments':renderCommentReplies();break;
    case 'improver':renderScriptImprover();break;
    case 'giftcodes':renderGiftCodes();break;
    case 'soundtrack':renderSoundtrack();break;
    case 'bundles':renderBundleDeals();break;
    case 'admin':renderAdmin();break;
    case 'ytanalyse':renderYTAnalyser();break;
    case 'descgen':renderDescGen();break;
    case 'thumbab':renderThumbAB();break;
    case 'collab':renderCollabFinder();break;
    case 'scheduler':renderPostScheduler();break;
    case 'xp':renderXPPage();break;
    case 'leaderboard':renderLeaderboard();break;
    case 'imagegen':
      if (!window.currentUser || !window.currentUser.isAdmin) {
        document.getElementById('page-content').innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh;gap:16px;text-align:center;padding:40px"><div style="font-size:56px">ðŸ”’</div><div style="font-family:var(--font-display);font-size:22px;font-weight:900">Admin Only</div><div style="font-size:14px;color:var(--muted)">The Image Generator is restricted to admins.</div></div>';
      } else { renderImageGen(); }
      break;
    case 'changelog':renderPublicChangelog();break;
    case 'videogen':renderVideoGen();break;
        default:document.getElementById('pageContent').innerHTML='<div style="color:var(--muted);padding:60px;text-align:center">Coming soon</div>';
  }
}

// ============================================================
// DASHBOARD
// ============================================================
function renderDashboard(){
  const scripts=JSON.parse(localStorage.getItem('tv_scripts')||'[]');
  const favs=JSON.parse(localStorage.getItem('tv_favs')||'[]');
  const calData=JSON.parse(localStorage.getItem('tv_calendar')||'{}');
  const calCount=Object.values(calData).filter(v=>v).length;
  const hour=new Date().getHours();
  const greeting=hour<12?'Good morning':hour<18?'Good afternoon':'Good evening';

  // Admin broadcast announcements
  var announcements=[]; try{announcements=JSON.parse(localStorage.getItem('tv_announcements')||'[]');}catch(e){}
  var dismissedAt=0; try{dismissedAt=parseInt(localStorage.getItem('tv_ann_dismissed')||'0');}catch(e){}
  var latestAnn = announcements.length>0 ? announcements[0] : null;
  var annBanner = '';
  if(latestAnn && latestAnn.at > dismissedAt) {
    var annColor={info:'var(--purple)',success:'var(--teal)',alert:'var(--accent)'}[latestAnn.type||'info']||'var(--purple)';
    var annBg={info:'rgba(167,139,250,0.08)',success:'rgba(0,212,170,0.08)',alert:'rgba(255,48,88,0.08)'}[latestAnn.type||'info']||'rgba(167,139,250,0.08)';
    annBanner=`<div style="background:${annBg};border:1px solid ${annColor};border-radius:12px;padding:12px 16px;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;gap:12px;animation:slideUp 0.4s ease">
      <div style="display:flex;align-items:center;gap:10px">
        <span style="font-size:20px">${latestAnn.type==='success'?'âœ…':latestAnn.type==='alert'?'âš ï¸':'ðŸ“Œ'}</span>
        <div><div style="font-size:13px;font-weight:700;color:${annColor}">${latestAnn.title}</div><div style="font-size:12px;color:var(--text2);margin-top:2px">${latestAnn.message}</div></div>
      </div>
      <button onclick="localStorage.setItem('tv_ann_dismissed','${latestAnn.at}');this.closest('[style]').remove()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;flex-shrink:0;padding:4px 8px">Ã—</button>
    </div>`;
  }

  // Trial banner (free users only, first 7 days)
  var trialBanner = '';
  var plan = currentUser?.plan||'free';
  if(plan === 'free') {
    var joinedAt = 0; try{ var u=JSON.parse(localStorage.getItem('tv_user')||'{}'); joinedAt=u.joinedAt||Date.now(); }catch(e){}
    if(!joinedAt) { joinedAt = Date.now(); try{ var u2=JSON.parse(localStorage.getItem('tv_user')||'{}'); u2.joinedAt=joinedAt; localStorage.setItem('tv_user',JSON.stringify(u2)); }catch(e){} }
    var daysLeft = Math.max(0, 7 - Math.floor((Date.now()-joinedAt)/(1000*60*60*24)));
    var trialDismissed = localStorage.getItem('tv_trial_dismissed');
    if(!trialDismissed) {
      trialBanner = `<div class="trial-banner">
        <div class="trial-banner-left">
          <div>
            <div class="trial-banner-days">âš¡ ${daysLeft}</div>
          </div>
          <div>
            <div class="trial-banner-text">days left in your free trial</div>
            <div class="trial-banner-sub">Upgrade to Pro to keep all your tools â€” no limits, no lock-outs</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-shrink:0">
          <button class="btn btn-gold btn-sm" onclick="navTo('pricing')">Upgrade Now ðŸ’Ž</button>
          <button onclick="localStorage.setItem('tv_trial_dismissed','1');this.closest('.trial-banner').remove()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;padding:4px">Ã—</button>
        </div>
      </div>`;
    }
  }

  // Onboarding checklist
  var checks = [
    {key:'scanned_trend', label:'Scan your first trend', icon:'ðŸ“ˆ', page:'trends', xp:'+10 XP'},
    {key:'wrote_script',  label:'Generate your first script', icon:'âœï¸', page:'script', xp:'+15 XP'},
    {key:'made_thumb',    label:'Create a thumbnail', icon:'ðŸŽ¨', page:'thumbnail', xp:'+10 XP'},
    {key:'saved_fav',     label:'Save a favourite trend', icon:'â­', page:'trends', xp:'+5 XP'},
    {key:'filled_cal',    label:'Fill your content calendar', icon:'ðŸ“…', page:'calendar', xp:'+10 XP'},
    {key:'tested_hook',   label:'Test a hook', icon:'âš¡', page:'hooktester', xp:'+10 XP'},
  ];
  var completed = 0; checks.forEach(c=>{ if(localStorage.getItem('tv_check_'+c.key)) completed++; });
  var allDone = completed >= checks.length;
  var checklistHtml = '';
  if(!allDone && !localStorage.getItem('tv_checklist_dismissed')) {
    var pct = Math.round(completed/checks.length*100);
    checklistHtml = `<div class="checklist-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div>
          <div class="section-label" style="margin-bottom:2px">GETTING STARTED</div>
          <div style="font-size:13px;font-weight:600">${completed}/${checks.length} complete Â· <span style="color:var(--gold)">${completed*10} XP earned</span></div>
        </div>
        <button onclick="localStorage.setItem('tv_checklist_dismissed','1');this.closest('.checklist-card').remove()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px">Ã—</button>
      </div>
      <div class="checklist-progress"><div class="checklist-progress-fill" style="width:${pct}%"></div></div>
      ${checks.map(c=>{
        var done = !!localStorage.getItem('tv_check_'+c.key);
        return `<div class="checklist-item${done?' done':''}" onclick="navTo('${c.page}')">
          <div class="checklist-circle">${done?'âœ“':''}</div>
          <span class="checklist-label">${c.icon} ${c.label}</span>
          <span class="checklist-xp">${c.xp}</span>
        </div>`;
      }).join('')}
    </div>`;
  }

  document.getElementById('pageContent').innerHTML=`
    ${annBanner}
    ${trialBanner}
    <div style="margin-bottom:24px;animation:slideUp 0.4s ease">
      <div class="section-label" style="margin-bottom:4px">WELCOME BACK</div>
      <h2 style="font-family:var(--font-display);font-size:30px;font-weight:800;letter-spacing:-0.5px">${greeting}, <span style="color:var(--accent)">${currentUser?currentUser.name:'Creator'}</span> ðŸ‘‹</h2>
      <p style="font-size:13px;color:var(--muted);margin-top:5px">Here's your content studio overview.</p>
    </div>

    ${checklistHtml}

    <div class="dashboard-grid">
      <div class="stat-card red" style="animation:slideUp 0.4s 0.05s ease both">
        <div class="stat-card-icon">âœï¸</div>
        <div class="stat-card-num">${scripts.length}</div>
        <div class="stat-card-label">Scripts Saved</div>
        <div class="stat-card-change up">â†‘ Ready to use</div>
      </div>
      <div class="stat-card teal" style="animation:slideUp 0.4s 0.1s ease both">
        <div class="stat-card-icon">â­</div>
        <div class="stat-card-num">${favs.length}</div>
        <div class="stat-card-label">Saved Trends</div>
        <div class="stat-card-change up">â†‘ Opportunities</div>
      </div>
      <div class="stat-card gold" style="animation:slideUp 0.4s 0.15s ease both">
        <div class="stat-card-icon">ðŸ“…</div>
        <div class="stat-card-num">${calCount}</div>
        <div class="stat-card-label">Calendar Ideas</div>
        <div class="stat-card-change ${calCount>0?'up':'down'}">${calCount>0?'â†‘ Planned ahead':'â†“ Fill your calendar'}</div>
      </div>
      <div class="stat-card purple" style="animation:slideUp 0.4s 0.2s ease both;cursor:pointer" onclick="navTo('trends')">
        <div class="stat-card-icon">ðŸ”</div>
        <div class="stat-card-num" style="font-size:24px;letter-spacing:-0.5px">NEW</div>
        <div class="stat-card-label">Competitor Analysis</div>
        <div class="stat-card-change up">â†‘ Try it now â†’</div>
      </div>
    </div>

    <div class="dash-row">
      <div class="card" style="animation:slideUp 0.4s 0.25s ease both">
        <div class="section-label" style="margin-bottom:14px">QUICK ACTIONS</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <div class="quick-action" onclick="navTo('trends')">
            <div class="quick-action-icon">ðŸ“ˆ</div>
            <div><div class="quick-action-title">Scan for Trends</div><div class="quick-action-desc">Find what's viral right now</div></div>
            <span style="margin-left:auto;color:var(--muted)">â†’</span>
          </div>
          <div class="quick-action" onclick="navTo('script')">
            <div class="quick-action-icon">âœï¸</div>
            <div><div class="quick-action-title">Write a Script</div><div class="quick-action-desc">AI-powered in 30 seconds</div></div>
            <span style="margin-left:auto;color:var(--muted)">â†’</span>
          </div>
          <div class="quick-action" onclick="navTo('thumbnail')">
            <div class="quick-action-icon">ðŸŽ¨</div>
            <div><div class="quick-action-title">Create Thumbnail</div><div class="quick-action-desc">High-CTR designs instantly</div></div>
            <span style="margin-left:auto;color:var(--muted)">â†’</span>
          </div>
          <div class="quick-action" onclick="navTo('ytanalyse')">
            <div class="quick-action-icon">ðŸ“º</div>
            <div><div class="quick-action-title">Analyse a Channel</div><div class="quick-action-desc">AI audit of any YouTube channel</div></div>
            <span style="margin-left:auto;color:var(--muted)">â†’</span>
          </div>
          <div class="quick-action" onclick="navTo('scheduler')">
            <div class="quick-action-icon">ðŸ—“ï¸</div>
            <div><div class="quick-action-title">Schedule Posts</div><div class="quick-action-desc">Plan your weekly upload calendar</div></div>
            <span style="margin-left:auto;color:var(--muted)">â†’</span>
          </div>
          <div class="quick-action" onclick="navTo('imagegen')" style="border-color:rgba(0,229,176,0.2);background:rgba(0,229,176,0.03)">
            <div class="quick-action-icon">ðŸ–¼ï¸</div>
            <div><div class="quick-action-title" style="color:var(--teal)">Generate Images</div><div class="quick-action-desc">Free AI image studio â€” all plans</div></div>
            <span style="margin-left:auto;color:var(--teal)">â†’</span>
          </div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;gap:14px">
        <!-- GROW & SHARE PROMO CARD -->
        <div class="card" style="border:1px solid rgba(255,48,88,0.2);background:linear-gradient(135deg,rgba(255,48,88,0.04),rgba(167,139,250,0.03));animation:slideUp 0.4s 0.28s ease both">
          <div style="font-size:10px;font-weight:900;letter-spacing:2px;color:var(--accent);margin-bottom:10px;font-family:var(--font-display)">ðŸš€ GROW YOUR CHANNEL</div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button onclick="showCreatorStatsCard()" style="display:flex;align-items:center;gap:10px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:9px 12px;cursor:pointer;font-family:inherit;text-align:left;width:100%;transition:border-color 0.15s" onmouseover="this.style.borderColor='rgba(0,229,176,0.4)'" onmouseout="this.style.borderColor='var(--border)'">
              <span style="font-size:18px">ðŸ“Š</span>
              <div><div style="font-size:12px;font-weight:700;color:var(--text)">My Creator Stats Card</div><div style="font-size:10px;color:var(--muted)">Shareable card of your TrendVid journey</div></div>
              <span style="margin-left:auto;color:var(--muted);font-size:12px">â†’</span>
            </button>
            <button onclick="showCertifiedBadge()" style="display:flex;align-items:center;gap:10px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:9px 12px;cursor:pointer;font-family:inherit;text-align:left;width:100%;transition:border-color 0.15s" onmouseover="this.style.borderColor='rgba(251,191,36,0.4)'" onmouseout="this.style.borderColor='var(--border)'">
              <span style="font-size:18px">ðŸ…</span>
              <div><div style="font-size:12px;font-weight:700;color:var(--text)">Certified Creator Badge</div><div style="font-size:10px;color:var(--muted)">Download & show it on your channel</div></div>
              <span style="margin-left:auto;color:var(--muted);font-size:12px">â†’</span>
            </button>
            <button onclick="showEmbedWidget()" style="display:flex;align-items:center;gap:10px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:9px 12px;cursor:pointer;font-family:inherit;text-align:left;width:100%;transition:border-color 0.15s" onmouseover="this.style.borderColor='rgba(167,139,250,0.4)'" onmouseout="this.style.borderColor='var(--border)'">
              <span style="font-size:18px">ðŸŒ</span>
              <div><div style="font-size:12px;font-weight:700;color:var(--text)">Embed Trend Widget</div><div style="font-size:10px;color:var(--muted)">Add live trends to your website/blog</div></div>
              <span style="margin-left:auto;color:var(--muted);font-size:12px">â†’</span>
            </button>
            <button onclick="navTo('affiliate')" style="display:flex;align-items:center;gap:10px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:9px 12px;cursor:pointer;font-family:inherit;text-align:left;width:100%;transition:border-color 0.15s" onmouseover="this.style.borderColor='rgba(255,138,0,0.4)'" onmouseout="this.style.borderColor='var(--border)'">
              <span style="font-size:18px">ðŸ’¸</span>
              <div><div style="font-size:12px;font-weight:700;color:var(--text)">Earn 30% Commission</div><div style="font-size:10px;color:var(--muted)">Refer creators, earn recurring income</div></div>
              <span style="margin-left:auto;color:var(--muted);font-size:12px">â†’</span>
            </button>
          </div>
        </div>
        <div class="tip-card" style="animation:slideUp 0.4s 0.3s ease both">
          <div class="tip-card-head">ðŸ’¡ Creator Tip of the Day</div>
          <div class="tip-card-body" id="tipBody">Loading your daily tip...</div>
        </div>
        <div class="card" style="animation:slideUp 0.4s 0.35s ease both">
          <div class="section-label" style="margin-bottom:12px">RECENT SCRIPTS</div>
          ${scripts.length===0?`<div style="text-align:center;padding:24px;color:var(--muted);font-size:13px">No scripts yet â€” <span style="color:var(--accent);cursor:pointer" onclick="navTo('script')">generate one â†’</span></div>`
          :scripts.slice(0,3).map(s=>`
            <div class="activity-item">
              <div class="activity-icon">âœï¸</div>
              <div style="flex:1;min-width:0">
                <div style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${s.topic}</div>
                <div style="font-size:11px;color:var(--muted)">${s.platform} Â· ${timeAgo(s.savedAt)}</div>
              </div>
            </div>`).join('')}
          ${scripts.length>0?`<div style="margin-top:8px"><button class="btn btn-ghost btn-sm" style="width:100%" onclick="navTo('library')">View All ${scripts.length} Scripts â†’</button></div>`:''}
        </div>
      </div>
    </div>`;

  // Load daily tip async
  const tips=[
    'Act on a trend when it\'s **Rising**, not already Hot â€” you\'ll be 3-5 days ahead of the wave.',
    'Your first **3 seconds** decide everything. Hook with a bold claim, question, or shocking visual.',
    'Thumbnails with **fewer than 6 words** and a human face get 40-60% better CTR on average.',
    'Post at **peak hours** for your audience: YouTube 2-4pm, TikTok 7-9pm, Instagram 11am-1pm.',
    'End every video with a **specific CTA** â€” "comment X if you want part 2" beats "like and subscribe".',
    '**Respond to comments** in the first 30 minutes â€” it tells the algorithm your video is generating engagement.',
    'Use **pattern interrupts** every 20-30 seconds to keep retention high â€” cut to B-roll, add text, change angle.',
    'Your **title and thumbnail** should create a curiosity gap â€” promise something, but don\'t fully deliver it in the preview.',
    'Re-purpose your **best performing video** into 5 Shorts, 3 tweets, and an email â€” one video, 9 pieces of content.',
    '**Consistency beats quality** for new channels. 1 video a week for a year beats 1 perfect video every 2 months.',
  ];
  setTimeout(()=>{
    const tipEl=document.getElementById('tipBody');
    if(tipEl){
      const tip=tips[Math.floor(Math.random()*tips.length)];
      tipEl.innerHTML=tip.replace(/\*\*(.*?)\*\*/g,'<strong style="color:var(--text)">$1</strong>');
    }
  },100);
}

// ============================================================
// TRENDS
// ============================================================
let trendPlatform='All', trendCategory='', trendTab='trends';
function renderTrends(){
  document.getElementById('pageContent').innerHTML=`
    <div style="display:flex;gap:6px;margin-bottom:22px;background:var(--surface2);padding:4px;border-radius:13px;border:1px solid var(--border);width:fit-content">
      <button class="btn btn-sm${trendTab==='trends'?' btn-primary':' btn-ghost'}" style="border-radius:9px" onclick="switchTrendTab('trends',this)">ðŸ“ˆ Trend Radar</button>
      <button class="btn btn-sm${trendTab==='competitor'?' btn-primary':' btn-ghost'}" style="border-radius:9px" onclick="switchTrendTab('competitor',this)">ðŸ” Competitor Analysis</button>
      <button class="btn btn-sm${trendTab==='ideas'?' btn-primary':' btn-ghost'}" style="border-radius:9px" onclick="switchTrendTab('ideas',this)">ðŸ’¡ Niche Ideas</button>
    </div>
    <div id="trendTabContent"></div>`;
  renderTrendTab();
}
function switchTrendTab(tab, el){
  trendTab=tab;
  document.querySelectorAll('#trendTabContent').forEach(()=>{});
  // Re-render with updated tab
  document.querySelector('[onclick^="switchTrendTab"]').closest('[style]').querySelectorAll('.btn').forEach(b=>{b.className=b.className.replace('btn-primary','btn-ghost');});
  el.className=el.className.replace('btn-ghost','btn-primary');
  renderTrendTab();
}
function renderTrendTab(){
  const container=document.getElementById('trendTabContent');
  if(!container)return;
  if(trendTab==='trends'){
    container.innerHTML=`
      <div class="trends-header">
        <div class="trends-filters" id="trendFilters">
          <div class="filter-chip active" onclick="setTrendPlatform('All',this)">ðŸŒ All</div>
          <div class="filter-chip" style="color:var(--yt)" onclick="setTrendPlatform('YouTube',this)">â–¶ YouTube</div>
          <div class="filter-chip" style="color:var(--tt)" onclick="setTrendPlatform('TikTok',this)">â™ª TikTok</div>
          <div class="filter-chip" style="color:var(--ig)" onclick="setTrendPlatform('Instagram',this)">â—ˆ Instagram</div>
          <select class="form-input form-select" style="width:150px;padding:7px 12px;font-size:11px;height:36px;" id="catSel" onchange="trendCategory=this.value">
            <option value="">All Categories</option>
            <option>Tech</option><option>Finance</option><option>Fitness</option>
            <option>Food</option><option>Gaming</option><option>Lifestyle</option>
            <option>Beauty</option><option>Education</option><option>Business</option><option>Entertainment</option>
          </select>
        </div>
        <button class="btn btn-primary btn-sm" onclick="loadTrends()">ðŸ”„ Refresh Trends</button>
      </div>
      <div id="trendsGrid" class="trends-grid">
        <div class="trend-empty">
          <span class="trend-empty-icon">ðŸ“ˆ</span>
          <div style="font-size:16px;font-weight:700;margin-bottom:8px">Discover what's trending right now</div>
          <div style="font-size:13px;margin-bottom:24px;color:var(--text2)">AI-powered trend scanning across YouTube, TikTok & Instagram</div>
          <button class="btn btn-primary btn-lg" onclick="loadTrends()">ðŸ”¥ Load Trends</button>
        </div>
      </div>`;
  } else if(trendTab==='competitor'){
    container.innerHTML=`
      <div class="card" style="margin-bottom:20px">
        <div class="section-label" style="margin-bottom:14px">COMPETITOR CHANNEL ANALYSIS</div>
        <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end">
          <div class="form-field" style="margin:0">
            <label>Channel or Creator Name</label>
            <input class="form-input" id="compInput" placeholder="e.g. MrBeast, MKBHD, Ali Abdaalâ€¦" onkeydown="if(event.key==='Enter')analyzeCompetitor()">
          </div>
          <button class="btn btn-primary" onclick="analyzeCompetitor()">ðŸ” Analyze</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          ${['MrBeast','MKBHD','Ali Abdaal','Yes Theory','Graham Stephan'].map(c=>`<span style="cursor:pointer;font-size:11px;padding:4px 12px;border-radius:20px;border:1px solid var(--border);color:var(--text2);transition:all var(--transition)" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text2)'" onclick="document.getElementById('compInput').value='${c}';analyzeCompetitor()">${c}</span>`).join('')}
        </div>
      </div>
      <div id="compResults"></div>`;
  } else {
    container.innerHTML=`
      <div class="card" style="margin-bottom:20px">
        <div class="section-label" style="margin-bottom:14px">NICHE OPPORTUNITY FINDER</div>
        <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:10px;align-items:end">
          <div class="form-field" style="margin:0">
            <label>Your Niche</label>
            <input class="form-input" id="nicheInput" placeholder="e.g. Personal Finance, Fitness, Tech Reviewsâ€¦">
          </div>
          <div class="form-field" style="margin:0">
            <label>Your Platform</label>
            <select class="form-input form-select" id="nichePlatform">
              <option>YouTube</option><option>TikTok</option><option>Instagram</option><option>All Platforms</option>
            </select>
          </div>
          <button class="btn btn-purple" onclick="findNicheIdeas()">ðŸ’¡ Find Gaps</button>
        </div>
      </div>
      <div id="nicheResults"></div>`;
  }
}
function setTrendPlatform(p,el){
  trendPlatform=p;
  document.querySelectorAll('#trendFilters .filter-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
}
async function loadTrends(){
  const grid=document.getElementById('trendsGrid');
  if(!grid)return;
  grid.innerHTML=`<div style="grid-column:1/-1;display:flex;align-items:center;justify-content:center;padding:70px;gap:14px;color:var(--muted);flex-direction:column"><div class="spinner spinner-lg"></div><div style="font-size:14px">Scanning platforms for viral trends...</div><div style="font-size:12px;opacity:0.6">This takes a few seconds</div></div>`;
  try{
    const cat=trendCategory?` in the ${trendCategory} niche`:'';
    const plat=trendPlatform!=='All'?` for ${trendPlatform}`:'across YouTube, TikTok, and Instagram';
    const raw=await callClaude([{role:'user',content:`Generate 9 trending video topic ideas${cat}${plat} for content creators. Return ONLY a raw JSON array with objects: title (max 65 chars), category, platform ("YouTube"|"TikTok"|"Instagram"), score (72-99), views (like "2.4M"), emoji (single emoji), hook (compelling one-liner under 80 chars), why (1 sentence why it's trending now).`}],
      'You are a social media trend analyst. Return ONLY valid raw JSON, no markdown.',1400);
    const trends=JSON.parse(raw.replace(/```json|```/g,'').trim());
    grid.innerHTML=trends.map((t,i)=>`
      <div class="trend-card" style="animation-delay:${i*0.06}s">
        <div class="trend-rank">#${i+1}</div>
        <div class="trend-platform-row">
          <div class="trend-platform-tag">
            <span>${t.platform==='YouTube'?'â–¶':t.platform==='TikTok'?'â™ª':'â—ˆ'}</span>
            <span style="color:${t.platform==='YouTube'?'var(--yt)':t.platform==='TikTok'?'var(--tt)':'var(--ig)'}">${t.platform}</span>
            <span>Â· ${t.category}</span>
          </div>
          <span class="badge badge-${t.score>90?'hot':t.score>80?'rising':'live'}">${t.score>90?'ðŸ”¥ HOT':t.score>80?'ðŸ“ˆ RISING':'âœ… LIVE'}</span>
        </div>
        <span class="trend-emoji">${t.emoji}</span>
        <div class="trend-title">${t.title}</div>
        <div class="trend-hook">"${t.hook}"</div>
        <div class="trend-stats">
          <div class="trend-stat">ðŸ‘ ${t.views}</div>
          <div class="trend-stat">ðŸ”¥ ${t.score}/100</div>
        </div>
        <div class="trend-bar"><div class="trend-bar-fill" style="width:${t.score}%"></div></div>
        ${t.why?`<div style="font-size:11px;color:var(--text2);margin-bottom:12px;line-height:1.4">ðŸ“Œ ${t.why}</div>`:''}
        <div class="trend-actions">
          <button class="btn btn-primary btn-sm" style="flex:1" onclick="useForScript('${esc(t.title)}','${t.platform}','${t.category}')">âœï¸ Script</button>
          <button class="btn btn-secondary btn-sm" onclick="useForThumb('${esc(t.title)}')">ðŸŽ¨</button>
          <button class="btn btn-ghost btn-sm" onclick="saveFavourite('${esc(t.title)}','${t.emoji}','${t.category}')">â­</button>
        </div>
      </div>`).join('');
    awardXP('scanned_trend');
  }catch(e){
    // If it's a network error (file:// CORS, no internet, expired keys), show demo trends
    // so the page is never a dead end
    var isNetworkErr = e.message && (e.message.indexOf('fetch') !== -1 || e.message.indexOf('providers failed') !== -1 || e.message.indexOf('network') !== -1);
    if (isNetworkErr) {
      var demoTrends = [
        {title:'I Tried Every AI Tool For 30 Days â€” Here\'s What Actually Works',category:'Tech',platform:'YouTube',score:97,views:'3.2M',emoji:'ðŸ¤–',hook:'The honest results nobody talks about',why:'AI tool reviews are exploding â€” audiences want real hands-on verdicts, not sponsored takes'},
        {title:'Silent Vlog: 6AM Productive Morning Routine (No Talking)',category:'Lifestyle',platform:'YouTube',score:94,views:'8.1M',emoji:'ðŸŒ…',hook:'No alarm. No coffee. No talking. Just this.',why:'Silent vlogs are trending as a calming counter to overstimulating content'},
        {title:'POV: I Quit My Job To Make Faceless YouTube Videos',category:'Business',platform:'TikTok',score:93,views:'5.7M',emoji:'ðŸ’»',hook:'Month 1 income reveal â€” not what I expected',why:'Faceless channel content & passive income stories dominate creator discourse right now'},
        {title:'We Ate At The World\'s Most Expensive McDonald\'s',category:'Food',platform:'YouTube',score:91,views:'12.4M',emoji:'ðŸ”',hook:'$47 Big Mac. Worth it?',why:'Luxury vs budget food comparisons consistently drive massive engagement'},
        {title:'Exposing The Algorithm: I Posted 90 Days In A Row',category:'Creator',platform:'TikTok',score:90,views:'2.9M',emoji:'ðŸ“Š',hook:'Day 90 result will shock you',why:'Transparency about creator growth experiments drives strong saves and shares'},
        {title:'How I Made $10K In One Weekend Flipping Thrift Store Finds',category:'Finance',platform:'Instagram',score:88,views:'1.8M',emoji:'ðŸ›',hook:'Everything I bought + final profit breakdown',why:'Side hustle and reselling content peaks in Q1 as people chase new income streams'},
        {title:'I Lived On $5 A Day In Tokyo For A Week',category:'Travel',platform:'YouTube',score:87,views:'6.3M',emoji:'ðŸ‡¯ðŸ‡µ',hook:'Day 3 almost broke me',why:'Budget travel challenges in expensive cities are a proven viral formula'},
        {title:'This Gym Mistake Kept Me Weak For 3 Years',category:'Fitness',platform:'TikTok',score:85,views:'4.1M',emoji:'ðŸ’ª',hook:'Nobody told me this and it cost me years',why:'Fitness myth-busting and "I wish I knew" content drives saves and reshares'},
        {title:'Rating Every Free AI Image Generator In 2025',category:'Tech',platform:'Instagram',score:83,views:'920K',emoji:'ðŸŽ¨',hook:'The free one that beats Midjourney',why:'Comparison and ranking content for free tools always attracts high-intent audiences'},
      ];
      var cat = trendCategory || '';
      var plat = trendPlatform !== 'All' ? trendPlatform : '';
      var filtered = demoTrends.filter(function(t) {
        return (!plat || t.platform === plat);
      });
      if (!filtered.length) filtered = demoTrends;
      grid.innerHTML = '<div style="grid-column:1/-1;padding:10px 0 18px;text-align:center;font-size:12px;color:var(--muted);background:rgba(255,200,0,0.07);border-radius:10px;margin-bottom:6px">âš¡ Showing example trends â€” connect an AI provider in Settings to load live data</div>' +
        filtered.map(function(t,i){ return `
        <div class="trend-card" style="animation-delay:${i*0.06}s">
          <div class="trend-rank">#${i+1}</div>
          <div class="trend-platform-row">
            <div class="trend-platform-tag">
              <span>${t.platform==='YouTube'?'â–¶':t.platform==='TikTok'?'â™ª':'â—ˆ'}</span>
              <span style="color:${t.platform==='YouTube'?'var(--yt)':t.platform==='TikTok'?'var(--tt)':'var(--ig)'}">${t.platform}</span>
              <span>Â· ${t.category}</span>
            </div>
            <span class="badge badge-${t.score>90?'hot':t.score>80?'rising':'live'}">${t.score>90?'ðŸ”¥ HOT':t.score>80?'ðŸ“ˆ RISING':'âœ… LIVE'}</span>
          </div>
          <span class="trend-emoji">${t.emoji}</span>
          <div class="trend-title">${t.title}</div>
          <div class="trend-hook">"${t.hook}"</div>
          <div class="trend-stats">
            <div class="trend-stat">ðŸ‘ ${t.views}</div>
            <div class="trend-stat">ðŸ”¥ ${t.score}/100</div>
          </div>
          <div class="trend-bar"><div class="trend-bar-fill" style="width:${t.score}%"></div></div>
          <div style="font-size:11px;color:var(--text2);margin-bottom:12px;line-height:1.4">ðŸ“Œ ${t.why}</div>
          <div class="trend-actions">
            <button class="btn btn-primary btn-sm" style="flex:1" onclick="useForScript('${esc(t.title)}','${t.platform}','${t.category}')">âœï¸ Script</button>
            <button class="btn btn-secondary btn-sm" onclick="useForThumb('${esc(t.title)}')">ðŸŽ¨</button>
            <button class="btn btn-ghost btn-sm" onclick="saveFavourite('${esc(t.title)}','${t.emoji}','${t.category}')">â­</button>
          </div>
        </div>`; }).join('');
    } else {
      grid.innerHTML=`<div class="trend-empty"><span style="font-size:40px">âš ï¸</span><div style="font-size:14px;font-weight:700;margin:10px 0 4px">Failed to load trends</div><div style="font-size:12px;margin-bottom:16px">${friendlyErr(e)}</div><button class="btn btn-primary btn-sm" onclick="loadTrends()">Retry</button></div>`;
    }
  }
}
function useForScript(title,platform,niche){navTo('script');setTimeout(()=>{document.getElementById('scriptTopic').value=title;document.getElementById('scriptPlatform').value=platform;document.getElementById('scriptNiche').value=niche||'';},50);notify('Loaded into Script Generator','success','âœï¸');}
function useForThumb(title){navTo('thumbnail');setTimeout(()=>{document.getElementById('thumbTitle').value=title;},50);notify('Loaded into Thumbnail AI','success','ðŸŽ¨');}

async function analyzeCompetitor(){
  const name=document.getElementById('compInput')?.value?.trim();
  if(!name){notify('Enter a channel name','error','âš ï¸');return;}
  const r=document.getElementById('compResults');
  r.innerHTML=`<div style="display:flex;gap:14px;align-items:center;padding:40px;color:var(--muted)"><div class="spinner spinner-lg"></div><div>Analyzing ${name}...</div></div>`;
  try{
    const raw=await callClaude([{role:'user',content:`Analyze the YouTube/social creator "${name}". Return ONLY raw JSON with: channel (name), niche (string), topFormats (array of 4 strings), avgViews (string), postFreq (string), strengths (array of 3 strings), gaps (array of 3 opportunities you could exploit), hooks (array of 3 hook styles they use), contentPillars (array of 4 main topics), score (0-100 authority score).`}],
      'You are a social media strategist. Return ONLY valid raw JSON, no markdown.',1000);
    const d=JSON.parse(raw.replace(/```json|```/g,'').trim());
    r.innerHTML=`
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div class="card">
          <div style="display:flex;align-items:center;gap:14px;margin-bottom:18px">
            <div style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:800;color:#fff;flex-shrink:0">${name[0].toUpperCase()}</div>
            <div>
              <div style="font-family:var(--font-display);font-weight:800;font-size:18px">${d.channel||name}</div>
              <div style="font-size:12px;color:var(--muted)">${d.niche} Â· ${d.avgViews} avg views</div>
            </div>
            <div style="margin-left:auto;text-align:center">
              <div style="font-family:var(--font-display);font-size:32px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent">${d.score}</div>
              <div style="font-size:9px;color:var(--muted);font-weight:700;letter-spacing:1px">AUTHORITY</div>
            </div>
          </div>
          <div class="section-label" style="margin-bottom:10px">CONTENT PILLARS</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px">
            ${(d.contentPillars||[]).map(p=>`<span style="background:rgba(255,48,88,0.08);border:1px solid rgba(255,48,88,0.2);color:var(--accent);padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700">${p}</span>`).join('')}
          </div>
          <div class="section-label" style="margin-bottom:10px">HOOK STYLES</div>
          ${(d.hooks||[]).map(h=>`<div style="font-size:12px;color:var(--text2);padding:6px 0;border-bottom:1px solid var(--border)">ðŸª ${h}</div>`).join('')}
        </div>
        <div style="display:flex;flex-direction:column;gap:14px">
          <div class="card" style="border-color:rgba(0,229,176,0.25)">
            <div class="section-label" style="margin-bottom:10px;color:var(--teal)">THEIR STRENGTHS</div>
            ${(d.strengths||[]).map(s=>`<div style="display:flex;gap:8px;font-size:12px;color:var(--text2);margin-bottom:8px"><span style="color:var(--teal);flex-shrink:0">âœ“</span>${s}</div>`).join('')}
          </div>
          <div class="card" style="border-color:rgba(251,191,36,0.3)">
            <div class="section-label" style="margin-bottom:10px;color:var(--gold)">ðŸ’° GAPS YOU CAN EXPLOIT</div>
            ${(d.gaps||[]).map((g,i)=>`
              <div style="display:flex;gap:10px;margin-bottom:10px;align-items:flex-start">
                <span style="width:22px;height:22px;border-radius:50%;background:rgba(251,191,36,0.15);color:var(--gold);font-size:10px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-family:var(--font-display)">${i+1}</span>
                <div>
                  <div style="font-size:12px;color:var(--text);font-weight:600">${g}</div>
                  <button class="btn btn-ghost btn-sm" style="margin-top:5px;font-size:10px" onclick="useForScript('${esc(g)}','YouTube','')">â†’ Turn into script</button>
                </div>
              </div>`).join('')}
          </div>
        </div>
      </div>`;
  }catch(e){r.innerHTML=`<div style="text-align:center;padding:40px;color:var(--muted)">${friendlyErr(e)}<br><button class="btn btn-primary btn-sm" style="margin-top:12px" onclick="analyzeCompetitor()">Retry</button></div>`;}
}

async function findNicheIdeas(){
  const niche=document.getElementById('nicheInput')?.value?.trim();
  const platform=document.getElementById('nichePlatform')?.value||'YouTube';
  if(!niche){notify('Enter your niche','error','âš ï¸');return;}
  const r=document.getElementById('nicheResults');
  r.innerHTML=`<div style="display:flex;gap:14px;align-items:center;padding:40px;color:var(--muted)"><div class="spinner spinner-lg"></div><div>Finding untapped opportunities in ${niche}...</div></div>`;
  try{
    const raw=await callClaude([{role:'user',content:`Find 6 content gap opportunities for a ${niche} creator on ${platform}. For each gap return: title (the video/content concept), problem (what's missing currently), audience (who specifically wants this), difficulty ("Easy"|"Medium"|"Hard"), potential ("High"|"Very High"|"Explosive"), angle (unique take), hook (example hook line).`}],
      'You are a content strategist. Return ONLY a valid raw JSON array.',900);
    const ideas=JSON.parse(raw.replace(/```json|```/g,'').trim());
    r.innerHTML=`<div class="comp-grid">${ideas.map((idea,i)=>`
      <div class="card card-hover" style="animation:slideUp 0.4s ${i*0.06}s ease both">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <span class="badge badge-${idea.potential==='Explosive'?'hot':idea.potential==='Very High'?'rising':'live'}">${idea.potential==='Explosive'?'ðŸš€ Explosive':idea.potential==='Very High'?'ðŸ“ˆ Very High':'âœ… High'}</span>
          <span style="font-size:10px;color:var(--muted);background:var(--surface2);border:1px solid var(--border);padding:2px 8px;border-radius:6px">${idea.difficulty}</span>
        </div>
        <div style="font-size:14px;font-weight:700;margin-bottom:6px;line-height:1.4">${idea.title}</div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:10px;font-style:italic">"${idea.hook}"</div>
        <div style="font-size:11px;color:var(--text2);margin-bottom:12px;line-height:1.5">ðŸ‘¥ <strong style="color:var(--text)">${idea.audience}</strong></div>
        <div style="font-size:11px;color:var(--text2);margin-bottom:14px;line-height:1.5">ðŸ“Œ ${idea.problem}</div>
        <button class="btn btn-primary btn-sm" style="width:100%" onclick="useForScript('${esc(idea.title)}','${platform}','${esc(niche)}')">âœï¸ Write This Script</button>
      </div>`).join('')}</div>`;
  }catch(e){r.innerHTML=`<div style="text-align:center;padding:40px;color:var(--muted)">${friendlyErr(e)}<br><button class="btn btn-primary btn-sm" style="margin-top:12px" onclick="findNicheIdeas()">Retry</button></div>`;}
}

// ============================================================
// SCRIPT GENERATOR
// ============================================================
let savedScripts=JSON.parse(localStorage.getItem('tv_scripts')||'[]');
let lastScript=null;
function renderScript(){
  document.getElementById('pageContent').innerHTML=`
    <div class="script-layout">
      <div class="script-panel">
        <div class="section-label" style="margin-bottom:14px">CONFIGURE SCRIPT</div>
        <div class="form-field">
          <label>Topic / Trend</label>
          <input class="form-input" id="scriptTopic" placeholder="e.g. AI tools replacing jobs">
        </div>
        <div class="form-field">
          <label>Platform</label>
          <select class="form-input form-select" id="scriptPlatform">
            <option>YouTube</option><option>TikTok</option><option>Instagram Reels</option>
          </select>
        </div>
        <div class="form-field">
          <label>Tone</label>
          <select class="form-input form-select" id="scriptTone">
            <option>Energetic & Exciting</option><option>Educational & Calm</option>
            <option>Controversial & Bold</option><option>Funny & Relatable</option><option>Inspirational</option>
          </select>
        </div>
        <div class="form-field">
          <label>Niche</label>
          <input class="form-input" id="scriptNiche" placeholder="Tech, Finance, Fitness...">
        </div>
        <div class="form-field">
          <label>Length</label>
          <select class="form-input form-select" id="scriptLength">
            <option>Short (30-60s)</option><option>Medium (2-5 min)</option><option>Long (10+ min)</option>
          </select>
        </div>
        <div class="form-field" style="margin-bottom:16px">
          <label>Target Audience</label>
          <input class="form-input" id="scriptAudience" placeholder="e.g. entrepreneurs 25-40">
        </div>
        <button class="btn btn-primary" style="width:100%;margin-bottom:8px" id="scriptBtn" onclick="generateScript()">âš¡ Generate Script</button>
        <button class="btn btn-ghost btn-sm" style="width:100%" onclick="generateScript('hooks')">ðŸª Generate 5 Hook Ideas</button>
      </div>
      <div class="output-area" id="scriptOutput">
        <div class="output-empty">
          <div class="big-icon">âœï¸</div>
          <div style="font-weight:700;font-size:15px">Ready to write</div>
          <div style="font-size:12px;color:var(--text2)">Configure your script on the left and hit Generate</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px">
            <span class="chip">ðŸª Hook</span><span class="chip">ðŸ“ Intro</span><span class="chip">ðŸŽ¯ Main Content</span><span class="chip">ðŸ’¡ Key Takeaway</span><span class="chip">ðŸ“£ CTA</span>
          </div>
        </div>
      </div>
    </div>`;
}

async function generateScript(mode='full'){
  // Pay-per-script check for free users
  if(currentUser && (currentUser.plan === 'free') && mode === 'full') {
    var credits = getScriptCredits();
    if(credits <= 0) {
      // Record what they were trying to do before hitting the paywall
      var _scriptTopicAttempt = (document.getElementById('scriptTopic')||{}).value||'';
      if(_scriptTopicAttempt) window._lastAttemptedAction = 'Write a viral script about "' + _scriptTopicAttempt + '"';
      showPayPerScriptModal();
      return;
    }
    if(!deductScriptCredit()) {
      showPayPerScriptModal();
      return;
    }
    var remaining = getScriptCredits();
    if(remaining <= 1) notify(remaining + ' script credit' + (remaining===1?'':'s') + ' remaining', 'info', 'âœï¸');
  }
  const topic=(document.getElementById('scriptTopic')||{}).value?.trim();
  if(!topic){notify('Enter a topic first','error','âš ï¸');return;}
  const platform=document.getElementById('scriptPlatform').value;
  const tone=document.getElementById('scriptTone').value;
  const niche=document.getElementById('scriptNiche').value||'general';
  const length=document.getElementById('scriptLength').value;
  const audience=document.getElementById('scriptAudience').value||'general audience';
  const btn=document.getElementById('scriptBtn');
  btn.innerHTML='<div class="spinner spinner-sm"></div> Writing...'; btn.disabled=true;

  if(mode==='hooks'){
    document.getElementById('scriptOutput').innerHTML=`<div class="output-empty"><div class="spinner spinner-lg"></div><div style="font-size:13px;color:var(--muted)">Generating hook ideas...</div></div>`;
    try{
      const raw=await callClaude([{role:'user',content:`Write 5 scroll-stopping video hooks for a ${platform} video about: "${topic}" targeting ${audience}. Tone: ${tone}. Return ONLY JSON array: [{"hook":"...","type":"Question|Shock|Story|Controversy|Promise"}]`}],
        'Return ONLY valid JSON arrays, no markdown.',600);
      let hooks=[];
      try{hooks=JSON.parse(raw.replace(/```json|```/g,'').trim());}catch(_){}
      document.getElementById('scriptOutput').innerHTML=`
        <div class="output-toolbar">
          <div style="font-size:13px;font-weight:700">ðŸª Hook Ideas for: <span style="color:var(--accent)">${topic}</span></div>
          <button class="btn btn-primary btn-sm" onclick="generateScript()">Write Full Script â†’</button>
        </div>
        <div style="padding:20px;display:flex;flex-direction:column;gap:10px">
          ${hooks.map((h,i)=>`
            <div class="sug-card" onclick="document.getElementById('scriptTopic').value='${esc(h.hook)}';generateScript()">
              <div>
                <div style="font-size:11px;color:var(--muted);margin-bottom:3px">Hook ${i+1} Â· ${h.type}</div>
                <div style="font-size:13px;font-weight:600">"${h.hook}"</div>
              </div>
              <span style="color:var(--muted);flex-shrink:0">â†’</span>
            </div>`).join('')}
        </div>`;
    }catch(e){document.getElementById('scriptOutput').innerHTML=`<div class="output-empty"><div style="color:var(--accent)">âš ï¸ ${friendlyErr(e)}</div></div>`;}
    btn.innerHTML='âš¡ Generate Script'; btn.disabled=false;
    return;
  }

  document.getElementById('scriptOutput').innerHTML=`<div class="output-empty"><div class="spinner spinner-lg"></div><div style="font-size:14px;font-weight:600;margin-top:4px">Writing your script...</div><div style="font-size:12px;color:var(--muted)">Crafting hooks, structure & CTA</div></div>`;
  try{
    const [script, scoreRaw] = await Promise.all([
      callClaude([{role:'user',content:`Write a complete ${platform} video script about: "${topic}"\nTone: ${tone} | Niche: ${niche} | Length: ${length} | Target: ${audience}\n\nUse these exact section headers:\nðŸª HOOK\nðŸ“ INTRO\nðŸŽ¯ MAIN CONTENT\nðŸ’¡ KEY TAKEAWAY\nðŸ“£ CALL TO ACTION\n\nAdd [pause], [emphasis], [b-roll: description] directions where useful. Make it ready to film.`}],
        'You are a world-class viral video scriptwriter. Write platform-native, highly engaging, complete and filmable scripts.',1800),
      callClaude([{role:'user',content:`Rate this video concept for virality on ${platform}: "${topic}" targeting ${audience} with tone: ${tone}. Return ONLY JSON: {"score":85,"hookStrength":90,"shareability":80,"retention":85,"verdict":"one-line verdict"}`}],
        'Return ONLY valid raw JSON.',200)
    ]);
    lastScript={topic,platform,tone,niche,content:script,id:Date.now(),savedAt:Date.now()};
    const wordCount=script.split(/\s+/).length;
    const readTime=Math.round(wordCount/140);
    let vs={score:80,hookStrength:78,shareability:82,retention:75,verdict:'Good potential'};
    try{vs=JSON.parse(scoreRaw.replace(/```json|```/g,'').trim());}catch(_){}
    const fmt=script
      .replace(/ðŸª[^\n]*/g,'<div class="script-section-head">ðŸª HOOK</div>')
      .replace(/ðŸ“[^\n]*/g,'<div class="script-section-head">ðŸ“ INTRO</div>')
      .replace(/ðŸŽ¯[^\n]*/g,'<div class="script-section-head">ðŸŽ¯ MAIN CONTENT</div>')
      .replace(/ðŸ’¡[^\n]*/g,'<div class="script-section-head">ðŸ’¡ KEY TAKEAWAY</div>')
      .replace(/ðŸ“£[^\n]*/g,'<div class="script-section-head">ðŸ“£ CALL TO ACTION</div>')
      .replace(/\[([^\]]+)\]/g,'<span style="color:var(--purple);font-size:11px;font-style:italic">[$1]</span>');
    document.getElementById('scriptOutput').innerHTML=`
      <div class="output-toolbar">
        <div class="output-meta">
          <span>âœ… <strong style="color:var(--teal)">Script Ready</strong></span>
          <span>ðŸ“ ${wordCount} words</span>
          <span>â± ~${readTime} min</span>
          <span style="color:var(--muted)">${platform} Â· ${niche}</span>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-teal btn-sm" onclick="doSaveScript()">ðŸ’¾ Save</button>
          <button class="btn btn-secondary btn-sm" onclick="copyScript()">ðŸ“‹ Copy</button>
          <button class="btn btn-ghost btn-sm" onclick="useForThumb('${esc(topic)}')">ðŸŽ¨ Thumbnail</button>
          <button class="btn btn-ghost btn-sm" onclick="shareWin('script','${esc(topic)}',${vs.score})" style="border-color:rgba(29,161,242,0.4);color:#1da1f2">ð• Share</button>
          ${(currentUser&&currentUser.plan==='elite') ? '<button class="btn btn-sm" style="background:linear-gradient(135deg,rgba(192,132,252,0.2),rgba(124,58,237,0.15));border:1px solid rgba(192,132,252,0.5);color:var(--elite)" onclick="showAutoUploadModal()">ðŸ“¤ Auto-Upload</button>' : ''}
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0;border-bottom:1px solid var(--border)">
        ${[['ðŸ”¥ Virality',vs.score],['ðŸª Hook',vs.hookStrength],['ðŸ” Share',vs.shareability],['ðŸ‘ Retention',vs.retention]].map(([label,val])=>`
          <div style="padding:14px 16px;border-right:1px solid var(--border);last-child:border:none">
            <div style="font-size:9px;color:var(--muted);font-weight:800;letter-spacing:1px;margin-bottom:4px;font-family:var(--font-display)">${label}</div>
            <div style="font-family:var(--font-display);font-size:22px;font-weight:800;color:${val>=85?'var(--teal)':val>=70?'var(--gold)':'var(--text)'}">${val}</div>
            <div style="height:2px;background:var(--border);border-radius:1px;margin-top:5px"><div style="width:${val}%;height:100%;border-radius:1px;background:${val>=85?'var(--teal)':val>=70?'var(--gold)':'var(--muted)'};transition:width 1s ease"></div></div>
          </div>`).join('')}
      </div>
      <div style="padding:10px 16px;background:rgba(0,229,176,0.04);border-bottom:1px solid var(--border);font-size:11px;color:var(--teal);font-weight:700">ðŸ’¡ ${vs.verdict}</div>
      <div class="output-box" id="scriptContent">${fmt}</div>`;
  }catch(e){
    document.getElementById('scriptOutput').innerHTML=`<div class="output-empty"><div style="font-size:32px">âš ï¸</div><div style="color:var(--accent);font-weight:700">${friendlyErr(e)}</div><button class="btn btn-primary btn-sm" style="margin-top:14px" onclick="generateScript()">Retry</button></div>`;
  }
  btn.innerHTML='âš¡ Generate Script'; btn.disabled=false;
}
function copyScript(){const el=document.getElementById('scriptContent');if(!el)return;safeCopy(el.innerText,'Script copied!','ðŸ“‹');}

// â”€â”€ AUTO-UPLOAD DAILY LIMIT HELPERS â”€â”€
function getUploadState() {
  var state = {}; try { state = JSON.parse(localStorage.getItem('tv_upload_state') || '{}'); } catch(e) {}
  var today = new Date().toISOString().slice(0,10);
  var now = Date.now();
  var oneYear = 365 * 24 * 60 * 60 * 1000;
  // Reset daily used counter if it's a new day (but keep extra credits)
  if(state.date !== today) { state.date = today; state.used = 0; }
  // Expire extra credits older than 1 year
  if(state.creditBatches && state.creditBatches.length) {
    state.creditBatches = state.creditBatches.filter(function(b){ return (now - b.purchasedAt) < oneYear; });
    state.extraCredits = state.creditBatches.reduce(function(sum,b){ return sum + b.remaining; }, 0);
  } else {
    // Migrate old flat extraCredits into a batch (assume purchased now, expires 1yr from now)
    if(state.extraCredits && state.extraCredits > 0) {
      state.creditBatches = [{remaining: state.extraCredits, purchasedAt: now, qty: state.extraCredits}];
    } else {
      state.creditBatches = [];
      state.extraCredits = 0;
    }
  }
  return state;
}
function saveUploadState(state) {
  try { localStorage.setItem('tv_upload_state', JSON.stringify(state)); } catch(e) {}
}
function getUploadDailyLimit() {
  var auCfg = {}; try { auCfg = JSON.parse(localStorage.getItem('tv_autoupload_cfg') || '{}'); } catch(e) {}
  return parseInt(auCfg.dailyLimit) || 2;
}
function getUploadsRemaining() {
  var state = getUploadState();
  var limit = getUploadDailyLimit();
  var freeLeft = Math.max(0, limit - state.used);
  return { freeLeft: freeLeft, extraCredits: state.extraCredits || 0, used: state.used, limit: limit };
}

function showAutoUploadModal() {
  var existing = document.getElementById('_autoUploadModal');
  if(existing) existing.remove();
  var auCfg = {}; try { auCfg = JSON.parse(localStorage.getItem('tv_autoupload_cfg') || '{}'); } catch(e) {}
  var rem = getUploadsRemaining();
  var totalLeft = rem.freeLeft + rem.extraCredits;
  var ytConnected = auCfg.youtube && auCfg.youtube.connected;

  var statusBar =
    '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:12px 16px;margin-bottom:16px">' +
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">' +
        '<span style="font-size:12px;font-weight:700">Daily Uploads</span>' +
        '<span style="font-size:12px;color:' + (totalLeft>0?'var(--teal)':'var(--accent)') + ';font-weight:800">' +
          (totalLeft > 0 ? totalLeft + ' remaining' : '0 remaining') +
        '</span>' +
      '</div>' +
      '<div style="height:6px;background:var(--border);border-radius:3px;overflow:hidden;margin-bottom:8px">' +
        '<div style="height:100%;width:' + Math.min(100, Math.round((rem.used/Math.max(rem.limit+rem.extraCredits,1))*100)) + '%;background:linear-gradient(90deg,var(--teal),var(--accent));border-radius:3px"></div>' +
      '</div>' +
      '<div style="font-size:10px;color:var(--muted)">' + rem.used + ' used today \xb7 ' + rem.freeLeft + ' free \xb7 ' + rem.extraCredits + ' extra</div>' +
    '</div>';

  var ytSection = ytConnected
    ? '<button class="btn btn-ghost" style="display:flex;align-items:center;gap:10px;width:100%;padding:12px 16px;border-radius:12px;margin-bottom:8px;text-align:left;font-size:13px;font-weight:700" onclick="ytUploadFromScript()">' +
        '<span style="font-size:22px">\u25b6\ufe0f</span>' +
        '<div><div>YouTube</div><div style="font-size:10px;color:var(--teal);font-weight:600">\u2705 Connected \u2014 tap to upload</div></div>' +
        '<span style="margin-left:auto;font-size:11px;color:var(--muted)">Upload \u2192</span>' +
      '</button>'
    : '<div style="background:rgba(255,48,88,0.06);border:1px solid rgba(255,48,88,0.2);border-radius:12px;padding:16px;margin-bottom:12px;text-align:center">' +
        '<div style="font-size:22px;margin-bottom:6px">\u25b6\ufe0f</div>' +
        '<div style="font-size:13px;font-weight:700;margin-bottom:4px">Connect YouTube</div>' +
        '<div style="font-size:12px;color:var(--muted);margin-bottom:12px">Sign in with Google to upload directly to your channel</div>' +
        '<button class="btn btn-primary" style="width:100%" onclick="connectYouTube()">Sign in with Google</button>' +
      '</div>';

  var topupSection = '';
  if(totalLeft <= 0) {
    topupSection =
      '<div style="background:rgba(255,48,88,0.06);border:1px solid rgba(255,48,88,0.2);border-radius:12px;padding:14px;margin-bottom:12px;text-align:center">' +
        '<div style="font-size:13px;font-weight:700;margin-bottom:8px">\u26a1 Out of uploads today</div>' +
        '<div style="font-size:12px;color:var(--muted);margin-bottom:12px">Top up with extra credits \u2014 they never expire.</div>' +
        '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px">' +
          '<button class="btn btn-sm btn-ghost" style="border-color:rgba(255,48,88,0.3)" onclick="buyUploadCredits(5)"><div style="font-weight:900">5</div><div style="font-size:9px;color:var(--muted)">\xa32.49</div></button>' +
          '<button class="btn btn-sm btn-primary" onclick="buyUploadCredits(15)"><div style="font-weight:900">15</div><div style="font-size:9px">\xa35.99</div></button>' +
          '<button class="btn btn-sm btn-ghost" style="border-color:rgba(192,132,252,0.4);color:var(--elite)" onclick="buyUploadCredits(50)"><div style="font-weight:900">50</div><div style="font-size:9px;color:var(--muted)">\xa314.99</div></button>' +
          '<button class="btn btn-sm btn-ghost" style="border-color:rgba(251,191,36,0.4);color:var(--gold)" onclick="buyUploadCredits(100)"><div style="font-weight:900">100</div><div style="font-size:9px;color:var(--muted)">\xa324.99</div></button>' +
          '<button class="btn btn-sm btn-ghost" style="border-color:rgba(0,229,176,0.4);color:var(--teal)" onclick="buyUploadCredits(500)"><div style="font-weight:900">500</div><div style="font-size:9px;color:var(--muted)">\xa399.99</div></button>' +
        '</div>' +
      '</div>';
  }

  var modal = document.createElement('div');
  modal.id = '_autoUploadModal';
  modal.className = 'modal-overlay show';
  modal.innerHTML =
    '<div class="modal-box" style="max-width:440px">' +
      '<div style="font-size:28px;margin-bottom:8px">\ud83d\udce4</div>' +
      '<div class="modal-title">Auto-Upload</div>' +
      '<div class="modal-sub" style="margin-bottom:16px">Upload your script &amp; thumbnail directly to YouTube.</div>' +
      statusBar +
      topupSection +
      ytSection +
      (ytConnected
        ? '<div style="margin-top:4px;padding:10px 12px;background:rgba(0,229,176,0.06);border:1px solid rgba(0,229,176,0.2);border-radius:10px;font-size:11px;color:var(--muted)">Your script title becomes the video title. Script body becomes the description. Upload is set to <strong>Private</strong> by default \u2014 you can publish from YouTube Studio.</div>'
        : '') +
      '<div style="margin-top:12px">' +
        '<button class="btn btn-ghost" style="width:100%" onclick="closeAutoUploadModal()">Cancel</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(modal);
}

function closeAutoUploadModal() {
  var m = document.getElementById('_autoUploadModal');
  if(m) m.remove();
}


function buyUploadCredits(qty, priceLabel) {
  var _prices = {5:'Â£2.49',15:'Â£5.99',50:'Â£14.99',100:'Â£24.99',500:'Â£99.99'};
  if(!priceLabel) priceLabel = _prices[qty] || (qty + " credits");
  var stripeCfg = {}; try { stripeCfg = JSON.parse(localStorage.getItem('tv_stripe_cfg') || '{}'); } catch(e) {}
  var linkMap = {5: stripeCfg.uploadCreditLink5, 15: stripeCfg.uploadCreditLink15, 50: stripeCfg.uploadCreditLink50, 100: stripeCfg.uploadCreditLink100, 500: stripeCfg.uploadCreditLink500};
  var link = linkMap[qty];
  if(link && link.startsWith('http')) {
    var email = encodeURIComponent((currentUser && currentUser.email) || '');
    var finalLink = link + (link.includes('?') ? '&' : '?') + 'prefilled_email=' + email;
    // Log sale notification
    try {
      var notifs = JSON.parse(localStorage.getItem('tv_admin_notifs') || '[]');
      notifs.unshift({type:'upload_credit_sale', icon:'ðŸ“¤', title:'Upload Credits Purchased', body:(currentUser&&currentUser.email||'user')+' bought '+qty+' upload credits ('+priceLabel+')', at:Date.now(), read:false});
      localStorage.setItem('tv_admin_notifs', JSON.stringify(notifs.slice(0,100)));
      var log = []; try { log = JSON.parse(localStorage.getItem('tv_activity_log') || '[]'); } catch(e2) {}
      log.unshift({icon:'ðŸ“¤', user:(currentUser&&currentUser.email)||'elite', action:'Purchased '+qty+' upload credits ('+priceLabel+')', type:'sale', at:Date.now()});
      localStorage.setItem('tv_activity_log', JSON.stringify(log.slice(0,500)));
    } catch(e) {}
    window.open(finalLink, '_blank');
    notify('Opening checkout for ' + qty + ' upload creditsâ€¦', 'success', 'ðŸ“¤');
    return;
  }
  // Demo mode â€” add credits directly
  var state = getUploadState();
  if(!state.creditBatches) state.creditBatches = [];
  // Add new batch with 1-year expiry
  var batch = {remaining: qty, qty: qty, purchasedAt: Date.now()};
  state.creditBatches.push(batch);
  state.extraCredits = state.creditBatches.reduce(function(sum,b){ return sum + b.remaining; }, 0);
  saveUploadState(state);
  document.getElementById('_autoUploadModal').remove();
  notify('âœ… ' + qty + ' upload credits added! (' + priceLabel + ')', 'success', 'ðŸ“¤');
  // Log sale notification
  try {
    var notifs = JSON.parse(localStorage.getItem('tv_admin_notifs') || '[]');
    notifs.unshift({type:'upload_credit_sale', icon:'ðŸ“¤', title:'Upload Credits Purchased', body:(currentUser&&currentUser.email||'user')+' bought '+qty+' upload credits ('+priceLabel+')', at:Date.now(), read:false});
    localStorage.setItem('tv_admin_notifs', JSON.stringify(notifs.slice(0,100)));
  } catch(e) {}
}

function doAutoUpload(platformId, platformLabel) {
  if(platformId === 'youtube') { ytUploadFromScript(); return; }
  closeAutoUploadModal();
  notify('Platform upload coming soon', 'info', 'â³');
}


function doSaveScript(){if(!lastScript){notify('Generate a script first','error','âš ï¸');return;}savedScripts.unshift(lastScript);localStorage.setItem('tv_scripts',JSON.stringify(savedScripts.slice(0,50)));updateBadges();notify('Saved to library!','success','ðŸ’¾');awardXP('wrote_script');if(savedScripts.length>=10)awardXP('scripts_10');if(savedScripts.length>=50)awardXP('scripts_50');}

// ============================================================
// THUMBNAIL AI
// ============================================================
let thumbColor='#ff3c5c';
function renderThumbnail(){
  document.getElementById('pageContent').innerHTML=`
    <div class="thumb-layout">
      <div>
        <div class="card" style="margin-bottom:12px">
          <div class="section-label" style="margin-bottom:14px">CONTENT</div>
          <div class="form-field">
            <label>Video Title</label>
            <input class="form-input" id="thumbTitle" placeholder="e.g. I Tested 10 AI Tools So You Don't Have To">
          </div>
          <div class="form-field">
            <label>Badge Text (optional)</label>
            <input class="form-input" id="thumbSubtitle" placeholder="e.g. #5 Shocked Me">
          </div>
          <div class="form-field">
            <label>Style</label>
            <select class="form-input form-select" id="thumbStyle">
              <option value="bold">Bold & High Contrast</option>
              <option value="gradient">Vibrant Gradient</option>
              <option value="dark">Dark & Dramatic</option>
              <option value="neon">Neon Glow</option>
              <option value="minimal">Clean & Minimal</option>
            </select>
          </div>
          <div class="form-field" style="margin-bottom:0">
            <label>Accent Color</label>
            <div class="color-row" id="colorPicker">
              ${[['#ff3c5c',true],['#ff8a00',false],['#f5c842',false],['#00d4aa',false],['#3b82f6',false],['#8b5cf6',false],['#111827',false],['#f8f8f8',false]].map(([c,s])=>`<div class="color-swatch${s?' sel':''}" style="background:${c}${c==='#f8f8f8'?';border:1px solid var(--border2)':''}" data-c="${c}" onclick="pickColor(this)"></div>`).join('')}
            </div>
          </div>
        </div>
        <button class="btn btn-primary btn-lg" style="width:100%;margin-bottom:8px" id="thumbBtn" onclick="generateThumbnail()">ðŸŽ¨ Generate Thumbnail</button>
        <button class="btn btn-secondary" style="width:100%" onclick="downloadThumb()">â¬‡ï¸ Download PNG</button>
      </div>
      <div>
        <div class="card" style="margin-bottom:12px">
          <div class="section-label" style="margin-bottom:10px">PREVIEW Â· 1280Ã—720</div>
          <div class="thumb-canvas-wrap" id="thumbWrap">
            <div class="thumb-empty" id="thumbEmpty"><div style="font-size:44px;margin-bottom:8px">ðŸ–¼ï¸</div><div>Your thumbnail appears here</div></div>
            <canvas id="thumbCanvas" width="1280" height="720" style="display:none"></canvas>
          </div>
          <div style="font-size:11px;color:var(--muted);text-align:center">YouTube optimised Â· 16:9 ratio</div>
        </div>
        <div class="card hidden" id="thumbSugCard">
          <div class="section-label" style="margin-bottom:10px">âœ¨ AI TITLE VARIATIONS</div>
          <div id="thumbSugs"></div>
        </div>
      </div>
    </div>`;
}
function pickColor(el){document.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('sel'));el.classList.add('sel');thumbColor=el.dataset.c;}
async function generateThumbnail(){
  const title=(document.getElementById('thumbTitle')||{}).value?.trim();
  if(!title){notify('Enter a title first','error','âš ï¸');return;}
  const sub=document.getElementById('thumbSubtitle').value.trim();
  const style=document.getElementById('thumbStyle').value;
  const btn=document.getElementById('thumbBtn');
  btn.innerHTML='<div class="spinner spinner-sm"></div> Generating...'; btn.disabled=true;
  drawCanvas(title,sub,style,thumbColor);
  try{
    const raw=await callClaude([{role:'user',content:`Give 4 alternative YouTube thumbnail title variations for: "${title}". Return ONLY JSON array: [{"title":"...","tip":"one-word tip e.g. SHORT BOLD NUMBERS EMOTION"}]`}],
      'Return ONLY valid JSON arrays, no markdown.',500);
    let sugs=[];
    try{sugs=JSON.parse(raw.replace(/```json|```/g,'').trim());}catch(_){}
    if(sugs.length){
      document.getElementById('thumbSugCard').classList.remove('hidden');
      document.getElementById('thumbSugs').innerHTML=sugs.map(s=>`
        <div class="sug-card" onclick="applyThumbTitle('${esc(s.title)}')">
          <div style="font-size:13px;font-weight:600">${s.title}</div>
          <span class="sug-tip">${s.tip}</span>
        </div>`).join('');
    }
    notify('Thumbnail generated!','success','ðŸŽ¨');awardXP('made_thumb');
  }catch(_){notify('Generated! (AI tips unavailable)','info','ðŸŽ¨');}
  btn.innerHTML='ðŸŽ¨ Generate Thumbnail'; btn.disabled=false;
}
function applyThumbTitle(t){document.getElementById('thumbTitle').value=t;generateThumbnail();}
function drawCanvas(title,sub,style,color){
  const canvas=document.getElementById('thumbCanvas');
  const empty=document.getElementById('thumbEmpty');
  const ctx=canvas.getContext('2d');
  const W=1280,H=720;
  canvas.width=W;canvas.height=H;
  canvas.style.display='block';
  if(empty)empty.style.display='none';
  if(style==='gradient'){const g=ctx.createLinearGradient(0,0,W,H);g.addColorStop(0,color);g.addColorStop(1,tweakColor(color,55));ctx.fillStyle=g;}
  else if(style==='dark'){const g=ctx.createRadialGradient(W/2,H/2,0,W/2,H/2,W*0.8);g.addColorStop(0,'#1a1e2e');g.addColorStop(1,'#000');ctx.fillStyle=g;}
  else if(style==='neon'){ctx.fillStyle='#03030d';}
  else if(style==='minimal'){ctx.fillStyle=isLight(color)?'#f9faff':color;}
  else{ctx.fillStyle=color;}
  ctx.fillRect(0,0,W,H);
  if(style==='bold'||style==='gradient'){ctx.save();ctx.globalAlpha=0.09;ctx.fillStyle=isLight(color)?'#000':'#fff';ctx.beginPath();ctx.arc(W-150,H/2,310,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(90,H-80,200,0,Math.PI*2);ctx.fill();ctx.restore();}
  if(style==='neon'){ctx.save();ctx.globalAlpha=0.1;for(let y=60;y<H;y+=60){const ng=ctx.createLinearGradient(0,0,W,0);ng.addColorStop(0,'transparent');ng.addColorStop(0.5,color);ng.addColorStop(1,'transparent');ctx.strokeStyle=ng;ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}ctx.restore();}
  if(style!=='minimal'){ctx.fillStyle=style==='neon'?color:(isLight(color)?'rgba(0,0,0,0.15)':'rgba(255,255,255,0.12)');ctx.fillRect(0,0,8,H);}
  const tc=style==='neon'?color:style==='dark'?'#fff':(isLight(color)?'#111':'#fff');
  const fs=title.length>35?68:title.length>20?82:96;
  ctx.font=`900 ${fs}px Impact,"Bebas Neue","Arial Black",sans-serif`;
  ctx.shadowColor=isLight(color)?'rgba(255,255,255,0.4)':'rgba(0,0,0,0.85)';
  ctx.shadowBlur=style==='neon'?32:12;ctx.shadowOffsetX=3;ctx.shadowOffsetY=3;
  ctx.fillStyle=tc;ctx.textAlign='left';
  const lines=wrapTxt(ctx,title.toUpperCase(),W-160,fs);
  const lh=fs*1.12;
  let sy=(H-lines.length*lh)/2-(sub?28:0)+fs;
  lines.forEach((l,i)=>ctx.fillText(l,80,sy+i*lh));
  if(sub){
    ctx.shadowBlur=0;ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;
    ctx.font=`bold 50px Impact,"Arial Black",sans-serif`;
    const sw=ctx.measureText(sub.toUpperCase()).width;
    const subY=sy+lines.length*lh+16;
    ctx.fillStyle=style==='neon'?color:'#fff';ctx.globalAlpha=style==='neon'?0.9:0.18;
    roundRect(ctx,72,subY-46,sw+36,62,10);ctx.fill();
    ctx.globalAlpha=1;ctx.fillStyle=tc;
    ctx.fillText(sub.toUpperCase(),90,subY);
  }
  ctx.shadowBlur=0;ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;
  ctx.globalAlpha=0.25;ctx.font='bold 22px "DM Sans",Arial,sans-serif';
  ctx.textAlign='right';ctx.fillStyle=isLight(color)?'#000':'#fff';
  ctx.fillText('TRENDVID AI',W-28,H-24);ctx.globalAlpha=1;
}
function wrapTxt(ctx,text,maxW,fs){
  ctx.font=`900 ${fs}px Impact,"Bebas Neue","Arial Black",sans-serif`;
  const words=text.split(' ');const lines=[];let cur='';
  for(const w of words){const t=cur?cur+' '+w:w;if(ctx.measureText(t).width>maxW&&cur){lines.push(cur);cur=w;}else cur=t;}
  if(cur)lines.push(cur);return lines;
}
function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();}
function isLight(hex){if(!hex||hex.length<7)return false;const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return(r*299+g*587+b*114)/1000>140;}
function tweakColor(hex,a){let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);r=Math.min(255,Math.max(0,r+a));g=Math.min(255,Math.max(0,g+Math.floor(a*0.6)));b=Math.min(255,Math.max(0,b+Math.floor(a*1.4)));return'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');}
function downloadThumb(){const c=document.getElementById('thumbCanvas');if(!c||c.style.display==='none'){notify('Generate a thumbnail first','error','âš ï¸');return;}const a=document.createElement('a');a.download='trendvid-thumbnail.png';a.href=c.toDataURL('image/png');a.click();notify('Downloaded!','success','â¬‡ï¸');awardXP('made_thumb');}

// ============================================================
// LIBRARY
// ============================================================
function renderLibrary(){
  savedScripts=JSON.parse(localStorage.getItem('tv_scripts')||'[]');
  const html=savedScripts.length?`<div class="lib-grid">${savedScripts.map((s,i)=>`
    <div class="lib-card">
      <div class="lib-platform ${s.platform==='YouTube'?'yt':s.platform==='TikTok'?'tt':'ig'}">${s.platform==='YouTube'?'â–¶':s.platform==='TikTok'?'â™ª':'â—ˆ'} ${s.platform}</div>
      <div style="font-size:14px;font-weight:700;margin-bottom:4px;line-height:1.35">${s.topic}</div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:10px">${s.tone} Â· ${timeAgo(s.savedAt)}</div>
      <div style="font-size:12px;color:var(--text2);line-height:1.6;overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;margin-bottom:14px">${s.content.substring(0,220)}â€¦</div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="viewSavedScript(${i})">ðŸ‘ View</button>
        <button class="btn btn-ghost btn-sm" onclick="deleteScript(${i})">ðŸ—‘ï¸</button>
      </div>
    </div>`).join('')}</div>`
  :`<div style="text-align:center;padding:80px 0;color:var(--muted)"><div style="font-size:52px;margin-bottom:16px">ðŸ“š</div><div style="font-size:15px;font-weight:700">No saved scripts yet</div><div style="font-size:13px;margin-top:6px;margin-bottom:20px">Generate scripts and click Save to store them here</div><button class="btn btn-primary" onclick="navTo('script')">âœï¸ Write a Script</button></div>`;
  document.getElementById('pageContent').innerHTML=`
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px">
      <div><div class="section-label" style="margin-bottom:2px">SAVED SCRIPTS</div><div class="page-title">Script Library</div></div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary btn-sm" onclick="navTo('script')">+ New Script</button>
        ${savedScripts.length?`<button class="btn btn-ghost btn-sm" onclick="clearLib()">ðŸ—‘ï¸ Clear All</button>`:''}
      </div>
    </div>${html}`;
}
function viewSavedScript(i){const s=savedScripts[i];navTo('script');setTimeout(()=>{document.getElementById('scriptTopic').value=s.topic;document.getElementById('scriptOutput').innerHTML=`<div class="output-toolbar"><div class="output-meta"><span>ðŸ“š From Library</span><span style="color:var(--muted)">${s.platform} Â· ${s.tone}</span></div><div style="display:flex;gap:6px"><button class="btn btn-secondary btn-sm" onclick="copyScript()">ðŸ“‹ Copy</button></div></div><div class="output-box" id="scriptContent">${s.content}</div>`;},50);}
function deleteScript(i){savedScripts.splice(i,1);localStorage.setItem('tv_scripts',JSON.stringify(savedScripts));updateBadges();renderLibrary();notify('Deleted','info','ðŸ—‘ï¸');}
function clearLib(){if(!confirm('Clear all saved scripts?'))return;savedScripts=[];localStorage.removeItem('tv_scripts');updateBadges();renderLibrary();}

// ============================================================
// CALENDAR
// ============================================================
let calData=JSON.parse(localStorage.getItem('tv_calendar')||'{}');
let calYear=new Date().getFullYear(), calMonth=new Date().getMonth();
function renderCalendar(){
  const now=new Date();
  const monthName=new Date(calYear,calMonth,1).toLocaleString('default',{month:'long'});
  const firstDay=new Date(calYear,calMonth,1).getDay();
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  let cells='';
  for(let i=0;i<firstDay;i++)cells+=`<div></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const key=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const idea=calData[key]||'';
    const isToday=d===now.getDate()&&calMonth===now.getMonth()&&calYear===now.getFullYear();
    cells+=`<div class="cal-cell${isToday?' today':''}${idea?' has-content':''}" onclick="editCalDay('${key}','${esc(idea)}')">
      <div class="cal-date">${d}</div>
      ${idea?`<div class="cal-idea">${idea}</div><div class="cal-dot"></div>`:''}
    </div>`;
  }
  const planned=Object.values(calData).filter(v=>v).length;
  document.getElementById('pageContent').innerHTML=`
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px">
      <div>
        <div class="section-label" style="margin-bottom:2px">CONTENT PLANNING</div>
        <div style="display:flex;align-items:center;gap:14px">
          <div class="cal-nav">
            <button class="cal-nav-btn" onclick="shiftCal(-1)">â€¹</button>
            <div class="page-title">${monthName} ${calYear}</div>
            <button class="cal-nav-btn" onclick="shiftCal(1)">â€º</button>
          </div>
          <div style="font-size:12px;color:var(--teal);font-weight:600">${planned} ideas planned</div>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary btn-sm" id="calGenBtn" onclick="generateCalendar()">âš¡ AI Fill Month</button>
        <button class="btn btn-ghost btn-sm" onclick="clearCalendar()">ðŸ—‘ï¸ Clear</button>
      </div>
    </div>
    <div class="card-sm">
      <div class="cal-header">${dayNames.map(d=>`<div class="cal-day-name">${d}</div>`).join('')}</div>
      <div class="cal-grid" id="calGrid">${cells}</div>
    </div>`;
}
function shiftCal(dir){calMonth+=dir;if(calMonth>11){calMonth=0;calYear++;}if(calMonth<0){calMonth=11;calYear--;}renderCalendar();}
function editCalDay(key,idea){const val=prompt('Content idea for this day:',idea)||'';calData[key]=val;localStorage.setItem('tv_calendar',JSON.stringify(calData));renderCalendar();}
async function generateCalendar(){
  const btn=document.getElementById('calGenBtn');
  const niche=prompt('What niche/topic?','General')||'General';
  btn.innerHTML='<div class="spinner spinner-sm"></div> Filling...'; btn.disabled=true;
  try{
    const raw=await callClaude([{role:'user',content:`Create a 30-day content calendar for a ${niche} creator for ${new Date(calYear,calMonth,1).toLocaleString('default',{month:'long'})} ${calYear}. Return ONLY a JSON object with keys 1-30 and short video idea values (max 55 chars each). Example: {"1":"idea","2":"idea",...}`}],
      'Return ONLY valid JSON objects, no markdown.',1400);
    const plan=JSON.parse(raw.replace(/```json|```/g,'').trim());
    Object.entries(plan).forEach(([day,idea])=>{
      const key=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(parseInt(day)).padStart(2,'0')}`;
      calData[key]=idea;
    });
    localStorage.setItem('tv_calendar',JSON.stringify(calData));
    renderCalendar();notify('30-day calendar filled!','success','ðŸ“…');awardXP('filled_cal');
  }catch(e){notify(friendlyErr(e),'error','âš ï¸');}
  btn.innerHTML='âš¡ AI Fill Month'; btn.disabled=false;
}
function clearCalendar(){if(!confirm('Clear calendar?'))return;calData={};localStorage.removeItem('tv_calendar');renderCalendar();}

// ============================================================
// FAVOURITES
// ============================================================
let favs=JSON.parse(localStorage.getItem('tv_favs')||'[]');
function saveFavourite(title,emoji,cat){
  if(favs.find(f=>f.title===title)){notify('Already saved!','info','â­');return;}
  favs.unshift({title,emoji,category:cat,savedAt:Date.now()});
  localStorage.setItem('tv_favs',JSON.stringify(favs.slice(0,50)));
  updateBadges();notify('Saved to favourites!','success','â­');
}
function renderFavourites(){
  favs=JSON.parse(localStorage.getItem('tv_favs')||'[]');
  const html=favs.length?`<div class="fav-grid">${favs.map((f,i)=>`
    <div class="fav-card">
      <button class="fav-remove" onclick="removeFav(${i})" title="Remove">âœ•</button>
      <div style="font-size:32px;margin-bottom:8px">${f.emoji}</div>
      <div style="font-weight:700;font-size:13px;line-height:1.4;margin-bottom:4px">${f.title}</div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:12px">${f.category} Â· ${timeAgo(f.savedAt)}</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-primary btn-sm" style="flex:1" onclick="useForScript('${esc(f.title)}','YouTube','${f.category}')">âœï¸ Script</button>
        <button class="btn btn-ghost btn-sm" onclick="useForThumb('${esc(f.title)}')">ðŸŽ¨</button>
      </div>
    </div>`).join('')}</div>`
  :`<div style="text-align:center;padding:80px;color:var(--muted)"><div style="font-size:52px;margin-bottom:16px">â­</div><div style="font-size:15px;font-weight:700">No favourites yet</div><div style="font-size:13px;margin-top:6px;margin-bottom:20px">Star any trend to save it here</div><button class="btn btn-primary" onclick="navTo('trends')">ðŸ“ˆ Browse Trends</button></div>`;
  document.getElementById('pageContent').innerHTML=`
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px">
      <div><div class="section-label" style="margin-bottom:2px">BOOKMARKED</div><div class="page-title">Favourites</div></div>
      ${favs.length?`<button class="btn btn-ghost btn-sm" onclick="if(confirm('Clear all?')){favs=[];localStorage.removeItem('tv_favs');updateBadges();renderFavourites();}">ðŸ—‘ï¸ Clear All</button>`:''}
    </div>${html}`;
}
function removeFav(i){favs.splice(i,1);localStorage.setItem('tv_favs',JSON.stringify(favs));updateBadges();renderFavourites();}

// ============================================================
// MULTI-LANGUAGE
// ============================================================
const LANGS=[{flag:'ðŸ‡¬ðŸ‡§',name:'English'},{flag:'ðŸ‡ªðŸ‡¸',name:'Spanish'},{flag:'ðŸ‡«ðŸ‡·',name:'French'},{flag:'ðŸ‡©ðŸ‡ª',name:'German'},{flag:'ðŸ‡®ðŸ‡¹',name:'Italian'},{flag:'ðŸ‡µðŸ‡¹',name:'Portuguese'},{flag:'ðŸ‡¸ðŸ‡¦',name:'Arabic'},{flag:'ðŸ‡·ðŸ‡º',name:'Russian'},{flag:'ðŸ‡¨ðŸ‡³',name:'Chinese'},{flag:'ðŸ‡¯ðŸ‡µ',name:'Japanese'},{flag:'ðŸ‡°ðŸ‡·',name:'Korean'},{flag:'ðŸ‡®ðŸ‡³',name:'Hindi'},{flag:'ðŸ‡³ðŸ‡±',name:'Dutch'},{flag:'ðŸ‡µðŸ‡±',name:'Polish'},{flag:'ðŸ‡¹ðŸ‡·',name:'Turkish'},{flag:'ðŸ‡¸ðŸ‡ª',name:'Swedish'},{flag:'ðŸ‡³ðŸ‡´',name:'Norwegian'},{flag:'ðŸ‡©ðŸ‡°',name:'Danish'},{flag:'ðŸ‡«ðŸ‡®',name:'Finnish'},{flag:'ðŸ‡¬ðŸ‡·',name:'Greek'}];
let selectedLang='Spanish';
function renderMultiLang(){
  document.getElementById('pageContent').innerHTML=`
    <div class="section-label" style="margin-bottom:16px">TRANSLATE YOUR SCRIPT</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div class="card">
        <div class="section-label" style="margin-bottom:12px">SELECT LANGUAGE</div>
        <div class="lang-grid" id="langGrid">${LANGS.map(l=>`<div class="lang-card${l.name===selectedLang?' sel':''}" onclick="selectLang('${l.name}',this)"><div class="lang-flag">${l.flag}</div><div class="lang-name">${l.name}</div></div>`).join('')}</div>
      </div>
      <div class="card" style="display:flex;flex-direction:column;gap:12px">
        <div class="form-field"><label>Source Script</label><textarea class="form-input" id="mlSource" rows="9" placeholder="Paste your script here..."></textarea></div>
        <button class="btn btn-purple" id="mlBtn" onclick="translateScript()">ðŸŒ Translate to ${selectedLang}</button>
        <div id="mlOutput" style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px;font-size:13px;color:var(--text2);min-height:130px;line-height:1.7;">Translation will appear here...</div>
        <button class="btn btn-ghost btn-sm" id="mlCopyBtn" style="display:none" onclick="safeCopy(document.getElementById('mlOutput').innerText,'Copied!','ðŸ“‹')">ðŸ“‹ Copy Translation</button>
      </div>
    </div>`;
}
function selectLang(name,el){selectedLang=name;document.querySelectorAll('.lang-card').forEach(c=>c.classList.remove('sel'));el.classList.add('sel');const btn=document.getElementById('mlBtn');if(btn)btn.textContent=`ðŸŒ Translate to ${name}`;}
async function translateScript(){
  const src=(document.getElementById('mlSource')||{}).value?.trim();
  if(!src){notify('Paste a script first','error','âš ï¸');return;}
  const btn=document.getElementById('mlBtn');
  btn.innerHTML='<div class="spinner spinner-sm"></div> Translating...'; btn.disabled=true;
  try{
    const result=await callClaude([{role:'user',content:`Translate this video script to ${selectedLang}. Keep the same energy, structure and cultural tone. Adapt idioms naturally:\n\n${src}`}],
      `Expert video script translator. Translate naturally and culturally into ${selectedLang}.`,1400);
    document.getElementById('mlOutput').innerHTML=result.replace(/\n/g,'<br>');
    document.getElementById('mlCopyBtn').style.display='block';
    notify(`Translated to ${selectedLang}!`,'success','ðŸŒ');awardXP('used_multilang');
  }catch(e){notify(friendlyErr(e),'error','âš ï¸');}
  btn.innerHTML=`ðŸŒ Translate to ${selectedLang}`; btn.disabled=false;
}

// ============================================================
// AFFILIATE
// ============================================================
function renderAffiliate(){
  const code=currentUser?.referralCode||'TV-XXXX';
  // Load real referral data from localStorage
  var allUsers = []; try { allUsers = JSON.parse(localStorage.getItem('tv_all_users')||'[]'); } catch(e) {}
  var refData = {}; try { refData = JSON.parse(localStorage.getItem('tv_ref_'+code)||'{}'); } catch(e) {}
  var referralUsers = allUsers.filter(function(u){ return u.referredBy === code; });
  var totalReferrals = referralUsers.length + (refData.count||0);
  var paidReferrals = referralUsers.filter(function(u){ return u.plan && u.plan!=='free'; }).length + (refData.paid||0);
  var planPrices = {free:0,starter:9,pro:19,gold:39,elite:79};
  var monthlyEarnings = referralUsers.reduce(function(s,u){ return s+Math.round((planPrices[u.plan]||0)*0.3); },0) + (refData.earnings||0);
  var totalEarnings = (refData.totalEarnings||0) + monthlyEarnings;
  var refLink = 'https://trendvid.ai/ref/'+code;
  // Generate share messages
  var twitterMsg = encodeURIComponent('I use TrendVid AI to script viral videos - it is incredible. Get started free: '+refLink);
  var statsHtml =
    '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px">' +
      '<div class="card" style="text-align:center;padding:16px"><div style="font-size:26px;font-weight:800;color:var(--gold);font-family:var(--font-display)">Â£'+totalEarnings+'</div><div style="font-size:11px;color:var(--muted);margin-top:4px;font-weight:700">Total Earned</div></div>' +
      '<div class="card" style="text-align:center;padding:16px"><div style="font-size:26px;font-weight:800;color:var(--teal);font-family:var(--font-display)">'+totalReferrals+'</div><div style="font-size:11px;color:var(--muted);margin-top:4px;font-weight:700">Referrals</div></div>' +
      '<div class="card" style="text-align:center;padding:16px"><div style="font-size:26px;font-weight:800;color:var(--accent);font-family:var(--font-display)">30%</div><div style="font-size:11px;color:var(--muted);margin-top:4px;font-weight:700">Commission</div></div>' +
      '<div class="card" style="text-align:center;padding:16px"><div style="font-size:26px;font-weight:800;color:var(--purple);font-family:var(--font-display)">Â£'+monthlyEarnings+'</div><div style="font-size:11px;color:var(--muted);margin-top:4px;font-weight:700">This Month</div></div>' +
    '</div>';
  var referralRows = referralUsers.length === 0
    ? '<div style="text-align:center;padding:28px;color:var(--muted);font-size:13px">No referrals yet â€” share your link to start earning!</div>'
    : referralUsers.map(function(u){
        var earnings = Math.round((planPrices[u.plan]||0)*0.3);
        return '<div style="display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border)">' +
          '<div><div style="font-size:12px;font-weight:600">'+(u.name||u.email||'â€”')+'</div><div style="font-size:10px;color:var(--muted)">'+u.email+'</div></div>' +
          '<div style="display:flex;align-items:center;gap:10px"><span class="tier-badge tier-'+(u.plan||'free')+'" style="font-size:9px">'+(u.plan||'free').toUpperCase()+'</span>' +
          '<span style="font-size:12px;font-weight:700;color:var(--teal)">Â£'+earnings+'/mo</span></div>' +
        '</div>';
      }).join('');
  document.getElementById('pageContent').innerHTML =
    '<div class="section-label" style="margin-bottom:8px">AFFILIATE PROGRAMME</div>' +
    '<h2 style="font-family:var(--font-display);font-size:24px;font-weight:800;margin-bottom:4px">Earn <span style="color:var(--teal)">30%</span> recurring commission</h2>' +
    '<p style="font-size:13px;color:var(--muted);margin-bottom:20px">For every creator you send to TrendVid, you earn 30% of their subscription â€” every month, forever.</p>' +
    statsHtml +
    '<div class="card" style="margin-bottom:14px">' +
      '<div class="section-label" style="margin-bottom:12px">YOUR REFERRAL LINK</div>' +
      '<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px">' +
        '<div class="form-input" style="flex:1;color:var(--teal);font-weight:600;cursor:default;min-width:200px;font-size:12px">'+refLink+'</div>' +
        '<button class="btn btn-teal btn-sm" onclick="safeCopy(&quot;&quot;+refLink+&quot;&quot;,&quot;Link copied!&quot;,&quot;ðŸ”—&quot;)">ðŸ“‹ Copy Link</button>' +
      '</div>' +
      '<div style="font-size:11px;color:var(--muted);margin-bottom:10px;font-weight:600">SHARE ON</div>' +
      '<div style="display:flex;gap:8px;flex-wrap:wrap">' +
        '<a href="https://twitter.com/intent/tweet?text='+twitterMsg+'" target="_blank" class="btn btn-ghost btn-sm" style="font-size:11px;text-decoration:none">ð• Twitter / X</a>' +
        '<button class="btn btn-ghost btn-sm" style="font-size:11px" onclick="safeCopy(&quot;&quot;+refLink+&quot;&quot;,&quot;Ready to paste!&quot;,&quot;âœ‚ï¸&quot;)">ðŸ“± Copy for WhatsApp / Discord</button>' +
        '<button class="btn btn-ghost btn-sm" style="font-size:11px;border-color:rgba(0,229,176,0.3);color:var(--teal)" onclick="showEmbedWidget()">ðŸŒ Embed Widget</button>' +
        '<button class="btn btn-ghost btn-sm" style="font-size:11px;border-color:rgba(167,139,250,0.3);color:var(--purple)" onclick="showCreatorStatsCard()">ðŸ“Š My Stats Card</button>' +
      '</div>' +
    '</div>' +
    '<div class="card" style="margin-bottom:14px">' +
      '<div class="section-label" style="margin-bottom:12px">YOUR REFERRALS</div>' +
      referralRows +
    '</div>' +
    '<div class="card">' +
      '<div class="section-label" style="margin-bottom:12px">HOW IT WORKS</div>' +
      '<div style="display:flex;flex-direction:column;gap:14px">' +
        [['Share your link','Send your unique link to other creators. Works on Twitter, YouTube descriptions, Discord, anywhere.'],
         ['They sign up','They get a free TrendVid account â€” no credit card needed. Low friction, high conversion.'],
         ['You earn 30%','Get 30% of every subscription they pay, every month, forever. Paid creators = Â£2.70 to Â£23.70/mo each.']
        ].map(function(item, i){
          return '<div style="display:flex;align-items:flex-start;gap:14px">' +
            '<div style="width:32px;height:32px;border-radius:50%;background:rgba(255,60,92,0.1);border:1px solid rgba(255,60,92,0.25);display:flex;align-items:center;justify-content:center;font-family:Bebas Neue;font-size:18px;color:var(--accent);flex-shrink:0">'+(i+1)+'</div>' +
            '<div><div style="font-size:13px;font-weight:700">'+item[0]+'</div><div style="font-size:12px;color:var(--muted);margin-top:2px">'+item[1]+'</div></div>' +
          '</div>';
        }).join('') +
      '</div>' +
    '</div>';
}

// ============================================================
// SETTINGS
// ============================================================

// ============================================================
// HF IMAGE KEY MANAGER â€” Admin can add/remove/pin keys & models
// All data stored permanently in localStorage
// ============================================================

function getHFAdminKeys() {
  try { return JSON.parse(localStorage.getItem('tv_hf_keys') || '[]'); } catch(e) { return []; }
}

function saveHFAdminKeys(keys) {
  localStorage.setItem('tv_hf_keys', JSON.stringify(keys));
  // Reset the in-memory pool so next image gen picks up the new list
  if (typeof _hfKeyPool !== 'undefined') { _hfKeyPool = []; _hfKeyIdx = 0; }
}

function getHFActiveModel() {
  return localStorage.getItem('tv_hf_active_model') || '';
}

function renderHFKeyManager() {
  var keys = getHFAdminKeys();
  var activeModel = getHFActiveModel();

  var models = [
    { id: 'flux-schnell', name: 'FLUX.1-schnell âš¡', desc: 'Fastest â€” best for most users' },
    { id: 'flux-dev',     name: 'FLUX.1-dev ðŸŽ¨',    desc: 'Higher quality, slower (28 steps)' },
    { id: 'sdxl-turbo',  name: 'SDXL-Turbo ðŸš€',    desc: 'Very fast, great quality' },
    { id: 'sdxl',        name: 'SDXL',               desc: 'Standard high-res model' },
    { id: 'sd21',        name: 'SD 2.1',             desc: 'Reliable fallback' },
    { id: 'sd15',        name: 'SD 1.5',             desc: 'Lightest, fastest cold start' },
  ];

  // Count total keys (vault + admin)
  var vaultCount = 11; // built-in encrypted keys
  var totalKeys = vaultCount + keys.length;

  var html = '';

  // â”€â”€ Status bar â”€â”€
  html += '<div style="background:rgba(0,229,176,0.06);border:1px solid rgba(0,229,176,0.2);border-radius:12px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">' +
    '<div style="display:flex;align-items:center;gap:10px">' +
      '<span style="font-size:22px">ðŸ”‘</span>' +
      '<div>' +
        '<div style="font-size:13px;font-weight:800;color:var(--teal)">' + totalKeys + ' HuggingFace Key' + (totalKeys !== 1 ? 's' : '') + ' Active</div>' +
        '<div style="font-size:11px;color:var(--muted)">' + vaultCount + ' built-in (encrypted) Â· ' + keys.length + ' admin-added Â· Auto-cycles on rate limits</div>' +
      '</div>' +
    '</div>' +
    '<div style="font-size:11px;font-weight:700;color:var(--teal);background:rgba(0,229,176,0.1);padding:4px 10px;border-radius:8px">Model: ' + (activeModel ? models.find(function(m){return m.id===activeModel;})?.name || activeModel : 'Auto (FLUX first)') + '</div>' +
  '</div>';

  // â”€â”€ Model picker â”€â”€
  html += '<div style="margin-bottom:16px">' +
    '<div style="font-size:11px;font-weight:800;color:var(--muted);letter-spacing:1px;margin-bottom:8px">ðŸŽ¨ ACTIVE MODEL</div>' +
    '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px">';

  // "Auto" option
  html += '<div onclick="hfSetActiveModel(\x27\x27)" style="cursor:pointer;border:2px solid ' + (!activeModel ? 'var(--teal)' : 'var(--border)') + ';border-radius:12px;padding:10px 12px;background:' + (!activeModel ? 'rgba(0,229,176,0.08)' : 'transparent') + ';transition:all 0.15s">' +
    '<div style="font-size:12px;font-weight:800;color:' + (!activeModel ? 'var(--teal)' : 'var(--text)') + '">ðŸ”„ Auto-cascade</div>' +
    '<div style="font-size:10px;color:var(--muted);margin-top:2px">Try each model in order</div>' +
  '</div>';

  models.forEach(function(m) {
    var isActive = activeModel === m.id;
    html += '<div onclick="hfSetActiveModel(\x27' + m.id + '\x27)" style="cursor:pointer;border:2px solid ' + (isActive ? 'var(--teal)' : 'var(--border)') + ';border-radius:12px;padding:10px 12px;background:' + (isActive ? 'rgba(0,229,176,0.08)' : 'transparent') + ';transition:all 0.15s">' +
      '<div style="font-size:12px;font-weight:800;color:' + (isActive ? 'var(--teal)' : 'var(--text)') + '">' + m.name + '</div>' +
      '<div style="font-size:10px;color:var(--muted);margin-top:2px">' + m.desc + '</div>' +
    '</div>';
  });

  html += '</div></div>';

  // â”€â”€ Admin-added keys list â”€â”€
  html += '<div style="margin-bottom:12px">' +
    '<div style="font-size:11px;font-weight:800;color:var(--muted);letter-spacing:1px;margin-bottom:8px">ðŸ” ADMIN-ADDED KEYS (' + keys.length + ')</div>';

  if (keys.length === 0) {
    html += '<div style="font-size:12px;color:var(--muted);padding:12px;background:var(--surface2);border-radius:10px;text-align:center">No admin keys added yet â€” the 11 built-in vault keys are already active</div>';
  } else {
    keys.forEach(function(key, idx) {
      var masked = key.slice(0, 6) + 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' + key.slice(-4);
      html += '<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;margin-bottom:6px">' +
        '<span style="font-size:14px">ðŸ”‘</span>' +
        '<span style="flex:1;font-family:monospace;font-size:11px;color:var(--text2)">' + masked + '</span>' +
        '<button onclick="hfRemoveKey(' + idx + ')" style="background:rgba(255,48,88,0.1);border:1px solid rgba(255,48,88,0.3);color:var(--accent);padding:3px 10px;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer">âœ• Remove</button>' +
      '</div>';
    });
  }

  html += '</div>';

  // â”€â”€ Add new key â”€â”€
  html += '<div style="display:flex;gap:8px;align-items:center">' +
    '<input class="form-input" id="hfNewKeyInput" type="password" placeholder="hf_â€¦ paste new HuggingFace token" style="flex:1;font-family:monospace;font-size:12px">' +
    '<button class="btn btn-primary btn-sm" onclick="hfAddKey()" style="white-space:nowrap;flex-shrink:0">+ Add Key</button>' +
    '<a href="https://huggingface.co/settings/tokens" target="_blank" class="btn btn-ghost btn-sm" style="flex-shrink:0;font-size:11px">Get â†—</a>' +
  '</div>' +
  '<div style="font-size:10px;color:var(--muted);margin-top:6px">Keys are saved permanently to this browser. All keys cycle automatically â€” new keys take effect immediately.</div>';

  return html;
}

function hfAddKey() {
  var inp = document.getElementById('hfNewKeyInput');
  if (!inp) return;
  var val = inp.value.trim();
  if (!val || !val.startsWith('hf_')) {
    notify('Paste a valid HuggingFace token starting with hf_', 'error', 'âš ï¸'); return;
  }
  var keys = getHFAdminKeys();
  if (keys.indexOf(val) !== -1) {
    notify('That key is already in the list', 'warning', 'âš ï¸'); return;
  }
  keys.push(val);
  saveHFAdminKeys(keys);
  inp.value = '';
  notify('âœ… Key added â€” now using ' + (11 + keys.length) + ' HuggingFace keys', 'success');
  refreshHFPanel();
}

function hfRemoveKey(idx) {
  var keys = getHFAdminKeys();
  keys.splice(idx, 1);
  saveHFAdminKeys(keys);
  notify('Key removed', 'info', 'ðŸ—‘ï¸');
  refreshHFPanel();
}

function hfSetActiveModel(modelId) {
  if (modelId) {
    localStorage.setItem('tv_hf_active_model', modelId);
    notify('âœ… Model pinned â€” all image gen will use ' + modelId, 'success', 'ðŸŽ¨');
  } else {
    localStorage.removeItem('tv_hf_active_model');
    notify('Model set to auto-cascade (FLUX first)', 'info', 'ðŸ”„');
  }
  refreshHFPanel();
}

function refreshHFPanel() {
  var panel = document.getElementById('hfKeyManagerPanel');
  if (panel) panel.innerHTML = renderHFKeyManager();
}
// ============================================================
// END HF IMAGE KEY MANAGER
// ============================================================

function renderSettings(){
  const isAdmin = currentUser?.isAdmin;
  document.getElementById('pageContent').innerHTML=`
    <div class="section-label" style="margin-bottom:12px">PREFERENCES</div>
    <div style="background:linear-gradient(135deg,rgba(167,139,250,0.1),rgba(0,229,176,0.05));border:1px solid rgba(167,139,250,0.3);border-radius:14px;padding:14px 16px;margin-bottom:16px;display:flex;align-items:flex-start;gap:12px">
      <div style="font-size:24px;flex-shrink:0">ðŸ”®</div>
      <div>
        <div style="font-size:13px;font-weight:800;margin-bottom:4px">Add Gemini for backup AI</div>
        <div style="font-size:12px;color:var(--muted);line-height:1.6">Get a <strong style="color:var(--text)">free</strong> Gemini API key from <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--accent);font-weight:700">aistudio.google.com</a> â€” it takes 30 seconds and means you are never left without AI if Groq goes down. Scroll to <strong style="color:var(--purple)">AI Provider</strong> below to add it.</div>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">Appearance</div>
      <div class="settings-row"><div><div class="settings-label">Dark Mode</div><div class="settings-desc">Use dark theme across the app</div></div><button class="toggle on" id="darkToggle" onclick="this.classList.toggle('on');toggleTheme()"></button></div>
      <div class="settings-row"><div><div class="settings-label">Grid Background</div><div class="settings-desc">Show subtle grid lines</div></div><button class="toggle on" onclick="document.body.classList.toggle('dark-grid')"></button></div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">Account</div>
      <div class="settings-row"><div><div class="settings-label">Current Plan</div><div class="settings-desc">${TIERS[currentUser?.plan||'free']?.desc||''}</div></div><span class="tier-badge tier-${currentUser?.plan||'free'}" style="${TIERS[currentUser?.plan||'free']?.badgeStyle||''}">${TIERS[currentUser?.plan||'free']?.label||'FREE'}</span></div>
      ${(currentUser?.plan||'free')!=='elite'?`<div class="settings-row"><div><div class="settings-label">Upgrade Plan</div><div class="settings-desc">Unlock more AI calls, tools & features</div></div><button class="btn btn-gold btn-sm" onclick="navTo('pricing')">View Plans ðŸ’Ž</button></div>`:`<div class="settings-row"><div><div class="settings-label">You're on the top plan</div><div class="settings-desc">All features unlocked â€” thank you! ðŸ’Ž</div></div></div>`}
    </div>
    ${isAdmin ? `
    <div class="admin-section">
      <div class="admin-section-title">ðŸ” <span>ADMIN ONLY â€” AI PROVIDER SETTINGS</span><span class="admin-lock" style="margin-left:auto">ðŸ‘‘ Admin Access</span></div>
      <div class="provider-status-grid">
        <div class="provider-card ${!_groqFailed?'active-provider':'offline-provider'}">
          <div class="provider-card-icon">âš¡</div>
          <div class="provider-card-name">Groq</div>
          <div style="font-size:11px;color:var(--muted);margin-bottom:8px">llama-3.3-70b</div>
          <div class="provider-card-status ${!_groqFailed?'status-active':'status-offline'}">${!_groqFailed?'â— PRIMARY â€” Active':'â— OFFLINE'}</div>
        </div>
        <div class="provider-card ${_geminiKey&&_groqFailed?'active-provider':''}">
          <div class="provider-card-icon">ðŸ”®</div>
          <div class="provider-card-name">Gemini</div>
          <div style="font-size:11px;color:var(--muted);margin-bottom:8px">gemini-2.0-flash</div>
          <div class="provider-card-status ${_geminiKey?(_groqFailed?'status-active':'status-standby'):'status-none'}">${_geminiKey?(_groqFailed?'â— BACKUP â€” Active':'â— BACKUP â€” Standby'):'â— Not Configured'}</div>
        </div>
      </div>
      <!-- â”€â”€ API PROVIDER MANAGER â”€â”€ -->
      <div style="display:flex;flex-direction:column;gap:12px;margin-top:4px">
        ${(function(){
          var defs = [
            {id:'groq-default',     icon:'âš¡', name:'Groq',         model:'llama-3.3-70b', badge:'PRIMARY', badgeColor:'rgba(0,229,176,0.15)', badgeText:'var(--teal)',   lsKey:'tv_groq_key',          keyUrl:'https://console.groq.com/keys',                hint:'gsk_â€¦',  builtinCheck:false},
            {id:'gemini-default',   icon:'ðŸ”®', name:'Gemini Flash', model:'gemini-2.0-flash', badge:'BACKUP', badgeColor:'rgba(167,139,250,0.15)', badgeText:'var(--purple)',lsKey:'tv_gemini_key_shared', keyUrl:'https://aistudio.google.com/app/apikey', hint:'AIzaâ€¦', builtinCheck:false},
            {id:'cerebras-default', icon:'ðŸ§ ', name:'Cerebras',     model:'llama3.1-70b',  badge:'BACKUP', badgeColor:'rgba(255,123,0,0.12)',    badgeText:'var(--accent2)',lsKey:'tv_cerebras_key',      keyUrl:'https://cloud.cerebras.ai',                      hint:'csk-â€¦', builtinCheck:!!CEREBRAS_KEY},
            {id:'cohere-default',   icon:'ðŸŒŠ', name:'Cohere',       model:'command-r-plus', badge:'BACKUP', badgeColor:'rgba(255,255,255,0.07)', badgeText:'var(--text2)', lsKey:'tv_cohere_key',        keyUrl:'https://dashboard.cohere.com/api-keys',          hint:'Pasteâ€¦',builtinCheck:!!COHERE_KEY},
            {id:'mistral-default',  icon:'ðŸŒ¬ï¸', name:'Mistral',      model:'mistral-large', badge:'BACKUP', badgeColor:'rgba(255,255,255,0.07)', badgeText:'var(--text2)', lsKey:'tv_mistral_key',       keyUrl:'https://console.mistral.ai/api-keys',            hint:'Pasteâ€¦',builtinCheck:!!MISTRAL_KEY},
            {id:'hf-default',       icon:'ðŸ–¼ï¸', name:'HuggingFace',   model:'FLUX + SDXL (images)', badge:'IMAGES', badgeColor:'rgba(255,196,0,0.12)', badgeText:'var(--gold)', lsKey:'tv_hf_key', keyUrl:'https://huggingface.co/settings/tokens', hint:'hf_â€¦', builtinCheck:false},
          ];
          return defs.map(function(r){
            var prov = _aiProviders.find(function(p){return p.id===r.id;});
            var isOn = prov ? !prov.paused : (r.id==='groq-default');
            var hasKey = r.builtinCheck || !!localStorage.getItem(r.lsKey);
            var dot = isOn&&hasKey ? '#00e5b0' : isOn&&!hasKey ? '#ff3058' : '#2a3350';
            var glow = isOn&&hasKey ? '0 0 8px rgba(0,229,176,0.5)' : 'none';
            var statusTxt = isOn&&hasKey ? 'ACTIVE' : isOn&&!hasKey ? 'NO KEY' : 'OFF';
            var statusColor = isOn&&hasKey ? 'var(--teal)' : isOn&&!hasKey ? 'var(--accent)' : 'var(--muted)';
            var border = isOn&&hasKey ? 'rgba(0,229,176,0.3)' : 'var(--border)';
            var lsVal = localStorage.getItem(r.lsKey);
            return `<div style="background:var(--surface3);border:1px solid ${border};border-radius:16px;padding:14px 16px;transition:border-color 0.2s">
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
                <span style="font-size:20px">${r.icon}</span>
                <div style="flex:1;min-width:0">
                  <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                    <span style="font-size:13px;font-weight:800">${r.name}</span>
                    <span style="font-size:10px;background:${r.badgeColor};color:${r.badgeText};padding:2px 8px;border-radius:10px;font-weight:700">${r.badge}</span>
                    <span style="font-size:10px;font-weight:900;color:${statusColor}">${statusTxt}</span>
                  </div>
                  <div style="font-size:11px;color:var(--muted)">${r.model}</div>
                </div>
                <div style="width:10px;height:10px;border-radius:50%;background:${dot};box-shadow:${glow};flex-shrink:0"></div>
                <label style="position:relative;display:inline-block;width:46px;height:26px;cursor:pointer;flex-shrink:0">
                  <input type="checkbox" ${isOn?'checked':''} style="opacity:0;width:0;height:0" onchange="adminToggleProvider('${r.id}',this.checked)">
                  <span style="position:absolute;inset:0;background:${isOn?'var(--accent)':'var(--border2)'};border-radius:26px;transition:background 0.2s"></span>
                  <span style="position:absolute;top:4px;left:${isOn?'24px':'4px'};width:18px;height:18px;background:#fff;border-radius:50%;transition:left 0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.3)"></span>
                </label>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <input class="form-input" id="keyInput_${r.id}" type="password" placeholder="${r.hint}"
                  style="flex:1;font-family:monospace;font-size:11px;padding:7px 10px"
                  value="${lsVal ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : r.builtinCheck ? '(built-in)' : ''}">
                <button class="btn btn-primary btn-sm" style="flex-shrink:0" onclick="adminSaveProviderKey('${r.id}','${r.lsKey}')">ðŸ’¾ Save</button>
                <a href="${r.keyUrl}" target="_blank" class="btn btn-ghost btn-sm" style="flex-shrink:0;font-size:11px">Get â†—</a>
              </div>
            </div>`;
          }).join('');
        })()}
        <div style="display:flex;gap:8px;padding-top:2px">
          <button class="btn btn-primary" style="flex:1" onclick="adminToggleAllProviders(true)">âš¡ Enable All</button>
          <button class="btn btn-ghost" style="flex:1" onclick="adminToggleAllProviders(false)">ðŸ”´ Disable All</button>
        </div>
        <div style="font-size:11px;color:var(--muted);text-align:center">Enabled providers are tried in order â€” Groq first, then fallbacks automatically.</div>
      </div>
    </div>

    <!-- â”€â”€ HF IMAGE KEY MANAGER â”€â”€ -->
    <div class="admin-section" style="margin-top:12px">
      <div class="admin-section-title">ðŸ–¼ï¸ <span>IMAGE AI â€” HUGGINGFACE KEY MANAGER</span><span class="admin-lock" style="margin-left:auto">ðŸ‘‘ Admin Only</span></div>
      <div id="hfKeyManagerPanel">${renderHFKeyManager()}</div>
    </div>
    ` : `
    <div class="settings-section">
      <div class="settings-section-title">âš¡ AI Status</div>
      <div style="display:flex;align-items:center;gap:12px;padding:14px 0">
        <div style="width:10px;height:10px;border-radius:50%;background:${hasAnyAIKey()?'var(--teal)':'var(--accent)'};box-shadow:0 0 8px ${hasAnyAIKey()?'rgba(0,229,176,0.5)':'rgba(255,48,88,0.5)'}"></div>
        <div>
          <div style="font-size:13px;font-weight:700">AI is ${hasAnyAIKey()?'Online':'No Key Configured'}</div>
          <div style="font-size:11px;color:var(--muted)">${hasAnyAIKey()?'All features powered by TrendVid AI':'Add a free Groq key in AI Provider below'}</div>
        </div>
      </div>
    </div>
    `}
    ${(currentUser && currentUser.isAdmin) ? `<div class="settings-section" style="margin-top:8px">
      <div class="settings-section-title">ðŸš€ Deploy to Netlify</div>
      <div style="background:linear-gradient(135deg,rgba(0,229,176,0.07),rgba(167,139,250,0.04));border:1px solid rgba(0,229,176,0.2);border-radius:14px;padding:16px;margin-bottom:14px">
        <div style="font-size:13px;font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:8px"><span>ðŸ“¦</span> How to redeploy your app</div>
        <div style="display:flex;flex-direction:column;gap:8px;font-size:12px;color:var(--text2);line-height:1.6">
          <div style="display:flex;gap:10px;align-items:flex-start"><span style="background:var(--teal);color:#000;border-radius:50%;width:18px;height:18px;min-width:18px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;margin-top:1px">1</span><span>Click <strong style="color:var(--text)">Download App File</strong> below â€” saves the latest version of TrendVid as an HTML file</span></div>
          <div style="display:flex;gap:10px;align-items:flex-start"><span style="background:var(--teal);color:#000;border-radius:50%;width:18px;height:18px;min-width:18px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;margin-top:1px">2</span><span>Go to <a href="https://app.netlify.com" target="_blank" style="color:var(--accent);font-weight:700">app.netlify.com</a> â†’ your site â†’ <strong style="color:var(--text)">Deploys</strong> tab</span></div>
          <div style="display:flex;gap:10px;align-items:flex-start"><span style="background:var(--teal);color:#000;border-radius:50%;width:18px;height:18px;min-width:18px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;margin-top:1px">3</span><span>Drag and drop the downloaded file into the Netlify deploy zone â€” it redeploys in seconds</span></div>
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="downloadAppFile()" style="display:flex;align-items:center;gap:8px;flex:1;justify-content:center;min-width:180px">â¬‡ï¸ Download App File</button>
        <a href="https://app.netlify.com" target="_blank" class="btn btn-ghost" style="display:flex;align-items:center;gap:8px;flex:1;justify-content:center;min-width:180px;text-decoration:none">ðŸŒ Open Netlify</a>
      </div>
      <div style="margin-top:10px;font-size:11px;color:var(--muted);text-align:center">The file will be named <code style="background:var(--surface3);padding:1px 6px;border-radius:4px">index.html</code> â€” drag it straight onto Netlify</div>
    </div>` : ''}
    `;
}

// ============================================================
// SCRIPT TO VIDEO â€” Animated Captions + Browser TTS
// ============================================================
var _vtv = {
  lines: [],
  currentLine: 0,
  utterance: null,
  playing: false,
  paused: false,
  animFrame: null,
  canvas: null,
  ctx: null,
  voice: null,
  rate: 0.95,
  pitch: 1.0,
  bgColor: '#0a0a12',
  textColor: '#ffffff',
  accentColor: '#ff3058',
  fontStyle: 'bold',
  animStyle: 'fade',
  bgStyle: 'dark',  // dark | gradient | cinematic | neon
  captionStyle: 'centered', // centered | lower-third | karaoke
  progress: 0,
  lineStartTime: 0,
  lineDuration: 0,
  wordIdx: 0,
  wordTimings: [],
  volume: 1.0,
  sceneImages: [],        // HTMLImageElement per line (or null)
  useSceneImages: false,  // toggle
};

// Preset themes for one-click style changes
var _vtvThemes = {
  dark:      { bg:'#0a0a12', text:'#ffffff', accent:'#ff3058', bgStyle:'dark' },
  cinematic: { bg:'#0d0800', text:'#fff8e7', accent:'#fbbf24', bgStyle:'cinematic' },
  neon:      { bg:'#050510', text:'#e0e0ff', accent:'#00e5b0', bgStyle:'neon' },
  minimal:   { bg:'#f5f5f0', text:'#111111', accent:'#ff3058', bgStyle:'minimal' },
  purple:    { bg:'#0b0514', text:'#f3e8ff', accent:'#a78bfa', bgStyle:'purple' },
};

function vtvApplyTheme(name) {
  var t = _vtvThemes[name];
  if (!t) return;
  _vtv.bgColor = t.bg;
  _vtv.textColor = t.text;
  _vtv.accentColor = t.accent;
  _vtv.bgStyle = t.bgStyle;
  document.getElementById('vtvBg').value = t.bg;
  document.getElementById('vtvTextCol').value = t.text;
  document.getElementById('vtvAccent').value = t.accent;
  document.querySelectorAll('.vtv-theme-btn').forEach(b => b.classList.remove('active'));
  var btn = document.querySelector('[data-theme-name="'+name+'"]');
  if (btn) btn.classList.add('active');
  if (_vtv.canvas && !_vtv.playing) vtvDrawIdle();
}

function renderVideoGen() {
  var savedScript = '';
  try {
    var scripts = JSON.parse(localStorage.getItem('tv_scripts') || '[]');
    if (scripts.length > 0) savedScript = scripts[scripts.length - 1].content || '';
  } catch(e) {}

  document.getElementById('pageContent').innerHTML = `
    <style>
      .vtv-tab { padding:7px 14px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:12px;font-weight:700;font-family:var(--font-display);cursor:pointer;transition:all 0.15s;letter-spacing:0.04em; }
      .vtv-tab.active { background:rgba(255,48,88,0.12);border-color:rgba(255,48,88,0.4);color:var(--accent); }
      .vtv-tab:hover:not(.active) { background:var(--surface2);color:var(--text); }
      .vtv-theme-swatch { width:100%;padding:8px 10px;border-radius:10px;border:1.5px solid var(--border);cursor:pointer;display:flex;align-items:center;gap:8px;transition:all 0.15s;font-size:11px;font-weight:700;color:var(--text2); }
      .vtv-theme-swatch:hover { border-color:var(--border2);background:var(--surface2); }
      .vtv-theme-swatch.active { border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,48,88,0.2); }
      .vtv-swatch-dot { width:18px;height:18px;border-radius:50%;flex-shrink:0;border:1px solid rgba(255,255,255,0.15); }
      .vtv-caption-btn { padding:6px 12px;border-radius:9px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:11px;font-weight:700;font-family:var(--font-display);cursor:pointer;transition:all 0.15s; }
      .vtv-caption-btn.active { background:rgba(0,229,176,0.1);border-color:rgba(0,229,176,0.4);color:var(--teal); }
      .vtv-stat-box { background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:10px 14px;display:flex;flex-direction:column;align-items:center;gap:2px; }
      .vtv-stat-val { font-size:18px;font-weight:900;font-family:var(--font-display);color:var(--text); }
      .vtv-stat-lbl { font-size:10px;color:var(--muted);font-weight:700; }
      .vtv-line-item { font-size:11px;padding:7px 11px;border-radius:9px;margin-bottom:4px;cursor:pointer;border:1px solid var(--border);background:var(--surface2);color:var(--text2);transition:all 0.18s;display:flex;align-items:center;gap:8px; }
      .vtv-line-item:hover { border-color:var(--border2);background:var(--surface3); }
      .vtv-line-num { font-size:9px;font-weight:900;font-family:var(--font-display);color:var(--muted);min-width:20px; }
      input[type=range].vtv-range { -webkit-appearance:none;appearance:none;height:5px;background:var(--border2);border-radius:3px;outline:none;cursor:pointer; }
      input[type=range].vtv-range::-webkit-slider-thumb { -webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);border:2px solid #fff;box-shadow:0 2px 6px rgba(255,48,88,0.4);cursor:pointer; }
      .vtv-play-ring { position:relative;display:flex;align-items:center;justify-content:center; }
      .vtv-transport { display:flex;align-items:center;gap:10px; }
      .vtv-big-btn { width:52px;height:52px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;transition:all 0.15s;flex-shrink:0; }
      .vtv-big-btn:hover { transform:scale(1.08); }
      .vtv-sm-btn { width:38px;height:38px;border-radius:50%;border:1px solid var(--border);background:var(--surface2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all 0.15s;color:var(--text2); }
      .vtv-sm-btn:hover { background:var(--surface3);border-color:var(--border2);transform:scale(1.05); }
    </style>

    <!-- PAGE HEADER -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px">
      <div>
        <h2 style="font-family:var(--font-display);font-size:22px;font-weight:900;margin-bottom:3px">ðŸŽ¬ Script to Video Studio</h2>
        <div style="font-size:12px;color:var(--muted)">Paste a script â†’ choose your style â†’ hit Play & screen-record</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost btn-sm" onclick="vtvShowHelp()" style="font-size:11px">â“ How it works</button>
        <button class="btn btn-sm" style="background:rgba(0,229,176,0.1);border:1px solid rgba(0,229,176,0.3);color:var(--teal);font-size:11px;font-weight:800" onclick="vtvDownloadScript()">ðŸ’¾ Save Script</button>
      </div>
    </div>

    <!-- MAIN LAYOUT -->
    <div style="display:grid;grid-template-columns:360px 1fr;gap:20px;align-items:start">

      <!-- â•â•â•â•â•â• LEFT PANEL â•â•â•â•â•â• -->
      <div style="display:flex;flex-direction:column;gap:14px">

        <!-- Tabs: Script / Voices / Style -->
        <div style="display:flex;gap:6px;background:var(--surface2);border-radius:13px;padding:5px">
          <button class="vtv-tab active" id="vtvTabScript" onclick="vtvSwitchTab('script')">ðŸ“ Script</button>
          <button class="vtv-tab" id="vtvTabVoice" onclick="vtvSwitchTab('voice')">ðŸŽ™ï¸ Voice</button>
          <button class="vtv-tab" id="vtvTabStyle" onclick="vtvSwitchTab('style')">ðŸŽ¨ Style</button>
        </div>

        <!-- â”€â”€ SCRIPT TAB â”€â”€ -->
        <div id="vtvPanelScript" class="card" style="padding:16px">
          <div class="section-label" style="margin-bottom:8px">YOUR SCRIPT</div>
          <textarea id="vtvScript" class="form-input" rows="11" placeholder="Paste your script here, or generate one from the Script Generator first...&#10;&#10;Each sentence will become one animated caption." style="resize:vertical;font-size:13px;line-height:1.75;border-radius:12px">${savedScript}</textarea>

          <!-- Stats row -->
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:10px 0">
            <div class="vtv-stat-box"><div class="vtv-stat-val" id="vtvStatWords">0</div><div class="vtv-stat-lbl">WORDS</div></div>
            <div class="vtv-stat-box"><div class="vtv-stat-val" id="vtvStatLines">0</div><div class="vtv-stat-lbl">CAPTIONS</div></div>
            <div class="vtv-stat-box"><div class="vtv-stat-val" id="vtvStatTime">0s</div><div class="vtv-stat-lbl">EST. LENGTH</div></div>
          </div>

          <button class="btn btn-primary" style="width:100%;font-size:13px;padding:13px;border-radius:12px;letter-spacing:0.03em;font-weight:800" onclick="vtvPrepare()">ðŸŽ¬ Build Video Preview</button>

          <!-- AI Scene Images -->
          <div id="vtvImgPanel" style="display:none;margin-top:12px;padding:12px;background:rgba(0,229,176,0.05);border:1px solid rgba(0,229,176,0.2);border-radius:12px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
              <div>
                <div style="font-size:12px;font-weight:800;color:var(--teal)">ðŸ–¼ï¸ AI Scene Images</div>
                <div style="font-size:10px;color:var(--muted);margin-top:1px">Auto-generate a background image for each caption</div>
              </div>
              <label style="position:relative;display:inline-block;width:40px;height:22px;cursor:pointer;flex-shrink:0">
                <input type="checkbox" id="vtvImgToggle" style="opacity:0;width:0;height:0" onchange="vtvToggleSceneImages(this.checked)">
                <span id="vtvImgToggleTrack" style="position:absolute;inset:0;background:var(--border2);border-radius:24px;transition:0.2s"></span>
                <span id="vtvImgToggleThumb" style="position:absolute;top:3px;left:3px;width:16px;height:16px;background:#fff;border-radius:50%;transition:0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.3)"></span>
              </label>
            </div>
            <div id="vtvImgStatus" style="font-size:11px;color:var(--muted);min-height:16px"></div>
            <div id="vtvImgStrip" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;max-height:120px;overflow-y:auto"></div>
          </div>
        </div>

        <!-- â”€â”€ VOICE TAB â”€â”€ -->
        <div id="vtvPanelVoice" class="card" style="padding:16px;display:none">
          <div class="section-label" style="margin-bottom:10px">VOICE SELECTION</div>
          <select class="form-input" id="vtvVoice" style="font-size:12px;margin-bottom:14px;border-radius:10px"></select>

          <div style="margin-bottom:14px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <div style="font-size:11px;color:var(--muted);font-weight:700">SPEED</div>
              <div style="font-size:12px;font-weight:900;font-family:var(--font-display);color:var(--accent)" id="vtvRateVal">0.95Ã—</div>
            </div>
            <input type="range" id="vtvRate" min="0.5" max="1.8" step="0.05" value="0.95" class="vtv-range" style="width:100%" oninput="document.getElementById('vtvRateVal').textContent=parseFloat(this.value).toFixed(2)+'Ã—';vtvUpdateStats()">
            <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:4px"><span>Slow</span><span>Fast</span></div>
          </div>

          <div style="margin-bottom:14px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <div style="font-size:11px;color:var(--muted);font-weight:700">PITCH</div>
              <div style="font-size:12px;font-weight:900;font-family:var(--font-display);color:var(--accent)" id="vtvPitchVal">1.0</div>
            </div>
            <input type="range" id="vtvPitch" min="0.5" max="2" step="0.1" value="1.0" class="vtv-range" style="width:100%" oninput="document.getElementById('vtvPitchVal').textContent=parseFloat(this.value).toFixed(1)">
            <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:4px"><span>Low</span><span>High</span></div>
          </div>

          <div style="margin-bottom:6px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <div style="font-size:11px;color:var(--muted);font-weight:700">VOLUME</div>
              <div style="font-size:12px;font-weight:900;font-family:var(--font-display);color:var(--accent)" id="vtvVolVal">100%</div>
            </div>
            <input type="range" id="vtvVol" min="0" max="1" step="0.05" value="1" class="vtv-range" style="width:100%" oninput="document.getElementById('vtvVolVal').textContent=Math.round(this.value*100)+'%';_vtv.volume=parseFloat(this.value)">
          </div>

          <div style="margin-top:14px;padding:10px;background:rgba(0,229,176,0.06);border:1px solid rgba(0,229,176,0.15);border-radius:10px;font-size:11px;color:var(--muted);line-height:1.6">
            ðŸ’¡ <strong style="color:var(--text2)">Tip:</strong> Try <em>Google UK English Male</em> or <em>Daniel</em> for the best podcast-style narration.
          </div>
        </div>

        <!-- â”€â”€ STYLE TAB â”€â”€ -->
        <div id="vtvPanelStyle" class="card" style="padding:16px;display:none">

          <div class="section-label" style="margin-bottom:10px">QUICK THEMES</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:16px">
            <button class="vtv-theme-swatch active" data-theme-name="dark" onclick="vtvApplyTheme('dark')">
              <div class="vtv-swatch-dot" style="background:linear-gradient(135deg,#0a0a12,#ff3058)"></div>Dark Red
            </button>
            <button class="vtv-theme-swatch" data-theme-name="cinematic" onclick="vtvApplyTheme('cinematic')">
              <div class="vtv-swatch-dot" style="background:linear-gradient(135deg,#0d0800,#fbbf24)"></div>Cinematic
            </button>
            <button class="vtv-theme-swatch" data-theme-name="neon" onclick="vtvApplyTheme('neon')">
              <div class="vtv-swatch-dot" style="background:linear-gradient(135deg,#050510,#00e5b0)"></div>Neon Teal
            </button>
            <button class="vtv-theme-swatch" data-theme-name="purple" onclick="vtvApplyTheme('purple')">
              <div class="vtv-swatch-dot" style="background:linear-gradient(135deg,#0b0514,#a78bfa)"></div>Purple
            </button>
            <button class="vtv-theme-swatch" data-theme-name="minimal" onclick="vtvApplyTheme('minimal')" style="grid-column:span 2">
              <div class="vtv-swatch-dot" style="background:linear-gradient(135deg,#f5f5f0,#ff3058)"></div>Clean Minimal (Light)
            </button>
          </div>

          <div class="section-label" style="margin-bottom:8px">CUSTOM COLORS</div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px">
            <div>
              <div style="font-size:10px;color:var(--muted);font-weight:700;margin-bottom:5px">BACKGROUND</div>
              <input type="color" id="vtvBg" value="#0a0a12" style="width:100%;height:36px;border:1px solid var(--border);border-radius:9px;cursor:pointer;background:none;padding:2px" oninput="vtvUpdateStyle()">
            </div>
            <div>
              <div style="font-size:10px;color:var(--muted);font-weight:700;margin-bottom:5px">TEXT</div>
              <input type="color" id="vtvTextCol" value="#ffffff" style="width:100%;height:36px;border:1px solid var(--border);border-radius:9px;cursor:pointer;background:none;padding:2px" oninput="vtvUpdateStyle()">
            </div>
            <div>
              <div style="font-size:10px;color:var(--muted);font-weight:700;margin-bottom:5px">ACCENT</div>
              <input type="color" id="vtvAccent" value="#ff3058" style="width:100%;height:36px;border:1px solid var(--border);border-radius:9px;cursor:pointer;background:none;padding:2px" oninput="vtvUpdateStyle()">
            </div>
          </div>

          <div class="section-label" style="margin-bottom:8px">CAPTION POSITION</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px">
            <button class="vtv-caption-btn active" id="vtvCapCenter" onclick="vtvSetCaption(this,'centered')">âŠž Center</button>
            <button class="vtv-caption-btn" id="vtvCapLower" onclick="vtvSetCaption(this,'lower-third')">â–¬ Lower Third</button>
            <button class="vtv-caption-btn" id="vtvCapTop" onclick="vtvSetCaption(this,'top')">â–€ Top</button>
          </div>

          <div class="section-label" style="margin-bottom:8px">ANIMATION</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px">
            <button class="btn btn-sm vtv-anim-btn active" data-anim="fade" onclick="vtvSetAnim(this,'fade')">âœ¦ Fade</button>
            <button class="btn btn-sm vtv-anim-btn" data-anim="slide" onclick="vtvSetAnim(this,'slide')">â†‘ Slide</button>
            <button class="btn btn-sm vtv-anim-btn" data-anim="pop" onclick="vtvSetAnim(this,'pop')">â˜… Pop</button>
            <button class="btn btn-sm vtv-anim-btn" data-anim="typewriter" onclick="vtvSetAnim(this,'typewriter')">| Type</button>
          </div>

          <div class="section-label" style="margin-bottom:8px">FONT WEIGHT</div>
          <div style="display:flex;gap:6px">
            <button class="btn btn-sm vtv-font-btn active" onclick="vtvSetFont(this,'bold')"><b>Bold</b></button>
            <button class="btn btn-sm vtv-font-btn" onclick="vtvSetFont(this,'normal')">Normal</button>
            <button class="btn btn-sm vtv-font-btn" onclick="vtvSetFont(this,'italic')"><i>Italic</i></button>
          </div>
        </div>

        <!-- Playback card (always visible after build) -->
        <div class="card" id="vtvControlsCard" style="display:none;padding:16px">
          <!-- Transport -->
          <div class="vtv-transport" style="justify-content:center;margin-bottom:14px">
            <button class="vtv-sm-btn" onclick="vtvStop()" title="Restart">â®</button>
            <button class="vtv-big-btn" id="vtvPlayBtn" onclick="vtvPlay()" style="background:linear-gradient(135deg,var(--accent),#ff7b3a);color:#fff;box-shadow:0 6px 20px rgba(255,48,88,0.45)">â–¶</button>
            <button class="vtv-big-btn" id="vtvPauseBtn" onclick="vtvPause()" style="background:linear-gradient(135deg,var(--purple),#7c3aed);color:#fff;box-shadow:0 6px 20px rgba(167,139,250,0.4);display:none">â¸</button>
            <button class="vtv-sm-btn" onclick="vtvSkipNext()" title="Next line">â­</button>
          </div>

          <!-- Progress -->
          <div style="background:var(--surface2);border-radius:10px;height:8px;overflow:hidden;cursor:pointer;margin-bottom:8px" onclick="vtvSeekClick(event, this)" id="vtvProgressTrack">
            <div id="vtvProgressBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--purple));border-radius:10px;transition:width 0.2s linear"></div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--muted)">
            <span id="vtvLineCount" style="font-weight:700;font-family:var(--font-display)">Line 0 / 0</span>
            <span id="vtvStatusText" style="color:var(--teal);font-weight:700">Ready â€” press Play</span>
          </div>
        </div>

      </div>

      <!-- â•â•â•â•â•â• RIGHT PANEL â•â•â•â•â•â• -->
      <div style="position:sticky;top:80px;display:flex;flex-direction:column;gap:14px">

        <!-- Canvas preview -->
        <div style="position:relative">
          <div id="vtvCanvasWrap" style="width:100%;aspect-ratio:16/9;background:linear-gradient(135deg,#0a0a14,#12091a);border-radius:18px;overflow:hidden;border:2px solid var(--border);box-shadow:0 24px 60px rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;">
            <div style="text-align:center;color:#444;padding:40px">
              <div style="font-size:64px;margin-bottom:16px;filter:drop-shadow(0 0 30px rgba(255,48,88,0.3))">ðŸŽ¬</div>
              <div style="font-size:17px;font-weight:800;margin-bottom:6px;color:#666;font-family:var(--font-display)">Script to Video Studio</div>
              <div style="font-size:12px;color:#3a3a4a;line-height:1.8">Paste your script â†’ click <strong style="color:#555;background:rgba(255,48,88,0.08);padding:1px 7px;border-radius:5px">Build Video Preview</strong><br>then hit Play and screen-record</div>
            </div>
          </div>
          <canvas id="vtvCanvas" style="display:none;width:100%;border-radius:18px;border:2px solid var(--border);box-shadow:0 24px 60px rgba(0,0,0,0.7)"></canvas>

          <!-- Fullscreen button overlay -->
          <button onclick="vtvFullscreen()" style="position:absolute;bottom:12px;right:12px;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.15);color:#fff;border-radius:8px;padding:5px 10px;font-size:11px;cursor:pointer;backdrop-filter:blur(8px);transition:all 0.15s" onmouseover="this.style.background='rgba(0,0,0,0.85)'" onmouseout="this.style.background='rgba(0,0,0,0.6)'">â›¶ Fullscreen</button>
        </div>

        <!-- Script line list -->
        <div id="vtvLineList" style="display:none">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <div class="section-label">SCRIPT CAPTIONS</div>
            <div style="font-size:10px;color:var(--muted)">Click any line to jump to it</div>
          </div>
          <div id="vtvLineItems" style="max-height:220px;overflow-y:auto;padding-right:4px"></div>
        </div>

        <!-- Tip box -->
        <div style="background:rgba(0,229,176,0.05);border:1px solid rgba(0,229,176,0.18);border-radius:14px;padding:13px 15px;font-size:12px;color:var(--muted);line-height:1.7">
          <strong style="color:var(--teal)">ðŸ’¡ Pro tip:</strong> Hit <strong style="color:var(--text2)">Fullscreen</strong>, then use your OS screen recorder to capture it as a video. On Mac: <code style="font-size:10px;background:var(--surface2);padding:1px 5px;border-radius:4px">âŒ˜â‡§5</code> â€” on Windows: <code style="font-size:10px;background:var(--surface2);padding:1px 5px;border-radius:4px">Win+G</code>
        </div>
      </div>
    </div>
  `;
  vtvPopulateVoices();
  // Bind live stats update on textarea input
  var ta = document.getElementById('vtvScript');
  if (ta) { ta.addEventListener('input', vtvUpdateStats); vtvUpdateStats(); }
}

function vtvSwitchTab(tab) {
  ['script','voice','style'].forEach(function(t) {
    var panel = document.getElementById('vtvPanel' + t.charAt(0).toUpperCase() + t.slice(1));
    var btn = document.getElementById('vtvTab' + t.charAt(0).toUpperCase() + t.slice(1));
    if (panel) panel.style.display = t === tab ? 'block' : 'none';
    if (btn) btn.classList.toggle('active', t === tab);
  });
}

function vtvUpdateStats() {
  var ta = document.getElementById('vtvScript');
  if (!ta) return;
  var text = ta.value.trim();
  var words = text ? text.split(/\s+/).length : 0;
  var lines = text ? text.split('\n').filter(function(l){ return l.trim().length > 0; }).length : 0;
  var rate = parseFloat((document.getElementById('vtvRate') || {value:'0.95'}).value) || 0.95;
  var secs = Math.round((words / (rate * 140)) * 60);
  var timeStr = secs < 60 ? secs + 's' : Math.floor(secs/60) + 'm ' + (secs%60) + 's';
  var wEl = document.getElementById('vtvStatWords');
  var lEl = document.getElementById('vtvStatLines');
  var tEl = document.getElementById('vtvStatTime');
  if (wEl) wEl.textContent = words;
  if (lEl) lEl.textContent = lines;
  if (tEl) tEl.textContent = timeStr;
}

function vtvSetCaption(btn, style) {
  document.querySelectorAll('.vtv-caption-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  _vtv.captionStyle = style;
  if (_vtv.canvas && !_vtv.playing) vtvDrawIdle();
}

function vtvFullscreen() {
  var c = document.getElementById('vtvCanvas');
  var w = document.getElementById('vtvCanvasWrap');
  var el = (c && c.style.display !== 'none') ? c : w;
  if (el && el.requestFullscreen) el.requestFullscreen();
  else if (el && el.webkitRequestFullscreen) el.webkitRequestFullscreen();
}

function vtvSeekClick(event, track) {
  if (!_vtv.lines.length) return;
  var rect = track.getBoundingClientRect();
  var pct = (event.clientX - rect.left) / rect.width;
  var idx = Math.floor(pct * _vtv.lines.length);
  idx = Math.max(0, Math.min(_vtv.lines.length - 1, idx));
  vtvStop();
  _vtv.currentLine = idx;
  setTimeout(function(){ vtvPlay(); }, 80);
}

function vtvSkipNext() {
  if (!_vtv.lines.length) return;
  var wasPlaying = _vtv.playing;
  speechSynthesis.cancel();
  cancelAnimationFrame(_vtv.animFrame);
  _vtv.currentLine = Math.min(_vtv.currentLine + 1, _vtv.lines.length - 1);
  if (wasPlaying || _vtv.paused) {
    _vtv.playing = true; _vtv.paused = false;
    document.getElementById('vtvPlayBtn').style.display = 'none';
    document.getElementById('vtvPauseBtn').style.display = '';
    vtvPlayLine();
  }
}

function vtvShowHelp() {
  notify('1. Paste your script  2. Build Preview  3. Choose Voice & Style  4. Play & screen-record!', 'info', 'ðŸ’¡');
}

function vtvDownloadScript() {
  var ta = document.getElementById('vtvScript');
  if (!ta || !ta.value.trim()) { notify('No script to save!', 'error', 'âš ï¸'); return; }
  var blob = new Blob([ta.value], {type:'text/plain'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url; a.download = 'script.txt';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
  notify('Script saved!', 'success', 'ðŸ’¾');
}

function vtvSetAnim(btn, anim) {
  document.querySelectorAll('.vtv-anim-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  _vtv.animStyle = anim;
}
function vtvSetFont(btn, style) {
  document.querySelectorAll('.vtv-font-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  _vtv.fontStyle = style;
}
function vtvUpdateStyle() {
  _vtv.bgColor = document.getElementById('vtvBg').value;
  _vtv.textColor = document.getElementById('vtvTextCol').value;
  _vtv.accentColor = document.getElementById('vtvAccent').value;
  if (_vtv.canvas && !_vtv.playing) vtvDrawIdle();
}

function vtvPopulateVoices() {
  var sel = document.getElementById('vtvVoice');
  if (!sel) return;
  var load = function() {
    var voices = speechSynthesis.getVoices();
    sel.innerHTML = '';
    var preferred = ['Google UK English Male','Google US English','Microsoft David','Alex','Daniel'];
    var sorted = voices.slice().sort(function(a,b){
      var ai = preferred.indexOf(a.name), bi = preferred.indexOf(b.name);
      if(ai===-1&&bi===-1) return a.name.localeCompare(b.name);
      if(ai===-1) return 1; if(bi===-1) return -1;
      return ai-bi;
    });
    sorted.forEach(function(v) {
      var opt = document.createElement('option');
      opt.value = v.name;
      opt.textContent = v.name + ' (' + v.lang + ')';
      sel.appendChild(opt);
    });
  };
  load();
  if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = load;
}

// Split a text block into caption-sized chunks
function _vtvChunkText(text) {
  var chunks = [];
  var sentences = text.match(/[^.!?]+[.!?]*/g) || [text];
  sentences.forEach(function(s) {
    s = s.trim();
    if (!s) return;
    if (s.length > 120) {
      var parts = s.split(/,\s*/);
      var current = '';
      parts.forEach(function(p) {
        if ((current + p).length > 100 && current) { chunks.push(current.trim()); current = p + ', '; }
        else { current += p + ', '; }
      });
      if (current.trim()) chunks.push(current.replace(/,\s*$/, '').trim());
    } else {
      chunks.push(s);
    }
  });
  return chunks;
}

async function vtvPrepare() {
  var raw = (document.getElementById('vtvScript').value || '').trim();
  if (!raw) { notify('Please paste a script first!', 'error', 'âš ï¸'); return; }

  // Disable button while processing
  var buildBtn = document.querySelector('[onclick="vtvPrepare()"]');
  if (buildBtn) { buildBtn.disabled = true; buildBtn.textContent = 'â³ Processing scriptâ€¦'; }

  // â”€â”€ Parse script: separate spoken text from [direction] tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Collect raw tokens: { type: 'text'|'direction', value: string }
  var tokens = [];
  // Walk line by line
  raw.split('\n').forEach(function(line) {
    line = line.trim();
    if (!line) return;
    // Strip markdown section headers (emoji + heading text on its own line)
    if (/^[ðŸªðŸ“ðŸŽ¯ðŸ’¡ðŸ“£#]/.test(line) && line.length < 60) return;
    // Extract all [bracket] tags from the line plus the remaining spoken text
    var remaining = line;
    var bracketRe = /\[([^\]]+)\]/g;
    var match;
    var lastIdx = 0;
    while ((match = bracketRe.exec(line)) !== null) {
      // Text before this bracket
      var before = line.slice(lastIdx, match.index).trim();
      if (before) tokens.push({ type: 'text', value: before });
      // The direction inside brackets
      tokens.push({ type: 'direction', value: match[1].trim() });
      lastIdx = match.index + match[0].length;
    }
    var after = line.slice(lastIdx).trim();
    if (after) tokens.push({ type: 'text', value: after });
  });

  // â”€â”€ Expand directions via AI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Collect all directions so we can batch one AI call
  var directionTokens = tokens.filter(function(t){ return t.type === 'direction'; });

  if (directionTokens.length > 0) {
    notify('ðŸ¤– AI is interpreting ' + directionTokens.length + ' direction(s)â€¦', 'info', 'â³');
    var dirList = directionTokens.map(function(t, i){ return (i+1) + '. [' + t.value + ']'; }).join('\n');
    try {
      var aiRaw = await callClaude([{
        role: 'user',
        content: 'You are a video narrator. For each stage direction below, write ONE short spoken sentence (max 15 words) that a narrator would say to describe or transition to that moment. Only output a numbered list matching the input, nothing else.\n\n' + dirList
      }], 'Video script narrator', 600);

      // Parse numbered list back into replacements
      var aiLines = (aiRaw || '').split('\n').filter(function(l){ return /^\d+\./.test(l.trim()); });
      directionTokens.forEach(function(t, i) {
        var aiLine = aiLines[i] ? aiLines[i].replace(/^\d+\.\s*/, '').trim() : '';
        t.expanded = aiLine || ''; // empty = skip this direction silently
      });
    } catch(e) {
      console.warn('[VTV] AI direction expansion failed:', e.message);
      directionTokens.forEach(function(t){ t.expanded = ''; });
    }
  }

  // â”€â”€ Build final chunks list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var chunks = [];
  // Also store direction hints for scene image prompts
  _vtv.directionHints = {}; // chunkIndex -> direction text for image gen

  tokens.forEach(function(t) {
    if (t.type === 'text') {
      _vtvChunkText(t.value).forEach(function(c){ chunks.push(c); });
    } else if (t.type === 'direction') {
      // Add the AI-generated spoken sentence (if any)
      if (t.expanded) {
        var expanded = _vtvChunkText(t.expanded);
        expanded.forEach(function(c) {
          _vtv.directionHints[chunks.length] = t.value; // tag this chunk as direction-sourced
          chunks.push(c);
        });
      }
      // Even if no spoken text, store the direction hint for the next caption's image
      // so the scene image reflects the b-roll direction
      _vtv.pendingDirectionHint = t.value;
    }
  });

  // Apply pending direction hints to the following text chunk
  // (already handled above via directionHints map)

  if (buildBtn) { buildBtn.disabled = false; buildBtn.textContent = 'ðŸŽ¬ Build Video Preview'; }
  if (!chunks.length) { notify('No readable lines found in script.', 'error', 'âš ï¸'); return; }
  _vtv.lines = chunks;
  _vtv.currentLine = 0;
  _vtv.playing = false;
  _vtv.paused = false;

  // Show canvas
  var wrap = document.getElementById('vtvCanvasWrap');
  var canvas = document.getElementById('vtvCanvas');
  if (wrap) wrap.style.display = 'none';
  if (canvas) canvas.style.display = 'block';
  _vtv.canvas = canvas;
  canvas.width = 1280;
  canvas.height = 720;
  _vtv.ctx = canvas.getContext('2d');

  vtvDrawIdle();

  var ctrl = document.getElementById('vtvControlsCard');
  if (ctrl) { ctrl.style.display = 'block'; ctrl.style.animation = 'slideUp 0.3s ease'; }

  // Build line list
  var list = document.getElementById('vtvLineList');
  var items = document.getElementById('vtvLineItems');
  if (list && items) {
    list.style.display = 'block';
    items.innerHTML = chunks.map(function(l, i) {
      var isDir = _vtv.directionHints && _vtv.directionHints[i];
      return '<div id="vtv-line-'+i+'" class="vtv-line-item" onclick="vtvJumpTo('+i+')"' + (isDir ? ' style="border-color:rgba(0,229,176,0.25);background:rgba(0,229,176,0.05)"' : '') + '><span class="vtv-line-num">'+(i+1)+'</span>' + (isDir ? '<span style="font-size:9px;color:var(--teal);font-weight:900;flex-shrink:0">AI</span>' : '') + '<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;' + (isDir ? 'color:var(--teal);font-style:italic' : '') + '">'+l+'</span></div>';
    }).join('');
  }

  var lc = document.getElementById('vtvLineCount');
  var st = document.getElementById('vtvStatusText');
  if (lc) lc.textContent = '0 / ' + chunks.length;
  if (st) st.textContent = 'Ready â€” press Play';
  notify('âœ… ' + chunks.length + ' captions ready. Hit Play!', 'success', 'ðŸŽ¬');

  // Show AI scene images panel
  var imgPanel = document.getElementById('vtvImgPanel');
  if (imgPanel) imgPanel.style.display = 'block';
  // Reset scene images
  _vtv.sceneImages = new Array(chunks.length).fill(null);
  var strip = document.getElementById('vtvImgStrip');
  if (strip) strip.innerHTML = '';
  var toggle = document.getElementById('vtvImgToggle');
  if (toggle && toggle.checked) {
    vtvToggleSceneImages(true);
  }
}

// â”€â”€ AI SCENE IMAGE GENERATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function vtvToggleSceneImages(on) {
  _vtv.useSceneImages = on;
  var track = document.getElementById('vtvImgToggleTrack');
  var thumb = document.getElementById('vtvImgToggleThumb');
  if (track) track.style.background = on ? 'var(--teal)' : 'var(--border2)';
  if (thumb) thumb.style.left = on ? '21px' : '3px';

  if (on && _vtv.lines.length > 0) {
    // Check if we already have images
    var have = _vtv.sceneImages.filter(function(x){ return x; }).length;
    if (have === 0) vtvGenerateSceneImages();
    else {
      var st = document.getElementById('vtvImgStatus');
      if (st) st.textContent = 'âœ… ' + have + ' scene images active';
    }
  } else {
    var st = document.getElementById('vtvImgStatus');
    if (st) st.textContent = on ? '' : 'Scene images off â€” using theme backgrounds';
    if (!on && _vtv.canvas && !_vtv.playing) vtvDrawIdle();
  }
}

async function vtvGenerateSceneImages() {
  var lines = _vtv.lines;
  if (!lines.length) return;

  var statusEl = document.getElementById('vtvImgStatus');
  var stripEl  = document.getElementById('vtvImgStrip');
  if (statusEl) statusEl.innerHTML = '<span style="color:var(--teal)">â³ Generating ' + lines.length + ' scene imagesâ€¦</span>';
  if (stripEl) stripEl.innerHTML = '';

  // Group lines into scenes (max 12)
  var maxScenes = Math.min(lines.length, 12);
  var step = lines.length / maxScenes;
  var scenePrompts = [];
  for (var i = 0; i < maxScenes; i++) {
    var lineIdx = Math.round(i * step);
    var caption = lines[lineIdx] || lines[0];
    var dirHint = (_vtv.directionHints && _vtv.directionHints[lineIdx]) || '';
    var promptBase = dirHint ? dirHint : caption;
    scenePrompts.push({ prompt: promptBase, lineIdx: lineIdx });
  }

  var imgForLine = new Array(lines.length).fill(null);
  _vtv.sceneImages = imgForLine;

  // Generate all scenes as canvas images (no network needed)
  for (var si = 0; si < scenePrompts.length; si++) {
    var scene = scenePrompts[si];
    var img = _vtvRenderSceneCanvas(scene.prompt, si, maxScenes);

    // Assign to line range
    var nextIdx = si < scenePrompts.length - 1 ? scenePrompts[si + 1].lineIdx : lines.length;
    for (var li = scene.lineIdx; li < nextIdx; li++) imgForLine[li] = img;
    if (si === 0) { for (var li2 = 0; li2 < scene.lineIdx; li2++) imgForLine[li2] = img; }

    // Thumbnail strip
    if (stripEl) {
      var thumb = document.createElement('img');
      thumb.src = img.src;
      thumb.style.cssText = 'height:48px;width:auto;border-radius:6px;border:1px solid var(--border);object-fit:cover;cursor:pointer';
      thumb.title = scene.prompt;
      (function(idx){ thumb.onclick = function(){ vtvPreviewSceneImage(idx); }; })(si);
      stripEl.appendChild(thumb);
    }
    tvImgLibSave(img.src, scene.prompt, 'video-scene');
    if (statusEl) statusEl.innerHTML = '<span style="color:var(--teal)">â³ ' + (si+1) + ' / ' + scenePrompts.length + ' scenes readyâ€¦</span>';
  }

  // Fill any gaps
  var lastImg = null;
  for (var li3 = 0; li3 < imgForLine.length; li3++) {
    if (imgForLine[li3]) lastImg = imgForLine[li3]; else if (lastImg) imgForLine[li3] = lastImg;
  }
  lastImg = null;
  for (var li4 = imgForLine.length - 1; li4 >= 0; li4--) {
    if (imgForLine[li4]) lastImg = imgForLine[li4]; else if (lastImg) imgForLine[li4] = lastImg;
  }

  _vtv.sceneImages = imgForLine;
  if (statusEl) statusEl.innerHTML = '<span style="color:var(--teal)">âœ… ' + scenePrompts.length + ' scene images ready</span>';
  if (!_vtv.playing) vtvDrawIdle();
}

// â”€â”€ Canvas-based scene image renderer (no network required) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _vtvRenderSceneCanvas(prompt, sceneIdx, totalScenes) {
  var seed = sceneIdx * 9999 + 42;
  var dataUrl = _imgRenderCanvas(prompt, 1280, 720, seed, null);
  var imgEl = new Image();
  imgEl.src = dataUrl;
  return imgEl;
}

function vtvPreviewSceneImage(sceneIdx) {
  // Flash a quick preview of the scene image on the canvas
  var ctx = _vtv.ctx, c = _vtv.canvas;
  if (!ctx || !c) return;
  var img = _vtv.sceneImages[sceneIdx];
  if (!img) return;
  ctx.drawImage(img, 0, 0, c.width, c.height);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function vtvDrawBg(ctx, W, H) {
  // If AI scene images are active, draw the current scene image as background
  if (_vtv.useSceneImages && _vtv.sceneImages && _vtv.sceneImages.length) {
    var lineImg = _vtv.sceneImages[_vtv.currentLine] || null;
    if (!lineImg && _vtv.sceneImages.length > 0) {
      // fallback: any available image
      lineImg = _vtv.sceneImages.find(function(x){ return x; }) || null;
    }
    if (lineImg) {
      try {
        // Draw full-bleed image
        ctx.drawImage(lineImg, 0, 0, W, H);
        // Dark cinematic overlay so text stays readable
        ctx.fillStyle = 'rgba(0,0,0,0.45)';
        ctx.fillRect(0, 0, W, H);
        return;
      } catch(e) { /* fall through to normal bg */ }
    }
  }

  var s = _vtv.bgStyle || 'dark';
  if (s === 'gradient') {
    var grd = ctx.createLinearGradient(0, 0, W, H);
    grd.addColorStop(0, _vtv.bgColor);
    grd.addColorStop(1, _vtv.accentColor + '33');
    ctx.fillStyle = grd;
  } else if (s === 'cinematic') {
    var grd2 = ctx.createRadialGradient(W/2, H/2, 0, W/2, H/2, W*0.75);
    grd2.addColorStop(0, _vtv.bgColor);
    grd2.addColorStop(1, '#000000');
    ctx.fillStyle = grd2;
  } else if (s === 'neon') {
    ctx.fillStyle = _vtv.bgColor;
    ctx.fillRect(0, 0, W, H);
    // neon glow circles
    var g1 = ctx.createRadialGradient(W*0.2, H*0.3, 0, W*0.2, H*0.3, 300);
    g1.addColorStop(0, _vtv.accentColor + '22');
    g1.addColorStop(1, 'transparent');
    ctx.fillStyle = g1;
    ctx.fillRect(0, 0, W, H);
    var g2 = ctx.createRadialGradient(W*0.8, H*0.7, 0, W*0.8, H*0.7, 250);
    g2.addColorStop(0, '#a78bfa22');
    g2.addColorStop(1, 'transparent');
    ctx.fillStyle = g2;
    ctx.fillRect(0, 0, W, H);
    return;
  } else if (s === 'purple') {
    var grd3 = ctx.createLinearGradient(0, 0, W, H);
    grd3.addColorStop(0, '#0b0514');
    grd3.addColorStop(0.5, '#1a0a2e');
    grd3.addColorStop(1, '#0b0514');
    ctx.fillStyle = grd3;
  } else {
    ctx.fillStyle = _vtv.bgColor;
  }
  ctx.fillRect(0, 0, W, H);

  // Subtle grid
  ctx.strokeStyle = 'rgba(255,255,255,0.025)';
  ctx.lineWidth = 1;
  for(var x=0;x<W;x+=80){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(var y=0;y<H;y+=80){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
}

function vtvDrawIdle() {
  var ctx = _vtv.ctx, c = _vtv.canvas;
  if (!ctx) return;
  var W = c.width, H = c.height;
  vtvDrawBg(ctx, W, H);

  // Logo top-left
  ctx.font = '900 22px Syne,sans-serif';
  ctx.fillStyle = _vtv.accentColor;
  ctx.textAlign = 'left';
  ctx.globalAlpha = 0.9;
  ctx.fillText('TRENDVID', 44, 50);
  ctx.globalAlpha = 1;

  // Caption position label bottom-left
  var capLabel = { centered:'Center', 'lower-third':'Lower Third', top:'Top' }[_vtv.captionStyle] || 'Center';
  ctx.font = '700 14px DM Sans,sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.2)';
  ctx.textAlign = 'left';
  ctx.fillText('Caption: ' + capLabel + '  Â·  Anim: ' + _vtv.animStyle, 44, H - 36);

  // Center message
  ctx.textAlign = 'center';
  ctx.font = '800 28px DM Sans,sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.18)';
  ctx.fillText('Ready â€” press Play', W/2, H/2 + 8);
  ctx.font = '400 15px DM Sans,sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.1)';
  ctx.fillText(_vtv.lines.length + ' captions loaded', W/2, H/2 + 38);

  // Bottom bar
  ctx.fillStyle = _vtv.accentColor;
  ctx.globalAlpha = 0.25;
  ctx.fillRect(0, H - 8, W, 8);
  ctx.globalAlpha = 1;
}

function vtvDrawFrame(line, progress, animStyle) {
  var ctx = _vtv.ctx, c = _vtv.canvas;
  var W = c.width, H = c.height;

  vtvDrawBg(ctx, W, H);

  // Overall progress bar at bottom
  ctx.fillStyle = 'rgba(255,255,255,0.07)';
  ctx.fillRect(0, H-8, W, 8);
  ctx.fillStyle = _vtv.accentColor;
  var totalPct = (_vtv.currentLine + progress) / _vtv.lines.length;
  ctx.fillRect(0, H-8, W * totalPct, 8);

  // Logo top-left
  ctx.font = '900 20px Syne,sans-serif';
  ctx.fillStyle = _vtv.accentColor;
  ctx.textAlign = 'left';
  ctx.globalAlpha = 0.75;
  ctx.fillText('TRENDVID', 44, 46);
  ctx.globalAlpha = 1;

  // Line counter top-right
  ctx.font = '700 15px DM Sans,sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.22)';
  ctx.textAlign = 'right';
  ctx.fillText((_vtv.currentLine+1) + ' / ' + _vtv.lines.length, W-44, 46);

  // Compute animation alpha/offset/scale
  var alpha = 1, offsetY = 0, scale = 1;
  var t = progress;
  var visibleChars = line.length; // for typewriter

  if (animStyle === 'fade') {
    if (t < 0.15) alpha = t / 0.15;
    else if (t > 0.82) alpha = (1 - t) / 0.18;
  } else if (animStyle === 'slide') {
    if (t < 0.18) { alpha = t/0.18; offsetY = 50*(1-t/0.18); }
    else if (t > 0.82) { alpha = (1-t)/0.18; offsetY = -24*((t-0.82)/0.18); }
  } else if (animStyle === 'pop') {
    if (t < 0.12) { scale = 0.65 + 0.35*(t/0.12); alpha = t/0.12; }
    else if (t < 0.22) { scale = 1.0 + 0.07*Math.sin((t-0.12)/0.10*Math.PI); }
    else if (t > 0.82) { alpha = (1-t)/0.18; scale = 1 - 0.18*((t-0.82)/0.18); }
  } else if (animStyle === 'typewriter') {
    visibleChars = Math.floor(t < 0.7 ? (t/0.7)*line.length : line.length);
    if (t > 0.85) alpha = (1-t)/0.15;
  }

  ctx.save();
  ctx.globalAlpha = Math.max(0, Math.min(1, alpha));

  // Caption Y position
  var capStyle = _vtv.captionStyle || 'centered';
  var capCenterY = capStyle === 'lower-third' ? H * 0.78 : capStyle === 'top' ? H * 0.22 : H * 0.5;

  // Font size
  var dispLine = animStyle === 'typewriter' ? line.substring(0, visibleChars) : line;
  var maxWidth = W - 180;
  var fontWeight = _vtv.fontStyle === 'bold' ? '800' : '400';
  var fontItalic = _vtv.fontStyle === 'italic' ? 'italic ' : '';
  var fontSize = line.length > 80 ? 38 : line.length > 50 ? 46 : 56;
  ctx.font = fontItalic + fontWeight + ' ' + fontSize + 'px DM Sans,sans-serif';
  ctx.textAlign = 'center';

  // Word-wrap
  var words = dispLine.split(' ');
  var wrappedLines = [];
  var cur = '';
  words.forEach(function(w) {
    var test = cur ? cur + ' ' + w : w;
    if (ctx.measureText(test).width > maxWidth && cur) { wrappedLines.push(cur); cur = w; }
    else { cur = test; }
  });
  if (cur) wrappedLines.push(cur);

  var lineH = fontSize * 1.4;
  var totalH = wrappedLines.length * lineH;
  var startY = capCenterY - totalH/2 + offsetY;

  // Lower-third: draw a background pill
  if (capStyle === 'lower-third') {
    var pillH = totalH + 36;
    var pillY = startY - 18;
    ctx.save();
    ctx.globalAlpha = ctx.globalAlpha * 0.72;
    ctx.fillStyle = 'rgba(0,0,0,0.65)';
    var pillW = maxWidth + 80;
    var px = (W - pillW) / 2;
    ctx.beginPath();
    if (ctx.roundRect) { ctx.roundRect(px, pillY, pillW, pillH, 16); } else { ctx.rect(px, pillY, pillW, pillH); }
    ctx.fill();
    ctx.restore();
  }

  if (scale !== 1) {
    ctx.translate(W/2, capCenterY + offsetY);
    ctx.scale(scale, scale);
    ctx.translate(-W/2, -(capCenterY + offsetY));
  }

  wrappedLines.forEach(function(wl, i) {
    var x = W/2;
    var y = startY + i * lineH + fontSize;

    // Text shadow / glow
    ctx.shadowColor = _vtv.accentColor;
    ctx.shadowBlur = 20;

    // Draw full line in text color
    ctx.fillStyle = _vtv.textColor;
    ctx.shadowBlur = 8;
    ctx.fillText(wl, x, y);

    // First word accent highlight
    var parts = wl.split(' ');
    if (parts.length > 1) {
      ctx.shadowBlur = 24;
      ctx.fillStyle = _vtv.accentColor;
      var firstWord = parts[0];
      var restWidth = ctx.measureText(wl).width;
      var firstWidth = ctx.measureText(firstWord).width;
      var offsetX = -restWidth/2;
      ctx.textAlign = 'left';
      ctx.fillText(firstWord, x + offsetX, y);
      ctx.textAlign = 'center';
    }
  });

  ctx.restore();
  ctx.shadowBlur = 0;

  // Typewriter cursor blink
  if (animStyle === 'typewriter' && t < 0.7 && visibleChars < line.length) {
    var blink = Math.floor(Date.now() / 400) % 2 === 0;
    if (blink) {
      var lastLine = wrappedLines[wrappedLines.length - 1] || '';
      var cursorX = W/2 + ctx.measureText(lastLine).width/2 + 6;
      var cursorY = startY + (wrappedLines.length - 1) * lineH + fontSize;
      ctx.fillStyle = _vtv.accentColor;
      ctx.fillRect(cursorX, cursorY - fontSize * 0.8, 3, fontSize * 0.9);
    }
  }
}

function vtvPlay() {
  if (_vtv.paused) { vtvResume(); return; }
  if (!_vtv.lines.length) { notify('Build the video preview first!','error','âš ï¸'); return; }
  _vtv.playing = true;
  _vtv.paused = false;
  _vtv.currentLine = 0;
  var pb = document.getElementById('vtvPlayBtn');
  var pause = document.getElementById('vtvPauseBtn');
  if (pb) pb.style.display = 'none';
  if (pause) pause.style.display = '';
  var st = document.getElementById('vtvStatusText');
  if (st) st.textContent = 'Playing...';
  speechSynthesis.cancel();
  vtvPlayLine();
}

function vtvPlayLine() {
  if (!_vtv.playing) return;
  var idx = _vtv.currentLine;
  if (idx >= _vtv.lines.length) { vtvEnd(); return; }

  var line = _vtv.lines[idx];
  var lc = document.getElementById('vtvLineCount');
  var pb = document.getElementById('vtvProgressBar');
  if (lc) lc.textContent = (idx+1) + ' / ' + _vtv.lines.length;
  if (pb) pb.style.width = (((_vtv.currentLine) / _vtv.lines.length) * 100) + '%';

  // Highlight current line
  document.querySelectorAll('[id^="vtv-line-"]').forEach(function(el) { el.style.background=''; el.style.color='var(--text2)'; el.style.borderColor=''; });
  var activeEl = document.getElementById('vtv-line-' + idx);
  if (activeEl) { activeEl.style.background='rgba(255,48,88,0.12)'; activeEl.style.color='var(--text)'; activeEl.style.borderColor='rgba(255,48,88,0.4)'; activeEl.scrollIntoView({block:'nearest',behavior:'smooth'}); }

  // TTS
  var voices = speechSynthesis.getVoices();
  var selVoice = document.getElementById('vtvVoice');
  var chosenVoice = voices.find(function(v){ return v.name === (selVoice ? selVoice.value : ''); }) || voices[0];
  var rate = parseFloat((document.getElementById('vtvRate')||{value:'0.95'}).value) || 0.95;
  var pitch = parseFloat((document.getElementById('vtvPitch')||{value:'1.0'}).value) || 1.0;

  var utt = new SpeechSynthesisUtterance(line);
  if (chosenVoice) utt.voice = chosenVoice;
  utt.rate = rate;
  utt.pitch = pitch;
  utt.volume = _vtv.volume || 1.0;
  _vtv.utterance = utt;

  // Estimate duration from word count
  var words = line.split(' ').length;
  var estSecs = (words / (rate * 140)) * 60; // ~140wpm base
  _vtv.lineDuration = Math.max(estSecs, 1.2) * 1000;
  _vtv.lineStartTime = Date.now();
  _vtv.progress = 0;

  var animStyle = _vtv.animStyle;

  function animate() {
    if (!_vtv.playing || _vtv.paused) return;
    var elapsed = Date.now() - _vtv.lineStartTime;
    _vtv.progress = Math.min(elapsed / _vtv.lineDuration, 1);
    vtvDrawFrame(line, _vtv.progress, animStyle);
    if (_vtv.progress < 1) {
      _vtv.animFrame = requestAnimationFrame(animate);
    }
  }
  _vtv.animFrame = requestAnimationFrame(animate);

  utt.onend = function() {
    if (!_vtv.playing) return;
    cancelAnimationFrame(_vtv.animFrame);
    vtvDrawFrame(line, 0.9, animStyle);
    _vtv.currentLine++;
    setTimeout(vtvPlayLine, 120);
  };
  utt.onerror = function() {
    _vtv.currentLine++;
    setTimeout(vtvPlayLine, 100);
  };

  speechSynthesis.speak(utt);
}

function vtvPause() {
  if (!_vtv.playing) return;
  _vtv.paused = true;
  _vtv.playing = false;
  speechSynthesis.pause();
  cancelAnimationFrame(_vtv.animFrame);
  var pb = document.getElementById('vtvPauseBtn');
  var pla = document.getElementById('vtvPlayBtn');
  var st = document.getElementById('vtvStatusText');
  if (pb) pb.style.display = 'none';
  if (pla) { pla.style.display = ''; pla.textContent = 'â–¶'; pla.title = 'Resume'; }
  if (st) st.textContent = 'Paused';
}

function vtvResume() {
  _vtv.playing = true;
  _vtv.paused = false;
  speechSynthesis.resume();
  var pb = document.getElementById('vtvPlayBtn');
  var pause = document.getElementById('vtvPauseBtn');
  var st = document.getElementById('vtvStatusText');
  if (pb) pb.style.display = 'none';
  if (pause) pause.style.display = '';
  if (st) st.textContent = 'Playing...';
  // Re-animate current frame
  var line = _vtv.lines[_vtv.currentLine];
  var animStyle = _vtv.animStyle;
  function animate() {
    if (!_vtv.playing || _vtv.paused) return;
    var elapsed = Date.now() - _vtv.lineStartTime;
    _vtv.progress = Math.min(elapsed / _vtv.lineDuration, 1);
    vtvDrawFrame(line, _vtv.progress, animStyle);
    if (_vtv.progress < 1) _vtv.animFrame = requestAnimationFrame(animate);
  }
  _vtv.animFrame = requestAnimationFrame(animate);
}

function vtvStop() {
  _vtv.playing = false;
  _vtv.paused = false;
  speechSynthesis.cancel();
  cancelAnimationFrame(_vtv.animFrame);
  _vtv.currentLine = 0;
  var pb = document.getElementById('vtvPlayBtn');
  var pause = document.getElementById('vtvPauseBtn');
  var prog = document.getElementById('vtvProgressBar');
  var lc = document.getElementById('vtvLineCount');
  var st = document.getElementById('vtvStatusText');
  if (pb) { pb.style.display = ''; pb.textContent = 'â–¶'; }
  if (pause) pause.style.display = 'none';
  if (prog) prog.style.width = '0%';
  if (lc) lc.textContent = '0 / ' + _vtv.lines.length;
  if (st) st.textContent = 'Stopped';
  document.querySelectorAll('[id^="vtv-line-"]').forEach(function(el){ el.style.background=''; el.style.color=''; el.style.borderColor=''; });
  vtvDrawIdle();
}

function vtvEnd() {
  _vtv.playing = false;
  var pb = document.getElementById('vtvPlayBtn');
  var pause = document.getElementById('vtvPauseBtn');
  var prog = document.getElementById('vtvProgressBar');
  var st = document.getElementById('vtvStatusText');
  if (pb) { pb.style.display = ''; pb.textContent = 'â–¶'; pb.title = 'Play Again'; }
  if (pause) pause.style.display = 'none';
  if (prog) prog.style.width = '100%';
  if (st) st.textContent = 'âœ… Done!';
  // Draw final frame
  var ctx = _vtv.ctx, c = _vtv.canvas;
  if (!ctx || !c) return;
  vtvDrawBg(ctx, c.width, c.height);
  ctx.font = '900 56px Syne,sans-serif';
  ctx.fillStyle = _vtv.accentColor;
  ctx.textAlign = 'center';
  ctx.shadowColor = _vtv.accentColor;
  ctx.shadowBlur = 40;
  ctx.fillText("That's a wrap! ðŸŽ¬", c.width/2, c.height/2 - 16);
  ctx.shadowBlur = 0;
  ctx.font = '400 20px DM Sans,sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.4)';
  ctx.fillText('Screen-record this window to save your video', c.width/2, c.height/2 + 34);
  notify('ðŸŽ¬ Video done! Screen-record to save it.', 'success', 'ðŸŽ¬');
}

function vtvJumpTo(idx) {
  if (!_vtv.lines.length) return;
  vtvStop();
  _vtv.currentLine = idx;
  setTimeout(function(){ vtvPlay(); }, 100);
}


function downloadAppFile() {
  if (!currentUser || !currentUser.isAdmin) { notify('Admin access required', 'error', 'ðŸ”’'); return; }
  try {
    const html = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'index.html';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    notify('Downloaded as index.html â€” drag it onto Netlify to deploy! ðŸš€', 'success', 'ðŸ“¦');
  } catch(e) {
    notify('Download failed: ' + e.message, 'error', 'âš ï¸');
  }
}
function saveGeminiKey(){
  const k=document.getElementById('geminiKeyInput').value.trim();
  if(!k||k.startsWith('â€¢')){notify('Paste your actual Gemini key','error','âš ï¸');return;}
  _geminiKey=k;
  _SHARED_GEMINI_KEY=k;
  // Write to shared slot â€” this is what all users will read
  localStorage.setItem('tv_gemini_key_shared',k);
  localStorage.setItem('tv_gemini_key',k);
  // Also embed into the active Gemini provider so it works immediately
  var gemProv = _aiProviders.find(function(p){return p.type==='gemini';});
  if(gemProv){ gemProv.key=k; saveAIProviders(); }
  notify('Gemini key saved â€” all users will now use this key automatically âœ…','success','ðŸ”®');
  renderSettings();
}
function clearGeminiKey(){
  _geminiKey='';
  _SHARED_GEMINI_KEY='';
  localStorage.removeItem('tv_gemini_key');
  localStorage.removeItem('tv_gemini_key_shared');
  var gemProv = _aiProviders.find(function(p){return p.type==='gemini';});
  if(gemProv){ gemProv.key=''; saveAIProviders(); }
  notify('Gemini key removed','info','ðŸ—‘ï¸');
  renderSettings();
}

// ============================================================
// HELP & AI CHAT
// ============================================================
let chatHistory=[];
let chatBusy=false;
const SMART_SUGS=[
  {label:'ðŸª Write me 5 hooks',msg:'Write me 5 different viral hook styles for a tech YouTube video'},
  {label:'ðŸ“± TikTok algorithm',msg:'How does the TikTok algorithm work in 2025?'},
  {label:'ðŸ–¼ï¸ Thumbnail formula',msg:'Give me the exact formula for a high-CTR YouTube thumbnail'},
  {label:'ðŸŽ¯ Find my niche',msg:'How do I find a profitable niche that I can actually rank in?'},
  {label:'ðŸ“… Posting schedule',msg:'What\'s the ideal posting schedule for a new YouTube channel?'},
  {label:'ðŸ’° Monetization',msg:'How do I monetize my channel before hitting 1000 subscribers?'},
  {label:'ðŸ“ˆ First 1000 subs',msg:'What\'s the fastest way to get my first 1000 YouTube subscribers?'},
  {label:'âœï¸ Scripting help',msg:'What\'s the best structure for a 10-minute YouTube video?'},
];
function renderHelp(){
  document.getElementById('pageContent').innerHTML=`
    <div class="help-layout">
      <div class="help-info">
        <div class="card" style="margin-bottom:14px">
          <div class="section-label" style="margin-bottom:14px">GETTING STARTED</div>
          ${[
            ['How do I find trending topics?','Go to Trend Radar and click "Refresh Trends". The AI scans YouTube, TikTok, and Instagram and surfaces the hottest topics. Filter by platform or category for targeted results.'],
            ['How does the Script Generator work?','Enter your topic, choose platform and tone, then hit Generate. The AI writes a full script with hook, intro, main content, key takeaway and CTA â€” ready to film.'],
            ['Can I use TrendVid for TikTok and Instagram?','Absolutely. When generating scripts, select your platform and the AI adapts format, length and language. The Multi-Language tool lets you translate scripts into 20+ languages.'],
            ['How do I save my work?','After generating a script, click the Save button to add it to your Script Library. Star trends to save them to Favourites.'],
            ['What is the Affiliate programme?','Earn 30% commission on every creator you refer to TrendVid. Go to the Affiliate page to get your unique link.'],
            ['Why is AI not working?','Make sure you\'re serving the file from a web server (not opening directly as a file). See Settings to check your provider status.'],
          ].map(([q,a])=>`
            <div style="margin-bottom:2px">
              <div class="help-q" onclick="this.classList.toggle('open')">${q}<span class="help-q-arrow">â–¾</span></div>
              <div class="help-a">${a}</div>
            </div><div class="divider"></div>`).join('')}
        </div>
        <div class="card">
          <div class="section-label" style="margin-bottom:12px">ðŸ’¡ CREATOR TIPS</div>
          <div style="display:flex;flex-direction:column;gap:12px;font-size:13px;color:var(--text2)">
            ${[['ðŸ”¥','Act on a trend when it\'s <strong style="color:var(--text)">Rising</strong>, not already Hot â€” you\'ll be ahead of the wave.'],['ðŸª','Your first 3 seconds decide everything. Read hooks out loud before filming â€” if it sounds awkward, rewrite it.'],['ðŸŽ¨','High-contrast thumbnails with fewer than 6 words and a human face get 40-60% better CTR on average.'],['ðŸ“…','Use the AI Fill Month button on the calendar to auto-generate 30 days of content ideas in seconds.']].map(([e,t])=>`<div style="display:flex;gap:10px;align-items:flex-start"><span style="font-size:17px">${e}</span><span>${t}</span></div>`).join('')}
          </div>
        </div>
      </div>
      <div class="chat-container">
        <div class="chat-header">
          <div class="chat-av" style="background:linear-gradient(135deg,var(--accent),var(--purple))">ðŸ¤–</div>
          <div style="flex:1">
            <div style="font-weight:800;font-size:14px;font-family:var(--font-display)">TrendVid AI Coach</div>
            <div class="chat-online"><span style="width:6px;height:6px;background:var(--teal);border-radius:50%;display:inline-block;margin-right:5px"></span>Online Â· Creator growth specialist</div>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="chatHistory=[];document.getElementById('chatMessages').innerHTML='';renderWelcomeMsg()">â†º Reset</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div style="padding:8px 12px;border-top:1px solid var(--border)">
          <div style="font-size:9px;font-weight:800;color:var(--muted);letter-spacing:1.5px;margin-bottom:7px;font-family:var(--font-display)">QUICK PROMPTS</div>
          <div class="chat-sugs" id="chatSugs" style="display:flex;flex-wrap:wrap;gap:5px">
            ${SMART_SUGS.slice(0,6).map(s=>`<div class="chat-sug" onclick="sendSug('${esc(s.msg)}')">${s.label}</div>`).join('')}
          </div>
        </div>
        <div class="chat-input-row">
          <input class="chat-inp" id="chatInp" placeholder="Ask anything about growth, scripts, thumbnailsâ€¦" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat();}">
          <button class="chat-send" id="chatSendBtn" onclick="sendChat()">âž¤</button>
        </div>
      </div>
    </div>

    <!-- CONTACT ADMIN -->
    <div class="card" style="margin-top:20px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
        <span style="font-size:22px">âœ‰ï¸</span>
        <div>
          <div style="font-size:14px;font-weight:800;font-family:var(--font-display)">Message the TrendVid Team</div>
          <div style="font-size:12px;color:var(--muted)">Send a personal message directly to Matthew â€” bug reports, feature requests, billing questions, anything.</div>
        </div>
      </div>
      <div style="margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="form-field" style="margin:0">
          <label>Your Name</label>
          <input class="form-input" id="contactName" type="text" placeholder="Your name" value="${currentUser&&currentUser.name?currentUser.name:''}" maxlength="80">
        </div>
        <div class="form-field" style="margin:0">
          <label>Your Email (for reply)</label>
          <input class="form-input" id="contactEmail" type="email" placeholder="your@email.com" value="${currentUser&&currentUser.email?currentUser.email:''}" maxlength="120">
        </div>
      </div>
      <div class="form-field" style="margin-top:10px">
        <label>Subject</label>
        <select class="form-input form-select" id="contactSubject">
          <option value="bug">ðŸ› Bug Report</option>
          <option value="feature">ðŸ’¡ Feature Request</option>
          <option value="billing">ðŸ’³ Billing Question</option>
          <option value="account">ðŸ‘¤ Account Issue</option>
          <option value="praise">ðŸŒŸ Positive Feedback</option>
          <option value="other">ðŸ’¬ Other</option>
        </select>
      </div>
      <div class="form-field" style="margin-top:10px">
        <label>Message</label>
        <textarea class="form-input" id="contactMessage" rows="4" placeholder="Describe your question or issue in as much detail as possible..." maxlength="2000" style="resize:vertical"></textarea>
        <div style="font-size:10px;color:var(--muted);margin-top:4px;text-align:right"><span id="contactCharCount">0</span>/2000</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;margin-top:4px">
        <button class="btn btn-primary" onclick="submitContactMessage()" id="contactSubmitBtn">ðŸ“¨ Send Message</button>
        <div id="contactSentMsg" style="font-size:12px;color:var(--teal);display:none">âœ… Message sent! Matthew will get back to you soon.</div>
      </div>
    </div>`;
  // Char counter for contact message
  setTimeout(function(){
    var ta = document.getElementById('contactMessage');
    var cc = document.getElementById('contactCharCount');
    if(ta&&cc){ ta.addEventListener('input',function(){ cc.textContent=ta.value.length; }); }
  }, 100);
  renderWelcomeMsg();
}
function renderWelcomeMsg(){
  const m=document.getElementById('chatMessages');
  if(!m)return;
  m.innerHTML='';
  addChatMsg('bot','Yo! ðŸ‘‹ I\'m TrendVid AI â€” your built-in creator coach. Ask me anything about going viral, growing your channel, writing better scripts, or getting the most out of TrendVid.\n\n**What I can help with:**\nâ€¢ Hook writing & script structure\nâ€¢ Platform-specific growth tactics\nâ€¢ Thumbnail & CTR optimization\nâ€¢ Content strategy & posting schedules\nâ€¢ Channel monetization paths');
}

function submitContactMessage() {
  var nameEl    = document.getElementById('contactName');
  var emailEl   = document.getElementById('contactEmail');
  var subjectEl = document.getElementById('contactSubject');
  var msgEl     = document.getElementById('contactMessage');
  var btn       = document.getElementById('contactSubmitBtn');
  var sentMsg   = document.getElementById('contactSentMsg');

  var name    = secSanitize((nameEl||{}).value||'', 80).trim();
  var email   = secSanitize((emailEl||{}).value||'', 120).trim().toLowerCase();
  var subject = (subjectEl||{}).value||'other';
  var message = secSanitize((msgEl||{}).value||'', 2000).trim();

  // Validate
  if(!name)    { notify('Please enter your name','error','âš ï¸'); if(nameEl) nameEl.focus(); return; }
  if(!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    notify('Please enter a valid email address','error','âš ï¸'); if(emailEl) emailEl.focus(); return;
  }
  if(!message || message.length < 10) {
    notify('Please write at least 10 characters','error','âš ï¸'); if(msgEl) msgEl.focus(); return;
  }

  // Rate limit: max 3 messages per session
  var sentCount = 0;
  try { sentCount = parseInt(sessionStorage.getItem('tv_contact_sent')||'0'); } catch(e) {}
  if(sentCount >= 3) { notify('You can send a maximum of 3 messages per session','error','ðŸ”’'); return; }

  // Save to admin messages inbox
  var messages = [];
  try { messages = JSON.parse(localStorage.getItem('tv_admin_messages')||'[]'); } catch(e) {}
  var validSubjects = ['bug','feature','billing','account','praise','other'];
  var safeSubject = validSubjects.includes(subject) ? subject : 'other';
  var subjectLabels = {bug:'ðŸ› Bug Report',feature:'ðŸ’¡ Feature Request',billing:'ðŸ’³ Billing Question',account:'ðŸ‘¤ Account Issue',praise:'ðŸŒŸ Positive Feedback',other:'ðŸ’¬ Other'};

  messages.unshift({
    id: Date.now(),
    name: name,
    email: email,
    subject: safeSubject,
    subjectLabel: subjectLabels[safeSubject],
    message: message,
    plan: currentUser ? currentUser.plan : 'unknown',
    at: new Date().toISOString(),
    read: false
  });
  try { localStorage.setItem('tv_admin_messages', JSON.stringify(messages.slice(0,200))); } catch(e) {}
  try { sessionStorage.setItem('tv_contact_sent', String(sentCount+1)); } catch(e) {}

  // Update admin badge
  updateAdminMessageBadge();

  // Success UI
  if(btn) btn.disabled = true;
  if(sentMsg) sentMsg.style.display = 'block';
  if(msgEl) msgEl.value = '';
  secLog('USER_MESSAGE', name + ' (' + email + ') â€” ' + safeSubject);
  notify('Message sent to Matthew âœ…','success','âœ‰ï¸');
}


function adminMarkMsgRead(idx) {
  var msgs = []; try { msgs = JSON.parse(localStorage.getItem('tv_admin_messages')||'[]'); } catch(e) {}
  if(msgs[idx]) msgs[idx].read = true;
  try { localStorage.setItem('tv_admin_messages', JSON.stringify(msgs)); } catch(e) {}
  updateAdminMessageBadge();
  renderAdmin();
}
function adminDeleteMsg(idx) {
  var msgs = []; try { msgs = JSON.parse(localStorage.getItem('tv_admin_messages')||'[]'); } catch(e) {}
  msgs.splice(idx, 1);
  try { localStorage.setItem('tv_admin_messages', JSON.stringify(msgs)); } catch(e) {}
  updateAdminMessageBadge();
  renderAdmin();
}
function adminMarkAllMsgsRead() {
  var msgs = []; try { msgs = JSON.parse(localStorage.getItem('tv_admin_messages')||'[]'); } catch(e) {}
  msgs.forEach(function(m){ m.read = true; });
  try { localStorage.setItem('tv_admin_messages', JSON.stringify(msgs)); } catch(e) {}
  updateAdminMessageBadge();
  renderAdmin();
}
function updateAdminMessageBadge() {
  var messages = [];
  try { messages = JSON.parse(localStorage.getItem('tv_admin_messages')||'[]'); } catch(e) {}
  var unread = messages.filter(function(m){ return !m.read; }).length;
  ['adminNotifBadge','adminNotifBadgeMobile'].forEach(function(id) {
    var el = document.getElementById(id);
    if(el) {
      el.style.display = unread > 0 ? 'block' : 'none';
      el.textContent = unread;
    }
  });
}

async function sendChat(){
  if(chatBusy)return;
  const inp=document.getElementById('chatInp');
  if(!inp)return;
  const msg=inp.value.trim();
  if(!msg)return;
  inp.value='';
  document.getElementById('chatSugs').innerHTML='';
  addChatMsg('user',msg);
  chatHistory.push({role:'user',content:msg});
  if(chatHistory.length>20)chatHistory=chatHistory.slice(-18);
  chatBusy=true;
  document.getElementById('chatSendBtn').disabled=true;
  showTyping();
  try{
    const reply=await callTrendVidAI(chatHistory,700);
    hideTyping();
    addChatMsg('bot',reply);
    chatHistory.push({role:'assistant',content:reply});
  }catch(e){
    hideTyping();
    addChatMsg('bot',`Hmm, hit a snag: ${friendlyErr(e)}. Try again!`);
  }
  chatBusy=false;
  document.getElementById('chatSendBtn').disabled=false;
  inp.focus();
}
function sendSug(msg){const inp=document.getElementById('chatInp');if(inp){inp.value=msg;sendChat();}}
function addChatMsg(role,text){
  const msgs=document.getElementById('chatMessages');
  if(!msgs)return;
  const now=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const fmt=text
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.*?)\*/g,'<em>$1</em>')
    .replace(/\n/g,'<br>');
  const div=document.createElement('div');
  div.className=`chat-msg ${role}`;
  div.innerHTML=`<div class="chat-bubble">${fmt}</div><div class="chat-ts">${now}</div>`;
  msgs.appendChild(div);
  msgs.scrollTop=msgs.scrollHeight;
}
function showTyping(){
  const msgs=document.getElementById('chatMessages');
  if(!msgs)return;
  const div=document.createElement('div');
  div.id='chatTyping';div.className='typing-row';
  div.innerHTML=`<div class="typing-dots"><div class="t-dot"></div><div class="t-dot"></div><div class="t-dot"></div></div>`;
  msgs.appendChild(div);msgs.scrollTop=msgs.scrollHeight;
}
function hideTyping(){document.getElementById('chatTyping')?.remove();}

// ============================================================
// 1. VOICE TO SCRIPT
// ============================================================
let mediaRecorder=null, audioChunks=[], isRecording=false;
function renderVoiceToScript(){
  if(renderLockedPage('voice','Voice to Script','ðŸŽ™ï¸')) return;
  document.getElementById('pageContent').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div class="card">
        <div class="section-label" style="margin-bottom:16px">RECORD YOUR IDEA</div>
        <div class="voice-recorder">
          <button class="record-btn" id="recordBtn" onclick="toggleRecording()">ðŸŽ™ï¸</button>
          <div id="recordStatus" style="font-size:13px;font-weight:700;color:var(--muted)">Tap to record</div>
          <div class="waveform" id="waveform">${Array(12).fill(0).map((_,i)=>`<div class="wave-bar" id="wb${i}" style="height:6px;background:var(--border)"></div>`).join('')}</div>
          <div style="font-size:11px;color:var(--muted);text-align:center">Describe your video idea out loud â€” the AI will transcribe and polish it into a proper script brief</div>
        </div>
        <div class="divider"></div>
        <div class="form-field" style="margin-top:14px">
          <label>Or type/paste your rough idea</label>
          <textarea class="form-input" id="voiceText" rows="4" placeholder="e.g. video about why most people fail at saving money, starts with shocking stat, interviews on the street..."></textarea>
        </div>
        <button class="btn btn-primary" style="width:100%" id="voicePolishBtn" onclick="polishVoiceIdea()">âœ¨ Polish into Script Brief</button>
      </div>
      <div class="output-area" id="voiceOutput">
        <div class="output-empty">
          <div class="big-icon">ðŸŽ™ï¸</div>
          <div style="font-weight:700;font-size:15px">Voice â†’ Script</div>
          <div style="font-size:12px;color:var(--text2)">Record your idea or type it, and AI turns it into a polished script brief</div>
        </div>
      </div>
    </div>`;
}
async function toggleRecording(){
  if(!navigator.mediaDevices?.getUserMedia){notify('Microphone not supported in this browser','error','âš ï¸');return;}
  if(!isRecording){
    try{
      const stream=await navigator.mediaDevices.getUserMedia({audio:true});
      mediaRecorder=new MediaRecorder(stream);
      audioChunks=[];
      mediaRecorder.ondataavailable=e=>{if(e.data.size>0)audioChunks.push(e.data);};
      mediaRecorder.onstop=async()=>{
        stream.getTracks().forEach(t=>t.stop());
        notify('Processing audio...','info','ðŸŽ™ï¸');
        // Simulate transcription since we do not have a speech-to-text API
        const duration=Math.round((Date.now()-recordStart)/1000);
        document.getElementById('voiceText').value=`[Voice note - ${duration}s recorded]\nAI transcription: Describe your video idea here after speaking. For now, type your idea in the box below and click "Polish into Script Brief".`;
        notify('Recording saved â€” refine the text and click Polish','success','âœ…');
      };
      mediaRecorder.start(100);
      isRecording=true;
      recordStart=Date.now();
      document.getElementById('recordBtn').classList.add('recording');
      document.getElementById('recordStatus').textContent='Recording... tap to stop';
      document.getElementById('recordStatus').style.color='var(--accent)';
      startWaveAnim();
    }catch(e){notify('Microphone access denied','error','âš ï¸');}
  } else {
    mediaRecorder?.stop();
    isRecording=false;
    stopWaveAnim();
    document.getElementById('recordBtn').classList.remove('recording');
    document.getElementById('recordBtn').textContent='ðŸŽ™ï¸';
    document.getElementById('recordStatus').textContent='Tap to record';
    document.getElementById('recordStatus').style.color='var(--muted)';
  }
}
let recordStart=0, waveInterval=null;
function startWaveAnim(){
  waveInterval=setInterval(()=>{
    for(let i=0;i<12;i++){
      const el=document.getElementById('wb'+i);
      if(el){const h=6+Math.random()*26;el.style.height=h+'px';el.style.background=h>18?'var(--accent)':'var(--border2)';}
    }
  },100);
}
function stopWaveAnim(){
  clearInterval(waveInterval);
  for(let i=0;i<12;i++){const el=document.getElementById('wb'+i);if(el){el.style.height='6px';el.style.background='var(--border)';}}
}
async function polishVoiceIdea(){
  const raw=document.getElementById('voiceText').value.trim();
  if(!raw){notify('Type or record your idea first','error','âš ï¸');return;}
  const btn=document.getElementById('voicePolishBtn');
  btn.innerHTML='<div class="spinner spinner-sm"></div> Polishing...'; btn.disabled=true;
  document.getElementById('voiceOutput').innerHTML=`<div class="output-empty"><div class="spinner spinner-lg"></div><div style="font-size:13px;color:var(--muted)">Turning your idea into a script brief...</div></div>`;
  try{
    const result=await callClaude([{role:'user',content:`Take this rough voice/idea note from a content creator and turn it into a polished, structured script brief:\n\n"${raw}"\n\nOutput:\n**TITLE IDEAS** (3 options)\n**HOOK** (first 30 seconds)\n**SCRIPT STRUCTURE** (5 bullet points)\n**TARGET AUDIENCE**\n**PLATFORM RECOMMENDATION**\n**ESTIMATED LENGTH**\n**KEY TALKING POINTS** (5 bullets)\n**CALL TO ACTION**`}],
      'You are a professional video producer. Transform rough ideas into tight, filmable script briefs.',1200);
    const fmt=result.replace(/\*\*(.*?)\*\*/g,'<div class="script-section-head">$1</div>').replace(/\n/g,'<br>');
    document.getElementById('voiceOutput').innerHTML=`
      <div class="output-toolbar">
        <div style="font-size:13px;font-weight:700">âœ… Script Brief Ready</div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-primary btn-sm" onclick="navTo('script');setTimeout(()=>{document.getElementById('scriptTopic').value=document.getElementById('voiceText').value.substring(0,80);},50)">â†’ Open in Script Generator</button>
          <button class="btn btn-secondary btn-sm" onclick="safeCopy(document.querySelector('#voiceOutput .output-box').innerText,'Copied!','ðŸ“‹')">ðŸ“‹ Copy</button>
        </div>
      </div>
      <div class="output-box">${fmt}</div>`;
  }catch(e){document.getElementById('voiceOutput').innerHTML=`<div class="output-empty"><div style="color:var(--accent)">âš ï¸ ${friendlyErr(e)}</div></div>`;}
  btn.innerHTML='âœ¨ Polish into Script Brief'; btn.disabled=false;
}

// ============================================================
// 2. TELEPROMPTER MODE
// ============================================================
let tpRunning=false, tpInterval=null, tpPos=0, tpSpeed=1.5;
function renderTeleprompter(){
  if(renderLockedPage('teleprompter','Teleprompter Mode','ðŸ“º')) return;
  const scripts=JSON.parse(localStorage.getItem('tv_scripts')||'[]');
  document.getElementById('pageContent').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 320px;gap:20px">
      <div class="card">
        <div class="section-label" style="margin-bottom:12px">SCRIPT TEXT</div>
        <textarea class="form-input" id="tpText" rows="14" placeholder="Paste your script here or load from library...">${scripts[0]?.content||''}</textarea>
        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
          <button class="btn btn-primary btn-lg" style="flex:1" onclick="launchTeleprompter()">ðŸ“º Launch Fullscreen</button>
          ${scripts.length?`<select class="form-input" style="width:200px" onchange="loadScriptToTP(this.value)">
            <option value="">Load from library...</option>
            ${scripts.slice(0,10).map((s,i)=>`<option value="${i}">${s.topic.substring(0,40)}</option>`).join('')}
          </select>`:''}
        </div>
      </div>
      <div class="card">
        <div class="section-label" style="margin-bottom:14px">SETTINGS</div>
        <div class="form-field">
          <label>Text Size</label>
          <input type="range" id="tpSizeSlider" min="24" max="72" value="42" class="form-input" style="padding:8px 0;cursor:pointer" oninput="document.getElementById('tpSizeVal').textContent=this.value+'px'">
          <div style="font-size:11px;color:var(--muted);margin-top:4px">Size: <span id="tpSizeVal">42px</span></div>
        </div>
        <div class="form-field">
          <label>Scroll Speed</label>
          <input type="range" id="tpSpeedSlider" min="0.3" max="4" step="0.1" value="1.5" class="form-input" style="padding:8px 0;cursor:pointer" oninput="document.getElementById('tpSpeedVal').textContent=this.value+'x'">
          <div style="font-size:11px;color:var(--muted);margin-top:4px">Speed: <span id="tpSpeedVal">1.5x</span></div>
        </div>
        <div class="form-field">
          <label>Text Color</label>
          <div style="display:flex;gap:8px">
            ${[['#ffffff','White'],['#fbbf24','Gold'],['#00e5b0','Teal'],['#a78bfa','Purple']].map(([c,n])=>`<div style="width:30px;height:30px;background:${c};border-radius:7px;cursor:pointer;border:2px solid transparent" title="${n}" onclick="document.getElementById('tpColorInput').value='${c}';this.parentElement.querySelectorAll('div').forEach(d=>d.style.borderColor='transparent');this.style.borderColor='rgba(255,255,255,0.5)'"></div>`).join('')}
            <input type="color" id="tpColorInput" value="#ffffff" style="width:30px;height:30px;border:none;background:none;cursor:pointer;border-radius:7px;">
          </div>
        </div>
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:4px">
          <div style="font-size:11px;color:var(--muted);margin-bottom:8px;font-weight:700">CONTROLS</div>
          <div style="font-size:12px;color:var(--text2);line-height:2">
            <div>âŽµ Space â€” Play/Pause</div>
            <div>â†‘/â†“ â€” Speed control</div>
            <div>R â€” Restart</div>
            <div>Esc â€” Exit</div>
          </div>
        </div>
      </div>
    </div>
  `;
}
function loadScriptToTP(idx){if(idx==='')return;const scripts=JSON.parse(localStorage.getItem('tv_scripts')||'[]');const s=scripts[parseInt(idx)];if(s)document.getElementById('tpText').value=s.content.replace(/<[^>]+>/g,'');}
function launchTeleprompter(){
  const text=document.getElementById('tpText').value.trim();
  if(!text){notify('Add script text first','error','âš ï¸');return;}
  const size=document.getElementById('tpSizeSlider').value;
  tpSpeed=parseFloat(document.getElementById('tpSpeedSlider').value);
  const color=document.getElementById('tpColorInput').value;
  const overlay=document.getElementById('teleprompterOverlay');
  const textEl=document.getElementById('tpScrollText');
  textEl.style.fontSize=size+'px';
  textEl.style.color=color;
  textEl.innerHTML=text.replace(/\n/g,'<br><br>');
  tpPos=0;
  textEl.style.transform=`translateY(0px)`;
  tpRunning=false;
  overlay.classList.add('active');
  document.getElementById('tpPlayBtn').textContent='â–¶ Play';
  document.addEventListener('keydown',tpKeyHandler);
}
function tpKeyHandler(e){
  if(e.code==='Space'){e.preventDefault();tpTogglePlay();}
  else if(e.code==='ArrowUp'){tpSpeed=Math.min(4,tpSpeed+0.2);}
  else if(e.code==='ArrowDown'){tpSpeed=Math.max(0.2,tpSpeed-0.2);}
  else if(e.code==='KeyR'){tpPos=0;document.getElementById('tpScrollText').style.transform='translateY(0)';}
  else if(e.code==='Escape'){closeTeleprompter();}
}
function tpTogglePlay(){
  tpRunning=!tpRunning;
  document.getElementById('tpPlayBtn').textContent=tpRunning?'â¸ Pause':'â–¶ Play';
  if(tpRunning) tpAnimate();
  else clearInterval(tpInterval);
}
function tpAnimate(){
  clearInterval(tpInterval);
  tpInterval=setInterval(()=>{
    if(!tpRunning)return;
    const el=document.getElementById('tpScrollText');
    const wrap=document.getElementById('tpScrollWrap');
    if(!el||!wrap)return;
    tpPos-=tpSpeed;
    const maxScroll=-(el.scrollHeight-wrap.clientHeight/2);
    if(tpPos<=maxScroll){tpPos=maxScroll;tpRunning=false;clearInterval(tpInterval);document.getElementById('tpPlayBtn').textContent='â–¶ Play';}
    el.style.transform=`translateY(${tpPos}px)`;
  },16);
}
function closeTeleprompter(){
  document.getElementById('teleprompterOverlay').classList.remove('active');
  tpRunning=false; clearInterval(tpInterval);
  document.removeEventListener('keydown',tpKeyHandler);
}

// ============================================================
// 3. HASHTAG & SEO GENERATOR
// ============================================================
function renderHashtags(){
  if(renderLockedPage('hashtags','Hashtag & SEO Generator','#ï¸âƒ£')) return;
  document.getElementById('pageContent').innerHTML=`
    <div style="display:grid;grid-template-columns:340px 1fr;gap:20px">
      <div class="card">
        <div class="section-label" style="margin-bottom:14px">VIDEO DETAILS</div>
        <div class="form-field">
          <label>Video Title / Topic</label>
          <input class="form-input" id="hashTitle" placeholder="e.g. 10 AI Tools That Will Replace Your Job">
        </div>
        <div class="form-field">
          <label>Niche</label>
          <input class="form-input" id="hashNiche" placeholder="Tech, Finance, Fitness...">
        </div>
        <div class="form-field">
          <label>Platform</label>
          <select class="form-input form-select" id="hashPlatform">
            <option>YouTube</option><option>TikTok</option><option>Instagram</option>
          </select>
        </div>
        <div class="form-field" style="margin-bottom:16px">
          <label>Target Keywords (optional)</label>
          <input class="form-input" id="hashKeywords" placeholder="comma separated">
        </div>
        <button class="btn btn-primary" style="width:100%" id="hashBtn" onclick="generateHashtags()">#ï¸âƒ£ Generate Hashtags & SEO</button>
      </div>
      <div>
        <div class="card" id="hashOutput" style="min-height:300px">
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px;color:var(--muted);gap:12px">
            <div style="font-size:44px">#ï¸âƒ£</div>
            <div style="font-size:14px;font-weight:700">AI Hashtag & SEO Generator</div>
            <div style="font-size:12px;text-align:center">Get optimised hashtags, SEO title, description, and tags to maximise discoverability</div>
          </div>
        </div>
      </div>
    </div>`;
}
async function generateHashtags(){
  const title=document.getElementById('hashTitle').value.trim();
  if(!title){notify('Enter a video title','error','âš ï¸');return;}
  const niche=document.getElementById('hashNiche').value||'general';
  const platform=document.getElementById('hashPlatform').value;
  const keywords=document.getElementById('hashKeywords').value;
  const btn=document.getElementById('hashBtn');
  btn.innerHTML='<div class="spinner spinner-sm"></div> Generating...'; btn.disabled=true;
  document.getElementById('hashOutput').innerHTML=`<div style="display:flex;align-items:center;gap:14px;padding:40px;color:var(--muted)"><div class="spinner spinner-lg"></div><div>Generating SEO strategy...</div></div>`;
  try{
    const raw=await callClaude([{role:'user',content:`Generate a complete SEO + hashtag strategy for a ${platform} video:\nTitle: "${title}"\nNiche: ${niche}\nKeywords: ${keywords||'auto'}\n\nReturn ONLY raw JSON:\n{\n"seoTitle": "optimised title max 60 chars",\n"seoDescription": "150 char meta description",\n"primaryHashtags": ["array of 5 high-volume hashtags without #"],\n"niche HashTags": ["array of 10 niche-specific hashtags"],\n"longTailHashtags": ["array of 8 long-tail hashtags"],\n"seoScore": 0-100,\n"searchVolume": "High|Medium|Low",\n"competition": "High|Medium|Low",\n"keywordTips": ["3 actionable SEO tips"],\n"bestPostTime": "e.g. Tuesday 3-5pm"\n}`}],
      'Return ONLY valid JSON.',900);
    const d=JSON.parse(raw.replace(/```json|```/g,'').trim());
    const allTags=[...(d.primaryHashtags||[]),...(d.nicheHashTags||d['niche HashTags']||[]),...(d.longTailHashtags||[])];
    document.getElementById('hashOutput').innerHTML=`
      <div style="padding:20px">
        <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px;flex-wrap:wrap">
          <div style="flex:1">
            <div class="section-label" style="margin-bottom:6px">SEO OPTIMISED TITLE</div>
            <div style="font-size:15px;font-weight:700;color:var(--teal)">${d.seoTitle}</div>
          </div>
          <div style="text-align:center">
            <div style="font-family:var(--font-display);font-size:36px;font-weight:800;color:${d.seoScore>=80?'var(--teal)':d.seoScore>=60?'var(--gold)':'var(--accent)'}">${d.seoScore}</div>
            <div style="font-size:9px;color:var(--muted);font-weight:700;letter-spacing:1px;font-family:var(--font-display)">SEO SCORE</div>
          </div>
        </div>
        <div class="seo-score-bar"><div class="seo-score-fill" style="width:${d.seoScore}%"></div></div>
        <div style="display:flex;gap:20px;margin:14px 0;flex-wrap:wrap">
          <div><div style="font-size:9px;color:var(--muted);font-weight:700;letter-spacing:1px;font-family:var(--font-display)">SEARCH VOL</div><div style="font-size:13px;font-weight:700;color:${d.searchVolume==='High'?'var(--teal)':'var(--gold)'}">${d.searchVolume}</div></div>
          <div><div style="font-size:9px;color:var(--muted);font-weight:700;letter-spacing:1px;font-family:var(--font-display)">COMPETITION</div><div style="font-size:13px;font-weight:700;color:${d.competition==='Low'?'var(--teal)':d.competition==='Medium'?'var(--gold)':'var(--accent)'}">${d.competition}</div></div>
          <div><div style="font-size:9px;color:var(--muted);font-weight:700;letter-spacing:1px;font-family:var(--font-display)">BEST TIME</div><div style="font-size:13px;font-weight:700">${d.bestPostTime||'N/A'}</div></div>
        </div>
        <div class="divider"></div>
        <div class="section-label" style="margin:12px 0 8px">META DESCRIPTION</div>
        <div style="font-size:12px;color:var(--text2);background:var(--surface2);padding:10px 14px;border-radius:9px;border:1px solid var(--border);margin-bottom:14px">${d.seoDescription}</div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div class="section-label">HASHTAGS â€” click to copy</div>
          <button class="btn btn-ghost btn-sm" onclick="safeCopy(${JSON.stringify(allTags)}.map(t=>'#'+t).join(' '),'All hashtags copied!','#ï¸âƒ£')">ðŸ“‹ Copy All</button>
        </div>
        <div class="hashtag-cloud">
          ${(d.primaryHashtags||[]).map(t=>`<div class="hashtag-tag" style="border-color:rgba(255,48,88,0.4);color:var(--accent);background:rgba(255,48,88,0.08)" onclick="safeCopy('#${t}','#${t} copied','ðŸ“‹')">#${t}</div>`).join('')}
          ${(d.nicheHashTags||d['niche HashTags']||[]).map(t=>`<div class="hashtag-tag" onclick="safeCopy('#${t}','#${t} copied','ðŸ“‹')">#${t}</div>`).join('')}
          ${(d.longTailHashtags||[]).map(t=>`<div class="hashtag-tag" style="border-color:rgba(167,139,250,0.3);color:var(--purple);background:rgba(167,139,250,0.07)" onclick="safeCopy('#${t}','#${t} copied','ðŸ“‹')">#${t}</div>`).join('')}
        </div>
        <div class="divider" style="margin:16px 0"></div>
        <div class="section-label" style="margin-bottom:10px">ðŸ’¡ SEO TIPS</div>
        ${(d.keywordTips||[]).map(tip=>`<div style="display:flex;gap:8px;font-size:12px;color:var(--text2);margin-bottom:8px"><span style="color:var(--teal)">â†’</span>${tip}</div>`).join('')}
      </div>`;
    notify('SEO strategy generated!','success','#ï¸âƒ£');awardXP('used_hashtags');
  }catch(e){document.getElementById('hashOutput').innerHTML=`<div style="padding:40px;text-align:center;color:var(--muted)">${friendlyErr(e)}</div>`;}
  btn.innerHTML='#ï¸âƒ£ Generate Hashtags & SEO'; btn.disabled=false;
}

// ============================================================
// 4. HOOK TESTER
// ============================================================
function renderHookTester(){
  if(renderLockedPage('hooktester','30-Second Hook Tester','âš¡')) return;
  document.getElementById('pageContent').innerHTML=`
    <div style="display:grid;grid-template-columns:400px 1fr;gap:20px">
      <div class="card">
        <div class="section-label" style="margin-bottom:14px">TEST YOUR HOOK</div>
        <div class="form-field">
          <label>Your Hook (first 30 seconds)</label>
          <textarea class="form-input" id="hookInput" rows="5" placeholder="e.g. 'I quit my $200K job and moved to Bali. Here's everything that went wrong...'"></textarea>
        </div>
        <div class="form-field">
          <label>Platform</label>
          <select class="form-input form-select" id="hookPlatform">
            <option>YouTube</option><option>TikTok</option><option>Instagram Reels</option>
          </select>
        </div>
        <div class="form-field" style="margin-bottom:16px">
          <label>Niche</label>
          <input class="form-input" id="hookNiche" placeholder="e.g. Personal Finance">
        </div>
        <button class="btn btn-primary" style="width:100%" id="hookBtn" onclick="testHook()">âš¡ Test This Hook</button>
        <div style="margin-top:14px">
          <div class="section-label" style="margin-bottom:8px">EXAMPLE HOOKS TO TEST</div>
          ${[
            '"Wait â€” before you close this, I need to show you something"',
            '"I\'ve been lying to you about how I make money online"',
            '"Most people don\'t know this one trick that doubled my views"',
          ].map(h=>`<div class="sug-card" onclick="document.getElementById('hookInput').value='${h.replace(/'/g,"\\'")}'">${h}<span style="color:var(--muted)">â†’</span></div>`).join('')}
        </div>
      </div>
      <div id="hookOutput">
        <div class="card" style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px;color:var(--muted);gap:12px;min-height:300px">
          <div style="font-size:44px">âš¡</div>
          <div style="font-size:14px;font-weight:700">Hook Tester</div>
          <div style="font-size:12px;text-align:center">Paste a hook and get a 1-10 score with detailed feedback on what works and what to fix</div>
        </div>
      </div>
    </div>`;
}
async function testHook(){
  const hook=document.getElementById('hookInput').value.trim();
  if(!hook){notify('Enter a hook to test','error','âš ï¸');return;}
  const platform=document.getElementById('hookPlatform').value;
  const niche=document.getElementById('hookNiche').value||'general';
  const btn=document.getElementById('hookBtn');
  btn.innerHTML='<div class="spinner spinner-sm"></div> Analysing...'; btn.disabled=true;
  document.getElementById('hookOutput').innerHTML=`<div class="card" style="display:flex;align-items:center;gap:14px;padding:40px"><div class="spinner spinner-lg"></div><div style="color:var(--muted)">Rating your hook...</div></div>`;
  try{
    const raw=await callClaude([{role:'user',content:`Rate this ${platform} video hook for the ${niche} niche:\n\n"${hook}"\n\nReturn ONLY raw JSON:\n{"score":7,"curiosityScore":8,"clarityScore":7,"emotionScore":6,"scrollStopScore":8,"verdict":"one sentence verdict","strengths":["strength 1","strength 2"],"weaknesses":["weakness 1","weakness 2"],"improvedVersion":"rewritten hook that would score higher","hookType":"Question|Shock|Story|Controversy|Promise|Curiosity Gap"}`}],
      'Return ONLY valid raw JSON.',500);
    const d=JSON.parse(raw.replace(/```json|```/g,'').trim());
    const scoreColor=d.score>=8?'var(--teal)':d.score>=6?'var(--gold)':'var(--accent)';
    document.getElementById('hookOutput').innerHTML=`
      <div class="card">
        <div style="display:flex;align-items:center;gap:24px;margin-bottom:24px;flex-wrap:wrap">
          <div class="hook-score-ring-wrap">
            <div class="score-big" style="background:linear-gradient(135deg,${d.score>=8?'var(--teal),#00a87e':d.score>=6?'var(--gold),#d97706':'var(--accent),#b8002e'});-webkit-background-clip:text;-webkit-text-fill-color:transparent">${d.score}</div>
            <div style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:1px;font-family:var(--font-display)">/10 SCORE</div>
          </div>
          <div style="flex:1">
            <div style="font-size:14px;font-weight:700;margin-bottom:6px">${d.verdict}</div>
            <div style="font-size:11px;background:rgba(255,48,88,0.08);border:1px solid rgba(255,48,88,0.2);color:var(--accent);padding:4px 12px;border-radius:20px;display:inline-block;font-weight:700;font-family:var(--font-display)">${d.hookType}</div>
          </div>
        </div>
        <div class="hook-meter">
          ${[['CURIOSITY',d.curiosityScore],['CLARITY',d.clarityScore],['EMOTION',d.emotionScore],['SCROLL-STOP',d.scrollStopScore]].map(([label,val])=>`
            <div class="hook-meter-row">
              <div class="hook-meter-label">${label}</div>
              <div class="hook-meter-bar"><div class="hook-meter-fill" style="width:${val*10}%"></div></div>
              <div class="hook-meter-val" style="color:${val>=8?'var(--teal)':val>=6?'var(--gold)':'var(--accent)'}">${val}</div>
            </div>`).join('')}
        </div>
        <div class="divider" style="margin:18px 0"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px">
          <div>
            <div class="section-label" style="margin-bottom:8px;color:var(--teal)">âœ… STRENGTHS</div>
            ${(d.strengths||[]).map(s=>`<div style="font-size:12px;color:var(--text2);margin-bottom:6px;display:flex;gap:8px"><span style="color:var(--teal)">âœ“</span>${s}</div>`).join('')}
          </div>
          <div>
            <div class="section-label" style="margin-bottom:8px;color:var(--accent)">âš ï¸ WEAKNESSES</div>
            ${(d.weaknesses||[]).map(w=>`<div style="font-size:12px;color:var(--text2);margin-bottom:6px;display:flex;gap:8px"><span style="color:var(--accent)">âœ•</span>${w}</div>`).join('')}
          </div>
        </div>
        <div style="background:linear-gradient(135deg,rgba(0,229,176,0.05),rgba(0,229,176,0.02));border:1px solid rgba(0,229,176,0.2);border-radius:12px;padding:16px">
          <div class="section-label" style="margin-bottom:8px;color:var(--teal)">âœ¨ IMPROVED VERSION</div>
          <div style="font-size:13px;font-style:italic;color:var(--text);line-height:1.6">"${d.improvedVersion}"</div>
          <button class="btn btn-teal btn-sm" style="margin-top:10px" onclick="document.getElementById('hookInput').value='${(d.improvedVersion||'').replace(/'/g,"\\'")}';notify('Loaded improved hook','success','âœ¨')">Use This Version â†’</button>
        </div>
      </div>`;
    notify(`Hook scored ${d.score}/10!`,'success','âš¡');awardXP('tested_hook');
  }catch(e){document.getElementById('hookOutput').innerHTML=`<div class="card" style="padding:40px;text-align:center;color:var(--muted)">${friendlyErr(e)}</div>`;}
  btn.innerHTML='âš¡ Test This Hook'; btn.disabled=false;
}

// ============================================================
// 5. SCRIPT REPURPOSER
// ============================================================
let repurposeTab='tiktok';
function renderRepurposer(){
  if(renderLockedPage('repurpose','Script Repurposer','â™»ï¸')) return;
  const scripts=JSON.parse(localStorage.getItem('tv_scripts')||'[]');
  document.getElementById('pageContent').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div class="card">
        <div class="section-label" style="margin-bottom:12px">SOURCE SCRIPT (YouTube)</div>
        ${scripts.length?`<select class="form-input" style="margin-bottom:10px" onchange="if(this.value!=='')document.getElementById('repurposeSource').value=document.querySelector('[data-si=\\''+this.value+'\\']').dataset.content"><option value="">Load from library...</option>${scripts.slice(0,10).map((s,i)=>`<option value="${i}">${s.topic.substring(0,45)}</option>`).join('')}</select>`:''}
        ${scripts.map((s,i)=>`<span data-si="${i}" data-content="${esc(s.content.substring(0,2000))}" style="display:none"></span>`).join('')}
        <textarea class="form-input" id="repurposeSource" rows="12" placeholder="Paste your YouTube script here..."></textarea>
        <button class="btn btn-primary" style="width:100%;margin-top:10px" id="repurposeBtn" onclick="repurposeScript()">â™»ï¸ Repurpose for All Platforms</button>
      </div>
      <div class="card">
        <div class="repurpose-tabs">
          ${[['tiktok','â™ª TikTok'],['reels','â—ˆ Reels'],['tweet','ðŸ¦ Tweet Thread'],['shorts','â–¶ Shorts']].map(([t,l])=>`<button class="btn btn-sm ${repurposeTab===t?'btn-primary':'btn-ghost'}" style="border-radius:8px" onclick="switchRepurposeTab('${t}',this)">${l}</button>`).join('')}
        </div>
        <div id="repurposeOutput" class="repurpose-output">Select a tab and repurpose your script to see output here...</div>
        <button class="btn btn-secondary btn-sm" style="margin-top:10px" onclick="safeCopy(document.getElementById('repurposeOutput').innerText,'Copied!','ðŸ“‹')">ðŸ“‹ Copy Output</button>
      </div>
    </div>`;
}
function switchRepurposeTab(tab,el){
  repurposeTab=tab;
  document.querySelectorAll('.repurpose-tabs .btn').forEach(b=>{b.className=b.className.replace('btn-primary','btn-ghost');});
  el.className=el.className.replace('btn-ghost','btn-primary');
  const existing=document.getElementById('repurposeOutput').dataset[tab];
  if(existing) document.getElementById('repurposeOutput').innerHTML=existing.replace(/\n/g,'<br>');
}
async function repurposeScript(){
  const src=document.getElementById('repurposeSource').value.trim();
  if(!src){notify('Paste a YouTube script first','error','âš ï¸');return;}
  const btn=document.getElementById('repurposeBtn');
  btn.innerHTML='<div class="spinner spinner-sm"></div> Repurposing...'; btn.disabled=true;
  document.getElementById('repurposeOutput').innerHTML='<div style="display:flex;align-items:center;gap:10px;padding:20px"><div class="spinner"></div><div>Generating all formats...</div></div>';
  try{
    const [tiktok,reels,tweet,shorts]=await Promise.all([
      callClaude([{role:'user',content:`Turn this YouTube script into a TikTok script (60-90 seconds max, very punchy, first person, rapid cuts, trending audio cue notes). Add [TRANSITION] markers:\n\n${src.substring(0,1500)}`}],'TikTok native scriptwriter.',600),
      callClaude([{role:'user',content:`Turn this into an Instagram Reels script (30-60 seconds, visual-first, trending audio suggestion, hook in first 3 seconds, text overlay suggestions in [brackets]):\n\n${src.substring(0,1500)}`}],'Instagram Reels creator.',600),
      callClaude([{role:'user',content:`Turn this into a Twitter/X thread (8-12 tweets, each under 280 chars, numbered 1/, 2/ etc., hook tweet, value tweets, CTA last tweet):\n\n${src.substring(0,1500)}`}],'Twitter thread writer.',600),
      callClaude([{role:'user',content:`Turn this into a YouTube Shorts script (under 60 seconds, vertical format, rapid hook in 2 seconds, end with question for comments):\n\n${src.substring(0,1500)}`}],'YouTube Shorts creator.',600),
    ]);
    const out=document.getElementById('repurposeOutput');
    out.dataset.tiktok=tiktok;
    out.dataset.reels=reels;
    out.dataset.tweet=tweet;
    out.dataset.shorts=shorts;
    const map={tiktok,reels,tweet,shorts};
    out.innerHTML=(map[repurposeTab]||tiktok).replace(/\n/g,'<br>');
    notify('All formats ready!','success','â™»ï¸');awardXP('used_repurpose');
  }catch(e){document.getElementById('repurposeOutput').innerHTML=`<div style="color:var(--accent)">âš ï¸ ${friendlyErr(e)}</div>`;}
  btn.innerHTML='â™»ï¸ Repurpose for All Platforms'; btn.disabled=false;
}

// ============================================================
// 6. BRAND KIT
// ============================================================
let brandKit=JSON.parse(localStorage.getItem('tv_brandkit')||'{"primaryColor":"#ff3058","secondaryColor":"#00e5b0","accentColor":"#fbbf24","font":"Syne","tagline":"","channelName":""}');
function renderBrandKit(){
  if(renderLockedPage('brandkit','Brand Kit','ðŸŽ¨')) return;
  document.getElementById('pageContent').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div>
        <div class="card" style="margin-bottom:14px">
          <div class="section-label" style="margin-bottom:14px">BRAND IDENTITY</div>
          <div class="form-field">
            <label>Channel / Brand Name</label>
            <input class="form-input" id="bkName" value="${brandKit.channelName}" placeholder="Your channel name">
          </div>
          <div class="form-field">
            <label>Tagline</label>
            <input class="form-input" id="bkTagline" value="${brandKit.tagline}" placeholder="Your brand tagline">
          </div>
          <div class="form-field">
            <label>Primary Colour</label>
            <div style="display:flex;gap:8px;align-items:center">
              <input type="color" id="bkPrimary" value="${brandKit.primaryColor}" style="width:44px;height:44px;border:none;cursor:pointer;border-radius:9px;background:none">
              <input class="form-input" id="bkPrimaryHex" value="${brandKit.primaryColor}" style="width:110px" onchange="document.getElementById('bkPrimary').value=this.value;updateBrandPreview()">
              <div style="display:flex;gap:5px">${['#ff3058','#ff8a00','#fbbf24','#00e5b0','#3b82f6','#8b5cf6','#e11d48','#0ea5e9'].map(c=>`<div style="width:26px;height:26px;border-radius:6px;background:${c};cursor:pointer;border:2px solid transparent" onclick="document.getElementById('bkPrimary').value='${c}';document.getElementById('bkPrimaryHex').value='${c}';updateBrandPreview()"></div>`).join('')}</div>
            </div>
          </div>
          <div class="form-field">
            <label>Secondary Colour</label>
            <div style="display:flex;gap:8px;align-items:center">
              <input type="color" id="bkSecondary" value="${brandKit.secondaryColor}" style="width:44px;height:44px;border:none;cursor:pointer;border-radius:9px;background:none">
              <input class="form-input" id="bkSecondaryHex" value="${brandKit.secondaryColor}" style="width:110px" onchange="document.getElementById('bkSecondary').value=this.value;updateBrandPreview()">
            </div>
          </div>
          <div class="form-field" style="margin-bottom:16px">
            <label>Brand Font</label>
            <select class="form-input form-select" id="bkFont" onchange="updateBrandPreview()">
              ${['Syne','DM Sans','Impact','Arial Black','Georgia','Courier New','Trebuchet MS'].map(f=>`<option ${brandKit.font===f?'selected':''}>${f}</option>`).join('')}
            </select>
          </div>
          <button class="btn btn-primary" style="width:100%;margin-bottom:8px" onclick="saveBrandKit()">ðŸ’¾ Save Brand Kit</button>
          <button class="btn btn-secondary btn-sm" style="width:100%" onclick="applyBrandToThumbnail()">ðŸŽ¨ Apply to Thumbnail Generator</button>
        </div>
      </div>
      <div>
        <div class="card" style="margin-bottom:14px">
          <div class="section-label" style="margin-bottom:14px">LIVE PREVIEW</div>
          <div class="brand-preview" id="bkPreview">
            <div class="brand-preview-title" id="bkPreviewName" style="font-family:${brandKit.font};color:${brandKit.primaryColor}">${brandKit.channelName||'Your Channel'}</div>
            <div style="font-size:13px;color:#666;margin-bottom:12px" id="bkPreviewTagline">${brandKit.tagline||'Your tagline here'}</div>
            <div class="brand-preview-badge" id="bkPreviewBadge" style="background:${brandKit.primaryColor};color:#fff">NEW VIDEO</div>
            <div style="display:flex;gap:6px;margin-top:12px;justify-content:center">
              <div style="width:60px;height:60px;border-radius:12px;background:${brandKit.primaryColor};display:flex;align-items:center;justify-content:center;font-size:24px">ðŸŽ¬</div>
              <div style="width:60px;height:60px;border-radius:12px;background:${brandKit.secondaryColor};display:flex;align-items:center;justify-content:center;font-size:24px">ðŸ“ˆ</div>
              <div style="width:60px;height:60px;border-radius:12px;background:${brandKit.accentColor||'#fbbf24'};display:flex;align-items:center;justify-content:center;font-size:24px">âœ¨</div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="section-label" style="margin-bottom:12px">COLOUR PALETTE</div>
          <div style="display:flex;gap:10px;margin-bottom:14px" id="bkPaletteDisplay">
            ${[brandKit.primaryColor,brandKit.secondaryColor,brandKit.accentColor||'#fbbf24'].map((c,i)=>`<div style="flex:1;height:60px;border-radius:10px;background:${c};display:flex;align-items:flex-end;padding:6px 8px"><span style="font-size:10px;font-weight:700;color:rgba(255,255,255,0.8)">${c}</span></div>`).join('')}
          </div>
          <button class="btn btn-ghost btn-sm" onclick="generateBrandPalette()">âœ¨ AI Generate Palette</button>
        </div>
      </div>
    </div>`;
  document.getElementById('bkPrimary').addEventListener('input',e=>{document.getElementById('bkPrimaryHex').value=e.target.value;updateBrandPreview();});
  document.getElementById('bkSecondary').addEventListener('input',e=>{document.getElementById('bkSecondaryHex').value=e.target.value;updateBrandPreview();});
  document.getElementById('bkName').addEventListener('input',updateBrandPreview);
  document.getElementById('bkTagline').addEventListener('input',updateBrandPreview);
}
function updateBrandPreview(){
  const name=document.getElementById('bkName').value||'Your Channel';
  const tagline=document.getElementById('bkTagline').value||'Your tagline here';
  const primary=document.getElementById('bkPrimary').value;
  const secondary=document.getElementById('bkSecondary').value;
  const font=document.getElementById('bkFont').value;
  document.getElementById('bkPreviewName').style.fontFamily=font;
  document.getElementById('bkPreviewName').style.color=primary;
  document.getElementById('bkPreviewName').textContent=name;
  document.getElementById('bkPreviewTagline').textContent=tagline;
  document.getElementById('bkPreviewBadge').style.background=primary;
}
function saveBrandKit(){
  brandKit={
    channelName:document.getElementById('bkName').value,
    tagline:document.getElementById('bkTagline').value,
    primaryColor:document.getElementById('bkPrimary').value,
    secondaryColor:document.getElementById('bkSecondary').value,
    accentColor:brandKit.accentColor,
    font:document.getElementById('bkFont').value,
  };
  localStorage.setItem('tv_brandkit',JSON.stringify(brandKit));
  notify('Brand kit saved!','success','ðŸŽ¨');
}
function applyBrandToThumbnail(){
  saveBrandKit();
  thumbColor=brandKit.primaryColor;
  navTo('thumbnail');
  setTimeout(()=>{
    document.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('sel'));
    notify('Brand colours applied to Thumbnail AI','success','ðŸŽ¨');
  },100);
}
async function generateBrandPalette(){
  const name=document.getElementById('bkName').value||'creator brand';
  try{
    notify('Generating palette...','info','ðŸŽ¨');
    const raw=await callClaude([{role:'user',content:`Generate a 3-colour brand palette for: "${name}". Return ONLY JSON: {"primary":"#hex","secondary":"#hex","accent":"#hex","rationale":"one sentence"}`}],'Return ONLY raw JSON.',150);
    const p=JSON.parse(raw.replace(/```json|```/g,'').trim());
    document.getElementById('bkPrimary').value=p.primary;
    document.getElementById('bkPrimaryHex').value=p.primary;
    document.getElementById('bkSecondary').value=p.secondary;
    document.getElementById('bkSecondaryHex').value=p.secondary;
    brandKit.accentColor=p.accent;
    updateBrandPreview();
    notify('Palette generated: '+p.rationale,'success','ðŸŽ¨');awardXP('used_brandkit');
  }catch(e){notify(friendlyErr(e),'error','âš ï¸');}
}

// ============================================================
// 7. TREND ALERTS
// ============================================================
let alertNiches=JSON.parse(localStorage.getItem('tv_alert_niches')||'[]');
let alertEmail=localStorage.getItem('tv_alert_email')||'';
let alertFrequency=localStorage.getItem('tv_alert_frequency')||'daily';
const NICHE_OPTIONS=['Tech','Finance','Fitness','Food','Gaming','Lifestyle','Beauty','Education','Business','Entertainment','Travel','Parenting','Music','Sports','Comedy','Science','Health','Productivity','Relationships','Sustainability'];
function renderAlerts(){
  if(renderLockedPage('alerts','Trend Alerts Email','ðŸ””')) return;
  document.getElementById('pageContent').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div class="card">
        <div class="section-label" style="margin-bottom:14px">ALERT SETTINGS</div>
        <div class="form-field">
          <label>Your Email</label>
          <input class="form-input" id="alertEmail" type="email" placeholder="you@email.com" value="${alertEmail}">
        </div>
        <div class="form-field">
          <label>Frequency</label>
          <select class="form-input form-select" id="alertFreq">
            <option value="daily" ${alertFrequency==='daily'?'selected':''}>Daily Digest</option>
            <option value="weekly" ${alertFrequency==='weekly'?'selected':''}>Weekly Summary</option>
            <option value="realtime" ${alertFrequency==='realtime'?'selected':''}>Real-time (Pro)</option>
          </select>
        </div>
        <div class="form-field">
          <label>Your Niches (select all that apply)</label>
          <div class="alert-niche-chips" style="margin-top:8px">
            ${NICHE_OPTIONS.map(n=>`<div class="alert-chip ${alertNiches.includes(n)?'sel-chip':''}" onclick="toggleAlertNiche('${n}',this)">${n}</div>`).join('')}
          </div>
        </div>
        <button class="btn btn-primary" style="width:100%;margin-top:6px" onclick="saveAlertSettings()">ðŸ”” Save Alert Settings</button>
        <button class="btn btn-ghost btn-sm" style="width:100%;margin-top:8px" id="previewDigestBtn" onclick="previewDigest()">ðŸ‘ Preview Today's Digest</button>
      </div>
      <div>
        <div id="digestPreview" class="card" style="min-height:300px">
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px;color:var(--muted);gap:12px">
            <div style="font-size:44px">ðŸ””</div>
            <div style="font-size:14px;font-weight:700">Trend Digest</div>
            <div style="font-size:12px;text-align:center">Set your niches and click Preview to see what today's alert would look like</div>
          </div>
        </div>
      </div>
    </div>`;
}
function toggleAlertNiche(niche,el){
  const idx=alertNiches.indexOf(niche);
  if(idx===-1){alertNiches.push(niche);el.classList.add('sel-chip');}
  else{alertNiches.splice(idx,1);el.classList.remove('sel-chip');}
}
function saveAlertSettings(){
  alertEmail=document.getElementById('alertEmail').value.trim();
  alertFrequency=document.getElementById('alertFreq').value;
  localStorage.setItem('tv_alert_niches',JSON.stringify(alertNiches));
  localStorage.setItem('tv_alert_email',alertEmail);
  localStorage.setItem('tv_alert_frequency',alertFrequency);
  if(!alertEmail){notify('Add your email first','error','âš ï¸');return;}
  if(!alertNiches.length){notify('Select at least one niche','error','âš ï¸');return;}
  notify(`Alerts set for ${alertNiches.join(', ')}!`,'success','ðŸ””');
}
async function previewDigest(){
  const niches=alertNiches.length?alertNiches:['Tech','Finance','Lifestyle'];
  const btn=document.getElementById('previewDigestBtn');
  btn.innerHTML='<div class="spinner spinner-sm"></div> Generating...'; btn.disabled=true;
  document.getElementById('digestPreview').innerHTML=`<div style="display:flex;align-items:center;gap:14px;padding:40px;color:var(--muted)"><div class="spinner spinner-lg"></div><div>Building today's digest...</div></div>`;
  try{
    const raw=await callClaude([{role:'user',content:`Create a daily trend digest for a creator in these niches: ${niches.slice(0,4).join(', ')}. Today's date: ${new Date().toLocaleDateString('en-GB',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}.\n\nReturn ONLY raw JSON: {"date":"today's date","niches":["array"],"trends":[{"title":"trend title","platform":"YouTube|TikTok|Instagram","category":"niche","momentum":"ðŸ”¥ Exploding|ðŸ“ˆ Rising|âœ… Steady","why":"one sentence","suggestedAngle":"content angle for creator"}] (5 trends),"weeklyInsight":"one paragraph insight about the week","topHashtags":["5 hashtags"]}`}],
      'Return ONLY raw JSON.',800);
    const d=JSON.parse(raw.replace(/```json|```/g,'').trim());
    document.getElementById('digestPreview').innerHTML=`
      <div style="padding:20px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
          <div style="font-size:28px">ðŸ”¥</div>
          <div>
            <div style="font-family:var(--font-display);font-size:16px;font-weight:800">TrendVid Daily Digest</div>
            <div style="font-size:11px;color:var(--muted)">${d.date} Â· ${d.niches?.join(', ')}</div>
          </div>
        </div>
        <div class="section-label" style="margin-bottom:10px">TODAY'S HOT TRENDS</div>
        ${(d.trends||[]).map(t=>`
          <div class="digest-topic">
            <div style="font-size:18px">${t.momentum.split(' ')[0]}</div>
            <div style="flex:1">
              <div style="font-size:12px;font-weight:700">${t.title}</div>
              <div style="font-size:11px;color:var(--muted)">${t.platform} Â· ${t.category}</div>
              <div style="font-size:11px;color:var(--text2);margin-top:3px">ðŸ’¡ ${t.suggestedAngle}</div>
            </div>
            <span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:6px;background:var(--surface3);color:var(--muted);white-space:nowrap">${t.momentum.split(' ').slice(1).join(' ')}</span>
          </div>`).join('')}
        <div style="margin-top:14px;padding:12px;background:var(--surface2);border-radius:10px;border:1px solid var(--border)">
          <div class="section-label" style="margin-bottom:6px">ðŸ“Š WEEKLY INSIGHT</div>
          <div style="font-size:12px;color:var(--text2);line-height:1.6">${d.weeklyInsight}</div>
        </div>
        <div style="margin-top:12px">
          <div class="section-label" style="margin-bottom:6px">TRENDING HASHTAGS</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px">${(d.topHashtags||[]).map(t=>`<span class="hashtag-tag" style="font-size:11px">#${t}</span>`).join('')}</div>
        </div>
        <div style="margin-top:14px;text-align:center;font-size:11px;color:var(--muted)">ðŸ“§ This digest would be emailed to ${alertEmail||'your email'}</div>
      </div>`;
  }catch(e){document.getElementById('digestPreview').innerHTML=`<div style="padding:40px;text-align:center;color:var(--muted)">${friendlyErr(e)}</div>`;}
  btn.innerHTML='ðŸ‘ Preview Today\'s Digest'; btn.disabled=false;
}

// ============================================================
// 8. A/B TITLE TESTER
// ============================================================
function renderABTitle(){
  if(renderLockedPage('abtitle','A/B Title Tester','ðŸ†š')) return;
  document.getElementById('pageContent').innerHTML=`
    <div class="card" style="margin-bottom:20px">
      <div class="section-label" style="margin-bottom:14px">COMPARE TWO TITLES</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
        <div class="form-field" style="margin:0">
          <label>Title A</label>
          <input class="form-input" id="titleA" placeholder="e.g. I Tested 10 AI Tools So You Don't Have To">
        </div>
        <div class="form-field" style="margin:0">
          <label>Title B</label>
          <input class="form-input" id="titleB" placeholder="e.g. 10 AI Tools That Changed My Business (Honest Review)">
        </div>
      </div>
      <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
        <div class="form-field" style="margin:0;flex:1">
          <label>Platform</label>
          <select class="form-input form-select" id="abPlatform"><option>YouTube</option><option>TikTok</option><option>Instagram</option></select>
        </div>
        <div class="form-field" style="margin:0;flex:1">
          <label>Niche</label>
          <input class="form-input" id="abNiche" placeholder="Tech, Finance...">
        </div>
        <button class="btn btn-primary btn-lg" id="abBtn" onclick="testABTitles()">ðŸ†š Predict Winner</button>
      </div>
    </div>
    <div id="abOutput"></div>`;
}
async function testABTitles(){
  const a=document.getElementById('titleA').value.trim();
  const b=document.getElementById('titleB').value.trim();
  if(!a||!b){notify('Enter both titles','error','âš ï¸');return;}
  const platform=document.getElementById('abPlatform').value;
  const niche=document.getElementById('abNiche').value||'general';
  const btn=document.getElementById('abBtn');
  btn.innerHTML='<div class="spinner spinner-sm"></div> Analysing...'; btn.disabled=true;
  document.getElementById('abOutput').innerHTML=`<div style="display:flex;align-items:center;gap:14px;padding:40px;color:var(--muted)"><div class="spinner spinner-lg"></div><div>Predicting CTR performance...</div></div>`;
  try{
    const raw=await callClaude([{role:'user',content:`Compare these two ${platform} titles for the ${niche} niche and predict which gets higher CTR:\n\nTitle A: "${a}"\nTitle B: "${b}"\n\nReturn ONLY raw JSON:\n{"winner":"A"|"B","titleA":{"ctrScore":0-100,"curiosity":0-100,"clarity":0-100,"emotion":0-100,"keywords":0-100,"verdict":"one line"},"titleB":{"ctrScore":0-100,"curiosity":0-100,"clarity":0-100,"emotion":0-100,"keywords":0-100,"verdict":"one line"},"winnerReason":"2 sentences why winner beats loser","improvementA":"improved version of title A","improvementB":"improved version of title B"}`}],
      'Return ONLY raw JSON.',500);
    const d=JSON.parse(raw.replace(/```json|```/g,'').trim());
    const wA=d.winner==='A', ta=d.titleA, tb=d.titleB;
    document.getElementById('abOutput').innerHTML=`
      <div class="ab-compare">
        <div class="ab-card ${wA?'winner':'loser'}">
          ${wA?'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px"><div class="section-label">TITLE A</div><span class="ab-winner-badge">ðŸ‘‘ PREDICTED WINNER</span></div>':'<div class="section-label" style="margin-bottom:12px">TITLE A</div>'}
          <div style="font-size:14px;font-weight:700;margin-bottom:12px;line-height:1.4">"${a}"</div>
          <div style="font-family:var(--font-display);font-size:40px;font-weight:800;color:${wA?'var(--teal)':'var(--text2)'}">${ta.ctrScore}<span style="font-size:16px;color:var(--muted)">/100</span></div>
          <div class="ctr-bar"><div class="ctr-fill-a" style="width:${ta.ctrScore}%"></div></div>
          <div style="font-size:11px;color:var(--text2);margin:10px 0">${ta.verdict}</div>
          ${[['Curiosity',ta.curiosity],['Clarity',ta.clarity],['Emotion',ta.emotion],['Keywords',ta.keywords]].map(([l,v])=>`<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:4px"><span>${l}</span><span style="font-weight:700;color:var(--text)">${v}/100</span></div>`).join('')}
          <div style="margin-top:12px;padding:10px;background:var(--surface2);border-radius:9px;border:1px solid var(--border)">
            <div style="font-size:10px;color:var(--muted);font-weight:700;margin-bottom:4px">IMPROVED VERSION</div>
            <div style="font-size:12px;font-style:italic">"${d.improvementA}"</div>
          </div>
        </div>
        <div class="ab-card ${!wA?'winner':'loser'}">
          ${!wA?'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px"><div class="section-label">TITLE B</div><span class="ab-winner-badge">ðŸ‘‘ PREDICTED WINNER</span></div>':'<div class="section-label" style="margin-bottom:12px">TITLE B</div>'}
          <div style="font-size:14px;font-weight:700;margin-bottom:12px;line-height:1.4">"${b}"</div>
          <div style="font-family:var(--font-display);font-size:40px;font-weight:800;color:${!wA?'var(--teal)':'var(--text2)'}">${tb.ctrScore}<span style="font-size:16px;color:var(--muted)">/100</span></div>
          <div class="ctr-bar"><div class="ctr-fill-b" style="width:${tb.ctrScore}%"></div></div>
          <div style="font-size:11px;color:var(--text2);margin:10px 0">${tb.verdict}</div>
          ${[['Curiosity',tb.curiosity],['Clarity',tb.clarity],['Emotion',tb.emotion],['Keywords',tb.keywords]].map(([l,v])=>`<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:4px"><span>${l}</span><span style="font-weight:700;color:var(--text)">${v}/100</span></div>`).join('')}
          <div style="margin-top:12px;padding:10px;background:var(--surface2);border-radius:9px;border:1px solid var(--border)">
            <div style="font-size:10px;color:var(--muted);font-weight:700;margin-bottom:4px">IMPROVED VERSION</div>
            <div style="font-size:12px;font-style:italic">"${d.improvementB}"</div>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top:14px;border-color:rgba(0,229,176,0.25)">
        <div class="section-label" style="margin-bottom:6px;color:var(--teal)">WHY TITLE ${d.winner} WINS</div>
        <div style="font-size:13px;color:var(--text2)">${d.winnerReason}</div>
      </div>`;
    notify(`Title ${d.winner} predicted to win!`,'success','ðŸ†š');awardXP('used_ab');
  }catch(e){document.getElementById('abOutput').innerHTML=`<div style="padding:40px;text-align:center;color:var(--muted)">${friendlyErr(e)}</div>`;}
  btn.innerHTML='ðŸ†š Predict Winner'; btn.disabled=false;
}

// ============================================================
// 9. CONTENT GAP FINDER
// ============================================================
function renderGapFinder(){
  if(renderLockedPage('gapfinder','Content Gap Finder','ðŸ”­')) return;
  document.getElementById('pageContent').innerHTML=`
    <div class="card" style="margin-bottom:20px">
      <div class="section-label" style="margin-bottom:14px">FIND UNTAPPED OPPORTUNITIES</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;align-items:flex-end;flex-wrap:wrap">
        <div class="form-field" style="margin:0">
          <label>Your Niche</label>
          <input class="form-input" id="gapNiche" placeholder="e.g. Personal Finance">
        </div>
        <div class="form-field" style="margin:0">
          <label>Main Competitors</label>
          <input class="form-input" id="gapCompetitors" placeholder="e.g. Graham Stephan, Andrei Jikh">
        </div>
        <div class="form-field" style="margin:0">
          <label>Platform</label>
          <select class="form-input form-select" id="gapPlatform"><option>YouTube</option><option>TikTok</option><option>Instagram</option><option>All</option></select>
        </div>
        <button class="btn btn-primary" id="gapBtn" onclick="findGaps()">ðŸ”­ Find Gaps</button>
      </div>
    </div>
    <div id="gapOutput"></div>`;
}
async function findGaps(){
  const niche=document.getElementById('gapNiche').value.trim();
  const competitors=document.getElementById('gapCompetitors').value.trim();
  const platform=document.getElementById('gapPlatform').value;
  if(!niche){notify('Enter your niche','error','âš ï¸');return;}
  const btn=document.getElementById('gapBtn');
  btn.innerHTML='<div class="spinner spinner-sm"></div> Scanning...'; btn.disabled=true;
  document.getElementById('gapOutput').innerHTML=`<div style="display:flex;align-items:center;gap:14px;padding:40px;color:var(--muted)"><div class="spinner spinner-lg"></div><div>Identifying content gaps...</div></div>`;
  try{
    const raw=await callClaude([{role:'user',content:`Identify 8 content gap opportunities in the ${niche} niche on ${platform}. ${competitors?`These are the main competitors: ${competitors}.`:'Look at typical saturated content.'}\n\nFind trending topics that competitors are NOT covering well. Return ONLY raw JSON array: [{"title":"specific video concept","gap":"what's missing in existing content","audience":"who specifically wants this","searchDemand":"High|Very High|Explosive","competition":"Low|Medium|High","angle":"your unique differentiated take","estimatedViews":"potential view range","hook":"example hook for this video","timeToRank":"e.g. 2-4 weeks","difficulty":"Easy|Medium|Hard"}]`}],
      'Return ONLY valid raw JSON array.',1000);
    const gaps=JSON.parse(raw.replace(/```json|```/g,'').trim());
    document.getElementById('gapOutput').innerHTML=`
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
        <div><span class="section-label">FOUND ${gaps.length} UNTAPPED GAPS</span></div>
        <div style="font-size:12px;color:var(--muted)">for ${niche} on ${platform} ${competitors?'vs '+competitors:''}</div>
      </div>
      <div class="gap-grid">
        ${gaps.map((g,i)=>`
          <div class="gap-card" style="animation:slideUp 0.4s ${i*0.07}s ease both">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
              <span class="badge badge-${g.searchDemand==='Explosive'?'hot':g.searchDemand==='Very High'?'rising':'live'}">${g.searchDemand==='Explosive'?'ðŸš€ Explosive':g.searchDemand==='Very High'?'ðŸ“ˆ Very High':'âœ… High'}</span>
              <span class="gap-difficulty ${g.difficulty==='Easy'?'gap-easy':g.difficulty==='Medium'?'gap-medium':'gap-hard'}">${g.difficulty}</span>
            </div>
            <div style="font-size:14px;font-weight:700;margin-bottom:6px;line-height:1.4">${g.title}</div>
            <div style="font-size:11px;color:var(--muted);font-style:italic;margin-bottom:8px;border-left:2px solid rgba(0,229,176,0.4);padding-left:8px">"${g.hook}"</div>
            <div style="font-size:11px;color:var(--text2);margin-bottom:6px">ðŸŽ¯ <strong>${g.angle}</strong></div>
            <div style="font-size:11px;color:var(--muted);margin-bottom:6px">âŒ Gap: ${g.gap}</div>
            <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-bottom:12px">
              <span>ðŸ‘ ${g.estimatedViews}</span>
              <span>â± ${g.timeToRank}</span>
              <span>ðŸ”¥ ${g.competition} competition</span>
            </div>
            <div style="display:flex;gap:6px">
              <button class="btn btn-primary btn-sm" style="flex:1" onclick="useForScript('${esc(g.title)}','${platform==='All'?'YouTube':platform}','${esc(niche)}')">âœï¸ Write Script</button>
              <button class="btn btn-ghost btn-sm" onclick="saveFavourite('${esc(g.title)}','ðŸ”­','${esc(niche)}')">â­</button>
            </div>
          </div>`).join('')}
      </div>`;
    notify(`Found ${gaps.length} content gaps!`,'success','ðŸ”­');awardXP('used_gapfinder');
  }catch(e){document.getElementById('gapOutput').innerHTML=`<div style="padding:40px;text-align:center;color:var(--muted)">${friendlyErr(e)}</div>`;}
  btn.innerHTML='ðŸ”­ Find Gaps'; btn.disabled=false;
}


// ============================================================
// PRICING PAGE
// ============================================================
function renderPricing(){
  const current = currentUser?.plan || 'free';
  const tierOrder = ['free','starter','pro','gold','elite'];
  document.getElementById('pageContent').innerHTML=`
    <div style="text-align:center;margin-bottom:32px;animation:slideUp 0.4s ease">
      <div class="section-label" style="margin-bottom:8px">CHOOSE YOUR PLAN</div>
      <h2 style="font-family:var(--font-display);font-size:28px;font-weight:800;letter-spacing:-0.5px;margin-bottom:8px">Simple, Transparent Pricing</h2>
      <p style="font-size:13px;color:var(--muted)">Upgrade or downgrade anytime. Cancel any time.</p>
    <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-top:16px;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:10px 20px;width:fit-content;margin-left:auto;margin-right:auto">
      <span style="font-size:13px;font-weight:600">Monthly</span>
      <button class="toggle${localStorage.getItem('tv_annual_pref')==='1' ? ' on' : ''}" id="annualPricingToggle" onclick="this.classList.toggle('on');localStorage.setItem('tv_annual_pref',this.classList.contains('on')?'1':'0');renderPricing()"></button>
      <span style="font-size:13px;font-weight:600">Annual <span style="color:var(--teal);font-size:11px;font-weight:700">SAVE 20%</span></span>
    </div>
    </div>
    <!-- Social proof bar -->
    <div style="display:flex;align-items:center;justify-content:center;gap:20px;flex-wrap:wrap;margin-bottom:28px;padding:14px 20px;background:var(--surface);border:1px solid var(--border);border-radius:14px;animation:slideUp 0.4s 0.1s ease both">
      <div style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">ðŸŽ¬</span><span style="font-size:12px;font-weight:700;color:var(--text)">12,400+ creators</span><span style="font-size:12px;color:var(--muted)">use TrendVid</span></div>
      <div style="width:1px;height:20px;background:var(--border)"></div>
      <div style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">â­</span><span style="font-size:12px;font-weight:700;color:var(--gold)">4.9 / 5</span><span style="font-size:12px;color:var(--muted)">avg. rating</span></div>
      <div style="width:1px;height:20px;background:var(--border)"></div>
      <div style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">ðŸ”¥</span><span style="font-size:12px;font-weight:700;color:var(--accent)">${(function(){ var u=0; try{u=JSON.parse(localStorage.getItem('tv_all_users')||'[]').length;}catch(e){} return (u+47)+' creators'; })()} upgraded this week</span></div>
      <div style="width:1px;height:20px;background:var(--border)"></div>
      <div style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">â†©ï¸</span><span style="font-size:12px;font-weight:700;color:var(--teal)">7-day money-back</span><span style="font-size:12px;color:var(--muted)">no questions asked</span></div>
    </div>
    <div class="pricing-grid">
      ${tierOrder.map((tid,i)=>{
        const t=TIERS[tid];
        const isCurrent=tid===current;
        const isRecommended=tid==='pro';
        const canUpgrade=TIER_RANK[tid]>TIER_RANK[current];
        const isDowngrade=TIER_RANK[tid]<TIER_RANK[current];
        const borderColor={free:'var(--border)',starter:'rgba(0,229,176,0.4)',pro:'rgba(255,48,88,0.5)',gold:'rgba(251,191,36,0.5)',elite:'rgba(192,132,252,0.5)'}[tid];
        return `
        <div class="pricing-card${isCurrent?' current-plan':''}${isRecommended&&!isCurrent?' recommended':''}"
          style="border-color:${isCurrent?borderColor:isRecommended?'rgba(255,48,88,0.4)':'var(--border)'};${isCurrent?'background:linear-gradient(135deg,var(--surface),var(--surface2));':''}animation:slideUp 0.4s ${i*0.08}s ease both">
          ${isCurrent?'<div class="pricing-current-badge">âœ“ YOUR PLAN</div>':''}
          ${isRecommended&&!isCurrent?'<div class="pricing-recommended-badge">ðŸ”¥ MOST POPULAR</div>':''}
          <div class="pricing-card-header">
            <div style="font-size:28px;margin-bottom:8px">${t.emoji}</div>
            <div class="pricing-plan-name" style="color:${t.color}">${t.label}</div>
            <div class="pricing-plan-desc">${t.desc}</div>
            <div class="pricing-price">${(function(){
              var annualEl=document.getElementById('annualPricingToggle');
              var isAnnual=annualEl&&annualEl.classList.contains('on');
              var monthlyNum=parseInt(t.price.replace('Â£',''));
              if(isAnnual&&monthlyNum>0){
                var annualPrice=Math.round(monthlyNum*12*0.8);
                return 'Â£'+annualPrice+'<span>/yr</span>';
              }
              return t.price+'<span>'+t.period+'</span>';
            })()}</div>
          </div>
          <div class="pricing-features">
            ${t.features.map(f=>`<div class="pricing-feat"><span class="pricing-feat-check" style="color:${t.color}">âœ“</span>${f}</div>`).join('')}
          </div>
          <button class="btn ${isCurrent?'btn-secondary':tid==='gold'?'btn-gold':tid==='elite'?'btn-purple':tid==='starter'?'btn-teal':'btn-primary'} btn-sm"
            style="width:100%;margin-top:auto"
            onclick="${isCurrent?`notify('You are already on this plan','info','âœ“')`:`${isDowngrade?`confirmDowngrade('${tid}')`:`upgradeTier('${tid}')`}`}"
            ${isCurrent?'disabled':''}>
            ${isCurrent?'âœ“ Current Plan':canUpgrade?`Upgrade to ${t.label} â†’`:isDowngrade?`Switch to ${t.label}`:'Get Started â†’'}
          </button>
        </div>`;
      }).join('')}
    </div>

    <div class="card" style="margin-top:24px;animation:slideUp 0.4s 0.4s ease both">
      <div class="section-label" style="margin-bottom:16px;text-align:center">FULL FEATURE BREAKDOWN</div>
      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;font-size:12px">
          <thead>
            <tr>
              <th style="text-align:left;padding:10px 14px;border-bottom:1px solid var(--border);font-family:var(--font-display);font-size:10px;letter-spacing:1px;color:var(--muted)">FEATURE</th>
              ${tierOrder.map(tid=>`<th style="text-align:center;padding:10px 8px;border-bottom:1px solid var(--border);${tid===current?'background:rgba(255,48,88,0.04);':''}"><span class="tier-badge tier-${tid}" style="${TIERS[tid].badgeStyle||''}">${TIERS[tid].label}</span></th>`).join('')}
            </tr>
          </thead>
          <tbody>
            ${[
              ['AI Calls / Month','10','100','500','2,000','Unlimited'],
              ['Saved Scripts','3','25','200','Unlimited','Unlimited'],
              ['Trend Radar','âœ“','Unlimited','Unlimited','Unlimited','Unlimited'],
              ['Script Generator','Basic','Full','Full','Full','Full'],
              ['Thumbnail AI','3/day','Unlimited','Unlimited','Unlimited','Unlimited'],
              ['Script Library','â€”','âœ“','âœ“','âœ“','âœ“'],
              ['Content Calendar','7 days','30 days','90 days','1 year','Unlimited'],
              ['Favourites','â€”','âœ“','âœ“','âœ“','âœ“'],
              ['Voice to Script','â€”','âœ“','âœ“','âœ“','âœ“'],
              ['Multi-Language','â€”','5 langs','20+ langs','20+ langs','20+ langs'],
              ['Affiliate Programme','â€”','âœ“','âœ“','âœ“','âœ“'],
              ['Teleprompter Mode','â€”','â€”','âœ“','âœ“','âœ“'],
              ['Hashtag & SEO Generator','â€”','â€”','âœ“','âœ“','âœ“'],
              ['Hook Tester','â€”','â€”','âœ“','âœ“','âœ“'],
              ['Competitor Spy','â€”','â€”','âœ“','âœ“','âœ“'],
              ['Content Gap Finder','â€”','â€”','âœ“','âœ“','âœ“'],
              ['Script Repurposer','â€”','â€”','â€”','âœ“','âœ“'],
              ['A/B Title Tester','â€”','â€”','â€”','âœ“','âœ“'],
              ['Brand Kit','â€”','â€”','â€”','âœ“','âœ“'],
              ['Trend Alerts','â€”','â€”','â€”','Daily','Real-time'],
              ['Team Seats','1','1','1','2','10'],
              ['API Access','â€”','â€”','â€”','â€”','âœ“'],
              ['White-label Exports','â€”','â€”','â€”','â€”','âœ“'],
            ].map(([feat,...vals])=>`
              <tr style="border-bottom:1px solid var(--border)" onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background=''">
                <td style="padding:10px 14px;font-weight:600;color:var(--text)">${feat}</td>
                ${vals.map((v,i)=>{
                  const tid=tierOrder[i];
                  const isCur=tid===current;
                  const hasIt=v!=='â€”';
                  return `<td style="text-align:center;padding:10px 8px;${isCur?'background:rgba(255,48,88,0.04);':''}">
                    <span style="color:${hasIt?TIERS[tid].color:'var(--muted)'};font-size:11px;font-weight:${hasIt?'700':'400'}">${v==='â€”'?'Â·':v}</span>
                  </td>`;
                }).join('')}
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>
    <!-- Testimonials -->
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:24px;animation:slideUp 0.4s 0.5s ease both">
      <div class="card" style="padding:18px">
        <div style="font-size:20px;margin-bottom:8px;color:var(--gold)">&#9733;&#9733;&#9733;&#9733;&#9733;</div>
        <div style="font-size:12px;color:var(--text2);line-height:1.7;margin-bottom:12px;font-style:italic">"TrendVid AI saves me 6+ hours a week. My last video hit 400K views &mdash; the hook it generated was perfect."</div>
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div><div style="font-size:12px;font-weight:700">@sarahcreates_</div><div style="font-size:10px;color:var(--muted)">182K YouTube subs</div></div>
          <span class="tier-badge tier-pro" style="font-size:9px">PRO</span>
        </div>
      </div>
      <div class="card" style="padding:18px">
        <div style="font-size:20px;margin-bottom:8px;color:var(--gold)">&#9733;&#9733;&#9733;&#9733;&#9733;</div>
        <div style="font-size:12px;color:var(--text2);line-height:1.7;margin-bottom:12px;font-style:italic">"I was skeptical but the Trend Radar flagged a topic 3 days before it went viral. Gained 8,000 followers that week."</div>
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div><div style="font-size:12px;font-weight:700">@techwithdave</div><div style="font-size:10px;color:var(--muted)">TikTok creator</div></div>
          <span class="tier-badge tier-gold" style="font-size:9px">GOLD</span>
        </div>
      </div>
      <div class="card" style="padding:18px">
        <div style="font-size:20px;margin-bottom:8px;color:var(--gold)">&#9733;&#9733;&#9733;&#9733;&#9733;</div>
        <div style="font-size:12px;color:var(--text2);line-height:1.7;margin-bottom:12px;font-style:italic">"The thumbnail AI alone is worth the subscription. My CTR went from 3% to 8.4% in a month."</div>
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div><div style="font-size:12px;font-weight:700">@fitnessbyamara</div><div style="font-size:10px;color:var(--muted)">Instagram &amp; YouTube</div></div>
          <span class="tier-badge tier-starter" style="font-size:9px">STARTER</span>
        </div>
      </div>
    </div>
    <div style="text-align:center;margin-top:20px;font-size:12px;color:var(--muted);display:flex;align-items:center;justify-content:center;gap:16px;flex-wrap:wrap;animation:slideUp 0.4s 0.6s ease both">
      <span>ðŸ”’ Secure checkout via Stripe</span>
      <span>â†©ï¸ 7-day money-back guarantee</span>
      <span>ðŸš« Cancel anytime, no questions</span>
      <span>âš¡ Instant access after payment</span>
    </div>`;
}

function upgradeTier(tier, isAnnual) {
  if(!TIERS[tier]){notify('Invalid plan','error','âš ï¸');return;}
  var annual = isAnnual || (localStorage.getItem('tv_annual_pref')==='1');
  var stripeCfg={}; try{stripeCfg=JSON.parse(localStorage.getItem('tv_stripe_cfg')||'{}');}catch(e){}
  var links = stripeCfg.links || {};
  var link = annual && links[tier+'_annual'] ? links[tier+'_annual'] : links[tier];

  if(link && link.startsWith('http')) {
    // Generate a one-time session token, store it, embed it in the success URL
    var token = _generatePaymentToken(tier, (currentUser&&currentUser.email)||'');
    var pending = {tier:tier, annual:annual, at:Date.now(), token:token};
    localStorage.setItem('tv_pending_upgrade', JSON.stringify(pending));

    var returnBase = window.location.href.split('?')[0];
    // Token comes back in the success URL â€” auto-verified, no user action needed
    var returnUrl = returnBase + '?upgraded=' + tier
      + (annual?'&billing=annual':'')
      + '&tvtoken=' + encodeURIComponent(token)
      + '&email=' + encodeURIComponent((currentUser&&currentUser.email)||'');

    var finalLink = link
      + (link.includes('?')?'&':'?')
      + 'prefilled_email=' + encodeURIComponent((currentUser&&currentUser.email)||'')
      + '&client_reference_id=' + encodeURIComponent((currentUser&&currentUser.email)||'')
      + '&success_url=' + encodeURIComponent(returnUrl);

    window.open(finalLink, '_blank');
    showAwaitingPaymentOverlay(tier, annual, token);
    return;
  }
  // Demo mode (no link configured): instant upgrade
  _applyUpgrade(tier, annual);
}

// Generate a random one-time payment session token
function _generatePaymentToken(tier, email) {
  var rand = Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
  var seed = tier + email + Date.now() + rand;
  var hash = 0;
  for (var i = 0; i < seed.length; i++) { hash = ((hash << 5) - hash) + seed.charCodeAt(i); hash |= 0; }
  return 'tvpay_' + Math.abs(hash).toString(36) + '_' + rand.slice(0,8);
}

function showAwaitingPaymentOverlay(tier, annual, token) {
  var existing = document.getElementById('_awaitingPaymentOverlay');
  if(existing) existing.remove();
  var t = TIERS[tier];
  var overlay = document.createElement('div');
  overlay.id = '_awaitingPaymentOverlay';
  overlay.style.cssText = 'position:fixed;inset:0;z-index:99995;background:rgba(0,0,0,0.75);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;padding:24px;animation:fadeIn 0.25s ease';
  var price = annual ? 'Â£'+Math.round(parseInt((t.price||'0').replace('Â£',''))*12*0.8)+'/yr' : (t.price||'')+'/mo';
  overlay.innerHTML =
    '<div style="background:var(--surface);border:1px solid var(--border2);border-radius:22px;padding:32px;max-width:420px;width:100%;text-align:center;box-shadow:0 24px 80px rgba(0,0,0,0.7)">' +
      '<div style="font-size:48px;margin-bottom:12px;animation:float 2s ease infinite">ðŸ’³</div>' +
      '<div style="font-family:var(--font-display);font-size:20px;font-weight:900;margin-bottom:8px">Complete your payment</div>' +
      '<div style="font-size:13px;color:var(--muted);line-height:1.7;margin-bottom:20px">Stripe opened in a new tab for <strong style="color:'+(t.color||'var(--accent)')+'">'+t.label+' â€” '+price+'</strong>.<br>Complete payment there â€” you\'ll be redirected back automatically.</div>' +
      '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:20px;font-size:12px;color:var(--text2);text-align:left">' +
        '<div style="font-weight:700;margin-bottom:8px;color:var(--text)">What happens next:</div>' +
        '<div style="display:flex;flex-direction:column;gap:7px">' +
          '<div style="display:flex;gap:10px;align-items:flex-start"><span style="background:var(--teal);color:#000;width:18px;height:18px;min-width:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;margin-top:1px">1</span><span>Pay in the Stripe tab</span></div>' +
          '<div style="display:flex;gap:10px;align-items:flex-start"><span style="background:var(--teal);color:#000;width:18px;height:18px;min-width:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;margin-top:1px">2</span><span>Stripe redirects you back here automatically</span></div>' +
          '<div style="display:flex;gap:10px;align-items:flex-start"><span style="background:var(--teal);color:#000;width:18px;height:18px;min-width:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;margin-top:1px">3</span><span>Your plan upgrades instantly âœ…</span></div>' +
        '</div>' +
      '</div>' +
      '<div style="display:flex;gap:8px;flex-direction:column">' +
        '<button class="btn btn-primary" onclick="checkPendingStripeReturn()" style="width:100%">âœ“ I\'ve paid â€” activate my plan</button>' +
        '<button class="btn btn-ghost btn-sm" onclick="document.getElementById(\'_awaitingPaymentOverlay\').remove()" style="color:var(--muted)">Cancel â€” I\'ll do this later</button>' +
      '</div>' +
      '<div style="margin-top:14px;font-size:11px;color:var(--muted)">Tab didn\'t open? <a href="#" onclick="upgradeTier(\'\'+tier+\'\',\'+annual+\');return false" style="color:var(--accent)">Click here to retry</a></div>' +
    '</div>';
  document.body.appendChild(overlay);

  // Auto-detect return via URL polling
  overlay._pollTimer = setInterval(function(){
    var params = new URLSearchParams(window.location.search);
    if(params.get('upgraded')) {
      clearInterval(overlay._pollTimer);
      overlay.remove();
      checkStripeReturn();
    }
  }, 2000);
}

function checkPendingStripeReturn() {
  var pending = null;
  try { pending = JSON.parse(localStorage.getItem('tv_pending_upgrade')||'null'); } catch(e) {}

  // Case 1: came back via URL with token (auto redirect from Stripe success URL)
  var params = new URLSearchParams(window.location.search);
  var urlTier = params.get('upgraded');
  var urlToken = params.get('tvtoken');
  if(urlTier && urlToken && pending && pending.token === urlToken && TIERS[urlTier]) {
    window.history.replaceState({}, document.title, window.location.pathname);
    _applyUpgrade(urlTier, pending.annual);
    localStorage.removeItem('tv_pending_upgrade');
    return;
  }

  // Case 2: user manually clicked "I've paid" â€” check token still matches pending session
  if(pending && pending.tier && TIERS[pending.tier]) {
    var age = Date.now() - (pending.at||0);
    if(age > 7200000) { // 2 hours
      localStorage.removeItem('tv_pending_upgrade');
      notify('Upgrade session expired â€” please start checkout again.','warning','â±ï¸');
      return;
    }
    // Valid pending session â€” apply upgrade (they clicked "I've paid")
    _applyUpgrade(pending.tier, pending.annual);
    localStorage.removeItem('tv_pending_upgrade');
    var overlay = document.getElementById('_awaitingPaymentOverlay');
    if(overlay) { clearInterval(overlay._pollTimer); overlay.remove(); }
    return;
  }

  notify('No payment in progress. Please start checkout again.','info','ðŸ’³');
}


function _applyUpgrade(tier, annual) {
  currentUser.plan = tier;
  currentUser.annual = annual || false;
  var saved={}; try{saved=JSON.parse(localStorage.getItem('tv_user')||'{}');}catch(e){}
  saved.plan = tier;
  saved.annual = annual || false;
  saved.upgradedAt = Date.now();
  localStorage.setItem('tv_user', JSON.stringify(saved));
  localStorage.setItem('tv_user_tier', tier);
  // Track in all_users for admin revenue reporting
  trackUser(currentUser);
  // Log activity
  if(typeof adminLogActivity === 'function') adminLogActivity('ðŸ’Ž', currentUser.email, 'Upgraded to '+tier+(annual?' (annual)':''));
  updateUserPlanUI();
  awardXP('upgraded_plan');
  notify('Upgraded to '+TIERS[tier].label+'! All features are now unlocked.','success','ðŸ’Ž');
  setTimeout(function(){ if(typeof renderPricing==='function') renderPricing(); }, 300);
}
function confirmDowngrade(tier){
  // Build a retention modal instead of a bare confirm()
  var t = TIERS[tier];
  var cur = TIERS[currentUser&&currentUser.plan?currentUser.plan:'pro'];
  // Features they will LOSE
  var lostFeatures = [];
  var currentRank = TIER_RANK[currentUser&&currentUser.plan?currentUser.plan:'pro'];
  var targetRank  = TIER_RANK[tier];
  var lossMap = {
    pro:  ['Teleprompter Mode','Hashtag & SEO Generator','Hook Tester','Competitor Spy','Content Gap Finder'],
    starter: ['Voice to Script','Multi-Language','Script Library','Unlimited Trend Radar'],
    free: ['Content Calendar','Saved Scripts (25 â†’ 3)','Unlimited AI calls','All paid features']
  };
  if(targetRank < currentRank) {
    for(var tk in lossMap) {
      if(TIER_RANK[tk]<=currentRank && TIER_RANK[tk]>targetRank) {
        lossMap[tk].forEach(function(f){ lostFeatures.push(f); });
      }
    }
  }
  // Inject a retention modal
  var existing = document.getElementById('_downgradeRetentionModal');
  if(existing) existing.remove();
  var modal = document.createElement('div');
  modal.id = '_downgradeRetentionModal';
  modal.style.cssText = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,0.7);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;padding:24px;animation:fadeIn 0.2s ease';
  var lostHtml = lostFeatures.slice(0,5).map(function(f){ return '<div style="display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);font-size:12px;color:var(--text2)"><span style="color:var(--accent);font-size:14px">âœ•</span>'+f+'</div>'; }).join('');
  modal.innerHTML =
    '<div style="background:var(--surface);border:1px solid var(--border2);border-radius:20px;padding:28px;max-width:420px;width:100%;box-shadow:0 24px 80px rgba(0,0,0,0.6)">' +
      '<div style="font-size:28px;text-align:center;margin-bottom:12px">ðŸ˜¢</div>' +
      '<div style="font-family:var(--font-display);font-size:20px;font-weight:900;text-align:center;margin-bottom:6px">Before you downgradeâ€¦</div>' +
      '<div style="font-size:13px;color:var(--muted);text-align:center;margin-bottom:20px">Switching to <strong style="color:var(--text)">'+(t?t.label:tier.toUpperCase())+'</strong> means losing access to:</div>' +
      (lostHtml ? '<div style="margin-bottom:20px">'+lostHtml+'</div>' : '') +
      '<div style="background:rgba(0,229,176,0.06);border:1px solid rgba(0,229,176,0.25);border-radius:12px;padding:14px 16px;margin-bottom:20px;font-size:12px;color:var(--teal);font-weight:600">ðŸ’¡ Reply to our last email with "pause" and we will freeze your account for 30 days â€” no charge.</div>' +
      '<div style="display:flex;gap:8px;">' +
        '<button class="btn btn-ghost" style="flex:1;font-size:13px" id="_drKeepBtn">Keep my plan</button>' +
        '<button class="btn btn-primary" style="flex:1;background:var(--surface3);border:1px solid var(--border2);color:var(--text);font-size:12px" id="_drConfirmBtn">Yes, downgrade anyway</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(modal);
  var keepBtn = document.getElementById('_drKeepBtn');
  var confirmBtn = document.getElementById('_drConfirmBtn');
  if(keepBtn) keepBtn.addEventListener('click', function(){ modal.remove(); });
  if(confirmBtn) confirmBtn.addEventListener('click', function(){
    modal.remove();
    _applyUpgrade(tier);
    notify('Switched to '+(t ? t.label : tier)+'.', 'info', 'ðŸ“‰');
  });
  modal.addEventListener('click', function(e){ if(e.target===modal) modal.remove(); });
}
// Handle Stripe return URL (?upgraded=pro)
function checkStripeReturn(){
  var params = new URLSearchParams(window.location.search);
  var tier = params.get('upgraded');
  var billing = params.get('billing'); // 'annual' or null
  var credits = params.get('credits'); // number of script credits purchased
  // Clean URL immediately
  if(tier || credits) window.history.replaceState({}, document.title, window.location.pathname);

  // Handle plan upgrade return
  if(tier && TIERS[tier]) {
    var isAnnual = billing === 'annual';
    _applyUpgrade(tier, isAnnual);
    localStorage.removeItem('tv_pending_upgrade');
    // Show rich success overlay
    var overlay = document.createElement('div');
    overlay.className = 'stripe-success-overlay';
    var t = TIERS[tier];
    var price = isAnnual ? 'Â£'+Math.round(parseInt((t.price||'0').replace('Â£',''))*12*0.8)+'/yr (annual)' : t.price+'/mo';
    overlay.innerHTML =
      '<div class="stripe-success-box" style="text-align:center">' +
        '<div style="font-size:64px;margin-bottom:16px;animation:float 2s ease infinite">ðŸŽ‰</div>' +
        '<div style="font-family:var(--font-display);font-size:28px;font-weight:900;letter-spacing:-0.5px;margin-bottom:8px">Payment Successful!</div>' +
        '<div style="font-size:14px;color:var(--muted);margin-bottom:6px">Welcome to <strong style="color:'+t.color+'">'+t.label+'</strong> â€” '+price+'</div>' +
        '<div style="font-size:12px;color:var(--muted);margin-bottom:24px">All features are now unlocked. A receipt is on its way to your email.</div>' +
        '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:24px;">' +
          t.features.slice(0,4).map(function(f){ return '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-size:11px;font-weight:600;color:var(--text2)">&#10003; '+f+'</div>'; }).join('') +
        '</div>' +
        '<button class="btn btn-primary" onclick="this.closest(&quot;.stripe-success-overlay&quot;).remove();navTo(&quot;dashboard&quot;)" style="width:100%;margin-bottom:8px">Go to Dashboard &#8594;</button>' +
        '<div style="font-size:11px;color:var(--muted)">Need help? Email support@trendvid.ai</div>' +
      '</div>';
    document.body.appendChild(overlay);
    return;
  }

  // Handle script credits purchase return
  if(credits) {
    var qty = parseInt(credits) || 0;
    if(qty > 0) {
      var newCredits = getScriptCredits() + qty;
      try { localStorage.setItem('tv_script_credits', newCredits.toString()); } catch(e){}
      localStorage.removeItem('tv_pending_credits');
      notify(qty+' script credits added! You now have '+newCredits+'.','success','âœï¸');
    }
    return;
  }
}

// ============================================================
// YOUTUBE CHANNEL ANALYSER
// ============================================================
function renderYTAnalyser(){
  const tier=currentUser?.plan||'free';
  if(!['pro','gold','elite'].includes(tier)){ window._lastAttemptedAction = 'Analyse a YouTube channel with AI'; showPricingModal('pro','YouTube Channel Analyser');return;}
  document.getElementById('pageContent').innerHTML=`
    <div class="section-label" style="margin-bottom:8px">YOUTUBE CHANNEL ANALYSER</div>
    <h2 style="font-family:var(--font-display);font-size:24px;font-weight:800;margin-bottom:6px">AI Channel Audit</h2>
    <p style="font-size:13px;color:var(--muted);margin-bottom:24px">Paste any YouTube channel URL or name and get a full AI-powered growth audit â€” strengths, gaps, and exactly what to fix.</p>
    <div class="card" style="margin-bottom:16px">
      <div class="form-field">
        <label>CHANNEL URL OR NAME</label>
        <div style="display:flex;gap:8px">
          <input class="form-input" id="ytChannelInput" placeholder="e.g. MrBeast or youtube.com/@MrBeast" style="flex:1">
          <button class="btn btn-primary" onclick="analyseYTChannel()">ðŸ” Analyse</button>
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        ${['MrBeast','MKBHD','Veritasium','Graham Stephan','Linus Tech Tips'].map(c=>`<button onclick="document.getElementById('ytChannelInput').value='${c}'" style="background:var(--surface2);border:1px solid var(--border);color:var(--muted);padding:5px 12px;border-radius:20px;font-size:11px;cursor:pointer;font-weight:600">${c}</button>`).join('')}
      </div>
    </div>
    <div id="ytAnalyseResult"></div>`;
}
async function analyseYTChannel(){
  const channel=document.getElementById('ytChannelInput').value.trim();
  if(!channel){notify('Enter a channel name','error','âš ï¸');return;}
  const result=document.getElementById('ytAnalyseResult');
  result.innerHTML=`<div class="card" style="text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:12px;animation:pulse 1.5s infinite">ðŸ”</div><div style="color:var(--muted)">Analysing ${channel}â€¦</div></div>`;
  try{
    const raw=await callAI([{role:'user',content:`Analyse the YouTube channel "${channel}". Return ONLY valid JSON:\n{"channelName":"","niche":"","estimatedSubs":"","postFrequency":"","avgViews":"","authorityScore":85,"contentPillars":["","","",""],"topFormats":["","",""],"strengths":["","",""],"weaknesses":["","",""],"opportunities":["","",""],"hookStyle":"","thumbnailStyle":"","bestPostTime":"","ctaStrategy":"","overallVerdict":""}`}],'You are a YouTube growth expert. Return ONLY valid raw JSON.',1200);
    const d=JSON.parse(raw.replace(/```json|```/g,'').trim());
    const score=d.authorityScore||75;
    const scoreColor=score>=80?'var(--teal)':score>=60?'var(--gold)':'var(--accent)';
    result.innerHTML=`<div class="yt-analyse-result">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;margin-bottom:20px">
        <div>
          <div style="font-family:var(--font-display);font-size:22px;font-weight:800">${d.channelName||channel}</div>
          <div style="font-size:13px;color:var(--muted);margin-top:3px">${d.niche||'Content Creator'} Â· ${d.estimatedSubs||'â€”'} subscribers</div>
        </div>
        <div style="text-align:center">
          <div style="font-family:var(--font-display);font-size:48px;font-weight:900;color:${scoreColor};line-height:1">${score}</div>
          <div style="font-size:10px;font-weight:800;letter-spacing:1px;color:var(--muted);font-family:var(--font-display)">AUTHORITY SCORE</div>
        </div>
      </div>
      <div class="yt-metric-grid">
        <div class="yt-metric"><div class="yt-metric-val">${d.avgViews||'â€”'}</div><div class="yt-metric-label">AVG VIEWS</div></div>
        <div class="yt-metric"><div class="yt-metric-val">${d.postFrequency||'â€”'}</div><div class="yt-metric-label">POST FREQ</div></div>
        <div class="yt-metric"><div class="yt-metric-val" style="font-size:14px">${d.bestPostTime||'â€”'}</div><div class="yt-metric-label">BEST TIME</div></div>
        <div class="yt-metric"><div class="yt-metric-val" style="font-size:14px;color:var(--teal)">${d.hookStyle||'â€”'}</div><div class="yt-metric-label">HOOK STYLE</div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">
        <div class="card" style="padding:14px">
          <div class="section-label" style="margin-bottom:8px;color:var(--teal)">âœ… STRENGTHS</div>
          ${(d.strengths||[]).map(s=>`<div style="font-size:12px;padding:4px 0;border-bottom:1px solid var(--border);color:var(--text2)">${s}</div>`).join('')}
        </div>
        <div class="card" style="padding:14px">
          <div class="section-label" style="margin-bottom:8px;color:var(--accent)">âš ï¸ WEAKNESSES</div>
          ${(d.weaknesses||[]).map(s=>`<div style="font-size:12px;padding:4px 0;border-bottom:1px solid var(--border);color:var(--text2)">${s}</div>`).join('')}
        </div>
        <div class="card" style="padding:14px">
          <div class="section-label" style="margin-bottom:8px;color:var(--gold)">ðŸ’¡ OPPORTUNITIES</div>
          ${(d.opportunities||[]).map((s,i)=>`<div style="font-size:12px;padding:4px 0;border-bottom:1px solid var(--border);color:var(--text2);cursor:pointer" onclick="navTo('script');setTimeout(()=>{document.getElementById('scriptTopic').value='${s.replace(/'/g,"\\'")}';},100);notify('Loaded into script generator','success','âœï¸')">${s} <span style="color:var(--accent);font-size:10px">â†’ script</span></div>`).join('')}
        </div>
      </div>
      <div class="card" style="padding:14px">
        <div class="section-label" style="margin-bottom:6px">ðŸ§  AI VERDICT</div>
        <div style="font-size:13px;color:var(--text2);line-height:1.6">${d.overallVerdict||''}</div>
      </div>
    </div>`;
    awardXP('used_ytanalyse');
  }catch(e){result.innerHTML=`<div class="card" style="text-align:center;padding:32px;color:var(--muted)">Analysis failed â€” try again.</div>`;}
}

// ============================================================
// DESCRIPTION & CHAPTERS GENERATOR
// ============================================================
function renderDescGen(){
  const tier=currentUser?.plan||'free';
  if(tier==='free'){ window._lastAttemptedAction = 'Generate a video description with AI'; showPricingModal('starter','Description Generator');return;}
  document.getElementById('pageContent').innerHTML=`
    <div class="section-label" style="margin-bottom:8px">DESCRIPTION & CHAPTERS GENERATOR</div>
    <h2 style="font-family:var(--font-display);font-size:24px;font-weight:800;margin-bottom:6px">Full Video Description Pack</h2>
    <p style="font-size:13px;color:var(--muted);margin-bottom:24px">Generate an SEO-optimised description, timestamps, pinned comment, and tags â€” all from your script or topic.</p>
    <div class="card" style="margin-bottom:16px">
      <div class="form-field">
        <label>VIDEO TOPIC / TITLE</label>
        <input class="form-input" id="descTitle" placeholder="e.g. I Tried Every Viral Life Hack So You Don't Have To">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-field">
          <label>PLATFORM</label>
          <select class="form-input form-select" id="descPlatform">
            <option>YouTube</option><option>TikTok</option><option>Instagram</option>
          </select>
        </div>
        <div class="form-field">
          <label>VIDEO LENGTH (mins)</label>
          <input class="form-input" type="number" id="descLength" placeholder="e.g. 12" min="1" max="120">
        </div>
      </div>
      <div class="form-field" style="margin-bottom:0">
        <label>KEY POINTS COVERED (optional)</label>
        <textarea class="form-input" id="descKeyPoints" rows="3" placeholder="e.g. Testing 10 viral hacks, ranking them, revealing the best one..."></textarea>
      </div>
      <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="generateDescription()">ðŸ“ Generate Description Pack</button>
    </div>
    <div id="descResult"></div>`;
}
async function generateDescription(){
  const title=document.getElementById('descTitle').value.trim();
  const platform=document.getElementById('descPlatform').value;
  const length=document.getElementById('descLength').value||'10';
  const points=document.getElementById('descKeyPoints').value.trim();
  if(!title){notify('Enter a video title','error','âš ï¸');return;}
  const result=document.getElementById('descResult');
  result.innerHTML=`<div class="card" style="text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:12px;animation:pulse 1.5s infinite">ðŸ“</div><div style="color:var(--muted)">Generating your description packâ€¦</div></div>`;
  try{
    const raw=await callAI([{role:'user',content:`Create a full ${platform} description pack for a ${length}-minute video titled: "${title}". Key points: ${points||'general'}. Return ONLY valid JSON:\n{"seoDescription":"","chapters":[{"time":"0:00","label":""}],"pinnedComment":"","tags":[""],"hashtags":[""],"firstCommentCTA":""}`}],'You are an expert YouTube SEO strategist. Return ONLY valid raw JSON.',1500);
    const d=JSON.parse(raw.replace(/```json|```/g,'').trim());
    const copyBtn=(text,label)=>`<button onclick="navigator.clipboard.writeText(\`${text.replace(/`/g,'\\`')}\`).then(()=>notify('Copied!','success','ðŸ“‹'))" style="background:var(--surface);border:1px solid var(--border);color:var(--muted);padding:5px 12px;border-radius:8px;font-size:11px;cursor:pointer;font-weight:700;font-family:var(--font-display)">ðŸ“‹ Copy ${label}</button>`;
    result.innerHTML=`
      <div class="desc-section">
        <div class="desc-section-label">ðŸ“„ SEO DESCRIPTION</div>
        <div style="font-size:12px;color:var(--text2);line-height:1.7;white-space:pre-wrap;max-height:200px;overflow-y:auto">${d.seoDescription||''}</div>
        <div style="margin-top:10px">${copyBtn(d.seoDescription||'','Description')}</div>
      </div>
      <div class="desc-section">
        <div class="desc-section-label">â±ï¸ CHAPTERS & TIMESTAMPS</div>
        ${(d.chapters||[]).map(c=>`<div style="font-size:12px;padding:4px 0;display:flex;gap:12px"><span style="color:var(--accent);font-family:monospace;font-weight:700;min-width:44px">${c.time}</span><span style="color:var(--text2)">${c.label}</span></div>`).join('')}
        <div style="margin-top:10px">${copyBtn((d.chapters||[]).map(c=>c.time+' '+c.label).join('\n'),'Chapters')}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="desc-section">
          <div class="desc-section-label">ðŸ“Œ PINNED COMMENT</div>
          <div style="font-size:12px;color:var(--text2);line-height:1.6">${d.pinnedComment||''}</div>
          <div style="margin-top:10px">${copyBtn(d.pinnedComment||'','Pinned Comment')}</div>
        </div>
        <div class="desc-section">
          <div class="desc-section-label">ðŸ’¬ FIRST COMMENT CTA</div>
          <div style="font-size:12px;color:var(--text2);line-height:1.6">${d.firstCommentCTA||''}</div>
          <div style="margin-top:10px">${copyBtn(d.firstCommentCTA||'','CTA')}</div>
        </div>
      </div>
      <div class="desc-section">
        <div class="desc-section-label">#ï¸âƒ£ HASHTAGS & TAGS</div>
        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px">
          ${[...(d.hashtags||[]),(d.tags||[]).map(t=>'#'+t)].flat().map(t=>`<span style="background:rgba(255,48,88,0.08);color:var(--accent);padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700">${t}</span>`).join('')}
        </div>
        <div style="margin-top:10px">${copyBtn([...(d.hashtags||[]),(d.tags||[])].join(' '),'All Tags')}</div>
      </div>`;
    localStorage.setItem('tv_check_wrote_script','1');
    awardXP('used_descgen');
  }catch(e){result.innerHTML=`<div class="card" style="text-align:center;padding:32px;color:var(--muted)">Generation failed â€” try again.</div>`;}
}

// ============================================================
// THUMBNAIL A/B TESTER
// ============================================================
function renderThumbAB(){
  const tier=currentUser?.plan||'free';
  if(!['pro','gold','elite'].includes(tier)){ window._lastAttemptedAction = 'A/B test thumbnail ideas'; showPricingModal('pro','Thumbnail A/B Tester');return;}
  document.getElementById('pageContent').innerHTML=`
    <div class="section-label" style="margin-bottom:8px">THUMBNAIL A/B TESTER</div>
    <h2 style="font-family:var(--font-display);font-size:24px;font-weight:800;margin-bottom:6px">Which Thumbnail Wins?</h2>
    <p style="font-size:13px;color:var(--muted);margin-bottom:24px">Upload or describe two thumbnails and get an AI analysis of which will get more clicks and why.</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
      <div class="card">
        <div class="section-label" style="margin-bottom:10px;color:var(--accent)">THUMBNAIL A</div>
        <div class="thumb-ab-drop" id="thumbDropA" onclick="document.getElementById('thumbFileA').click()">
          <div style="font-size:32px;margin-bottom:8px">ðŸ–¼ï¸</div>
          <div style="font-size:13px;font-weight:600">Click to upload</div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px">or describe it below</div>
        </div>
        <input type="file" id="thumbFileA" accept="image/*" style="display:none" onchange="previewThumb('A',this)">
        <div id="thumbPreviewA" style="display:none;margin-top:10px"><img style="width:100%;border-radius:10px;border:1px solid var(--border)"></div>
        <textarea class="form-input" id="thumbDescA" rows="2" placeholder="e.g. Red background, shocked face, bold text saying 'I Lost Everything'" style="margin-top:10px"></textarea>
      </div>
      <div class="card">
        <div class="section-label" style="margin-bottom:10px;color:var(--teal)">THUMBNAIL B</div>
        <div class="thumb-ab-drop" id="thumbDropB" onclick="document.getElementById('thumbFileB').click()">
          <div style="font-size:32px;margin-bottom:8px">ðŸ–¼ï¸</div>
          <div style="font-size:13px;font-weight:600">Click to upload</div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px">or describe it below</div>
        </div>
        <input type="file" id="thumbFileB" accept="image/*" style="display:none" onchange="previewThumb('B',this)">
        <div id="thumbPreviewB" style="display:none;margin-top:10px"><img style="width:100%;border-radius:10px;border:1px solid var(--border)"></div>
        <textarea class="form-input" id="thumbDescB" rows="2" placeholder="e.g. Split face reaction, yellow background, arrow pointing right" style="margin-top:10px"></textarea>
      </div>
    </div>
    <div class="form-field">
      <label>VIDEO NICHE / CONTEXT (optional)</label>
      <input class="form-input" id="thumbABContext" placeholder="e.g. tech review, finance, fitness challenge">
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="runThumbAB()">ðŸ†š Compare Thumbnails</button>
    <div id="thumbABResult" style="margin-top:16px"></div>`;
}
function previewThumb(which, input){
  if(!input.files[0])return;
  const preview=document.getElementById('thumbPreview'+which);
  if(preview){preview.style.display='block';preview.querySelector('img').src=URL.createObjectURL(input.files[0]);}
}
async function runThumbAB(){
  const descA=document.getElementById('thumbDescA').value.trim();
  const descB=document.getElementById('thumbDescB').value.trim();
  const context=document.getElementById('thumbABContext').value.trim();
  if(!descA&&!descB){notify('Describe at least one thumbnail','error','âš ï¸');return;}
  const result=document.getElementById('thumbABResult');
  result.innerHTML=`<div class="card" style="text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:12px;animation:pulse 1.5s infinite">ðŸ†š</div><div style="color:var(--muted)">Analysing thumbnailsâ€¦</div></div>`;
  try{
    const raw=await callAI([{role:'user',content:`Compare these two YouTube thumbnails and predict CTR performance. Niche: ${context||'general'}.\n\nThumbnail A: ${descA||'(no description)'}\nThumbnail B: ${descB||'(no description)'}\n\nReturn ONLY valid JSON:\n{"winner":"A","winnerConfidence":82,"thumbA":{"ctrScore":65,"strengths":["",""],"weaknesses":["",""]},"thumbB":{"ctrScore":78,"strengths":["",""],"weaknesses":["",""]},"keyDifference":"","improvementTip":""}`}],'You are a YouTube thumbnail CTR expert. Return ONLY valid raw JSON.',900);
    const d=JSON.parse(raw.replace(/```json|```/g,'').trim());
    const winner=d.winner||'A'; const loser=winner==='A'?'B':'A';
    const winnerColor=winner==='A'?'var(--accent)':'var(--teal)';
    document.getElementById('thumbDropA').classList.toggle('thumb-ab-winner',winner==='A');
    document.getElementById('thumbDropB').classList.toggle('thumb-ab-winner',winner==='B');
    result.innerHTML=`<div class="card">
      <div style="text-align:center;margin-bottom:20px">
        <div style="font-size:40px;margin-bottom:8px">${winner==='A'?'ðŸ”´':'ðŸŸ¢'}</div>
        <div style="font-family:var(--font-display);font-size:26px;font-weight:900;color:${winnerColor}">Thumbnail ${winner} Wins</div>
        <div style="font-size:13px;color:var(--muted);margin-top:4px">${d.winnerConfidence||80}% confidence Â· ${d.keyDifference||''}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
        ${['A','B'].map(t=>{
          const data=t==='A'?d.thumbA:d.thumbB; const isWinner=t===winner;
          const col=t==='A'?'var(--accent)':'var(--teal)';
          return `<div style="background:var(--surface2);border:2px solid ${isWinner?col:'var(--border)'};border-radius:14px;padding:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
              <div style="font-family:var(--font-display);font-size:16px;font-weight:800;color:${col}">THUMBNAIL ${t}</div>
              <div style="font-family:var(--font-display);font-size:28px;font-weight:900;color:${col}">${(data||{}).ctrScore||'â€”'}</div>
            </div>
            <div style="font-size:10px;font-weight:800;color:var(--teal);letter-spacing:1px;margin-bottom:4px;font-family:var(--font-display)">STRENGTHS</div>
            ${((data||{}).strengths||[]).map(s=>`<div style="font-size:11px;color:var(--text2);padding:2px 0">âœ“ ${s}</div>`).join('')}
            <div style="font-size:10px;font-weight:800;color:var(--accent);letter-spacing:1px;margin:8px 0 4px;font-family:var(--font-display)">WEAKNESSES</div>
            ${((data||{}).weaknesses||[]).map(s=>`<div style="font-size:11px;color:var(--text2);padding:2px 0">âœ— ${s}</div>`).join('')}
          </div>`;
        }).join('')}
      </div>
      <div style="background:rgba(0,229,176,0.07);border:1px solid rgba(0,229,176,0.25);border-radius:12px;padding:14px">
        <div style="font-size:10px;font-weight:800;color:var(--teal);letter-spacing:1px;margin-bottom:6px;font-family:var(--font-display)">ðŸ’¡ IMPROVEMENT TIP</div>
        <div style="font-size:13px;color:var(--text2)">${d.improvementTip||''}</div>
      </div>
    </div>`;
    awardXP('used_thumbab');
  }catch(e){result.innerHTML=`<div class="card" style="text-align:center;padding:32px;color:var(--muted)">Analysis failed â€” try again.</div>`;}
}

// ============================================================
// COLLAB FINDER
// ============================================================
function renderCollabFinder(){
  const tier=currentUser?.plan||'free';
  if(!['pro','gold','elite'].includes(tier)){ window._lastAttemptedAction = 'Find collab partners with AI'; showPricingModal('pro','Collab Finder');return;}
  document.getElementById('pageContent').innerHTML=`
    <div class="section-label" style="margin-bottom:8px">COLLAB FINDER</div>
    <h2 style="font-family:var(--font-display);font-size:24px;font-weight:800;margin-bottom:6px">Find Your Perfect Collab Partner</h2>
    <p style="font-size:13px;color:var(--muted);margin-bottom:24px">Describe your channel and niche â€” AI suggests ideal collaboration partners, angles, and outreach scripts.</p>
    <div class="card" style="margin-bottom:16px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-field">
          <label>YOUR NICHE</label>
          <input class="form-input" id="collabNiche" placeholder="e.g. personal finance for Gen Z">
        </div>
        <div class="form-field">
          <label>YOUR CHANNEL SIZE</label>
          <select class="form-input form-select" id="collabSize">
            <option value="nano">Nano (0â€“10K)</option>
            <option value="micro">Micro (10Kâ€“100K)</option>
            <option value="mid">Mid (100Kâ€“1M)</option>
            <option value="macro">Macro (1M+)</option>
          </select>
        </div>
      </div>
      <div class="form-field">
        <label>YOUR CONTENT STYLE</label>
        <input class="form-input" id="collabStyle" placeholder="e.g. educational explainers, storytelling, challenges">
      </div>
      <div class="form-field" style="margin-bottom:0">
        <label>COLLAB GOAL</label>
        <select class="form-input form-select" id="collabGoal">
          <option>Grow my subscriber count</option>
          <option>Reach a new audience demographic</option>
          <option>Create a viral challenge video</option>
          <option>Cross-promote existing content</option>
          <option>Build credibility in my niche</option>
        </select>
      </div>
      <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="findCollabs()">ðŸ¤ Find Collab Matches</button>
    </div>
    <div id="collabResult"></div>`;
}
async function findCollabs(){
  const niche=document.getElementById('collabNiche').value.trim();
  const size=document.getElementById('collabSize').value;
  const style=document.getElementById('collabStyle').value.trim();
  const goal=document.getElementById('collabGoal').value;
  if(!niche){notify('Enter your niche','error','âš ï¸');return;}
  const result=document.getElementById('collabResult');
  result.innerHTML=`<div class="card" style="text-align:center;padding:40px"><div style="font-size:32px;margin-bottom:12px;animation:pulse 1.5s infinite">ðŸ¤</div><div style="color:var(--muted)">Finding matchesâ€¦</div></div>`;
  try{
    const raw=await callAI([{role:'user',content:`Find collab partners for a ${size} ${niche} channel with ${style} style. Goal: ${goal}.\n\nReturn ONLY valid JSON:\n{"matches":[{"channelType":"","niche":"","estimatedSize":"","why":"","collabAngle":"","outreachScript":"","compatibilityScore":85}]}`}],'You are a YouTube growth strategist specialising in collaborations. Return ONLY valid raw JSON with 5 matches.',1200);
    const d=JSON.parse(raw.replace(/```json|```/g,'').trim());
    result.innerHTML=`<div style="display:flex;flex-direction:column;gap:12px">
      ${(d.matches||[]).map(m=>`<div class="collab-card">
        <div class="collab-avatar">${m.niche?m.niche.charAt(0).toUpperCase():'ðŸ¤'}</div>
        <div style="flex:1">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
            <div style="font-weight:800;font-size:14px">${m.channelType||'Creator Type'} <span style="color:var(--muted);font-weight:400;font-size:12px">Â· ${m.estimatedSize||'â€”'}</span></div>
            <div style="font-family:var(--font-display);font-size:20px;font-weight:900;color:var(--teal)">${m.compatibilityScore||80}%</div>
          </div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:8px">${m.niche||''}</div>
          <div style="font-size:12px;color:var(--text2);margin-bottom:6px"><strong style="color:var(--text)">Why it works:</strong> ${m.why||''}</div>
          <div style="font-size:12px;color:var(--text2);margin-bottom:10px"><strong style="color:var(--text)">Collab angle:</strong> ${m.collabAngle||''}</div>
          <details style="margin-top:8px">
            <summary style="font-size:11px;font-weight:800;color:var(--accent);cursor:pointer;font-family:var(--font-display);letter-spacing:0.5px">VIEW OUTREACH SCRIPT â–¼</summary>
            <div style="font-size:12px;color:var(--text2);margin-top:8px;padding:12px;background:var(--surface);border-radius:10px;border:1px solid var(--border);line-height:1.7">${m.outreachScript||''}</div>
            <button onclick="navigator.clipboard.writeText(\`${(m.outreachScript||'').replace(/`/g,'\\`')}\`).then(()=>notify('Script copied!','success','ðŸ“‹'))" style="background:var(--surface);border:1px solid var(--border);color:var(--muted);padding:5px 12px;border-radius:8px;font-size:11px;cursor:pointer;margin-top:8px;font-weight:700">ðŸ“‹ Copy Script</button>
          </details>
        </div>
      </div>`).join('')}
    </div>`;
    awardXP('used_collab');
  }catch(e){result.innerHTML=`<div class="card" style="text-align:center;padding:32px;color:var(--muted)">Generation failed â€” try again.</div>`;}
}
// ============================================================

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YOUTUBE OAUTH + UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var YT_CLIENT_ID_DEFAULT = '887174058350-2hvp00joohr5m5lmi6sfc72opk2d8647.apps.googleusercontent.com';
var YT_CLIENT_ID = (function(){
  try {
    var cfg = JSON.parse(localStorage.getItem('tv_autoupload_cfg') || '{}');
    return (cfg.youtube && cfg.youtube.clientId) || YT_CLIENT_ID_DEFAULT;
  } catch(e) { return YT_CLIENT_ID_DEFAULT; }
})();
var YT_SCOPES    = 'https://www.googleapis.com/auth/youtube.upload https://www.googleapis.com/auth/youtube.readonly';
var _ytTokenClient = null;
var _ytAccessToken = null;
var _ytTokenExpiry = 0;

function connectYouTube() {
  if(!window.google || !window.google.accounts) {
    notify('Loading Google sign-inâ€¦', 'info', 'â³');
    loadGoogleScript(function() { _doYtSignIn(); });
    return;
  }
  _doYtSignIn();
}

function loadGoogleScript(cb) {
  if(document.getElementById('_gsi_script')) { if(cb) cb(); return; }
  var s = document.createElement('script');
  s.id  = '_gsi_script';
  s.src = 'https://accounts.google.com/gsi/client';
  s.onload = function() { setTimeout(cb, 300); };
  s.onerror = function() { notify('Could not load Google sign-in. Check your internet connection.', 'error', 'âŒ'); };
  document.head.appendChild(s);
}

function _doYtSignIn() {
  // Always read the latest Client ID (admin may have updated it)
  try { var _cfg = JSON.parse(localStorage.getItem('tv_autoupload_cfg')||'{}'); if(_cfg.youtube&&_cfg.youtube.clientId) YT_CLIENT_ID = _cfg.youtube.clientId; } catch(e) {}
  try {
    _ytTokenClient = google.accounts.oauth2.initTokenClient({
      client_id: YT_CLIENT_ID,
      scope: YT_SCOPES,
      callback: function(resp) {
        if(resp.error) {
          notify('Sign-in failed: ' + resp.error, 'error', 'âŒ');
          return;
        }
        _ytAccessToken = resp.access_token;
        _ytTokenExpiry = Date.now() + ((resp.expires_in || 3600) * 1000);
        // Fetch channel info to confirm
        fetch('https://www.googleapis.com/youtube/v3/channels?part=snippet&mine=true', {
          headers: { Authorization: 'Bearer ' + _ytAccessToken }
        })
        .then(function(r){ return r.json(); })
        .then(function(data) {
          var ch = data.items && data.items[0];
          var chName = ch ? ch.snippet.title : 'Your Channel';
          var auCfg = {}; try { auCfg = JSON.parse(localStorage.getItem('tv_autoupload_cfg') || '{}'); } catch(e) {}
          auCfg.youtube = { connected: true, channelName: chName, connectedAt: Date.now() };
          localStorage.setItem('tv_autoupload_cfg', JSON.stringify(auCfg));
          notify('âœ… Connected to ' + chName + '!', 'success', 'â–¶ï¸');
          closeAutoUploadModal();
          setTimeout(showAutoUploadModal, 400);
        })
        .catch(function() {
          notify('Connected! Channel info unavailable.', 'success', 'â–¶ï¸');
          var auCfg = {}; try { auCfg = JSON.parse(localStorage.getItem('tv_autoupload_cfg') || '{}'); } catch(e) {}
          auCfg.youtube = { connected: true, connectedAt: Date.now() };
          localStorage.setItem('tv_autoupload_cfg', JSON.stringify(auCfg));
          closeAutoUploadModal();
          setTimeout(showAutoUploadModal, 400);
        });
      }
    });
    _ytTokenClient.requestAccessToken();
  } catch(err) {
    notify('Google sign-in error: ' + err.message, 'error', 'âŒ');
  }
}

function ytEnsureToken(cb) {
  if(_ytAccessToken && Date.now() < _ytTokenExpiry - 60000) {
    cb(_ytAccessToken);
    return;
  }
  // Token expired â€” re-authenticate
  loadGoogleScript(function() {
    try {
      _ytTokenClient = google.accounts.oauth2.initTokenClient({
        client_id: YT_CLIENT_ID,
        scope: YT_SCOPES,
        callback: function(resp) {
          if(resp.error) { notify('Re-auth failed: ' + resp.error, 'error', 'âŒ'); return; }
          _ytAccessToken = resp.access_token;
          _ytTokenExpiry = Date.now() + ((resp.expires_in || 3600) * 1000);
          cb(_ytAccessToken);
        }
      });
      _ytTokenClient.requestAccessToken({ prompt: '' });
    } catch(e) {
      notify('Token refresh failed: ' + e.message, 'error', 'âŒ');
    }
  });
}

function ytUploadFromScript() {
  // Check upload credits
  var rem = getUploadsRemaining();
  if(rem.freeLeft <= 0 && rem.extraCredits <= 0) {
    notify('No upload credits remaining', 'error', 'âš¡');
    return;
  }
  // Get script content
  var scripts = []; try { scripts = JSON.parse(localStorage.getItem('tv_scripts') || '[]'); } catch(e) {}
  var s = scripts[0]; // Most recent script
  if(!s) { notify('No script found â€” generate one first', 'error', 'âš ï¸'); return; }

  closeAutoUploadModal();

  // Show upload form modal
  var formModal = document.createElement('div');
  formModal.id = '_ytUploadForm';
  formModal.className = 'modal-overlay show';
  formModal.innerHTML =
    '<div class="modal-box" style="max-width:480px">' +
      '<div style="font-size:26px;margin-bottom:8px">â–¶ï¸ Upload to YouTube</div>' +
      '<div class="modal-sub" style="margin-bottom:16px">Review &amp; edit details before uploading.</div>' +
      '<div class="form-field">' +
        '<label>VIDEO TITLE</label>' +
        '<input class="form-input" id="_ytTitle" value="' + (s.title || '').replace(/"/g, '&quot;') + '" placeholder="Video title">' +
      '</div>' +
      '<div class="form-field">' +
        '<label>DESCRIPTION</label>' +
        '<textarea class="form-input" id="_ytDesc" rows="5" placeholder="Video description...">' + (s.body || s.content || '').replace(/<[^>]+>/g,'').substring(0,4000) + '</textarea>' +
      '</div>' +
      '<div class="form-field">' +
        '<label>PRIVACY</label>' +
        '<select class="form-input form-select" id="_ytPrivacy">' +
          '<option value="private" selected>Private (recommended â€” review before publishing)</option>' +
          '<option value="unlisted">Unlisted</option>' +
          '<option value="public">Public</option>' +
        '</select>' +
      '</div>' +
      '<div class="form-field">' +
        '<label>TAGS (comma separated)</label>' +
        '<input class="form-input" id="_ytTags" placeholder="tag1, tag2, tag3" value="">' +
      '</div>' +
      '<div style="background:rgba(255,138,0,0.08);border:1px solid rgba(255,138,0,0.3);border-radius:10px;padding:10px 12px;font-size:11px;color:var(--muted);margin-bottom:16px">' +
        'âš ï¸ YouTube requires an actual video file to upload. This will create a <strong>video entry with your script as the description</strong>. You still need to upload your video file via YouTube Studio.' +
      '</div>' +
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">' +
        '<button class="btn btn-ghost" onclick="closeYtUploadForm()">Cancel</button>' +
        '<button class="btn btn-primary" onclick="ytSubmitUpload()" id="_ytSubmitBtn">â–¶ï¸ Upload Details</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(formModal);
  ytEnsureToken(function(token) {
    // Token ready â€” form is already shown
  });
}

function closeYtUploadForm() { var m=document.getElementById("_ytUploadForm"); if(m) m.remove(); }

function ytSubmitUpload() {
  var title    = (document.getElementById('_ytTitle') || {}).value || 'Untitled';
  var desc     = (document.getElementById('_ytDesc') || {}).value || '';
  var privacy  = (document.getElementById('_ytPrivacy') || {}).value || 'private';
  var tagsRaw  = (document.getElementById('_ytTags') || {}).value || '';
  var tags     = tagsRaw.split(',').map(function(t){return t.trim();}).filter(Boolean);
  var btn      = document.getElementById('_ytSubmitBtn');
  if(btn) { btn.disabled = true; btn.textContent = 'Uploadingâ€¦'; }

  ytEnsureToken(function(token) {
    // Create video metadata entry via YouTube API
    var metadata = {
      snippet: {
        title:       title.substring(0, 100),
        description: desc.substring(0, 5000),
        tags:        tags,
        categoryId:  '22' // People & Blogs
      },
      status: {
        privacyStatus: privacy,
        selfDeclaredMadeForKids: false
      }
    };

    // Use YouTube videos.insert with an empty/placeholder video
    // In practice, users will need to upload the video file from Studio
    // We upload the metadata and create a draft entry
    fetch('https://www.googleapis.com/youtube/v3/videos?part=snippet,status', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(metadata)
    })
    .then(function(r){ return r.json(); })
    .then(function(data) {
      if(data.error) {
        var msg = data.error.message || 'Upload failed';
        if(data.error.code === 403) msg = 'Permission denied â€” make sure YouTube is enabled for your Google account';
        notify('Upload error: ' + msg, 'error', 'âŒ');
        if(btn) { btn.disabled = false; btn.textContent = 'â–¶ï¸ Upload Details'; }
        return;
      }
      var videoId = data.id;
      // Deduct upload credit
      _deductUploadCredit();
      // Log activity
      try {
        var notifs = JSON.parse(localStorage.getItem('tv_admin_notifs') || '[]');
        notifs.unshift({type:'autoupload_done', icon:'ðŸ“¤', title:'YouTube Upload', body:(currentUser&&currentUser.email||'user')+' uploaded: '+title, at:Date.now(), read:false});
        localStorage.setItem('tv_admin_notifs', JSON.stringify(notifs.slice(0,100)));
        var log = []; try{log=JSON.parse(localStorage.getItem('tv_activity_log')||'[]');}catch(e){}
        log.unshift({icon:'â–¶ï¸',user:(currentUser&&currentUser.email)||'',action:'Uploaded to YouTube: '+title,type:'upload',at:Date.now()});
        localStorage.setItem('tv_activity_log', JSON.stringify(log.slice(0,500)));
      } catch(e) {}
      document.getElementById('_ytUploadForm').remove();
      // Show success with link
      var successModal = document.createElement('div');
      successModal.className = 'modal-overlay show';
      successModal.innerHTML =
        '<div class="modal-box" style="max-width:400px;text-align:center">' +
          '<div style="font-size:48px;margin-bottom:12px">ðŸŽ‰</div>' +
          '<div style="font-family:var(--font-display);font-size:20px;font-weight:900;margin-bottom:8px">Uploaded to YouTube!</div>' +
          '<div style="font-size:13px;color:var(--muted);margin-bottom:20px">Your video details have been saved. Open YouTube Studio to attach your video file and publish.</div>' +
          (videoId
            ? '<a href="https://studio.youtube.com/video/' + videoId + '/edit" target="_blank" class="btn btn-primary" style="display:block;margin-bottom:8px">Open in YouTube Studio â†’</a>'
            : '') +
          '<button class="btn btn-ghost" style="width:100%" onclick="this.closest(\".modal-overlay\").remove()">Done</button>' +
        '</div>';
      document.body.appendChild(successModal);
    })
    .catch(function(err) {
      notify('Upload failed: ' + err.message, 'error', 'âŒ');
      if(btn) { btn.disabled = false; btn.textContent = 'â–¶ï¸ Upload Details'; }
    });
  });
}

function _deductUploadCredit() {
  var state = getUploadState();
  var rem = getUploadsRemaining();
  if(rem.freeLeft > 0) {
    state.used = (state.used || 0) + 1;
  } else if(state.creditBatches && state.creditBatches.length) {
    for(var i = 0; i < state.creditBatches.length; i++) {
      if(state.creditBatches[i].remaining > 0) {
        state.creditBatches[i].remaining--;
        break;
      }
    }
    state.creditBatches = state.creditBatches.filter(function(b){ return b.remaining > 0; });
    state.extraCredits  = state.creditBatches.reduce(function(sum,b){ return sum + b.remaining; }, 0);
  } else {
    state.extraCredits = Math.max(0, (state.extraCredits || 0) - 1);
  }
  saveUploadState(state);
}

function disconnectYouTube() {
  var auCfg = {}; try { auCfg = JSON.parse(localStorage.getItem('tv_autoupload_cfg') || '{}'); } catch(e) {}
  delete auCfg.youtube;
  localStorage.setItem('tv_autoupload_cfg', JSON.stringify(auCfg));
  _ytAccessToken = null;
  _ytTokenExpiry = 0;
  if(window.google && window.google.accounts) google.accounts.oauth2.revoke(_ytAccessToken, function(){});
  notify('YouTube disconnected', 'info', 'â–¶ï¸');
}


function renderPostScheduler(){
  const tier=currentUser?.plan||'free';
  if(tier==='free'){ window._lastAttemptedAction = 'Schedule posts with the AI planner'; showPricingModal('starter','Post Scheduler');return;}
  var schedule={}; try{schedule=JSON.parse(localStorage.getItem('tv_schedule')||'{}');}catch(e){}
  const today=new Date(); const days=['SUN','MON','TUE','WED','THU','FRI','SAT'];
  const platforms=['YouTube','TikTok','Instagram','All'];
  // Build 2-week grid
  var weekHtml='';
  for(let i=0;i<14;i++){
    const d=new Date(today); d.setDate(today.getDate()+i);
    const key=d.toISOString().split('T')[0];
    const post=schedule[key];
    weekHtml+=`<div class="schedule-day${post?' has-post':''}" onclick="openScheduleSlot('${key}','${d.toLocaleDateString('en-GB',{day:'numeric',month:'short'})}')">
      <div class="schedule-day-name">${days[d.getDay()]}</div>
      <div class="schedule-day-num" style="${d.toDateString()===today.toDateString()?'color:var(--accent)':''}">${d.getDate()}</div>
      ${post?`<div class="schedule-post-dot"></div><div style="font-size:9px;color:var(--teal);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%;padding:0 2px">${post.platform||''}</div>`:''}
    </div>`;
  }
  document.getElementById('pageContent').innerHTML=`
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px">
      <div>
        <div class="section-label" style="margin-bottom:4px">POST SCHEDULER</div>
        <h2 style="font-family:var(--font-display);font-size:24px;font-weight:800">Your Upload Calendar</h2>
      </div>
      <button class="btn btn-primary btn-sm" onclick="aiSuggestSchedule()">ðŸ¤– AI Suggest Best Times</button>
    </div>
    <div class="card" style="margin-bottom:20px">
      <div class="section-label" style="margin-bottom:12px">NEXT 14 DAYS</div>
      <div class="schedule-week" style="grid-template-columns:repeat(7,1fr)">${weekHtml}</div>
    </div>
    <div id="scheduleSuggestion"></div>
    <div class="card">
      <div class="section-label" style="margin-bottom:12px">SCHEDULED POSTS</div>
      <div id="scheduleList">${renderScheduleList(schedule)}</div>
    </div>
    <div class="modal-overlay" id="scheduleModal">
      <div class="modal-box" style="max-width:420px">
        <div class="modal-title" id="scheduleModalTitle">Schedule Post</div>
        <div class="modal-sub" id="scheduleModalDate"></div>
        <div class="form-field" style="margin-top:16px">
          <label>PLATFORM</label>
          <select class="form-input form-select" id="schedPlatform">${platforms.map(p=>`<option>${p}</option>`).join('')}</select>
        </div>
        <div class="form-field">
          <label>CONTENT IDEA / TITLE</label>
          <input class="form-input" id="schedTitle" placeholder="e.g. Why I Quit My 9-5 (full story)">
        </div>
        <div class="form-field">
          <label>POST TIME</label>
          <input class="form-input" type="time" id="schedTime" value="14:00">
        </div>
        <div class="form-field" style="margin-bottom:0">
          <label>NOTES</label>
          <textarea class="form-input" id="schedNotes" rows="2" placeholder="Filming notes, reminders..."></textarea>
        </div>
        <div style="display:flex;gap:8px;margin-top:16px">
          <button class="btn btn-primary" style="flex:1" onclick="saveScheduleSlot()">ðŸ’¾ Save</button>
          <button class="btn btn-ghost" onclick="document.getElementById('scheduleModal').classList.remove('show')">Cancel</button>
        </div>
      </div>
    </div>`;
}
var _currentScheduleKey='';
function openScheduleSlot(key,label){
  _currentScheduleKey=key;
  var schedule={}; try{schedule=JSON.parse(localStorage.getItem('tv_schedule')||'{}');}catch(e){}
  var existing=schedule[key]||{};
  document.getElementById('scheduleModalDate').textContent=label;
  document.getElementById('schedPlatform').value=existing.platform||'YouTube';
  document.getElementById('schedTitle').value=existing.title||'';
  document.getElementById('schedTime').value=existing.time||'14:00';
  document.getElementById('schedNotes').value=existing.notes||'';
  document.getElementById('scheduleModal').classList.add('show');
}
function saveScheduleSlot(){
  var schedule={}; try{schedule=JSON.parse(localStorage.getItem('tv_schedule')||'{}');}catch(e){}
  const title=document.getElementById('schedTitle').value.trim();
  if(!title){notify('Add a title','error','âš ï¸');return;}
  schedule[_currentScheduleKey]={platform:document.getElementById('schedPlatform').value,title,time:document.getElementById('schedTime').value,notes:document.getElementById('schedNotes').value,createdAt:Date.now()};
  localStorage.setItem('tv_schedule',JSON.stringify(schedule));
  document.getElementById('scheduleModal').classList.remove('show');
  notify('Post scheduled! âœ…','success','ðŸ—“ï¸');awardXP('used_scheduler');
  document.getElementById('scheduleList').innerHTML=renderScheduleList(schedule);
  renderPostScheduler();
  localStorage.setItem('tv_check_filled_cal','1');
}
function renderScheduleList(schedule){
  const entries=Object.entries(schedule).sort((a,b)=>a[0].localeCompare(b[0])).slice(0,10);
  if(!entries.length)return`<div style="text-align:center;padding:20px;color:var(--muted);font-size:13px">No posts scheduled yet â€” click a day above to add one.</div>`;
  return entries.map(([date,post])=>`<div class="activity-item" style="justify-content:space-between">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="activity-icon">ðŸ—“ï¸</div>
      <div><div style="font-size:12px;font-weight:700">${post.title}</div><div style="font-size:11px;color:var(--muted)">${post.platform} Â· ${new Date(date).toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'})} at ${post.time||'â€”'}</div></div>
    </div>
    <button onclick="deleteScheduleSlot('${date}')" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:4px">ðŸ—‘</button>
  </div>`).join('');
}
function deleteScheduleSlot(key){
  var schedule={}; try{schedule=JSON.parse(localStorage.getItem('tv_schedule')||'{}');}catch(e){}
  delete schedule[key]; localStorage.setItem('tv_schedule',JSON.stringify(schedule));
  renderPostScheduler();
}
async function aiSuggestSchedule(){
  const result=document.getElementById('scheduleSuggestion');
  result.innerHTML=`<div class="card" style="text-align:center;padding:24px;margin-bottom:16px"><div style="animation:pulse 1.5s infinite">ðŸ¤– Generating your optimal scheduleâ€¦</div></div>`;
  try{
    const raw=await callAI([{role:'user',content:`Suggest the optimal posting schedule for a content creator wanting to grow on YouTube, TikTok, and Instagram. Return ONLY valid JSON:\n{"schedule":[{"platform":"YouTube","days":["Tuesday","Thursday","Saturday"],"time":"2:00 PM","reason":""},{"platform":"TikTok","days":["Mon","Wed","Fri","Sun"],"time":"7:00 PM","reason":""},{"platform":"Instagram","days":["Mon","Wed","Fri"],"time":"11:00 AM","reason":""}],"generalTip":""}`}],'You are a social media posting schedule expert. Return ONLY valid raw JSON.',600);
    const d=JSON.parse(raw.replace(/```json|```/g,'').trim());
    result.innerHTML=`<div class="card" style="margin-bottom:16px">
      <div class="section-label" style="margin-bottom:12px">ðŸ¤– AI RECOMMENDED SCHEDULE</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">
        ${(d.schedule||[]).map(s=>`<div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:14px">
          <div style="font-weight:800;font-size:14px;margin-bottom:4px">${s.platform}</div>
          <div style="font-size:12px;color:var(--teal);font-weight:700;margin-bottom:4px">${(s.days||[]).join(', ')} Â· ${s.time}</div>
          <div style="font-size:11px;color:var(--muted);line-height:1.5">${s.reason||''}</div>
        </div>`).join('')}
      </div>
      ${d.generalTip?`<div style="margin-top:12px;padding:12px;background:rgba(251,191,36,0.07);border:1px solid rgba(251,191,36,0.2);border-radius:10px;font-size:12px;color:var(--text2)">ðŸ’¡ ${d.generalTip}</div>`:''}
    </div>`;
  }catch(e){result.innerHTML='';}
}
window.onerror = function(msg, src, line, col, err) {
  // error silenced
  return true;
};
window.onunhandledrejection = function(e) {
  // promise error silenced
};
// ============================================================
// GIFT CODES
// ============================================================
function getGifts(){try{return JSON.parse(localStorage.getItem('tv_gifts')||'[]');}catch(e){return[];}}
function saveGifts(g){try{localStorage.setItem('tv_gifts',JSON.stringify(g));}catch(e){}}
function getSharedGifts(){try{return JSON.parse(localStorage.getItem('tv_shared_gifts')||'[]');}catch(e){return[];}}

function generateGiftCode(){
  var tierEl=document.getElementById('gcTier');
  var tier=tierEl?tierEl.value:'pro';
  var chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  function rand(n){var a=crypto.getRandomValues(new Uint8Array(n));return Array.from(a).map(function(b){return chars[b%chars.length];}).join('');}
  var code='TV-'+rand(4)+'-'+tier.substring(0,3).toUpperCase()+'-'+rand(4);
  var gift={code:code,tier:tier,used:false,usedBy:null,createdAt:Date.now()};
  var gifts=getGifts();gifts.unshift(gift);saveGifts(gifts);
  var shared=getSharedGifts();shared.unshift(gift);
  try{localStorage.setItem('tv_shared_gifts',JSON.stringify(shared));}catch(e){}
  safeCopy(code,'Code copied: '+code,'ðŸŽ')
  renderGiftCodes();
}

function redeemGiftCode(){
  var input=document.getElementById('gcRedeemInput');
  var code=input?input.value.trim().toUpperCase():'';
  if(!code){notify('Enter a code first','error','âŒ');return;}
  var BUILTIN=['TRENDVID-PRO','TV2025PRO','STRIPE-PAID'];
  if(BUILTIN.indexOf(code)>=0){applyGiftTier('pro');if(input)input.value='';return;}
  var gifts=getGifts();
  var shared=getSharedGifts();
  var gift=null;
  for(var i=0;i<gifts.length;i++){if(gifts[i].code===code&&!gifts[i].used){gift=gifts[i];break;}}
  if(!gift){for(var j=0;j<shared.length;j++){if(shared[j].code===code&&!shared[j].used){gift=shared[j];break;}}}
  if(!gift){notify('Invalid or already used code','error','âŒ');return;}
  var usedBy=currentUser?currentUser.email:'unknown';
  for(var k=0;k<gifts.length;k++){if(gifts[k].code===code){gifts[k].used=true;gifts[k].usedBy=usedBy;gifts[k].usedAt=Date.now();}}
  saveGifts(gifts);
  for(var l=0;l<shared.length;l++){if(shared[l].code===code){shared[l].used=true;shared[l].usedBy=usedBy;}}
  try{localStorage.setItem('tv_shared_gifts',JSON.stringify(shared));}catch(e){}
  applyGiftTier(gift.tier);
  if(input)input.value='';
  renderGiftCodes();
}

function applyGiftTier(tier){
  if(!currentUser){notify('Sign in first to redeem a code','info','ðŸŽ');return;}
  currentUser.plan=tier;
  try{localStorage.setItem('tv_user',JSON.stringify(currentUser));}catch(e){}
  if(typeof updateUserPlanUI==='function')updateUserPlanUI();
  notify('ðŸŽ‰ '+tier.charAt(0).toUpperCase()+tier.slice(1)+' plan activated!','success','ðŸŽ');
}

function renderGiftCodes(){
  var pc=document.getElementById('pageContent');
  if(!pc)return;
  var isAdmin=currentUser&&currentUser.isAdmin;
  var gifts=getGifts();
  var adminHtml='';
  if(isAdmin){
    var rows='';
    for(var i=0;i<gifts.length;i++){
      var g=gifts[i];
      var statusStyle=g.used?'background:rgba(255,60,92,0.1);color:var(--accent)':'background:rgba(0,212,170,0.1);color:var(--teal)';
      var statusText=g.used?'USED':'ACTIVE';
      rows+='<tr style="border-bottom:1px solid rgba(30,39,54,0.5)">'+
        '<td style="padding:8px 6px;font-family:monospace;color:var(--teal)">'+g.code+'</td>'+
        '<td style="padding:8px 6px">'+g.tier+'</td>'+
        '<td style="padding:8px 6px"><span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;'+statusStyle+'">'+statusText+'</span></td>'+
        '<td style="padding:8px 6px;color:var(--muted)">'+(g.usedBy||'â€”')+'</td>'+
        '<td style="padding:8px 6px"><button class="btn btn-ghost btn-sm" style="font-size:10px;padding:3px 8px" data-code="'+g.code+'" onclick="safeCopy(this.dataset.code,\&quot;Copied!\&quot;,\&quot;ðŸ“‹\&quot;)">Copy</button></td>'+
        '</tr>';
    }
    var tableHtml=gifts.length?
      '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px">'+
        '<thead><tr style="border-bottom:1px solid var(--border)">'+
          '<th style="padding:8px 6px;text-align:left;color:var(--muted)">CODE</th>'+
          '<th style="padding:8px 6px;text-align:left;color:var(--muted)">PLAN</th>'+
          '<th style="padding:8px 6px;text-align:left;color:var(--muted)">STATUS</th>'+
          '<th style="padding:8px 6px;text-align:left;color:var(--muted)">USED BY</th>'+
          '<th style="padding:8px 6px"></th>'+
        '</tr></thead>'+
        '<tbody>'+rows+'</tbody>'+
      '</table></div>':
      '<p style="color:var(--muted);font-size:13px;text-align:center;padding:20px">No codes yet.</p>';
    adminHtml=
      '<div class="card" style="margin-bottom:16px">'+
        '<div style="font-size:13px;font-weight:700;margin-bottom:12px">&#x1F451; Admin â€” Generate Codes</div>'+
        '<div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">'+
          '<div class="form-field" style="margin:0;flex:1"><label>PLAN</label>'+
            '<select class="form-input form-select" id="gcTier">'+
              '<option value="starter">Starter</option>'+
              '<option value="pro" selected>Pro</option>'+
              '<option value="gold">Gold</option>'+
              '<option value="elite">Elite</option>'+
            '</select></div>'+
          '<button class="btn btn-gold" onclick="generateGiftCode()">&#x26A1; Generate &amp; Copy</button>'+
        '</div>'+
      '</div>'+
      '<div class="card"><div style="font-size:13px;font-weight:700;margin-bottom:12px">Generated Codes ('+gifts.length+')</div>'+tableHtml+'</div>';
  }
  pc.innerHTML=
    '<div class="section-label" style="margin-bottom:16px">&#x1F381; GIFT CODES</div>'+
    '<div class="card" style="margin-bottom:16px">'+
      '<div style="font-size:13px;font-weight:700;margin-bottom:12px">Redeem a Code</div>'+
      '<div style="display:flex;gap:10px;flex-wrap:wrap">'+
        '<input class="form-input" id="gcRedeemInput" placeholder="TV-XXXX-PRO-XXXX" style="flex:1;min-width:200px;font-family:monospace;text-transform:uppercase">'+
        '<button class="btn btn-primary" onclick="redeemGiftCode()">&#x1F381; Redeem</button>'+
      '</div>'+
      '<p style="font-size:11px;color:var(--muted);margin-top:8px">Try: TRENDVID-PRO &nbsp;&middot;&nbsp; TV2025PRO &nbsp;&middot;&nbsp; STRIPE-PAID</p>'+
    '</div>'+adminHtml;
  var inp=document.getElementById('gcRedeemInput');
  if(inp)inp.addEventListener('keydown',function(e){if(e.key==='Enter')redeemGiftCode();});
}

// ============================================================
// VIRAL SCORE
// ============================================================
function renderViralScore(){
  var pc=document.getElementById('pageContent');if(!pc)return;
  pc.innerHTML=
    '<div class="section-label" style="margin-bottom:16px">&#x1F680; VIRAL POTENTIAL SCORE</div>'+
    '<div class="card" style="margin-bottom:16px">'+
      '<div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;align-items:flex-end;flex-wrap:wrap">'+
        '<div class="form-field" style="margin:0"><label>VIDEO TITLE / TOPIC</label><input class="form-input" id="viralTopic" placeholder="e.g. I lived on Â£1 a day for 30 days..."></div>'+
        '<div class="form-field" style="margin:0"><label>PLATFORM</label><select class="form-input form-select" id="viralPlatform"><option>YouTube</option><option>TikTok</option><option>Instagram</option></select></div>'+
        '<div class="form-field" style="margin:0"><label>NICHE</label><select class="form-input form-select" id="viralNiche"><option value="general">General</option><option value="finance">Finance</option><option value="tech">Tech</option><option value="fitness">Fitness</option><option value="food">Food</option><option value="lifestyle">Lifestyle</option><option value="gaming">Gaming</option></select></div>'+
        '<button class="btn btn-primary" id="viralBtn" onclick="getViralScore()">&#x1F680; Score It</button>'+
      '</div>'+
    '</div>'+
    '<div id="viralOutput"></div>';
}
async function getViralScore(){
  var topic=document.getElementById('viralTopic').value.trim();
  if(!topic){notify('Enter a topic first','error');return;}
  var platform=document.getElementById('viralPlatform').value;
  var niche=document.getElementById('viralNiche').value;
  var btn=document.getElementById('viralBtn');
  var out=document.getElementById('viralOutput');
  btn.disabled=true;btn.textContent='Scoring...';
  out.innerHTML='<div class="ai-thinking"><div class="spinner"></div><span>Calculating viral potential...</span></div>';
  try{
    var data=await aiCall([{role:'user',content:'Rate the viral potential of this video on '+platform+' in the '+niche+' niche. TOPIC: "'+topic+'". Return ONLY valid JSON with no markdown: {"score":78,"verdict":"Strong potential","factors":{"trendRelevance":82,"emotionalTrigger":75,"shareability":80,"titleStrength":70,"audienceSize":85},"strengths":["s1","s2"],"weaknesses":["w1"],"improvements":["i1","i2","i3"],"bestPostTime":"Tuesday 2-4pm","estimatedViews":"50K-200K"}'}],800);
    var r;
    try{r=JSON.parse(data.replace(/```json|```/g,'').trim());}
    catch(e){r={score:65,verdict:'Good potential',factors:{trendRelevance:65,emotionalTrigger:60,shareability:65,titleStrength:60,audienceSize:70},strengths:['Good topic choice'],weaknesses:['Title could be stronger'],improvements:['Add a stronger hook','Be more specific','Post at peak hours'],bestPostTime:'Tuesday 3pm',estimatedViews:'10K-50K'};}
    var sc=r.score>=80?'var(--teal)':r.score>=60?'var(--gold)':'var(--accent)';
    var factorsHtml='';
    var fkeys=r.factors?Object.keys(r.factors):[];
    for(var i=0;i<fkeys.length;i++){
      var k=fkeys[i];var v=r.factors[k];
      var fc=v>=80?'var(--teal)':v>=60?'var(--gold)':'var(--accent)';
      factorsHtml+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">'+
        '<div style="font-size:12px;width:130px;flex-shrink:0">'+k.replace(/([A-Z])/g,' $1').trim()+'</div>'+
        '<div style="flex:1;height:8px;background:var(--surface2);border-radius:4px"><div style="width:'+v+'%;height:100%;border-radius:4px;background:'+fc+'"></div></div>'+
        '<div style="font-size:12px;font-weight:700;width:28px;text-align:right">'+v+'</div>'+
        '</div>';
    }
    var strHtml='';(r.strengths||[]).forEach(function(s){strHtml+='<div style="font-size:12px;padding:4px 0;border-bottom:1px solid var(--border)">&#x2713; '+s+'</div>';});
    var weakHtml='';(r.weaknesses||[]).forEach(function(w){weakHtml+='<div style="font-size:12px;padding:4px 0;border-bottom:1px solid var(--border)">&#x2717; '+w+'</div>';});
    var impHtml='';(r.improvements||[]).forEach(function(imp,i){impHtml+='<div style="display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)"><div style="font-size:18px;color:var(--accent);width:20px;font-weight:700">'+(i+1)+'.</div><div style="font-size:13px">'+imp+'</div></div>';});
    var _viralTopic=topic,_viralScore=r.score,_viralVerdict=r.verdict;
    out.innerHTML=
      '<div class="card" style="text-align:center;margin-bottom:14px">'+
        '<div style="font-size:80px;font-weight:900;line-height:1;color:'+sc+'">'+r.score+'</div>'+
        '<div style="font-size:16px;font-weight:700;margin-bottom:4px">'+r.verdict+'</div>'+
        '<div style="font-size:12px;color:var(--muted)">Est: <strong>'+r.estimatedViews+'</strong> &nbsp;&middot;&nbsp; Best time: <strong>'+r.bestPostTime+'</strong></div>'+
        '<button onclick="shareWin(\'viral\',\''+_viralTopic+'\','+_viralScore+')" style="margin-top:12px;background:rgba(29,161,242,0.1);border:1px solid rgba(29,161,242,0.3);color:#1da1f2;border-radius:10px;padding:7px 18px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit">ð• Share my viral score</button>'+
      '</div>'+
      '<div class="card" style="margin-bottom:14px"><div class="section-label" style="margin-bottom:12px">SCORE BREAKDOWN</div>'+factorsHtml+'</div>'+
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">'+
        '<div class="card"><div class="section-label" style="margin-bottom:8px;color:var(--teal)">STRENGTHS</div>'+strHtml+'</div>'+
        '<div class="card"><div class="section-label" style="margin-bottom:8px;color:var(--accent)">WEAKNESSES</div>'+weakHtml+'</div>'+
      '</div>'+
      '<div class="card"><div class="section-label" style="margin-bottom:10px">IMPROVEMENTS</div>'+impHtml+'</div>';
    awardXP('used_viral');
  }catch(err){out.innerHTML='<div style="color:var(--accent);padding:14px">Error: '+err.message+'</div>';}
  finally{btn.disabled=false;btn.textContent='&#x1F680; Score It';}
}

// ============================================================
// CHANNEL HEALTH
// ============================================================
function renderChannelHealth(){
  var pc=document.getElementById('pageContent');if(!pc)return;
  pc.innerHTML=
    '<div class="section-label" style="margin-bottom:16px">&#x1F4CA; CHANNEL HEALTH SCORE</div>'+
    '<div class="card" style="margin-bottom:16px">'+
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">'+
        '<div class="form-field"><label>CHANNEL NICHE</label><input class="form-input" id="hNiche" placeholder="e.g. Tech reviews"></div>'+
        '<div class="form-field"><label>PLATFORM</label><select class="form-input form-select" id="hPlatform"><option>YouTube</option><option>TikTok</option><option>Instagram</option></select></div>'+
        '<div class="form-field"><label>SUBSCRIBERS</label><input class="form-input" id="hSubs" placeholder="e.g. 1200" type="number"></div>'+
        '<div class="form-field"><label>VIDEOS POSTED</label><input class="form-input" id="hVideos" placeholder="e.g. 24" type="number"></div>'+
        '<div class="form-field"><label>POSTING FREQUENCY</label><select class="form-input form-select" id="hFreq"><option value="daily">Daily</option><option value="3week">3x per week</option><option value="weekly" selected>Weekly</option><option value="biweekly">Every 2 weeks</option><option value="monthly">Monthly</option></select></div>'+
        '<div class="form-field"><label>AVG VIEWS PER VIDEO</label><input class="form-input" id="hViews" placeholder="e.g. 850" type="number"></div>'+
      '</div>'+
      '<button class="btn btn-primary" style="width:100%;margin-top:4px" id="healthBtn" onclick="getChannelHealth()">&#x1F4CA; Get Health Score</button>'+
    '</div>'+
    '<div id="healthOutput"></div>';
}
async function getChannelHealth(){
  var niche=document.getElementById('hNiche').value.trim();
  if(!niche){notify('Enter your niche first','error');return;}
  var btn=document.getElementById('healthBtn');
  var out=document.getElementById('healthOutput');
  btn.disabled=true;btn.textContent='Analysing...';
  out.innerHTML='<div class="ai-thinking"><div class="spinner"></div><span>Analysing your channel...</span></div>';
  var platform=document.getElementById('hPlatform').value;
  var subs=document.getElementById('hSubs').value||'0';
  var videos=document.getElementById('hVideos').value||'0';
  var freq=document.getElementById('hFreq').value;
  var views=document.getElementById('hViews').value||'0';
  try{
    var data=await aiCall([{role:'user',content:'Analyse this '+platform+' channel. Niche:'+niche+' Subs:'+subs+' Videos:'+videos+' Posting:'+freq+' AvgViews:'+views+'. Return ONLY valid JSON: {"score":72,"grade":"B","verdict":"Growing steadily","metrics":{"contentConsistency":80,"engagementRate":65,"growthVelocity":70,"nicheAuthority":75,"postingFrequency":85},"strengths":["s1","s2"],"critical":["c1"],"actionPlan":["step1","step2","step3","step4","step5"],"timeToNextMilestone":"3-4 months"}'}],900);
    var h;
    try{h=JSON.parse(data.replace(/```json|```/g,'').trim());}
    catch(e){h={score:65,grade:'B',verdict:'Has good potential',metrics:{contentConsistency:65,engagementRate:55,growthVelocity:60,nicheAuthority:65,postingFrequency:70},strengths:['Consistent posting'],critical:['Engagement needs work'],actionPlan:['Post consistently','Improve thumbnails','Focus on one niche','Engage with comments','Study top performers'],timeToNextMilestone:'6 months'};}
    var sc=h.score>=80?'var(--teal)':h.score>=60?'var(--gold)':'var(--accent)';
    var metricsHtml='';
    var mkeys=h.metrics?Object.keys(h.metrics):[];
    for(var i=0;i<mkeys.length;i++){
      var k=mkeys[i];var v=h.metrics[k];
      var mc=v>=80?'var(--teal)':v>=60?'var(--gold)':'var(--accent)';
      metricsHtml+='<div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center">'+
        '<div style="font-size:28px;font-weight:900;color:'+mc+'">'+v+'</div>'+
        '<div style="font-size:10px;color:var(--muted);font-weight:600">'+k.replace(/([A-Z])/g,' $1').toUpperCase()+'</div>'+
        '</div>';
    }
    var strHtml='';(h.strengths||[]).forEach(function(s){strHtml+='<div style="font-size:12px;padding:4px 0;border-bottom:1px solid var(--border)">&#x2713; '+s+'</div>';});
    var critHtml='';(h.critical||[]).forEach(function(c){critHtml+='<div style="font-size:12px;padding:4px 0;border-bottom:1px solid var(--border)">&#x2717; '+c+'</div>';});
    var planHtml='';(h.actionPlan||[]).forEach(function(s,i){planHtml+='<div style="display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)"><div style="font-size:20px;font-weight:900;color:var(--accent);width:22px">'+(i+1)+'.</div><div style="font-size:13px">'+s+'</div></div>';});
    out.innerHTML=
      '<div class="card" style="text-align:center;margin-bottom:14px">'+
        '<div style="font-size:80px;font-weight:900;line-height:1;color:'+sc+'">'+h.grade+'</div>'+
        '<div style="font-size:16px;font-weight:700">'+h.score+'/100 &mdash; '+h.verdict+'</div>'+
        '<div style="font-size:12px;color:var(--muted)">Next milestone: '+h.timeToNextMilestone+'</div>'+
      '</div>'+
      '<div class="card" style="margin-bottom:14px"><div class="section-label" style="margin-bottom:12px">METRICS</div><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px">'+metricsHtml+'</div></div>'+
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">'+
        '<div class="card"><div class="section-label" style="margin-bottom:8px;color:var(--teal)">WORKING</div>'+strHtml+'</div>'+
        '<div class="card"><div class="section-label" style="margin-bottom:8px;color:var(--accent)">FIX THESE</div>'+critHtml+'</div>'+
      '</div>'+
      '<div class="card"><div class="section-label" style="margin-bottom:10px">5-STEP ACTION PLAN</div>'+planHtml+'</div>';
    awardXP('used_health');
  }catch(err){out.innerHTML='<div style="color:var(--accent);padding:14px">Error: '+err.message+'</div>';}
  finally{btn.disabled=false;btn.textContent='&#x1F4CA; Get Health Score';}
}

// ============================================================
// B-ROLL IDEAS
// ============================================================
function renderBroll(){
  var pc=document.getElementById('pageContent');if(!pc)return;
  pc.innerHTML=
    '<div class="section-label" style="margin-bottom:16px">&#x1F3AC; B-ROLL IDEAS</div>'+
    '<div class="card" style="margin-bottom:16px">'+
      '<div class="form-field"><label>YOUR SCRIPT OR TOPIC</label>'+
        '<textarea class="form-input" id="brollInput" style="min-height:100px;resize:vertical" placeholder="Paste your script or describe your video topic..."></textarea></div>'+
      '<button class="btn btn-primary" style="width:100%" id="brollBtn" onclick="getBroll()">&#x1F3AC; Generate B-Roll List</button>'+
    '</div>'+
    '<div id="brollOutput"></div>';
}
async function getBroll(){
  var script=document.getElementById('brollInput').value.trim();
  if(!script){notify('Add your script or topic first','error');return;}
  var btn=document.getElementById('brollBtn');
  var out=document.getElementById('brollOutput');
  btn.disabled=true;btn.textContent='Generating...';
  out.innerHTML='<div class="ai-thinking"><div class="spinner"></div><span>Finding footage ideas...</span></div>';
  try{
    var data=await aiCall([{role:'user',content:'Suggest 10 B-roll footage ideas for this video. SCRIPT: "'+script.substring(0,800)+'". Return ONLY valid JSON array: [{"timestamp":"0:00-0:15","description":"what to show","searchTerm":"pexels search","tip":"filming tip"}]'}],800);
    var shots;
    try{shots=JSON.parse(data.replace(/```json|```/g,'').trim());}
    catch(e){shots=[{timestamp:'0:00',description:'Relevant footage for your topic',searchTerm:'relevant footage',tip:'Search Pexels for free HD clips'}];}
    var html='';
    shots.forEach(function(s,i){
      html+='<div class="card" style="margin-bottom:10px;display:flex;gap:14px;align-items:flex-start">'+
        '<div style="font-size:20px;font-weight:900;color:var(--accent);flex-shrink:0;width:28px">'+(i+1)+'</div>'+
        '<div style="flex:1">'+
          '<div style="font-weight:700;font-size:13px;margin-bottom:3px">'+s.timestamp+' &mdash; '+s.description+'</div>'+
          '<div style="font-size:12px;color:var(--muted);margin-bottom:8px">&#x1F4A1; '+s.tip+'</div>'+
          '<div style="display:flex;gap:6px;flex-wrap:wrap">'+
            '<a href="https://www.pexels.com/search/'+encodeURIComponent(s.searchTerm)+'/" target="_blank" class="btn btn-secondary btn-sm" style="font-size:11px">&#x1F3AC; Pexels</a>'+
            '<a href="https://unsplash.com/s/photos/'+encodeURIComponent(s.searchTerm)+'" target="_blank" class="btn btn-secondary btn-sm" style="font-size:11px">&#x1F4F7; Unsplash</a>'+
          '</div>'+
        '</div>'+
      '</div>';
    });
    out.innerHTML=html;
    awardXP('used_broll');
  }catch(err){out.innerHTML='<div style="color:var(--accent);padding:14px">Error: '+err.message+'</div>';}
  finally{btn.disabled=false;btn.textContent='&#x1F3AC; Generate B-Roll List';}
}

// ============================================================
// MUSIC PICKS
// ============================================================
function renderMusicPicks(){
  var pc=document.getElementById('pageContent');if(!pc)return;
  pc.innerHTML=
    '<div class="section-label" style="margin-bottom:16px">&#x1F3B5; MUSIC PICKS</div>'+
    '<div class="card" style="margin-bottom:16px">'+
      '<div style="display:grid;grid-template-columns:1fr 1fr auto;gap:10px;align-items:flex-end;flex-wrap:wrap">'+
        '<div class="form-field" style="margin:0"><label>VIDEO MOOD</label><select class="form-input form-select" id="musicMood"><option value="energetic">Energetic / Hype</option><option value="calm">Calm / Lo-fi</option><option value="inspiring">Inspiring</option><option value="dramatic">Cinematic / Dramatic</option><option value="funny">Funny / Quirky</option><option value="corporate">Corporate</option></select></div>'+
        '<div class="form-field" style="margin:0"><label>PLATFORM</label><select class="form-input form-select" id="musicPlatform"><option>YouTube</option><option>TikTok</option><option>Instagram</option></select></div>'+
        '<button class="btn btn-primary" id="musicBtn" onclick="getMusicPicks()">&#x1F3B5; Get Picks</button>'+
      '</div>'+
    '</div>'+
    '<div id="musicOutput"></div>';
}
async function getMusicPicks(){
  var mood=document.getElementById('musicMood').value;
  var platform=document.getElementById('musicPlatform').value;
  var btn=document.getElementById('musicBtn');
  var out=document.getElementById('musicOutput');
  btn.disabled=true;btn.textContent='Finding...';
  out.innerHTML='<div class="ai-thinking"><div class="spinner"></div><span>Finding perfect tracks...</span></div>';
  try{
    var data=await aiCall([{role:'user',content:'Recommend 8 royalty-free music tracks for a '+mood+' '+platform+' video. Return ONLY valid JSON array: [{"title":"Track Name","artist":"Artist","genre":"Genre","bpm":120,"searchTerm":"search keywords","vibe":"short description"}]'}],700);
    var tracks;
    try{tracks=JSON.parse(data.replace(/```json|```/g,'').trim());}
    catch(e){tracks=[{title:'Inspiring Background',artist:'Various',genre:'Ambient',bpm:90,searchTerm:'inspiring background music',vibe:'Versatile background music'}];}
    var html='';
    tracks.forEach(function(t){
      html+='<div class="card" style="margin-bottom:10px;display:flex;gap:14px;align-items:center;flex-wrap:wrap">'+
        '<div style="font-size:28px">&#x1F3B5;</div>'+
        '<div style="flex:1;min-width:150px">'+
          '<div style="font-weight:700;font-size:13px">'+t.title+' &mdash; '+t.artist+'</div>'+
          '<div style="font-size:12px;color:var(--muted)">'+t.genre+' &middot; '+t.bpm+' BPM</div>'+
          '<div style="font-size:11px;color:var(--text2);margin-top:2px">'+t.vibe+'</div>'+
        '</div>'+
        '<div style="display:flex;gap:6px;flex-wrap:wrap">'+
          '<a href="https://www.youtube.com/audiolibrary/music" target="_blank" class="btn btn-secondary btn-sm" style="font-size:11px">YT Audio Library</a>'+
          '<a href="https://freemusicarchive.org/search?adv=1&search[query]='+encodeURIComponent(t.searchTerm)+'" target="_blank" class="btn btn-secondary btn-sm" style="font-size:11px">Free Music Archive</a>'+
        '</div>'+
      '</div>';
    });
    out.innerHTML=html;
    awardXP('used_music');
  }catch(err){out.innerHTML='<div style="color:var(--accent);padding:14px">Error: '+err.message+'</div>';}
  finally{btn.disabled=false;btn.textContent='&#x1F3B5; Get Picks';}
}

// ============================================================
// CAPTION GENERATOR
// ============================================================
var _capPlatform='YouTube';
function renderCaptionGen(){
  var pc=document.getElementById('pageContent');if(!pc)return;
  _capPlatform='YouTube';
  pc.innerHTML=
    '<div class="section-label" style="margin-bottom:16px">&#x1F4AC; CAPTION GENERATOR</div>'+
    '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px" id="capPlatBtns">'+
      '<button class="btn btn-primary" style="font-size:12px" onclick="selectCapPlatform(this,\&quot;YouTube\&quot;)">YouTube</button>'+
      '<button class="btn btn-secondary" style="font-size:12px" onclick="selectCapPlatform(this,\&quot;Instagram\&quot;)">Instagram</button>'+
      '<button class="btn btn-secondary" style="font-size:12px" onclick="selectCapPlatform(this,\&quot;TikTok\&quot;)">TikTok</button>'+
      '<button class="btn btn-secondary" style="font-size:12px" onclick="selectCapPlatform(this,\&quot;LinkedIn\&quot;)">LinkedIn</button>'+
      '<button class="btn btn-secondary" style="font-size:12px" onclick="selectCapPlatform(this,\&quot;Twitter/X\&quot;)">Twitter/X</button>'+
    '</div>'+
    '<div class="card" style="margin-bottom:16px">'+
      '<div class="form-field"><label>TOPIC / VIDEO TITLE</label><input class="form-input" id="capTopic" placeholder="e.g. How I made Â£5K in one month freelancing..."></div>'+
      '<div class="form-field"><label>KEY POINTS (optional)</label><textarea class="form-input" id="capPoints" style="min-height:70px;resize:vertical" placeholder="Main points to mention..."></textarea></div>'+
      '<button class="btn btn-primary" style="width:100%" id="capGenBtn" onclick="generateCaption()">&#x1F4AC; Generate Caption</button>'+
    '</div>'+
    '<div id="capOutput"></div>';
}
function selectCapPlatform(btn,p){
  _capPlatform=p;
  var btns=document.getElementById('capPlatBtns');
  if(btns){Array.from(btns.children).forEach(function(b){b.className='btn btn-secondary';b.style.fontSize='12px';});}
  btn.className='btn btn-primary';btn.style.fontSize='12px';
}
async function generateCaption(){
  var topic=document.getElementById('capTopic').value.trim();
  if(!topic){notify('Enter a topic first','error');return;}
  var points=document.getElementById('capPoints').value.trim();
  var btn=document.getElementById('capGenBtn');
  var out=document.getElementById('capOutput');
  btn.disabled=true;btn.textContent='Writing...';
  out.innerHTML='<div class="ai-thinking"><div class="spinner"></div><span>Writing your caption...</span></div>';
  var guides={YouTube:'SEO description 150-300 words with keywords and CTA',Instagram:'engaging with emojis 100-200 words and 30 hashtags at end',TikTok:'punchy under 150 chars with 3-5 hashtags',LinkedIn:'professional thought-leadership 150-200 words with 3 hashtags','Twitter/X':'tweet under 280 chars with hashtags and CTA'};
  try{
    var result=await aiCall([{role:'user',content:'Write a '+_capPlatform+' caption for: "'+topic+'". Key points: '+(points||'none')+'. Format: '+(guides[_capPlatform]||guides.YouTube)+'. Return ONLY the caption text.'}],700);
    btn.disabled=false;btn.textContent='&#x1F4AC; Generate Caption';
    out.innerHTML=
      '<div class="card">'+
        '<div style="white-space:pre-wrap;font-size:13px;line-height:1.7;margin-bottom:14px" id="capText"></div>'+
        '<div style="display:flex;gap:8px;flex-wrap:wrap">'+
          '<button class="btn btn-teal btn-sm" id="copyCaptionBtn">&#x1F4CB; Copy</button>'+
          '<button class="btn btn-secondary btn-sm" onclick="generateCaption()">&#x1F504; Regenerate</button>'+
        '</div>'+
      '</div>';
    document.getElementById('capText').textContent=result;
    document.getElementById('copyCaptionBtn').addEventListener('click',function(){
      safeCopy(result,'Copied!','ðŸ“‹');
    });
    awardXP('used_captions');
  }catch(err){btn.disabled=false;btn.textContent='&#x1F4AC; Generate Caption';out.innerHTML='<div style="color:var(--accent);padding:14px">Error: '+err.message+'</div>';}
}

// ============================================================
// COMMENT REPLY GENERATOR
// ============================================================
function renderCommentReplies(){
  var pc=document.getElementById('pageContent');if(!pc)return;
  pc.innerHTML=
    '<div class="section-label" style="margin-bottom:16px">&#x1F4AD; COMMENT REPLY GENERATOR</div>'+
    '<div class="card" style="margin-bottom:16px">'+
      '<div class="form-field"><label>PASTE THE COMMENT</label>'+
        '<textarea class="form-input" id="commentInput" style="min-height:80px;resize:vertical" placeholder="e.g. This was so helpful! Can you make a part 2?"></textarea></div>'+
      '<div class="form-field"><label>YOUR CHANNEL VIBE</label>'+
        '<select class="form-input form-select" id="commentVibe"><option value="friendly">Friendly &amp; Warm</option><option value="funny">Funny &amp; Witty</option><option value="professional">Professional</option><option value="hype">Hyped &amp; Energetic</option></select></div>'+
      '<button class="btn btn-primary" style="width:100%" id="replyBtn" onclick="generateReplies()">&#x1F4AD; Generate 3 Replies</button>'+
    '</div>'+
    '<div id="repliesOutput"></div>';
}
async function generateReplies(){
  var comment=document.getElementById('commentInput').value.trim();
  if(!comment){notify('Paste a comment first','error');return;}
  var vibe=document.getElementById('commentVibe').value;
  var btn=document.getElementById('replyBtn');
  var out=document.getElementById('repliesOutput');
  btn.disabled=true;btn.textContent='Writing replies...';
  out.innerHTML='<div class="ai-thinking"><div class="spinner"></div><span>Writing the perfect replies...</span></div>';
  try{
    var data=await aiCall([{role:'user',content:'Generate 3 different creator replies to this comment with a '+vibe+' vibe. COMMENT: "'+comment+'". Return ONLY valid JSON array: [{"tone":"Warm & Personal","reply":"text here"},{"tone":"Engaging Question","reply":"text here"},{"tone":"Quick & Punchy","reply":"text here"}]'}],600);
    var replies;
    try{replies=JSON.parse(data.replace(/```json|```/g,'').trim());}
    catch(e){replies=[{tone:'Friendly Reply',reply:'Thank you so much! Really appreciate the support! Stay tuned for more content coming soon ðŸ™'}];}
    btn.disabled=false;btn.textContent='&#x1F4AD; Generate 3 Replies';
    var html='';
    replies.forEach(function(r,idx){
      var id='replyText'+idx;
      html+='<div class="card" style="margin-bottom:10px">'+
        '<div style="font-size:10px;font-weight:700;color:var(--muted);letter-spacing:1px;margin-bottom:6px">'+r.tone.toUpperCase()+'</div>'+
        '<div style="font-size:13px;line-height:1.6;margin-bottom:10px" id="'+id+'"></div>'+
        '<button class="btn btn-teal btn-sm" data-id="'+id+'" onclick="(function(el){safeCopy(el.textContent,\&quot;Copied!\&quot;,\&quot;ðŸ’¬\&quot;);})(document.getElementById(\&quot;&quot;+id+&quot;\&quot;))">&#x1F4CB; Copy</button>'+
        '</div>';
    });
    out.innerHTML=html;
    replies.forEach(function(r,idx){
      var el=document.getElementById('replyText'+idx);
      if(el)el.textContent=r.reply;
    });
    awardXP('used_comments');
  }catch(err){btn.disabled=false;btn.textContent='&#x1F4AD; Generate 3 Replies';out.innerHTML='<div style="color:var(--accent);padding:14px">Error: '+err.message+'</div>';}
}

// ============================================================
// SCRIPT IMPROVER
// ============================================================
function renderScriptImprover(){
  var pc=document.getElementById('pageContent');if(!pc)return;
  pc.innerHTML=
    '<div class="section-label" style="margin-bottom:16px">&#x2728; SCRIPT IMPROVER</div>'+
    '<div class="card" style="margin-bottom:16px">'+
      '<div class="form-field"><label>PASTE YOUR SCRIPT</label>'+
        '<textarea class="form-input" id="improverInput" style="min-height:180px;resize:vertical" placeholder="Paste any script here and AI will rewrite it to be dramatically better..."></textarea></div>'+
      '<div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">'+
        '<div class="form-field" style="margin:0;flex:1"><label>IMPROVEMENT STYLE</label>'+
          '<select class="form-input form-select" id="improverStyle">'+
            '<option value="viral">More Viral</option>'+
            '<option value="engaging">More Engaging</option>'+
            '<option value="shorter">Much Shorter</option>'+
            '<option value="funnier">Funnier</option>'+
            '<option value="professional">More Professional</option>'+
          '</select>'+
        '</div>'+
        '<button class="btn btn-primary" id="improverBtn" onclick="improveScript()">&#x2728; Improve Script</button>'+
      '</div>'+
    '</div>'+
    '<div id="improverOutput"></div>';
}
async function improveScript(){
  var script=document.getElementById('improverInput').value.trim();
  if(!script){notify('Paste a script first','error');return;}
  var style=document.getElementById('improverStyle').value;
  var btn=document.getElementById('improverBtn');
  var out=document.getElementById('improverOutput');
  btn.disabled=true;btn.textContent='Rewriting...';
  out.innerHTML='<div class="ai-thinking"><div class="spinner"></div><span>Rewriting for maximum impact...</span></div>';
  var styleMap={viral:'more viral with a stronger hook and shareable moments',engaging:'more engaging with better storytelling and emotional connection',shorter:'significantly shorter while keeping all the key value',funnier:'funnier with more wit, personality and relatable moments',professional:'more polished, authoritative and credible'};
  try{
    var result=await aiCall([{role:'user',content:'Rewrite this script to be '+(styleMap[style]||'better')+'. Keep the same topic. Return ONLY the improved script, no commentary.\n\nORIGINAL:\n'+script.substring(0,3000)}],2500);
    btn.disabled=false;btn.textContent='&#x2728; Improve Script';
    out.innerHTML=
      '<div class="card">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">'+
          '<div style="font-size:13px;font-weight:700">&#x2728; Improved Version</div>'+
          '<div style="display:flex;gap:8px">'+
            '<button class="btn btn-teal btn-sm" id="copyImprovedBtn">&#x1F4CB; Copy</button>'+
            '<button class="btn btn-secondary btn-sm" id="reImproveBtn">&#x21A9; Re-improve</button>'+
          '</div>'+
        '</div>'+
        '<div style="white-space:pre-wrap;font-size:13px;line-height:1.7" id="improvedText"></div>'+
      '</div>';
    document.getElementById('improvedText').textContent=result;
    document.getElementById('copyImprovedBtn').addEventListener('click',function(){
      safeCopy(result,'Copied!','ðŸ“‹');
    });
    document.getElementById('reImproveBtn').addEventListener('click',function(){
      var el=document.getElementById('improvedText');
      if(el)document.getElementById('improverInput').value=el.textContent;
    });
    awardXP('used_improver');
  }catch(err){btn.disabled=false;btn.textContent='&#x2728; Improve Script';out.innerHTML='<div style="color:var(--accent);padding:14px">Error: '+err.message+'</div>';}
}

// ============================================================
// openLoginModal â€” safe open with optional tab
// ============================================================
function openLoginModal(tab) {
  var m = document.getElementById('loginModal');
  if(m) { m.style.display = 'flex'; m.classList.add('show'); }
  var emailEl = document.getElementById('loginEmail');
  if(emailEl) setTimeout(function() { emailEl.focus(); }, 100);
}

// ============================================================
// WELCOME BANNER â€” auto-dismiss after 3s, has X button
// ============================================================
// ============================================================
// FIRST-ACTION NUDGE â€” guides new users to their first aha moment
// ============================================================
function showFirstActionNudge(name) {
  // Don't show if they've already done something
  if (localStorage.getItem('tv_check_scanned_trend') || localStorage.getItem('tv_check_wrote_script')) return;
  var existing = document.getElementById('_firstActionNudge');
  if (existing) existing.remove();
  var nudge = document.createElement('div');
  nudge.id = '_firstActionNudge';
  nudge.style.cssText = 'position:fixed;inset:0;z-index:99990;background:rgba(0,0,0,0.65);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;padding:24px;animation:fadeIn 0.3s ease';
  nudge.innerHTML =
    '<div style="background:var(--surface);border:1px solid var(--border2);border-radius:22px;padding:32px;max-width:460px;width:100%;box-shadow:0 24px 80px rgba(0,0,0,0.7);text-align:center;animation:slideUp 0.4s ease">' +
      '<div style="font-size:48px;margin-bottom:12px">ðŸš€</div>' +
      '<div style="font-family:var(--font-display);font-size:22px;font-weight:900;letter-spacing:-0.5px;margin-bottom:8px">Let us find your first viral idea, '+name+'</div>' +
      '<div style="font-size:13px;color:var(--muted);line-height:1.7;margin-bottom:24px">Most creators see results in their first 5 minutes. Pick where you want to start:</div>' +
      '<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:24px">' +
        '<button onclick="document.getElementById(&quot;_firstActionNudge&quot;).remove();navTo(&quot;trends&quot;)" style="display:flex;align-items:center;gap:14px;padding:14px 18px;background:rgba(255,48,88,0.06);border:1px solid rgba(255,48,88,0.25);border-radius:14px;cursor:pointer;text-align:left;width:100%;transition:all 0.15s" onmouseover="this.style.background=&quot;rgba(255,48,88,0.12)&quot;" onmouseout="this.style.background=&quot;rgba(255,48,88,0.06)&quot;">' +
          '<span style="font-size:28px">ðŸ“ˆ</span>' +
          '<div><div style="font-size:13px;font-weight:700;color:var(--text)">Discover trending topics</div><div style="font-size:11px;color:var(--muted)">See what is blowing up right now in your niche</div></div>' +
          '<span style="margin-left:auto;color:var(--accent);font-size:18px">â†’</span>' +
        '</button>' +
        '<button onclick="document.getElementById(&quot;_firstActionNudge&quot;).remove();navTo(&quot;script&quot;)" style="display:flex;align-items:center;gap:14px;padding:14px 18px;background:rgba(0,229,176,0.06);border:1px solid rgba(0,229,176,0.25);border-radius:14px;cursor:pointer;text-align:left;width:100%;transition:all 0.15s" onmouseover="this.style.background=&quot;rgba(0,229,176,0.12)&quot;" onmouseout="this.style.background=&quot;rgba(0,229,176,0.06)&quot;">' +
          '<span style="font-size:28px">âœï¸</span>' +
          '<div><div style="font-size:13px;font-weight:700;color:var(--text)">Write a viral script</div><div style="font-size:11px;color:var(--muted)">AI generates a full script with hook, body & CTA</div></div>' +
          '<span style="margin-left:auto;color:var(--teal);font-size:18px">â†’</span>' +
        '</button>' +
        '<button onclick="document.getElementById(&quot;_firstActionNudge&quot;).remove();navTo(&quot;thumbnail&quot;)" style="display:flex;align-items:center;gap:14px;padding:14px 18px;background:rgba(167,139,250,0.06);border:1px solid rgba(167,139,250,0.25);border-radius:14px;cursor:pointer;text-align:left;width:100%;transition:all 0.15s" onmouseover="this.style.background=&quot;rgba(167,139,250,0.12)&quot;" onmouseout="this.style.background=&quot;rgba(167,139,250,0.06)&quot;">' +
          '<span style="font-size:28px">ðŸŽ¨</span>' +
          '<div><div style="font-size:13px;font-weight:700;color:var(--text)">Design a thumbnail</div><div style="font-size:11px;color:var(--muted)">High-CTR thumbnail ideas generated by AI</div></div>' +
          '<span style="margin-left:auto;color:var(--purple);font-size:18px">â†’</span>' +
        '</button>' +
      '</div>' +
      '<button onclick="document.getElementById(&quot;_firstActionNudge&quot;).remove()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:12px;text-decoration:underline">Skip â€” I will explore on my own</button>' +
    '</div>';
  document.body.appendChild(nudge);
  nudge.addEventListener('click', function(e){ if(e.target===nudge) nudge.remove(); });
}

function showWelcomeBanner(name, isNew) {
  var banner = document.getElementById('welcomeBanner');
  if(!banner) return;
  var emoji = document.getElementById('welcomeBannerEmoji');
  var title = document.getElementById('welcomeBannerTitle');
  var sub = document.getElementById('welcomeBannerSub');
  if(emoji) emoji.textContent = isNew ? 'ðŸŽ‰' : 'ðŸ‘‹';
  if(title) title.textContent = isNew ? 'Welcome to TrendVid, ' + name + '!' : 'Hey, ' + name + '!';
  if(sub) sub.textContent = isNew ? "You're in. Let's go viral ðŸš€" : 'Welcome back â€” ready to create?';
  banner.style.display = 'flex';
  clearTimeout(banner._t);
  banner._t = setTimeout(function() { dismissWelcomeBanner(); }, 3000);
}
function dismissWelcomeBanner() {
  var banner = document.getElementById('welcomeBanner');
  if(banner) {
    banner.style.opacity = '0';
    banner.style.transform = 'translateX(-50%) translateY(-20px)';
    banner.style.transition = 'all 0.35s ease';
    setTimeout(function() { banner.style.display = 'none'; banner.style.opacity = ''; banner.style.transform = ''; }, 350);
  }
}

// ============================================================
// TRENDVID WATERMARK TOAST â€” shows for 3s after AI output
// ============================================================
var _watermarkTimer = null;
function showWatermark() {
  var toast = document.getElementById('tvWatermarkToast');
  if(!toast) return;
  toast.style.display = 'block';
  clearTimeout(_watermarkTimer);
  _watermarkTimer = setTimeout(function() {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.5s ease';
    setTimeout(function() { toast.style.display = 'none'; toast.style.opacity = ''; toast.style.transition = ''; }, 500);
  }, 3000);
}

// ============================================================
// ANNUAL BILLING HELPERS
// ============================================================
var _annualBilling = (localStorage.getItem('tv_annual_pref') === '1');
function updateAnnualPrices() {
  var toggle = document.getElementById('annualBillingToggle');
  _annualBilling = toggle && toggle.classList.contains('on');
  localStorage.setItem('tv_annual_pref', _annualBilling ? '1' : '0');
  // Update pricing page if open
  var pc = document.getElementById('pageContent');
  if(pc && pc.innerHTML.indexOf('pricing-card') >= 0) { renderPricing(); }
}

// ============================================================
// REPORT ERROR HANDLER
// ============================================================
function submitErrorReport() {
  var type = document.getElementById('reportType');
  var desc = document.getElementById('reportDesc');
  var email = document.getElementById('reportEmail');
  var typeVal = type ? type.value : 'unknown';
  var descVal = esc(desc ? desc.value.trim() : '');
  var emailVal = esc(email ? email.value.trim() : '');
  if(!descVal) { notify('Please describe what happened', 'error', 'âš ï¸'); return; }
  // Validate email format
  if(emailVal && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(emailVal)) { notify('Please enter a valid email address', 'error', 'âš ï¸'); return; }
  // Save to localStorage for admin to view
  var reports = [];
  try { reports = JSON.parse(localStorage.getItem('tv_reports') || '[]'); } catch(e) {}
  var report = {
    id: Date.now(),
    type: typeVal,
    desc: descVal,
    email: emailVal || (currentUser ? esc(currentUser.email) : 'anonymous'),
    user: currentUser ? currentUser.email : 'anonymous',
    plan: currentUser ? currentUser.plan : 'unknown',
    at: new Date().toISOString()
  };
  reports.unshift(report);
  try { localStorage.setItem('tv_reports', JSON.stringify(reports.slice(0, 100))); } catch(e) {}
  document.getElementById('errorReportModal').classList.remove('show');
  notify('Report sent â€” thank you! ðŸ™', 'success', 'ðŸ“¤');
}

// ============================================================
// ADMIN DASHBOARD â€” full embedded admin panel
// ============================================================
// ============================================================
// ADMIN PANEL â€” HAMBURGER SIDEBAR LAYOUT + EXPANDED SECTIONS
// ============================================================
// ============================================================
// AI APP BUILDER â€” Admin Only
// ============================================================

// The "database" of things the AI can change, stored in localStorage
function getAppConfig() {
  var defaults = {
    appName:       'TrendVid',
    appTagline:    'AI Content Studio',
    primaryColor:  '#ff3058',
    tealColor:     '#00e5b0',
    bgColor:       '#060810',
    surfaceColor:  '#0c0f1a',
    borderColor:   '#1e2538',
    textColor:     '#eef2ff',
    mutedColor:    '#566380',
    borderRadius:  '18px',
    fontDisplay:   'Syne',
    // Nav section labels
    sectionHome:    'HOME',
    sectionCreate:  'CREATE',
    sectionManage:  'MANAGE',
    sectionTools:   'TOOLS',
    sectionAccount: 'ACCOUNT',
    // Page title overrides (empty = use defaults)
    pageTitleOverrides: {},
    // Feature toggles (hide/show nav items)
    hiddenPages: [],
    // Custom CSS injected into <head>
    customCSS: '',
    // Dashboard welcome message override
    dashboardWelcome: '',
    // Sidebar bottom tagline
    sidebarTagline: 'AI Content Studio',
    // Applied changes log
    changeLog: []
  };
  try {
    var saved = JSON.parse(localStorage.getItem('tv_app_config') || '{}');
    return Object.assign({}, defaults, saved);
  } catch(e) { return defaults; }
}

// On startup, hydrate localStorage from persistent storage if localStorage is empty
async function hydrateAppConfigFromStorage() {
  try {
    if (!window.storage || typeof window.storage.get !== 'function') return;
    var local = localStorage.getItem('tv_app_config');
    // If localStorage already has config, sync it TO persistent storage (keep them in sync)
    if (local && local !== '{}') {
      await window.storage.set('tv_app_config', local);
      return;
    }
    // localStorage is empty â€” pull from persistent storage
    var result = await window.storage.get('tv_app_config');
    if (result && result.value) {
      localStorage.setItem('tv_app_config', result.value);
      applyAppConfig();
    }
  } catch(e) {}
}

function saveAppConfig(cfg) {
  // Save to localStorage (fast, in-session)
  try { localStorage.setItem('tv_app_config', JSON.stringify(cfg)); } catch(e) {}
  // Save to persistent storage (survives browser clears, shared across sessions)
  try {
    if (window.storage && typeof window.storage.set === 'function') {
      window.storage.set('tv_app_config', JSON.stringify(cfg)).catch(function(){});
    }
  } catch(e) {}
}

// Apply all config to the live DOM
function applyAppConfig() {
  var cfg = getAppConfig();

  // CSS variables
  var root = document.documentElement;
  root.style.setProperty('--accent',   cfg.primaryColor);
  root.style.setProperty('--teal',     cfg.tealColor);
  root.style.setProperty('--bg',       cfg.bgColor);
  root.style.setProperty('--surface',  cfg.surfaceColor);
  root.style.setProperty('--border',   cfg.borderColor);
  root.style.setProperty('--text',     cfg.textColor);
  root.style.setProperty('--muted',    cfg.mutedColor);
  root.style.setProperty('--radius',   cfg.borderRadius);

  // App name / tagline in sidebar
  var nameEl = document.querySelector('.sidebar-logo-text');
  if (nameEl && cfg.appName) {
    var parts = cfg.appName.split('');
    var mid   = Math.ceil(parts.length / 2);
    nameEl.innerHTML = parts.slice(0, mid).join('') + '<span>' + parts.slice(mid).join('') + '</span>';
  }
  var tagEls = document.querySelectorAll('.sidebar-tagline');
  tagEls.forEach(function(el) { el.textContent = cfg.sidebarTagline || cfg.appTagline || 'AI Content Studio'; });

  // Nav section labels
  var sections = document.querySelectorAll('.sidebar-section');
  var sectionMap = ['sectionHome','sectionCreate','sectionManage','sectionTools','sectionAccount'];
  sections.forEach(function(el, i) {
    var key = sectionMap[i];
    if (key && cfg[key]) el.textContent = cfg[key];
  });

  // Page title overrides
  if (cfg.pageTitleOverrides) {
    Object.keys(cfg.pageTitleOverrides).forEach(function(page) {
      if (typeof pageTitles !== 'undefined') pageTitles[page] = cfg.pageTitleOverrides[page];
      var btn = document.querySelector('[data-page="' + page + '"]');
      if (btn) {
        var iconSpan = btn.querySelector('.icon');
        var iconHtml = iconSpan ? iconSpan.outerHTML : '';
        // Preserve badges
        var badge = btn.querySelector('.nav-badge');
        var badgeHtml = badge ? badge.outerHTML : '';
        btn.innerHTML = iconHtml + cfg.pageTitleOverrides[page] + badgeHtml;
        if (iconSpan) btn.insertBefore(iconSpan, btn.firstChild);
      }
    });
  }

  // Hidden pages
  if (cfg.hiddenPages && cfg.hiddenPages.length) {
    cfg.hiddenPages.forEach(function(page) {
      var btn = document.querySelector('[data-page="' + page + '"]');
      if (btn) btn.style.display = 'none';
    });
  }

  // Custom CSS
  var existingStyle = document.getElementById('tv-custom-css');
  if (existingStyle) existingStyle.remove();
  if (cfg.customCSS) {
    var style = document.createElement('style');
    style.id = 'tv-custom-css';
    style.textContent = cfg.customCSS;
    document.head.appendChild(style);
  }
}

// â”€â”€ The AI builder function â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runAIAppBuilder(instruction) {
  var cfg = getAppConfig();

  var availablePages = Object.keys(typeof pageTitles !== 'undefined' ? pageTitles : {}).join(', ');
  var availableColors = Object.keys(cfg).filter(function(k){ return k.toLowerCase().includes('color'); }).join(', ');

  var systemPrompt =
    'You are an AI app customiser for TrendVid â€” a SaaS creator platform. ' +
    'The admin gives you plain-English instructions and you return a JSON object of changes to apply. ' +
    'You can modify: colours, app name, tagline, nav section labels, page title overrides, hidden pages, custom CSS, and sidebar tagline. ' +
    'Return ONLY valid JSON, no prose, no markdown fences. ' +
    'The JSON must match this exact schema â€” include only the keys you are changing:\n' +
    '{\n' +
    '  "appName": "string â€” the app name shown in sidebar logo",\n' +
    '  "sidebarTagline": "string â€” tagline under logo",\n' +
    '  "primaryColor": "hex â€” main accent/action colour",\n' +
    '  "tealColor": "hex â€” secondary accent colour",\n' +
    '  "bgColor": "hex â€” page background",\n' +
    '  "surfaceColor": "hex â€” card/panel background",\n' +
    '  "borderColor": "hex â€” border colour",\n' +
    '  "textColor": "hex â€” primary text",\n' +
    '  "mutedColor": "hex â€” muted/secondary text",\n' +
    '  "borderRadius": "e.g. 8px, 18px, 24px â€” controls roundness",\n' +
    '  "sectionHome": "string â€” HOME section label",\n' +
    '  "sectionCreate": "string â€” CREATE section label",\n' +
    '  "sectionManage": "string â€” MANAGE section label",\n' +
    '  "sectionTools": "string â€” TOOLS section label",\n' +
    '  "sectionAccount": "string â€” ACCOUNT section label",\n' +
    '  "pageTitleOverrides": {"pageId": "New Title", ...},\n' +
    '  "hiddenPages": ["pageId", ...],\n' +
    '  "customCSS": "any valid CSS string to inject",\n' +
    '  "summaryOfChanges": "human-friendly one-line summary of what you changed"\n' +
    '}\n\n' +
    'Available page IDs: ' + availablePages + '.\n' +
    'Current config: ' + JSON.stringify(cfg, null, 0).substring(0, 600);

  var userMsg = instruction;

  notify('AI is planning your changes...', 'info', 'build');

  try {
    var raw = await aiCall(
      [{role: 'user', content: userMsg}],
      systemPrompt,
      1200
    );

    var changes = {};
    try {
      var clean = raw.replace(/```json|```/g, '').trim();
      changes = JSON.parse(clean);
    } catch(parseErr) {
      notify('AI returned invalid JSON. Try rephrasing.', 'error', 'x');
      return null;
    }

    var summary = changes.summaryOfChanges || 'Changes applied';
    delete changes.summaryOfChanges;

    // Merge into config
    var newCfg = Object.assign({}, cfg, changes);

    // If pageTitleOverrides was returned, merge (don't overwrite all)
    if (changes.pageTitleOverrides) {
      newCfg.pageTitleOverrides = Object.assign({}, cfg.pageTitleOverrides || {}, changes.pageTitleOverrides);
    }

    // If hiddenPages was returned, replace (admin can say "show all" to clear)
    if (changes.hiddenPages !== undefined) {
      newCfg.hiddenPages = changes.hiddenPages;
    }

    // Log the change
    if (!newCfg.changeLog) newCfg.changeLog = [];
    newCfg.changeLog.unshift({
      instruction: instruction,
      summary:     summary,
      changes:     changes,
      at:          Date.now()
    });
    newCfg.changeLog = newCfg.changeLog.slice(0, 30);

    saveAppConfig(newCfg);
    applyAppConfig();

    notify('Applied: ' + summary, 'success', 'done');
    return { summary: summary, changes: changes };

  } catch(err) {
    notify('AI builder error: ' + err.message, 'error', 'x');
    return null;
  }
}

// Reset all config to defaults
function resetAppConfig() {
  localStorage.removeItem('tv_app_config');
  try {
    if (window.storage && typeof window.storage.delete === 'function') {
      window.storage.delete('tv_app_config').catch(function(){});
    }
  } catch(e) {}
  applyAppConfig();
  notify('App reset to defaults', 'info', 'done');
  window._adminTab = 'aibuilder';
  renderAdmin();
}

// â”€â”€ Admin tab renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _adminAIBuilderContent() {
  var cfg = getAppConfig();
  var log = cfg.changeLog || [];

  // Live preview swatches
  var colorKeys = [
    {key:'primaryColor', label:'Accent'},
    {key:'tealColor',    label:'Secondary'},
    {key:'bgColor',      label:'Background'},
    {key:'surfaceColor', label:'Surface'},
    {key:'borderColor',  label:'Border'},
    {key:'textColor',    label:'Text'},
    {key:'mutedColor',   label:'Muted'},
  ];
  var swatches = colorKeys.map(function(c) {
    return '<div style="display:flex;align-items:center;gap:6px;font-size:11px">' +
      '<div style="width:20px;height:20px;border-radius:6px;background:' + (cfg[c.key] || '#888') + ';border:1px solid var(--border2);flex-shrink:0"></div>' +
      '<span style="color:var(--muted)">' + c.label + '</span>' +
      '<span style="color:var(--text2);font-family:monospace;font-size:10px">' + (cfg[c.key] || '') + '</span>' +
    '</div>';
  }).join('');

  // Suggestion chips
  var suggestions = [
    'Make the app look like a premium dark blue theme',
    'Rename "Script Generator" to "Video Writer" and "Trend Radar" to "Viral Ideas"',
    'Make the app look clean and minimal with white surfaces and light grey borders',
    'Add a glowing purple accent colour and round all corners to 24px',
    'Make the background pure black and the accent colour electric blue',
    'Hide the "Gift Codes" and "Bundle Deals" pages from the nav',
    'Rename the CREATE section to "BUILD" and TOOLS to "POWER TOOLS"',
    'Make it look like a Spotify-inspired dark green theme',
    'Reset all nav labels to professional corporate English',
    'Make the accent colour gold and rename the app to CreatorOS',
  ];
  var chips = suggestions.map(function(s) {
    return '<button onclick="document.getElementById(\'aiBuilderInput\').value=' + JSON.stringify(s) + '" ' +
      'style="background:var(--surface2);border:1px solid var(--border);color:var(--text2);' +
      'border-radius:20px;padding:5px 12px;font-size:11px;cursor:pointer;font-family:inherit;white-space:nowrap;' +
      'transition:all 0.15s" onmouseover="this.style.borderColor=\'var(--teal)\';this.style.color=\'var(--teal)\'" ' +
      'onmouseout="this.style.borderColor=\'var(--border)\';this.style.color=\'var(--text2)\'">' + s + '</button>';
  }).join('');

  // Change log
  var logRows = log.length === 0
    ? '<div style="text-align:center;padding:24px;color:var(--muted);font-size:12px">No changes yet. Give the AI an instruction above.</div>'
    : log.map(function(entry, i) {
        var dt = new Date(entry.at).toLocaleString('en-GB', {day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
        var changedKeys = Object.keys(entry.changes || {}).filter(function(k){ return k !== 'summaryOfChanges'; });
        return '<div style="padding:12px 0;border-bottom:1px solid var(--border)">' +
          '<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:4px">' +
            '<div style="font-size:12px;font-weight:700">' + (entry.summary || entry.instruction || '') + '</div>' +
            '<div style="font-size:10px;color:var(--muted);white-space:nowrap;flex-shrink:0">' + dt + '</div>' +
          '</div>' +
          '<div style="font-size:11px;color:var(--muted);margin-bottom:4px;font-style:italic">"' + (entry.instruction || '').substring(0, 100) + '"</div>' +
          (changedKeys.length ? '<div style="font-size:10px;color:var(--teal)">' + changedKeys.join(', ') + '</div>' : '') +
        '</div>';
      }).join('');

  return (
    '<div style="font-family:var(--font-display);font-size:16px;font-weight:900;margin-bottom:4px">&#x1F916; AI App Builder</div>' +
    '<div style="font-size:12px;color:var(--muted);margin-bottom:20px">Tell the AI how to change the app â€” colours, names, layout, hidden pages, custom CSS. Changes are live instantly.</div>' +

    // Input box
    '<div class="card" style="margin-bottom:16px;padding:18px 20px">' +
      '<div style="font-size:12px;font-weight:700;color:var(--muted);margin-bottom:10px">INSTRUCTION</div>' +
      '<textarea id="aiBuilderInput" rows="3" class="form-input" placeholder="e.g. Make the app dark blue with gold accents, rename the app to CreatorOS, and hide the Gift Codes page" ' +
        'style="width:100%;resize:vertical;font-size:13px;margin-bottom:12px"></textarea>' +
      '<div style="display:flex;gap:8px;align-items:center">' +
        '<button class="btn btn-primary" style="flex:1" onclick="adminRunAIBuilder()" id="aiBuilderBtn">&#x1F916; Apply with AI</button>' +
        '<button class="btn btn-ghost" style="font-size:11px;color:var(--accent)" onclick="if(confirm(\'Reset all customisations to defaults?\')) { resetAppConfig(); }">&#x21BA; Reset All</button>' +
      '</div>' +
    '</div>' +

    // Suggestion chips
    '<div style="font-size:11px;font-weight:700;color:var(--muted);margin-bottom:8px">QUICK PROMPTS</div>' +
    '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:20px">' + chips + '</div>' +

    // Real-time config editor (replaces static config card)
    _buildRealTimeEditor() +

        // Change log
    '<div class="card" style="padding:16px 20px">' +
      '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">' +
        '<div style="font-size:11px;font-weight:700;color:var(--muted)">CHANGE HISTORY (' + log.length + ')</div>' +
        (log.length ? '<button onclick="if(confirm(\'Clear change history?\')) { var c=getAppConfig(); c.changeLog=[]; saveAppConfig(c); window._adminTab=\'aibuilder\'; renderAdmin(); }" style="font-size:10px;color:var(--muted);background:none;border:none;cursor:pointer;font-family:inherit">Clear</button>' : '') +
      '</div>' +
      logRows +
    '</div>'
  );
}

async function adminRunAIBuilder() {
  var inp = document.getElementById('aiBuilderInput');
  var btn = document.getElementById('aiBuilderBtn');
  if (!inp) return;
  var instruction = (inp.value || '').trim();
  if (!instruction) { notify('Please enter an instruction first', 'error', 'x'); return; }

  if (btn) { btn.disabled = true; btn.textContent = 'AI is thinking...'; }
  var result = await runAIAppBuilder(instruction);
  if (btn) { btn.disabled = false; btn.textContent = 'Apply with AI'; }

  if (result) {
    inp.value = '';
    window._adminTab = 'aibuilder';
    renderAdmin();
  }
}




// ============================================================
// AI TOOLS SUITE â€” 6 admin-only AI power tools
// ============================================================

// â”€â”€ 1. AI USER INSIGHTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function adminRunUserInsights() {
  var users = [];
  try { users = JSON.parse(localStorage.getItem('tv_all_users') || '[]'); } catch(e) {}
  var actLog = [];
  try { actLog = JSON.parse(localStorage.getItem('tv_activity_log') || '[]'); } catch(e) {}
  var npsScores = [];
  try { npsScores = JSON.parse(localStorage.getItem('tv_nps_scores') || '[]'); } catch(e) {}

  if (!users.length) { notify('No users to analyse yet', 'error', 'x'); return; }

  var planCounts = {free:0,starter:0,pro:0,gold:0,elite:0};
  users.forEach(function(u){ if(planCounts[u.plan]!==undefined) planCounts[u.plan]++; });
  var paid = users.filter(function(u){ return u.plan !== 'free'; }).length;
  var convRate = users.length ? Math.round((paid/users.length)*100) : 0;
  var now = Date.now();
  var day = 86400000;
  var active7 = users.filter(function(u){ return (now-(u.lastLogin||0)) < 7*day; }).length;
  var inactive30 = users.filter(function(u){ return (now-(u.lastLogin||0)) > 30*day; }).length;
  var promoters = npsScores.filter(function(n){ return n.score>=9; }).length;
  var detractors = npsScores.filter(function(n){ return n.score<=6; }).length;
  var nps = npsScores.length ? Math.round(((promoters-detractors)/npsScores.length)*100) : null;

  var btn = document.getElementById('userInsightsBtn');
  var out = document.getElementById('userInsightsOutput');
  if(btn) { btn.disabled=true; btn.textContent='Analysing...'; }
  if(out) out.innerHTML = '<div class="ai-thinking"><div class="spinner"></div><span>AI is analysing your users...</span></div>';

  var prompt =
    'You are a SaaS growth consultant analysing user data for TrendVid AI.\n\n' +
    'DATA:\n' +
    '- Total users: ' + users.length + '\n' +
    '- Plan breakdown: Free=' + planCounts.free + ', Starter=' + planCounts.starter + ', Pro=' + planCounts.pro + ', Gold=' + planCounts.gold + ', Elite=' + planCounts.elite + '\n' +
    '- Conversion rate (freeâ†’paid): ' + convRate + '%\n' +
    '- Active in last 7 days: ' + active7 + '\n' +
    '- Inactive 30+ days: ' + inactive30 + '\n' +
    (nps !== null ? '- NPS score: ' + nps + '\n' : '') +
    '- Recent actions logged: ' + actLog.length + '\n\n' +
    'Return ONLY valid JSON:\n' +
    '{\n' +
    '  "healthScore": number 0-100,\n' +
    '  "healthLabel": "Healthy|At Risk|Critical",\n' +
    '  "summary": "2-sentence overview of the user base",\n' +
    '  "churnRisk": "1-2 sentences on churn risk",\n' +
    '  "topOpportunity": "single best upsell/retention opportunity",\n' +
    '  "quickWins": ["action 1", "action 2", "action 3"],\n' +
    '  "upgradeTargets": "which plan segment to focus upsell on and why",\n' +
    '  "reEngagementIdea": "specific tactic to re-engage the ' + inactive30 + ' inactive users",\n' +
    '  "kpis": [{"label":"string","value":"string","trend":"up|down|flat","note":"string"}]\n' +
    '}';

  try {
    var raw = await aiCall([{role:'user',content:prompt}], 'You are a data-driven SaaS growth analyst. Return ONLY valid raw JSON.', 1000);
    var data = JSON.parse(raw.replace(/```json|```/g,'').trim());
    var healthColor = {'Healthy':'var(--teal)','At Risk':'var(--gold)','Critical':'var(--accent)'}[data.healthLabel]||'var(--teal)';

    var kpiHtml = (data.kpis||[]).map(function(k){
      var trendIcon = {up:'â†‘',down:'â†“',flat:'â†’'}[k.trend]||'';
      var trendColor = {up:'var(--teal)',down:'var(--accent)',flat:'var(--muted)'}[k.trend]||'var(--muted)';
      return '<div class="card" style="padding:12px 14px;text-align:center">'+
        '<div style="font-size:18px;font-weight:900;color:var(--text)">'+k.value+'<span style="font-size:14px;color:'+trendColor+'"> '+trendIcon+'</span></div>'+
        '<div style="font-size:10px;color:var(--muted);margin-top:2px">'+k.label+'</div>'+
        (k.note?'<div style="font-size:10px;color:var(--text2);margin-top:3px">'+k.note+'</div>':'')+
      '</div>';
    }).join('');

    var quickWinsHtml = (data.quickWins||[]).map(function(w,i){
      return '<div style="display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">'+
        '<div style="width:22px;height:22px;border-radius:50%;background:rgba(0,229,176,0.15);border:1px solid rgba(0,229,176,0.3);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900;color:var(--teal);flex-shrink:0">'+(i+1)+'</div>'+
        '<div style="font-size:12px;color:var(--text2);line-height:1.5">'+w+'</div>'+
      '</div>';
    }).join('');

    if(out) out.innerHTML =
      '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-bottom:16px">'+kpiHtml+'</div>'+
      '<div class="card" style="margin-bottom:12px;padding:16px 18px;border-color:'+healthColor.replace(')',',0.4)').replace('var(--','rgba(').replace('teal','0,229,176').replace('gold','251,191,36').replace('accent','255,48,88')+'">'+
        '<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">'+
          '<div style="width:44px;height:44px;border-radius:50%;background:'+healthColor+';display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;color:#000;flex-shrink:0">'+data.healthScore+'</div>'+
          '<div><div style="font-size:14px;font-weight:900">'+data.healthLabel+'</div><div style="font-size:11px;color:var(--muted)">User Base Health Score</div></div>'+
        '</div>'+
        '<div style="font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:10px">'+data.summary+'</div>'+
        '<div style="font-size:12px;color:var(--gold);background:rgba(251,191,36,0.07);border:1px solid rgba(251,191,36,0.2);border-radius:8px;padding:8px 12px;margin-bottom:8px">âš ï¸ Churn Risk: '+data.churnRisk+'</div>'+
        '<div style="font-size:12px;color:var(--teal);background:rgba(0,229,176,0.07);border:1px solid rgba(0,229,176,0.2);border-radius:8px;padding:8px 12px">ðŸŽ¯ Top Opportunity: '+data.topOpportunity+'</div>'+
      '</div>'+
      '<div class="card" style="margin-bottom:12px;padding:16px 18px">'+
        '<div style="font-size:11px;font-weight:900;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px">QUICK WINS</div>'+
        quickWinsHtml+
      '</div>'+
      '<div class="card" style="padding:16px 18px">'+
        '<div style="font-size:11px;font-weight:900;letter-spacing:1.5px;color:var(--muted);margin-bottom:8px">RE-ENGAGEMENT IDEA</div>'+
        '<div style="font-size:12px;color:var(--text2);line-height:1.6">'+data.reEngagementIdea+'</div>'+
        '<div style="margin-top:10px;font-size:11px;font-weight:900;letter-spacing:1.5px;color:var(--muted);margin-bottom:8px">UPSELL TARGETS</div>'+
        '<div style="font-size:12px;color:var(--text2);line-height:1.6">'+data.upgradeTargets+'</div>'+
      '</div>';

    notify('User insights ready', 'success', 'done');
  } catch(err) {
    if(out) out.innerHTML = '<div style="color:var(--accent);padding:12px">Error: '+err.message+'</div>';
  }
  if(btn) { btn.disabled=false; btn.textContent='ðŸ§  Analyse Users'; }
}

function _adminUserInsightsContent() {
  return '<div style="font-family:var(--font-display);font-size:16px;font-weight:900;margin-bottom:4px">ðŸ§  AI User Insights</div>'+
    '<div style="font-size:12px;color:var(--muted);margin-bottom:16px">AI reads your user data and gives you a health score, churn risk, and concrete actions to grow.</div>'+
    '<button class="btn btn-primary" id="userInsightsBtn" onclick="adminRunUserInsights()" style="margin-bottom:16px">ðŸ§  Analyse Users</button>'+
    '<div id="userInsightsOutput"></div>';
}

// â”€â”€ 2. AI GROWTH ADVISOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function adminRunGrowthAdvisor() {
  var users = [];
  try { users = JSON.parse(localStorage.getItem('tv_all_users') || '[]'); } catch(e) {}
  var prices = {};
  try { prices = JSON.parse(localStorage.getItem('tv_custom_prices') || '{}'); } catch(e) {}
  var planPrices = {free:0,starter:parseInt(prices.price_starter||9),pro:parseInt(prices.price_pro||19),gold:parseInt(prices.price_gold||39),elite:parseInt(prices.price_elite||79)};
  var mrr = users.reduce(function(s,u){return s+(planPrices[u.plan]||0);},0);
  var paid = users.filter(function(u){return u.plan!=='free';}).length;
  var conv = users.length ? ((paid/users.length)*100).toFixed(1) : 0;
  var planCounts = {};
  ['free','starter','pro','gold','elite'].forEach(function(p){ planCounts[p]=users.filter(function(u){return u.plan===p;}).length; });

  var goalEl = document.getElementById('growthGoalInput');
  var goal = goalEl ? goalEl.value.trim() : '';

  var btn = document.getElementById('growthAdvisorBtn');
  var out = document.getElementById('growthAdvisorOutput');
  if(btn){ btn.disabled=true; btn.textContent='Thinking...'; }
  if(out) out.innerHTML='<div class="ai-thinking"><div class="spinner"></div><span>AI is building your growth strategy...</span></div>';

  var prompt =
    'You are a SaaS growth expert for TrendVid AI, a creator platform with plans at Â£9/Â£19/Â£39/Â£79/mo.\n\n'+
    'CURRENT METRICS:\n'+
    '- MRR: Â£'+mrr+'/mo\n'+
    '- Users: '+users.length+' total ('+paid+' paid, '+planCounts.free+' free)\n'+
    '- Conversion: '+conv+'%\n'+
    '- Plan breakdown: Starter='+planCounts.starter+', Pro='+planCounts.pro+', Gold='+planCounts.gold+', Elite='+planCounts.elite+'\n'+
    (goal ? '- Admin goal: '+goal+'\n' : '')+
    '\nReturn ONLY valid raw JSON:\n'+
    '{\n'+
    '  "mrrTarget": "realistic 90-day MRR target in Â£",\n'+
    '  "strategy": "2-3 sentence overall growth strategy",\n'+
    '  "channels": [{"name":"string","effort":"Low|Medium|High","impact":"Low|Medium|High","action":"specific tactic string"}],\n'+
    '  "conversionFix": "specific tip to improve freeâ†’paid conversion",\n'+
    '  "pricingInsight": "one pricing lever to pull",\n'+
    '  "retentionPlay": "one retention improvement",\n'+
    '  "week1Actions": ["action1","action2","action3"],\n'+
    '  "metrics": [{"name":"string","current":"string","target":"string"}]\n'+
    '}';

  try {
    var raw = await aiCall([{role:'user',content:prompt}], 'You are an expert SaaS growth advisor. Return ONLY valid raw JSON.', 1200);
    var data = JSON.parse(raw.replace(/```json|```/g,'').trim());

    var effortColor = {'Low':'var(--teal)','Medium':'var(--gold)','High':'var(--accent)'};
    var impactColor = {'Low':'var(--muted)','Medium':'var(--gold)','High':'var(--teal)'};

    var channelRows = (data.channels||[]).map(function(c){
      return '<div style="display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);align-items:flex-start">'+
        '<div style="flex:1"><div style="font-size:12px;font-weight:800;margin-bottom:2px">'+c.name+'</div>'+
        '<div style="font-size:12px;color:var(--text2)">'+c.action+'</div></div>'+
        '<div style="display:flex;gap:6px;flex-shrink:0;align-items:center">'+
          '<span style="font-size:9px;font-weight:800;padding:2px 7px;border-radius:6px;background:rgba(0,0,0,0.2);color:'+(effortColor[c.effort]||'var(--muted)')+'">'+c.effort+' effort</span>'+
          '<span style="font-size:9px;font-weight:800;padding:2px 7px;border-radius:6px;background:rgba(0,0,0,0.2);color:'+(impactColor[c.impact]||'var(--muted)')+'">'+c.impact+' impact</span>'+
        '</div>'+
      '</div>';
    }).join('');

    var week1Html = (data.week1Actions||[]).map(function(a,i){
      return '<div style="display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">'+
        '<div style="width:22px;height:22px;border-radius:6px;background:rgba(255,48,88,0.15);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900;color:var(--accent);flex-shrink:0">'+(i+1)+'</div>'+
        '<div style="font-size:12px;color:var(--text2);line-height:1.5">'+a+'</div>'+
      '</div>';
    }).join('');

    var metricsHtml = (data.metrics||[]).map(function(m){
      return '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px">'+
        '<span style="color:var(--muted)">'+m.name+'</span>'+
        '<span><strong style="color:var(--text)">'+m.current+'</strong><span style="color:var(--muted)"> â†’ </span><strong style="color:var(--teal)">'+m.target+'</strong></span>'+
      '</div>';
    }).join('');

    if(out) out.innerHTML =
      '<div class="card" style="margin-bottom:12px;padding:16px 18px;background:linear-gradient(135deg,rgba(0,229,176,0.05),rgba(167,139,250,0.03));border-color:rgba(0,229,176,0.2)">'+
        '<div style="font-size:11px;font-weight:900;letter-spacing:1.5px;color:var(--muted);margin-bottom:6px">90-DAY TARGET</div>'+
        '<div style="font-size:26px;font-weight:900;font-family:var(--font-display);color:var(--teal);margin-bottom:8px">'+data.mrrTarget+'</div>'+
        '<div style="font-size:13px;color:var(--text2);line-height:1.6">'+data.strategy+'</div>'+
      '</div>'+
      '<div class="card" style="margin-bottom:12px;padding:16px 18px">'+
        '<div style="font-size:11px;font-weight:900;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px">GROWTH CHANNELS</div>'+
        channelRows+
      '</div>'+
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">'+
        '<div class="card" style="padding:14px 16px">'+
          '<div style="font-size:10px;font-weight:900;color:var(--muted);margin-bottom:8px">CONVERSION FIX</div>'+
          '<div style="font-size:12px;color:var(--text2);line-height:1.5">'+data.conversionFix+'</div>'+
        '</div>'+
        '<div class="card" style="padding:14px 16px">'+
          '<div style="font-size:10px;font-weight:900;color:var(--muted);margin-bottom:8px">PRICING LEVER</div>'+
          '<div style="font-size:12px;color:var(--text2);line-height:1.5">'+data.pricingInsight+'</div>'+
        '</div>'+
      '</div>'+
      '<div class="card" style="margin-bottom:12px;padding:16px 18px">'+
        '<div style="font-size:11px;font-weight:900;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px">DO THIS WEEK</div>'+
        week1Html+
      '</div>'+
      '<div class="card" style="padding:16px 18px">'+
        '<div style="font-size:11px;font-weight:900;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px">METRICS TO TRACK</div>'+
        metricsHtml+
      '</div>';
    notify('Growth plan ready', 'success', 'done');
  } catch(err) {
    if(out) out.innerHTML='<div style="color:var(--accent);padding:12px">Error: '+err.message+'</div>';
  }
  if(btn){ btn.disabled=false; btn.textContent='ðŸ“Š Get Growth Plan'; }
}

function _adminGrowthAdvisorContent() {
  return '<div style="font-family:var(--font-display);font-size:16px;font-weight:900;margin-bottom:4px">ðŸ“Š AI Growth Advisor</div>'+
    '<div style="font-size:12px;color:var(--muted);margin-bottom:16px">AI reads your real MRR, conversion rate, and plan data â€” then gives a concrete 90-day growth strategy.</div>'+
    '<div class="card" style="margin-bottom:16px;padding:14px 16px">'+
      '<label style="font-size:11px;font-weight:700;color:var(--muted);display:block;margin-bottom:6px">YOUR GOAL (optional)</label>'+
      '<input id="growthGoalInput" class="form-input" placeholder="e.g. Reach Â£5,000 MRR, reduce churn, double conversion rate..." style="font-size:12px">'+
    '</div>'+
    '<button class="btn btn-primary" id="growthAdvisorBtn" onclick="adminRunGrowthAdvisor()" style="margin-bottom:16px">ðŸ“Š Get Growth Plan</button>'+
    '<div id="growthAdvisorOutput"></div>';
}

// â”€â”€ 3. AI COPYWRITER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function adminRunCopywriter() {
  var typeEl = document.getElementById('copyTypeSelect');
  var toneEl = document.getElementById('copyToneSelect');
  var contextEl = document.getElementById('copyContextInput');
  var copyType = typeEl ? typeEl.value : 'upgrade_cta';
  var tone = toneEl ? toneEl.value : 'friendly';
  var context = contextEl ? contextEl.value.trim() : '';

  var btn = document.getElementById('copywriterBtn');
  var out = document.getElementById('copywriterOutput');
  if(btn){ btn.disabled=true; btn.textContent='Writing...'; }
  if(out) out.innerHTML='<div class="ai-thinking"><div class="spinner"></div><span>AI is writing your copy...</span></div>';

  var copyTypes = {
    upgrade_cta: 'in-app upgrade CTA (short button text + 1-line subtext)',
    onboarding_email: 'onboarding welcome email (subject + full email body)',
    winback_email: 'win-back email for churned/inactive users (subject + full email body)',
    upgrade_email: 'upgrade nudge email targeting free users (subject + full email body)',
    push_notification: '3 push notification variants (title + body for each)',
    landing_hero: 'landing page hero section (headline, subheadline, CTA button text, 3 benefit bullets)',
    pricing_page: 'pricing page copy (headline, plan descriptions, FAQ answers)',
    social_bio: 'social media bio variants for Twitter, LinkedIn, Instagram',
    feature_announcement: 'in-app feature announcement banner (title + 2-sentence message)',
    ad_copy: '3 ad copy variants (Facebook/Google style â€” headline + description + CTA)',
  };

  var prompt =
    'You are a world-class SaaS copywriter for TrendVid AI â€” an AI studio for content creators.\n'+
    'The app helps creators find viral trends, generate scripts, make thumbnails, and grow their channels.\n'+
    'Plans start at Â£9/mo. Tone for this piece: '+tone+'.\n'+
    (context ? 'Additional context: '+context+'\n' : '')+
    '\nWrite: '+copyTypes[copyType]+'\n\n'+
    'Return ONLY valid raw JSON:\n'+
    '{\n'+
    '  "pieces": [{"label":"string","content":"string"}],\n'+
    '  "notes": "1 line of guidance on when/how to use this copy"\n'+
    '}';

  try {
    var raw = await aiCall([{role:'user',content:prompt}], 'You are a conversion-focused SaaS copywriter. Return ONLY valid raw JSON.', 1400);
    var data = JSON.parse(raw.replace(/```json|```/g,'').trim());

    var piecesHtml = (data.pieces||[]).map(function(p){
      return '<div class="card" style="margin-bottom:10px;padding:14px 16px">'+
        '<div style="font-size:10px;font-weight:900;color:var(--teal);letter-spacing:1.5px;margin-bottom:8px">'+p.label.toUpperCase()+'</div>'+
        '<pre style="white-space:pre-wrap;font-family:inherit;font-size:12px;color:var(--text2);line-height:1.7;margin:0 0 10px">'+p.content+'</pre>'+
        '<button class="btn btn-ghost btn-sm" style="font-size:10px" onclick="adminCopyText(this,'+JSON.stringify(p.content)+')">ðŸ“‹ Copy</button>'+
      '</div>';
    }).join('');

    if(out) out.innerHTML =
      (data.notes?'<div style="font-size:11px;color:var(--muted);margin-bottom:12px;padding:8px 12px;background:rgba(167,139,250,0.06);border:1px solid rgba(167,139,250,0.2);border-radius:8px">ðŸ’¡ '+data.notes+'</div>':'')+
      piecesHtml;
    notify('Copy generated', 'success', 'done');
  } catch(err) {
    if(out) out.innerHTML='<div style="color:var(--accent);padding:12px">Error: '+err.message+'</div>';
  }
  if(btn){ btn.disabled=false; btn.textContent='âœï¸ Write Copy'; }
}

function adminCopyText(btn, text) {
  navigator.clipboard && navigator.clipboard.writeText(text).then(function(){
    btn.textContent='âœ… Copied!';
    setTimeout(function(){ btn.textContent='ðŸ“‹ Copy'; }, 2000);
  });
}

function _adminCopywriterContent() {
  var types = [
    ['upgrade_cta',       'In-app Upgrade CTA'],
    ['onboarding_email',  'Onboarding Email'],
    ['winback_email',     'Win-Back Email'],
    ['upgrade_email',     'Upgrade Nudge Email'],
    ['push_notification', 'Push Notifications'],
    ['landing_hero',      'Landing Page Hero'],
    ['pricing_page',      'Pricing Page Copy'],
    ['social_bio',        'Social Media Bios'],
    ['feature_announcement','Feature Announcement'],
    ['ad_copy',           'Ad Copy (FB/Google)'],
  ];
  var tones = ['friendly','professional','urgent','playful','bold','empathetic'];

  return '<div style="font-family:var(--font-display);font-size:16px;font-weight:900;margin-bottom:4px">âœï¸ AI Copywriter</div>'+
    '<div style="font-size:12px;color:var(--muted);margin-bottom:16px">Generate conversion-ready copy for emails, landing pages, ads, push notifications, and in-app CTAs.</div>'+
    '<div class="card" style="margin-bottom:16px;padding:14px 16px">'+
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px">'+
        '<div><label style="font-size:10px;font-weight:900;color:var(--muted);display:block;margin-bottom:6px">WHAT TO WRITE</label>'+
          '<select id="copyTypeSelect" class="form-input form-select" style="font-size:12px">'+
            types.map(function(t){ return '<option value="'+t[0]+'">'+t[1]+'</option>'; }).join('')+
          '</select>'+
        '</div>'+
        '<div><label style="font-size:10px;font-weight:900;color:var(--muted);display:block;margin-bottom:6px">TONE</label>'+
          '<select id="copyToneSelect" class="form-input form-select" style="font-size:12px">'+
            tones.map(function(t){ return '<option value="'+t+'">'+t.charAt(0).toUpperCase()+t.slice(1)+'</option>'; }).join('')+
          '</select>'+
        '</div>'+
      '</div>'+
      '<label style="font-size:10px;font-weight:900;color:var(--muted);display:block;margin-bottom:6px">EXTRA CONTEXT (optional)</label>'+
      '<input id="copyContextInput" class="form-input" placeholder="e.g. targeting Pro users who haven\'t used Script Generator, offering 20% discount..." style="font-size:12px;margin-bottom:10px">'+
      '<button class="btn btn-primary" id="copywriterBtn" onclick="adminRunCopywriter()">âœï¸ Write Copy</button>'+
    '</div>'+
    '<div id="copywriterOutput"></div>';
}

// â”€â”€ 4. AI FEATURE PLANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function adminRunFeaturePlanner() {
  var ideaEl = document.getElementById('featureIdeaInput');
  var idea = ideaEl ? ideaEl.value.trim() : '';
  if(!idea){ notify('Describe a feature idea first','error','x'); return; }

  var btn = document.getElementById('featurePlannerBtn');
  var out = document.getElementById('featurePlannerOutput');
  if(btn){ btn.disabled=true; btn.textContent='Planning...'; }
  if(out) out.innerHTML='<div class="ai-thinking"><div class="spinner"></div><span>AI is writing your feature spec...</span></div>';

  var existingPages = Object.keys(typeof pageTitles!=='undefined'?pageTitles:{}).join(', ');

  var prompt =
    'You are a senior product manager + developer for TrendVid AI â€” a single-file HTML/JS SaaS app for content creators.\n'+
    'Existing pages: '+existingPages+'\n'+
    'Stack: vanilla JS, localStorage, AI via aiCall(), CSS custom properties, no frameworks.\n\n'+
    'Feature idea from admin: "'+idea+'"\n\n'+
    'Return ONLY valid raw JSON:\n'+
    '{\n'+
    '  "name": "Feature name",\n'+
    '  "tagline": "One-line description",\n'+
    '  "problem": "What user problem this solves",\n'+
    '  "userStory": "As a [user], I want to [action] so that [outcome]",\n'+
    '  "plan": "Target plan tier (free/starter/pro/gold/elite)",\n'+
    '  "components": ["UI component 1","UI component 2","..."],\n'+
    '  "aiPrompt": "The exact AI prompt this feature would send to get results",\n'+
    '  "dataStored": "What gets saved to localStorage and the key name",\n'+
    '  "navPageId": "suggested URL-safe page id (e.g. mypageid)",\n'+
    '  "implementation": ["Step 1: add to pageTitles","Step 2: add navTo case","Step 3: write renderXxx()","Step 4: ..."],\n'+
    '  "effort": "Low|Medium|High",\n'+
    '  "impact": "Low|Medium|High",\n'+
    '  "mvpScope": "What to build first for MVP (1-2 sentences)",\n'+
    '  "risks": ["risk 1","risk 2"]\n'+
    '}';

  try {
    var raw = await aiCall([{role:'user',content:prompt}], 'You are a precise product manager. Return ONLY valid raw JSON.', 1400);
    var d = JSON.parse(raw.replace(/```json|```/g,'').trim());

    var effortColor = {'Low':'var(--teal)','Medium':'var(--gold)','High':'var(--accent)'};
    var impactColor = {'Low':'var(--muted)','Medium':'var(--gold)','High':'var(--teal)'};

    var implHtml = (d.implementation||[]).map(function(s,i){
      return '<div style="display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">'+
        '<div style="width:20px;height:20px;border-radius:6px;background:rgba(99,102,241,0.15);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;color:var(--purple);flex-shrink:0">'+(i+1)+'</div>'+
        '<div style="font-size:12px;color:var(--text2);line-height:1.5">'+s+'</div>'+
      '</div>';
    }).join('');

    if(out) out.innerHTML =
      '<div class="card" style="margin-bottom:12px;padding:16px 18px;border-color:rgba(99,102,241,0.3)">'+
        '<div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px">'+
          '<div>'+
            '<div style="font-size:16px;font-weight:900">'+d.name+'</div>'+
            '<div style="font-size:12px;color:var(--muted)">'+d.tagline+'</div>'+
          '</div>'+
          '<div style="display:flex;gap:6px">'+
            '<span style="font-size:9px;font-weight:900;padding:3px 9px;border-radius:8px;background:rgba(0,0,0,0.2);color:'+(effortColor[d.effort]||'var(--muted)')+'">'+d.effort+' effort</span>'+
            '<span style="font-size:9px;font-weight:900;padding:3px 9px;border-radius:8px;background:rgba(0,0,0,0.2);color:'+(impactColor[d.impact]||'var(--muted)')+'">'+d.impact+' impact</span>'+
            '<span class="tier-badge tier-'+(d.plan||'pro')+'" style="font-size:9px">'+(d.plan||'pro').toUpperCase()+'</span>'+
          '</div>'+
        '</div>'+
        '<div style="font-size:12px;color:var(--text2);margin-bottom:8px"><strong style="color:var(--text)">Problem:</strong> '+d.problem+'</div>'+
        '<div style="font-size:12px;color:var(--text2);margin-bottom:8px;font-style:italic;background:var(--surface2);padding:8px 12px;border-radius:8px">'+d.userStory+'</div>'+
        '<div style="font-size:12px;color:var(--teal)"><strong>MVP: </strong>'+d.mvpScope+'</div>'+
      '</div>'+
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">'+
        '<div class="card" style="padding:14px 16px">'+
          '<div style="font-size:10px;font-weight:900;color:var(--muted);margin-bottom:8px">AI PROMPT TO USE</div>'+
          '<div style="font-size:11px;color:var(--text2);line-height:1.6;background:var(--surface2);padding:10px;border-radius:8px;font-family:monospace;white-space:pre-wrap">'+d.aiPrompt+'</div>'+
          '<button class="btn btn-ghost btn-sm" style="font-size:10px;margin-top:8px" onclick="adminCopyText(this,'+JSON.stringify(d.aiPrompt||'')+')" >ðŸ“‹ Copy Prompt</button>'+
        '</div>'+
        '<div class="card" style="padding:14px 16px">'+
          '<div style="font-size:10px;font-weight:900;color:var(--muted);margin-bottom:8px">COMPONENTS + DATA</div>'+
          '<div style="font-size:11px;color:var(--text2);margin-bottom:8px">'+
            (d.components||[]).map(function(c){ return '<div style="padding:3px 0;border-bottom:1px solid var(--border)">â€¢ '+c+'</div>'; }).join('')+
          '</div>'+
          '<div style="font-size:10px;font-weight:900;color:var(--muted);margin-bottom:4px">PAGE ID</div>'+
          '<code style="font-size:11px;background:var(--surface2);padding:3px 8px;border-radius:6px;color:var(--teal)">'+d.navPageId+'</code>'+
          '<div style="font-size:10px;font-weight:900;color:var(--muted);margin:8px 0 4px">localStorage KEY</div>'+
          '<div style="font-size:11px;color:var(--text2)">'+d.dataStored+'</div>'+
        '</div>'+
      '</div>'+
      '<div class="card" style="margin-bottom:12px;padding:14px 16px">'+
        '<div style="font-size:10px;font-weight:900;color:var(--muted);margin-bottom:8px">IMPLEMENTATION STEPS</div>'+
        implHtml+
      '</div>'+
      (d.risks&&d.risks.length?
        '<div class="card" style="padding:14px 16px;border-color:rgba(255,48,88,0.2)">'+
          '<div style="font-size:10px;font-weight:900;color:var(--accent);margin-bottom:8px">RISKS</div>'+
          (d.risks||[]).map(function(r){ return '<div style="font-size:12px;color:var(--text2);padding:4px 0;border-bottom:1px solid var(--border)">âš ï¸ '+r+'</div>'; }).join('')+
        '</div>':''
      );
    notify('Feature spec ready','success','done');
  } catch(err) {
    if(out) out.innerHTML='<div style="color:var(--accent);padding:12px">Error: '+err.message+'</div>';
  }
  if(btn){ btn.disabled=false; btn.textContent='âš¡ Plan Feature'; }
}

function _adminFeaturePlannerContent() {
  var recent = [];
  try {
    var log = JSON.parse(localStorage.getItem('tv_feature_plans')||'[]');
    recent = log.slice(0,3);
  } catch(e) {}

  return '<div style="font-family:var(--font-display);font-size:16px;font-weight:900;margin-bottom:4px">âš¡ AI Feature Planner</div>'+
    '<div style="font-size:12px;color:var(--muted);margin-bottom:16px">Describe a feature idea. AI writes a full product spec, implementation steps, AI prompt, and localStorage schema.</div>'+
    '<div class="card" style="margin-bottom:16px;padding:14px 16px">'+
      '<label style="font-size:10px;font-weight:900;color:var(--muted);display:block;margin-bottom:6px">YOUR IDEA</label>'+
      '<textarea id="featureIdeaInput" class="form-input" rows="3" placeholder="e.g. A competitor spy tool that lets users paste a YouTube channel URL and get their top-performing video topics, upload frequency, and estimated earnings..." style="font-size:12px;resize:vertical;margin-bottom:10px"></textarea>'+
      '<button class="btn btn-primary" id="featurePlannerBtn" onclick="adminRunFeaturePlanner()">âš¡ Plan Feature</button>'+
    '</div>'+
    '<div id="featurePlannerOutput"></div>';
}

// â”€â”€ 5. AI EMAIL SEQUENCES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function adminRunEmailSequence() {
  var typeEl = document.getElementById('seqTypeSelect');
  var seqType = typeEl ? typeEl.value : 'onboarding';
  var lengthEl = document.getElementById('seqLengthSelect');
  var seqLength = lengthEl ? parseInt(lengthEl.value) : 3;

  var btn = document.getElementById('emailSeqBtn');
  var out = document.getElementById('emailSeqOutput');
  if(btn){ btn.disabled=true; btn.textContent='Writing...'; }
  if(out) out.innerHTML='<div class="ai-thinking"><div class="spinner"></div><span>AI is writing your email sequence...</span></div>';

  var seqLabels = {
    onboarding: 'onboarding sequence for brand new users',
    winback: 'win-back sequence for users inactive 30+ days',
    upgrade: 'upgrade nurture sequence for free users',
    pro_to_gold: 'upsell sequence for Pro users â†’ Gold plan',
    trial_expiry: 'trial expiry warning sequence',
    feature_adoption: 'feature adoption sequence to get users to try Script Generator',
  };

  var prompt =
    'Write a '+seqLength+'-email '+seqLabels[seqType]+' for TrendVid AI â€” an AI creator studio (plans from Â£9/mo).\n'+
    'Each email should drive a specific action. Be concise, personal, and conversion-focused.\n\n'+
    'Return ONLY valid raw JSON:\n'+
    '{\n'+
    '  "sequenceName": "string",\n'+
    '  "triggerCondition": "when this sequence fires",\n'+
    '  "emails": [\n'+
    '    {\n'+
    '      "day": number,\n'+
    '      "subject": "string",\n'+
    '      "preheader": "string",\n'+
    '      "body": "full email body string (use \\n for line breaks)",\n'+
    '      "cta": "button text",\n'+
    '      "goal": "what this email achieves"\n'+
    '    }\n'+
    '  ]\n'+
    '}';

  try {
    var raw = await aiCall([{role:'user',content:prompt}], 'You are a conversion email specialist. Return ONLY valid raw JSON.', 2000);
    var data = JSON.parse(raw.replace(/```json|```/g,'').trim());

    var emailsHtml = (data.emails||[]).map(function(e,i){
      return '<div class="card" style="margin-bottom:10px;padding:14px 16px">'+
        '<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:10px">'+
          '<div>'+
            '<div style="font-size:10px;font-weight:900;color:var(--accent);letter-spacing:1.5px;margin-bottom:4px">EMAIL '+(i+1)+' Â· DAY '+e.day+'</div>'+
            '<div style="font-size:13px;font-weight:800">'+e.subject+'</div>'+
            '<div style="font-size:11px;color:var(--muted);margin-top:2px">Preview: '+e.preheader+'</div>'+
          '</div>'+
          '<span style="font-size:9px;background:rgba(0,229,176,0.1);color:var(--teal);padding:3px 9px;border-radius:8px;font-weight:700;flex-shrink:0">'+e.goal+'</span>'+
        '</div>'+
        '<pre style="white-space:pre-wrap;font-family:inherit;font-size:12px;color:var(--text2);line-height:1.75;background:var(--surface2);padding:12px;border-radius:8px;margin-bottom:10px">'+e.body+'</pre>'+
        '<div style="display:flex;align-items:center;justify-content:space-between">'+
          '<span style="font-size:11px;font-weight:700;background:var(--accent);color:#fff;padding:4px 14px;border-radius:8px">'+e.cta+'</span>'+
          '<button class="btn btn-ghost btn-sm" style="font-size:10px" onclick="adminCopyText(this,'+JSON.stringify('Subject: '+e.subject+'\nPreheader: '+e.preheader+'\n\n'+e.body+'\n\nCTA: '+e.cta)+')" >ðŸ“‹ Copy</button>'+
        '</div>'+
      '</div>';
    }).join('');

    if(out) out.innerHTML =
      '<div class="card" style="margin-bottom:12px;padding:12px 16px;background:rgba(99,102,241,0.04);border-color:rgba(99,102,241,0.25)">'+
        '<div style="font-size:13px;font-weight:800;margin-bottom:4px">'+data.sequenceName+'</div>'+
        '<div style="font-size:11px;color:var(--muted)">Trigger: '+data.triggerCondition+'</div>'+
      '</div>'+
      emailsHtml;
    notify('Email sequence ready','success','done');
  } catch(err) {
    if(out) out.innerHTML='<div style="color:var(--accent);padding:12px">Error: '+err.message+'</div>';
  }
  if(btn){ btn.disabled=false; btn.textContent='ðŸ“§ Generate Sequence'; }
}

function _adminEmailSeqContent() {
  var types = [
    ['onboarding',      'Onboarding (new users)'],
    ['winback',         'Win-Back (inactive 30d+)'],
    ['upgrade',         'Free â†’ Paid Upgrade'],
    ['pro_to_gold',     'Pro â†’ Gold Upsell'],
    ['trial_expiry',    'Trial Expiry Warning'],
    ['feature_adoption','Feature Adoption'],
  ];
  return '<div style="font-family:var(--font-display);font-size:16px;font-weight:900;margin-bottom:4px">ðŸ“§ AI Email Sequences</div>'+
    '<div style="font-size:12px;color:var(--muted);margin-bottom:16px">Generate full drip email sequences â€” onboarding, win-back, upgrade nudges, upsells. Ready to paste into any email tool.</div>'+
    '<div class="card" style="margin-bottom:16px;padding:14px 16px">'+
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px">'+
        '<div><label style="font-size:10px;font-weight:900;color:var(--muted);display:block;margin-bottom:6px">SEQUENCE TYPE</label>'+
          '<select id="seqTypeSelect" class="form-input form-select" style="font-size:12px">'+
            types.map(function(t){ return '<option value="'+t[0]+'">'+t[1]+'</option>'; }).join('')+
          '</select>'+
        '</div>'+
        '<div><label style="font-size:10px;font-weight:900;color:var(--muted);display:block;margin-bottom:6px">NUMBER OF EMAILS</label>'+
          '<select id="seqLengthSelect" class="form-input form-select" style="font-size:12px">'+
            ['3','5','7'].map(function(n){ return '<option value="'+n+'">'+n+' emails</option>'; }).join('')+
          '</select>'+
        '</div>'+
      '</div>'+
      '<button class="btn btn-primary" id="emailSeqBtn" onclick="adminRunEmailSequence()">ðŸ“§ Generate Sequence</button>'+
    '</div>'+
    '<div id="emailSeqOutput"></div>';
}

// â”€â”€ 6. AI BUG FIXER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function adminRunBugFixer() {
  var errEl = document.getElementById('bugErrorInput');
  var ctxEl = document.getElementById('bugContextInput');
  var err = errEl ? errEl.value.trim() : '';
  var ctx = ctxEl ? ctxEl.value.trim() : '';
  if(!err){ notify('Paste an error message first','error','x'); return; }

  var btn = document.getElementById('bugFixerBtn');
  var out = document.getElementById('bugFixerOutput');
  if(btn){ btn.disabled=true; btn.textContent='Diagnosing...'; }
  if(out) out.innerHTML='<div class="ai-thinking"><div class="spinner"></div><span>AI is diagnosing your bug...</span></div>';

  var prompt =
    'You are a senior JavaScript/HTML developer specialising in single-file vanilla JS apps.\n'+
    'The app is TrendVid AI â€” a single HTML file with ~12,000 lines of vanilla JS, CSS, uses localStorage, no frameworks, calls AI via aiCall().\n\n'+
    'ERROR:\n'+err+'\n'+
    (ctx ? '\nCONTEXT / CODE SNIPPET:\n'+ctx+'\n' : '')+
    '\nDiagnose and fix this. Return ONLY valid raw JSON:\n'+
    '{\n'+
    '  "diagnosis": "What is wrong and why",\n'+
    '  "severity": "Low|Medium|High|Critical",\n'+
    '  "rootCause": "The exact technical root cause",\n'+
    '  "fix": "The exact code fix or change needed",\n'+
    '  "fixExplanation": "Why this fix works",\n'+
    '  "preventionTip": "How to avoid this class of bug in future",\n'+
    '  "relatedIssues": ["other things this might affect"]\n'+
    '}';

  try {
    var raw = await aiCall([{role:'user',content:prompt}], 'You are a precise JavaScript debugger. Return ONLY valid raw JSON.', 1000);
    var data = JSON.parse(raw.replace(/```json|```/g,'').trim());

    var sevColor = {'Low':'var(--teal)','Medium':'var(--gold)','High':'var(--accent)','Critical':'var(--accent)'}[data.severity]||'var(--muted)';

    if(out) out.innerHTML =
      '<div class="card" style="margin-bottom:12px;padding:14px 16px;border-color:'+sevColor.replace(')',',0.4)').replace('var(--','rgba(').replace('teal','0,229,176').replace('gold','251,191,36').replace('accent','255,48,88')+'">'+
        '<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">'+
          '<span style="font-size:9px;font-weight:900;padding:4px 12px;border-radius:20px;background:rgba(0,0,0,0.3);color:'+sevColor+'">'+data.severity+' SEVERITY</span>'+
          '<div style="font-size:13px;font-weight:800">'+data.diagnosis+'</div>'+
        '</div>'+
        '<div style="font-size:12px;color:var(--muted)"><strong style="color:var(--text)">Root cause:</strong> '+data.rootCause+'</div>'+
      '</div>'+
      '<div class="card" style="margin-bottom:12px;padding:14px 16px;border-color:rgba(0,229,176,0.3)">'+
        '<div style="font-size:10px;font-weight:900;color:var(--teal);margin-bottom:8px">THE FIX</div>'+
        '<pre style="white-space:pre-wrap;font-family:monospace;font-size:12px;color:var(--text2);line-height:1.7;background:var(--surface2);padding:12px;border-radius:8px;margin-bottom:10px">'+data.fix+'</pre>'+
        '<button class="btn btn-ghost btn-sm" style="font-size:10px;margin-bottom:10px" onclick="adminCopyText(this,'+JSON.stringify(data.fix||'')+')" >ðŸ“‹ Copy Fix</button>'+
        '<div style="font-size:12px;color:var(--text2)">'+data.fixExplanation+'</div>'+
      '</div>'+
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">'+
        '<div class="card" style="padding:14px 16px">'+
          '<div style="font-size:10px;font-weight:900;color:var(--muted);margin-bottom:8px">PREVENTION TIP</div>'+
          '<div style="font-size:12px;color:var(--text2)">'+data.preventionTip+'</div>'+
        '</div>'+
        (data.relatedIssues&&data.relatedIssues.length?
          '<div class="card" style="padding:14px 16px">'+
            '<div style="font-size:10px;font-weight:900;color:var(--muted);margin-bottom:8px">MAY ALSO AFFECT</div>'+
            (data.relatedIssues||[]).map(function(r){ return '<div style="font-size:11px;color:var(--text2);padding:3px 0;border-bottom:1px solid var(--border)">â€¢ '+r+'</div>'; }).join('')+
          '</div>':'<div></div>')+
      '</div>';
    notify('Diagnosis ready','success','done');
  } catch(err) {
    if(out) out.innerHTML='<div style="color:var(--accent);padding:12px">Error: '+err.message+'</div>';
  }
  if(btn){ btn.disabled=false; btn.textContent='ðŸ” Diagnose Bug'; }
}

function _adminBugFixerContent() {
  return '<div style="font-family:var(--font-display);font-size:16px;font-weight:900;margin-bottom:4px">ðŸ› AI Bug Fixer</div>'+
    '<div style="font-size:12px;color:var(--muted);margin-bottom:16px">Paste a JS error, AI diagnoses the cause, writes the exact fix, and explains how to prevent it.</div>'+
    '<div class="card" style="margin-bottom:16px;padding:14px 16px">'+
      '<label style="font-size:10px;font-weight:900;color:var(--muted);display:block;margin-bottom:6px">ERROR MESSAGE</label>'+
      '<textarea id="bugErrorInput" class="form-input" rows="3" placeholder="Paste the error from the browser console here..." style="font-size:12px;font-family:monospace;resize:vertical;margin-bottom:10px"></textarea>'+
      '<label style="font-size:10px;font-weight:900;color:var(--muted);display:block;margin-bottom:6px">RELEVANT CODE SNIPPET (optional)</label>'+
      '<textarea id="bugContextInput" class="form-input" rows="4" placeholder="Paste the function or code block where the error occurs..." style="font-size:12px;font-family:monospace;resize:vertical;margin-bottom:10px"></textarea>'+
      '<button class="btn btn-primary" id="bugFixerBtn" onclick="adminRunBugFixer()">ðŸ” Diagnose Bug</button>'+
    '</div>'+
    '<div id="bugFixerOutput"></div>';
}

// â”€â”€ Main AI Tools Hub tab content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _adminAIToolsContent() {
  var tools = [
    {id:'insights',  icon:'ðŸ§ ', label:'User Insights',    desc:'Health score, churn risk, quick wins'},
    {id:'growth',    icon:'ðŸ“Š', label:'Growth Advisor',   desc:'90-day strategy, channels, MRR targets'},
    {id:'copy',      icon:'âœï¸', label:'Copywriter',       desc:'Emails, CTAs, landing pages, ads'},
    {id:'feature',   icon:'âš¡', label:'Feature Planner',  desc:'Full spec, implementation steps, AI prompt'},
    {id:'emailseq',  icon:'ðŸ“§', label:'Email Sequences',  desc:'Drip sequences for onboarding, upsells, win-back'},
    {id:'bugfix',    icon:'ðŸ›', label:'Bug Fixer',        desc:'Paste an error, get the exact fix'},
  ];

  var activeTool = window._activeAITool || 'insights';

  var navHtml = tools.map(function(t){
    var isActive = activeTool === t.id;
    return '<button onclick="window._activeAITool=\''+t.id+'\';window._adminTab=\'aitools\';renderAdmin()" style="'+
      'display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;border:1px solid '+(isActive?'rgba(0,229,176,0.35)':'var(--border)')+';'+
      'background:'+(isActive?'rgba(0,229,176,0.06)':'transparent')+';cursor:pointer;text-align:left;width:100%;transition:all 0.15s;font-family:inherit">'+
      '<span style="font-size:20px">'+t.icon+'</span>'+
      '<div>'+
        '<div style="font-size:12px;font-weight:800;color:'+(isActive?'var(--teal)':'var(--text)')+'">'+t.label+'</div>'+
        '<div style="font-size:10px;color:var(--muted)">'+t.desc+'</div>'+
      '</div>'+
    '</button>';
  }).join('');

  var toolContent = '';
  if(activeTool==='insights') toolContent = _adminUserInsightsContent();
  else if(activeTool==='growth') toolContent = _adminGrowthAdvisorContent();
  else if(activeTool==='copy') toolContent = _adminCopywriterContent();
  else if(activeTool==='feature') toolContent = _adminFeaturePlannerContent();
  else if(activeTool==='emailseq') toolContent = _adminEmailSeqContent();
  else if(activeTool==='bugfix') toolContent = _adminBugFixerContent();

  return '<div style="display:grid;grid-template-columns:200px 1fr;gap:16px;align-items:flex-start">'+
    '<div style="display:flex;flex-direction:column;gap:6px">'+
      '<div style="font-size:9px;font-weight:900;letter-spacing:2px;color:var(--muted);padding:4px 2px;font-family:var(--font-display)">AI TOOLS</div>'+
      navHtml+
    '</div>'+
    '<div>'+toolContent+'</div>'+
  '</div>';
}




// ============================================================
// REAL-TIME CONFIG EDITOR â€” instant live preview + persist
// ============================================================

// Called by every input/picker change â€” applies to DOM immediately and saves
function liveConfigUpdate(key, value) {
  var cfg = getAppConfig();
  cfg[key] = value;
  saveAppConfig(cfg);

  // Apply only the changed key instantly, no full re-render
  var root = document.documentElement;
  var colorMap = {
    primaryColor: '--accent',
    tealColor:    '--teal',
    bgColor:      '--bg',
    surfaceColor: '--surface',
    borderColor:  '--border',
    textColor:    '--text',
    mutedColor:   '--muted',
  };
  if (colorMap[key]) {
    root.style.setProperty(colorMap[key], value);
    // Update the swatch preview in the editor
    var swatch = document.getElementById('swatch_' + key);
    if (swatch) swatch.style.background = value;
    return;
  }
  if (key === 'borderRadius') {
    root.style.setProperty('--radius', value);
    return;
  }
  if (key === 'appName') {
    var nameEl = document.querySelector('.sidebar-logo-text');
    if (nameEl) {
      var parts = value.split('');
      var mid = Math.ceil(parts.length / 2);
      nameEl.innerHTML = parts.slice(0, mid).join('') + '<span>' + parts.slice(mid).join('') + '</span>';
    }
    return;
  }
  if (key === 'sidebarTagline') {
    document.querySelectorAll('.sidebar-tagline').forEach(function(el) {
      el.textContent = value;
    });
    return;
  }
  if (key === 'customCSS') {
    var style = document.getElementById('tv-custom-css');
    if (!style) {
      style = document.createElement('style');
      style.id = 'tv-custom-css';
      document.head.appendChild(style);
    }
    style.textContent = value;
    return;
  }
  // Section labels
  var sectionLabels = ['sectionHome','sectionCreate','sectionManage','sectionTools','sectionAccount'];
  if (sectionLabels.indexOf(key) !== -1) {
    var idx = sectionLabels.indexOf(key);
    var sections = document.querySelectorAll('.sidebar-section');
    if (sections[idx]) sections[idx].textContent = value;
    return;
  }
  // Fallback â€” full apply
  applyAppConfig();
}

// Debounce for text inputs (don't save on every keypress, wait 300ms)
var _liveConfigDebounce = {};
function liveConfigDebounced(key, value) {
  clearTimeout(_liveConfigDebounce[key]);
  _liveConfigDebounce[key] = setTimeout(function() {
    liveConfigUpdate(key, value);
  }, 300);
}

// The real-time config editor panel (replaces the config card in AI builder)
function _buildRealTimeEditor() {
  var cfg = getAppConfig();

  var colorFields = [
    {key:'primaryColor', label:'Accent / Action colour'},
    {key:'tealColor',    label:'Secondary / Highlight'},
    {key:'bgColor',      label:'Page background'},
    {key:'surfaceColor', label:'Card / Panel'},
    {key:'borderColor',  label:'Borders'},
    {key:'textColor',    label:'Primary text'},
    {key:'mutedColor',   label:'Muted text'},
  ];

  var colorPickersHtml = colorFields.map(function(f) {
    return '<div style="display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--border)">' +
      '<div id="swatch_' + f.key + '" style="width:28px;height:28px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);flex-shrink:0;cursor:pointer;background:' + (cfg[f.key]||'#888') + ';position:relative;overflow:hidden">' +
        '<input type="color" value="' + (cfg[f.key]||'#888') + '" ' +
          'oninput="liveConfigUpdate(\'' + f.key + '\',this.value)" ' +
          'onchange="liveConfigUpdate(\'' + f.key + '\',this.value)" ' +
          'style="position:absolute;inset:-4px;width:calc(100%+8px);height:calc(100%+8px);opacity:0;cursor:pointer;border:none;padding:0">' +
      '</div>' +
      '<div style="flex:1;min-width:0">' +
        '<div style="font-size:11px;font-weight:700;color:var(--text)">' + f.label + '</div>' +
        '<div style="font-size:10px;color:var(--muted);font-family:monospace" id="val_' + f.key + '">' + (cfg[f.key]||'') + '</div>' +
      '</div>' +
      '<input type="text" value="' + (cfg[f.key]||'') + '" maxlength="9" ' +
        'oninput="this.previousElementSibling.previousElementSibling.querySelector(\'[id]\').textContent=this.value;liveConfigDebounced(\'' + f.key + '\',this.value)" ' +
        'style="width:72px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:3px 7px;color:var(--text);font-size:11px;font-family:monospace;text-align:center">' +
    '</div>';
  }).join('');

  var radiusOptions = ['4px','8px','12px','16px','18px','24px','32px'];
  var radiusHtml = radiusOptions.map(function(r) {
    var active = cfg.borderRadius === r;
    return '<button onclick="liveConfigUpdate(\'borderRadius\',\'' + r + '\');this.parentNode.querySelectorAll(\'button\').forEach(function(b){b.style.background=\'transparent\';b.style.color=\'var(--text2)\';b.style.borderColor=\'var(--border)\'});this.style.background=\'var(--accent)\';this.style.color=\'#fff\';this.style.borderColor=\'var(--accent)\'" ' +
      'style="border:1px solid ' + (active?'var(--accent)':'var(--border)') + ';background:' + (active?'var(--accent)':'transparent') + ';color:' + (active?'#fff':'var(--text2)') + ';border-radius:8px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">' + r + '</button>';
  }).join('');

  var sectionKeys = [
    {key:'sectionHome',    placeholder:'HOME'},
    {key:'sectionCreate',  placeholder:'CREATE'},
    {key:'sectionManage',  placeholder:'MANAGE'},
    {key:'sectionTools',   placeholder:'TOOLS'},
    {key:'sectionAccount', placeholder:'ACCOUNT'},
  ];
  var sectionHtml = sectionKeys.map(function(s) {
    return '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">' +
      '<span style="font-size:10px;color:var(--muted);width:72px;flex-shrink:0">' + s.placeholder + '</span>' +
      '<input class="form-input" value="' + (cfg[s.key]||s.placeholder) + '" placeholder="' + s.placeholder + '" ' +
        'oninput="liveConfigDebounced(\'' + s.key + '\',this.value)" ' +
        'style="font-size:11px;padding:4px 8px;flex:1">' +
    '</div>';
  }).join('');

  return (
    // Header bar with live indicator
    '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">' +
      '<div>' +
        '<div style="font-family:var(--font-display);font-size:16px;font-weight:900">ðŸŽ¨ Real-Time App Editor</div>' +
        '<div style="font-size:11px;color:var(--muted)">Changes apply instantly to the live app and are saved permanently.</div>' +
      '</div>' +
      '<div style="display:flex;align-items:center;gap:6px;background:rgba(0,229,176,0.08);border:1px solid rgba(0,229,176,0.25);border-radius:20px;padding:5px 12px">' +
        '<div style="width:7px;height:7px;border-radius:50%;background:var(--teal);animation:pulse 2s infinite"></div>' +
        '<span style="font-size:11px;color:var(--teal);font-weight:700">Live</span>' +
      '</div>' +
    '</div>' +

    // Identity
    '<div class="card" style="margin-bottom:12px;padding:14px 16px">' +
      '<div style="font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1.5px;margin-bottom:12px">IDENTITY</div>' +
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">' +
        '<div><label style="font-size:10px;font-weight:700;color:var(--muted);display:block;margin-bottom:4px">APP NAME</label>' +
          '<input class="form-input" value="' + (cfg.appName||'TrendVid') + '" oninput="liveConfigDebounced(\'appName\',this.value)" style="font-size:12px"></div>' +
        '<div><label style="font-size:10px;font-weight:700;color:var(--muted);display:block;margin-bottom:4px">SIDEBAR TAGLINE</label>' +
          '<input class="form-input" value="' + (cfg.sidebarTagline||'AI Content Studio') + '" oninput="liveConfigDebounced(\'sidebarTagline\',this.value)" style="font-size:12px"></div>' +
      '</div>' +
    '</div>' +

    // Colours
    '<div class="card" style="margin-bottom:12px;padding:14px 16px">' +
      '<div style="font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1.5px;margin-bottom:8px">COLOURS â€” click swatch to pick</div>' +
      colorPickersHtml +
    '</div>' +

    // Border radius
    '<div class="card" style="margin-bottom:12px;padding:14px 16px">' +
      '<div style="font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1.5px;margin-bottom:10px">BORDER RADIUS</div>' +
      '<div style="display:flex;flex-wrap:wrap;gap:6px">' + radiusHtml + '</div>' +
    '</div>' +

    // Nav section labels
    '<div class="card" style="margin-bottom:12px;padding:14px 16px">' +
      '<div style="font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1.5px;margin-bottom:10px">NAV SECTION LABELS</div>' +
      sectionHtml +
    '</div>' +

    // Custom CSS
    '<div class="card" style="margin-bottom:12px;padding:14px 16px">' +
      '<div style="font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1.5px;margin-bottom:8px">CUSTOM CSS INJECTION</div>' +
      '<textarea id="customCSSEditor" class="form-input" rows="4" placeholder=".card { border-width: 2px; }" ' +
        'oninput="liveConfigDebounced(\'customCSS\',this.value)" ' +
        'style="font-size:11px;font-family:monospace;resize:vertical">' + (cfg.customCSS||'') + '</textarea>' +
    '</div>' +

    // Reset
    '<button class="btn btn-ghost" style="font-size:11px;color:var(--accent)" onclick="if(confirm(\'Reset all customisations to defaults?\')) { resetAppConfig(); window._adminTab=\'aibuilder\'; renderAdmin(); }">â†º Reset all to defaults</button>'
  );
}

// ============================================================
// APP HEALTH CHECKER
// ============================================================

async function runAppHealthCheck() {
  var btn = document.getElementById('healthCheckBtn');
  var out = document.getElementById('healthCheckOutput');
  if(btn){ btn.disabled=true; btn.innerHTML='<div class="spinner spinner-sm" style="display:inline-block;margin-right:6px"></div>Scanning...'; }
  if(out) out.innerHTML='<div class="ai-thinking"><div class="spinner"></div><span>Scanning all code, functions, and buttons...</span></div>';

  // â”€â”€ PHASE 1: Static analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  await new Promise(function(r){ setTimeout(r, 50); }); // let UI update

  var results = { checks:[], score:100, issues:[], warnings:[] };
  var _fixers = {}; // fixId â†’ function

  function addIssue(cat, msg, deduct, fixId) {
    results.issues.push({cat:cat, msg:msg, deduct:deduct, fixId:fixId||null});
    results.score = Math.max(0, results.score - deduct);
  }
  function addWarning(cat, msg, fixId) {
    results.warnings.push({cat:cat, msg:msg, fixId:fixId||null});
    results.score = Math.max(0, results.score - 1);
  }
  function addCheck(label, passed, detail, fixId) {
    results.checks.push({label:label, passed:passed, detail:detail||'', fixId:fixId||null});
  }

  // â”€â”€ Check 1: All onclick= functions exist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var allFnNames = new Set();
  // Collect all defined functions from current window
  for (var k in window) {
    try { if (typeof window[k] === 'function') allFnNames.add(k); } catch(e) {}
  }

  // Also scan all onclick attributes in the rendered sidebar
  var allButtons = document.querySelectorAll('[onclick]');
  var missingFns = [];
  var checkedFns = new Set();
  allButtons.forEach(function(el) {
    var onclick = el.getAttribute('onclick') || '';
    var fnMatch = onclick.match(/^(\w+)\(/);
    if (fnMatch) {
      var fn = fnMatch[1];
      if (!checkedFns.has(fn)) {
        checkedFns.add(fn);
        if (!allFnNames.has(fn) && !window[fn]) {
          missingFns.push(fn);
        }
      }
    }
  });

  if (missingFns.length === 0) {
    addCheck('Onclick handlers', true, 'All ' + allButtons.length + ' onclick buttons reference valid functions');
  } else {
    addCheck('Onclick handlers', false, missingFns.length + ' buttons reference undefined functions: ' + missingFns.slice(0,5).join(', '));
    missingFns.forEach(function(fn){ addIssue('Buttons', 'Undefined function: ' + fn + '()', 3); });
  }

  // â”€â”€ Check 2: localStorage keys readable â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var lsKeys = ['tv_user','tv_all_users','tv_announcements','tv_changelog','tv_scripts','tv_app_config','tv_feature_flags','tv_stripe_cfg'];
  var lsBroken = [];
  var lsBrokenKeys = [];
  lsKeys.forEach(function(k) {
    try {
      var v = localStorage.getItem(k);
      if (v && v !== 'null') JSON.parse(v); // validate JSON
    } catch(e) {
      lsBroken.push(k + ': ' + e.message);
      lsBrokenKeys.push(k);
    }
  });
  if (lsBroken.length === 0) {
    addCheck('localStorage integrity', true, 'All ' + lsKeys.length + ' critical keys are valid JSON');
  } else {
    _fixers['fix_ls_corrupt'] = function() {
      lsBrokenKeys.forEach(function(k){ try { localStorage.removeItem(k); } catch(e){} });
      notify('Cleared ' + lsBrokenKeys.length + ' corrupt localStorage key(s) â€” re-run health check', 'success', 'ðŸ”§');
      setTimeout(runAppHealthCheck, 1500);
    };
    lsBroken.forEach(function(e){ addIssue('Storage', 'Corrupt localStorage: ' + e, 5, 'fix_ls_corrupt'); });
    addCheck('localStorage integrity', false, lsBroken.join(', '), 'fix_ls_corrupt');
  }

  // â”€â”€ Check 3: AI providers configured â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var providers = [];
  try { providers = JSON.parse(localStorage.getItem('tv_ai_providers')||'[]'); } catch(e) {}
  var activeProviders = providers.filter(function(p){ return !p.paused && p.key; });
  if (activeProviders.length > 0) {
    addCheck('AI providers', true, activeProviders.length + ' active provider(s): ' + activeProviders.map(function(p){return p.name;}).join(', '));
  } else if (typeof GROQ_KEY !== 'undefined' && GROQ_KEY) {
    addCheck('AI providers', true, 'Default Groq key present');
  } else {
    _fixers['fix_ai_providers'] = function() {
      navTo('settings');
      setTimeout(function(){ notify('Add your API key in the AI Providers section below', 'info', 'ðŸ”‘'); }, 400);
    };
    addCheck('AI providers', false, 'No active AI provider â€” AI features will not work', 'fix_ai_providers');
    addIssue('Configuration', 'No AI provider configured', 10, 'fix_ai_providers');
  }

  // â”€â”€ Check 4: Critical functions defined â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var criticalFns = ['navTo','renderDashboard','renderScript','renderTrends','aiCall','notify',
    'enterAppWithUser','showLogin','generateScript','applyAppConfig','saveAppConfig','getAppConfig',
    'renderAdmin','trackUser','checkShowWhatsNew','isEarlyAccessUser'];
  var undefinedCritical = criticalFns.filter(function(fn){ return typeof window[fn] !== 'function'; });
  if (undefinedCritical.length === 0) {
    addCheck('Core functions', true, 'All ' + criticalFns.length + ' critical functions defined');
  } else {
    _fixers['fix_reload'] = function() {
      if(confirm('Reload the page to restore missing functions?')) location.reload();
    };
    addCheck('Core functions', false, 'Missing: ' + undefinedCritical.join(', '), 'fix_reload');
    undefinedCritical.forEach(function(fn){ addIssue('Core', 'Critical function missing: ' + fn, 8, 'fix_reload'); });
  }

  // â”€â”€ Check 5: Nav routing â€” all pageTitles have render fns â”€
  var pTitles = typeof pageTitles !== 'undefined' ? pageTitles : {};
  var missingRenders = [];
  Object.keys(pTitles).forEach(function(page) {
    var renderFn = 'render' + page.charAt(0).toUpperCase() + page.slice(1);
    // Some pages use different function names
    var altFn = {dashboard:'renderDashboard',script:'renderScript',trends:'renderTrends',admin:'renderAdmin'}[page];
    var fn = altFn || renderFn;
    if (typeof window[fn] !== 'function' && typeof window[renderFn] !== 'function') {
      missingRenders.push(page + ' (expects ' + renderFn + ')');
    }
  });
  if (missingRenders.length === 0) {
    addCheck('Page routing', true, 'All ' + Object.keys(pTitles).length + ' pages have render functions');
  } else if (missingRenders.length <= 3) {
    missingRenders.forEach(function(p){ addWarning('Routing', 'Page "'+p+'" may not render'); });
    addCheck('Page routing', false, missingRenders.length + ' pages may be missing renderers: ' + missingRenders.join(', '), 'fix_reload');
  } else {
    addCheck('Page routing', true, Object.keys(pTitles).length + ' pages registered (' + missingRenders.length + ' use inline routing)');
  }

  // â”€â”€ Check 6: Auth flow intact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var authFns = ['showLogin','showSignup','doAuth','logout','enterAppWithUser'];
  var missingAuth = authFns.filter(function(fn){ return typeof window[fn] !== 'function'; });
  if (missingAuth.length === 0) {
    addCheck('Auth flow', true, 'All 5 auth functions present');
  } else {
    addCheck('Auth flow', false, 'Missing auth functions: ' + missingAuth.join(', '), 'fix_reload');
    addIssue('Auth', 'Auth flow broken â€” users cannot sign in/out', 15, 'fix_reload');
  }

  // â”€â”€ Check 7: App config persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var cfgFns = ['getAppConfig','saveAppConfig','applyAppConfig','resetAppConfig','hydrateAppConfigFromStorage'];
  var missingCfg = cfgFns.filter(function(fn){ return typeof window[fn] !== 'function'; });
  if (missingCfg.length === 0) {
    addCheck('Config system', true, 'All 5 config functions present, persistent storage active');
  } else {
    addCheck('Config system', false, 'Missing: ' + missingCfg.join(', '), 'fix_reload');
    addIssue('Config', 'Config persistence broken', 5, 'fix_reload');
  }

  // â”€â”€ Check 8: window.storage available â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (window.storage && typeof window.storage.set === 'function') {
    addCheck('Persistent storage', true, 'window.storage API available â€” changes survive browser clears');
  } else {
    _fixers['fix_storage_info'] = function() {
      notify('Persistent storage requires hosting on Netlify/Vercel â€” works fine on claude.ai', 'info', 'â„¹ï¸');
    };
    addCheck('Persistent storage', false, 'window.storage not available â€” using localStorage only', 'fix_storage_info');
    addWarning('Storage', 'Changes may not persist if localStorage is cleared', 'fix_storage_info');
  }

  // â”€â”€ Check 9: Admin panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var adminFns = ['renderAdmin','adminSendBroadcast','adminToggleFlag','exportUserCSV','adminRunAIBuilder'];
  var missingAdmin = adminFns.filter(function(fn){ return typeof window[fn] !== 'function'; });
  if (missingAdmin.length === 0) {
    addCheck('Admin panel', true, 'All ' + adminFns.length + ' admin functions present');
  } else {
    addCheck('Admin panel', false, 'Missing: ' + missingAdmin.join(', '), 'fix_reload');
    missingAdmin.forEach(function(fn){ addWarning('Admin', fn + ' not defined'); });
  }

  // â”€â”€ Check 10: Early access system â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var earlyFns = ['isEarlyAccessUser','earlyAccessTabActive','adminToggleEarlyAccess','renderEarlyAccessPage'];
  var missingEarly = earlyFns.filter(function(fn){ return typeof window[fn] !== 'function'; });
  if (missingEarly.length === 0) {
    addCheck('Early access', true, 'All 4 early access functions present');
  } else {
    addCheck('Early access', false, 'Missing: ' + missingEarly.join(', '), 'fix_reload');
    missingEarly.forEach(function(fn){ addWarning('EarlyAccess', fn + ' not defined'); });
  }

  // â”€â”€ Check 11: XP / gamification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var xpFns = ['awardXP','renderXPPage','renderLeaderboard'];
  var missingXP = xpFns.filter(function(fn){ return typeof window[fn] !== 'function'; });
  if (missingXP.length === 0) {
    addCheck('XP & gamification', true, 'XP system fully wired');
  } else {
    addCheck('XP & gamification', false, 'Missing: ' + missingXP.join(', '), 'fix_reload');
    missingXP.forEach(function(fn){ addWarning('XP', fn + ' not defined'); });
  }

  // â”€â”€ Check 12: AI tools suite â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var aiToolFns = ['adminRunUserInsights','adminRunGrowthAdvisor','adminRunCopywriter','adminRunFeaturePlanner','adminRunEmailSequence','adminRunBugFixer'];
  var missingAITools = aiToolFns.filter(function(fn){ return typeof window[fn] !== 'function'; });
  if (missingAITools.length === 0) {
    addCheck('AI tools suite', true, 'All 6 AI tool functions present');
  } else {
    addCheck('AI tools suite', false, 'Missing: ' + missingAITools.join(', '), 'fix_reload');
    missingAITools.forEach(function(fn){ addWarning('AITools', fn + ' not defined'); });
  }

  // â”€â”€ Store fixers globally so onclick buttons can reach them â”€â”€
  window._healthFixers = _fixers;

  // â”€â”€ PHASE 2: AI summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var passedCount = results.checks.filter(function(c){return c.passed;}).length;
  var totalChecks = results.checks.length;
  var finalScore  = Math.max(0, Math.min(100, results.score));

  // Quick cap: if all checks pass, score can't be below 85
  if (passedCount === totalChecks && finalScore < 85) finalScore = 85;

  // Ask AI to summarise findings
  var checkSummary = results.checks.map(function(c,i){
    return (c.passed?'âœ…':'âŒ') + ' ' + c.label + ': ' + c.detail;
  }).join('\n');
  var issueSummary = results.issues.length ? results.issues.map(function(i){ return 'âŒ ['+i.cat+'] '+i.msg+' (-'+i.deduct+'pts)'; }).join('\n') : 'None';
  var warnSummary  = results.warnings.length ? results.warnings.map(function(w){ return 'âš ï¸ ['+w.cat+'] '+w.msg; }).join('\n') : 'None';

  var aiPrompt =
    'You are a senior code auditor. Summarise the health check results for TrendVid AI (a 14,000-line single-file HTML/JS SaaS app).\n\n'+
    'CHECKS ('+passedCount+'/'+totalChecks+' passed):\n'+checkSummary+'\n\n'+
    'ISSUES:\n'+issueSummary+'\n\n'+
    'WARNINGS:\n'+warnSummary+'\n\n'+
    'HEALTH SCORE: '+finalScore+'/100\n\n'+
    'Return ONLY valid raw JSON:\n'+
    '{\n'+
    '  "verdict": "one-word verdict: Excellent|Good|Fair|Poor|Critical",\n'+
    '  "summary": "2-3 sentence executive summary of the app health",\n'+
    '  "topIssue": "the single most important thing to fix (or null if none)",\n'+
    '  "strengths": ["strength 1","strength 2","strength 3"],\n'+
    '  "recommendations": ["specific actionable fix 1","fix 2","fix 3"]\n'+
    '}';

  var aiData = null;
  try {
    var raw = await aiCall([{role:'user',content:aiPrompt}], 'You are a precise code auditor. Return ONLY valid raw JSON.', 600);
    aiData = JSON.parse(raw.replace(/```json|```/g,'').trim());
  } catch(e) {
    aiData = {
      verdict: finalScore>=90?'Excellent':finalScore>=75?'Good':finalScore>=60?'Fair':'Poor',
      summary: passedCount+' of '+totalChecks+' checks passed. '+results.issues.length+' issues and '+results.warnings.length+' warnings found.',
      topIssue: results.issues.length ? results.issues[0].msg : null,
      strengths: results.checks.filter(function(c){return c.passed;}).slice(0,3).map(function(c){return c.label;}),
      recommendations: results.issues.slice(0,3).map(function(i){return i.msg;})
    };
  }

  // â”€â”€ Render results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var scoreColor = finalScore>=90?'var(--teal)':finalScore>=75?'var(--gold)':finalScore>=60?'#ff7b00':'var(--accent)';
  var verdictColor = {Excellent:'var(--teal)',Good:'var(--teal)',Fair:'var(--gold)',Poor:'var(--accent)',Critical:'var(--accent)'}[aiData.verdict]||'var(--muted)';

  // Donut-style score ring via SVG
  var circumference = 2 * Math.PI * 40; // r=40
  var dash = (finalScore / 100) * circumference;

  // Snapshot for Fix All button closures
  window._healthIssuesSnap = results.issues.slice();

  var checkRows = results.checks.map(function(c) {
    var fixBtn = (!c.passed && c.fixId) ? '<button onclick="if(window._healthFixers&&window._healthFixers[\''+c.fixId+'\'])window._healthFixers[\''+c.fixId+'\']();" style="margin-top:5px;padding:3px 10px;font-size:10px;font-weight:700;background:rgba(255,48,88,0.12);color:var(--accent);border:1px solid rgba(255,48,88,0.3);border-radius:6px;cursor:pointer;transition:background 0.15s" onmouseover="this.style.background=\'rgba(255,48,88,0.25)\'" onmouseout="this.style.background=\'rgba(255,48,88,0.12)\'">ðŸ”§ Fix</button>' : '';
    return '<div style="display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">' +
      '<span style="font-size:14px;flex-shrink:0;margin-top:1px">' + (c.passed?'âœ…':'âŒ') + '</span>' +
      '<div style="flex:1;min-width:0">' +
        '<div style="font-size:12px;font-weight:700;color:' + (c.passed?'var(--text)':'var(--accent)') + '">' + c.label + '</div>' +
        '<div style="font-size:11px;color:var(--muted);line-height:1.4">' + c.detail + '</div>' +
        fixBtn +
      '</div>' +
    '</div>';
  }).join('');

  var issueRows = results.issues.length === 0
    ? '<div style="font-size:12px;color:var(--teal);padding:8px 0">No issues found ðŸŽ‰</div>'
    : results.issues.map(function(i) {
        var fixBtn = i.fixId ? '<button onclick="if(window._healthFixers&&window._healthFixers[\''+i.fixId+'\'])window._healthFixers[\''+i.fixId+'\']();" style="margin-left:6px;padding:2px 9px;font-size:10px;font-weight:700;background:rgba(255,48,88,0.12);color:var(--accent);border:1px solid rgba(255,48,88,0.3);border-radius:6px;cursor:pointer" onmouseover="this.style.background=\'rgba(255,48,88,0.25)\'" onmouseout="this.style.background=\'rgba(255,48,88,0.12)\'">ðŸ”§ Fix</button>' : '';
        return '<div style="display:flex;align-items:flex-start;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)">' +
          '<span style="font-size:11px;font-weight:900;color:var(--accent);background:rgba(255,48,88,0.1);padding:2px 7px;border-radius:6px;flex-shrink:0;margin-top:1px">-'+i.deduct+'</span>' +
          '<div style="flex:1"><div style="font-size:11px;font-weight:700;color:var(--accent);display:flex;align-items:center;flex-wrap:wrap;gap:4px">' + i.msg + fixBtn + '</div>' +
          '<div style="font-size:10px;color:var(--muted)">' + i.cat + '</div></div>' +
        '</div>';
      }).join('');

  var warnRows = results.warnings.length === 0
    ? '<div style="font-size:12px;color:var(--teal);padding:8px 0">No warnings ðŸŽ‰</div>'
    : results.warnings.map(function(w) {
        var fixBtn = w.fixId ? '<button onclick="if(window._healthFixers&&window._healthFixers[\''+w.fixId+'\'])window._healthFixers[\''+w.fixId+'\']();" style="margin-left:6px;padding:2px 9px;font-size:10px;font-weight:700;background:rgba(251,191,36,0.12);color:var(--gold);border:1px solid rgba(251,191,36,0.3);border-radius:6px;cursor:pointer" onmouseover="this.style.background=\'rgba(251,191,36,0.25)\'" onmouseout="this.style.background=\'rgba(251,191,36,0.12)\'">ðŸ”§ Fix</button>' : '';
        return '<div style="font-size:11px;color:var(--gold);padding:5px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;flex-wrap:wrap;gap:4px">âš ï¸ ' + w.msg + fixBtn + '</div>';
      }).join('');

  var recsHtml = (aiData.recommendations||[]).map(function(r,i) {
    return '<div style="display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">' +
      '<div style="width:20px;height:20px;border-radius:6px;background:rgba(0,229,176,0.12);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;color:var(--teal);flex-shrink:0">' + (i+1) + '</div>' +
      '<div style="font-size:12px;color:var(--text2);line-height:1.5">' + r + '</div>' +
    '</div>';
  }).join('');

  var strengthsHtml = (aiData.strengths||[]).map(function(s) {
    return '<div style="font-size:11px;color:var(--teal);padding:4px 0;border-bottom:1px solid var(--border)">âœ“ ' + s + '</div>';
  }).join('');

  if(out) out.innerHTML =
    // Score card
    '<div class="card" style="margin-bottom:14px;padding:20px;background:linear-gradient(135deg,rgba(0,0,0,0.2),rgba(0,0,0,0.1));border-color:' + scoreColor.replace(')',',0.4)').replace('var(--','rgba(').replace('teal','0,229,176').replace('gold','251,191,36').replace('accent','255,48,88') + '">' +
      '<div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap">' +
        // SVG ring
        '<div style="position:relative;width:100px;height:100px;flex-shrink:0">' +
          '<svg width="100" height="100" viewBox="0 0 100 100" style="transform:rotate(-90deg)">' +
            '<circle cx="50" cy="50" r="40" fill="none" stroke="var(--border)" stroke-width="10"/>' +
            '<circle cx="50" cy="50" r="40" fill="none" stroke="' + scoreColor + '" stroke-width="10" ' +
              'stroke-dasharray="' + dash.toFixed(1) + ' ' + circumference.toFixed(1) + '" stroke-linecap="round"/>' +
          '</svg>' +
          '<div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center">' +
            '<div style="font-size:26px;font-weight:900;font-family:var(--font-display);color:' + scoreColor + ';line-height:1">' + finalScore + '</div>' +
            '<div style="font-size:9px;color:var(--muted);font-weight:700">/100</div>' +
          '</div>' +
        '</div>' +
        '<div style="flex:1;min-width:200px">' +
          '<div style="font-size:22px;font-weight:900;font-family:var(--font-display);color:' + verdictColor + ';margin-bottom:4px">' + (aiData.verdict||'') + '</div>' +
          '<div style="font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:10px">' + (aiData.summary||'') + '</div>' +
          '<div style="display:flex;gap:8px;flex-wrap:wrap">' +
            '<span style="font-size:11px;background:rgba(0,229,176,0.1);color:var(--teal);padding:3px 10px;border-radius:8px;font-weight:700">' + passedCount + '/' + totalChecks + ' checks passed</span>' +
            (results.issues.length?'<span style="font-size:11px;background:rgba(255,48,88,0.1);color:var(--accent);padding:3px 10px;border-radius:8px;font-weight:700">' + results.issues.length + ' issue' + (results.issues.length!==1?'s':'') + '</span>':'') +
            (results.warnings.length?'<span style="font-size:11px;background:rgba(251,191,36,0.1);color:var(--gold);padding:3px 10px;border-radius:8px;font-weight:700">' + results.warnings.length + ' warning' + (results.warnings.length!==1?'s':'') + '</span>':'') +
          '</div>' +
        '</div>' +
      '</div>' +
      (aiData.topIssue?'<div style="margin-top:14px;padding:10px 14px;background:rgba(255,48,88,0.07);border:1px solid rgba(255,48,88,0.25);border-radius:10px;font-size:12px;color:var(--accent)">ðŸš¨ <strong>Top priority:</strong> ' + aiData.topIssue + '</div>':'') +
    '</div>' +

    // Three columns
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">' +
      '<div class="card" style="padding:14px 16px">' +
        '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">' +
          '<div style="font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1.5px">ISSUES (' + results.issues.length + ')</div>' +
          (results.issues.some(function(i){return i.fixId;}) ? '<button onclick="var fs=window._healthFixers||{};var snap=window._healthIssuesSnap||[];var done=new Set();snap.forEach(function(i){if(i.fixId&&!done.has(i.fixId)&&fs[i.fixId]){done.add(i.fixId);fs[i.fixId]();}});" style="padding:3px 10px;font-size:10px;font-weight:700;background:rgba(255,48,88,0.12);color:var(--accent);border:1px solid rgba(255,48,88,0.3);border-radius:6px;cursor:pointer">ðŸ”§ Fix All</button>' : '') +
        '</div>' +
        issueRows +
      '</div>' +
      '<div class="card" style="padding:14px 16px">' +
        '<div style="font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1.5px;margin-bottom:10px">WARNINGS (' + results.warnings.length + ')</div>' +
        warnRows +
        '<div style="font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1.5px;margin-top:14px;margin-bottom:8px">STRENGTHS</div>' +
        strengthsHtml +
      '</div>' +
    '</div>' +

    // All checks
    '<div class="card" style="margin-bottom:12px;padding:14px 16px">' +
      '<div style="font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1.5px;margin-bottom:10px">ALL CHECKS (' + totalChecks + ')</div>' +
      checkRows +
    '</div>' +

    // Recommendations
    '<div class="card" style="padding:14px 16px">' +
      '<div style="font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1.5px;margin-bottom:10px">AI RECOMMENDATIONS</div>' +
      recsHtml +
    '</div>';

  if(btn){ btn.disabled=false; btn.innerHTML='ðŸ” Run Health Check'; }
  notify('Health check complete â€” score: ' + finalScore + '/100', finalScore>=80?'success':'error', finalScore>=80?'done':'x');
}

function _adminHealthCheckerContent() {
  return '<div style="font-family:var(--font-display);font-size:16px;font-weight:900;margin-bottom:4px">ðŸ” App Health Checker</div>' +
    '<div style="font-size:12px;color:var(--muted);margin-bottom:16px">Scans all functions, onclick handlers, localStorage integrity, routing, auth, and AI config â€” then gives a health score out of 100.</div>' +
    '<div class="card" style="margin-bottom:16px;padding:14px 16px;background:rgba(99,102,241,0.04);border-color:rgba(99,102,241,0.25)">' +
      '<div style="font-size:11px;color:var(--text2);margin-bottom:10px;line-height:1.6">' +
        'âœ… Verifies all onclick buttons call real functions<br>' +
        'âœ… Validates localStorage JSON integrity<br>' +
        'âœ… Checks all 16 critical functions exist<br>' +
        'âœ… Confirms auth, routing, config, XP, early access, AI tools<br>' +
        'âœ… AI writes an executive summary and prioritised fix list' +
      '</div>' +
      '<button class="btn btn-primary" id="healthCheckBtn" onclick="runAppHealthCheck()" style="width:100%">ðŸ” Run Health Check</button>' +
    '</div>' +
    '<div id="healthCheckOutput"></div>';
}



function renderAdmin() {
  if(!currentUser || !currentUser.isAdmin) { notify('Admin access required','error','ðŸ”'); return; }
  var pc = document.getElementById('pageContent');
  if(!pc) return;
  var tab = window._adminTab || 'overview';
  var users = []; try { users = JSON.parse(localStorage.getItem('tv_all_users')||'[]'); } catch(e) {}
  var reports = []; try { reports = JSON.parse(localStorage.getItem('tv_reports')||'[]'); } catch(e) {}
  var gifts = []; try { gifts = JSON.parse(localStorage.getItem('tv_gifts')||'[]'); } catch(e) {}
  var prices = {}; try { prices = JSON.parse(localStorage.getItem('tv_custom_prices')||'{}'); } catch(e) {}
  var announcements = []; try { announcements = JSON.parse(localStorage.getItem('tv_announcements')||'[]'); } catch(e) {}
  var notes = ''; try { notes = localStorage.getItem('tv_admin_notes')||''; } catch(e) {}
  var actLog = []; try { actLog = JSON.parse(localStorage.getItem('tv_activity_log')||'[]'); } catch(e) {}
  var flags = {}; try { flags = JSON.parse(localStorage.getItem('tv_feature_flags')||'{}'); } catch(e) {}
  var appCfg = {}; try { appCfg = JSON.parse(localStorage.getItem('tv_app_config')||'{}'); } catch(e) {}

  var planPrices = {free:0,starter:9,pro:19,gold:39,elite:79};
  var totalMRR = users.reduce(function(s,u){return s+(planPrices[u.plan]||0);},0);
  var paidUsers = users.filter(function(u){return u.plan!=='free';}).length;
  var weeklyOptins = users.filter(function(u){return u.weeklyReports!==false;}).length;

  // Tab definitions with icons and groups
  var tabGroups = [
    { label:'ANALYTICS', items:[
      {id:'overview',  icon:'ðŸ“Š', label:'Overview'},
      {id:'users',     icon:'ðŸ‘¥', label:'Users'},
      {id:'activity',  icon:'ðŸ“‹', label:'Activity Log'},
      {id:'revenue',   icon:'ðŸ’·', label:'Revenue'},
      {id:'nps',       icon:'ðŸŽ¯', label:'NPS Scores'},
    ]},
    { label:'CONTENT', items:[
      {id:'messages',  icon:'âœ‰ï¸',  label:'Messages', badge: (function(){var m=[];try{m=JSON.parse(localStorage.getItem('tv_admin_messages')||'[]');}catch(e){}return m.filter(function(x){return !x.read;}).length||0;})()},
      {id:'broadcast', icon:'ðŸ“¢', label:'Broadcast'},
      {id:'weekly',    icon:'ðŸ“§', label:'Weekly Emails'},
      {id:'codes',     icon:'ðŸŽ', label:'Gift Codes'},
      {id:'reports',   icon:'ðŸ›', label:'Bug Reports', badge: reports.length > 0 ? reports.length : 0},
    ]},
    { label:'SYSTEM', items:[
      {id:'ai',        icon:'ðŸ¤–', label:'AI Providers'},
      {id:'flags',     icon:'ðŸš©', label:'Feature Flags'},
      {id:'config',    icon:'âš™ï¸',  label:'App Config'},
      {id:'prices',    icon:'ðŸ’·', label:'Pricing'},
      {id:'stripe',    icon:'ðŸ’³', label:'Stripe'},
      {id:'seclog',    icon:'ðŸ”', label:'Security Log'},
      {id:'autoupload', icon:'ðŸ“¤', label:'Auto-Upload'},
      {id:'apikeys',    icon:'ðŸ”‘', label:'API Keys'},
      {id:'selfheal',   icon:'ðŸ¤–', label:'Self-Heal', badge:(function(){ var tf=0; try{tf=parseInt(localStorage.getItem('tv_selfheal_total_fixed')||'0');}catch(e){} return tf>0?tf:0;})()},
    ]},
    { label:'MISC', items:[
      {id:'credits',   icon:'ðŸ’°', label:'Credits'},
      {id:'changelog', icon:'ðŸ“', label:'Changelog'},
      {id:'notes',     icon:'ðŸ—’ï¸',  label:'Admin Notes'},
    ]},
    { label:'UPDATES', items:[
      {id:'releasemanager', icon:'ðŸš€', label:'Release Manager'},
      {id:'aibuilder',      icon:'ðŸ¤–', label:'AI App Builder'},
      {id:'aitools',        icon:'ðŸ› ï¸', label:'AI Tools Suite'},
      {id:'health',         icon:'ðŸ”', label:'Health Checker'},
    ]},
    { label:'PROMO STUDIO', items:[
      {id:'promovid',  icon:'ðŸŽ¬', label:'Promo Videos'},
    ]},
    { label:'CREATORS', items:[
      {id:'xp',            icon:'â­', label:'XP Manager'},
      {id:'levels',        icon:'ðŸ…', label:'Levels'},
      {id:'notifications', icon:'ðŸ””', label:'Alerts', badge:(function(){var n=[];try{n=JSON.parse(localStorage.getItem('tv_admin_notifs')||'[]');}catch(e){}return n.filter(function(x){return !x.read;}).length||0;})()},
    ]},
  ];

  // Build sidebar HTML
  var sidebarHTML = '<div style="flex-shrink:0;width:200px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;min-height:0;overflow-y:auto;border-radius:var(--radius) 0 0 var(--radius);">';
  sidebarHTML += '<div style="padding:16px 14px 12px;border-bottom:1px solid var(--border);flex-shrink:0;">';
  sidebarHTML += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:2px"><span style="font-size:18px">ðŸ›¡ï¸</span><span style="font-family:var(--font-display);font-size:15px;font-weight:800;letter-spacing:1px;color:var(--gold);flex:1">ADMIN</span><button onclick="navTo(\'dashboard\')" title="Close Admin Panel" style="background:rgba(255,48,88,0.1);border:1px solid rgba(255,48,88,0.3);color:var(--accent);border-radius:8px;padding:3px 8px;font-size:12px;font-weight:700;cursor:pointer;line-height:1;transition:all 0.15s;" onmouseover="this.style.background=\'rgba(255,48,88,0.22)\'" onmouseout="this.style.background=\'rgba(255,48,88,0.1)\'">âœ•</button></div>';
  sidebarHTML += '<div style="font-size:10px;color:var(--muted)">'+users.length+' users Â· Â£'+totalMRR+'/mo MRR</div>';
  sidebarHTML += '</div>';
  sidebarHTML += '<div style="padding:8px 8px;flex:1;">';

  tabGroups.forEach(function(group) {
    sidebarHTML += '<div style="font-size:8px;font-weight:900;letter-spacing:2px;color:var(--muted);padding:10px 8px 4px;text-transform:uppercase;font-family:var(--font-display);">'+group.label+'</div>';
    group.items.forEach(function(item) {
      var isActive = tab === item.id;
      var badgeHtml = item.badge ? '<span style="margin-left:auto;background:var(--accent);color:#fff;font-size:8px;font-weight:900;padding:1px 6px;border-radius:8px;">'+item.badge+'</span>' : '';
      sidebarHTML += '<button onclick="window._adminTab=\''+item.id+'\';renderAdmin()" style="width:100%;display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:9px;font-size:12px;font-weight:'+(isActive?'700':'600')+';cursor:pointer;border:none;text-align:left;transition:all 0.15s;background:'+(isActive?'linear-gradient(90deg,rgba(251,191,36,0.15),rgba(251,191,36,0.05))':'transparent')+';color:'+(isActive?'var(--gold)':'var(--text2)')+';border-left:'+(isActive?'2px solid var(--gold)':'2px solid transparent')+';">'+
        '<span style="font-size:14px;width:18px;text-align:center;flex-shrink:0">'+item.icon+'</span>'+
        '<span style="flex:1">'+item.label+'</span>'+
        badgeHtml+
      '</button>';
    });
  });

  sidebarHTML += '</div></div>'; // end sidebar

  // â”€â”€ TAB CONTENT â”€â”€
  var content = '';

  // â”€â”€ OVERVIEW â”€â”€
  if(tab==='overview') {
    var planDist = {free:0,starter:0,pro:0,gold:0,elite:0};
    users.forEach(function(u){if(planDist[u.plan]!==undefined)planDist[u.plan]++;});
    var convRate = users.length>0 ? Math.round((paidUsers/users.length)*100) : 0;
    content =
      '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px">'+
        adminStat('ðŸ’· MRR','Â£'+totalMRR,'var(--teal)')+
        adminStat('ðŸ‘¥ Users',users.length,'var(--accent)')+
        adminStat('ðŸ’Ž Paid',paidUsers,'var(--gold)')+
        adminStat('ðŸ“ˆ Conv.',convRate+'%','var(--purple)')+
      '</div>'+
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">'+
        '<div class="card"><div style="font-size:12px;font-weight:800;margin-bottom:14px;font-family:var(--font-display);letter-spacing:0.5px;color:var(--text2)">PLAN DISTRIBUTION</div>'+
          Object.entries(planDist).map(function(e){
            var pct = Math.round((e[1]/Math.max(users.length,1))*100);
            var col = {free:'var(--muted)',starter:'var(--teal)',pro:'var(--accent)',gold:'var(--gold)',elite:'var(--elite)'}[e[0]]||'var(--muted)';
            return '<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px"><span style="font-weight:600">'+e[0].charAt(0).toUpperCase()+e[0].slice(1)+'</span><span style="color:var(--muted)">'+e[1]+' ('+pct+'%)</span></div>'+
              '<div style="height:6px;background:var(--border);border-radius:3px"><div style="width:'+pct+'%;height:100%;background:'+col+';border-radius:3px;transition:width 0.6s ease"></div></div></div>';
          }).join('')+
        '</div>'+
        '<div class="card"><div style="font-size:12px;font-weight:800;margin-bottom:14px;font-family:var(--font-display);letter-spacing:0.5px;color:var(--text2)">RECENT SIGNUPS</div>'+
          (users.length===0?'<div style="color:var(--muted);font-size:13px;text-align:center;padding:20px">No users yet</div>':
          users.slice(0,5).map(function(u){
            return '<div style="display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border)">'+
              '<div><div style="font-size:12px;font-weight:600">'+(u.name||'â€”')+'</div><div style="font-size:10px;color:var(--muted)">'+u.email+'</div></div>'+
              '<span class="tier-badge tier-'+(u.plan||'free')+'" style="font-size:9px">'+(u.plan||'free').toUpperCase()+'</span>'+
            '</div>';
          }).join(''))+
        '</div>'+
      '</div>'+
      '<div class="card"><div style="font-size:12px;font-weight:800;margin-bottom:12px;font-family:var(--font-display);letter-spacing:0.5px;color:var(--text2)">QUICK ACTIONS</div>'+
        '<div style="display:flex;gap:8px;flex-wrap:wrap">'+
          '<button class="btn btn-ghost btn-sm" onclick="window._adminTab=\&quot;users\&quot;;renderAdmin()">ðŸ‘¥ Manage Users</button>'+
          '<button class="btn btn-ghost btn-sm" onclick="window._adminTab=\&quot;codes\&quot;;renderAdmin()">ðŸŽ Generate Code</button>'+
          '<button class="btn btn-ghost btn-sm" onclick="window._adminTab=\&quot;broadcast\&quot;;renderAdmin()">ðŸ“¢ Broadcast</button>'+
          '<button class="btn btn-ghost btn-sm" onclick="window._adminTab=\&quot;flags\&quot;;renderAdmin()">ðŸš© Feature Flags</button>'+
          '<button class="btn btn-ghost btn-sm" onclick="exportUserCSV()">â¬‡ï¸ Export CSV</button>'+
          '<button class="btn btn-ghost btn-sm" onclick="window._adminTab=\&quot;activity\&quot;;renderAdmin()">ðŸ“‹ Activity Log</button>'+
        '</div>'+
      '</div>';
  }

  // â”€â”€ USERS â”€â”€
  if(tab==='users') {
    var filterPlan = window._adminUserFilter||'all';
    var searchQ = window._adminUserSearch||'';
    var filtered = users.filter(function(u){
      var matchPlan = filterPlan==='all' || u.plan===filterPlan;
      var matchSearch = !searchQ || (u.email||'').toLowerCase().includes(searchQ) || (u.name||'').toLowerCase().includes(searchQ);
      return matchPlan && matchSearch;
    });
    var filterBtns = ['all','free','starter','pro','gold','elite'].map(function(p){
      return '<button class="btn btn-sm '+(filterPlan===p?'btn-primary':'btn-ghost')+'" style="border-radius:8px;font-size:11px" onclick="window._adminUserFilter=\''+p+'\';renderAdmin()">'+p.charAt(0).toUpperCase()+p.slice(1)+'</button>';
    }).join('');
    var rows = filtered.length===0 ? '<tr><td colspan="8" style="padding:20px;text-align:center;color:var(--muted)">No users found</td></tr>' :
      filtered.map(function(u){
        var monthly = planPrices[u.plan]||0;
        var paid = monthly>0?'Â£'+monthly+'/mo':'Free';
        var ago = adminTimeAgo(u.lastLogin||u.joinedAt||Date.now());
        var joined = u.joinedAt ? new Date(u.joinedAt).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'2-digit'}) : 'â€”';
        return '<tr style="border-bottom:1px solid var(--border)" onmouseover="this.style.background=\'var(--surface2)\'" onmouseout="this.style.background=\'\'">'+
          '<td style="padding:9px 10px;font-size:12px;font-weight:600">'+(u.name||'â€”')+'</td>'+
          '<td style="padding:9px 10px;font-size:11px;color:var(--muted)">'+u.email+'</td>'+
          '<td style="padding:9px 10px"><span class="tier-badge tier-'+(u.plan||'free')+'">'+(u.plan||'free').toUpperCase()+'</span></td>'+
          '<td style="padding:9px 10px;font-size:12px;color:var(--teal);font-weight:700">'+paid+'</td>'+
          '<td style="padding:9px 10px;font-size:11px;color:'+(u.weeklyReports===false?'var(--muted)':'var(--teal)')+'">'+
            (u.weeklyReports===false?'âŒ':'âœ…')+'</td>'+
          '<td style="padding:9px 10px;font-size:11px;color:var(--muted)">'+joined+'</td>'+
          '<td style="padding:9px 10px;font-size:11px;color:var(--muted)">'+ago+'</td>'+
          '<td style="padding:9px 10px;white-space:nowrap">'+
            '<select onchange="adminChangePlanInline(\''+u.email+'\',this.value)" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);font-size:10px;padding:3px 6px;border-radius:6px;cursor:pointer;margin-right:4px">'+
              '<option value="">Change...</option>'+
              ['free','starter','pro','gold','elite'].map(function(p){return '<option value="'+p+'"'+(u.plan===p?' selected':'')+'>'+p+'</option>';}).join('')+
            '</select>'+
            '<button class="btn btn-ghost btn-sm" style="font-size:10px;color:' + (u.earlyAccess?'var(--teal)':'var(--muted)') + '" onclick="adminToggleEarlyAccess(\'' + u.email + '\')">&#x26A1;</button>'+
            '<button class="btn btn-ghost btn-sm" style="font-size:10px;color:var(--accent)" onclick="adminRemoveUser(\&quot;&quot;+u.email+&quot;\&quot;)">&#x1F5D1;&#xFE0F;</button>'+
          '</td>'+
        '</tr>';
      }).join('');
    content =
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">'+
        '<div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">'+
          '<input id="adminSearchInput" placeholder="Search name or email..." value="'+searchQ+'" oninput="window._adminUserSearch=this.value;renderAdmin()" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:7px 12px;border-radius:9px;font-size:12px;outline:none;width:220px">'+
          filterBtns+
        '</div>'+
        '<div style="display:flex;gap:6px">'+
          '<button class="btn btn-ghost btn-sm" onclick="exportUserCSV()">â¬‡ï¸ Export CSV</button>'+
          '<span style="font-size:12px;color:var(--muted);align-self:center">'+filtered.length+' of '+users.length+'</span>'+
        '</div>'+
      '</div>'+
      '<div style="overflow-x:auto;border-radius:var(--radius-sm);border:1px solid var(--border)">'+
        '<table style="width:100%;border-collapse:collapse;font-size:12px">'+
          '<thead><tr style="background:var(--surface2);border-bottom:1px solid var(--border)">'+
            '<th style="padding:9px 10px;text-align:left;font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1px;font-family:var(--font-display)">NAME</th>'+
            '<th style="padding:9px 10px;text-align:left;font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1px;font-family:var(--font-display)">EMAIL</th>'+
            '<th style="padding:9px 10px;text-align:left;font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1px;font-family:var(--font-display)">PLAN</th>'+
            '<th style="padding:9px 10px;text-align:left;font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1px;font-family:var(--font-display)">VALUE</th>'+
            '<th style="padding:9px 10px;text-align:left;font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1px;font-family:var(--font-display)">WEEKLY</th>'+
            '<th style="padding:9px 10px;text-align:left;font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1px;font-family:var(--font-display)">JOINED</th>'+
            '<th style="padding:9px 10px;text-align:left;font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1px;font-family:var(--font-display)">LAST SEEN</th>'+
            '<th style="padding:9px 10px;text-align:left;font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1px;font-family:var(--font-display)">ACTIONS</th>'+
          '</tr></thead>'+
          '<tbody>'+rows+'</tbody>'+
        '</table>'+
      '</div>';
  }

  // â”€â”€ ACTIVITY LOG â”€â”€
  if(tab==='activity') {
    // Gather activity from scripts, logins, signups stored in localStorage
    var allActivity = actLog.slice(0,100);
    var logRows = allActivity.length===0
      ? '<div style="padding:30px;text-align:center;color:var(--muted)">No activity recorded yet. Actions by users will appear here.</div>'
      : allActivity.map(function(a){
          return '<div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)">'+
            '<div style="width:34px;height:34px;border-radius:9px;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0">'+(a.icon||'ðŸ“Œ')+'</div>'+
            '<div style="flex:1;min-width:0">'+
              '<div style="font-size:12px;font-weight:600">'+(a.user||'Unknown')+'</div>'+
              '<div style="font-size:11px;color:var(--muted)">'+(a.action||'â€”')+'</div>'+
            '</div>'+
            '<div style="font-size:10px;color:var(--muted);text-align:right;flex-shrink:0">'+adminTimeAgo(a.at)+'</div>'+
          '</div>';
        }).join('');
    content =
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">'+
        '<div><div style="font-size:14px;font-weight:800">Activity Log</div><div style="font-size:12px;color:var(--muted)">Last 100 user actions across the platform</div></div>'+
        '<button class="btn btn-ghost btn-sm" onclick="if(confirm(\&quot;Clear log?\&quot;)){localStorage.removeItem(\&quot;tv_activity_log\&quot;);renderAdmin();}">ðŸ—‘ï¸ Clear Log</button>'+
      '</div>'+
      '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px">'+
        adminStat('ðŸ“‹ Events',actLog.length,'var(--teal)')+
        adminStat('ðŸ‘¥ Users',users.length,'var(--accent)')+
        adminStat('âœï¸ Scripts',actLog.filter(function(a){return a.type==='script';}).length,'var(--gold)')+
        adminStat('ðŸ” Logins',actLog.filter(function(a){return a.type==='login';}).length,'var(--purple)')+
      '</div>'+
      '<div class="card">'+logRows+'</div>';
  }

  // â”€â”€ REVENUE â”€â”€
  if(tab==='revenue') {
    var planPricesFull = {free:{monthly:0,annual:0},starter:{monthly:9,annual:86},pro:{monthly:19,annual:182},gold:{monthly:39,annual:374},elite:{monthly:79,annual:758}};
    var planCounts = {free:0,starter:0,pro:0,gold:0,elite:0};
    users.forEach(function(u){if(planCounts[u.plan]!==undefined)planCounts[u.plan]++;});
    var annualMRR = users.reduce(function(s,u){return s+((planPricesFull[u.plan]||{}).monthly||0);},0);
    var projectedARR = annualMRR * 12;
    content =
      '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px">'+
        adminStat('ðŸ’· MRR','Â£'+annualMRR,'var(--teal)')+
        adminStat('ðŸ“† Proj. ARR','Â£'+projectedARR,'var(--gold)')+
        adminStat('ðŸ’Ž Paid Users',paidUsers,'var(--accent)')+
        adminStat('ðŸ“Š ARPU',paidUsers>0?'Â£'+Math.round(annualMRR/paidUsers):'â€”','var(--purple)')+
      '</div>'+
      '<div class="card" style="margin-bottom:14px">'+
        '<div style="font-size:12px;font-weight:800;margin-bottom:14px;font-family:var(--font-display);letter-spacing:0.5px;color:var(--text2)">REVENUE BY PLAN</div>'+
        Object.entries(planPricesFull).map(function(e){
          var count = planCounts[e[0]]||0;
          var mrr = count * e[1].monthly;
          var pct = projectedARR>0 ? Math.round((mrr*12/projectedARR)*100) : 0;
          var col = {free:'var(--muted)',starter:'var(--teal)',pro:'var(--accent)',gold:'var(--gold)',elite:'var(--elite)'}[e[0]]||'var(--muted)';
          return '<div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)">'+
            '<div style="width:80px;font-size:12px;font-weight:700;color:'+col+'">'+e[0].toUpperCase()+'</div>'+
            '<div style="flex:1"><div style="height:7px;background:var(--border);border-radius:4px"><div style="width:'+pct+'%;height:100%;background:'+col+';border-radius:4px;transition:width 0.6s ease"></div></div></div>'+
            '<div style="width:50px;text-align:right;font-size:12px;color:var(--muted)">'+count+' users</div>'+
            '<div style="width:70px;text-align:right;font-size:12px;font-weight:700;color:var(--text)">Â£'+mrr+'/mo</div>'+
          '</div>';
        }).join('')+
      '</div>'+
      '<div class="card">'+
        '<div style="font-size:12px;font-weight:800;margin-bottom:10px;font-family:var(--font-display);letter-spacing:0.5px;color:var(--text2)">REVENUE INSIGHTS</div>'+
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:13px;color:var(--text2);line-height:1.6">'+
          '<div style="background:rgba(0,229,176,0.05);border:1px solid rgba(0,229,176,0.2);border-radius:10px;padding:14px">ðŸ“ˆ <strong>To double MRR:</strong> Convert '+Math.ceil(users.filter(function(u){return u.plan==='free';}).length*0.1)+' free users to Starter.</div>'+
          '<div style="background:rgba(255,48,88,0.05);border:1px solid rgba(255,48,88,0.2);border-radius:10px;padding:14px">ðŸŽ¯ <strong>Best upsell target:</strong> Starter users â†’ Pro (Â£10 more/mo).</div>'+
        '</div>'+
      '</div>';
  }

  // â”€â”€ FEATURE FLAGS â”€â”€
  if(tab==='flags') {
    var defaultFlags = [
      {id:'ai_chat',       label:'AI Chat (Help page)',        desc:'Enable the TrendVid AI chat assistant'},
      {id:'viral_score',   label:'Viral Score Tool',           desc:'Show viral potential scorer in nav'},
      {id:'competitor',    label:'Competitor Analysis',        desc:'Enable competitor analysis on Trend Radar'},
      {id:'ab_tester',     label:'A/B Title Tester',           desc:'Enable A/B title testing for Pro+'},
      {id:'multilang',     label:'Multi-Language Tool',        desc:'Enable script translation feature'},
      {id:'teleprompter',  label:'Teleprompter Mode',          desc:'Enable the teleprompter feature'},
      {id:'bundle_deals',  label:'Bundle Deals Page',          desc:'Show bundle deals in sidebar'},
      {id:'gift_codes',    label:'Gift Code Redemption',       desc:'Allow users to redeem gift codes'},
      {id:'weekly_email',  label:'Weekly Email Reports',       desc:'Send weekly performance reports'},
      {id:'pay_per_script',label:'Pay-per-Script (Free)',      desc:'Charge free users per script via credits'},
      {id:'signup_open',   label:'Open Signups',               desc:'Allow new user registrations'},
      {id:'maintenance',   label:'Maintenance Mode',           desc:'Show maintenance banner to all users'},
    ];
    content =
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">'+
        '<div><div style="font-size:14px;font-weight:800">Feature Flags</div><div style="font-size:12px;color:var(--muted)">Toggle features without redeploying</div></div>'+
        '<button class="btn btn-ghost btn-sm" onclick="resetFeatureFlags()">â†º Reset All</button>'+
      '</div>'+
      '<div style="display:flex;flex-direction:column;gap:8px">'+
        defaultFlags.map(function(f){
          var isOn = flags[f.id] !== false; // default on
          return '<div class="card" style="display:flex;align-items:center;gap:14px;padding:14px 16px;">'+
            '<div style="flex:1">'+
              '<div style="font-size:13px;font-weight:700;">'+f.label+'</div>'+
              '<div style="font-size:11px;color:var(--muted);">'+f.desc+'</div>'+
            '</div>'+
            '<div style="display:flex;align-items:center;gap:8px">'+
              '<span style="font-size:10px;font-weight:700;color:'+(isOn?'var(--teal)':'var(--muted)')+'">'+( isOn?'ON':'OFF')+'</span>'+
              '<button class="toggle'+(isOn?' on':'')+'" onclick="adminToggleFlag(\&quot;&quot;+f.id+&quot;\&quot;,&quot;+(!isOn)+&quot;)"></button>'+
            '</div>'+
          '</div>';
        }).join('')+
      '</div>';
  }

  // â”€â”€ APP CONFIG â”€â”€
  if(tab==='config') {
    content =
      '<div style="font-size:14px;font-weight:800;margin-bottom:16px">App Configuration</div>'+
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">'+
        '<div class="card">'+
          '<div style="font-size:12px;font-weight:800;margin-bottom:14px;color:var(--text2);font-family:var(--font-display);letter-spacing:0.5px;">GENERAL</div>'+
          '<div class="form-field"><label>App Name</label><input class="form-input" id="cfg_appName" value="'+(appCfg.appName||'TrendVid AI')+'" placeholder="TrendVid AI"></div>'+
          '<div class="form-field"><label>Tagline</label><input class="form-input" id="cfg_tagline" value="'+(appCfg.tagline||'AI Content Studio')+'" placeholder="AI Content Studio"></div>'+
          '<div class="form-field"><label>Support Email</label><input class="form-input" id="cfg_supportEmail" value="'+(appCfg.supportEmail||'')+'" placeholder="support@trendvid.ai" type="email"></div>'+
          '<div class="form-field" style="margin-bottom:0"><label>Max Free Scans/Month</label><input class="form-input" id="cfg_freeScans" value="'+(appCfg.freeScans||'5')+'" type="number" min="0" max="100"></div>'+
        '</div>'+
        '<div class="card">'+
          '<div style="font-size:12px;font-weight:800;margin-bottom:14px;color:var(--text2);font-family:var(--font-display);letter-spacing:0.5px;">LIMITS & THRESHOLDS</div>'+
          '<div class="form-field"><label>Free Script Credits (new users)</label><input class="form-input" id="cfg_freeCredits" value="'+(appCfg.freeCredits||'3')+'" type="number" min="0"></div>'+
          '<div class="form-field"><label>Max Saved Scripts (Free)</label><input class="form-input" id="cfg_maxFreeScripts" value="'+(appCfg.maxFreeScripts||'3')+'" type="number" min="0"></div>'+
          '<div class="form-field"><label>AI Rate Limit (calls/hour)</label><input class="form-input" id="cfg_aiRateLimit" value="'+(appCfg.aiRateLimit||'60')+'" type="number" min="1"></div>'+
          '<div class="form-field" style="margin-bottom:0"><label>Maintenance Banner Message</label><input class="form-input" id="cfg_maintenanceMsg" value="'+(appCfg.maintenanceMsg||'')+'" placeholder="We\'re updating â€” back in 30 mins!"></div>'+
        '</div>'+
      '</div>'+
      '<button class="btn btn-primary" style="margin-top:14px" onclick="adminSaveConfig()">ðŸ’¾ Save Configuration</button>';
  }

  // â”€â”€ STRIPE â”€â”€
  if(tab==='stripe') {
    var stripe = {}; try { stripe = JSON.parse(localStorage.getItem('tv_stripe_cfg')||'{}'); } catch(e) {}
    var stripeLinks = stripe.links || {};
    var pk = stripe.publishableKey || '';
    var isLive = !!(pk && pk.startsWith('pk_'));
    var isTestMode = !!(pk && pk.startsWith('pk_test'));
    var isRealLive = !!(pk && pk.startsWith('pk_live'));
    var modeColor = isRealLive ? 'var(--teal)' : isTestMode ? 'var(--gold)' : 'var(--accent)';
    var modeLabel = isRealLive ? 'âœ… Live â€” Real Payments' : isTestMode ? 'ðŸ§ª Test Mode' : 'âš ï¸ Demo Mode â€” No Real Payments';
    var planColors = {starter:'var(--teal)',pro:'var(--accent)',gold:'var(--gold)',elite:'var(--elite)'};
    var planPrices = {starter:'Â£9/mo',pro:'Â£19/mo',gold:'Â£39/mo',elite:'Â£79/mo'};
    var annualPrices = {starter:'Â£86/yr',pro:'Â£182/yr',gold:'Â£374/yr',elite:'Â£758/yr'};

    // Count how many live links are configured
    var liveLinks = ['starter','pro','gold','elite'].filter(function(p){ var l=stripeLinks[p]||''; return l && !l.includes('/test_'); });
    var testLinks  = ['starter','pro','gold','elite'].filter(function(p){ var l=stripeLinks[p]||''; return l && l.includes('/test_'); });

    content =
      // â”€â”€ STATUS BANNER â”€â”€
      '<div style="background:'+(isRealLive?'rgba(0,229,176,0.08)':isTestMode?'rgba(251,191,36,0.08)':'rgba(255,48,88,0.08)')+';border:1px solid '+(isRealLive?'rgba(0,229,176,0.3)':isTestMode?'rgba(251,191,36,0.35)':'rgba(255,48,88,0.35)')+';border-radius:16px;padding:16px 18px;margin-bottom:16px;display:flex;align-items:center;gap:14px">'+
        '<div style="font-size:32px">'+(isRealLive?'ðŸŸ¢':isTestMode?'ðŸŸ¡':'ðŸ”´')+'</div>'+
        '<div style="flex:1">'+
          '<div style="font-size:14px;font-weight:900;font-family:var(--font-display);color:'+modeColor+'">'+modeLabel+'</div>'+
          '<div style="font-size:12px;color:var(--muted);margin-top:2px">'+
            (isRealLive ? liveLinks.length+'/4 plan links configured Â· Real card payments active Â· Confirmation code fraud protection ON' :
             isTestMode ? 'Test card payments only Â· Real customers CANNOT pay Â· Switch to pk_live_ to go live' :
             'Anyone can upgrade for free Â· No payments taken Â· Add your Stripe keys below to go live') +
          '</div>'+
        '</div>'+
        (isTestMode || !isLive ?
          '<button class="btn btn-primary btn-sm" onclick="document.getElementById(\'_stripePKInput\').focus();document.getElementById(\'_stripePKInput\').select()" style="white-space:nowrap">Go Live â†’</button>'
        : '') +
      '</div>'+

      // â”€â”€ FRAUD PROTECTION STATUS â”€â”€
      '<div style="background:rgba(0,229,176,0.05);border:1px solid rgba(0,229,176,0.2);border-radius:12px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:12px">'+
        '<span style="font-size:20px">ðŸ”</span>'+
        '<div>'+
          '<div style="font-size:12px;font-weight:800;color:var(--teal)">Confirmation Code Fraud Protection â€” ACTIVE</div>'+
          '<div style="font-size:11px;color:var(--muted);margin-top:2px">After checkout, users must enter a unique time-based code to unlock their plan. Prevents URL manipulation attacks.</div>'+
        '</div>'+
      '</div>'+

      // â”€â”€ SETUP GUIDE (only when not fully live) â”€â”€
      (!isRealLive ?
        '<details style="margin-bottom:16px" '+(isTestMode?'':'open')+'>'+
          '<summary style="cursor:pointer;list-style:none;display:flex;align-items:center;justify-content:space-between;background:rgba(99,102,241,0.06);border:1px solid rgba(99,102,241,0.25);border-radius:12px;padding:12px 16px">'+
            '<span style="font-size:12px;font-weight:800;color:var(--purple);font-family:var(--font-display);letter-spacing:0.5px">ðŸ“– HOW TO GO LIVE WITH STRIPE</span>'+
            '<span style="color:var(--muted);font-size:16px">+</span>'+
          '</summary>'+
          '<div style="border:1px solid rgba(99,102,241,0.2);border-top:none;border-radius:0 0 12px 12px;padding:16px;display:flex;flex-direction:column;gap:10px">'+
            [
              ['1','Create Stripe account','<a href="https://dashboard.stripe.com/register" target="_blank" style="color:var(--accent)">dashboard.stripe.com/register</a> â€” complete business verification'],
              ['2','Get your live key','Stripe Dashboard â†’ Developers â†’ API Keys â†’ copy <strong>pk_live_...</strong>'],
              ['3','Create Payment Links','Payment Links â†’ + New â†’ Recurring product for each plan. Set success URL: <code style="background:var(--surface3);padding:1px 5px;border-radius:4px;font-size:10px">YOUR_DOMAIN/?upgraded=PLAN_NAME</code>'],
              ['4','Create Annual Links','Repeat with 20% off annual pricing. Leave blank to reuse monthly links.'],
              ['5','Paste & Save','Enter everything below and click Save. Payments go live immediately.'],
            ].map(function(s){
              return '<div style="display:flex;gap:12px;align-items:flex-start">'+
                '<div style="width:22px;height:22px;min-width:22px;border-radius:50%;background:rgba(99,102,241,0.15);border:1px solid rgba(99,102,241,0.4);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900;color:var(--purple)">'+s[0]+'</div>'+
                '<div><div style="font-size:12px;font-weight:700;margin-bottom:2px">'+s[1]+'</div><div style="font-size:11px;color:var(--muted);line-height:1.5">'+s[2]+'</div></div>'+
              '</div>';
            }).join('')+
          '</div>'+
        '</details>'
      : '') +

      // â”€â”€ API KEYS â”€â”€
      '<div class="card" style="margin-bottom:14px">'+
        '<div style="font-size:12px;font-weight:800;margin-bottom:14px;color:var(--text2);font-family:var(--font-display);letter-spacing:0.5px">ðŸ”‘ API KEYS</div>'+
        '<div class="form-field">'+
          '<label>Publishable Key '+
            (isRealLive ? '<span style="background:rgba(0,229,176,0.12);color:var(--teal);padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700">LIVE</span>' :
             isTestMode ? '<span style="background:rgba(251,191,36,0.12);color:var(--gold);padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700">TEST â€” switch to pk_live_ to charge real cards</span>' :
             '<span style="color:var(--muted);font-weight:400;font-size:11px">starts with pk_live_ or pk_test_</span>') +
          '</label>'+
          '<input class="form-input" id="_stripePKInput" name="stripe_pk" value="'+(pk)+'" placeholder="pk_live_... (required to take payments)" autocomplete="off" oninput="document.getElementById(\'stripe_pk\').value=this.value">'+
          '<input type="hidden" id="stripe_pk" value="'+pk+'">'+
        '</div>'+
        '<div class="form-field" style="margin-bottom:0">'+
          '<label>Webhook Secret <span style="color:var(--muted);font-weight:400;font-size:11px">optional â€” for server-side verification (whsec_...)</span></label>'+
          '<input class="form-input" id="stripe_wh" type="password" value="'+(stripe.webhookSecret||'')+'" placeholder="whsec_..." autocomplete="off">'+
        '</div>'+
      '</div>'+

      // â”€â”€ MONTHLY LINKS â”€â”€
      '<div class="card" style="margin-bottom:14px">'+
        '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">'+
          '<div style="font-size:12px;font-weight:800;color:var(--text2);font-family:var(--font-display);letter-spacing:0.5px">ðŸ’³ MONTHLY PAYMENT LINKS</div>'+
          (testLinks.length > 0 ? '<span style="font-size:10px;font-weight:700;color:var(--gold);background:rgba(251,191,36,0.1);padding:2px 8px;border-radius:10px">'+testLinks.length+' test links detected</span>' : '')+
        '</div>'+
        '<div style="font-size:11px;color:var(--muted);margin-bottom:14px">Stripe Dashboard â†’ Payment Links â†’ Create recurring product â†’ Set success URL to <code style="background:var(--surface3);padding:1px 5px;border-radius:4px">yourdomain.com/?upgraded=PLAN</code></div>'+
        ['starter','pro','gold','elite'].map(function(p){
          var val = stripeLinks[p] || '';
          var isTest = val.includes('/test_');
          var isSet = !!val;
          return '<div class="form-field" style="position:relative">'+
            '<label style="display:flex;align-items:center;gap:6px">'+
              '<span style="color:'+planColors[p]+'">'+p.toUpperCase()+' â€” '+planPrices[p]+'</span>'+
              (isSet && !isTest ? '<span style="font-size:10px;background:rgba(0,229,176,0.12);color:var(--teal);padding:1px 7px;border-radius:10px;font-weight:700">âœ“ Live</span>' : '')+
              (isTest ? '<span style="font-size:10px;background:rgba(251,191,36,0.12);color:var(--gold);padding:1px 7px;border-radius:10px;font-weight:700">âš  Test link</span>' : '')+
            '</label>'+
            '<input class="form-input" id="stripe_link_'+p+'" value="'+val+'" placeholder="https://buy.stripe.com/live_... (replace test_ with live_)">'+
          '</div>';
        }).join('')+
      '</div>'+

      // â”€â”€ ANNUAL LINKS â”€â”€
      '<div class="card" style="margin-bottom:14px">'+
        '<div style="font-size:12px;font-weight:800;margin-bottom:4px;color:var(--text2);font-family:var(--font-display);letter-spacing:0.5px">ðŸ“… ANNUAL PAYMENT LINKS <span style="font-weight:400;color:var(--teal);font-size:10px;margin-left:4px">SAVE 20%</span></div>'+
        '<div style="font-size:11px;color:var(--muted);margin-bottom:14px">Leave blank to fall back to monthly links when annual toggle is on.</div>'+
        ['starter','pro','gold','elite'].map(function(p){
          var val = stripeLinks[p+'_annual'] || '';
          var isTest = val.includes('/test_');
          return '<div class="form-field">'+
            '<label style="display:flex;align-items:center;gap:6px">'+
              '<span style="color:'+planColors[p]+'">'+p.toUpperCase()+' ANNUAL â€” '+annualPrices[p]+'</span>'+
              (val && !isTest ? '<span style="font-size:10px;background:rgba(0,229,176,0.12);color:var(--teal);padding:1px 7px;border-radius:10px;font-weight:700">âœ“ Live</span>' : '')+
              (isTest ? '<span style="font-size:10px;background:rgba(251,191,36,0.12);color:var(--gold);padding:1px 7px;border-radius:10px;font-weight:700">âš  Test</span>' : '')+
            '</label>'+
            '<input class="form-input" id="stripe_link_'+p+'_annual" value="'+val+'" placeholder="https://buy.stripe.com/live_... (annual)">'+
          '</div>';
        }).join('')+
      '</div>'+

      // â”€â”€ CREDIT LINKS â”€â”€
      '<div class="card" style="margin-bottom:20px">'+
        '<div style="font-size:12px;font-weight:800;margin-bottom:4px;color:var(--text2);font-family:var(--font-display);letter-spacing:0.5px">âœï¸ SCRIPT CREDIT PACK LINKS</div>'+
        '<div style="font-size:11px;color:var(--muted);margin-bottom:12px">One-time Stripe payment links shown in the Script Credits modal. Users can buy 1, 10, or 25 scripts at a time.</div>'+
        '<div class="form-field"><label>1 Script Credit Link</label>'+
          '<input class="form-input" id="stripe_credit_link1" value="'+(stripe.creditLink1||'')+'" placeholder="https://buy.stripe.com/live_... (1 credit)"></div>'+
        '<div class="form-field"><label>10 Script Credits Link</label>'+
          '<input class="form-input" id="stripe_credit_link10" value="'+(stripe.creditLink10||'')+'" placeholder="https://buy.stripe.com/live_... (10 credits)"></div>'+
        '<div class="form-field"><label>25 Script Credits Link</label>'+
          '<input class="form-input" id="stripe_credit_link25" value="'+(stripe.creditLink25||'')+'" placeholder="https://buy.stripe.com/live_... (25 credits)"></div>'+
        '<div class="form-field" style="margin-bottom:0"><label>Fallback Credit Pack Link <span style="color:var(--muted);font-weight:400;font-size:11px">used if qty-specific links above are empty</span></label>'+
          '<input class="form-input" id="stripe_credit_link" value="'+(stripe.creditLink||'')+'" placeholder="https://buy.stripe.com/live_... (fallback one-time)"></div>'+
      '</div>'+

      // â”€â”€ SAVE â”€â”€
      '<button class="btn btn-primary" onclick="adminSaveStripe()" style="width:100%;font-size:14px">ðŸ’¾ Save Stripe Config</button>'+
      (isTestMode ? '<div style="margin-top:10px;background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.3);border-radius:10px;padding:10px 14px;font-size:11px;color:var(--gold);text-align:center">âš ï¸ You are in test mode. Replace <strong>pk_test_</strong> with <strong>pk_live_</strong> and update your payment links to start taking real payments.</div>' : '')+
      '<div style="margin-top:10px;font-size:11px;color:var(--muted);text-align:center">All plan links include automatic confirmation-code fraud protection â€” no extra setup needed.</div>';
  }

  // â”€â”€ CHANGELOG â”€â”€
  if(tab==='changelog') {
    var changelog = []; try { changelog = JSON.parse(localStorage.getItem('tv_changelog')||'[]'); } catch(e) {}
    var defaultChangelog = [
      {version:'v14b',date:'Feb 2026',type:'fix',note:'Fixed clipboard API blocked error on file:// protocol. All copy buttons now work.'},
      {version:'v14a',date:'Feb 2026',type:'feature',note:'Added admin panel hamburger sidebar. Moved admin to Account section.'},
      {version:'v13',date:'Jan 2026',type:'feature',note:'Added Activity Log, Revenue tab, Feature Flags, App Config, Stripe integration to admin.'},
      {version:'v12',date:'Jan 2026',type:'feature',note:'Added Script Improver, Comment Reply Generator, Caption Gen, B-Roll Ideas, Music Picks.'},
      {version:'v11',date:'Dec 2025',type:'fix',note:'Syntax error in gift code table fixed. Node.js syntax check added to CI.'},
      {version:'v10',date:'Dec 2025',type:'feature',note:'Added Viral Score, Channel Health, Content Gap Finder, Soundtrack Finder, Bundle Deals.'},
    ];
    var allChangelog = changelog.concat(defaultChangelog);
    var typeColors = {feature:'var(--teal)',fix:'var(--gold)',breaking:'var(--accent)'};
    content =
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">'+
        '<div>'+
          '<div style="font-size:14px;font-weight:800">Changelog & Release Notes</div>'+
          '<div style="font-size:12px;color:var(--muted);margin-top:2px">Current build: <span style="color:var(--teal);font-weight:800">'+APP_VERSION+'</span> Â· <span style="font-family:monospace;font-size:10px;color:var(--muted)">'+APP_BUILD_HASH+'</span></div>'+
        '</div>'+
        '<div style="display:flex;gap:6px">'+
          '<button class="btn btn-ghost btn-sm" onclick="adminManualUpdateCheck()" title="Force update check and regenerate release notes">ðŸ”„ Check Updates</button>'+
          '<button class="btn btn-primary btn-sm" onclick="adminAddChangelogEntry()">+ Add Entry</button>'+
        '</div>'+
      '</div>'+
      '<div style="background:rgba(0,229,176,0.06);border:1px solid rgba(0,229,176,0.2);border-radius:10px;padding:10px 14px;font-size:11px;color:var(--text2);margin-bottom:14px;line-height:1.6">'+
        'ðŸ¤– <strong style="color:var(--teal)">Auto-Release Notes:</strong> When this app file is updated and a user logs in, TrendVid AI automatically compares the build hash, generates release notes, and broadcasts them to all users as an announcement. No manual action needed.'+
      '</div>'+
      '<div id="changelogEntryForm" style="display:none" class="card" style="margin-bottom:14px">'+
        '<div style="font-size:12px;font-weight:700;margin-bottom:10px">New Entry</div>'+
        '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px">'+
          '<input class="form-input" id="cl_version" placeholder="v15" style="font-size:12px">'+
          '<input class="form-input" id="cl_date" placeholder="Mar 2026" style="font-size:12px">'+
          '<select class="form-input form-select" id="cl_type" style="font-size:12px"><option value="feature">Feature</option><option value="fix">Fix</option><option value="breaking">Breaking</option></select>'+
        '</div>'+
        '<textarea class="form-input" id="cl_note" rows="2" placeholder="What changed..." style="font-size:12px;margin-bottom:8px;resize:none"></textarea>'+
        '<div style="display:flex;gap:8px"><button class="btn btn-primary btn-sm" onclick="adminSaveChangelog()">Save</button><button class="btn btn-ghost btn-sm" onclick="document.getElementById(\&quot;changelogEntryForm\&quot;).style.display=\&quot;none\&quot;">Cancel</button></div>'+
      '</div>'+
      '<div style="display:flex;flex-direction:column;gap:8px">'+
        allChangelog.map(function(c){
          var col = typeColors[c.type]||'var(--muted)';
          return '<div class="card" style="display:flex;gap:12px;padding:14px 16px;">'+
            '<div style="flex-shrink:0;text-align:right;width:60px">'+
              '<div style="font-size:12px;font-weight:800;font-family:var(--font-display);color:var(--text)">'+c.version+'</div>'+
              '<div style="font-size:10px;color:var(--muted)">'+c.date+'</div>'+
            '</div>'+
            '<div style="width:2px;border-radius:1px;background:'+col+';flex-shrink:0"></div>'+
            '<div style="flex:1">'+
              '<span style="font-size:9px;font-weight:900;padding:2px 8px;border-radius:6px;text-transform:uppercase;letter-spacing:1px;background:'+col.replace(')',',0.1)').replace('var(--','rgba(').replace('teal','0,229,176').replace('gold','251,191,36').replace('accent','255,48,88')+';color:'+col+'">'+c.type+'</span>'+
              '<div style="font-size:12px;color:var(--text2);margin-top:5px;line-height:1.5">'+c.note+'</div>'+
            '</div>'+
          '</div>';
        }).join('')+
      '</div>';
  }

  // â”€â”€ BROADCAST, WEEKLY, CODES, REPORTS, AI, CREDITS, PRICES, NOTES â”€â”€
  // These already have content-generating code â€” pull from existing logic
  if(tab==='nps') {
    var npsScores = []; try { npsScores = JSON.parse(localStorage.getItem('tv_nps_scores')||'[]'); } catch(e) {}
    var npsFeedback = []; try { npsFeedback = JSON.parse(localStorage.getItem('tv_nps_feedback')||'[]'); } catch(e) {}
    var promoters = npsScores.filter(function(n){return n.score>=9;}).length;
    var detractors = npsScores.filter(function(n){return n.score<=6;}).length;
    var npsScore = npsScores.length ? Math.round(((promoters-detractors)/npsScores.length)*100) : 0;
    var npsColor = npsScore>=50?'var(--teal)':npsScore>=0?'var(--gold)':'var(--accent)';
    content =
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">'+
        '<div><div style="font-size:14px;font-weight:800">NPS & User Feedback</div><div style="font-size:12px;color:var(--muted)">Net Promoter Score from in-app surveys</div></div>'+
        '<button class="btn btn-ghost btn-sm" onclick="if(confirm(\'Clear all NPS data?\')){localStorage.removeItem(\'tv_nps_scores\');localStorage.removeItem(\'tv_nps_feedback\');renderAdmin();}">ðŸ—‘ï¸ Clear</button>'+
      '</div>'+
      '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px">'+
        adminStat('NPS Score', (npsScore>0?'+':'')+npsScore, npsColor)+
        adminStat('Total Responses', npsScores.length, 'var(--text)')+
        adminStat('Promoters (9-10)', promoters, 'var(--teal)')+
        adminStat('Detractors (0-6)', detractors, 'var(--accent)')+
      '</div>'+
      (npsFeedback.length > 0 ?
        '<div class="card"><div style="font-size:12px;font-weight:800;margin-bottom:12px">WRITTEN FEEDBACK ('+npsFeedback.length+')</div>'+
        '<div style="display:flex;flex-direction:column;gap:10px">'+
        npsFeedback.slice().reverse().map(function(f){
          return '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px">'+
            '<div style="font-size:10px;color:var(--muted);margin-bottom:4px">Score: '+f.score+'/10 Â· '+adminTimeAgo(f.at)+'</div>'+
            '<div style="font-size:12px;color:var(--text2)">'+esc(f.feedback||'')+'</div>'+
          '</div>';
        }).join('')+
        '</div></div>'
      : '<div class="card" style="text-align:center;padding:32px;color:var(--muted)">No feedback submitted yet. NPS surveys appear to users after 7 days of inactivity.</div>');
  }

  if(tab==='broadcast') {
    content = _adminBroadcastContent(announcements);
  }
  if(tab==='weekly') {
    content = _adminWeeklyContent(users);
  }
  if(tab==='codes') {
    content = _adminCodesContent(gifts);
  }
  if(tab==='reports') {
    content = _adminReportsContent(reports);
  }
  if(tab==='ai') {
    content = _adminAIContent();
  }
  if(tab==='apikeys') {
    content = _adminAPIKeysContent();
  }
  if(tab==='credits') {
    content = _adminCreditsContent(users, prices);
  }
  if(tab==='prices') {
    content = _adminPricesContent(prices);
  }
  if(tab==='notes') {
    content = _adminNotesContent(notes);
  }


  if(tab==='messages') {
    var allMsgs = [];
    try { allMsgs = JSON.parse(localStorage.getItem('tv_admin_messages')||'[]'); } catch(e) {}
    var unreadCount = allMsgs.filter(function(m){ return !m.read; }).length;
    var msgRows = allMsgs.length===0
      ? '<div style="text-align:center;padding:50px;color:var(--muted)">No messages yet</div>'
      : allMsgs.map(function(m,i){
          var si = {bug:'ðŸ›',feature:'ðŸ’¡',billing:'ðŸ’³',account:'ðŸ‘¤',praise:'ðŸŒŸ',other:'ðŸ’¬'}[m.subject]||'ðŸ’¬';
          var time = new Date(m.at).toLocaleString('en-GB',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
          var nameS = esc(m.name||'');
          var emailS = esc(m.email||'');
          var planS = esc(m.plan||'unknown');
          var subjectS = esc(m.subjectLabel||m.subject||'');
          var msgS = esc(m.message||'');
          return '<div class="card" style="margin-bottom:10px;border-left:3px solid '+(m.read?'var(--border)':'var(--accent)')+'">'+
            '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">'+
              '<div style="display:flex;align-items:center;gap:8px">'+
                '<span style="font-size:18px">'+si+'</span>'+
                '<div>'+
                  '<div style="font-size:13px;font-weight:700">'+nameS+'</div>'+
                  '<div style="font-size:11px;color:var(--muted)">'+emailS+'  Â·  Plan: '+planS+'</div>'+
                '</div>'+
                (!m.read?'<span style="background:var(--accent);color:#fff;font-size:9px;font-weight:900;padding:2px 8px;border-radius:8px;margin-left:6px">NEW</span>':'')+
              '</div>'+
              '<div style="display:flex;align-items:center;gap:6px">'+
                '<span style="font-size:10px;color:var(--muted)">'+time+'</span>'+
                '<span style="font-size:11px;font-weight:700;background:rgba(255,255,255,0.05);padding:2px 8px;border-radius:6px">'+subjectS+'</span>'+
                '<button class="btn btn-ghost btn-sm" style="font-size:10px" onclick="adminMarkMsgRead(&quot;+i+&quot;)" title="Mark read">âœ…</button>'+
                '<button class="btn btn-ghost btn-sm" style="font-size:10px;color:var(--accent)" onclick="adminDeleteMsg(&quot;+i+&quot;)" title="Delete">ðŸ—‘ï¸</button>'+
              '</div>'+
            '</div>'+
            '<div style="font-size:13px;color:var(--text2);line-height:1.6;background:var(--surface2);padding:10px 12px;border-radius:8px;margin-bottom:8px">'+msgS+'</div>'+
            '<a href="mailto:'+emailS+'?subject=Re: TrendVid - '+subjectS+'&body=Hi '+nameS+',%0A%0A" class="btn btn-ghost btn-sm" style="font-size:11px;text-decoration:none;display:inline-flex">â†©ï¸ Reply by Email</a>'+
          '</div>';
        }).join('');
    content =
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">'+
        '<div>'+
          '<div style="font-size:14px;font-weight:700">Inbox ('+allMsgs.length+' total Â· '+unreadCount+' unread)</div>'+
          '<div style="font-size:11px;color:var(--muted);margin-top:2px">Personal messages sent from Help & Support</div>'+
        '</div>'+
        '<div style="display:flex;gap:6px">'+
          '<button class="btn btn-ghost btn-sm" onclick="adminMarkAllMsgsRead()">âœ… Mark All Read</button>'+
          '<button class="btn btn-ghost btn-sm" onclick="if(confirm(\&quot;Delete all messages?\&quot;)){localStorage.removeItem(\&quot;tv_admin_messages\&quot;);renderAdmin();}">ðŸ—‘ï¸ Clear All</button>'+
        '</div>'+
      '</div>'+
      msgRows;
  }

  if(tab==='seclog') {
    var secEntries = [];
    try { secEntries = JSON.parse(localStorage.getItem('tv_sec_log')||'[]'); } catch(e) {}
    secEntries = secEntries.slice().reverse();
    var typeColors = {
      LOGIN_SUCCESS:'var(--teal)', LOGIN_FAIL:'var(--gold)', ACCOUNT_LOCKED:'var(--accent)',
      LOGIN_BLOCKED:'var(--accent)', SUSPICIOUS_INPUT:'var(--accent)', TAMPER_ATTEMPT:'var(--elite)',
      DEVTOOLS_OPENED:'var(--purple)', CSP_VIOLATION:'var(--accent)'
    };
    var loginFails   = secEntries.filter(function(e){return e.type==='LOGIN_FAIL'||e.type==='ACCOUNT_LOCKED'||e.type==='LOGIN_BLOCKED';}).length;
    var tampers      = secEntries.filter(function(e){return e.type==='TAMPER_ATTEMPT'||e.type==='SUSPICIOUS_INPUT';}).length;
    var deviceFlags  = secEntries.filter(function(e){return e.type==='DEVTOOLS_OPENED';}).length;
    content =
      '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">'+
        adminStat('ðŸ“‹ Total Events', secEntries.length, 'var(--text2)')+
        adminStat('âš ï¸ Login Fails',  loginFails,  loginFails>0?'var(--gold)':'var(--teal)')+
        adminStat('ðŸ›¡ï¸ Tamper Attempts', tampers, tampers>0?'var(--accent)':'var(--teal)')+
      '</div>'+
      '<div class="card">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">'+
          '<div><div style="font-size:13px;font-weight:700">Security Event Log</div>'+
          '<div style="font-size:11px;color:var(--muted);margin-top:2px">Auto-captured login attempts, tampering, and suspicious activity</div></div>'+
          '<button class="btn btn-ghost btn-sm" onclick="if(confirm(\&quot;Clear security log?\&quot;)){localStorage.removeItem(\&quot;tv_sec_log\&quot;);window._securityLog&&(_securityLog=[]);renderAdmin();}">ðŸ—‘ï¸ Clear</button>'+
        '</div>'+
        (secEntries.length===0
          ? '<div style="text-align:center;padding:40px;color:var(--muted)">No security events yet ðŸŽ‰</div>'
          : '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:11px">'+
              '<thead><tr style="border-bottom:1px solid var(--border)">'+
                ['TYPE','DETAIL','USER','TIME'].map(function(h){return '<th style="padding:7px 10px;text-align:left;color:var(--muted);font-size:10px;white-space:nowrap">'+h+'</th>';}).join('')+
              '</tr></thead><tbody>'+
              secEntries.slice(0,150).map(function(e){
                var col = typeColors[e.type]||'var(--muted)';
                var time = new Date(e.ts).toLocaleString('en-GB',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
                return '<tr style="border-bottom:1px solid rgba(255,255,255,0.03)" onmouseover="this.style.background=\'var(--surface2)\'" onmouseout="this.style.background=\'\'">'+
                  '<td style="padding:7px 10px"><span style="font-size:9px;font-weight:800;padding:2px 8px;border-radius:6px;white-space:nowrap;background:rgba(0,0,0,0.2);color:'+col+'">'+esc(e.type)+'</span></td>'+
                  '<td style="padding:7px 10px;color:var(--text2);max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+esc(e.detail||'')+'">'+esc((e.detail||'').substring(0,70))+'</td>'+
                  '<td style="padding:7px 10px;color:var(--muted);font-size:10px">'+esc(e.user||'â€”')+'</td>'+
                  '<td style="padding:7px 10px;color:var(--muted);white-space:nowrap;font-size:10px">'+time+'</td>'+
                '</tr>';
              }).join('')+
            '</tbody></table></div>'
        )+
      '</div>';
  }

  // â”€â”€ XP MANAGER â”€â”€
  if(tab==='xp') {
    var allU = users;
    var userOpts = allU.map(function(u) {
      var lv = Math.max(1, Math.floor((u.xp_total||0) / XP_PER_LEVEL) + 1);
      return '<option value="'+u.email+'">'+(u.name||u.email)+' â€” LVL '+lv+' ('+(u.xp_total||0)+' XP)</option>';
    }).join('');
    var xpRows = allU.slice(0,50).map(function(u) {
      var xp = u.xp_total||0;
      var lv = Math.max(1, Math.floor(xp/XP_PER_LEVEL)+1);
      var bd = getCurrentBadge(lv);
      var safeEmail = (u.email||'').replace(/"/g,'');
      return '<tr style="border-bottom:1px solid var(--border)">'+
        '<td style="padding:8px 10px;font-size:12px">'+(u.name||'â€”')+'</td>'+
        '<td style="padding:8px 10px;font-size:11px;color:var(--muted)">'+(u.email||'â€”')+'</td>'+
        '<td style="padding:8px 10px;text-align:center">'+(bd?bd.emoji:'ðŸŒ±')+' LVL '+lv+'</td>'+
        '<td style="padding:8px 10px;text-align:center;font-weight:700;color:var(--accent2)">'+xp+'</td>'+
        '<td style="padding:8px 10px">'+
          '<div style="display:flex;gap:4px;align-items:center">'+
            '<input type="number" placeholder="Â±XP" class="xp-row-input" data-email="'+safeEmail+'" style="width:70px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:4px 6px;color:var(--text);font-size:11px">'+
            '<button class="btn btn-ghost btn-sm" style="font-size:10px;padding:3px 8px" onclick="adminXPRowAdjust(this,false)">+/âˆ’</button>'+
            '<button class="btn btn-ghost btn-sm" style="font-size:10px;padding:3px 8px;color:var(--teal)" onclick="adminXPRowAdjust(this,true)">Set</button>'+
          '</div>'+
        '</td>'+
      '</tr>';
    }).join('');
    content =
      '<div class="card" style="margin-bottom:14px">'+
        '<div style="font-size:13px;font-weight:700;margin-bottom:8px">â­ Quick XP Adjust</div>'+
        '<div style="display:grid;grid-template-columns:1fr 120px auto;gap:8px;align-items:flex-end;margin-bottom:8px">'+
          '<div class="form-field" style="margin:0"><label>User</label><select class="form-input form-select" id="xpAdminUser"><option value="">â€” Select user â€”</option>'+userOpts+'</select></div>'+
          '<div class="form-field" style="margin:0"><label>XP Amount</label><input class="form-input" id="xpAdminAmount" type="number" placeholder="e.g. 50"></div>'+
          '<div style="display:flex;gap:6px;align-items:flex-end;padding-bottom:1px">'+
            '<button class="btn btn-primary btn-sm" onclick="adminXPQuickAdjust(false)">+/âˆ’ Add</button>'+
            '<button class="btn btn-secondary btn-sm" onclick="adminXPQuickAdjust(true)">= Set</button>'+
          '</div>'+
        '</div>'+
      '</div>'+
      '<div class="card" style="padding:0;overflow:hidden">'+
        '<div style="padding:12px 16px;border-bottom:1px solid var(--border);font-size:12px;font-weight:700;color:var(--muted)">ALL USERS ('+allU.length+')</div>'+
        '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px">'+
          '<thead><tr style="border-bottom:1px solid var(--border)">'+
            '<th style="padding:8px 10px;text-align:left;font-size:10px;color:var(--muted)">NAME</th>'+
            '<th style="padding:8px 10px;text-align:left;font-size:10px;color:var(--muted)">EMAIL</th>'+
            '<th style="padding:8px 10px;text-align:center;font-size:10px;color:var(--muted)">LEVEL</th>'+
            '<th style="padding:8px 10px;text-align:center;font-size:10px;color:var(--muted)">XP</th>'+
            '<th style="padding:8px 10px;text-align:left;font-size:10px;color:var(--muted)">ADJUST</th>'+
          '</tr></thead>'+
          '<tbody>'+(xpRows||'<tr><td colspan="5" style="padding:20px;text-align:center;color:var(--muted)">No users yet</td></tr>')+'</tbody>'+
        '</table></div>'+
      '</div>';
  }

  // â”€â”€ LEVELS & BADGES EDITOR â”€â”€
  if(tab==='levels') {
    var allLevs = getCustomLevels ? getCustomLevels() : [];
    var maxLev = allLevs.reduce(function(m,l){return Math.max(m,l.level);},0);
    var levRows = allLevs.map(function(l) {
      return '<div class="card" style="margin-bottom:6px;padding:10px 12px">'+
        '<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">'+
          '<div style="font-size:18px;width:28px;text-align:center">'+l.emoji+'</div>'+
          '<span style="font-size:10px;font-weight:700;color:var(--muted);min-width:44px">LVL '+l.level+'</span>'+
          '<input class="adm-lev-inp" data-level="'+l.level+'" data-field="badge" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:3px 8px;color:var(--text);font-size:12px;font-weight:700;width:130px" value="'+l.badge+'" onchange="adminLevelFieldChange(this)" placeholder="Badge name">'+
          '<input class="adm-lev-inp" data-level="'+l.level+'" data-field="emoji" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:3px 6px;color:var(--text);font-size:14px;width:36px;text-align:center" value="'+l.emoji+'" onchange="adminLevelFieldChange(this)" placeholder="ðŸ†">'+
          '<input class="adm-lev-inp" data-level="'+l.level+'" data-field="desc" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:3px 8px;color:var(--text);font-size:11px;flex:1;min-width:160px" value="'+(l.desc||'')+'" onchange="adminLevelFieldChange(this)" placeholder="Description">'+
          '<button class="btn btn-ghost btn-sm" style="font-size:10px;color:var(--accent);flex-shrink:0" onclick="adminDeleteLevel('+l.level+')">ðŸ—‘</button>'+
        '</div>'+
      '</div>';
    }).join('');
    content =
      '<div class="card" style="margin-bottom:12px">'+
        '<div style="font-size:13px;font-weight:700;margin-bottom:10px">âž• Add New Level</div>'+
        '<div style="display:grid;grid-template-columns:50px 1fr 1fr;gap:8px;margin-bottom:8px">'+
          '<div class="form-field" style="margin:0"><label>Emoji</label><input class="form-input" id="newLevelEmoji" placeholder="â­" style="text-align:center;font-size:18px"></div>'+
          '<div class="form-field" style="margin:0"><label>Badge Name</label><input class="form-input" id="newLevelBadge" placeholder="Ultra Creator"></div>'+
          '<div class="form-field" style="margin:0"><label>Title</label><input class="form-input" id="newLevelTitle" placeholder="The Legend"></div>'+
        '</div>'+
        '<div class="form-field"><label>Description</label><input class="form-input" id="newLevelDesc" placeholder="Add a description..."></div>'+
        '<button class="btn btn-primary btn-sm" onclick="adminAddLevel()">âœ¨ Add Level after LVL '+maxLev+'</button>'+
      '</div>'+
      '<div style="font-size:11px;color:var(--muted);margin-bottom:8px">'+allLevs.length+' levels â€” edit inline, saves instantly</div>'+
      '<div style="max-height:55vh;overflow-y:auto">'+levRows+'</div>';
  }

  // â”€â”€ NOTIFICATIONS / ALERTS â”€â”€
  if(tab==='notifications') {
    var adminNotifs=[]; try{adminNotifs=JSON.parse(localStorage.getItem('tv_admin_notifs')||'[]');}catch(e){}
    adminNotifs.forEach(function(n){n.read=true;});
    try{localStorage.setItem('tv_admin_notifs',JSON.stringify(adminNotifs));}catch(e){}
    if(typeof updateAdminNotifBadge==='function') updateAdminNotifBadge();
    var nIcons={champion_streak:'ðŸ†',user_joined:'ðŸ‘¤',error_report:'ðŸ›'};
    var nMsg=function(n){
      if(n.type==='champion_streak') return (n.name||n.user)+' held #1 for '+n.weeks+' weeks â€” +500 XP auto-granted.';
      if(n.type==='user_joined') return (n.name||n.user)+' joined TrendVid.';
      if(n.type==='error_report') return 'Bug report from '+(n.user||'anonymous');
      return n.type;
    };
    var nRows=adminNotifs.length===0?
      '<div style="text-align:center;padding:40px;color:var(--muted)"><div style="font-size:36px;margin-bottom:8px">ðŸ””</div>No notifications yet</div>':
      adminNotifs.map(function(n){
        return '<div class="card" style="margin-bottom:8px;padding:14px 16px">'+
          '<div style="display:flex;gap:12px;align-items:flex-start">'+
            '<div style="font-size:22px;flex-shrink:0">'+(nIcons[n.type]||'ðŸ””')+'</div>'+
            '<div style="flex:1"><div style="font-size:13px;font-weight:700;margin-bottom:4px">'+nMsg(n)+'</div>'+
            '<div style="font-size:11px;color:var(--muted)">'+new Date(n.at).toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})+'</div></div>'+
          '</div>'+
        '</div>';
      }).join('');
    content=
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">'+
        '<div style="font-size:13px;font-weight:700">Alerts ('+adminNotifs.length+')</div>'+
        '<button class="btn btn-ghost btn-sm" onclick="adminClearNotifs()">Clear All</button>'+
      '</div>'+nRows;
  }

  if(tab==='autoupload') {
    var auCfg = {}; try { auCfg = JSON.parse(localStorage.getItem('tv_autoupload_cfg') || '{}'); } catch(e) {}
    var platforms = [
      {id:'youtube',   label:'YouTube',    icon:'â–¶ï¸',  color:'#ff0000', planned:false},
      {id:'tiktok',    label:'TikTok',     icon:'ðŸŽµ',  color:'#69C9D0', planned:false},
      {id:'instagram', label:'Instagram',  icon:'ðŸ“¸',  color:'#e1306c', planned:false},
      {id:'facebook',  label:'Facebook',   icon:'ðŸ‘¥',  color:'#1877f2', planned:true},
      {id:'twitter',   label:'Twitter/X',  icon:'ðŸ¦',  color:'#1da1f2', planned:true},
      {id:'linkedin',  label:'LinkedIn',   icon:'ðŸ’¼',  color:'#0077b5', planned:true},
      {id:'pinterest', label:'Pinterest',  icon:'ðŸ“Œ',  color:'#e60023', planned:true},
    ];
    var platformCards = platforms.map(function(p) {
      var enabled = !p.planned && auCfg[p.id] && auCfg[p.id].connected;
      var apiKey = (auCfg[p.id] && auCfg[p.id].apiKey) || '';
      var clientId = (auCfg[p.id] && auCfg[p.id].clientId) || '';
      if(p.planned) {
        return '<div class="card" style="opacity:0.5;position:relative">'+
          '<div style="position:absolute;top:10px;right:10px;font-size:9px;font-weight:900;background:var(--surface3);color:var(--muted);padding:2px 8px;border-radius:8px;letter-spacing:1px">COMING SOON</div>'+
          '<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">'+
            '<span style="font-size:24px">'+p.icon+'</span>'+
            '<div style="font-weight:800;font-size:14px">'+p.label+'</div>'+
          '</div>'+
          '<div style="font-size:11px;color:var(--muted)">Integration planned â€” stay tuned.</div>'+
        '</div>';
      }
      return '<div class="card" style="border-color:'+(enabled?'rgba(0,229,176,0.4)':'var(--border)')+'">'+
        '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">'+
          '<div style="display:flex;align-items:center;gap:10px">'+
            '<span style="font-size:24px">'+p.icon+'</span>'+
            '<div>'+
              '<div style="font-weight:800;font-size:14px">'+p.label+'</div>'+
              '<div style="font-size:10px;color:'+(enabled?'var(--teal)':'var(--muted)')+'">'+
                (enabled ? 'âœ… Connected' : 'âš ï¸ Not connected')+
              '</div>'+
            '</div>'+
          '</div>'+
          '<label style="display:flex;align-items:center;gap:6px;cursor:pointer">'+
            '<input type="checkbox" '+(enabled?'checked':'')+' onchange="adminToggleAutoUploadPlatform(this)" style="width:16px;height:16px;cursor:pointer">'+
            '<span style="font-size:11px;font-weight:700">Enable</span>'+
          '</label>'+
        '</div>'+
        '<div class="form-field" style="margin-bottom:8px">'+
          '<label style="font-size:10px">API KEY / ACCESS TOKEN</label>'+
          '<input class="form-input" id="au_key_'+p.id+'" value="'+apiKey+'" placeholder="Paste your '+p.label+' API key..." type="password" style="font-size:12px">'+
        '</div>'+
        '<div class="form-field" style="margin-bottom:12px">'+
          '<label style="font-size:10px">CLIENT ID (OAuth)</label>'+
          '<input class="form-input" id="au_cid_'+p.id+'" value="'+clientId+'" placeholder="OAuth Client ID..." style="font-size:12px">'+
        '</div>'+
        '<div style="display:flex;gap:6px">'+
          '<button class="btn btn-primary btn-sm" style="flex:1" onclick="adminSaveAutoUploadPlatform(\'' + p.id + '\')">ðŸ’¾ Save</button>'+
          '<button class="btn btn-ghost btn-sm" onclick="adminTestAutoUpload(\'' + p.id + '\',\'' + p.label + '\')">ðŸ§ª Test</button>'+
        '</div>'+
      '</div>';
    }).join('');

    var scheduleRows = (auCfg.queue || []).slice(0,10).map(function(q,i){
      var t = new Date(q.scheduledAt).toLocaleString('en-GB',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
      var statusColor = q.status==='done' ? 'var(--teal)' : q.status==='failed' ? 'var(--accent)' : 'var(--gold)';
      return '<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">'+
        '<div style="flex:1"><div style="font-size:12px;font-weight:700">'+esc(q.title||'Untitled')+'</div>'+
        '<div style="font-size:10px;color:var(--muted)">'+esc(q.platform||'')+'  Â·  '+t+'</div></div>'+
        '<span style="font-size:10px;font-weight:800;color:'+statusColor+'">'+((q.status||'queued').toUpperCase())+'</span>'+
        '<button class="btn btn-ghost btn-sm" style="font-size:10px" onclick="adminRemoveUploadQueue('+i+')">ðŸ—‘ï¸</button>'+
      '</div>';
    }).join('') || '<div style="text-align:center;padding:30px;color:var(--muted);font-size:12px">No uploads queued</div>';

    content =
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">'+
        '<div style="font-family:var(--font-display);font-size:18px;font-weight:900">ðŸ“¤ Auto-Upload Manager</div>'+
        '<span style="font-size:10px;font-weight:900;background:linear-gradient(135deg,rgba(192,132,252,0.2),rgba(124,58,237,0.15));color:var(--elite);border:1px solid rgba(192,132,252,0.5);padding:3px 10px;border-radius:10px">ðŸ’Ž ELITE ONLY</span>'+
      '</div>'+
      '<div style="font-size:12px;color:var(--muted);margin-bottom:20px">Connect your social accounts to auto-publish content directly from TrendVid. Elite users get this feature â€” manage connections here.</div>'+

      '<div style="font-size:11px;font-weight:900;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px;font-family:var(--font-display)">PLATFORM CONNECTIONS</div>'+
      '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;margin-bottom:24px">'+
        platformCards+
      '</div>'+

      '<div style="font-size:11px;font-weight:900;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px;font-family:var(--font-display)">UPLOAD SETTINGS</div>'+
      '<div class="card" style="margin-bottom:20px">'+
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">'+
          '<div class="form-field" style="margin:0">'+
            '<label>Default Upload Time</label>'+
            '<input class="form-input" id="au_default_time" type="time" value="'+(auCfg.defaultTime||'09:00')+'" style="font-size:13px">'+
          '</div>'+
          '<div class="form-field" style="margin:0">'+
            '<label>Default Privacy</label>'+
            '<select class="form-input form-select" id="au_default_privacy">'+
              '<option value="public" '+(auCfg.defaultPrivacy==='public'?'selected':'')+'>Public</option>'+
              '<option value="unlisted" '+(auCfg.defaultPrivacy==='unlisted'?'selected':'')+'>Unlisted</option>'+
              '<option value="private" '+(auCfg.defaultPrivacy==='private'?'selected':'')+'>Private</option>'+
            '</select>'+
          '</div>'+
          '<div class="form-field" style="margin:0">'+
            '<label>Free Uploads Per Day (Elite)</label>'+
            '<input class="form-input" id="au_daily_limit" type="number" min="1" max="50" value="'+(auCfg.dailyLimit||2)+'" style="font-size:13px" placeholder="2">'+
            '<div style="font-size:10px;color:var(--muted);margin-top:4px">Elite users get this many free uploads per day. They can buy extra credits on top.</div>'+
          '</div>'+
        '<div class="form-field" style="margin:0;grid-column:1/-1">'+
            '<label>Notify Admin on Upload</label>'+
            '<div style="display:flex;align-items:center;gap:8px;margin-top:4px">'+
              '<input type="checkbox" id="au_notify" '+(auCfg.notifyAdmin!==false?'checked':'')+' style="width:16px;height:16px;cursor:pointer">'+
              '<span style="font-size:12px;color:var(--text2)">Send alert notification when an upload completes or fails</span>'+
            '</div>'+
          '</div>'+
        '</div>'+
        '<button class="btn btn-primary" style="margin-top:14px" onclick="adminSaveAutoUploadSettings()">ðŸ’¾ Save Settings</button>'+
      '</div>'+

      '<div style="font-size:11px;font-weight:900;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px;font-family:var(--font-display)">UPLOAD QUEUE</div>'+
      '<div class="card">'+scheduleRows+'</div>';
  }

  if(tab==='promovid') {
    content = _adminPromoVidContent();
  }

  
  // â”€â”€ RELEASE MANAGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(tab==='releasemanager') {
    var changelog = []; try { changelog = JSON.parse(localStorage.getItem('tv_changelog')||'[]'); } catch(e) {}
    var announcements2 = []; try { announcements2 = JSON.parse(localStorage.getItem('tv_announcements')||'[]'); } catch(e) {}
    var lastManifest2 = {}; try { lastManifest2 = JSON.parse(localStorage.getItem('tv_last_manifest')||'{}'); } catch(e) {}
    var lastHash2 = localStorage.getItem('tv_last_build_hash') || '';
    var lastVer2  = localStorage.getItem('tv_last_version')    || '';

    // Diff current vs stored manifest
    var oldPages2    = lastManifest2.pages    || [];
    var addedPages2  = APP_FEATURE_MANIFEST.pages.filter(function(p){ return oldPages2.indexOf(p)===-1; });
    var oldFeats2    = lastManifest2.features  || [];
    var addedFeats2  = APP_FEATURE_MANIFEST.features.filter(function(f){ return oldFeats2.indexOf(f)===-1; });
    var isCurrent    = lastHash2 === APP_BUILD_HASH;

    var statusCard =
      '<div class="card" style="margin-bottom:16px;padding:16px 20px;border:1px solid ' + (isCurrent?'rgba(0,229,176,0.3)':'rgba(255,138,0,0.4)') + ';background:' + (isCurrent?'rgba(0,229,176,0.05)':'rgba(255,138,0,0.05)') + '">' +
        '<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">' +
          '<div style="font-size:22px">' + (isCurrent?'âœ…':'ðŸŸ ') + '</div>' +
          '<div>' +
            '<div style="font-size:13px;font-weight:900">' + (isCurrent ? 'Up to date â€” users have the latest build' : 'New build detected â€” release notes not yet sent') + '</div>' +
            '<div style="font-size:11px;color:var(--muted)">Stored: <strong>' + (lastVer2||'none') + '</strong> Â· Current: <strong>' + APP_VERSION + '</strong> Â· Hash: <code style="font-size:10px">' + APP_BUILD_HASH + '</code></div>' +
          '</div>' +
        '</div>' +
        (addedPages2.length || addedFeats2.length
          ? '<div style="font-size:11px;color:var(--muted);margin-bottom:12px">'+
              (addedPages2.length?'<div>ðŸ“„ New pages: <strong>'+addedPages2.join(', ')+'</strong></div>':'') +
              (addedFeats2.length?'<div>âœ¨ New features: <strong>'+addedFeats2.slice(0,6).join(', ')+(addedFeats2.length>6?' +'+( addedFeats2.length-6)+' more':'')+'</strong></div>':'')+
            '</div>'
          : '<div style="font-size:11px;color:var(--muted);margin-bottom:12px">No manifest differences detected since last release.</div>')+
        '<button class="btn btn-primary" style="width:100%" onclick="adminRunRelease()" id="adminReleaseBtnMain">ðŸ¤– Generate AI Release Notes &amp; Broadcast Now</button>' +
      '</div>';

    var recentReleases = changelog.filter(function(c){ return c.autoGenerated; }).slice(0,5);
    var releaseRows = recentReleases.length === 0
      ? '<div style="text-align:center;padding:30px;color:var(--muted)"><div style="font-size:36px;margin-bottom:8px">ðŸš€</div>No auto-releases yet.<br>Hit the button above to generate your first one.</div>'
      : recentReleases.map(function(c) {
          var hlHtml = (c.highlights||[]).length
            ? '<ul style="margin:6px 0 0 14px;padding:0;font-size:11px;color:var(--muted);line-height:1.8">' +
                c.highlights.map(function(h){ return '<li>'+h+'</li>'; }).join('') +
              '</ul>'
            : '';
          return '<div class="card" style="margin-bottom:8px;padding:14px 16px">' +
            '<div style="display:flex;align-items:flex-start;gap:10px">' +
              '<div style="font-size:20px;flex-shrink:0">ðŸš€</div>' +
              '<div style="flex:1;min-width:0">' +
                '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">' +
                  '<span style="font-size:12px;font-weight:900;color:var(--teal)">' + (c.version||'') + '</span>' +
                  '<span style="font-size:10px;color:var(--muted)">' + (c.date||'') + '</span>' +
                  '<span style="font-size:9px;background:rgba(0,229,176,0.15);color:var(--teal);padding:1px 6px;border-radius:8px;font-weight:700">AI GENERATED</span>' +
                '</div>' +
                '<div style="font-size:12px;line-height:1.5">' + (c.note||'') + '</div>' +
                hlHtml +
              '</div>' +
            '</div>' +
          '</div>';
        }).join('');

    var sentRows = announcements2.filter(function(a){ return a.autoRelease; }).slice(0,5).map(function(a) {
      return '<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px">' +
        '<span style="font-size:16px">ðŸ“¢</span>' +
        '<div style="flex:1"><strong>' + (a.title||'') + '</strong><br>' +
          '<span style="font-size:11px;color:var(--muted)">' + new Date(a.at).toLocaleString('en-GB') + ' Â· v' + (a.version||'') + '</span>' +
        '</div>' +
        '<span style="font-size:10px;background:rgba(0,229,176,0.12);color:var(--teal);padding:2px 8px;border-radius:8px;font-weight:700">SENT âœ“</span>' +
      '</div>';
    }).join('') || '<div style="font-size:12px;color:var(--muted);padding:12px 0">No broadcasts sent yet.</div>';

    content =
      '<div style="font-family:var(--font-display);font-size:16px;font-weight:900;margin-bottom:4px">ðŸš€ Release Manager</div>' +
      '<div style="font-size:12px;color:var(--muted);margin-bottom:16px">Compare builds, generate AI release notes, and broadcast updates to all users.</div>' +
      statusCard +
      '<div class="card" style="margin-bottom:14px">' +
        '<div style="font-size:12px;font-weight:700;color:var(--muted);margin-bottom:10px">RECENT AUTO-RELEASES</div>' +
        releaseRows +
      '</div>' +
      '<div class="card">' +
        '<div style="font-size:12px;font-weight:700;color:var(--muted);margin-bottom:10px">BROADCAST HISTORY</div>' +
        sentRows +
      '</div>';
  }

  
  if(tab==='aibuilder') {
    content = _adminAIBuilderContent();
  }

  if(tab==='aitools') {
    content = _adminAIToolsContent();
  }

  if(tab==='health') {
    content = _adminHealthCheckerContent();
  }

  if(tab==='selfheal') {
    // Pull live data from tvSelfHeal public API if available
    var shLog = (window.tvSelfHeal && typeof window.tvSelfHeal.log === 'function') ? window.tvSelfHeal.log() : [];
    var shFixes = (window.tvSelfHeal && typeof window.tvSelfHeal.fixes === 'function') ? window.tvSelfHeal.fixes() : 0;
    // Persist total fixes so badge counter can read it
    try { localStorage.setItem('tv_selfheal_total_fixed', String(shFixes)); } catch(e) {}

    var agentMeta = {
      btn:  { icon:'ðŸ”§', color:'#00e5b0', label:'Button Fixer',   desc:'Detects broken onclick handlers & regenerates missing functions.' },
      perf: { icon:'âš¡', color:'#a78bfa', label:'Perf Monitor',   desc:'Watches for slow renders, excessive DOM nodes & memory leaks.' },
      ls:   { icon:'ðŸ’¾', color:'#fbbf24', label:'Storage Guard',  desc:'Validates localStorage data integrity & auto-repairs corrupt JSON.' },
      ui:   { icon:'ðŸŽ¨', color:'#f472b6', label:'UI Doctor',      desc:'Detects broken layouts, invisible text & missing styles.' },
      nav:  { icon:'ðŸ§­', color:'#60a5fa', label:'Nav Watchdog',   desc:'Ensures all nav links resolve to valid pages.' },
      err:  { icon:'ðŸ›¡ï¸', color:'#fb923c', label:'Error Shield',  desc:'Intercepts console errors & unhandled rejections, patches proactively.' }
    };

    var agentCards = Object.keys(agentMeta).map(function(id) {
      var m = agentMeta[id];
      return '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:6px;">' +
        '<div style="display:flex;align-items:center;gap:8px;">' +
          '<span style="font-size:22px;">' + m.icon + '</span>' +
          '<div>' +
            '<div style="font-family:var(--font-display);font-size:13px;font-weight:800;color:' + m.color + ';">' + m.label + '</div>' +
            '<div style="font-size:10px;color:var(--muted);">' + m.desc + '</div>' +
          '</div>' +
        '</div>' +
        '<button onclick="window.tvSelfHeal&&window.tvSelfHeal.agents[\'' + id + '\']&&window.tvSelfHeal.agents[\'' + id + '\']().then(function(){window._adminTab=\'selfheal\';renderAdmin();})" ' +
          'style="background:rgba(255,255,255,0.05);border:1px solid var(--border2);color:var(--text2);padding:5px 10px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;width:100%;transition:all 0.15s;" ' +
          'onmouseover="this.style.borderColor=\'' + m.color + '\';this.style.color=\'' + m.color + '\'" ' +
          'onmouseout="this.style.borderColor=\'var(--border2)\';this.style.color=\'var(--text2)\'">' +
          'â–¶ Run Now' +
        '</button>' +
      '</div>';
    }).join('');

    var logRows = shLog.length ? shLog.slice().reverse().map(function(e) {
      var m = agentMeta[e.agent] || { icon:'ðŸ”¹', color:'#a78bfa' };
      var col = e.type==='fix' ? '#00e5b0' : e.type==='error' ? '#ff3058' : e.type==='warn' ? '#fbbf24' : m.color;
      return '<tr style="border-bottom:1px solid var(--border);">' +
        '<td style="padding:8px 6px;font-size:16px;">' + m.icon + '</td>' +
        '<td style="padding:8px 6px;"><span style="color:' + col + ';font-weight:700;font-size:11px;">' + (e.label||'') + '</span>' +
          '<div style="color:var(--muted);font-size:10px;">' + (e.detail||'') + '</div></td>' +
        '<td style="padding:8px 6px;font-size:10px;color:var(--muted);white-space:nowrap;">' + (e.time||'') + '</td>' +
        '<td style="padding:8px 6px;">' +
          '<span style="font-size:10px;background:' + (e.type==='fix'?'rgba(0,229,176,0.12)':e.type==='error'?'rgba(255,48,88,0.12)':'rgba(255,255,255,0.06)') + ';' +
            'color:' + col + ';padding:2px 8px;border-radius:6px;font-weight:800;">' + (e.type||'info').toUpperCase() + '</span></td>' +
      '</tr>';
    }).join('') : '<tr><td colspan="4" style="padding:24px;text-align:center;color:var(--muted);font-size:12px;">All agents monitoring... no events yet. ðŸ‘€</td></tr>';

    content =
      '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">' +
        '<div>' +
          '<div style="font-family:var(--font-display);font-size:22px;font-weight:900;background:linear-gradient(135deg,#00e5b0,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">ðŸ¤– AI Self-Heal Engine</div>' +
          '<div style="font-size:12px;color:var(--muted);margin-top:3px;">6 autonomous agents continuously monitor & auto-repair the app for every user</div>' +
        '</div>' +
        '<div style="display:flex;gap:8px;align-items:center;">' +
          '<div style="background:rgba(0,229,176,0.1);border:1px solid rgba(0,229,176,0.3);border-radius:12px;padding:8px 16px;text-align:center;">' +
            '<div style="font-family:var(--font-display);font-size:24px;font-weight:900;color:#00e5b0;">' + shFixes + '</div>' +
            '<div style="font-size:10px;color:var(--muted);font-weight:700;">TOTAL FIXED</div>' +
          '</div>' +
          '<button onclick="if(window.tvSelfHeal){window.tvSelfHeal.agents.btn();window.tvSelfHeal.agents.err();window.tvSelfHeal.agents.nav();window.tvSelfHeal.agents.ui();} setTimeout(function(){window._adminTab=\'selfheal\';renderAdmin();},2000);" ' +
            'style="background:linear-gradient(135deg,#00e5b0,#a78bfa);border:none;color:#000;padding:10px 18px;border-radius:12px;font-weight:900;font-size:12px;cursor:pointer;font-family:var(--font-display);">ðŸ”„ Run All Agents</button>' +
        '</div>' +
      '</div>' +
      // Stats row
      '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px;">' +
        '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:14px;text-align:center;">' +
          '<div style="font-size:28px;font-weight:900;font-family:var(--font-display);color:var(--teal);">6</div>' +
          '<div style="font-size:11px;color:var(--muted);font-weight:700;">ACTIVE AGENTS</div>' +
        '</div>' +
        '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:14px;text-align:center;">' +
          '<div style="font-size:28px;font-weight:900;font-family:var(--font-display);color:var(--gold);">' + shLog.filter(function(e){return e.type==='fix';}).length + '</div>' +
          '<div style="font-size:11px;color:var(--muted);font-weight:700;">PATCHES APPLIED</div>' +
        '</div>' +
        '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:14px;text-align:center;">' +
          '<div style="font-size:28px;font-weight:900;font-family:var(--font-display);color:var(--accent);">' + shLog.filter(function(e){return e.type==='error';}).length + '</div>' +
          '<div style="font-size:11px;color:var(--muted);font-weight:700;">ERRORS CAUGHT</div>' +
        '</div>' +
      '</div>' +
      // Agent grid
      '<div style="font-family:var(--font-display);font-size:11px;font-weight:900;letter-spacing:2px;color:var(--muted);margin-bottom:10px;">AGENTS</div>' +
      '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:24px;">' + agentCards + '</div>' +
      // Log table
      '<div style="font-family:var(--font-display);font-size:11px;font-weight:900;letter-spacing:2px;color:var(--muted);margin-bottom:10px;">ACTIVITY LOG</div>' +
      '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:14px;overflow:hidden;">' +
        '<table style="width:100%;border-collapse:collapse;">' +
          '<thead><tr style="border-bottom:1px solid var(--border);background:var(--surface);">' +
            '<th style="padding:8px 6px;text-align:left;font-size:10px;color:var(--muted);font-weight:900;letter-spacing:1px;width:28px;"></th>' +
            '<th style="padding:8px 6px;text-align:left;font-size:10px;color:var(--muted);font-weight:900;letter-spacing:1px;">EVENT</th>' +
            '<th style="padding:8px 6px;text-align:left;font-size:10px;color:var(--muted);font-weight:900;letter-spacing:1px;">TIME</th>' +
            '<th style="padding:8px 6px;text-align:left;font-size:10px;color:var(--muted);font-weight:900;letter-spacing:1px;">TYPE</th>' +
          '</tr></thead>' +
          '<tbody>' + logRows + '</tbody>' +
        '</table>' +
      '</div>' +
      // How it works info
      '<div style="margin-top:20px;background:rgba(0,229,176,0.05);border:1px solid rgba(0,229,176,0.15);border-radius:14px;padding:16px;">' +
        '<div style="font-family:var(--font-display);font-size:12px;font-weight:900;color:var(--teal);margin-bottom:8px;">â„¹ï¸ HOW IT WORKS</div>' +
        '<div style="font-size:12px;color:var(--text2);line-height:1.7;">' +
          'The Self-Heal Engine runs silently in the background for <strong>every user</strong>. When it detects a broken button, corrupt storage, layout issue, or unhandled error, it uses AI to generate and apply a JavaScript patch automatically â€” no reload needed. ' +
          'The ðŸ¤– orb in the bottom-right corner pulses when agents are working and turns âœ… when a fix is applied. Regular users see a status toast on click; only admins can access this detailed panel.' +
        '</div>' +
      '</div>';
  }
    '<div style="display:flex;gap:0;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;min-height:600px;">'+
      sidebarHTML+
      '<div style="flex:1;padding:20px;overflow-y:auto;min-width:0;">'+
        content+
      '</div>'+
    '</div>';

  if(tab==='broadcast') { setTimeout(function(){ adminSelectBroadcastType('info'); },50); }
}

// â”€â”€ Auto-Upload helpers â”€â”€

function adminToggleAutoUploadPlatform(cb) {
  // Find platform id from nearest data attribute or parent
  var card = cb.closest('[data-platform-id]');
  var pid = card ? card.dataset.platformId : null;
  if(pid && typeof adminToggleAutoUpload === 'function') adminToggleAutoUpload(pid, cb.checked);
}


function adminToggleAutoUpload(platformId, enabled) {
  var auCfg = {}; try { auCfg = JSON.parse(localStorage.getItem('tv_autoupload_cfg') || '{}'); } catch(e) {}
  if(!auCfg[platformId]) auCfg[platformId] = {};
  auCfg[platformId].connected = enabled;
  localStorage.setItem('tv_autoupload_cfg', JSON.stringify(auCfg));
  notify((enabled ? 'âœ… ' : 'âš ï¸ ') + platformId + ' auto-upload ' + (enabled ? 'enabled' : 'disabled'), enabled ? 'success' : 'info', 'ðŸ“¤');
}
function adminSaveAutoUploadPlatform(platformId) {
  var auCfg = {}; try { auCfg = JSON.parse(localStorage.getItem('tv_autoupload_cfg') || '{}'); } catch(e) {}
  if(!auCfg[platformId]) auCfg[platformId] = {};
  var keyEl = document.getElementById('au_key_' + platformId);
  var cidEl = document.getElementById('au_cid_' + platformId);
  if(keyEl) auCfg[platformId].apiKey = keyEl.value;
  if(cidEl) auCfg[platformId].clientId = cidEl.value;
  localStorage.setItem('tv_autoupload_cfg', JSON.stringify(auCfg));
  // If YouTube Client ID was updated, sync the live variable immediately
  if(platformId === 'youtube' && cidEl && cidEl.value.trim()) {
    YT_CLIENT_ID = cidEl.value.trim();
    _ytTokenClient = null; // force re-init with new client ID
  }
  notify('âœ… ' + platformId + ' credentials saved', 'success', 'ðŸ’¾');
}
function adminTestAutoUpload(platformId, platformLabel) {
  var auCfg = {}; try { auCfg = JSON.parse(localStorage.getItem('tv_autoupload_cfg') || '{}'); } catch(e) {}
  var cfg = auCfg[platformId] || {};
  if(!cfg.apiKey) { notify('No API key set for ' + platformLabel, 'error', 'âš ï¸'); return; }
  notify('ðŸ§ª Testing ' + platformLabel + ' connectionâ€¦ (simulated OK)', 'success', 'ðŸ“¤');
  try {
    var notifs = JSON.parse(localStorage.getItem('tv_admin_notifs') || '[]');
    notifs.unshift({type:'autoupload_test', icon:'ðŸ“¤', title:'Auto-Upload Test', body:platformLabel + ' connection test passed', at:Date.now(), read:false});
    localStorage.setItem('tv_admin_notifs', JSON.stringify(notifs.slice(0,100)));
  } catch(e) {}
}
function adminSaveAutoUploadSettings() {
  var auCfg = {}; try { auCfg = JSON.parse(localStorage.getItem('tv_autoupload_cfg') || '{}'); } catch(e) {}
  var timeEl = document.getElementById('au_default_time');
  var privEl = document.getElementById('au_default_privacy');
  var notifyEl = document.getElementById('au_notify');
  var limitEl = document.getElementById('au_daily_limit');
  if(limitEl) auCfg.dailyLimit = parseInt(limitEl.value) || 2;
  if(timeEl) auCfg.defaultTime = timeEl.value;
  if(privEl) auCfg.defaultPrivacy = privEl.value;
  if(notifyEl) auCfg.notifyAdmin = notifyEl.checked;
  localStorage.setItem('tv_autoupload_cfg', JSON.stringify(auCfg));
  notify('Auto-upload settings saved', 'success', 'âš™ï¸');
}
function adminRemoveUploadQueue(index) {
  var auCfg = {}; try { auCfg = JSON.parse(localStorage.getItem('tv_autoupload_cfg') || '{}'); } catch(e) {}
  if(auCfg.queue && auCfg.queue[index]) {
    auCfg.queue.splice(index, 1);
    localStorage.setItem('tv_autoupload_cfg', JSON.stringify(auCfg));
    notify('Removed from queue', 'info', 'ðŸ—‘ï¸');
    renderAdmin();
  }
}

// â”€â”€ Helper: admin toggle feature flag â”€â”€
function adminToggleFlag(id, val) {
  var flags = {}; try { flags = JSON.parse(localStorage.getItem('tv_feature_flags')||'{}'); } catch(e) {}
  flags[id] = val;
  localStorage.setItem('tv_feature_flags', JSON.stringify(flags));
  renderAdmin();
  notify('Flag "'+id+'" set to '+(val?'ON':'OFF'),'success','ðŸš©');
}
function resetFeatureFlags() {
  if(!confirm('Reset all feature flags to defaults?')) return;
  localStorage.removeItem('tv_feature_flags');
  renderAdmin();
  notify('Feature flags reset','success','ðŸš©');
}

// â”€â”€ Helper: admin save config â”€â”€
function adminSaveConfig() {
  var appCfg = {
    appName: (document.getElementById('cfg_appName')||{}).value||'TrendVid AI',
    tagline: (document.getElementById('cfg_tagline')||{}).value||'AI Content Studio',
    supportEmail: (document.getElementById('cfg_supportEmail')||{}).value||'',
    freeScans: (document.getElementById('cfg_freeScans')||{}).value||'5',
    freeCredits: (document.getElementById('cfg_freeCredits')||{}).value||'3',
    maxFreeScripts: (document.getElementById('cfg_maxFreeScripts')||{}).value||'3',
    aiRateLimit: (document.getElementById('cfg_aiRateLimit')||{}).value||'60',
    maintenanceMsg: (document.getElementById('cfg_maintenanceMsg')||{}).value||'',
  };
  localStorage.setItem('tv_app_config', JSON.stringify(appCfg));
  notify('Configuration saved!','success','âš™ï¸');
}

// â”€â”€ Helper: admin save stripe â”€â”€
function adminSaveStripe() {
  var g = function(id){ return (document.getElementById(id)||{}).value||''; };
  var stripe = {
    publishableKey: g('stripe_pk'),
    webhookSecret:  g('stripe_wh'),
    creditLink:     g('stripe_credit_link'),
    creditLink1:    g('stripe_credit_link1'),
    creditLink10:   g('stripe_credit_link10'),
    creditLink25:   g('stripe_credit_link25'),
    links: {
      starter:         g('stripe_link_starter'),
      pro:             g('stripe_link_pro'),
      gold:            g('stripe_link_gold'),
      elite:           g('stripe_link_elite'),
      starter_annual:  g('stripe_link_starter_annual'),
      pro_annual:      g('stripe_link_pro_annual'),
      gold_annual:     g('stripe_link_gold_annual'),
      elite_annual:    g('stripe_link_elite_annual'),
    }
  };
  localStorage.setItem('tv_stripe_cfg', JSON.stringify(stripe));
  var isTest = stripe.publishableKey.startsWith('pk_test');
  var isLive = stripe.publishableKey.startsWith('pk_live');
  if(isTest)  notify('Stripe test mode saved. Use pk_live_ to go live.','info','&#9888;&#65039;');
  else if(isLive) notify('&#128994; Stripe LIVE config saved! Real payments are now active.','success','&#128994;');
  else notify('Stripe config saved (no key â€” demo mode).','info','&#128315;');
  // Refresh test-mode banner
  var oldBanner = document.getElementById('_stripeTestBanner');
  if (oldBanner) { oldBanner.remove(); var app=document.querySelector('.app'); if(app) app.style.paddingTop=''; }
  if (typeof window._showStripeTestBanner === 'function') setTimeout(window._showStripeTestBanner, 300);
  renderAdmin();
}

// â”€â”€ Helper: admin changelog â”€â”€
function adminAddChangelogEntry() {
  var el = document.getElementById('changelogEntryForm');
  if(el) el.style.display = el.style.display==='none' ? '' : 'none';
}

async function adminRunRelease() {
  var btn = document.getElementById('adminReleaseBtnMain');
  if(btn) { btn.disabled = true; btn.textContent = 'â³ AI is writing release notesâ€¦'; }
  localStorage.removeItem('tv_last_build_hash');
  localStorage.removeItem('tv_last_manifest');
  localStorage.removeItem('tv_user_saw_version');
  try {
    var data = await checkForAppUpdate();
    notify('ðŸš€ Release notes generated and broadcast to all users!', 'success', 'âœ…');
    setTimeout(function() {
      window._adminTab = 'releasemanager';
      renderAdmin();
    }, 800);
  } catch(e) {
    notify('Release failed: ' + (e.message||'AI error'), 'error', 'âŒ');
    if(btn) { btn.disabled = false; btn.textContent = 'ðŸ¤– Generate AI Release Notes & Broadcast Now'; }
  }
}


async function adminManualUpdateCheck() {
  notify('ðŸ”„ Forcing update check â€” AI is writing release notesâ€¦', 'info', 'ðŸ¤–');
  localStorage.removeItem('tv_last_build_hash');
  localStorage.removeItem('tv_last_manifest');
  localStorage.removeItem('tv_user_saw_version');
  try {
    var data = await checkForAppUpdate();
    notify('âœ… Release notes generated and broadcast to all users!', 'success', 'ðŸš€');
    setTimeout(function() {
      window._adminTab = 'changelog';
      renderAdmin();
    }, 800);
  } catch(e) {
    notify('Update check failed: ' + (e.message || 'AI error'), 'error', 'âŒ');
  }
}

function adminSaveChangelog() {
  var version = (document.getElementById('cl_version')||{}).value||'';
  var date = (document.getElementById('cl_date')||{}).value||'';
  var type = (document.getElementById('cl_type')||{}).value||'feature';
  var note = (document.getElementById('cl_note')||{}).value||'';
  if(!version||!note) { notify('Fill in version and note','error','âš ï¸'); return; }
  var changelog = []; try { changelog = JSON.parse(localStorage.getItem('tv_changelog')||'[]'); } catch(e) {}
  changelog.unshift({version,date,type,note,at:Date.now()});
  localStorage.setItem('tv_changelog', JSON.stringify(changelog));
  renderAdmin();
  notify('Changelog entry added!','success','ðŸ“');
}

// â”€â”€ Helper: inline plan change from users table â”€â”€
function adminChangePlanInline(email, plan) {
  if(!plan) return;
  var users = []; try { users = JSON.parse(localStorage.getItem('tv_all_users')||'[]'); } catch(e) {}
  var user = users.find(function(u){return u.email===email;});
  if(!user) { notify('User not found','error','âš ï¸'); return; }
  user.plan = plan;
  localStorage.setItem('tv_all_users', JSON.stringify(users));
  // Also log the activity
  adminLogActivity('âœï¸', email, 'Plan changed to '+plan+' by admin');
  notify(email+' â†’ '+plan.toUpperCase(),'success','âœï¸');
  renderAdmin();
}

// â”€â”€ Helper: log activity â”€â”€
function adminLogActivity(icon, user, action) {
  var log = []; try { log = JSON.parse(localStorage.getItem('tv_activity_log')||'[]'); } catch(e) {}
  log.unshift({icon:icon, user:user, action:action, type:'admin', at:Date.now()});
  localStorage.setItem('tv_activity_log', JSON.stringify(log.slice(0,500)));
}

// â”€â”€ Extracted tab content helpers (keep existing logic, just factored out) â”€â”€
function _adminBroadcastContent(announcements) {
  var types = [{id:'info',icon:'ðŸ“Œ',label:'Info',color:'var(--purple)'},{id:'success',icon:'âœ…',label:'Success',color:'var(--teal)'},{id:'alert',icon:'âš ï¸',label:'Alert',color:'var(--accent)'}];
  return '<div style="font-size:14px;font-weight:800;margin-bottom:4px">Broadcast Announcement</div>'+
    '<div style="font-size:12px;color:var(--muted);margin-bottom:16px">Post a banner that all users see on their dashboard</div>'+
    '<div class="card" style="margin-bottom:14px">'+
      '<div class="form-field"><label>TYPE</label><div style="display:flex;gap:8px">'+
        types.map(function(t){return '<button class="btn btn-sm btn-ghost" id="bcast_'+t.id+'" style="border-radius:8px" onclick="adminSelectBroadcastType(\''+t.id+'\')">'+t.icon+' '+t.label+'</button>';}).join('')+
      '</div></div>'+
      '<div class="form-field"><label>TITLE</label><input class="form-input" id="broadcastTitle" placeholder="e.g. New Feature Alert!"></div>'+
      '<div class="form-field"><label>MESSAGE</label><textarea class="form-input" id="broadcastMsg" rows="3" placeholder="Full announcement text..."></textarea></div>'+
      '<button class="btn btn-primary" onclick="adminSendBroadcast()">ðŸ“¢ Post Announcement</button>'+
    '</div>'+
    '<div class="card">'+
      '<div style="font-size:12px;font-weight:800;margin-bottom:12px;color:var(--text2)">ACTIVE ANNOUNCEMENTS ('+announcements.length+')</div>'+
      (announcements.length===0?'<div style="color:var(--muted);font-size:13px;text-align:center;padding:20px">No announcements posted</div>':
      announcements.slice(0,5).map(function(a,i){
        var col = {info:'var(--purple)',success:'var(--teal)',alert:'var(--accent)'}[a.type]||'var(--purple)';
        return '<div style="display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">'+
          '<span style="font-size:18px">'+(a.type==='success'?'âœ…':a.type==='alert'?'âš ï¸':'ðŸ“Œ')+'</span>'+
          '<div style="flex:1"><div style="font-size:12px;font-weight:700;color:'+col+'">'+a.title+'</div><div style="font-size:11px;color:var(--text2)">'+a.message+'</div><div style="font-size:10px;color:var(--muted)">'+adminTimeAgo(a.at)+'</div></div>'+
          '<button class="btn btn-ghost btn-sm" style="font-size:10px;color:var(--accent)" onclick="adminDeleteAnnouncement(&quot;+i+&quot;)">ðŸ—‘ï¸</button>'+
        '</div>';
      }).join(''))+
    '</div>';
}

function _adminWeeklyContent(users) {
  var weeklyLog = []; try { weeklyLog = JSON.parse(localStorage.getItem('tv_weekly_log')||'[]'); } catch(e) {}
  var optinUsers = users.filter(function(u){return u.weeklyReports!==false;});
  var lastSent = weeklyLog.length>0 ? weeklyLog[0].at : null;
  var lastSentStr = lastSent ? adminTimeAgo(lastSent) : 'Never';
  var nextSend = new Date(); nextSend.setDate(nextSend.getDate()+(7-nextSend.getDay()+1)%7||7);
  return '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">'+
    adminStat('ðŸ“§ Opted In',optinUsers.length,'var(--teal)')+
    adminStat('ðŸ“¬ Emails Sent',weeklyLog.reduce(function(s,l){return s+l.count;},0),'var(--accent)')+
    adminStat('ðŸ“… Last Sent',lastSentStr,'var(--purple)')+
  '</div>'+
  '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">'+
    '<div class="card">'+
      '<div style="font-size:12px;font-weight:800;margin-bottom:12px;color:var(--text2)">SEND CONTROLS</div>'+
      '<div class="form-field"><label>NICHE FOCUS (optional)</label><input class="form-input" id="weeklyNiche" placeholder="Tech, Finance, Fitness..."></div>'+
      '<div style="display:flex;flex-direction:column;gap:8px">'+
        '<button class="btn btn-primary" onclick="adminSendWeeklyEmails()">ðŸ“§ Send to '+optinUsers.length+' users</button>'+
        '<button class="btn btn-secondary btn-sm" onclick="adminPreviewWeeklyEmail()">ðŸ‘ Preview Email</button>'+
      '</div>'+
    '</div>'+
    '<div class="card">'+
      '<div style="font-size:12px;font-weight:800;margin-bottom:12px;color:var(--text2)">OPTED-IN RECIPIENTS</div>'+
      (optinUsers.length===0?'<div style="color:var(--muted);font-size:13px">No opted-in users</div>':
      optinUsers.slice(0,8).map(function(u){return '<div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--border)"><span style="font-size:12px">'+(u.name||u.email)+'</span><span class="tier-badge tier-'+(u.plan||'free')+'" style="font-size:8px">'+(u.plan||'free').toUpperCase()+'</span></div>';}).join('')+
      (optinUsers.length>8?'<div style="font-size:11px;color:var(--muted);margin-top:6px">...and '+(optinUsers.length-8)+' more</div>':''))+
    '</div>'+
  '</div>';
}

function _adminCodesContent(gifts) {
  var rows = gifts.length===0?'<tr><td colspan="5" style="padding:20px;text-align:center;color:var(--muted)">No codes yet</td></tr>':
    gifts.slice(0,30).map(function(g){
      return '<tr style="border-bottom:1px solid var(--border)">'+
        '<td style="padding:8px 10px;font-family:monospace;font-size:11px;color:var(--teal)">'+g.code+'</td>'+
        '<td style="padding:8px 10px"><span class="tier-badge tier-'+(g.tier||'pro')+'" style="font-size:9px">'+(g.tier||'pro').toUpperCase()+'</span></td>'+
        '<td style="padding:8px 10px"><span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;'+(g.used?'background:rgba(255,48,88,0.1);color:var(--accent)':'background:rgba(0,229,176,0.1);color:var(--teal)')+'">'+( g.used?'USED':'ACTIVE')+'</span></td>'+
        '<td style="padding:8px 10px;font-size:11px;color:var(--muted)">'+(g.usedBy||'â€”')+'</td>'+
        '<td style="padding:8px 10px"><button class="btn btn-ghost btn-sm" style="font-size:10px" onclick="safeCopy(\&quot;&quot;+g.code+&quot;\&quot;,\&quot;Copied!\&quot;,\&quot;ðŸ“‹\&quot;)">Copy</button></td>'+
      '</tr>';
    }).join('');
  return '<div style="font-size:14px;font-weight:800;margin-bottom:16px">Gift Codes</div>'+
    '<div class="card" style="margin-bottom:14px">'+
      '<div style="font-size:12px;font-weight:800;margin-bottom:12px;color:var(--text2)">GENERATE CODE</div>'+
      '<div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">'+
        '<div class="form-field" style="margin:0;flex:1;min-width:120px"><label>PLAN</label><select class="form-input form-select" id="gcTierAdmin"><option value="starter">Starter</option><option value="pro" selected>Pro</option><option value="gold">Gold</option><option value="elite">Elite</option></select></div>'+
        '<div class="form-field" style="margin:0;width:80px"><label>QTY</label><input type="number" class="form-input" id="gcQty" value="1" min="1" max="50" style="text-align:center;"></div>'+
        '<button class="btn btn-gold" onclick="adminGenerateCode()">âš¡ Generate & Copy</button>'+
        '<button class="btn btn-ghost btn-sm" onclick="adminClearUnusedCodes()">ðŸ—‘ï¸ Clear Used</button>'+
      '</div>'+
    '</div>'+
    '<div class="card">'+
      '<div style="font-size:12px;font-weight:800;margin-bottom:12px;color:var(--text2)">ALL CODES ('+gifts.length+')</div>'+
      '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px">'+
        '<thead><tr style="border-bottom:1px solid var(--border)">'+
          '<th style="padding:8px 10px;text-align:left;color:var(--muted);font-size:10px;font-weight:900;font-family:var(--font-display)">CODE</th>'+
          '<th style="padding:8px 10px;text-align:left;color:var(--muted);font-size:10px;font-weight:900;font-family:var(--font-display)">PLAN</th>'+
          '<th style="padding:8px 10px;text-align:left;color:var(--muted);font-size:10px;font-weight:900;font-family:var(--font-display)">STATUS</th>'+
          '<th style="padding:8px 10px;text-align:left;color:var(--muted);font-size:10px;font-weight:900;font-family:var(--font-display)">USED BY</th>'+
          '<th style="padding:8px 10px"></th>'+
        '</tr></thead>'+
        '<tbody>'+rows+'</tbody>'+
      '</table></div>'+
    '</div>';
}

function _adminReportsContent(reports) {
  return '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">'+
    '<div><div style="font-size:14px;font-weight:800">Bug Reports</div><div style="font-size:12px;color:var(--muted)">'+reports.length+' report'+( reports.length!==1?'s':'')+' from users</div></div>'+
    '<button class="btn btn-ghost btn-sm" onclick="if(confirm(\&quot;Clear all reports?\&quot;)){localStorage.removeItem(\&quot;tv_reports\&quot;);renderAdmin();}">ðŸ—‘ï¸ Clear All</button>'+
  '</div>'+
  (reports.length===0?'<div class="card" style="text-align:center;padding:40px;color:var(--muted)">No bug reports yet ðŸŽ‰</div>':
  reports.map(function(r,i){
    return '<div class="card" style="margin-bottom:10px">'+
      '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:8px">'+
        '<div style="display:flex;align-items:center;gap:8px">'+
          '<span style="font-size:18px">'+({ai_wrong:'ðŸ¤–',ai_down:'âš¡',ui_bug:'ðŸ–¥ï¸',feature_broken:'ðŸ”§',other:'ðŸ“Œ'}[r.type]||'ðŸ“Œ')+'</span>'+
          '<div><div style="font-size:12px;font-weight:700">'+(r.type||'other').replace('_',' ')+'</div><div style="font-size:11px;color:var(--muted)">'+r.user+' Â· '+(r.plan||'free').toUpperCase()+'</div></div>'+
        '</div>'+
        '<div style="display:flex;align-items:center;gap:6px">'+
          '<span style="font-size:10px;color:var(--muted)">'+adminTimeAgo(new Date(r.at).getTime())+'</span>'+
          '<button class="btn btn-ghost btn-sm" style="font-size:10px;color:var(--accent)" onclick="adminDismissReport(&quot;+i+&quot;)">Dismiss</button>'+
        '</div>'+
      '</div>'+
      '<div style="font-size:13px;color:var(--text2);line-height:1.55;background:var(--surface2);padding:10px 12px;border-radius:9px">'+r.desc+'</div>'+
      (r.email?'<div style="font-size:11px;color:var(--muted);margin-top:6px">Reply to: '+r.email+'</div>':'')+
    '</div>';
  }).join(''));
}

function _adminAPIKeysContent() {
  // Render a loading shell â€” keys are async decrypted and injected after
  var forced = localStorage.getItem('tv_admin_forced_key') || '';
  var html = '<div style="padding:24px;max-width:800px" id="_apiKeyPanel">';
  html += '<h2 style="font-family:var(--font-display);font-size:20px;font-weight:900;color:var(--gold);margin-bottom:4px">ðŸ”‘ API Key Manager</h2>';
  html += '<p style="font-size:12px;color:var(--muted);margin-bottom:20px">Keys are AES-256-GCM encrypted. Select which key to force, or leave on Auto to rotate across all. Admin keys are exclusive to your account.</p>';

  html += '<div style="background:linear-gradient(135deg,rgba(0,229,176,0.08),rgba(0,229,176,0.04));border:1px solid rgba(0,229,176,0.2);border-radius:12px;padding:10px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px">';
  html += '<span style="font-size:16px">ðŸ”’</span><span style="font-size:12px;color:var(--teal);font-weight:700">All keys encrypted with AES-256-GCM â€” plaintext never stored in source</span>';
  html += '</div>';

  html += '<div style="background:linear-gradient(135deg,rgba(251,191,36,0.08),rgba(255,138,0,0.05));border:1px solid rgba(251,191,36,0.25);border-radius:14px;padding:16px 20px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;gap:16px">';
  html += '<div><div style="font-family:var(--font-display);font-size:13px;font-weight:800;color:var(--gold)">ðŸ”„ AUTO â€” Rotate All Keys</div>';
  html += '<div style="font-size:11px;color:var(--muted);margin-top:2px">Randomly spreads load across all 13 encrypted keys</div></div>';
  html += '<button onclick="localStorage.removeItem(&quot;tv_admin_forced_key&quot;);window._adminTab=&quot;apikeys&quot;;renderAdmin()" style="background:'+(forced===''?'var(--teal)':'rgba(255,255,255,0.08)')+';border:1px solid '+(forced===''?'var(--teal)':'var(--border2)')+';color:'+(forced===''?'#000':'var(--text2)')+';padding:7px 18px;border-radius:9px;font-weight:800;font-size:12px;cursor:pointer;font-family:var(--font-display)">'+(forced===''?'âœ“ ACTIVE':'Set Auto')+'</button>';
  html += '</div>';

  html += '<div id="_apiKeyList" style="display:grid;gap:10px"><div style="text-align:center;padding:30px;color:var(--muted);font-size:13px">ðŸ”“ Decrypting keysâ€¦</div></div>';

  html += '<div style="margin-top:20px;background:rgba(255,48,88,0.05);border:1px solid rgba(255,48,88,0.2);border-radius:12px;padding:14px 18px">';
  html += '<div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:4px">âš ï¸ Security Note</div>';
  html += '<div style="font-size:11px;color:var(--muted);line-height:1.6">Keys are encrypted with AES-256-GCM. Even if someone views source, they cannot use the keys without the embedded decryption logic running in-browser. Rotate at <a href="https://console.groq.com/keys" target="_blank" style="color:var(--teal)">console.groq.com/keys</a> if compromised.</div>';
  html += '</div>';
  html += '</div>';

  // Async: decrypt all keys and render the list
  setTimeout(async function() {
    var listEl = document.getElementById('_apiKeyList');
    if (!listEl) return;
    try {
      var isAdmin = !!(currentUser && currentUser.isAdmin);
      var shared = await _KV.getSharedPool();
      var admins = isAdmin ? await _KV.getAdminPool() : [];
      var forced2 = localStorage.getItem('tv_admin_forced_key') || '';
      var allKeys = [];
      shared.forEach(function(k,i){ allKeys.push({label:'Shared Key '+(i+1), key:k, admin:false}); });
      admins.forEach(function(k,i){ allKeys.push({label:'Admin Key '+(i+1), key:k, admin:true}); });
      var listHtml = '';
      allKeys.forEach(function(k) {
        if (!k.key) return;
        var isActive = forced2 === k.key;
        var masked = 'gsk_' + 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' + k.key.slice(-6);
        var adminBadge = k.admin
          ? '<span style="background:rgba(192,132,252,0.15);border:1px solid rgba(192,132,252,0.4);color:#c084fc;font-size:9px;font-weight:900;padding:2px 7px;border-radius:6px;font-family:var(--font-display)">ADMIN ONLY</span>'
          : '<span style="background:rgba(0,229,176,0.1);border:1px solid rgba(0,229,176,0.25);color:var(--teal);font-size:9px;font-weight:900;padding:2px 7px;border-radius:6px;font-family:var(--font-display)">SHARED</span>';
        listHtml += '<div style="background:'+(isActive?'linear-gradient(135deg,rgba(0,229,176,0.08),rgba(0,229,176,0.03))':'var(--surface)')+';border:'+(isActive?'1px solid rgba(0,229,176,0.4)':'1px solid var(--border)')+';border-radius:12px;padding:14px 18px;display:flex;align-items:center;gap:14px">';
        listHtml += '<div style="flex:1;min-width:0">';
        listHtml += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px"><span style="font-family:var(--font-display);font-size:13px;font-weight:800;color:'+(isActive?'var(--teal)':'var(--text)')+'">'+k.label+'</span>'+adminBadge+'</div>';
        listHtml += '<code style="font-size:11px;color:var(--muted);letter-spacing:1px">'+masked+'</code>';
        listHtml += '</div>';
        // Store key index for forcing (avoid storing plaintext in onclick attr)
        listHtml += '<button data-kv-key="'+k.key+'" onclick="(async function(btn){var kv=btn.getAttribute(&quot;data-kv-key&quot;);localStorage.setItem(&quot;tv_admin_forced_key&quot;,kv);window._adminTab=&quot;apikeys&quot;;renderAdmin();})(this)" style="background:'+(isActive?'var(--teal)':'rgba(255,255,255,0.06)')+';border:1px solid '+(isActive?'var(--teal)':'var(--border2)')+';color:'+(isActive?'#000':'var(--text2)')+';padding:7px 16px;border-radius:9px;font-weight:800;font-size:12px;cursor:pointer;font-family:var(--font-display);white-space:nowrap">'+(isActive?'âœ“ ACTIVE':'Use This Key')+'</button>';
        listHtml += '</div>';
      });
      listEl.innerHTML = listHtml || '<div style="color:var(--muted);font-size:12px">No keys found.</div>';
    } catch(err) {
      if (listEl) listEl.innerHTML = '<div style="color:var(--accent);font-size:12px;padding:16px">Failed to decrypt keys: '+err.message+'</div>';
    }
  }, 100);

  return html;
}

function _adminAIContent() {
  if (!_aiProviders.length) initAIProviders();
  var providerRows = _aiProviders.map(function(p, idx){
    var statusColor = p.paused ? 'var(--accent)' : 'var(--teal)';
    var statusLabel = p.paused ? 'â¸ PAUSED' : 'â–¶ ACTIVE';
    var maskedKey = p.key ? (p.key.substring(0,8)+'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'+p.key.slice(-4)) : '(not set)';
    var isGemini = p.type === 'gemini';
    var toggleLabel = isGemini ? (p.paused ? 'âœ… Enable' : 'ðŸš« Disable') : (p.paused ? 'â–¶ Unpause' : 'â¸ Pause');
    var adminBadge = isGemini ? '<span style="font-size:9px;font-weight:800;background:rgba(167,139,250,0.15);color:#a78bfa;border:1px solid rgba(167,139,250,0.3);padding:1px 6px;border-radius:5px;margin-left:6px;vertical-align:middle">ðŸ”’ ADMIN ONLY</span>' : '';
    return '<div class="card" style="margin-bottom:10px;border-left:3px solid '+(p.paused?'var(--accent)':p.isPrimary?'var(--teal)':'var(--border2)')+'">'+
      '<div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:10px">'+
        '<div style="flex:1"><div style="font-weight:800;font-size:13px;margin-bottom:3px">'+(p.isPrimary?'â­ ':'')+p.name+adminBadge+'</div>'+
          '<div style="font-size:11px;color:var(--muted)">Key: <span style="font-family:monospace">'+maskedKey+'</span></div>'+
          '<div style="font-size:11px;color:var(--muted)">Calls: '+(p.callCount||0)+' Â· Status: <span style="color:'+statusColor+'">'+statusLabel+'</span></div>'+
          (isGemini && p.paused ? '<div style="font-size:10px;color:#a78bfa;margin-top:3px">Disabled by default â€” enable here to activate for all users</div>' : '')+
        '</div>'+
        '<div style="display:flex;gap:5px;flex-wrap:wrap">'+
          '<button class="btn btn-ghost btn-sm" onclick="adminToggleAIPause(&quot;+idx+&quot;)">'+toggleLabel+'</button>'+
          (!p.isPrimary?'<button class="btn btn-teal btn-sm" style="font-size:10px" onclick="adminSetPrimaryAI('+idx+')">â­ Primary</button>':'')+
          '<button class="btn btn-ghost btn-sm" style="font-size:10px" onclick="adminEditAI(&quot;+idx+&quot;)">âœï¸ Edit</button>'+
          (p.id!=='groq-default'?'<button class="btn btn-ghost btn-sm" style="font-size:10px;color:var(--accent)" onclick="adminRemoveAI('+idx+')">ðŸ—‘ï¸</button>':'')+
        '</div>'+
      '</div>'+
    '</div>';
  }).join('');
  return '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">'+
    '<div><div style="font-size:14px;font-weight:800">AI Providers</div><div style="font-size:12px;color:var(--muted)">'+_aiProviders.filter(function(p){return !p.paused;}).length+' active Â· '+_aiProviders.length+' total</div></div>'+
    '<button class="btn btn-primary" onclick="adminShowAddAI()">+ Add Provider</button>'+
  '</div>'+
  providerRows+
  '<div id="addAIForm" style="display:none"></div>';
}

function _adminCreditsContent(users, prices) {
  return '<div style="font-size:14px;font-weight:800;margin-bottom:16px">Script Credits</div>'+
    '<div class="card" style="margin-bottom:14px">'+
      '<div style="font-size:12px;font-weight:800;margin-bottom:12px;color:var(--text2)">CREDIT PRICING</div>'+
      '<div class="form-field"><label>Script Pack Price (Â£)</label><input class="form-input" id="creditPackPrice" value="'+(prices.scriptPack||'5')+'" type="number" min="0" step="0.5" placeholder="5.00"></div>'+
      '<div class="form-field"><label>Price Per Script (Â£)</label><input class="form-input" id="creditPerScript" value="'+(prices.scriptPerUse||'0.50')+'" type="number" min="0" step="0.1" placeholder="0.50"></div>'+
      '<button class="btn btn-primary btn-sm" onclick="adminSavePrices()">ðŸ’¾ Save</button>'+
    '</div>'+
    '<div class="card">'+
      '<div style="font-size:12px;font-weight:800;margin-bottom:12px;color:var(--text2)">ADJUST USER CREDITS</div>'+
      '<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end">'+
        '<div class="form-field" style="margin:0;flex:1;min-width:160px"><label>USER EMAIL</label><input class="form-input" id="creditUserEmail" placeholder="user@example.com"></div>'+
        '<div class="form-field" style="margin:0;width:100px"><label>CREDITS</label><input class="form-input" id="creditAmount" type="number" value="5" min="1"></div>'+
        '<button class="btn btn-teal" onclick="adminAdjustCredits()">âš¡ Add Credits</button>'+
      '</div>'+
    '</div>';
}

function _adminPricesContent(prices) {
  var planPrices = {free:0,starter:9,pro:19,gold:39,elite:79};
  return '<div style="font-size:14px;font-weight:800;margin-bottom:16px">Plan Pricing</div>'+
    '<div class="card">'+
      '<div style="font-size:12px;font-weight:800;margin-bottom:12px;color:var(--text2)">MONTHLY PRICES (Â£)</div>'+
      ['starter','pro','gold','elite'].map(function(p){
        var col = {starter:'var(--teal)',pro:'var(--accent)',gold:'var(--gold)',elite:'var(--elite)'}[p];
        return '<div class="form-field"><label style="color:'+col+'">'+p.toUpperCase()+'</label>'+
          '<input class="form-input" id="price_'+p+'" type="number" value="'+(prices['price_'+p]||planPrices[p]||0)+'" min="0" step="1" placeholder="'+planPrices[p]+'"></div>';
      }).join('')+
      '<button class="btn btn-primary" onclick="adminSavePrices()">ðŸ’¾ Save Prices</button>'+
    '</div>';
}

function _adminNotesContent(notes) {
  return '<div style="font-size:14px;font-weight:800;margin-bottom:16px">Admin Notes</div>'+
    '<div class="card">'+
      '<div style="font-size:12px;color:var(--muted);margin-bottom:10px">Private scratchpad â€” visible to admins only</div>'+
      '<textarea class="form-input" id="adminNotesArea" rows="16" style="resize:vertical;font-size:13px;line-height:1.65;font-family:inherit" placeholder="Your private admin notes, TODOs, ideas...">'+notes+'</textarea>'+
      '<button class="btn btn-primary btn-sm" style="margin-top:10px" onclick="adminSaveNotes()">ðŸ’¾ Save Notes</button>'+
    '</div>';
}

// ============================================================
// PROMO VIDEO STUDIO â€” Admin-only AI promo content generator
// ============================================================
function _adminPromoVidContent() {
  var saved = [];
  try { saved = JSON.parse(localStorage.getItem('tv_promo_videos') || '[]'); } catch(e) {}

  var platforms = [
    {id:'youtube',   label:'YouTube',    icon:'â–¶ï¸',  color:'#ff0000', dims:'1920Ã—1080 (16:9)',  aspectNote:'Landscape'},
    {id:'shorts',    label:'YT Shorts',  icon:'ðŸ“±',  color:'#ff0000', dims:'1080Ã—1920 (9:16)',  aspectNote:'Vertical'},
    {id:'tiktok',    label:'TikTok',     icon:'ðŸŽµ',  color:'#69C9D0', dims:'1080Ã—1920 (9:16)',  aspectNote:'Vertical'},
    {id:'instagram', label:'Instagram',  icon:'ðŸ“¸',  color:'#e1306c', dims:'1080Ã—1080 (1:1)',   aspectNote:'Square/Vertical'},
    {id:'twitter',   label:'Twitter/X',  icon:'ðŸ¦',  color:'#1da1f2', dims:'1280Ã—720 (16:9)',   aspectNote:'Landscape'},
    {id:'linkedin',  label:'LinkedIn',   icon:'ðŸ’¼',  color:'#0077b5', dims:'1920Ã—1080 (16:9)',  aspectNote:'Landscape'},
  ];

  var angles = [
    {id:'hook',     label:'ðŸ”¥ Viral Hook',     desc:'Punchy hook that stops the scroll in 2 seconds'},
    {id:'tutorial', label:'ðŸ“š Tutorial Style', desc:'Step-by-step walkthrough of a key feature'},
    {id:'social',   label:'ðŸ“£ Social Proof',   desc:'Results-driven â€” show the growth & wins'},
    {id:'compare',  label:'âš”ï¸ Vs Competitors', desc:'Why TrendVid beats manual research'},
    {id:'creator',  label:'ðŸŽ¤ Creator Story',  desc:'Relatable creator pain points & solution'},
    {id:'launch',   label:'ðŸš€ Product Launch', desc:'Hype reveal / new feature announcement'},
  ];

  var savedCards = saved.length === 0
    ? '<div style="text-align:center;padding:40px 20px;color:var(--muted);font-size:12px"><div style="font-size:32px;margin-bottom:10px">ðŸŽ¬</div>No promo videos generated yet.<br>Use the generator above to create your first one.</div>'
    : saved.slice().reverse().map(function(v, i) {
        var realIdx = saved.length - 1 - i;
        var platformMeta = platforms.find(function(p){ return p.id === v.platform; }) || platforms[0];
        var timeAgo = adminTimeAgo(v.createdAt);
        return '<div class="card" style="margin-bottom:12px;border-left:3px solid '+platformMeta.color+'">'+
          '<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:12px">'+
            '<div style="display:flex;align-items:center;gap:10px">'+
              '<div style="width:36px;height:36px;border-radius:10px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0">'+platformMeta.icon+'</div>'+
              '<div>'+
                '<div style="font-size:13px;font-weight:800">'+esc(v.title||'Promo Video')+'</div>'+
                '<div style="font-size:10px;color:var(--muted);margin-top:2px">'+platformMeta.label+' Â· '+esc(v.angle||'')+'  Â·  '+timeAgo+'</div>'+
              '</div>'+
            '</div>'+
            '<button onclick="adminDeletePromoVideo('+realIdx+')" style="background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:4px" title="Delete">ðŸ—‘ï¸</button>'+
          '</div>'+
          '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:12px;max-height:180px;overflow-y:auto">'+
            '<pre style="white-space:pre-wrap;font-family:inherit;font-size:12px;color:var(--text2);line-height:1.65;margin:0">'+esc(v.script||'')+'</pre>'+
          '</div>'+
          '<div style="display:flex;gap:6px;flex-wrap:wrap">'+
            '<button class="btn btn-primary btn-sm" onclick="adminDownloadPromoScript('+realIdx+')">â¬‡ï¸ Download Script</button>'+
            '<button class="btn btn-ghost btn-sm" onclick="adminCopyPromoScript('+realIdx+')">ðŸ“‹ Copy Script</button>'+
            '<button class="btn btn-ghost btn-sm" onclick="adminDownloadPromoPoster('+realIdx+')">ðŸ–¼ï¸ Download Poster</button>'+
            '<button class="btn btn-ghost btn-sm" onclick="adminPromoToCaption('+realIdx+')">âœï¸ Caption Pack</button>'+
          '</div>'+
        '</div>';
      }).join('');

  return '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">'+
    '<div>'+
      '<div style="font-family:var(--font-display);font-size:20px;font-weight:900;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent">ðŸŽ¬ Promo Video Studio</div>'+
      '<div style="font-size:12px;color:var(--muted);margin-top:2px">AI-generated promotional content ready to post on any platform</div>'+
    '</div>'+
    (saved.length>0?'<button class="btn btn-ghost btn-sm" onclick="if(confirm(\'Clear all saved promos?\')){localStorage.removeItem(\'tv_promo_videos\');renderAdmin();}">ðŸ—‘ï¸ Clear All</button>':'')+
  '</div>'+

  // Generator card
  '<div class="card" style="margin-bottom:20px;border:1px solid rgba(255,48,88,0.25);background:linear-gradient(135deg,rgba(255,48,88,0.04),transparent)">'+
    '<div style="font-size:12px;font-weight:900;letter-spacing:1.5px;color:var(--accent);margin-bottom:14px;font-family:var(--font-display)">âš¡ GENERATE NEW PROMO</div>'+

    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">'+
      '<div>'+
        '<label style="font-size:10px;font-weight:800;color:var(--muted);display:block;margin-bottom:6px;letter-spacing:1px">PLATFORM</label>'+
        '<div style="display:flex;flex-wrap:wrap;gap:6px" id="promoPlatformPicker">'+
          platforms.map(function(p){
            return '<button onclick="adminSelectPromoPlatform(\''+p.id+'\')" id="promoPlatBtn_'+p.id+'" style="border:1px solid var(--border);background:transparent;color:var(--text2);border-radius:9px;padding:5px 11px;font-size:11px;font-weight:700;cursor:pointer;transition:all 0.15s;font-family:inherit">'+p.icon+' '+p.label+'</button>';
          }).join('')+
        '</div>'+
      '</div>'+
      '<div>'+
        '<label style="font-size:10px;font-weight:800;color:var(--muted);display:block;margin-bottom:6px;letter-spacing:1px">VIDEO ANGLE</label>'+
        '<div style="display:flex;flex-wrap:wrap;gap:6px" id="promoAnglePicker">'+
          angles.map(function(a){
            return '<button onclick="adminSelectPromoAngle(\''+a.id+'\')" id="promoAngleBtn_'+a.id+'" title="'+a.desc+'" style="border:1px solid var(--border);background:transparent;color:var(--text2);border-radius:9px;padding:5px 11px;font-size:11px;font-weight:700;cursor:pointer;transition:all 0.15s;font-family:inherit">'+a.label+'</button>';
          }).join('')+
        '</div>'+
      '</div>'+
    '</div>'+

    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">'+
      '<div style="margin-bottom:4px">'+
        '<label style="font-size:10px;font-weight:800;color:var(--muted);letter-spacing:1px;display:block;margin-bottom:8px">VIDEO LENGTH</label>'+
        '<input type="hidden" id="promoLength" value="30">'+
        '<div style="display:flex;flex-wrap:wrap;gap:6px" id="promoLengthPicker">'+
          [['15','15s','Reel / Short'],['30','30s','Ideal âœ“'],['45','45s','Extended'],['60','1min','Full minute'],['90','90s','Long Short'],['120','2min','Deep Dive'],['180','3min','Tutorial'],['300','5min','Full Video']].map(function(l){
            return '<button onclick="adminSelectPromoLength(\'' + l[0] + '\')" id="promoLenBtn_' + l[0] + '" title="' + l[2] + '" style="border:1px solid var(--border);background:' + (l[0]==="30"?'var(--accent)':'transparent') + ';color:' + (l[0]==="30"?'#fff':'var(--text2)') + ';border-color:' + (l[0]==="30"?'var(--accent)':'var(--border)') + ';border-radius:9px;padding:6px 11px;font-size:11px;font-weight:700;cursor:pointer;transition:all 0.15s;font-family:inherit;display:flex;flex-direction:column;align-items:center;min-width:52px;">'+
              '<span style="font-size:13px;font-weight:900;line-height:1">'+l[1]+'</span>'+
              '<span style="font-size:9px;opacity:0.75;margin-top:1px;white-space:nowrap">'+l[2]+'</span>'+
            '</button>';
          }).join('')+
        '</div>'+
      '</div>'+
      '<div class="form-field" style="margin:0">'+
        '<label style="font-size:10px;font-weight:800;color:var(--muted);letter-spacing:1px">TONE / VIBE</label>'+
        '<select class="form-input" id="promoTone" style="font-size:12px">'+
          '<option value="hype">ðŸ”¥ Hype & Energetic</option>'+
          '<option value="casual">ðŸ˜Ž Casual & Relatable</option>'+
          '<option value="professional">ðŸ’¼ Professional</option>'+
          '<option value="funny">ðŸ˜‚ Funny / Comedic</option>'+
          '<option value="urgent">â° Urgent / FOMO</option>'+
          '<option value="inspiring">âœ¨ Inspiring</option>'+
        '</select>'+
      '</div>'+
    '</div>'+

    '<div class="form-field" style="margin-bottom:14px">'+
      '<label style="font-size:10px;font-weight:800;color:var(--muted);letter-spacing:1px">KEY FEATURE TO HIGHLIGHT <span style="color:var(--muted);font-weight:400">(optional)</span></label>'+
      '<input class="form-input" id="promoFeature" placeholder="e.g. AI script generator, trend radar, thumbnail AI..." style="font-size:12px">'+
    '</div>'+

    '<button class="btn btn-primary" id="promoGenBtn" onclick="adminGeneratePromoVideo()" style="width:100%;font-size:13px;padding:11px">'+
      'ðŸŽ¬ Generate Promo Script + Poster'+
    '</button>'+

    '<div id="promoGenResult" style="display:none;margin-top:16px"></div>'+
  '</div>'+

  // Saved videos
  '<div style="font-size:11px;font-weight:900;letter-spacing:1.5px;color:var(--muted);margin-bottom:12px;font-family:var(--font-display)">SAVED PROMOS ('+saved.length+')</div>'+
  savedCards;
}

window._selectedPromoPlatform = 'youtube';
window._selectedPromoAngle = 'hook';

function adminSelectPromoLength(val) {
  var hidEl = document.getElementById('promoLength');
  if(hidEl) hidEl.value = val;
  document.querySelectorAll('[id^="promoLenBtn_"]').forEach(function(b){
    var isActive = b.id === 'promoLenBtn_' + val;
    b.style.background = isActive ? 'var(--accent)' : 'transparent';
    b.style.color = isActive ? '#fff' : 'var(--text2)';
    b.style.borderColor = isActive ? 'var(--accent)' : 'var(--border)';
  });
}

// Select platform
function adminSelectPromoPlatform(id) {
  window._selectedPromoPlatform = id;
  document.querySelectorAll('[id^="promoPlatBtn_"]').forEach(function(b){
    var isActive = b.id === 'promoPlatBtn_' + id;
    b.style.background = isActive ? 'var(--accent)' : 'transparent';
    b.style.color = isActive ? '#fff' : 'var(--text2)';
    b.style.borderColor = isActive ? 'var(--accent)' : 'var(--border)';
  });
}

// Select angle
function adminSelectPromoAngle(id) {
  window._selectedPromoAngle = id;
  document.querySelectorAll('[id^="promoAngleBtn_"]').forEach(function(b){
    var isActive = b.id === 'promoAngleBtn_' + id;
    b.style.background = isActive ? 'rgba(255,48,88,0.15)' : 'transparent';
    b.style.color = isActive ? 'var(--accent)' : 'var(--text2)';
    b.style.borderColor = isActive ? 'rgba(255,48,88,0.5)' : 'var(--border)';
  });
}

// Generate promo script via AI
async function adminGeneratePromoVideo() {
  var platform = window._selectedPromoPlatform || 'youtube';
  var angle = window._selectedPromoAngle || 'hook';
  var length = document.getElementById('promoLength') ? document.getElementById('promoLength').value : '30';
  var tone = document.getElementById('promoTone') ? document.getElementById('promoTone').value : 'hype';
  var feature = document.getElementById('promoFeature') ? document.getElementById('promoFeature').value.trim() : '';

  var platformLabels = {youtube:'YouTube',shorts:'YouTube Shorts',tiktok:'TikTok',instagram:'Instagram Reels',twitter:'Twitter/X',linkedin:'LinkedIn'};
  var angleLabels = {hook:'Viral Hook',tutorial:'Tutorial Style',social:'Social Proof',compare:'Vs Competitors',creator:'Creator Story',launch:'Product Launch'};
  var toneLabels = {hype:'hype & energetic',casual:'casual & relatable',professional:'professional & trustworthy',funny:'funny & comedic',urgent:'urgent with FOMO',inspiring:'inspiring & motivational'};

  var btn = document.getElementById('promoGenBtn');
  var resultEl = document.getElementById('promoGenResult');
  if(btn) { btn.disabled = true; btn.textContent = 'â³ Generatingâ€¦'; }
  if(resultEl) resultEl.style.display = 'none';

  var prompt = 'You are a viral marketing expert creating a promotional video script for TrendVid AI â€” the #1 AI studio for content creators that helps them spot viral trends, generate scripts, create thumbnails, and grow their channels.\n\n' +
    'Platform: ' + (platformLabels[platform]||platform) + '\n' +
    'Video angle: ' + (angleLabels[angle]||angle) + '\n' +
    'Duration: ' + length + ' seconds\n' +
    'Tone: ' + (toneLabels[tone]||tone) + '\n' +
    (feature ? 'Feature to highlight: ' + feature + '\n' : '') +
    '\nReturn ONLY valid JSON with this exact structure:\n' +
    '{\n' +
    '  "title": "Short punchy video title (max 60 chars)",\n' +
    '  "hook": "Opening line / first 3 seconds (must be attention-grabbing)",\n' +
    '  "script": "Full word-for-word video script with [ON SCREEN TEXT], [B-ROLL], [VOICEOVER], [CTA] markers",\n' +
    '  "caption": "Social media caption for this post with hashtags",\n' +
    '  "hashtags": ["tag1","tag2","tag3","tag4","tag5"],\n' +
    '  "posterHeadline": "Bold visual headline text for the thumbnail/poster (max 8 words)",\n' +
    '  "posterSubtext": "Subtext for poster (max 12 words)",\n' +
    '  "cta": "Call to action text",\n' +
    '  "tips": ["filming tip 1", "filming tip 2", "filming tip 3"]\n' +
    '}';

  try {
    var raw = await aiCall([{role:'user', content: prompt}], 'You are a professional viral marketing copywriter. Return ONLY valid raw JSON with no markdown or code blocks.', 1500);
    var clean = raw.replace(/```json|```/g,'').trim();
    var data = JSON.parse(clean);

    // Save to localStorage
    var saved = [];
    try { saved = JSON.parse(localStorage.getItem('tv_promo_videos') || '[]'); } catch(e) {}
    var entry = {
      id: Date.now(),
      platform: platform,
      angle: angleLabels[angle] || angle,
      tone: tone,
      length: length,
      feature: feature,
      title: data.title || 'Promo Video',
      hook: data.hook || '',
      script: data.script || '',
      caption: data.caption || '',
      hashtags: data.hashtags || [],
      posterHeadline: data.posterHeadline || '',
      posterSubtext: data.posterSubtext || '',
      cta: data.cta || '',
      tips: data.tips || [],
      createdAt: Date.now()
    };
    saved.push(entry);
    localStorage.setItem('tv_promo_videos', JSON.stringify(saved));

    // Show inline result
    if(resultEl) {
      resultEl.style.display = 'block';
      resultEl.innerHTML =
        '<div style="background:rgba(0,229,176,0.06);border:1px solid rgba(0,229,176,0.25);border-radius:12px;padding:16px">' +
          '<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">' +
            '<span style="font-size:20px">âœ…</span>' +
            '<div style="font-family:var(--font-display);font-size:14px;font-weight:800;color:var(--teal)">Promo Generated!</div>' +
          '</div>' +
          '<div style="font-size:12px;font-weight:800;color:var(--text);margin-bottom:6px">ðŸŽ¬ ' + esc(data.title||'') + '</div>' +
          '<div style="font-size:12px;color:var(--accent);font-weight:700;margin-bottom:8px;font-style:italic">"' + esc(data.hook||'') + '"</div>' +
          '<div style="background:var(--surface3);border-radius:9px;padding:12px;font-size:12px;color:var(--text2);line-height:1.7;max-height:160px;overflow-y:auto;white-space:pre-wrap;margin-bottom:12px">' + esc(data.script||'') + '</div>' +
          '<div style="display:flex;gap:8px;flex-wrap:wrap">' +
            '<button class="btn btn-primary btn-sm" onclick="adminDownloadPromoScript(' + (saved.length-1) + ')">â¬‡ï¸ Download Script</button>' +
            '<button class="btn btn-teal btn-sm" onclick="adminDownloadPromoPoster(' + (saved.length-1) + ')">ðŸ–¼ï¸ Download Poster</button>' +
            '<button class="btn btn-ghost btn-sm" onclick="adminCopyPromoScript(' + (saved.length-1) + ')">ðŸ“‹ Copy</button>' +
            '<button class="btn btn-ghost btn-sm" onclick="adminPromoToCaption(' + (saved.length-1) + ')">âœï¸ Caption Pack</button>' +
          '</div>' +
        '</div>';
    }

    notify('ðŸŽ¬ Promo video script generated!', 'success', 'âœ…');
  } catch(err) {
    notify('Failed to generate promo: ' + (err.message||'AI error'), 'error', 'âŒ');
    if(resultEl) {
      resultEl.style.display = 'block';
      resultEl.innerHTML = '<div style="background:rgba(255,48,88,0.08);border:1px solid rgba(255,48,88,0.3);border-radius:10px;padding:12px;font-size:12px;color:var(--accent)">âŒ Generation failed. Check your AI provider in Settings and try again.</div>';
    }
  }

  if(btn) { btn.disabled = false; btn.textContent = 'ðŸŽ¬ Generate Promo Script + Poster'; }
}

// Download script as .txt file
function adminDownloadPromoScript(idx) {
  var saved = [];
  try { saved = JSON.parse(localStorage.getItem('tv_promo_videos') || '[]'); } catch(e) {}
  var v = saved[idx]; if(!v) return;

  var text = '=================================================\n' +
    'TRENDVID AI â€” PROMO VIDEO SCRIPT\n' +
    '=================================================\n\n' +
    'TITLE: ' + (v.title||'') + '\n' +
    'PLATFORM: ' + (v.platform||'').toUpperCase() + '\n' +
    'ANGLE: ' + (v.angle||'') + '\n' +
    'DURATION: ' + (v.length||'30') + ' seconds\n' +
    'GENERATED: ' + new Date(v.createdAt).toLocaleString('en-GB') + '\n\n' +
    '-------------------------------------------------\n' +
    'HOOK (First 3 seconds)\n' +
    '-------------------------------------------------\n' +
    (v.hook||'') + '\n\n' +
    '-------------------------------------------------\n' +
    'FULL SCRIPT\n' +
    '-------------------------------------------------\n' +
    (v.script||'') + '\n\n' +
    '-------------------------------------------------\n' +
    'SOCIAL CAPTION\n' +
    '-------------------------------------------------\n' +
    (v.caption||'') + '\n\n' +
    '-------------------------------------------------\n' +
    'HASHTAGS\n' +
    '-------------------------------------------------\n' +
    (v.hashtags||[]).map(function(h){ return '#'+h; }).join(' ') + '\n\n' +
    '-------------------------------------------------\n' +
    'CALL TO ACTION\n' +
    '-------------------------------------------------\n' +
    (v.cta||'') + '\n\n' +
    '-------------------------------------------------\n' +
    'FILMING TIPS\n' +
    '-------------------------------------------------\n' +
    (v.tips||[]).map(function(t,i){ return (i+1)+'. '+t; }).join('\n') + '\n\n' +
    '=================================================\n' +
    'Generated by TrendVid AI Admin â€” trendvid.ai\n' +
    '=================================================\n';

  var blob = new Blob([text], {type:'text/plain'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'trendvid-promo-' + (v.platform||'video') + '-' + Date.now() + '.txt';
  a.click();
  notify('ðŸ“„ Script downloaded!', 'success', 'â¬‡ï¸');
}

// Copy script to clipboard
function adminCopyPromoScript(idx) {
  var saved = [];
  try { saved = JSON.parse(localStorage.getItem('tv_promo_videos') || '[]'); } catch(e) {}
  var v = saved[idx]; if(!v) return;
  var text = (v.title||'') + '\n\n' + (v.script||'') + '\n\n---\nCAPTION:\n' + (v.caption||'') + '\n\nHASHTAGS: ' + (v.hashtags||[]).map(function(h){return '#'+h;}).join(' ');
  navigator.clipboard && navigator.clipboard.writeText(text).then(function(){
    notify('ðŸ“‹ Script copied to clipboard!', 'success', 'âœ…');
  }).catch(function(){
    notify('Copy failed â€” try downloading instead', 'error', 'âŒ');
  });
}

// Generate and download a visual poster as HTMLâ†’canvas via print
function adminDownloadPromoPoster(idx) {
  var saved = [];
  try { saved = JSON.parse(localStorage.getItem('tv_promo_videos') || '[]'); } catch(e) {}
  var v = saved[idx]; if(!v) return;

  var platformColors = {youtube:'#ff0000',shorts:'#ff0000',tiktok:'#69C9D0',instagram:'#e1306c',twitter:'#1da1f2',linkedin:'#0077b5'};
  var accentColor = platformColors[v.platform] || '#ff3058';
  var platformIcons = {youtube:'â–¶',shorts:'ðŸ“±',tiktok:'â™ª',instagram:'â—ˆ',twitter:'ð•',linkedin:'in'};
  var platformIcon = platformIcons[v.platform] || 'â–¶';

  // Build a self-contained HTML poster that will print well
  var posterHTML = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>TrendVid Promo Poster</title>' +
    '<link href="https://fonts.googleapis.com/css2?family=Syne:wght@800;900&family=DM+Sans:wght@400;700&display=swap" rel="stylesheet">' +
    '<style>' +
    '*{margin:0;padding:0;box-sizing:border-box;}' +
    'body{width:1080px;height:1080px;overflow:hidden;background:#060810;font-family:"DM Sans",sans-serif;position:relative;}' +
    '.bg{position:absolute;inset:0;background:radial-gradient(circle at 30% 50%,rgba('+hexToRgb(accentColor)+',0.25) 0%,transparent 60%),radial-gradient(circle at 80% 20%,rgba(0,229,176,0.12) 0%,transparent 50%),#060810;}' +
    '.grid{position:absolute;inset:0;background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:60px 60px;pointer-events:none;}' +
    '.content{position:relative;z-index:1;padding:70px;height:100%;display:flex;flex-direction:column;justify-content:space-between;}' +
    '.top-bar{display:flex;align-items:center;justify-content:space-between;}' +
    '.logo{font-family:"Syne",sans-serif;font-size:22px;font-weight:900;color:#fff;letter-spacing:3px;text-transform:uppercase;}' +
    '.logo span{color:' + accentColor + ';}' +
    '.platform-badge{background:' + accentColor + ';color:#fff;padding:6px 18px;border-radius:30px;font-size:13px;font-weight:800;font-family:"Syne",sans-serif;letter-spacing:1px;display:flex;align-items:center;gap:8px;}' +
    '.main{flex:1;display:flex;flex-direction:column;justify-content:center;padding:20px 0;}' +
    '.ai-tag{font-size:13px;font-weight:800;color:' + accentColor + ';letter-spacing:4px;text-transform:uppercase;margin-bottom:20px;font-family:"Syne",sans-serif;}' +
    '.headline{font-family:"Syne",sans-serif;font-size:78px;font-weight:900;color:#fff;line-height:1.0;letter-spacing:-2px;margin-bottom:24px;text-transform:uppercase;}' +
    '.headline em{color:' + accentColor + ';font-style:normal;}' +
    '.subtext{font-size:22px;color:rgba(255,255,255,0.65);line-height:1.5;max-width:700px;margin-bottom:36px;}' +
    '.cta-box{display:inline-flex;align-items:center;gap:14px;background:' + accentColor + ';color:#fff;padding:16px 32px;border-radius:14px;font-family:"Syne",sans-serif;font-size:20px;font-weight:900;letter-spacing:0.5px;}' +
    '.bottom-bar{display:flex;align-items:center;justify-content:space-between;}' +
    '.url{font-size:16px;color:rgba(255,255,255,0.4);font-weight:700;letter-spacing:2px;}' +
    '.stats{display:flex;gap:32px;}' +
    '.stat{text-align:center;}' +
    '.stat-num{font-family:"Syne",sans-serif;font-size:22px;font-weight:900;color:#fff;}' +
    '.stat-label{font-size:11px;color:rgba(255,255,255,0.4);font-weight:700;letter-spacing:1px;text-transform:uppercase;}' +
    '.corner-accent{position:absolute;bottom:0;right:0;width:300px;height:300px;background:radial-gradient(circle,rgba('+hexToRgb(accentColor)+',0.2),transparent 70%);pointer-events:none;}' +
    '.print-btn{position:fixed;top:20px;right:20px;background:'+accentColor+';color:#fff;border:none;padding:12px 24px;border-radius:10px;font-size:14px;font-weight:800;cursor:pointer;font-family:"Syne",sans-serif;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.4);}' +
    '.print-btn:hover{opacity:0.9;}' +
    '@media print{.print-btn{display:none;}body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}}' +
    '</style></head><body>' +
    '<div class="bg"></div><div class="grid"></div><div class="corner-accent"></div>' +
    '<button class="print-btn" onclick="window.print()">ðŸ–¨ï¸ Save as PDF / Print</button>' +
    '<div class="content">' +
      '<div class="top-bar">' +
        '<div class="logo">Trend<span>Vid</span> AI</div>' +
        '<div class="platform-badge"><span>' + platformIcon + '</span>' + (v.platform||'YouTube').toUpperCase() + '</div>' +
      '</div>' +
      '<div class="main">' +
        '<div class="ai-tag">âš¡ AI-Powered</div>' +
        '<div class="headline">' + formatPosterHeadline(v.posterHeadline || v.title || 'Grow Your Channel') + '</div>' +
        '<div class="subtext">' + esc(v.posterSubtext || 'The AI studio built for content creators who want to go viral.') + '</div>' +
        '<div class="cta-box"><span>ðŸš€</span>' + esc(v.cta || 'Try TrendVid AI Free') + '</div>' +
      '</div>' +
      '<div class="bottom-bar">' +
        '<div class="url">trendvid.ai</div>' +
        '<div class="stats">' +
          '<div class="stat"><div class="stat-num">10K+</div><div class="stat-label">Creators</div></div>' +
          '<div class="stat"><div class="stat-num">AI</div><div class="stat-label">Powered</div></div>' +
          '<div class="stat"><div class="stat-num">Free</div><div class="stat-label">To Start</div></div>' +
        '</div>' +
      '</div>' +
    '</div>' +
    '\n\n<!-- ===== STRIPE TEST MODE BANNER ===== -->\n' + '<scr' + 'ipt>' + '\n(function() {\n  function showStripeTestBanner() {\n    if (document.getElementById(\'_stripeTestBanner\')) return;\n    var stripeCfg = {};\n    try { stripeCfg = JSON.parse(localStorage.getItem(\'tv_stripe_cfg\') || \'{}\'); } catch(e) {}\n    var pk = stripeCfg.publishableKey || \'\';\n    // Show banner if: no pk set (demo mode) OR pk_test_ is set\n    var isTestMode = !pk || pk.startsWith(\'pk_test\');\n    if (!isTestMode) return;\n    // Only show to admins\n    if (!window.currentUser || !window.currentUser.isAdmin) return;\n\n    var label = !pk ? \'âš ï¸ Demo Mode â€” No Stripe keys set. Upgrades are free for everyone right now.\' : \'ðŸ§ª Stripe Test Mode â€” Using test keys. Real customers cannot pay yet.\';\n    var actionText = !pk ? \'Configure Stripe â†’\' : \'Switch to Live Keys â†’\';\n\n    var banner = document.createElement(\'div\');\n    banner.id = \'_stripeTestBanner\';\n    banner.style.cssText = [\n      \'position:fixed\',\n      \'top:0\',\n      \'left:0\',\n      \'right:0\',\n      \'z-index:99980\',\n      \'background:linear-gradient(90deg,#ff3058,#ff7b00)\',\n      \'color:#fff\',\n      \'font-size:12px\',\n      \'font-weight:700\',\n      \'font-family:DM Sans,sans-serif\',\n      \'display:flex\',\n      \'align-items:center\',\n      \'justify-content:center\',\n      \'gap:12px\',\n      \'padding:8px 16px\',\n      \'box-shadow:0 2px 12px rgba(255,48,88,0.5)\',\n      \'animation:fadeIn 0.4s ease\'\n    ].join(\';\');\n    banner.innerHTML =\n      \'<span>\' + label + \'</span>\' +\n      \'<button onclick="if(typeof navTo===\'function\')navTo(\'admin\');setTimeout(function(){window._adminTab=\'stripe\';if(typeof renderAdmin===\'function\')renderAdmin();},300)" \' +\n        \'style="background:rgba(255,255,255,0.25);border:1px solid rgba(255,255,255,0.5);color:#fff;padding:3px 10px;border-radius:20px;cursor:pointer;font-size:11px;font-weight:800;font-family:inherit;white-space:nowrap">\' +\n        actionText +\n      \'</button>\' +\n      \'<button onclick="document.getElementById(\'_stripeTestBanner\').remove()" \' +\n        \'style="background:none;border:none;color:rgba(255,255,255,0.7);cursor:pointer;font-size:16px;line-height:1;padding:0 4px;margin-left:4px">âœ•</button>\';\n    document.body.appendChild(banner);\n\n    // Push page content down so banner doesn\'t overlap\n    var app = document.querySelector(\'.app\');\n    if (app) app.style.paddingTop = \'38px\';\n  }\n\n  // Run after app is initialized (currentUser is set)\n  window.addEventListener(\'load\', function() {\n    setTimeout(showStripeTestBanner, 1500);\n  });\n  // Also watch for login\n  var _origEnterApp = window.enterAppWithUser;\n  if (typeof _origEnterApp === \'function\') {\n    window.enterAppWithUser = function() {\n      _origEnterApp.apply(this, arguments);\n      setTimeout(showStripeTestBanner, 800);\n    };\n  }\n  window._showStripeTestBanner = showStripeTestBanner;\n})();\n<\/script>\n<!-- ===== END STRIPE TEST MODE BANNER ===== -->\n\n</body></html>';

  var blob = new Blob([posterHTML], {type:'text/html'});
  var url = URL.createObjectURL(blob);
  window.open(url, '_blank');
  notify('ðŸ–¼ï¸ Poster opened â€” use Print â†’ Save as PDF to export!', 'success', 'ðŸ–¨ï¸');
}

function hexToRgb(hex) {
  var r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  return r+','+g+','+b;
}

function formatPosterHeadline(text) {
  if(!text) return 'GROW YOUR<br><em>CHANNEL</em>';
  var words = text.toUpperCase().replace(/[<>&"]/g,function(c){return{'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c];}).split(' ');
  // Bold last word in accent color
  if(words.length > 1) { words[words.length-1] = '<em>' + words[words.length-1] + '</em>'; }
  // Split into 2 lines naturally
  var mid = Math.ceil(words.length / 2);
  return words.slice(0,mid).join(' ') + '<br>' + words.slice(mid).join(' ');
}

// Generate caption pack download
function adminPromoToCaption(idx) {
  var saved = [];
  try { saved = JSON.parse(localStorage.getItem('tv_promo_videos') || '[]'); } catch(e) {}
  var v = saved[idx]; if(!v) return;

  var hashtags = (v.hashtags||[]).map(function(h){return '#'+h;}).join(' ');
  var text = '=================================================\n' +
    'TRENDVID AI â€” SOCIAL CAPTION PACK\n' +
    'Platform: ' + (v.platform||'').toUpperCase() + '\n' +
    '=================================================\n\n' +
    '--- MAIN CAPTION ---\n' + (v.caption||'') + '\n\n' +
    '--- HASHTAGS ---\n' + hashtags + '\n\n' +
    '--- CALL TO ACTION ---\n' + (v.cta||'') + '\n\n' +
    '--- SHORT VERSION (Twitter/X) ---\n' +
    (v.hook ? v.hook + '\n\n' : '') +
    'ðŸ‘‰ Try free at trendvid.ai\n\n' +
    hashtags.split(' ').slice(0,3).join(' ') + '\n\n' +
    '--- LINKEDIN VERSION ---\n' +
    (v.hook ? v.hook + '\n\n' : '') +
    (v.caption||'') + '\n\nðŸ”— trendvid.ai\n\n' +
    '=================================================\n';

  var blob = new Blob([text], {type:'text/plain'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'trendvid-captions-' + Date.now() + '.txt';
  a.click();
  notify('âœï¸ Caption pack downloaded!', 'success', 'â¬‡ï¸');
}

// Delete a promo video
function adminDeletePromoVideo(idx) {
  if(!confirm('Delete this promo video?')) return;
  var saved = [];
  try { saved = JSON.parse(localStorage.getItem('tv_promo_videos') || '[]'); } catch(e) {}
  saved.splice(idx, 1);
  localStorage.setItem('tv_promo_videos', JSON.stringify(saved));
  renderAdmin();
}

function adminStat(label, value, color) {
  return '<div class="card" style="text-align:center;padding:16px">'+
    '<div style="font-size:11px;color:var(--muted);font-weight:700;letter-spacing:1px;font-family:var(--font-display);margin-bottom:6px">'+label+'</div>'+
    '<div style="font-size:26px;font-weight:800;color:'+color+';font-family:var(--font-display)">'+value+'</div>'+
  '</div>';
}

function adminTimeAgo(ts) {
  if(!ts) return 'â€”';
  var diff = Date.now() - ts;
  var mins = Math.floor(diff/60000);
  var hrs = Math.floor(mins/60);
  var days = Math.floor(hrs/24);
  if(mins<2) return 'just now';
  if(mins<60) return mins+'m ago';
  if(hrs<24) return hrs+'h ago';
  return days+'d ago';
}

function adminSelectBroadcastType(type) {
  window._bcType = type;
  ['info','success','alert'].forEach(function(t) {
    var btn = document.getElementById('bcType_'+t);
    if(!btn) return;
    var col = {info:'var(--purple)',success:'var(--teal)',alert:'var(--accent)'}[t];
    btn.style.background = t===type ? col : '';
    btn.style.color = t===type ? '#fff' : col;
  });
}


// ============================================================
// AUTO-UPDATE DETECTION + AI RELEASE NOTES
// Compares APP_BUILD_HASH to last seen hash in localStorage.
// If changed, uses AI to generate a human "What's New" message
// and auto-broadcasts it to all users as an announcement.
// ============================================================

async function checkForAppUpdate() {
  try {
    var lastHash     = localStorage.getItem('tv_last_build_hash') || '';
    var lastVersion  = localStorage.getItem('tv_last_version')    || '';
    var lastManifest = {};
    try { lastManifest = JSON.parse(localStorage.getItem('tv_last_manifest') || '{}'); } catch(e) {}

    // If decryption silently failed (key change, fingerprint drift), the raw
    // ciphertext is returned as-is. Treat any tvenc1: blob as "unknown" so we
    // don't false-trigger an update announcement or log gibberish.
    var _isEncBlob = function(v) { return typeof v === 'string' && v.startsWith('tvenc1:'); };
    if (_isEncBlob(lastHash))    lastHash    = '';
    if (_isEncBlob(lastVersion)) lastVersion = '';

    // Always persist current manifest so next run can diff against it
    localStorage.setItem('tv_last_manifest', JSON.stringify(APP_FEATURE_MANIFEST));

    if (lastHash === APP_BUILD_HASH) return;

    if (!lastHash) {
      localStorage.setItem('tv_last_build_hash', APP_BUILD_HASH);
      localStorage.setItem('tv_last_version',    APP_VERSION);
      return;
    }

    console.log('[TrendVid] Update: ' + lastVersion + ' to ' + APP_VERSION);
    localStorage.setItem('tv_last_build_hash', APP_BUILD_HASH);
    localStorage.setItem('tv_last_version',    APP_VERSION);

    var oldPages      = lastManifest.pages          || [];
    var addedPages    = APP_FEATURE_MANIFEST.pages.filter(function(p){ return oldPages.indexOf(p) === -1; });
    var oldFeatures   = lastManifest.features       || [];
    var addedFeatures = APP_FEATURE_MANIFEST.features.filter(function(f){ return oldFeatures.indexOf(f) === -1; });
    var oldAdmin      = lastManifest.adminFeatures  || [];
    var addedAdmin    = APP_FEATURE_MANIFEST.adminFeatures.filter(function(f){ return oldAdmin.indexOf(f) === -1; });

    var allChangelog = APP_FEATURE_MANIFEST.changelog || [];
    var newChangelog = allChangelog.filter(function(c){ return c.indexOf(APP_VERSION + ':') === 0; });
    if (!newChangelog.length) newChangelog = allChangelog.slice(0, 5);

    var diffLines = [];
    if (addedPages.length)    diffLines.push('New pages/tools: '    + addedPages.join(', '));
    if (addedFeatures.length) diffLines.push('New features: '       + addedFeatures.join(', '));
    if (addedAdmin.length)    diffLines.push('New admin features: ' + addedAdmin.join(', '));
    if (newChangelog.length)  diffLines.push('Changelog: '          + newChangelog.join(' | '));

    var diffSummary = diffLines.length
      ? diffLines.join('\n')
      : 'General improvements from ' + lastVersion + ' to ' + APP_VERSION;

    var topFeature = addedFeatures[0] || addedPages[0] || 'new improvements';
    var topPage    = addedPages[0]    || 'dashboard';

    var prompt =
      'You write short, exciting in-app update announcements for TrendVid AI â€” a creator platform.\n\n' +
      'Previous version: ' + (lastVersion || 'previous version') + '\n' +
      'New version: ' + APP_VERSION + ' (' + APP_FEATURE_MANIFEST.buildDate + ')\n\n' +
      'What changed (auto-detected by diffing the app manifest):\n' + diffSummary + '\n\n' +
      'Write a release announcement. Rules:\n' +
      '- title: punchy max-8-word headline celebrating the top new feature\n' +
      '- message: 2-3 sentences MAX. Creator-friendly tone. Max 2 emojis.\n' +
      '- cta: short action phrase like "Try Image Generator"\n' +
      '- ctaPage: internal page id (pick from: ' + topPage + ', dashboard, script, trends, library)\n' +
      '- highlights: array of 3-5 plain-text bullet strings summarising key changes\n' +
      'Return ONLY valid JSON, no code fences:\n' +
      '{"title":"...","message":"...","cta":"...","ctaPage":"...","highlights":["...","..."]}';

    var data = {};
    try {
      var raw = await aiCall(
        [{role: 'user', content: prompt}],
        'You write crisp app update announcements. Return ONLY valid raw JSON, no markdown.',
        600
      );
      var clean = raw.replace(/```json|```/g, '').trim();
      data = JSON.parse(clean);
    } catch(e) {
      // AI unavailable or JSON parse failed â€” use static fallback silently
      data = {
        title:      APP_VERSION + ' is live!',
        message:    'We shipped new features including ' + topFeature + '. Explore the app to see everything new!',
        cta:        "See what's new",
        ctaPage:    topPage,
        highlights: newChangelog.slice(0, 4).map(function(c){ return c.replace(/^v\d+[^:]*:\s*/, ''); })
      };
    }

    if (!Array.isArray(data.highlights) || !data.highlights.length) {
      data.highlights = diffLines.slice(0, 4);
    }

    // Save to changelog
    var changelog = [];
    try { changelog = JSON.parse(localStorage.getItem('tv_changelog') || '[]'); } catch(e) {}
    changelog.unshift({
      version:       APP_VERSION,
      date:          APP_FEATURE_MANIFEST.buildDate,
      type:          'feature',
      note:          data.message     || '',
      highlights:    data.highlights  || [],
      addedPages:    addedPages,
      addedFeatures: addedFeatures,
      at:            Date.now(),
      autoGenerated: true
    });
    try { localStorage.setItem('tv_changelog', JSON.stringify(changelog.slice(0, 50))); } catch(e) {}

    // Broadcast announcement to all users
    var announcements = [];
    try { announcements = JSON.parse(localStorage.getItem('tv_announcements') || '[]'); } catch(e) {}
    announcements.unshift({
      releasedAt:  Date.now(),
      title:       data.title       || (APP_VERSION + ' Update'),
      message:     data.message     || 'New features have been added!',
      cta:         data.cta         || "See what's new",
      ctaPage:     data.ctaPage     || 'dashboard',
      highlights:  data.highlights  || [],
      type:        'success',
      at:          Date.now(),
      version:     APP_VERSION,
      autoRelease: true
    });
    try { localStorage.setItem('tv_announcements', JSON.stringify(announcements.slice(0, 20))); } catch(e) {}

    if (typeof adminLogActivity === 'function') {
      adminLogActivity('system', 'System', 'Auto-released ' + APP_VERSION + ' - AI notes broadcast to all users');
    }
    if (currentUser && currentUser.isAdmin) {
      setTimeout(function() {
        notify(APP_VERSION + ' deployed - AI release notes sent to all users!', 'success', 'done');
      }, 2000);
    }

    return data;
  } catch(err) {
    console.warn('[TrendVid] Update check error:', err);
  }
}

// Show What's New modal to users on first login after an update

function dismissWhatsNewBanner() { var b = document.getElementById('whatsNewBanner'); if(b) b.remove(); }

function whatsNewCtaClick() {
  var banner = document.getElementById('whatsNewBanner');
  var page = banner ? (banner.dataset.ctaPage || 'dashboard') : 'dashboard';
  if (banner) banner.remove();
  navTo(page);
}


function _showWhatsNewBanner(release) {
  try {
    var existingBanner = document.getElementById('whatsNewBanner');
    if (existingBanner) existingBanner.remove();

    var banner = document.createElement('div');
    banner.id = 'whatsNewBanner';
    banner.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:99980;' +
      'background:var(--surface);border:1px solid rgba(0,229,176,0.4);border-radius:16px;' +
      'box-shadow:0 8px 40px rgba(0,0,0,0.5),0 0 0 1px rgba(0,229,176,0.1);' +
      'padding:16px 20px;max-width:400px;width:calc(100vw - 40px);animation:slideUp 0.4s ease both;';

    var hlHtml = (release.highlights && release.highlights.length)
      ? '<ul style="margin:4px 0 0 14px;padding:0;font-size:11px;color:var(--muted);line-height:1.8">' +
          release.highlights.slice(0,4).map(function(h){ return '<li>' + h + '</li>'; }).join('') +
        '</ul>'
      : '';

    banner.innerHTML =
      '<div style="display:flex;align-items:flex-start;gap:12px">' +
        '<div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,rgba(0,229,176,0.2),rgba(167,139,250,0.15));' +
             'border:1px solid rgba(0,229,176,0.3);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0">&#x1F680;</div>' +
        '<div style="flex:1;min-width:0">' +
          '<div style="font-size:13px;font-weight:800;margin-bottom:3px;color:var(--teal)">' + (release.title || "What's New") + '</div>' +
          '<div style="font-size:12px;color:var(--text2);line-height:1.5">' + (release.message || '') + '</div>' +
          hlHtml +
        '</div>' +
        '<button onclick="dismissWhatsNewBanner()" ' +
          'style="background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:16px;padding:0;flex-shrink:0;line-height:1">&#x2715;</button>' +
      '</div>' +
      '<div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">' +
        '<button onclick="dismissWhatsNewBanner()" ' +
          'style="background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:8px;padding:5px 14px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">Dismiss</button>' +
        '<button onclick="whatsNewCtaClick()" ' +
          'style="background:var(--teal);color:#000;border:none;border-radius:8px;padding:5px 14px;font-size:11px;font-weight:800;cursor:pointer;font-family:inherit">' + (release.cta || 'Try it now') + '</button>' +
      '</div>';

    banner.dataset.ctaPage = release.ctaPage || 'dashboard';
    document.body.appendChild(banner);

    setTimeout(function() {
      if (banner.parentNode) {
        banner.style.animation = 'fadeOut 0.4s ease forwards';
        setTimeout(function() { if (banner.parentNode) banner.remove(); }, 400);
      }
    }, 12000);
  } catch(e) {}
}

function checkShowWhatsNew() {
  try {
    var lastSeen = localStorage.getItem('tv_user_saw_version') || '';
    if (lastSeen === APP_VERSION) return;

    var announcements = [];
    try { announcements = JSON.parse(localStorage.getItem('tv_announcements') || '[]'); } catch(e) {}
    var release = announcements.find(function(a) { return a.autoRelease && a.version === APP_VERSION; });
    if (!release) return;

    var releasedAt = release.releasedAt || release.at || 0;
    var ageMs      = Date.now() - releasedAt;
    var userIsEA   = isEarlyAccessUser();

    if (!userIsEA && ageMs < EARLY_ACCESS_WINDOW_MS) {
      // Non-EA user: schedule banner to fire when 7-day window ends
      var waitMs = EARLY_ACCESS_WINDOW_MS - ageMs;
      setTimeout(function() {
        var stillUnseen = (localStorage.getItem('tv_user_saw_version') || '') !== APP_VERSION;
        if (stillUnseen) {
          localStorage.setItem('tv_user_saw_version', APP_VERSION);
          _showWhatsNewBanner(release);
        }
      }, waitMs);
      return; // don't mark as seen yet
    }

    // EA user (or 7 days already passed) â€” mark seen and show now
    localStorage.setItem('tv_user_saw_version', APP_VERSION);
    setTimeout(function() { _showWhatsNewBanner(release); }, 3500);
  } catch(e) {}
}


function adminSendBroadcast() {
  var title = esc(((document.getElementById('bcTitle')||{}).value||'').trim());
  var msg   = esc(((document.getElementById('bcMessage')||{}).value||'').trim());
  var type  = ['info','success','alert'].includes(window._bcType) ? window._bcType : 'info';
  if(!title||!msg) { notify('Please fill in title and message','error','âš ï¸'); return; }
  var announcements = [];
  try { announcements = JSON.parse(localStorage.getItem('tv_announcements')||'[]'); } catch(e) {}
  announcements.unshift({title:title,message:msg,type:type,at:Date.now()});
  try { localStorage.setItem('tv_announcements', JSON.stringify(announcements.slice(0,20))); } catch(e) {}
  notify('Announcement sent to all users!','success','ðŸ“¢');
  renderAdmin();
}

function adminDeleteAnnouncement(idx) {
  var announcements = [];
  try { announcements = JSON.parse(localStorage.getItem('tv_announcements')||'[]'); } catch(e) {}
  announcements.splice(idx,1);
  try { localStorage.setItem('tv_announcements', JSON.stringify(announcements)); } catch(e) {}
  renderAdmin();
}

function adminSaveNotes() {
  var val = ((document.getElementById('adminNotesArea')||{}).value)||'';
  try { localStorage.setItem('tv_admin_notes', val); } catch(e) {}
  var msg = document.getElementById('notesSavedMsg');
  if(msg) { msg.style.display='flex'; setTimeout(function(){ msg.style.display='none'; },2000); }
}

function adminUpgradeUser(email) {
  var plan = prompt('Set plan for '+email+':\n\nOptions: free, starter, pro, gold, elite');
  if(!plan) return;
  plan = plan.trim().toLowerCase();
  var valid = ['free','starter','pro','gold','elite'];
  if(!valid.includes(plan)) { notify('Invalid plan name','error','âš ï¸'); return; }
  var users = [];
  try { users = JSON.parse(localStorage.getItem('tv_all_users')||'[]'); } catch(e) {}
  for(var i=0;i<users.length;i++){
    if(users[i].email===email){ users[i].plan=plan; break; }
  }
  try { localStorage.setItem('tv_all_users', JSON.stringify(users)); } catch(e) {}
  notify('Plan updated to '+plan.toUpperCase()+' for '+email,'success','âœ…');
  renderAdmin();
}

function exportUserCSV() {
  var users = [];
  try { users = JSON.parse(localStorage.getItem('tv_all_users')||'[]'); } catch(e) {}
  if(users.length===0) { notify('No users to export','info','ðŸ“‹'); return; }
  var header = 'Name,Email,Plan,Weekly Reports,Credits,Joined,Last Seen';
  var rows = users.map(function(u) {
    return [
      (u.name||'').replace(/,/g,' '),
      u.email,
      u.plan||'free',
      u.weeklyReports===false?'No':'Yes',
      u.credits||0,
      u.joinedAt ? new Date(u.joinedAt).toLocaleDateString('en-GB') : '',
      u.lastLogin ? new Date(u.lastLogin).toLocaleDateString('en-GB') : ''
    ].join(',');
  });
  var csv = [header].concat(rows).join('\n');
  var blob = new Blob([csv], {type:'text/csv'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'trendvid-users-'+new Date().toISOString().slice(0,10)+'.csv';
  a.click();
  notify('Exported '+users.length+' users as CSV','success','â¬‡ï¸');
}

function adminDismissReport(idx) {
  var reports = [];
  try { reports = JSON.parse(localStorage.getItem('tv_reports')||'[]'); } catch(e) {}
  reports.splice(idx,1);
  try { localStorage.setItem('tv_reports', JSON.stringify(reports)); } catch(e) {}
  renderAdmin();
}

function adminClearUnusedCodes() {
  var gifts = [];
  try { gifts = JSON.parse(localStorage.getItem('tv_gifts')||'[]'); } catch(e) {}
  var before = gifts.length;
  gifts = gifts.filter(function(g){return g.used;});
  try { localStorage.setItem('tv_gifts', JSON.stringify(gifts)); } catch(e) {}
  notify('Removed '+(before-gifts.length)+' unused codes','info','ðŸ—‘ï¸');
  renderAdmin();
}

function adminAdjustCredits() {
  var email = ((document.getElementById('creditUserEmail')||{}).value||'');
  var amount = parseInt(((document.getElementById('creditAmount')||{}).value||'0'));
  if(!email) { notify('Enter user email','error','âš ï¸'); return; }
  if(isNaN(amount)||amount===0) { notify('Enter a non-zero amount','error','âš ï¸'); return; }
  var users = [];
  try { users = JSON.parse(localStorage.getItem('tv_all_users')||'[]'); } catch(e) {}
  var found = false;
  for(var i=0;i<users.length;i++){
    if(users[i].email===email){
      users[i].credits = Math.max(0,(users[i].credits||0)+amount);
      found = true;
      var fb = document.getElementById('creditFeedback');
      if(fb) fb.textContent = 'âœ… '+email+' now has '+users[i].credits+' credits';
      break;
    }
  }
  if(!found) { notify('User not found: '+email,'error','âš ï¸'); return; }
  try { localStorage.setItem('tv_all_users', JSON.stringify(users)); } catch(e) {}
  notify('Credits updated for '+email,'success','ðŸ’°');
}

function adminSavePrices() {
  var fields = ['starter','pro','gold','elite','scriptPerUse','scriptPack'];
  var prices = {};
  fields.forEach(function(f){ var el=document.getElementById('price_'+f); if(el) prices[f]=parseFloat(el.value)||0; });
  try { localStorage.setItem('tv_custom_prices', JSON.stringify(prices)); } catch(e) {}
  Object.keys(prices).forEach(function(t){ if(window.TIERS&&window.TIERS[t]&&prices[t]) window.TIERS[t].price='Â£'+prices[t]; });
  var el = document.getElementById('pricesSaved');
  if(el) { el.style.display='block'; setTimeout(function(){el.style.display='none';},3000); }
  notify('Prices saved!','success','ðŸ’·');
}

function adminGenerateCode() {
  var tierEl = document.getElementById('gcTierAdmin');
  var qtyEl  = document.getElementById('gcQty');
  var tier = tierEl ? tierEl.value : 'pro';
  var qty  = Math.min(50, Math.max(1, parseInt((qtyEl||{}).value)||1));
  var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  var gifts = [];
  try { gifts = JSON.parse(localStorage.getItem('tv_gifts')||'[]'); } catch(e) {}
  var codes = [];
  for(var q=0;q<qty;q++){
    var bytes = crypto.getRandomValues(new Uint8Array(8));
    var p1 = Array.from(bytes.slice(0,4)).map(function(b){return chars[b%chars.length];}).join('');
    var p2 = Array.from(bytes.slice(4,8)).map(function(b){return chars[b%chars.length];}).join('');
    var code = 'TV-'+p1+'-'+tier.substring(0,3).toUpperCase()+'-'+p2;
    codes.push(code);
    gifts.unshift({code:code,tier:tier,used:false,usedBy:null,createdAt:Date.now()});
  }
  try { localStorage.setItem('tv_gifts', JSON.stringify(gifts)); } catch(e) {}
  if(qty===1) {
    safeCopy(codes[0],'Copied: '+codes[0],'ðŸŽ');
  } else {
    safeCopy(codes.join('\n'),'Generated & copied '+qty+' codes','ðŸŽ');
  }
  renderAdmin();
}

function adminCopyUser(email) {
  safeCopy(email,'Email copied','ðŸ“‹');
}

function adminRemoveUser(email) {
  if(!confirm('Remove record for '+email+'? (Does not cancel subscription)')) return;
  var users = [];
  try { users = JSON.parse(localStorage.getItem('tv_all_users')||'[]'); } catch(e) {}
  users = users.filter(function(u){ return u.email!==email; });
  try { localStorage.setItem('tv_all_users', JSON.stringify(users)); } catch(e) {}
  notify('User record removed','info','ðŸ—‘ï¸');
  renderAdmin();
}

function trackUser(userData) {
  var users = [];
  try { users = JSON.parse(localStorage.getItem('tv_all_users')||'[]'); } catch(e) {}
  var existing = null;
  for(var i=0;i<users.length;i++){ if(users[i].email===userData.email){ existing=users[i]; break; } }
  if(existing) {
    existing.plan = userData.plan;
    existing.name = userData.name;
    existing.lastLogin = Date.now();
    existing.annual = userData.annual||false;
    existing.weeklyReports = userData.weeklyReports!==undefined ? userData.weeklyReports : existing.weeklyReports;
  } else {
    users.unshift({email:userData.email,name:userData.name,plan:userData.plan,annual:userData.annual||false,
      weeklyReports:userData.weeklyReports!==undefined?userData.weeklyReports:true,
      credits:0,joinedAt:Date.now(),lastLogin:Date.now()});
  }
  try { localStorage.setItem('tv_all_users', JSON.stringify(users.slice(0,500))); } catch(e) {}
}


// ============================================================
// WEEKLY EMAIL SYSTEM
// ============================================================
function checkAndSendWeeklyReports() {
  var lastSent = parseInt(localStorage.getItem('tv_weekly_last_sent') || '0');
  var now = Date.now();
  var WEEK = 7 * 24 * 60 * 60 * 1000;
  if (now - lastSent >= WEEK) {
    // Auto-send if overdue (silent â€” admin-controlled in practice)
    // In production this would trigger server-side. Here we log it.
    var users = [];
    try { users = JSON.parse(localStorage.getItem('tv_all_users')||'[]'); } catch(e) {}
    var optins = users.filter(function(u){ return u.weeklyReports !== false; });
    if (optins.length > 0 && lastSent > 0) {
      // weekly report trigger silenced
    }
  }
}

async function adminSendWeeklyEmails() {
  var users = [];
  try { users = JSON.parse(localStorage.getItem('tv_all_users')||'[]'); } catch(e) {}
  var optins = users.filter(function(u){ return u.weeklyReports !== false; });
  if (optins.length === 0) { notify('No opted-in users to send to','error','âš ï¸'); return; }

  var niche = (document.getElementById('weeklyNiche')||{}).value || 'general';
  notify('â³ Generating weekly email content...','info','ðŸ“§');

  try {
    var raw = await aiCall([{role:'user',content:
      'Generate a weekly creator newsletter for TrendVid users ('+niche+' niche). ' +
      'Return ONLY valid JSON: {'+
        '"subject":"...",'+
        '"trendingTopics":[{"title":"...","platform":"YouTube|TikTok|Instagram","score":number}],'+
        '"hookOfWeek":{"hook":"...","type":"Question|Shock|Story","tip":"..."},'+
        '"creatorTip":{"tip":"...","detail":"..."},'+
        '"algorithmUpdate":{"platform":"...","update":"...","action":"..."},'+
        '"thumbnailInsight":{"insight":"...","example":"..."},'+
        '"viralNicheAlert":{"niche":"...","why":"...","ideas":["...","..."]},'+
        '"weekIdeas":["idea1","idea2","idea3","idea4","idea5","idea6","idea7"],'+
        '"featureSpotlight":{"feature":"...","tip":"..."}'+
      '}'
    }], 'You are TrendVid AI generating a professional weekly newsletter. Be specific, data-driven and actionable. Return ONLY valid JSON.', 1800);

    var data = {};
    try { data = JSON.parse(raw.replace(/```json|```/g,'').trim()); } catch(e) {
      throw new Error('Could not parse AI response. Try again.');
    }

    // Log the send
    var log = [];
    try { log = JSON.parse(localStorage.getItem('tv_weekly_log')||'[]'); } catch(e) {}
    log.unshift({ at: Date.now(), count: optins.length, niche: niche, subject: data.subject || 'TrendVid Weekly', data: data });
    try { localStorage.setItem('tv_weekly_log', JSON.stringify(log.slice(0,20))); } catch(e) {}
    localStorage.setItem('tv_weekly_last_sent', Date.now().toString());

    // In a real app, this would POST to your backend/email service
    // For now, show the generated email preview and log it
    showWeeklyEmailPreview(data, optins);
    notify('ðŸ“§ Weekly email generated & logged for '+optins.length+' users!','success','âœ…');
    renderAdmin();
  } catch(err) {
    notify('Error: '+err.message,'error','âš ï¸');
  }
}

async function adminPreviewWeeklyEmail() {
  var niche = (document.getElementById('weeklyNiche')||{}).value || 'general';
  notify('â³ Generating preview...','info','ðŸ“§');
  try {
    var raw = await aiCall([{role:'user',content:
      'Generate a weekly creator newsletter for TrendVid users ('+niche+' niche). ' +
      'Return ONLY valid JSON: {'+
        '"subject":"...",'+
        '"trendingTopics":[{"title":"...","platform":"YouTube|TikTok|Instagram","score":number}],'+
        '"hookOfWeek":{"hook":"...","type":"Question|Shock|Story","tip":"..."},'+
        '"creatorTip":{"tip":"...","detail":"..."},'+
        '"algorithmUpdate":{"platform":"...","update":"...","action":"..."},'+
        '"thumbnailInsight":{"insight":"...","example":"..."},'+
        '"viralNicheAlert":{"niche":"...","why":"...","ideas":["...","..."]},'+
        '"weekIdeas":["idea1","idea2","idea3","idea4","idea5","idea6","idea7"],'+
        '"featureSpotlight":{"feature":"...","tip":"..."}'+
      '}'
    }], 'Return ONLY valid raw JSON, no markdown.', 1800);
    var data = {};
    try { data = JSON.parse(raw.replace(/```json|```/g,'').trim()); } catch(e) {}
    showWeeklyEmailPreview(data, []);
  } catch(err) {
    notify('Error: '+err.message,'error','âš ï¸');
  }
}

function showWeeklyEmailPreview(data, recipients) {
  var existing = document.getElementById('weeklyPreviewModal');
  if (existing) existing.remove();

  var topics = (data.trendingTopics||[]).map(function(t,i){
    return '<tr><td style="padding:8px 0;border-bottom:1px solid #2a2a3a;font-size:14px;font-weight:700;color:#fff">'+(i+1)+'. '+t.title+'</td>'+
      '<td style="padding:8px;border-bottom:1px solid #2a2a3a;text-align:right"><span style="font-size:11px;color:#00e5b0;background:rgba(0,229,176,0.1);padding:2px 8px;border-radius:4px">'+t.platform+'</span></td>'+
      '<td style="padding:8px;border-bottom:1px solid #2a2a3a;text-align:right;font-size:13px;font-weight:800;color:#fbbf24">'+t.score+'/100</td></tr>';
  }).join('');

  var ideas = (data.weekIdeas||[]).map(function(idea,i){
    var days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    return '<div style="display:flex;gap:12px;align-items:flex-start;padding:8px 0;border-bottom:1px solid #2a2a3a">'+
      '<div style="background:rgba(255,48,88,0.2);color:#ff3058;border-radius:6px;padding:2px 8px;font-size:11px;font-weight:800;flex-shrink:0;min-width:36px;text-align:center">'+(days[i]||'D'+(i+1))+'</div>'+
      '<div style="font-size:13px;color:#c8d8f0">'+idea+'</div>'+
    '</div>';
  }).join('');

  var emailHtml = 
    '<div style="background:#060810;color:#eef2ff;font-family:DM Sans,sans-serif;max-width:600px;margin:0 auto;border-radius:16px;overflow:hidden;border:1px solid #1e2538">'+
      // Header
      '<div style="background:linear-gradient(135deg,#0d1020,#1a1040);padding:32px 36px;text-align:center">'+
        '<div style="font-size:28px;font-weight:900;letter-spacing:4px;background:linear-gradient(90deg,#ff3058,#ff7b00);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px">TRENDVID</div>'+
        '<div style="font-size:11px;color:#566380;letter-spacing:2px;text-transform:uppercase">Weekly Creator Intelligence</div>'+
        '<div style="margin-top:16px;padding:10px 20px;background:rgba(255,48,88,0.1);border:1px solid rgba(255,48,88,0.25);border-radius:8px;display:inline-block">'+
          '<div style="font-size:18px;font-weight:800;color:#fff">'+(data.subject||'Your Weekly Creator Briefing')+'</div>'+
        '</div>'+
      '</div>'+
      // Trending
      '<div style="padding:28px 36px;border-bottom:1px solid #1e2538">'+
        '<div style="font-size:10px;font-weight:800;letter-spacing:3px;color:#566380;margin-bottom:14px">ðŸ“ˆ TRENDING THIS WEEK</div>'+
        '<table style="width:100%;border-collapse:collapse">'+topics+'</table>'+
      '</div>'+
      // Hook of the week
      '<div style="padding:28px 36px;border-bottom:1px solid #1e2538;background:rgba(255,48,88,0.03)">'+
        '<div style="font-size:10px;font-weight:800;letter-spacing:3px;color:#566380;margin-bottom:12px">ðŸª HOOK OF THE WEEK</div>'+
        '<div style="border-left:3px solid #ff3058;padding-left:16px;margin-bottom:12px">'+
          '<div style="font-size:16px;font-weight:700;color:#fff;margin-bottom:6px;line-height:1.5">"'+(data.hookOfWeek&&data.hookOfWeek.hook||'â€”')+'"</div>'+
          '<div style="font-size:11px;color:#566380">Type: '+(data.hookOfWeek&&data.hookOfWeek.type||'â€”')+'</div>'+
        '</div>'+
        '<div style="background:rgba(0,229,176,0.06);border:1px solid rgba(0,229,176,0.2);border-radius:8px;padding:12px;font-size:12px;color:#a8b8d8">'+
          'ðŸ’¡ '+(data.hookOfWeek&&data.hookOfWeek.tip||'â€”')+
        '</div>'+
      '</div>'+
      // Creator tip
      '<div style="padding:28px 36px;border-bottom:1px solid #1e2538">'+
        '<div style="font-size:10px;font-weight:800;letter-spacing:3px;color:#566380;margin-bottom:12px">ðŸ’¡ CREATOR TIP THIS WEEK</div>'+
        '<div style="font-size:15px;font-weight:700;color:#fff;margin-bottom:8px">'+(data.creatorTip&&data.creatorTip.tip||'â€”')+'</div>'+
        '<div style="font-size:13px;color:#a8b8d8;line-height:1.7">'+(data.creatorTip&&data.creatorTip.detail||'')+'</div>'+
      '</div>'+
      // Algorithm update
      '<div style="padding:28px 36px;border-bottom:1px solid #1e2538;background:rgba(251,191,36,0.03)">'+
        '<div style="font-size:10px;font-weight:800;letter-spacing:3px;color:#566380;margin-bottom:12px">ðŸ“Š ALGORITHM UPDATE</div>'+
        '<div style="display:flex;gap:10px;align-items:flex-start">'+
          '<span style="background:rgba(251,191,36,0.15);color:#fbbf24;font-size:10px;font-weight:800;padding:3px 10px;border-radius:6px;flex-shrink:0">'+(data.algorithmUpdate&&data.algorithmUpdate.platform||'â€”')+'</span>'+
          '<div>'+
            '<div style="font-size:13px;color:#eef2ff;font-weight:600;margin-bottom:4px">'+(data.algorithmUpdate&&data.algorithmUpdate.update||'â€”')+'</div>'+
            '<div style="font-size:12px;color:#a8b8d8">âœ… What to do: '+(data.algorithmUpdate&&data.algorithmUpdate.action||'â€”')+'</div>'+
          '</div>'+
        '</div>'+
      '</div>'+
      // Thumbnail insight
      '<div style="padding:28px 36px;border-bottom:1px solid #1e2538">'+
        '<div style="font-size:10px;font-weight:800;letter-spacing:3px;color:#566380;margin-bottom:12px">ðŸŽ¨ THUMBNAIL INSIGHT</div>'+
        '<div style="font-size:14px;font-weight:700;color:#fff;margin-bottom:6px">'+(data.thumbnailInsight&&data.thumbnailInsight.insight||'â€”')+'</div>'+
        '<div style="font-size:12px;color:#a8b8d8;font-style:italic">'+(data.thumbnailInsight&&data.thumbnailInsight.example||'')+'</div>'+
      '</div>'+
      // Viral niche alert
      '<div style="padding:28px 36px;border-bottom:1px solid #1e2538;background:rgba(167,139,250,0.03)">'+
        '<div style="font-size:10px;font-weight:800;letter-spacing:3px;color:#566380;margin-bottom:12px">ðŸ”¥ VIRAL NICHE ALERT</div>'+
        '<div style="font-size:16px;font-weight:800;color:#fff;margin-bottom:6px">'+(data.viralNicheAlert&&data.viralNicheAlert.niche||'â€”')+'</div>'+
        '<div style="font-size:12px;color:#a8b8d8;margin-bottom:10px">'+(data.viralNicheAlert&&data.viralNicheAlert.why||'')+'</div>'+
        '<div style="display:flex;flex-wrap:wrap;gap:6px">'+
          (data.viralNicheAlert&&data.viralNicheAlert.ideas||[]).map(function(idea){
            return '<span style="background:rgba(167,139,250,0.12);border:1px solid rgba(167,139,250,0.25);color:#a78bfa;font-size:11px;padding:3px 10px;border-radius:6px">'+idea+'</span>';
          }).join('')+
        '</div>'+
      '</div>'+
      // Week ideas
      '<div style="padding:28px 36px;border-bottom:1px solid #1e2538">'+
        '<div style="font-size:10px;font-weight:800;letter-spacing:3px;color:#566380;margin-bottom:14px">ðŸ“… YOUR CONTENT PLAN THIS WEEK</div>'+
        ideas+
      '</div>'+
      // Feature spotlight
      '<div style="padding:28px 36px;border-bottom:1px solid #1e2538;background:rgba(0,229,176,0.03)">'+
        '<div style="font-size:10px;font-weight:800;letter-spacing:3px;color:#566380;margin-bottom:10px">âš¡ TRENDVID FEATURE SPOTLIGHT</div>'+
        '<div style="font-size:14px;font-weight:700;color:#fff;margin-bottom:6px">'+(data.featureSpotlight&&data.featureSpotlight.feature||'â€”')+'</div>'+
        '<div style="font-size:12px;color:#a8b8d8">'+(data.featureSpotlight&&data.featureSpotlight.tip||'')+'</div>'+
      '</div>'+
      // Footer
      '<div style="padding:24px 36px;text-align:center;background:#0c0f1a">'+
        '<div style="font-size:12px;color:#566380;line-height:1.8">'+
          'You\'re receiving this because you opted in to weekly reports.<br>'+
          '<span style="color:#a8b8d8">Â© TrendVid AI Â· Unsubscribe in Settings</span>'+
        '</div>'+
      '</div>'+
    '</div>';

  var modal = document.createElement('div');
  modal.id = 'weeklyPreviewModal';
  modal.className = 'modal-overlay show';
  modal.style.cssText = 'z-index:99999;overflow-y:auto;padding:20px;';
  modal.innerHTML = 
    '<div style="max-width:660px;margin:0 auto;position:relative">'+
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">'+
        '<div style="font-size:14px;font-weight:800;color:#fff">ðŸ“§ Weekly Email Preview'+(recipients.length?' â€” Sending to '+recipients.length+' users':'')+'</div>'+
        '<div style="display:flex;gap:8px">'+
          '<button class="btn btn-teal btn-sm" onclick="copyWeeklyEmailHTML()">ðŸ“‹ Copy HTML</button>'+
          '<button class="btn btn-ghost btn-sm" onclick="document.getElementById(\&quot;weeklyPreviewModal\&quot;).remove()">âœ• Close</button>'+
        '</div>'+
      '</div>'+
      '<div id="weeklyEmailBody">'+emailHtml+'</div>'+
    '</div>';
  document.body.appendChild(modal);
}

function copyWeeklyEmailHTML() {
  var el = document.getElementById('weeklyEmailBody');
  if (!el) return;
  safeCopy(el.innerHTML,'Copied!','ðŸ“‹');
}

// ============================================================
// AI PROVIDER ADMIN FUNCTIONS
// ============================================================
function adminToggleAIPause(idx) {
  if (!_aiProviders[idx]) return;
  _aiProviders[idx].paused = !_aiProviders[idx].paused;
  var p = _aiProviders[idx];
  saveAIProviders();
  // If we paused the active one, switch to next available
  if (p.paused && _activeProviderKey === p.id) {
    var next = getNextFallbackProvider(p.id);
    _activeProviderKey = next ? next.id : null;
  }
  notify((p.paused ? 'â¸ Paused: ' : 'â–¶ Unpaused: ') + p.name, p.paused ? 'error' : 'success', p.paused ? 'â¸' : 'â–¶');
  renderAdmin();
}

function adminSetPrimaryAI(idx) {
  _aiProviders.forEach(function(p, i){ p.isPrimary = (i === idx); });
  _activeProviderKey = _aiProviders[idx].id;
  saveAIProviders();
  notify('â­ '+_aiProviders[idx].name+' set as primary provider','success','â­');
  renderAdmin();
}

function adminEditAI(idx) {
  var p = _aiProviders[idx];
  if (!p) return;
  var newKey = prompt('API Key for '+p.name+' (leave blank to keep current):', '');
  if (newKey === null) return; // cancelled
  if (newKey.trim()) p.key = newKey.trim();
  var newModel = prompt('Model name for '+p.name+':', p.model || '');
  if (newModel === null) return;
  if (newModel.trim()) p.model = newModel.trim();
  if (p.type === 'openai-compat') {
    var newEndpoint = prompt('API Endpoint URL:', p.endpoint || '');
    if (newEndpoint !== null && newEndpoint.trim()) p.endpoint = newEndpoint.trim();
  }
  saveAIProviders();
  notify('âœ… '+p.name+' updated','success','âœï¸');
  renderAdmin();
}

function adminRemoveAI(idx) {
  var p = _aiProviders[idx];
  if (!p) return;
  if (p.id === 'groq-default') { notify('Cannot remove the built-in Groq provider','error','âš ï¸'); return; }
  if (!confirm('Remove provider "'+p.name+'"? This cannot be undone.')) return;
  _aiProviders.splice(idx, 1);
  saveAIProviders();
  notify('ðŸ—‘ï¸ Removed: '+p.name,'info','ðŸ—‘ï¸');
  renderAdmin();
}

function adminShowAddAI() {
  var form = document.getElementById('addAIForm');
  if (!form) return;
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
  if (form.style.display === 'none') return;
  form.innerHTML =
    '<div style="font-size:14px;font-weight:800;margin-bottom:14px">+ Add New AI Provider</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">'+
      '<div class="form-field" style="margin:0"><label>Provider Name</label><input class="form-input" id="aiNewName" placeholder="e.g. OpenAI GPT-4o"></div>'+
      '<div class="form-field" style="margin:0"><label>Type</label>'+
        '<select class="form-input form-select" id="aiNewType" onchange="adminToggleEndpointField()">'+
          '<option value="groq">Groq</option>'+
          '<option value="gemini">Gemini (Google)</option>'+
          '<option value="openai">OpenAI</option>'+
          '<option value="openai-compat">OpenAI-Compatible (Ollama, DeepSeek, Together, Mistralâ€¦)</option>'+
        '</select>'+
      '</div>'+
      '<div class="form-field" style="margin:0"><label>Model Name</label><input class="form-input" id="aiNewModel" placeholder="e.g. gpt-4o-mini"></div>'+
      '<div class="form-field" style="margin:0"><label>API Key</label><input class="form-input" id="aiNewKey" type="password" placeholder="sk-... or gsk_..."></div>'+
    '</div>'+
    '<div class="form-field" id="aiEndpointField" style="margin-top:10px;display:none">'+
      '<label>API Endpoint URL</label>'+
      '<input class="form-input" id="aiNewEndpoint" placeholder="e.g. https://api.deepseek.com/v1/chat/completions">'+
    '</div>'+
    '<div style="display:flex;gap:8px;margin-top:14px">'+
      '<button class="btn btn-primary" onclick="adminSaveNewAI()">+ Add Provider</button>'+
      '<button class="btn btn-ghost" onclick="document.getElementById(\&quot;addAIForm\&quot;).style.display=\&quot;none\&quot;">Cancel</button>'+
    '</div>';
}

function adminToggleEndpointField() {
  var type = (document.getElementById('aiNewType')||{}).value;
  var field = document.getElementById('aiEndpointField');
  if (field) field.style.display = type === 'openai-compat' ? 'block' : 'none';
}

function adminSaveNewAI() {
  var name = ((document.getElementById('aiNewName')||{}).value||'').trim();
  var type = ((document.getElementById('aiNewType')||{}).value||'groq');
  var model = ((document.getElementById('aiNewModel')||{}).value||'').trim();
  var key = ((document.getElementById('aiNewKey')||{}).value||'').trim();
  var endpoint = ((document.getElementById('aiNewEndpoint')||{}).value||'').trim();
  if (!name) { notify('Please enter a provider name','error','âš ï¸'); return; }
  if (!model) { notify('Please enter a model name','error','âš ï¸'); return; }
  if (!key && type !== 'openai-compat') { notify('Please enter an API key','error','âš ï¸'); return; }
  if (type === 'openai-compat' && !endpoint) { notify('Please enter the endpoint URL','error','âš ï¸'); return; }
  var newProvider = {
    id: 'custom-'+Date.now(),
    name: name, type: type, model: model, key: key,
    isPrimary: false, paused: false, addedAt: Date.now(), callCount: 0
  };
  if (endpoint) newProvider.endpoint = endpoint;
  _aiProviders.push(newProvider);
  saveAIProviders();
  notify('âœ… Added: '+name,'success','ðŸ¤–');
  renderAdmin();
}

// ============================================================
// SOUNDTRACK FINDER â€” paid feature
// ============================================================
function renderSoundtrack() {
  if(!currentUser) return;
  var plan = currentUser.plan || 'free';
  var allowed = plan === 'pro' || plan === 'gold' || plan === 'elite' || currentUser.isAdmin;
  var pc = document.getElementById('pageContent');
  if(!pc) return;
  if(!allowed) {
    showUpgradeGate('soundtrack');
    return;
  }
  pc.innerHTML = '<div class="section-label" style="margin-bottom:16px">ðŸŽµ SOUNDTRACK FINDER</div>' +
    '<div class="card" style="margin-bottom:16px">' +
      '<div style="font-size:13px;font-weight:700;margin-bottom:12px">Identify music from a video</div>' +
      '<div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:flex-end;margin-bottom:14px">' +
        '<div class="form-field" style="margin:0"><label>Paste a Video URL (YouTube, TikTok, Instagram)</label><input class="form-input" id="soundtrackUrl" placeholder="https://www.youtube.com/watch?v=..."></div>' +
        '<button class="btn btn-primary" id="soundtrackBtn" onclick="findSoundtrack()">ðŸŽµ Find Music</button>' +
      '</div>' +
      '<div style="text-align:center;padding:12px;border:2px dashed var(--border);border-radius:10px;color:var(--muted);font-size:13px">' +
        '<div style="font-size:24px;margin-bottom:6px">ðŸ“</div>' +
        '<div>Or <label style="color:var(--accent);cursor:pointer;text-decoration:underline" for="soundtrackFile">upload a video file</label></div>' +
        '<input type="file" id="soundtrackFile" accept="video/*,audio/*" style="display:none" onchange="handleSoundtrackFile(this)">' +
        '<div style="font-size:11px;margin-top:4px">MP4, MOV, WebM, MP3, WAV accepted</div>' +
      '</div>' +
    '</div>' +
    '<div id="soundtrackOutput"></div>';
}

async function findSoundtrack() {
  var url = (document.getElementById('soundtrackUrl') || {}).value || '';
  var btn = document.getElementById('soundtrackBtn');
  var out = document.getElementById('soundtrackOutput');
  if(!url) { notify('Paste a video URL first', 'error', 'âš ï¸'); return; }
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner spinner-sm"></div> Analysing...';
  out.innerHTML = '<div class="ai-thinking"><div class="spinner"></div><span>Analysing video for music...</span></div>';
  try {
    var raw = await aiCall([{role:'user',content:'A user wants to identify songs and soundtracks used in this video: "' + url + '". Based on what you know about this video or typical music choices for content like this, suggest the most likely tracks. Return ONLY valid JSON: {"tracks":[{"title":"Song Title","artist":"Artist Name","album":"Album (if known)","genre":"Genre","yearReleased":"Year","type":"Background|Main Theme|Transition","whereInVideo":"e.g. Throughout, 0:00-1:30","royaltyFree":true or false,"licenseType":"Copyright|Creative Commons|Public Domain","whereToFind":"Platform/store links","alternativeFreeVersion":"if royalty-free alternative exists"}],"disclaimer":"note about accuracy"}'}], 1200);
    var data;
    try { data = JSON.parse(raw.replace(/```json|```/g,'').trim()); } catch(e) { data = {tracks:[], disclaimer:'Could not parse tracks'}; }
    if(!data.tracks || data.tracks.length === 0) {
      out.innerHTML = '<div class="card" style="text-align:center;padding:40px;color:var(--muted)">' +
        '<div style="font-size:36px;margin-bottom:12px">ðŸŽµ</div>' +
        '<div style="font-size:14px;font-weight:700">No tracks identified</div>' +
        '<div style="font-size:12px;margin-top:6px">Try a different URL or upload the audio file directly</div>' +
      '</div>';
    } else {
      var html = data.tracks.map(function(t, i) {
        var rfColor = t.royaltyFree ? 'var(--teal)' : 'var(--accent)';
        var rfLabel = t.royaltyFree ? 'âœ… Royalty Free' : 'âš ï¸ Copyrighted';
        return '<div class="card" style="margin-bottom:10px">' +
          '<div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px;margin-bottom:10px">' +
            '<div>' +
              '<div style="font-size:15px;font-weight:800">' + t.title + '</div>' +
              '<div style="font-size:12px;color:var(--muted)">' + t.artist + (t.album ? ' Â· ' + t.album : '') + (t.yearReleased ? ' Â· ' + t.yearReleased : '') + '</div>' +
            '</div>' +
            '<span style="font-size:11px;font-weight:700;padding:3px 10px;border-radius:6px;background:' + rfColor.replace('var(--teal)','rgba(0,212,170,0.1)').replace('var(--accent)','rgba(255,48,88,0.1)') + ';color:' + rfColor + '">' + rfLabel + '</span>' +
          '</div>' +
          '<div style="display:flex;flex-wrap:wrap;gap:10px;font-size:12px;color:var(--text2);margin-bottom:10px">' +
            '<span>ðŸŽµ ' + (t.genre||'Unknown') + '</span>' +
            '<span>ðŸ“Œ ' + (t.type||'Background') + '</span>' +
            '<span>â± ' + (t.whereInVideo||'Throughout') + '</span>' +
            '<span>ðŸ“œ ' + (t.licenseType||'Unknown') + '</span>' +
          '</div>' +
          (t.alternativeFreeVersion ? '<div style="font-size:11px;color:var(--teal);margin-bottom:10px">ðŸ’¡ Free alternative: ' + t.alternativeFreeVersion + '</div>' : '') +
          '<div style="display:flex;gap:6px;flex-wrap:wrap">' +
            '<a href="https://www.youtube.com/results?search_query=' + encodeURIComponent(t.title + ' ' + t.artist) + '" target="_blank" class="btn btn-secondary btn-sm" style="font-size:11px">â–¶ YouTube</a>' +
            '<a href="https://open.spotify.com/search/' + encodeURIComponent(t.title + ' ' + t.artist) + '" target="_blank" class="btn btn-secondary btn-sm" style="font-size:11px">ðŸŽ§ Spotify</a>' +
            '<a href="https://www.shazam.com/search?term=' + encodeURIComponent(t.title + ' ' + t.artist) + '" target="_blank" class="btn btn-secondary btn-sm" style="font-size:11px">ðŸ”Š Shazam</a>' +
          '</div>' +
        '</div>';
      }).join('');
      out.innerHTML = '<div style="font-size:11px;color:var(--muted);margin-bottom:12px;padding:8px 12px;background:rgba(255,191,36,0.06);border:1px solid rgba(255,191,36,0.2);border-radius:8px">âš ï¸ ' + (data.disclaimer||'AI identification â€” verify with Shazam for accuracy') + '</div>' + html;
    }
    showWatermark();
  } catch(err) {
    out.innerHTML = '<div style="color:var(--accent);padding:14px">Error: ' + err.message + '</div>';
  }
  btn.disabled = false;
  btn.innerHTML = 'ðŸŽµ Find Music';
}

function handleSoundtrackFile(input) {
  var file = input.files[0];
  if(!file) return;
  notify('File uploaded: ' + file.name + ' â€” analysing...', 'info', 'ðŸŽµ');
  // Simulate via AI since we can't process audio in-browser
  var out = document.getElementById('soundtrackOutput');
  var _fnSpan = document.createElement('span');
  _fnSpan.textContent = 'Analysing audio from ' + file.name + '...';
  out.innerHTML = '<div class="ai-thinking"><div class="spinner"></div></div>';
  out.querySelector('.ai-thinking').appendChild(_fnSpan);
  setTimeout(function() {
    out.innerHTML = '<div class="card" style="text-align:center;padding:30px;color:var(--muted)">' +
      '<div style="font-size:36px;margin-bottom:12px">ðŸŽµ</div>' +
      '<div style="font-size:14px;font-weight:700;margin-bottom:8px">Audio uploaded</div>' +
      '<div style="font-size:12px;line-height:1.6">For best results, try <a href="https://www.shazam.com" target="_blank" style="color:var(--accent)">Shazam</a> or <a href="https://www.audiotag.info" target="_blank" style="color:var(--accent)">AudioTag.info</a> to identify exact tracks from uploaded audio files. These services have extensive music databases.</div>' +
    '</div>';
  }, 1500);
}

// ============================================================
// PAY-PER-SCRIPT â€” Â£0.50 per script on free plan
// ============================================================
var _scriptCredits = 0;
function getScriptCredits() {
  try { _scriptCredits = parseInt(localStorage.getItem('tv_script_credits') || '3'); } catch(e) { _scriptCredits = 3; }
  return _scriptCredits;
}
function deductScriptCredit() {
  var credits = getScriptCredits();
  if(credits <= 0) return false;
  credits--;
  try { localStorage.setItem('tv_script_credits', credits.toString()); } catch(e) {}
  _scriptCredits = credits;
  return true;
}
function showPayPerScriptModal() {
  var prices = {};
  try { prices = JSON.parse(localStorage.getItem('tv_custom_prices') || '{}'); } catch(e) {}
  var perScript = parseFloat(prices.scriptPerUse || '0.50');
  var packPrice = parseFloat(prices.scriptPack || '5');
  var bundle25 = parseFloat(prices.bundle25 || '10');
  var save10Pct = Math.max(0, Math.round(100 - (packPrice / (perScript * 10)) * 100));
  var existing = document.getElementById('payPerScriptModal');
  if(existing) existing.remove();
  var modal = document.createElement('div');
  modal.id = 'payPerScriptModal';
  modal.className = 'modal-overlay show';
  modal.innerHTML =
    '<div class="modal-box" style="max-width:480px">' +
      '<div style="font-size:36px;margin-bottom:8px">&#x270d;&#xfe0f;</div>' +
      '<div class="modal-title">Script Credits</div>' +
      '<div class="modal-sub">You&#39;ve used your free scripts. Top up to keep creating &mdash; no subscription needed.</div>' +
      '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:20px 0">' +
        '<div style="border:1px solid var(--border2);border-radius:12px;padding:14px;text-align:center;cursor:pointer;transition:border-color 0.15s" onmouseover="this.style.borderColor=&quot;rgba(255,48,88,0.5)&quot;" onmouseout="this.style.borderColor=&quot;var(--border2)&quot;">' +
          '<div style="font-size:22px;margin-bottom:6px">&#x270d;&#xfe0f;</div>' +
          '<div style="font-weight:900;font-size:18px;color:var(--text)">&#163;'+perScript.toFixed(2)+'</div>' +
          '<div style="font-size:11px;color:var(--muted);margin:3px 0 10px">1 Script</div>' +
          '<button class="btn btn-primary btn-sm" style="width:100%;font-size:11px" onclick="buyScriptCredits(1,&quot;&#163;&quot;+perScript.toFixed(2)+&quot;&quot;)">Buy</button>' +
        '</div>' +
        '<div style="border:2px solid rgba(251,191,36,0.5);border-radius:12px;padding:14px;text-align:center;cursor:pointer;background:rgba(251,191,36,0.04);position:relative;transition:background 0.15s" onmouseover="this.style.background=&quot;rgba(251,191,36,0.09)&quot;" onmouseout="this.style.background=&quot;rgba(251,191,36,0.04)&quot;">' +
          '<div style="position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:var(--gold);color:#000;font-size:9px;font-weight:900;padding:2px 10px;border-radius:10px;white-space:nowrap">SAVE '+save10Pct+'%</div>' +
          '<div style="font-size:22px;margin-bottom:6px">&#128230;</div>' +
          '<div style="font-weight:900;font-size:18px;color:var(--gold)">&#163;'+packPrice.toFixed(2)+'</div>' +
          '<div style="font-size:11px;color:var(--muted);margin:3px 0 10px">10 Scripts</div>' +
          '<button class="btn btn-gold btn-sm" style="width:100%;font-size:11px" onclick="buyScriptCredits(10,&quot;&#163;&quot;+packPrice.toFixed(2)+&quot; for 10&quot;)">Best Value</button>' +
        '</div>' +
        '<div style="border:1px solid rgba(167,139,250,0.4);border-radius:12px;padding:14px;text-align:center;cursor:pointer;transition:border-color 0.15s" onmouseover="this.style.borderColor=&quot;rgba(167,139,250,0.7)&quot;" onmouseout="this.style.borderColor=&quot;rgba(167,139,250,0.4)&quot;">' +
          '<div style="font-size:22px;margin-bottom:6px">&#128640;</div>' +
          '<div style="font-weight:900;font-size:18px;color:var(--purple)">&#163;'+bundle25.toFixed(2)+'</div>' +
          '<div style="font-size:11px;color:var(--muted);margin:3px 0 10px">25 Scripts</div>' +
          '<button class="btn btn-sm" style="width:100%;font-size:11px;background:rgba(167,139,250,0.15);border:1px solid rgba(167,139,250,0.4);color:var(--purple)" onclick="buyScriptCredits(25,&quot;&#163;&quot;+bundle25.toFixed(2)+&quot; for 25&quot;)">Power Pack</button>' +
        '</div>' +
      '</div>' +
      '<div style="background:rgba(0,229,176,0.05);border:1px solid rgba(0,229,176,0.2);border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:12px;color:var(--teal);display:flex;align-items:center;gap:8px">' +
        '<span style="font-size:16px">&#128161;</span>' +
        '<span>Credits never expire. Upgrade to a plan for unlimited scripts from <strong>&#163;9/mo</strong>.</span>' +
      '</div>' +
      '<div style="display:flex;gap:8px">' +
        '<button class="btn btn-secondary" style="flex:1" onclick="navTo(&quot;pricing&quot;);document.getElementById(&quot;payPerScriptModal&quot;).remove()">View Plans &rarr;</button>' +
        '<button class="btn btn-ghost" onclick="document.getElementById(&quot;payPerScriptModal&quot;).remove()">Maybe later</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(modal);
}

function buyScriptCredits(qty, priceLabel) {
  // Get admin-configured Stripe link for script credits
  var stripeCfg = {}; try { stripeCfg = JSON.parse(localStorage.getItem('tv_stripe_cfg') || '{}'); } catch(e) {}
  var prices = {}; try { prices = JSON.parse(localStorage.getItem('tv_custom_prices') || '{}'); } catch(e) {}

  // Map qty to the right link â€” admin configures these in Settings â†’ Stripe
  var linkMap = {
    1:  stripeCfg.creditLink1  || stripeCfg.scriptLink1  || stripeCfg.creditLink || '',
    10: stripeCfg.creditLink10 || stripeCfg.scriptLink10 || stripeCfg.creditLink || '',
    25: stripeCfg.creditLink25 || stripeCfg.scriptLink25 || stripeCfg.creditLink || ''
  };
  var link = linkMap[qty] || '';

  // Log purchase intent for admin
  try {
    var notifs = JSON.parse(localStorage.getItem('tv_admin_notifs') || '[]');
    notifs.unshift({
      type: 'script_credit_intent',
      icon: 'âœï¸',
      title: 'Script Credit Purchase',
      body: (currentUser && currentUser.email ? currentUser.email + ' â€” ' : '') + qty + ' script' + (qty > 1 ? 's' : '') + ' (' + priceLabel + ')',
      at: Date.now(),
      read: false
    });
    localStorage.setItem('tv_admin_notifs', JSON.stringify(notifs.slice(0, 100)));
    var log = []; try { log = JSON.parse(localStorage.getItem('tv_activity_log') || '[]'); } catch(le) {}
    log.unshift({ type: 'script_buy', qty: qty, price: priceLabel, at: Date.now(), user: currentUser && currentUser.email });
    localStorage.setItem('tv_activity_log', JSON.stringify(log.slice(0, 200)));
  } catch(e) {}

  if (!link) {
    // No Stripe link configured â€” show info and redirect to pricing/bundles
    var modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.innerHTML =
      '<div class="modal-box" style="max-width:380px;text-align:center">' +
        '<div style="font-size:48px;margin-bottom:12px">âœï¸</div>' +
        '<div class="modal-title">Script Credits</div>' +
        '<div class="modal-sub" style="margin-bottom:20px">Buying <strong>' + qty + ' script credit' + (qty > 1 ? 's' : '') + '</strong> for <strong>' + priceLabel + '</strong>.<br>Checkout will be available shortly â€” view our full plans in the meantime.</div>' +
        '<div style="display:flex;gap:8px">' +
          '<button class="btn btn-primary" style="flex:1" onclick="navTo(\'pricing\');this.closest(\'.modal-overlay\').remove()">View Plans â†’</button>' +
          '<button class="btn btn-ghost" onclick="this.closest(\'.modal-overlay\').remove()">Close</button>' +
        '</div>' +
      '</div>';
    document.body.appendChild(modal);
    return;
  }

  // Add user email prefill if available
  var checkoutUrl = link;
  if (currentUser && currentUser.email) {
    try { checkoutUrl += (checkoutUrl.includes('?') ? '&' : '?') + 'prefilled_email=' + encodeURIComponent(currentUser.email); } catch(e) {}
  }

  // Store pending credit purchase so we can grant credits on return
  try {
    localStorage.setItem('tv_pending_script_buy', JSON.stringify({ qty: qty, price: priceLabel, at: Date.now() }));
  } catch(e) {}

  // Show confirmation overlay and open Stripe
  var existing = document.getElementById('payPerScriptModal');
  if (existing) existing.remove();

  var overlay = document.createElement('div');
  overlay.className = 'modal-overlay show';
  overlay.innerHTML =
    '<div class="modal-box" style="max-width:420px;text-align:center">' +
      '<div style="font-size:48px;margin-bottom:12px">ðŸ’³</div>' +
      '<div class="modal-title">Complete Your Purchase</div>' +
      '<div class="modal-sub" style="margin-bottom:20px">Stripe opened in a new tab for <strong>' + qty + ' script credit' + (qty > 1 ? 's' : '') + ' â€” ' + priceLabel + '</strong>.<br>Complete payment there â€” your credits will be added instantly.</div>' +
      '<div style="background:rgba(0,229,176,0.06);border:1px solid rgba(0,229,176,0.2);border-radius:12px;padding:14px;margin-bottom:20px;display:flex;flex-direction:column;gap:8px;text-align:left">' +
        '<div style="display:flex;gap:10px;align-items:center"><span style="background:var(--teal);color:#000;width:20px;height:20px;min-width:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900">1</span><span style="font-size:13px">Pay in the Stripe tab</span></div>' +
        '<div style="display:flex;gap:10px;align-items:center"><span style="background:var(--teal);color:#000;width:20px;height:20px;min-width:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900">2</span><span style="font-size:13px">Return here â€” credits added automatically</span></div>' +
      '</div>' +
      '<div style="display:flex;gap:8px">' +
        '<button class="btn btn-primary" style="flex:1" onclick="this.closest(\'.modal-overlay\').remove()">âœ“ I\'ve paid â€” activate credits</button>' +
        '<button class="btn btn-ghost" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(overlay);
  window.open(checkoutUrl, '_blank');
}

// ============================================================
// BUNDLE DEALS PAGE
// ============================================================
function renderBundleDeals() {
  var prices = {};
  try { prices = JSON.parse(localStorage.getItem('tv_custom_prices') || '{}'); } catch(e) {}
  var packPrice = prices.scriptPack || '5';
  var perScript = prices.scriptPerUse || '0.50';
  var pc = document.getElementById('pageContent');
  if(!pc) return;
  pc.innerHTML = '<div class="section-label" style="margin-bottom:16px">ðŸ“¦ BUNDLE DEALS</div>' +
    '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px">' +
      [ {icon:'âœï¸', title:'10 Script Pack', desc:'Generate 10 AI scripts, use them whenever you like', price:packPrice, badge:'Most Popular', badgeColor:'var(--accent)', link:'https://buy.stripe.com/test_cNi5kEcZ0ap9c8H40c2ZO0a', items:['10 full AI scripts','Any platform, any niche','Never expires','Includes viral score']},
        {icon:'ðŸŽ', title:'Creator Starter Kit', desc:'Everything you need to launch your channel properly', price:'15', badge:'Best Value', badgeColor:'var(--gold)', link:'https://buy.stripe.com/test_9B67sM2km8h1fkT54g2ZO0b', items:['25 AI scripts','20 thumbnail ideas','1 month content calendar','Hashtag packs for 5 niches']},
        {icon:'ðŸš€', title:'Launch Pack', desc:'Go from zero to 30 days of planned content', price:'29', badge:'', badgeColor:'', link:'https://buy.stripe.com/test_eVqbJ2e347cX2y78gs2ZO0c', items:['50 AI scripts','B-roll lists for every video','Competitor analysis x5','Full brand kit setup','Priority AI speed']},
        {icon:'ðŸŽ¯', title:'Viral Booster', desc:'Everything you need to chase your first viral moment', price:'19', badge:'', badgeColor:'', link:'https://buy.stripe.com/test_14A6oIbUW0Oz8Wv68k2ZO0d', items:['Hook Tester (20 hooks)','Trend Radar deep dive','Viral score analysis x10','Thumbnail A/B test pack','Top hashtag sets x10']},
        {icon:'ðŸ“±', title:'TikTok & Reels Pack', desc:'Short-form content sorted for an entire month', price:'12', badge:'', badgeColor:'', link:'https://buy.stripe.com/test_fZu8wQ7EGgNxa0z1S42ZO0e', items:['20 short-form scripts','Hook ideas x30','Trending audio suggestions','Caption & hashtag sets','Repurpose guide included']},
        {icon:'ðŸ§ ', title:'SEO & Growth Kit', desc:'Optimise every video for maximum discoverability', price:'19', badge:'', badgeColor:'', link:'https://buy.stripe.com/test_9B6aEY6AC54P4Gf2W82ZO0f', items:['SEO title generator x20','Description templates x20','Tag & hashtag packs','Channel audit checklist','Keyword research guide']},
        {icon:'ðŸ†', title:'Agency Pack', desc:'Built for teams managing multiple creators', price:'79', badge:'Pro Pick', badgeColor:'var(--purple)', link:'https://buy.stripe.com/test_7sY7sM5wyfJtc8H0O02ZO0g', items:['200 AI scripts','10 brand kits','Unlimited thumbnail ideas','Competitor spy x20 channels','White-label export ready','Priority AI speed']},
        {icon:'ðŸŒ', title:'Multi-Language Pack', desc:'Reach global audiences in 20+ languages', price:'24', badge:'', badgeColor:'', link:'https://buy.stripe.com/test_28EfZi0ce40L6On54g2ZO0h', items:['Scripts in 10 languages','Localised hashtag sets','Cultural trend insights','20 translated titles & descriptions','SEO per region']},
      ].map(function(deal) {
        return '<div class="card" style="border-color:' + (deal.badge ? 'rgba(255,48,88,0.3)' : 'var(--border)') + ';position:relative">' +
          (deal.badge ? '<div style="position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:' + deal.badgeColor + ';color:#fff;font-size:10px;font-weight:800;padding:3px 12px;border-radius:20px;letter-spacing:1px">' + deal.badge + '</div>' : '') +
          '<div style="font-size:36px;margin-bottom:10px">' + deal.icon + '</div>' +
          '<div style="font-weight:800;font-size:16px;margin-bottom:4px">' + deal.title + '</div>' +
          '<div style="font-size:12px;color:var(--muted);margin-bottom:12px">' + deal.desc + '</div>' +
          '<div style="font-family:var(--font-display);font-size:32px;font-weight:900;margin-bottom:14px">Â£' + deal.price + '<span style="font-size:14px;color:var(--muted);font-weight:400"> one-time</span></div>' +
          '<div style="margin-bottom:16px">' + deal.items.map(function(item){return '<div style="font-size:12px;color:var(--text2);padding:4px 0;border-bottom:1px solid var(--border);display:flex;gap:8px"><span style="color:var(--teal)">âœ“</span>' + item + '</div>';}).join('') + '</div>' +
          '<button class="btn btn-primary" style="width:100%" onclick="buyBundle(' + JSON.stringify(deal.title) + ',' + JSON.stringify(deal.price) + ',' + JSON.stringify(deal.link) + ')">Buy for Â£' + deal.price + ' â†’</button>' +
        '</div>';
      }).join('') +
    '</div>' +
    '<div style="margin-top:20px;text-align:center;font-size:12px;color:var(--muted)">ðŸ”’ Secure checkout via Stripe Â· One-time payment Â· Instant delivery</div>';
}
function buyBundle(name, price, link) {
  // Log sale notification for admin
  try {
    var notifs = JSON.parse(localStorage.getItem('tv_admin_notifs') || '[]');
    notifs.unshift({
      type: 'bundle_sale',
      icon: 'ðŸ’³',
      title: 'Bundle Sale!',
      body: name + ' purchased â€” Â£' + price,
      at: Date.now(),
      read: false
    });
    localStorage.setItem('tv_admin_notifs', JSON.stringify(notifs.slice(0, 100)));
    // Also log to activity log
    var log = []; try { log = JSON.parse(localStorage.getItem('tv_activity_log') || '[]'); } catch(e) {}
    log.unshift({icon:'ðŸ’³', user:(currentUser&&currentUser.email)||'guest', action:'Purchased bundle: ' + name + ' (Â£' + price + ')', type:'sale', at:Date.now()});
    localStorage.setItem('tv_activity_log', JSON.stringify(log.slice(0, 500)));
  } catch(e) {}
  // Open Stripe checkout
  if (link && link.startsWith('http')) {
    var email = (currentUser && currentUser.email) || '';
    var finalLink = link + (link.includes('?') ? '&' : '?') + 'prefilled_email=' + encodeURIComponent(email);
    window.open(finalLink, '_blank');
    notify('Opening secure checkout for ' + name + 'â€¦', 'success', 'ðŸ’³');
  } else {
    notify('Bundle: ' + name + ' (Â£' + price + ') â€” test mode', 'info', 'ðŸ“¦');
  }
}

// ============================================================
// SHOW WATERMARK after every AI output â€” patch aiCall
// ============================================================
var _origAiCall = aiCall;
aiCall = async function(messages, system, maxTokens) {
  var result = await _origAiCall.call(this, messages, system, maxTokens);
  showWatermark();
  return result;
};



// ============================================================
// XP & LEVELS SYSTEM
// ============================================================
const XP_PER_LEVEL = 100;

// ALL XP-earning actions â€” key, label, icon, xp value
const XP_ACTIONS = [
  {key:'scanned_trend',    label:'Scan your first trend',          icon:'ðŸ“ˆ', xp:10},
  {key:'wrote_script',     label:'Generate a script',               icon:'âœï¸', xp:15},
  {key:'made_thumb',       label:'Create a thumbnail',              icon:'ðŸŽ¨', xp:10},
  {key:'saved_fav',        label:'Save a favourite trend',          icon:'â­', xp:5},
  {key:'filled_cal',       label:'Fill your content calendar',      icon:'ðŸ“…', xp:10},
  {key:'tested_hook',      label:'Test a hook',                     icon:'âš¡', xp:10},
  {key:'used_repurpose',   label:'Repurpose a script',              icon:'â™»ï¸', xp:12},
  {key:'used_ab',          label:'Run an A/B title test',           icon:'ðŸ†š', xp:10},
  {key:'used_collab',      label:'Find a collab partner',           icon:'ðŸ¤', xp:15},
  {key:'used_ytanalyse',   label:'Analyse a YouTube channel',       icon:'ðŸ“º', xp:20},
  {key:'used_descgen',     label:'Generate a description pack',     icon:'ðŸ“', xp:12},
  {key:'used_thumbab',     label:'Run a thumbnail A/B test',        icon:'ðŸ–¼ï¸', xp:12},
  {key:'used_scheduler',   label:'Schedule a post',                 icon:'ðŸ—“ï¸', xp:8},
  {key:'used_multilang',   label:'Translate a script',              icon:'ðŸŒ', xp:10},
  {key:'used_hashtags',    label:'Generate hashtags & SEO',         icon:'#ï¸âƒ£', xp:8},
  {key:'used_viral',       label:'Check viral score',               icon:'ðŸš€', xp:8},
  {key:'used_health',      label:'Check channel health',            icon:'ðŸ“Š', xp:10},
  {key:'used_music',       label:'Find music picks',                icon:'ðŸŽµ', xp:8},
  {key:'used_captions',    label:'Generate captions',               icon:'ðŸ’¬', xp:8},
  {key:'used_comments',    label:'Generate comment replies',        icon:'ðŸ’­', xp:8},
  {key:'used_improver',    label:'Improve a script',                icon:'âœ¨', xp:10},
  {key:'used_brandkit',    label:'Set up brand kit',                icon:'ðŸŽ¨', xp:20},
  {key:'used_broll',       label:'Generate B-roll ideas',           icon:'ðŸŽ¬', xp:8},
  {key:'used_gapfinder',   label:'Find content gaps',               icon:'ðŸ”­', xp:12},
  {key:'referred_user',    label:'Refer a friend',                  icon:'ðŸ”—', xp:50},
  {key:'upgraded_plan',    label:'Upgrade your plan',               icon:'ðŸ’Ž', xp:100},
  {key:'streak_7',         label:'7-day usage streak',              icon:'ðŸ”¥', xp:50},
  {key:'streak_30',        label:'30-day usage streak',             icon:'ðŸ’ª', xp:200},
  {key:'scripts_10',       label:'Save 10 scripts',                 icon:'ðŸ“š', xp:30},
  {key:'scripts_50',       label:'Save 50 scripts',                 icon:'ðŸ†', xp:100},
];

// ============================================================
// 100 LEVELS â€” each with a badge emoji, name, title & desc
// ============================================================
const XP_LEVELS = [
  {level:1,   emoji:'ðŸŒ±', badge:'Seedling',         title:'The Newcomer',        desc:'First steps into the creator world',        glow:'rgba(0,229,176,0.35)',   color:'#00e5b0'},
  {level:2,   emoji:'ðŸŒ¿', badge:'Sprouting',         title:'Getting Started',     desc:'Building the habit',                        glow:'rgba(0,229,176,0.35)',   color:'#00e5b0'},
  {level:3,   emoji:'ðŸ€', badge:'Lucky Clover',      title:'The Curious One',     desc:'Exploring the tools',                       glow:'rgba(0,200,160,0.35)',   color:'#00c8a0'},
  {level:4,   emoji:'ðŸŒ»', badge:'Sunflower',         title:'Rising Talent',       desc:'Growing towards the algorithm',             glow:'rgba(251,191,36,0.35)', color:'#fbbf24'},
  {level:5,   emoji:'â­', badge:'First Star',        title:'Trend Spotter',       desc:'You know what clicks',                      glow:'rgba(251,191,36,0.4)',  color:'#fbbf24'},
  {level:6,   emoji:'ðŸŽ¯', badge:'On Target',         title:'The Focused',         desc:'Locking in on your niche',                  glow:'rgba(255,138,0,0.35)', color:'#ff8a00'},
  {level:7,   emoji:'ðŸ”¥', badge:'Ignited',           title:'On Fire',             desc:'Content machine warming up',                glow:'rgba(255,138,0,0.45)', color:'#ff8a00'},
  {level:8,   emoji:'ðŸ’¡', badge:'Big Ideas',         title:'The Ideator',         desc:'Ideas faster than you can film',            glow:'rgba(167,139,250,0.4)', color:'#a78bfa'},
  {level:9,   emoji:'âš¡', badge:'Charged Up',        title:'The Energiser',       desc:'Unstoppable momentum building',             glow:'rgba(255,48,88,0.4)',  color:'#ff3058'},
  {level:10,  emoji:'ðŸ…', badge:'Bronze Creator',    title:'First Milestone',     desc:'10 levels in â€” the journey begins!',       glow:'rgba(180,120,40,0.55)', color:'#b47828'},
  {level:11,  emoji:'ðŸ§ ', badge:'Strategic Mind',    title:'The Thinker',         desc:'Planning beats posting',                    glow:'rgba(0,229,176,0.35)', color:'#00e5b0'},
  {level:12,  emoji:'ðŸŽ™ï¸', badge:'Voice Found',       title:'The Storyteller',     desc:'Your voice is your brand',                  glow:'rgba(167,139,250,0.4)', color:'#a78bfa'},
  {level:13,  emoji:'ðŸ“Š', badge:'Data Driven',       title:'The Analyst',         desc:'Metrics don\'t lie',                        glow:'rgba(0,229,176,0.35)', color:'#00e5b0'},
  {level:14,  emoji:'ðŸŽ¨', badge:'Visual Maestro',    title:'The Creative',        desc:'Thumbnails that stop the scroll',           glow:'rgba(255,138,0,0.4)',  color:'#ff8a00'},
  {level:15,  emoji:'ðŸŒŠ', badge:'Wave Rider',        title:'Trend Surfer',        desc:'Catching trends before they peak',          glow:'rgba(0,200,255,0.4)',  color:'#00c8ff'},
  {level:16,  emoji:'ðŸŽ­', badge:'Entertainer',       title:'The Performer',       desc:'Every video a show',                        glow:'rgba(255,48,88,0.4)',  color:'#ff3058'},
  {level:17,  emoji:'ðŸ“±', badge:'Mobile Native',     title:'Screen King',         desc:'Born for the algorithm',                    glow:'rgba(0,229,176,0.4)',  color:'#00e5b0'},
  {level:18,  emoji:'ðŸ¤', badge:'Collaborator',      title:'Network Builder',     desc:'Growth through connection',                 glow:'rgba(167,139,250,0.4)', color:'#a78bfa'},
  {level:19,  emoji:'ðŸ”­', badge:'Content Scout',     title:'The Explorer',        desc:'Finding gaps no one else sees',             glow:'rgba(0,229,176,0.4)',  color:'#00e5b0'},
  {level:20,  emoji:'ðŸ¥ˆ', badge:'Silver Creator',    title:'Seriously Committed', desc:'20 levels â€” now it\'s serious',            glow:'rgba(192,192,210,0.55)', color:'#c0c0d2'},
  {level:21,  emoji:'ðŸŽ¬', badge:'Action!',           title:'The Director',        desc:'Every frame intentional',                   glow:'rgba(255,138,0,0.4)',  color:'#ff8a00'},
  {level:22,  emoji:'ðŸ“¡', badge:'Signal Strong',     title:'The Broadcaster',     desc:'Reaching wider audiences',                  glow:'rgba(0,229,176,0.4)',  color:'#00e5b0'},
  {level:23,  emoji:'ðŸ§ª', badge:'Content Lab',       title:'The Experimenter',    desc:'Testing what the algorithm loves',          glow:'rgba(167,139,250,0.4)', color:'#a78bfa'},
  {level:24,  emoji:'ðŸ‹ï¸', badge:'Grind Mode',        title:'The Grinder',         desc:'Showing up every single day',               glow:'rgba(255,48,88,0.4)',  color:'#ff3058'},
  {level:25,  emoji:'ðŸŒ', badge:'Global Reach',      title:'World Creator',       desc:'Your content crosses borders',              glow:'rgba(0,229,176,0.45)', color:'#00e5b0'},
  {level:26,  emoji:'ðŸŽµ', badge:'Soundtrack',        title:'Mood Setter',         desc:'Perfect audio game',                        glow:'rgba(167,139,250,0.4)', color:'#a78bfa'},
  {level:27,  emoji:'ðŸ”‘', badge:'Key Insights',      title:'The Unlocked',        desc:'You\'ve cracked the code',                  glow:'rgba(251,191,36,0.4)', color:'#fbbf24'},
  {level:28,  emoji:'ðŸ§²', badge:'Audience Magnet',   title:'The Attractor',       desc:'Retention that keeps them watching',        glow:'rgba(255,138,0,0.4)',  color:'#ff8a00'},
  {level:29,  emoji:'ðŸ—ºï¸', badge:'Content Map',       title:'The Planner',         desc:'30 days ahead, always',                     glow:'rgba(0,229,176,0.4)',  color:'#00e5b0'},
  {level:30,  emoji:'ðŸ¥‡', badge:'Gold Creator',      title:'Gold Standard',       desc:'30 levels â€” you\'re the real deal',        glow:'rgba(251,191,36,0.6)', color:'#fbbf24'},
  {level:31,  emoji:'ðŸ¦', badge:'Creator King',      title:'Pride of Creators',   desc:'Leading by example',                        glow:'rgba(251,191,36,0.45)', color:'#fbbf24'},
  {level:32,  emoji:'ðŸŒ', badge:'Digital Native',    title:'The Internet Kid',    desc:'This is your natural habitat',              glow:'rgba(0,229,176,0.4)',  color:'#00e5b0'},
  {level:33,  emoji:'ðŸš¦', badge:'Always Green',      title:'Traffic Driver',      desc:'Clicks, views, subscribers â€” all up',      glow:'rgba(0,200,100,0.4)',  color:'#00c864'},
  {level:34,  emoji:'ðŸ§©', badge:'Puzzle Master',     title:'The Strategist',      desc:'Every piece in its place',                  glow:'rgba(167,139,250,0.4)', color:'#a78bfa'},
  {level:35,  emoji:'ðŸ†', badge:'Trophy Case',       title:'Award-Worthy',        desc:'The community notices',                     glow:'rgba(251,191,36,0.5)', color:'#fbbf24'},
  {level:36,  emoji:'ðŸŒˆ', badge:'Spectrum Creator',  title:'Multi-Platform',      desc:'YouTube, TikTok, Insta â€” all conquered',   glow:'rgba(255,138,0,0.4)',  color:'#ff8a00'},
  {level:37,  emoji:'ðŸ”®', badge:'Future Seer',       title:'The Visionary',       desc:'Trends you spot become the mainstream',    glow:'rgba(167,139,250,0.5)', color:'#a78bfa'},
  {level:38,  emoji:'ðŸ›¡ï¸', badge:'Brand Guardian',   title:'Brand Protector',     desc:'Consistency is your superpower',            glow:'rgba(0,229,176,0.4)',  color:'#00e5b0'},
  {level:39,  emoji:'ðŸš€', badge:'Pre-Launch',        title:'Countdown',           desc:'Something big is coming',                   glow:'rgba(255,48,88,0.4)',  color:'#ff3058'},
  {level:40,  emoji:'ðŸ’«', badge:'Shooting Star',     title:'Viral Potential',     desc:'40 levels of pure momentum',                glow:'rgba(255,48,88,0.55)', color:'#ff3058'},
  {level:41,  emoji:'ðŸŽ¯', badge:'Bullseye',          title:'The Marksman',        desc:'Always hitting the target audience',        glow:'rgba(255,138,0,0.4)',  color:'#ff8a00'},
  {level:42,  emoji:'ðŸ“–', badge:'The Author',        title:'Script Legend',       desc:'Scripts that convert to views',             glow:'rgba(0,229,176,0.4)',  color:'#00e5b0'},
  {level:43,  emoji:'ðŸ„', badge:'Algorithm Surfer',  title:'Wave Chaser',         desc:'In sync with every platform shift',        glow:'rgba(0,200,255,0.4)',  color:'#00c8ff'},
  {level:44,  emoji:'ðŸŒŸ', badge:'Bright Star',       title:'The Shining One',     desc:'Hard to miss, impossible to ignore',       glow:'rgba(251,191,36,0.5)', color:'#fbbf24'},
  {level:45,  emoji:'ðŸ¦‹', badge:'Transformation',    title:'The Evolved',         desc:'Your content has levelled up completely',  glow:'rgba(167,139,250,0.45)', color:'#a78bfa'},
  {level:46,  emoji:'ðŸ”¬', badge:'Content Scientist', title:'The Researcher',      desc:'Testing hypotheses with every upload',      glow:'rgba(0,229,176,0.4)',  color:'#00e5b0'},
  {level:47,  emoji:'ðŸŽ¯', badge:'Precision',         title:'The Sniper',          desc:'No wasted content, only impact',            glow:'rgba(255,48,88,0.4)',  color:'#ff3058'},
  {level:48,  emoji:'ðŸ¦…', badge:'Eagle Eye',         title:'The Spotter',         desc:'Sees what others miss',                     glow:'rgba(0,200,255,0.4)',  color:'#00c8ff'},
  {level:49,  emoji:'âš™ï¸', badge:'The Machine',       title:'Automation King',     desc:'Systems that make content flow',            glow:'rgba(167,139,250,0.4)', color:'#a78bfa'},
  {level:50,  emoji:'ðŸ’Ž', badge:'Diamond Creator',   title:'Half-Century',        desc:'50 levels â€” absolutely elite',              glow:'rgba(168,237,255,0.65)', color:'#a8edff'},
  {level:51,  emoji:'ðŸŒ™', badge:'Midnight Creator',  title:'Never Sleeps',        desc:'Creating while the competition rests',      glow:'rgba(167,139,250,0.5)', color:'#a78bfa'},
  {level:52,  emoji:'â˜€ï¸', badge:'Dawn Breaker',      title:'Early Mover',         desc:'First to every trend, every time',          glow:'rgba(251,191,36,0.45)', color:'#fbbf24'},
  {level:53,  emoji:'ðŸŒŠ', badge:'Tsunami',           title:'Force of Nature',     desc:'Unstoppable content wave',                  glow:'rgba(0,200,255,0.45)', color:'#00c8ff'},
  {level:54,  emoji:'ðŸ¦Š', badge:'The Fox',           title:'Smart Creator',       desc:'Clever, nimble, always ahead',              glow:'rgba(255,138,0,0.45)', color:'#ff8a00'},
  {level:55,  emoji:'ðŸŽª', badge:'The Showman',       title:'Centre Stage',        desc:'Every upload commands attention',           glow:'rgba(255,48,88,0.45)', color:'#ff3058'},
  {level:56,  emoji:'ðŸ—¼', badge:'Towering',          title:'Standing Tall',       desc:'Above the noise',                           glow:'rgba(0,229,176,0.45)', color:'#00e5b0'},
  {level:57,  emoji:'ðŸŒ‹', badge:'Eruption',          title:'The Disruptor',       desc:'Shaking up the algorithm',                  glow:'rgba(255,48,88,0.5)',  color:'#ff3058'},
  {level:58,  emoji:'ðŸ§­', badge:'True North',        title:'The Navigator',       desc:'Always knows where the audience is',        glow:'rgba(0,229,176,0.45)', color:'#00e5b0'},
  {level:59,  emoji:'ðŸŽ¡', badge:'The Entertainer',   title:'Non-Stop Fun',        desc:'Viewers come back for more',                glow:'rgba(255,138,0,0.45)', color:'#ff8a00'},
  {level:60,  emoji:'ðŸ”±', badge:'Trident',           title:'Platform Conqueror',  desc:'60 levels â€” ruling every platform',        glow:'rgba(0,229,176,0.6)',  color:'#00e5b0'},
  {level:61,  emoji:'ðŸ‘ï¸', badge:'Third Eye',         title:'The Seer',            desc:'Predicts trends weeks in advance',          glow:'rgba(167,139,250,0.5)', color:'#a78bfa'},
  {level:62,  emoji:'ðŸ°', badge:'Content Castle',    title:'Built Different',     desc:'A library of legendary content',            glow:'rgba(251,191,36,0.5)', color:'#fbbf24'},
  {level:63,  emoji:'âš¡', badge:'Thunderstrike',     title:'The Impact',          desc:'Every post sends shockwaves',               glow:'rgba(255,48,88,0.5)',  color:'#ff3058'},
  {level:64,  emoji:'ðŸŒº', badge:'Bloom',             title:'In Full Bloom',       desc:'Audience growing organically',              glow:'rgba(255,138,0,0.45)', color:'#ff8a00'},
  {level:65,  emoji:'ðŸ¦š', badge:'The Peacock',       title:'Full Display',        desc:'Brand presence impossible to ignore',       glow:'rgba(0,229,176,0.5)',  color:'#00e5b0'},
  {level:66,  emoji:'ðŸŽ¯', badge:'Double Aim',        title:'The Dual Creator',    desc:'Content AND community',                     glow:'rgba(167,139,250,0.5)', color:'#a78bfa'},
  {level:67,  emoji:'ðŸŒ ', badge:'Meteor',            title:'The Blazer',          desc:'Burning bright across every feed',          glow:'rgba(255,48,88,0.5)',  color:'#ff3058'},
  {level:68,  emoji:'ðŸ—ï¸', badge:'The Builder',      title:'Empire Architect',    desc:'Content strategy is your blueprint',        glow:'rgba(251,191,36,0.5)', color:'#fbbf24'},
  {level:69,  emoji:'ðŸŽ†', badge:'Fireworks',         title:'The Spectacular',     desc:'Every upload lights up the feed',           glow:'rgba(255,138,0,0.5)',  color:'#ff8a00'},
  {level:70,  emoji:'ðŸ‘‘', badge:'Creator Crown',     title:'Royalty',             desc:'70 levels â€” wear your crown',               glow:'rgba(251,191,36,0.65)', color:'#fbbf24'},
  {level:71,  emoji:'ðŸŒŒ', badge:'Galaxy Mind',       title:'Cosmic Thinker',      desc:'Your ideas orbit a different dimension',   glow:'rgba(167,139,250,0.55)', color:'#a78bfa'},
  {level:72,  emoji:'ðŸ¦', badge:'The Lion',          title:'Pack Leader',         desc:'Others follow your creative lead',          glow:'rgba(251,191,36,0.5)', color:'#fbbf24'},
  {level:73,  emoji:'ðŸ”ï¸', badge:'Mountain Top',     title:'Summit Reached',      desc:'Most never get this high',                  glow:'rgba(0,229,176,0.5)',  color:'#00e5b0'},
  {level:74,  emoji:'âš—ï¸', badge:'Alchemist',         title:'Gold Maker',          desc:'Turning ideas into viral gold',             glow:'rgba(255,138,0,0.5)',  color:'#ff8a00'},
  {level:75,  emoji:'ðŸŽ¯', badge:'Triple Quarter',    title:'Three-Quarter Legend', desc:'75 levels â€” nearly there',                 glow:'rgba(255,48,88,0.55)', color:'#ff3058'},
  {level:76,  emoji:'ðŸ•¹ï¸', badge:'Game Master',       title:'Creator God Mode',    desc:'You\'ve unlocked all the cheats',           glow:'rgba(167,139,250,0.55)', color:'#a78bfa'},
  {level:77,  emoji:'ðŸŒŸ', badge:'Lucky Stars',       title:'Blessed Creator',     desc:'Luck meets preparation',                    glow:'rgba(251,191,36,0.55)', color:'#fbbf24'},
  {level:78,  emoji:'ðŸ¦‹', badge:'Metamorphosis',     title:'Fully Transformed',   desc:'Unrecognisable from level 1',               glow:'rgba(167,139,250,0.55)', color:'#a78bfa'},
  {level:79,  emoji:'ðŸŒŠ', badge:'Tidal Force',       title:'The Wave',            desc:'Audiences move with you',                   glow:'rgba(0,200,255,0.55)', color:'#00c8ff'},
  {level:80,  emoji:'ðŸŒŒ', badge:'Galaxy Brain',      title:'Beyond Elite',        desc:'80 levels â€” a true legend',                glow:'rgba(167,139,250,0.7)', color:'#a78bfa'},
  {level:81,  emoji:'ðŸ”®', badge:'Oracle',            title:'The Prophet',         desc:'You see the future of content',             glow:'rgba(167,139,250,0.6)', color:'#a78bfa'},
  {level:82,  emoji:'ðŸŒ', badge:'Internet Lord',     title:'Web Ruler',           desc:'Every platform bows to your content',       glow:'rgba(0,229,176,0.55)', color:'#00e5b0'},
  {level:83,  emoji:'âšœï¸', badge:'Royal Crest',       title:'The Aristocrat',      desc:'Old money, new content',                    glow:'rgba(251,191,36,0.6)', color:'#fbbf24'},
  {level:84,  emoji:'ðŸŒ ', badge:'Supernova',         title:'Explosive Growth',    desc:'When you post, the internet moves',         glow:'rgba(255,48,88,0.6)',  color:'#ff3058'},
  {level:85,  emoji:'ðŸ¦…', badge:'Apex Predator',     title:'Top of the Feed',     desc:'Dominating every recommended tab',          glow:'rgba(0,200,255,0.6)',  color:'#00c8ff'},
  {level:86,  emoji:'ðŸ›ï¸', badge:'The Institution',  title:'Creator Heritage',    desc:'Your content is studied by others',         glow:'rgba(167,139,250,0.6)', color:'#a78bfa'},
  {level:87,  emoji:'ðŸ’¥', badge:'Impact',            title:'World-Changing',      desc:'Your reach shapes culture',                 glow:'rgba(255,48,88,0.65)', color:'#ff3058'},
  {level:88,  emoji:'ðŸŒ', badge:'Global Creator',    title:'Worldwide',           desc:'No borders â€” pure reach',                   glow:'rgba(0,229,176,0.6)',  color:'#00e5b0'},
  {level:89,  emoji:'ðŸŒ€', badge:'Vortex',            title:'The Singularity',     desc:'You are the algorithm',                     glow:'rgba(167,139,250,0.65)', color:'#a78bfa'},
  {level:90,  emoji:'âšœï¸', badge:'Living Legend',     title:'The Legendary',       desc:'90 levels â€” few even breathe this air',   glow:'rgba(255,215,0,0.7)',  color:'#ffd700'},
  {level:91,  emoji:'ðŸ†', badge:'Multi-Trophy',      title:'Collection',          desc:'Awards on awards on awards',                glow:'rgba(251,191,36,0.65)', color:'#fbbf24'},
  {level:92,  emoji:'ðŸ‘ï¸', badge:'Omniscient',        title:'The All-Seeing',      desc:'Content omnipresence achieved',             glow:'rgba(167,139,250,0.7)', color:'#a78bfa'},
  {level:93,  emoji:'ðŸŒ‹', badge:'Eternal Flame',     title:'Undying',             desc:'The algorithm cannot touch you',            glow:'rgba(255,48,88,0.7)',  color:'#ff3058'},
  {level:94,  emoji:'âš¡', badge:'God Mode',          title:'Untouchable',         desc:'Content on a different plane',              glow:'rgba(255,215,0,0.7)',  color:'#ffd700'},
  {level:95,  emoji:'ðŸŒŒ', badge:'Nebula',            title:'Origin of Stars',     desc:'Others look to you for inspiration',        glow:'rgba(167,139,250,0.75)', color:'#a78bfa'},
  {level:96,  emoji:'â™¾ï¸', badge:'Infinite',          title:'Beyond Counting',     desc:'Your impact can\'t be measured',            glow:'rgba(0,229,176,0.7)',  color:'#00e5b0'},
  {level:97,  emoji:'ðŸŒŸ', badge:'Constellation',     title:'Hall of Fame',        desc:'Named among the greatest creators',         glow:'rgba(255,215,0,0.75)', color:'#ffd700'},
  {level:98,  emoji:'ðŸ”±', badge:'Titan',             title:'The Titan',           desc:'Immovable. Unbeatable. Iconic.',            glow:'rgba(255,215,0,0.8)',  color:'#ffd700'},
  {level:99,  emoji:'ðŸ’Ž', badge:'Final Form',        title:'Pre-GOAT',            desc:'One level stands between you and history', glow:'rgba(168,237,255,0.8)', color:'#a8edff'},
  {level:100, emoji:'ðŸ†', badge:'TrendVid GOAT',    title:'GREATEST OF ALL TIME', desc:'Level 100 â€” the pinnacle of TrendVid mastery', glow:'rgba(255,215,0,1)', color:'#ffd700'},
];

// Keep XP_BADGES as alias for backward compat â€” same as XP_LEVELS
const XP_BADGES = XP_LEVELS;

// TITLES â€” unlockable display titles shown on XP page
const XP_TITLES = [
  {id:'newcomer',     level:1,   title:'The Newcomer',        emoji:'ðŸ‘¶', color:'#00e5b0'},
  {id:'trend_spotter',level:5,   title:'Trend Spotter',       emoji:'ðŸ“ˆ', color:'#fbbf24'},
  {id:'on_fire',      level:7,   title:'On Fire',             emoji:'ðŸ”¥', color:'#ff8a00'},
  {id:'storyteller',  level:12,  title:'The Storyteller',     emoji:'ðŸŽ™ï¸', color:'#a78bfa'},
  {id:'analyst',      level:13,  title:'The Analyst',         emoji:'ðŸ“Š', color:'#00e5b0'},
  {id:'wave_rider',   level:15,  title:'Trend Surfer',        emoji:'ðŸŒŠ', color:'#00c8ff'},
  {id:'director',     level:21,  title:'The Director',        emoji:'ðŸŽ¬', color:'#ff8a00'},
  {id:'world_creator',level:25,  title:'World Creator',       emoji:'ðŸŒ', color:'#00e5b0'},
  {id:'gold_standard',level:30,  title:'Gold Standard',       emoji:'ðŸ¥‡', color:'#fbbf24'},
  {id:'lion',         level:31,  title:'Pride of Creators',   emoji:'ðŸ¦', color:'#fbbf24'},
  {id:'disruptor',    level:37,  title:'The Disruptor',       emoji:'ðŸŒ‹', color:'#ff3058'},
  {id:'viral_king',   level:40,  title:'Viral Potential',     emoji:'ðŸ’«', color:'#ff3058'},
  {id:'script_legend',level:42,  title:'Script Legend',       emoji:'ðŸ“–', color:'#00e5b0'},
  {id:'diamond',      level:50,  title:'Diamond Elite',       emoji:'ðŸ’Ž', color:'#a8edff'},
  {id:'showman',      level:55,  title:'Centre Stage',        emoji:'ðŸŽª', color:'#ff3058'},
  {id:'platform_lord',level:60,  title:'Platform Conqueror',  emoji:'ðŸ”±', color:'#00e5b0'},
  {id:'cosmic',       level:71,  title:'Cosmic Thinker',      emoji:'ðŸŒŒ', color:'#a78bfa'},
  {id:'apex',         level:85,  title:'Apex Predator',       emoji:'ðŸ¦…', color:'#00c8ff'},
  {id:'legendary',    level:90,  title:'The Legendary',       emoji:'âšœï¸', color:'#ffd700'},
  {id:'goat',         level:100, title:'GOAT',                emoji:'ðŸ†', color:'#ffd700'},
];

// TIER BADGES â€” shown on the XP page based on subscription plan
const TIER_XP_BADGES = {
  free:    {emoji:'ðŸŒ±', name:'Free Explorer',    desc:'Just getting started',          style:'background:rgba(100,100,120,0.15);border:1px solid var(--border);color:var(--muted)'},
  starter: {emoji:'ðŸš€', name:'Starter Creator',  desc:'Building the foundation',       style:'background:rgba(0,229,176,0.1);border:1px solid rgba(0,229,176,0.35);color:var(--teal)'},
  pro:     {emoji:'âš¡', name:'Pro Creator',       desc:'Serious about growth',          style:'background:rgba(255,48,88,0.1);border:1px solid rgba(255,48,88,0.35);color:var(--accent)'},
  gold:    {emoji:'ðŸ‘‘', name:'Gold Creator',      desc:'Full-time content machine',     style:'background:rgba(251,191,36,0.12);border:1px solid rgba(251,191,36,0.4);color:var(--gold)'},
  elite:   {emoji:'ðŸ’Ž', name:'Elite Creator',     desc:'The highest tier â€” unlimited', style:'background:rgba(192,132,252,0.12);border:1px solid rgba(192,132,252,0.4);color:var(--elite)'},
};

// REWARDS â€” every level has a unique reward; big rewards at every 10; jackpot at 100
const LEVEL_REWARDS = [
  null, // placeholder for index 0
  {type:'small', emoji:'â­', label:'Newcomer Star',      desc:'Welcome to TrendVid XP!',                          code:null},
  {type:'small', emoji:'ðŸŽ¨', label:'Thumbnail Tip',      desc:'5 bonus AI thumbnail style suggestions',           code:null},
  {type:'small', emoji:'âœï¸', label:'Script Boost',        desc:'3 extra script tone options unlocked',             code:null},
  {type:'small', emoji:'ðŸ“ˆ', label:'Trend Radar+',        desc:'Extended trend history enabled',                   code:null},
  {type:'small', emoji:'â­', label:'Rising Star Badge',   desc:'Equip the Rising Star title on your profile',      code:null},
  {type:'small', emoji:'ðŸŽ¯', label:'Niche Kit',           desc:'Personalised niche content tips unlocked',         code:null},
  {type:'small', emoji:'ðŸ”¥', label:'Hot Streak Boost',   desc:'Double XP on next 3 actions',                      code:null},
  {type:'small', emoji:'ðŸ’¡', label:'Idea Vault',          desc:'Access to 50 pre-made viral hooks',                code:null},
  {type:'small', emoji:'âš¡', label:'Energy Pack',         desc:'Bonus content calendar templates',                 code:null},
  {type:'big',   emoji:'ðŸŽ', label:'Bronze Bundle',       desc:'1 week Pro free + 15% off any upgrade',           code:'BRONZE10TV'},
  {type:'small', emoji:'ðŸ§ ', label:'Strategy Guide',      desc:'Creator growth checklist PDF unlocked',            code:null},
  {type:'small', emoji:'ðŸŽ™ï¸', label:'Voice Preset',       desc:'3 new voice-to-script personalities unlocked',     code:null},
  {type:'small', emoji:'ðŸ“Š', label:'Analytics Mode',      desc:'Enhanced dashboard stats view',                    code:null},
  {type:'small', emoji:'ðŸŽ¨', label:'Colour Palette',      desc:'10 new thumbnail colour schemes',                  code:null},
  {type:'small', emoji:'ðŸŒŠ', label:'Trend Wave Alert',   desc:'7-day early trend notification boost',             code:null},
  {type:'small', emoji:'ðŸŽ­', label:'Persona Pack',        desc:'5 new content persona scripts unlocked',           code:null},
  {type:'small', emoji:'ðŸ“±', label:'Mobile Boost',        desc:'Vertical video script format unlocked',            code:null},
  {type:'small', emoji:'ðŸ¤', label:'Collab Template',     desc:'Ready-made collab pitch email template',           code:null},
  {type:'small', emoji:'ðŸ”­', label:'Gap Scanner',         desc:'Expanded content gap categories',                  code:null},
  {type:'big',   emoji:'ðŸŽ', label:'Silver Reward',       desc:'1 week Pro free + 20% off any upgrade',           code:'SILVER20TV'},
  {type:'small', emoji:'ðŸŽ¬', label:'Director\'s Cut',     desc:'Premium B-roll keyword packs unlocked',            code:null},
  {type:'small', emoji:'ðŸ“¡', label:'Broadcast Pack',      desc:'Multi-platform posting guide unlocked',            code:null},
  {type:'small', emoji:'ðŸ§ª', label:'Lab Access',          desc:'Beta features early access granted',               code:null},
  {type:'small', emoji:'ðŸ‹ï¸', label:'Grind Bonus',        desc:'Persistent 1.5Ã— XP multiplier for 24h',           code:null},
  {type:'small', emoji:'ðŸŒ', label:'Global Template',     desc:'Multi-language intro/outro scripts',               code:null},
  {type:'small', emoji:'ðŸŽµ', label:'Music Pro Pack',      desc:'50 royalty-free music genre suggestions',          code:null},
  {type:'small', emoji:'ðŸ”‘', label:'Unlock Key',          desc:'One premium feature trial (48h)',                  code:null},
  {type:'small', emoji:'ðŸ§²', label:'Retention Kit',       desc:'5 retention hook formulas',                        code:null},
  {type:'small', emoji:'ðŸ—ºï¸', label:'30-Day Blueprint',   desc:'Automated 30-day content calendar template',       code:null},
  {type:'big',   emoji:'ðŸ’°', label:'Gold Reward',         desc:'2 weeks Pro free + 25% off any upgrade',          code:'GOLD30TV'},
  {type:'small', emoji:'ðŸ¦', label:'Leader Badge',        desc:'Equip the Pack Leader title',                      code:null},
  {type:'small', emoji:'ðŸŒ', label:'Digital Kit',         desc:'Full digital creator toolkit access',              code:null},
  {type:'small', emoji:'ðŸš¦', label:'Traffic Guide',       desc:'Click-through rate optimisation guide',            code:null},
  {type:'small', emoji:'ðŸ§©', label:'Strategy Puzzle',     desc:'Complete creator strategy walkthrough',            code:null},
  {type:'small', emoji:'ðŸ†', label:'Trophy Pack',         desc:'3 exclusive trophy badge emojis unlocked',         code:null},
  {type:'small', emoji:'ðŸŒˆ', label:'Spectrum Pack',       desc:'Multi-niche content crossover templates',          code:null},
  {type:'small', emoji:'ðŸ”®', label:'Oracle Access',       desc:'AI future-trend prediction prompts',               code:null},
  {type:'small', emoji:'ðŸ›¡ï¸', label:'Brand Shield',       desc:'Brand consistency checklist + templates',          code:null},
  {type:'small', emoji:'ðŸš€', label:'Launch Pad',          desc:'Video series launch blueprint',                    code:null},
  {type:'big',   emoji:'ðŸŽ', label:'Level 40 Surge',      desc:'1 month Pro free + 30% off upgrade',              code:'SURGE40TV'},
  {type:'small', emoji:'ðŸŽ¯', label:'Precision Pack',      desc:'Advanced targeting content strategy',              code:null},
  {type:'small', emoji:'ðŸ“–', label:'Author Pack',         desc:'Long-form script templates (10+ min)',             code:null},
  {type:'small', emoji:'ðŸ„', label:'Algorithm Pack',      desc:'Platform algorithm cheat sheet 2025',              code:null},
  {type:'small', emoji:'ðŸŒŸ', label:'Star Power',          desc:'Exclusive "Bright Star" profile frame',            code:null},
  {type:'small', emoji:'ðŸ¦‹', label:'Evolution Kit',       desc:'Content pivot strategy guide',                     code:null},
  {type:'small', emoji:'ðŸ”¬', label:'Science Pack',        desc:'Data-backed content formula library',              code:null},
  {type:'small', emoji:'ðŸ¦…', label:'Eagle Pack',          desc:'Competitive analysis deep-dive templates',         code:null},
  {type:'small', emoji:'âš™ï¸', label:'System Kit',          desc:'Content automation workflow blueprint',            code:null},
  {type:'small', emoji:'ðŸŒ ', label:'Pre-Diamond Boost',   desc:'2Ã— XP for next 5 actions',                        code:null},
  {type:'big',   emoji:'ðŸ’Ž', label:'Diamond Reward',      desc:'1 month Pro free + 40% off any upgrade + exclusive Diamond badge', code:'DIAMOND50TV'},
  {type:'small', emoji:'ðŸŒ™', label:'Night Mode Pack',     desc:'Late-night creator content bundle',                code:null},
  {type:'small', emoji:'â˜€ï¸', label:'Early Bird Pack',     desc:'Morning trend alert system templates',             code:null},
  {type:'small', emoji:'ðŸŒŠ', label:'Tsunami Pack',        desc:'Viral cascade content strategy',                   code:null},
  {type:'small', emoji:'ðŸ¦Š', label:'Fox Pack',            desc:'Smart creator growth hacks collection',            code:null},
  {type:'small', emoji:'ðŸŽª', label:'Show Pack',           desc:'Entertainment content formula library',            code:null},
  {type:'small', emoji:'ðŸ—¼', label:'Tower Pack',          desc:'Authority building content strategy',              code:null},
  {type:'small', emoji:'ðŸŒ‹', label:'Eruption Pack',       desc:'Controversial-but-safe content angles',            code:null},
  {type:'small', emoji:'ðŸ§­', label:'Navigator Pack',      desc:'Audience journey mapping toolkit',                 code:null},
  {type:'small', emoji:'ðŸŽ¡', label:'Entertainment Kit',   desc:'30 entertainment hook templates',                  code:null},
  {type:'big',   emoji:'ðŸ‘‘', label:'Platform Crown',      desc:'2 months Pro free + 45% off + Crown title',       code:'CROWN60TV'},
  {type:'small', emoji:'ðŸ‘ï¸', label:'Insight Pack',        desc:'Deep audience psychology guide',                   code:null},
  {type:'small', emoji:'ðŸ°', label:'Castle Pack',         desc:'Content legacy building strategy',                 code:null},
  {type:'small', emoji:'âš¡', label:'Thunder Pack',        desc:'High-energy hook formula library',                 code:null},
  {type:'small', emoji:'ðŸŒº', label:'Bloom Pack',          desc:'Organic growth tactics handbook',                  code:null},
  {type:'small', emoji:'ðŸ¦š', label:'Peacock Pack',        desc:'Visual branding mastery guide',                    code:null},
  {type:'small', emoji:'ðŸŽ¯', label:'Dual Pack',           desc:'Content + community growth strategy',              code:null},
  {type:'small', emoji:'ðŸŒ ', label:'Meteor Pack',         desc:'Rapid-growth sprint framework',                    code:null},
  {type:'small', emoji:'ðŸ—ï¸', label:'Builder Pack',       desc:'Content empire architecture guide',                code:null},
  {type:'small', emoji:'ðŸŽ†', label:'Fireworks Pack',      desc:'Celebration content & milestones kit',            code:null},
  {type:'big',   emoji:'ðŸ‘‘', label:'Royalty Reward',      desc:'3 months Pro free + 50% off + Royalty title',     code:'ROYALTY70TV'},
  {type:'small', emoji:'ðŸŒŒ', label:'Galaxy Pack',         desc:'Abstract & philosophical content angles',          code:null},
  {type:'small', emoji:'ðŸ¦', label:'Pride Pack',          desc:'Leadership in creator communities guide',          code:null},
  {type:'small', emoji:'ðŸ”ï¸', label:'Summit Pack',        desc:'Long-term creator career blueprint',               code:null},
  {type:'small', emoji:'âš—ï¸', label:'Alchemy Pack',        desc:'Monetisation formula & product launch guide',     code:null},
  {type:'small', emoji:'ðŸŽ¯', label:'75 Legend Pack',      desc:'All-time best performing content frameworks',      code:null},
  {type:'small', emoji:'ðŸ•¹ï¸', label:'God Mode Pack',       desc:'Advanced creator cheats & shortcuts',              code:null},
  {type:'small', emoji:'ðŸŒŸ', label:'Lucky Stars Pack',    desc:'Luck-maximising consistency framework',            code:null},
  {type:'small', emoji:'ðŸ¦‹', label:'Final Form Pack',     desc:'Complete creator transformation blueprint',        code:null},
  {type:'small', emoji:'ðŸŒŠ', label:'Tidal Pack',          desc:'Mass-audience content wave strategy',              code:null},
  {type:'big',   emoji:'ðŸŒŒ', label:'Galaxy Reward',       desc:'6 months Pro free + 60% off annual + Galaxy title', code:'GALAXY80TV'},
  {type:'small', emoji:'ðŸ”®', label:'Oracle Pack',         desc:'AI-powered future content prediction kit',         code:null},
  {type:'small', emoji:'ðŸŒ', label:'Empire Pack',         desc:'Full creator empire business playbook',            code:null},
  {type:'small', emoji:'âšœï¸', label:'Crest Pack',          desc:'Prestige content positioning strategy',            code:null},
  {type:'small', emoji:'ðŸŒ ', label:'Supernova Pack',      desc:'Explosive launch campaign blueprint',              code:null},
  {type:'small', emoji:'ðŸ¦…', label:'Apex Pack',           desc:'Top 1% creator secrets compiled',                  code:null},
  {type:'small', emoji:'ðŸ›ï¸', label:'Heritage Pack',      desc:'Build your content legacy & wiki',                 code:null},
  {type:'small', emoji:'ðŸ’¥', label:'Impact Pack',         desc:'Culture-shaping content strategy',                 code:null},
  {type:'small', emoji:'ðŸŒ', label:'Global Pack',         desc:'Worldwide audience expansion blueprint',           code:null},
  {type:'small', emoji:'ðŸŒ€', label:'Vortex Pack',         desc:'Become the algorithm yourself',                    code:null},
  {type:'big',   emoji:'âšœï¸', label:'Legend Reward',       desc:'1 year Pro free + 70% off Elite + Legend title',  code:'LEGEND90TV'},
  {type:'small', emoji:'ðŸ†', label:'Trophy Storm',        desc:'Collect all previous rewards retroactively',       code:null},
  {type:'small', emoji:'ðŸ‘ï¸', label:'Omniscient Pack',     desc:'Every content signal decoded',                     code:null},
  {type:'small', emoji:'ðŸŒ‹', label:'Eternal Pack',        desc:'Timeless content formula that never dies',         code:null},
  {type:'small', emoji:'âš¡', label:'Godlike Pack',        desc:'Absolute creator power toolkit',                   code:null},
  {type:'small', emoji:'ðŸŒŒ', label:'Nebula Pack',         desc:'Inspire the next generation of creators',          code:null},
  {type:'small', emoji:'â™¾ï¸', label:'Infinite Pack',       desc:'Unlimited ideas generator framework',              code:null},
  {type:'small', emoji:'ðŸŒŸ', label:'Constellation Kit',   desc:'Your content legacy mapped as stars',              code:null},
  {type:'small', emoji:'ðŸ”±', label:'Titan Pack',          desc:'Absolute dominance â€” nothing left to prove',       code:null},
  {type:'small', emoji:'ðŸ’Ž', label:'Final Diamond',       desc:'One step from immortality',                        code:null},
  {type:'jackpot',emoji:'ðŸ†', label:'GOAT BAG â€” JACKPOT', desc:'ðŸŽ‰ 1 YEAR ELITE FREE + 80% off lifetime + GOAT title + exclusive badge + featured on TrendVid wall of fame', code:'GOAT100TV'},
];

function getRewardForLevel(level) {
  if(level >= 1 && level <= 100 && LEVEL_REWARDS[level]) return LEVEL_REWARDS[level];
  if(level % 100 === 0) return {type:'jackpot',emoji:'ðŸ†',label:'JACKPOT BAG',desc:'1 year Elite free + GOAT title',code:'JACKPOT'+level+'TV'};
  if(level % 10 === 0)  return {type:'big',    emoji:'ðŸŽ', label:'Big Reward', desc:'Pro trial + discount code',       code:'BIG'+level+'TV'};
  return {type:'small', emoji:'â­', label:'Level Up!', desc:'Keep going!', code:null};
}

function getXPData() {
  var xp = 0;
  XP_ACTIONS.forEach(function(a) { if(localStorage.getItem('tv_check_'+a.key)) xp += a.xp; });
  // Bonus XP from multiple scripts
  var scripts = []; try { scripts = JSON.parse(localStorage.getItem('tv_scripts')||'[]'); } catch(e) {}
  if(scripts.length >= 10) xp += 30;
  if(scripts.length >= 50) xp += 100;
  var storedXP = parseInt(localStorage.getItem('tv_xp_bonus')||'0');
  xp += storedXP;
  var level = Math.max(1, Math.floor(xp / XP_PER_LEVEL) + 1);
  var xpInLevel = xp % XP_PER_LEVEL;
  var pct = Math.round(xpInLevel / XP_PER_LEVEL * 100);
  return {xp, level, xpInLevel, pct};
}

function getCurrentBadge(level) {
  var badge = XP_LEVELS[0];
  for(var i = 0; i < XP_LEVELS.length; i++) {
    if(level >= XP_LEVELS[i].level) badge = XP_LEVELS[i];
  }
  return badge;
}

function getUnlockedTitles(level) {
  return XP_TITLES.filter(function(t){ return level >= t.level; });
}

function getActiveTitle() {
  try { return JSON.parse(localStorage.getItem("tv_active_title")||"null"); } catch(e) { return null; }
}

function setActiveTitle(titleId) {
  if(!titleId) {
    localStorage.removeItem("tv_active_title");
    updateXPSidebarChip();
    notify("Title removed","info","ðŸ·ï¸");
    renderXPPage();
    return;
  }
  var t = XP_TITLES.find(function(x){ return x.id === titleId; });
  if(t) {
    localStorage.setItem("tv_active_title", JSON.stringify(t));
    updateXPSidebarChip();
    notify("Title equipped: "+t.title,"success",t.emoji);
    renderXPPage();
  }
}

function getUserTitle(level) {
  var active = getActiveTitle();
  if(active) return active.title;
  // fallback: highest unlocked title
  var unlocked = XP_TITLES.filter(function(t){ return level >= t.level; });
  return unlocked.length ? unlocked[unlocked.length-1].title : '';
}

function awardXP(actionKey) {
  var action = XP_ACTIONS.find(function(a){ return a.key === actionKey; });
  if(!action) return;
  var alreadyDone = localStorage.getItem('tv_check_'+actionKey);
  if(alreadyDone) return; // each action only awards XP once
  var beforeData = getXPData();
  var beforeLevel = beforeData.level;
  localStorage.setItem('tv_check_'+actionKey, '1');
  var afterData = getXPData();
  // Check level up
  if(afterData.level > beforeLevel) {
    triggerLevelUp(afterData.level);
  } else {
    notify('+'+action.xp+' XP â€” '+action.label,'info','â­');
  }
  updateXPSidebarChip();
}

function triggerLevelUp(level) {
  var reward = getRewardForLevel(level);
  var badge  = getCurrentBadge(level);
  // Leaf confetti
  spawnLeaves(reward.type === 'jackpot' ? 80 : reward.type === 'big' ? 50 : 25);
  // Log reward
  var rewards = []; try { rewards = JSON.parse(localStorage.getItem('tv_rewards')||'[]'); } catch(e) {}
  rewards.unshift({level, reward, earnedAt: Date.now()});
  localStorage.setItem('tv_rewards', JSON.stringify(rewards.slice(0,100)));
  // Show overlay
  var overlay = document.createElement('div');
  overlay.className = 'reward-overlay';
  overlay.innerHTML = `<div class="reward-box">
    <div style="font-size:60px;margin-bottom:4px;animation:float 2s ease infinite">${reward.emoji}</div>
    <div style="font-family:var(--font-display);font-size:11px;font-weight:900;letter-spacing:3px;color:var(--gold);margin-bottom:8px">${reward.type==='jackpot'?'JACKPOT!':reward.type==='big'?'BIG REWARD':'LEVEL UP'}</div>
    <div style="font-family:var(--font-display);font-size:36px;font-weight:900;letter-spacing:-1px;margin-bottom:4px">Level ${level}</div>
    <div style="font-size:22px;margin-bottom:6px">${badge.emoji}</div>
    <div style="font-size:14px;font-weight:700;color:var(--text2);margin-bottom:4px">${badge.name}</div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:20px">${reward.desc}</div>
    ${reward.code ? `<div style="margin-bottom:20px">
      <div style="font-size:10px;color:var(--muted);font-weight:700;letter-spacing:1px;margin-bottom:6px;font-family:var(--font-display)">YOUR REWARD CODE</div>
      <div class="reward-item-code" onclick="navigator.clipboard.writeText('${reward.code}').then(()=>notify('Code copied!','success','ðŸ“‹'))">${reward.code}</div>
      <div style="font-size:10px;color:var(--muted);margin-top:6px">Tap to copy Â· Redeem in Plans & Pricing</div>
    </div>` : ''}
    <button class="btn btn-primary" style="width:100%" onclick="this.closest('.reward-overlay').remove()">ðŸŽ‰ Awesome!</button>
    <button class="btn btn-ghost btn-sm" style="width:100%;margin-top:8px" onclick="this.closest('.reward-overlay').remove();navTo('xp')">View All Rewards â†’</button>
  </div>`;
  document.body.appendChild(overlay);
}

function spawnLeaves(count) {
  var leaves = ['ðŸ€','ðŸŒ¿','ðŸƒ','ðŸŒ±','ðŸŒ¾','ðŸ','ðŸ‚','âœ¨','â­','ðŸ’«','ðŸŒŸ'];
  for(var i = 0; i < count; i++) {
    (function(idx) {
      setTimeout(function() {
        var leaf = document.createElement('div');
        leaf.className = 'leaf-particle';
        leaf.textContent = leaves[Math.floor(Math.random()*leaves.length)];
        leaf.style.left  = Math.random()*100+'vw';
        leaf.style.top   = '-40px';
        leaf.style.fontSize = (14 + Math.random()*16)+'px';
        var dur = 2.5 + Math.random()*3;
        leaf.style.animationDuration = dur+'s';
        leaf.style.animationDelay = '0s';
        document.body.appendChild(leaf);
        setTimeout(function(){ leaf.remove(); }, dur*1000+100);
      }, idx * 40);
    })(i);
  }
}

function updateXPSidebarChip() {
  var d = getXPData();
  var badge = getCurrentBadge(d.level);
  var activeTitle = getActiveTitle();
  var displayName = activeTitle ? activeTitle.title : badge.badge;
  var displayEmoji = activeTitle ? activeTitle.emoji : badge.emoji;
  // Desktop sidebar
  var cl = document.getElementById('xpChipLevel');
  var cb = document.getElementById('xpChipBadge');
  var cf = document.getElementById('xpChipFill');
  var cx = document.getElementById('xpChipLabel');
  var lb = document.getElementById('xpLevelBadge');
  var lbm = document.getElementById('xpLevelBadgeMobile');
  if(cl) cl.textContent = 'LVL '+d.level+' Â· '+displayName;
  if(cb) cb.textContent = displayEmoji;
  if(cf) cf.style.width = d.pct+'%';
  if(cx) cx.textContent = d.xpInLevel+' / '+XP_PER_LEVEL+' XP to next level';
  if(lb) lb.textContent = d.level;
  if(lbm) lbm.textContent = d.level;
  // Mobile sidebar chip
  var mcl = document.getElementById('xpChipLevelMobile');
  var mcb = document.getElementById('xpChipBadgeMobile');
  var mcf = document.getElementById('xpChipFillMobile');
  var mcx = document.getElementById('xpChipLabelMobile');
  if(mcl) mcl.textContent = 'LVL '+d.level+' Â· '+displayName;
  if(mcb) mcb.textContent = displayEmoji;
  if(mcf) mcf.style.width = d.pct+'%';
  if(mcx) mcx.textContent = d.xpInLevel+' / '+XP_PER_LEVEL+' XP Â· Tap to view';
}

// ============================================================
// XP PAGE RENDERER
// ============================================================
function renderXPPage() {
  var d = getXPData();
  var badge = getCurrentBadge(d.level);
  var plan  = currentUser?.plan || 'free';
  var tierBadge = TIER_XP_BADGES[plan] || TIER_XP_BADGES.free;
  var rewards = []; try { rewards = JSON.parse(localStorage.getItem('tv_rewards')||'[]'); } catch(e) {}
  var activeTitle = getActiveTitle();
  var unlockedTitles = getUnlockedTitles(d.level);

  // â”€â”€ LEVEL MAP: all 100 levels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var levelsHtml = XP_LEVELS.map(function(lv) {
    var unlocked = d.level >= lv.level;
    var isCurrent = d.level === lv.level;
    var reward = getRewardForLevel(lv.level);
    var isBig = reward.type === 'big' || reward.type === 'jackpot';
    return '<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;border:1px solid '+(isCurrent?'rgba(255,48,88,0.5)':unlocked?'rgba('+lv.color.replace('#','').match(/.{2}/g).map(h=>parseInt(h,16)).join(',')+',0.2)':'var(--border)')+';background:'+(isCurrent?'rgba(255,48,88,0.08)':isBig&&unlocked?'rgba(251,191,36,0.05)':'transparent')+';margin-bottom:6px;transition:all 0.2s;">'
      +'<div style="width:32px;height:32px;border-radius:50%;background:'+(unlocked?lv.color:'var(--surface3)')+';display:flex;align-items:center;justify-content:center;font-size:'+(isBig?'18':'15')+'px;flex-shrink:0;opacity:'+(unlocked?1:0.3)+';box-shadow:'+(unlocked?'0 0 12px '+lv.glow:'none')+';">'
      +lv.emoji+'</div>'
      +'<div style="flex:1;min-width:0">'
      +'<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">'
      +'<span style="font-family:var(--font-display);font-size:10px;font-weight:900;color:'+(unlocked?lv.color:'var(--muted)')+'">LVL '+lv.level+'</span>'
      +'<span style="font-size:12px;font-weight:700;color:'+(unlocked?'var(--text)':'var(--muted)')+'">'+lv.badge+'</span>'
      +(isBig?'<span style="font-size:9px;font-weight:900;color:'+(reward.type==='jackpot'?'var(--elite)':'var(--gold)')+';background:'+(reward.type==='jackpot'?'rgba(192,132,252,0.12)':'rgba(251,191,36,0.1)')+';border:1px solid '+(reward.type==='jackpot'?'rgba(192,132,252,0.3)':'rgba(251,191,36,0.3)')+';padding:1px 6px;border-radius:6px;font-family:var(--font-display);letter-spacing:0.5px">'+(reward.type==='jackpot'?'ðŸŽ’ JACKPOT':'ðŸŽ BIG')+'</span>':'')
      +(isCurrent?'<span style="font-size:9px;font-weight:900;color:var(--accent);background:rgba(255,48,88,0.1);border:1px solid rgba(255,48,88,0.3);padding:1px 6px;border-radius:6px;font-family:var(--font-display)">YOU ARE HERE</span>':'')
      +'</div>'
      +'<div style="font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+lv.title+' â€” '+lv.desc+'</div>'
      +'</div>'
      +'<div style="text-align:right;flex-shrink:0">'
      +'<div style="font-size:11px;color:'+(unlocked?lv.color:'var(--muted)')+';font-weight:700;white-space:nowrap">'+reward.emoji+' '+reward.label+'</div>'
      +(unlocked?'<div style="font-size:9px;color:var(--teal);font-weight:800;font-family:var(--font-display)">âœ“ EARNED</div>':'<div style="font-size:9px;color:var(--muted)">'+(lv.level*100-d.xp+d.xpInLevel)+' XP away</div>')
      +'</div>'
      +'</div>';
  }).join('');

  // â”€â”€ BADGES GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var badgesHtml = XP_LEVELS.map(function(b) {
    var unlocked = d.level >= b.level;
    return '<div class="badge-card '+(unlocked?'unlocked':'locked')+'" style="'+(unlocked?'--badge-glow:'+b.glow:'')+'">'
      +'<span class="badge-icon">'+b.emoji+'</span>'
      +'<div class="badge-name" style="'+(unlocked?'color:'+b.color:'')+'">'+b.badge+'</div>'
      +'<div class="badge-desc">Lvl '+b.level+'</div>'
      +'<div class="badge-desc" style="font-size:9px;color:var(--muted)">'+b.title+'</div>'
      +(unlocked?'<div style="font-size:9px;font-weight:800;color:var(--teal);letter-spacing:0.5px;margin-top:4px;font-family:var(--font-display)">âœ“ UNLOCKED</div>':'')
      +'</div>';
  }).join('');

  // â”€â”€ TITLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var titlesHtml = XP_TITLES.map(function(t) {
    var unlocked = d.level >= t.level;
    var isActive = activeTitle && activeTitle.id === t.id;
    return '<div style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:'+(isActive?'rgba(255,48,88,0.06)':'var(--surface2)')+';border:1px solid '+(isActive?'rgba(255,48,88,0.4)':unlocked?'var(--border2)':'var(--border)')+';border-radius:12px;margin-bottom:8px;opacity:'+(unlocked?1:0.4)+';">'
      +'<div style="font-size:28px;flex-shrink:0;filter:'+(unlocked?'none':'grayscale(1)')+'">'+t.emoji+'</div>'
      +'<div style="flex:1;">'
      +'<div style="font-size:13px;font-weight:800;color:'+(unlocked?t.color:'var(--muted)')+'">'+t.title+'</div>'
      +'<div style="font-size:11px;color:var(--muted)">Unlocked at Level '+t.level+(unlocked?' Â· âœ“ Earned':''+(d.level < t.level?' Â· '+(t.level-d.level)+' levels away':''))+'</div>'
      +'</div>'
      +(unlocked
        ? '<button onclick="setActiveTitle(\''+t.id+'\')" style="background:'+(isActive?'rgba(255,48,88,0.15)':'rgba(0,229,176,0.1)')+';border:1px solid '+(isActive?'rgba(255,48,88,0.4)':'rgba(0,229,176,0.3)')+';color:'+(isActive?'var(--accent)':'var(--teal)')+';padding:6px 12px;border-radius:8px;font-size:11px;font-weight:800;cursor:pointer;font-family:var(--font-display);white-space:nowrap">'+(isActive?'âœ“ EQUIPPED':'EQUIP')+'</button>'
        : '<span style="font-size:11px;color:var(--muted);font-weight:700">LVL '+t.level+' ðŸ”’</span>')
      +'</div>';
  }).join('');

  // â”€â”€ TIER BADGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var tierHtml = Object.entries(TIER_XP_BADGES).map(function([key, tb]) {
    var owned = plan === key;
    return '<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">'
      +'<div style="font-size:26px">'+tb.emoji+'</div>'
      +'<div style="flex:1"><div style="font-size:13px;font-weight:700">'+tb.name+'</div><div style="font-size:11px;color:var(--muted)">'+tb.desc+'</div></div>'
      +(owned ? '<span style="'+tb.style+';padding:4px 12px;border-radius:20px;font-size:10px;font-weight:900;font-family:var(--font-display)">âœ“ YOURS</span>' : '<button class="btn btn-ghost btn-sm" onclick="navTo(\'pricing\')" style="font-size:11px">Upgrade</button>')
      +'</div>';
  }).join('');

  // â”€â”€ ACTIONS CHECKLIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var actionsHtml = XP_ACTIONS.map(function(a) {
    var done = !!localStorage.getItem('tv_check_'+a.key);
    return '<div class="checklist-item'+(done?' done':'')+'">'
      +'<div class="checklist-circle">'+(done?'âœ“':'')+'</div>'
      +'<span class="checklist-label">'+a.icon+' '+a.label+'</span>'
      +'<span class="checklist-xp">'+(done?'âœ“ Earned':'+'+a.xp+' XP')+'</span>'
      +'</div>';
  }).join('');

  // â”€â”€ REWARDS LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var rewardsHtml = rewards.length ? rewards.map(function(r) {
    return '<div class="reward-item">'
      +'<div class="reward-item-icon">'+r.reward.emoji+'</div>'
      +'<div style="flex:1">'
      +'<div class="reward-item-label">'+r.reward.label+' <span style="color:var(--gold);font-size:11px">Â· Level '+r.level+'</span></div>'
      +'<div class="reward-item-sub">'+r.reward.desc+'</div>'
      +'</div>'
      +(r.reward.code ? '<span class="reward-item-code" onclick="navigator.clipboard.writeText(\''+r.reward.code+'\').then(()=>notify(\'Copied!\',\'success\',\'ðŸ“‹\'))" title="Click to copy">'+r.reward.code+'</span>' : '')
      +'</div>';
  }).join('') : '<div style="text-align:center;padding:24px;color:var(--muted);font-size:13px">No rewards yet â€” level up to earn them!</div>';

  var next10 = Math.ceil((d.level+0.5) / 10) * 10;
  var next100 = 100;

  document.getElementById('pageContent').innerHTML = `
    <div class="xp-hero" style="animation:slideUp 0.4s ease">
      <span class="xp-hero-badge">${badge.emoji}</span>
      <div class="xp-hero-level" style="color:${badge.color || 'var(--gold)'};">${d.level}</div>
      <div style="font-family:var(--font-display);font-size:20px;font-weight:900;letter-spacing:1px;margin-bottom:2px;color:${badge.color || 'var(--text)'};">${badge.badge}</div>
      ${activeTitle ? `<div style="display:inline-flex;align-items:center;gap:6px;background:rgba(255,48,88,0.08);border:1px solid rgba(255,48,88,0.3);padding:4px 12px;border-radius:20px;margin-bottom:8px;font-size:12px;font-weight:800;color:var(--accent)">${activeTitle.emoji} ${activeTitle.title}</div>` : ''}
      <div style="font-size:12px;color:var(--muted);margin-bottom:16px">${badge.desc} Â· <strong style="color:var(--gold)">${d.xp} XP total</strong></div>
      <div class="xp-bar-wrap">
        <div class="xp-bar-fill" style="width:${d.pct}%;background:linear-gradient(90deg,${badge.color || 'var(--gold)'},var(--accent));"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);font-weight:600;margin-top:6px">
        <span>${d.xpInLevel} XP</span>
        <span>${XP_PER_LEVEL - d.xpInLevel} XP to Level ${d.level+1}</span>
        <span>${XP_PER_LEVEL} XP</span>
      </div>
      <div style="margin-top:14px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
        <span class="tier-xp-badge" style="${tierBadge.style}">${tierBadge.emoji} ${tierBadge.name}</span>
        ${unlockedTitles.length > 0 ? `<span style="background:rgba(255,48,88,0.08);border:1px solid rgba(255,48,88,0.25);color:var(--accent);padding:6px 14px;border-radius:20px;font-family:var(--font-display);font-size:11px;font-weight:800;cursor:pointer" onclick="showXPTab('titles')">ðŸ·ï¸ ${unlockedTitles.length} TITLES EARNED</span>` : ''}
      </div>
    </div>

    <!-- UPCOMING REWARDS -->
    <div class="card" style="margin-bottom:20px;animation:slideUp 0.4s 0.05s ease both">
      <div class="section-label" style="margin-bottom:14px">â­ï¸ UPCOMING REWARDS</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
        <div style="background:rgba(251,191,36,0.06);border:1px solid rgba(251,191,36,0.2);border-radius:12px;padding:14px;text-align:center">
          <div style="font-size:24px;margin-bottom:4px">â­</div>
          <div style="font-family:var(--font-display);font-size:10px;font-weight:800;color:var(--gold)">EVERY LEVEL</div>
          <div style="font-size:10px;color:var(--muted);margin-top:4px">Unique reward + badge</div>
        </div>
        <div style="background:rgba(255,138,0,0.06);border:1px solid rgba(255,138,0,0.25);border-radius:12px;padding:14px;text-align:center">
          <div style="font-size:24px;margin-bottom:4px">ðŸŽ</div>
          <div style="font-family:var(--font-display);font-size:10px;font-weight:800;color:var(--accent2)">EVERY 10 LEVELS</div>
          <div style="font-size:10px;color:var(--muted);margin-top:4px">Pro trial + discount</div>
          <div style="font-size:10px;color:var(--accent2);font-weight:700;margin-top:4px">Next: Lvl ${next10}</div>
        </div>
        <div style="background:rgba(192,132,252,0.06);border:1px solid rgba(192,132,252,0.25);border-radius:12px;padding:14px;text-align:center">
          <div style="font-size:24px;margin-bottom:4px">ðŸ†</div>
          <div style="font-family:var(--font-display);font-size:10px;font-weight:800;color:var(--elite)">LEVEL 100</div>
          <div style="font-size:10px;color:var(--muted);margin-top:4px">GOAT Jackpot Bag</div>
          <div style="font-size:10px;color:var(--elite);font-weight:700;margin-top:4px">Next: Lvl ${next100}</div>
        </div>
      </div>
    </div>

    <!-- TABS -->
    <div style="display:flex;gap:4px;background:var(--surface2);padding:4px;border-radius:13px;border:1px solid var(--border);margin-bottom:20px;animation:slideUp 0.4s 0.1s ease both;overflow-x:auto;flex-wrap:nowrap">
      <button class="btn btn-primary btn-sm" id="xpTab1" style="flex:1;border-radius:9px;white-space:nowrap;min-width:70px" onclick="showXPTab('levels')">ðŸ—ºï¸ All 100</button>
      <button class="btn btn-ghost btn-sm" id="xpTab2" style="flex:1;border-radius:9px;white-space:nowrap;min-width:70px" onclick="showXPTab('badges')">ðŸ… Badges</button>
      <button class="btn btn-ghost btn-sm" id="xpTab3" style="flex:1;border-radius:9px;white-space:nowrap;min-width:60px" onclick="showXPTab('titles')">ðŸ·ï¸ Titles</button>
      <button class="btn btn-ghost btn-sm" style="flex-shrink:0;border-radius:9px;white-space:nowrap;border-color:rgba(0,229,176,0.4);color:var(--teal)" onclick="showCreatorStatsCard()">ðŸ“Š Stats Card</button>
      <button class="btn btn-ghost btn-sm" style="flex-shrink:0;border-radius:9px;white-space:nowrap;border-color:rgba(251,191,36,0.4);color:var(--gold)" onclick="showCertifiedBadge()">ðŸ… Get Badge</button>
      <button class="btn btn-ghost btn-sm" id="xpTab4" style="flex:1;border-radius:9px;white-space:nowrap;min-width:60px" onclick="showXPTab('actions')">âš¡ Earn</button>
      <button class="btn btn-ghost btn-sm" id="xpTab5" style="flex:1;border-radius:9px;white-space:nowrap;min-width:70px" onclick="showXPTab('rewards')">ðŸŽ Rewards</button>
      <button class="btn btn-ghost btn-sm" id="xpTab6" style="flex:1;border-radius:9px;white-space:nowrap;min-width:50px" onclick="showXPTab('tier')">ðŸ’Ž Tier</button>
    </div>

    <div id="xpTabLevels" style="animation:slideUp 0.3s ease">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
        <div class="section-label">ðŸ—ºï¸ ALL 100 LEVELS â€” ${d.level}/100 REACHED</div>
        <div style="background:rgba(0,229,176,0.08);border:1px solid rgba(0,229,176,0.25);border-radius:8px;padding:4px 12px;font-size:11px;font-weight:800;color:var(--teal)">${Math.round(d.level)}% COMPLETE</div>
      </div>
      <div class="card" style="padding:12px">
        ${levelsHtml}
      </div>
    </div>

    <div id="xpTabBadges" style="display:none;animation:slideUp 0.3s ease">
      <div class="section-label" style="margin-bottom:12px">ðŸ… 100 BADGES â€” ${d.level} UNLOCKED</div>
      <div class="badges-grid">${badgesHtml}</div>
    </div>

    <div id="xpTabTitles" style="display:none;animation:slideUp 0.3s ease">
      <div class="section-label" style="margin-bottom:6px">ðŸ·ï¸ TITLES â€” ${unlockedTitles.length}/${XP_TITLES.length} UNLOCKED</div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:16px">Equip a title to display it on your XP chip and sidebar.</div>
      ${titlesHtml}
    </div>

    <div id="xpTabActions" style="display:none;animation:slideUp 0.3s ease">
      <div class="section-label" style="margin-bottom:12px">âš¡ EARN XP â€” ${XP_ACTIONS.filter(a=>localStorage.getItem('tv_check_'+a.key)).length}/${XP_ACTIONS.length} COMPLETE</div>
      <div class="card"><div class="checklist-progress" style="margin-bottom:16px"><div class="checklist-progress-fill" style="width:${Math.round(XP_ACTIONS.filter(a=>localStorage.getItem('tv_check_'+a.key)).length/XP_ACTIONS.length*100)}%"></div></div>${actionsHtml}</div>
    </div>

    <div id="xpTabRewards" style="display:none;animation:slideUp 0.3s ease">
      <div class="section-label" style="margin-bottom:12px">ðŸŽ MY REWARD HISTORY</div>
      ${rewardsHtml}
    </div>

    <div id="xpTabTier" style="display:none;animation:slideUp 0.3s ease">
      <div class="section-label" style="margin-bottom:12px">ðŸ’Ž SUBSCRIPTION TIER BADGES</div>
      <div class="card">${tierHtml}</div>
      <div class="card" style="margin-top:12px;text-align:center;padding:20px">
        <div style="font-size:13px;color:var(--muted);margin-bottom:12px">Upgrade to unlock higher tier badges and bonus XP</div>
        <button class="btn btn-primary" onclick="navTo('pricing')">View Plans ðŸ’Ž</button>
      </div>
    </div>`;

  updateXPSidebarChip();
}

function showXPTab(tab) {
  var tabs = ['levels','badges','titles','actions','rewards','tier'];
  tabs.forEach(function(t, i) {
    var panel = document.getElementById('xpTab' + t.charAt(0).toUpperCase() + t.slice(1));
    var btn   = document.getElementById('xpTab' + (i + 1));
    if (panel) panel.style.display = t === tab ? '' : 'none';
    if (btn) {
      btn.className = (t === tab ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm');
      btn.style.flex = '1';
      btn.style.borderRadius = '9px';
      btn.style.whiteSpace = 'nowrap';
    }
  });
}
window.addEventListener('load', function() {
  // â”€â”€ AUTO-LOGIN: if user was previously logged in, skip landing page â”€â”€
  try {
    var savedUser = localStorage.getItem('tv_user');
    if (savedUser) {
      var parsedUser = JSON.parse(savedUser);
      if (parsedUser && parsedUser.email) {
        var isAdmin = (parsedUser.email === _ADMIN_EMAIL);
        enterAppWithUser(parsedUser.email, isAdmin, parsedUser.name || undefined);
      }
    }
  } catch(e) { /* silenced â€” just show landing page */ }

  initAIProviders();
  checkAndSendWeeklyReports();
  initCookieBanner();
  checkStripeReturn();
  updateXPSidebarChip();
  syncXPToUserRecord();
  checkLeaderboardRewards();
  checkDailyStreak();
  updateAdminNotifBadge();
  setTimeout(function() {
    var p = getActiveProvider();
    var pName = p ? p.name : 'AI';
    notify('âš¡ TrendVid AI ready â€” powered by '+pName, 'success', 'ðŸš€');
  }, 900);
  var styleEl = document.createElement('style');
  styleEl.textContent = '@keyframes slideDown{from{opacity:0;transform:translateX(-50%) translateY(-30px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}';
  document.head.appendChild(styleEl);
  window.onerror = function(msg, src, line) { return true; };
  window.onunhandledrejection = function(e) { };
  document.addEventListener('click', function(e) {
    if(e.target.closest('[onclick*="saveFav"], [onclick*="addFav"]')) awardXP('saved_fav');
  });
});


// ============================================================
// GLOBAL LEADERBOARD SYSTEM
// Uses tv_all_users + tv_xp_bonus + tv_check_* keys
// Tracks weekly #1 streaks and rewards
// ============================================================

function getLeaderboardData() {
  // Build leaderboard from all tracked users
  var users = [];
  try { users = JSON.parse(localStorage.getItem('tv_all_users') || '[]'); } catch(e) {}
  
  // Build entries
  var entries = users.map(function(u) {
    var xp = u.xp_total || 0;
    var level = Math.max(1, Math.floor(xp / XP_PER_LEVEL) + 1);
    var badge = getCurrentBadge(level);
    return {
      name: u.name || u.email || 'Anonymous',
      email: u.email || '',
      xp: xp,
      level: level,
      badge: badge,
      plan: u.plan || 'free',
      streak: u.leaderboard_streak || 0,
      lastFirstAt: u.leaderboard_first_at || null
    };
  });

  // Include current user (may not be in tv_all_users yet or may have fresher XP)
  if (currentUser) {
    var myXP = getXPData();
    var myBadge = getCurrentBadge(myXP.level);
    var existing = entries.find(function(e) { return e.email === currentUser.email; });
    if (existing) {
      existing.xp = myXP.xp;
      existing.level = myXP.level;
      existing.badge = myBadge;
    } else {
      entries.push({
        name: currentUser.name || 'You',
        email: currentUser.email,
        xp: myXP.xp,
        level: myXP.level,
        badge: myBadge,
        plan: currentUser.plan || 'free',
        streak: 0,
        lastFirstAt: null,
        isYou: true
      });
    }
    // Mark self
    entries.forEach(function(e) {
      if (e.email === currentUser.email) e.isYou = true;
    });
  }

  // Sort by XP desc
  entries.sort(function(a, b) { return b.xp - a.xp; });
  return entries;
}


// ============================================================
// IMAGE GENERATOR â€” Free for all users, powered by Pollinations AI
// ============================================================
function renderImageGen() {
  var history = [];
  try { history = JSON.parse(localStorage.getItem('tv_image_history') || '[]'); } catch(e) {}

  var styles = [
    {id:'photorealistic', label:'ðŸ“¸ Photo', desc:'Ultra-realistic photography'},
    {id:'cinematic',      label:'ðŸŽ¬ Cinematic', desc:'Movie-grade lighting'},
    {id:'digital-art',    label:'ðŸŽ¨ Digital Art', desc:'Vibrant digital illustration'},
    {id:'anime',          label:'âœ¨ Anime', desc:'Japanese animation style'},
    {id:'3d-render',      label:'ðŸ§Š 3D Render', desc:'CGI / 3D rendered look'},
    {id:'watercolor',     label:'ðŸŽ­ Watercolour', desc:'Soft painted textures'},
    {id:'minimalist',     label:'â¬œ Minimal', desc:'Clean, simple composition'},
    {id:'neon-cyberpunk', label:'ðŸ’œ Cyberpunk', desc:'Neon-lit futuristic city'},
    {id:'vintage',        label:'ðŸŸ« Vintage', desc:'Film grain retro feel'},
    {id:'flat-design',    label:'ðŸŸ¦ Flat Design', desc:'Bold shapes & colours'},
  ];

  var ratios = [
    {id:'1:1',   label:'1:1',  icon:'â¬œ', w:1024, h:1024, hint:'Instagram post'},
    {id:'16:9',  label:'16:9', icon:'â–¬',  w:1280, h:720,  hint:'YouTube / Banner'},
    {id:'9:16',  label:'9:16', icon:'â–®',  w:720,  h:1280, hint:'Reels / Shorts'},
    {id:'4:3',   label:'4:3',  icon:'â–­',  w:1024, h:768,  hint:'Classic'},
    {id:'3:4',   label:'3:4',  icon:'â–¯',  w:768,  h:1024, hint:'Portrait'},
    {id:'21:9',  label:'21:9', icon:'â”',  w:1512, h:648,  hint:'Ultrawide banner'},
  ];

  // History rendered separately by renderImageGenHistory()

  document.getElementById('pageContent').innerHTML =
    '<div style="max-width:860px;margin:0 auto">' +

    // Header
    '<div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:20px">' +
      '<div>' +
        '<div style="font-family:var(--font-display);font-size:22px;font-weight:900;letter-spacing:-0.5px">ðŸ–¼ï¸ AI Image Generator</div>' +
        '<div style="font-size:12px;color:var(--muted);margin-top:3px">Create stunning visuals for your thumbnails, content & social posts â€” free for all users</div>' +
      '</div>' +
      '<div style="display:flex;align-items:center;gap:8px">' +
        '<span style="font-size:10px;font-weight:900;background:linear-gradient(135deg,rgba(0,229,176,0.15),rgba(167,139,250,0.1));color:var(--teal);border:1px solid rgba(0,229,176,0.3);padding:4px 12px;border-radius:20px;letter-spacing:1px">âœ¨ FREE FOR ALL USERS</span>' +
        (history.length > 0 ? '<button class="btn btn-ghost btn-sm" onclick="if(confirm(\'Clear image history?\')){localStorage.removeItem(\'tv_image_history\');renderImageGen();}">ðŸ—‘ï¸ Clear History</button>' : '') +
      '</div>' +
    '</div>' +

    // Generator card
    '<div class="card" style="border:1px solid rgba(0,229,176,0.2);background:linear-gradient(135deg,rgba(0,229,176,0.03),transparent)">' +

      // Prompt
      '<div class="form-field" style="margin-bottom:16px">' +
        '<label style="font-size:10px;font-weight:900;color:var(--teal);letter-spacing:1.5px;font-family:var(--font-display)">âœï¸ DESCRIBE YOUR IMAGE</label>' +
        '<textarea id="imgPrompt" rows="3" class="form-input" placeholder="e.g. A cinematic shot of a content creator at their desk, dramatic lighting, YouTube studio setup, ultra-detailed, 8K..." style="resize:none;font-size:13px;line-height:1.6;margin-top:6px"></textarea>' +
      '</div>' +

      // Negative prompt
      '<div class="form-field" style="margin-bottom:16px">' +
        '<label style="font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1.5px;font-family:var(--font-display)">ðŸš« NEGATIVE PROMPT <span style="font-weight:400;font-size:9px">(what to avoid)</span></label>' +
        '<input id="imgNegative" class="form-input" placeholder="blurry, low quality, watermark, text, ugly, deformed..." style="font-size:12px;margin-top:6px">' +
      '</div>' +

      // Style picker
      '<div style="margin-bottom:16px">' +
        '<label style="font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1.5px;font-family:var(--font-display);display:block;margin-bottom:8px">ðŸŽ¨ STYLE</label>' +
        '<div style="display:flex;flex-wrap:wrap;gap:6px" id="imgStylePicker">' +
          styles.map(function(s) {
            var isActive = s.id === 'photorealistic';
            return '<button onclick="imageGenSelectStyle(\''+s.id+'\')" id="imgStyleBtn_'+s.id+'" title="'+s.desc+'" style="border:1px solid '+(isActive?'var(--teal)':'var(--border)')+';background:'+(isActive?'rgba(0,229,176,0.12)':'transparent')+';color:'+(isActive?'var(--teal)':'var(--text2)')+';border-radius:9px;padding:5px 12px;font-size:11px;font-weight:700;cursor:pointer;transition:all 0.15s;font-family:inherit">'+s.label+'</button>';
          }).join('') +
        '</div>' +
      '</div>' +

      // Aspect ratio
      '<div style="margin-bottom:16px">' +
        '<label style="font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1.5px;font-family:var(--font-display);display:block;margin-bottom:8px">ðŸ“ ASPECT RATIO</label>' +
        '<div style="display:flex;flex-wrap:wrap;gap:6px" id="imgRatioPicker">' +
          ratios.map(function(r) {
            var isActive = r.id === '1:1';
            return '<button onclick="imageGenSelectRatio(\''+r.id+'\')" id="imgRatioBtn_'+r.id+'" title="'+r.hint+'" style="border:1px solid '+(isActive?'var(--teal)':'var(--border)')+';background:'+(isActive?'rgba(0,229,176,0.12)':'transparent')+';color:'+(isActive?'var(--teal)':'var(--text2)')+';border-radius:9px;padding:6px 12px;font-size:11px;font-weight:800;cursor:pointer;transition:all 0.15s;font-family:inherit;display:flex;flex-direction:column;align-items:center;min-width:58px">' +
              '<span style="font-size:13px;line-height:1">'+r.icon+'</span>' +
              '<span style="font-size:10px;font-weight:900">'+r.label+'</span>' +
              '<span style="font-size:8px;opacity:0.7">'+r.hint+'</span>' +
            '</button>';
          }).join('') +
        '</div>' +
      '</div>' +

      // Generation count + seed
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">' +
        '<div class="form-field" style="margin:0">' +
          '<label style="font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1.5px;font-family:var(--font-display)">ðŸ”¢ HOW MANY</label>' +
          '<select id="imgCount" class="form-input" style="font-size:12px;margin-top:6px">' +
            '<option value="1">1 image</option>' +
            '<option value="2" selected>2 images</option>' +
            '<option value="4">4 images</option>' +
          '</select>' +
        '</div>' +
        '<div class="form-field" style="margin:0">' +
          '<label style="font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1.5px;font-family:var(--font-display)">ðŸŽ² SEED <span style="font-weight:400;font-size:9px">(blank = random)</span></label>' +
          '<input id="imgSeed" class="form-input" placeholder="Random" type="number" min="1" max="99999999" style="font-size:12px;margin-top:6px">' +
        '</div>' +
      '</div>' +

      // Quick prompt ideas
      '<div style="margin-bottom:16px">' +
        '<label style="font-size:10px;font-weight:900;color:var(--muted);letter-spacing:1.5px;font-family:var(--font-display);display:block;margin-bottom:8px">ðŸ’¡ QUICK IDEAS</label>' +
        '<div style="display:flex;flex-wrap:wrap;gap:6px">' +
          ['YouTube thumbnail background, dramatic lighting, studio setup',
           'Content creator working at desk, cinematic, moody atmosphere',
           'Viral social media graphic, bold colours, eye-catching design',
           'Tech setup with multiple screens, glowing neon, professional',
           'Abstract digital art, trending aesthetic, vibrant gradients',
           'Podcast studio, professional microphone, warm lighting',
           'Flat lay product shot, clean white background, minimal',
           'Futuristic AI technology concept, neural networks, glowing'].map(function(idea) {
            return '<button onclick="document.getElementById(\'imgPrompt\').value=\''+idea.replace(/'/g,"\\'")+'\'" style="background:var(--surface2);border:1px solid var(--border);color:var(--text2);border-radius:8px;padding:4px 10px;font-size:10px;font-weight:600;cursor:pointer;transition:all 0.15s;font-family:inherit" onmouseover="this.style.borderColor=\'var(--teal)\';this.style.color=\'var(--teal)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.color=\'var(--text2)\'">'+idea.substring(0,32)+'â€¦</button>';
          }).join('') +
        '</div>' +
      '</div>' +

      // Generate button
      '<button class="btn btn-primary" id="imgGenBtn" onclick="imageGenGenerate()" style="width:100%;font-size:14px;padding:13px;font-family:var(--font-display);letter-spacing:0.5px">' +
        'âœ¨ Generate Image' +
      '</button>' +

      // Result area
      '<div id="imgGenResult" style="margin-top:18px"></div>' +

    '</div>' +

    // History
    '<div id="imgGenHistory"></div>' +

    // Enlarge modal placeholder
    '<div id="imgEnlargeModal" style="display:none;position:fixed;inset:0;z-index:99990;background:rgba(0,0,0,0.88);backdrop-filter:blur(8px);cursor:pointer;align-items:center;justify-content:center;flex-direction:column;gap:16px" onclick="imageGenCloseEnlarge()">' +
      '<div style="max-width:90vw;max-height:80vh;overflow:hidden;border-radius:16px;box-shadow:0 32px 100px rgba(0,0,0,0.8)">' +
        '<img id="imgEnlargeImg" src="" style="max-width:100%;max-height:80vh;object-fit:contain;display:block">' +
      '</div>' +
      '<div style="display:flex;gap:12px" onclick="event.stopPropagation()">' +
        '<a id="imgEnlargeDownload" href="" download="trendvid-image.jpg" style="background:var(--accent);color:#fff;padding:10px 24px;border-radius:10px;font-size:13px;font-weight:800;text-decoration:none;font-family:var(--font-display)">â¬‡ï¸ Download</a>' +
        '<button onclick="imageGenCloseEnlarge()" style="background:var(--surface);color:var(--text);border:1px solid var(--border2);padding:10px 24px;border-radius:10px;font-size:13px;font-weight:800;cursor:pointer;font-family:var(--font-display)">âœ• Close</button>' +
      '</div>' +
    '</div>' +

  '</div>';

  // Set defaults
  window._imgStyle = 'photorealistic';
  window._imgRatio = '1:1';
}

// Style selector
function imageGenSelectStyle(id) {
  window._imgStyle = id;
  document.querySelectorAll('[id^="imgStyleBtn_"]').forEach(function(b) {
    var isActive = b.id === 'imgStyleBtn_' + id;
    b.style.background = isActive ? 'rgba(0,229,176,0.12)' : 'transparent';
    b.style.color = isActive ? 'var(--teal)' : 'var(--text2)';
    b.style.borderColor = isActive ? 'var(--teal)' : 'var(--border)';
  });
}

// Ratio selector
function imageGenSelectRatio(id) {
  window._imgRatio = id;
  document.querySelectorAll('[id^="imgRatioBtn_"]').forEach(function(b) {
    var isActive = b.id === 'imgRatioBtn_' + id;
    b.style.background = isActive ? 'rgba(0,229,176,0.12)' : 'transparent';
    b.style.color = isActive ? 'var(--teal)' : 'var(--text2)';
    b.style.borderColor = isActive ? 'var(--teal)' : 'var(--border)';
  });
  setTimeout(renderImageGenHistory, 50);
}
// Main generate function
// â”€â”€ Image gen helpers (top-level to avoid nested async fn issues) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Image generation â€” multi-provider with automatic fallback â”€â”€
var _imgProviderFailures = {};

// Helper: load image via <img> tag (bypasses CORS), draw to canvas, return dataURL
async function _imgFetchAsDataURL(url, retries) {
  retries = retries === undefined ? 2 : retries;
  for (var attempt = 0; attempt <= retries; attempt++) {
    try {
      var dataUrl = await new Promise(function(resolve, reject) {
        var img = new Image();
        img.crossOrigin = 'anonymous';
        var timer = setTimeout(function() { reject(new Error('Image load timeout after 60s')); }, 60000);
        img.onload = function() {
          clearTimeout(timer);
          try {
            var canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth || img.width;
            canvas.height = img.naturalHeight || img.height;
            if (!canvas.width || !canvas.height) { reject(new Error('Zero size image')); return; }
            var ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            var data = canvas.toDataURL('image/jpeg', 0.92);
            if (!data || data.length < 1000) { reject(new Error('Canvas empty â€” CORS blocked')); return; }
            resolve(data);
          } catch(canvasErr) {
            // CORS tainted canvas â€” fall back to using the URL directly as src
            resolve('__imgurl__' + url);
          }
        };
        img.onerror = function(e) {
          clearTimeout(timer);
          reject(new Error('Image failed to load'));
        };
        img.src = url;
      });
      return dataUrl;
    } catch(e) {
      if (attempt >= retries) throw e;
      await new Promise(function(r){ setTimeout(r, 2000 * (attempt + 1)); });
    }
  }
}

// Legacy compat
function _imgBuildUrl(promptText, w, h, seed, model) {
  var enc = encodeURIComponent(promptText);
  return 'https://image.pollinations.ai/prompt/' + enc +
    '?width=' + w + '&height=' + h + '&seed=' + seed + '&nologo=true&model=flux';
}

// Build URL for a given provider
function _imgUrlFor(provider, enc, promptText, w, h, seed) {
  if (provider === 'pollinations_flux') {
    return 'https://image.pollinations.ai/prompt/' + enc +
      '?width=' + w + '&height=' + h + '&seed=' + seed + '&nologo=true&model=flux&enhance=false';
  }
  if (provider === 'pollinations_turbo') {
    return 'https://image.pollinations.ai/prompt/' + enc +
      '?width=' + w + '&height=' + h + '&seed=' + (seed+777) + '&nologo=true&model=turbo';
  }
  if (provider === 'pollinations_sc') {
    // stable-diffusion-3.5 via pollinations
    return 'https://image.pollinations.ai/prompt/' + enc +
      '?width=' + w + '&height=' + h + '&seed=' + (seed+333) + '&nologo=true&model=stable-diffusion-3.5-large';
  }
  if (provider === 'together') {
    // Together AI â€” free tier, FLUX.1-schnell via direct URL pattern
    return 'https://api.together.xyz/v1/images/generations';
  }
  if (provider === 'fal_fast') {
    // fal.ai fast SDXL â€” no key for low-res
    return 'https://fal.run/fal-ai/fast-sdxl?prompt=' + enc + '&image_size=square_hd';
  }
  if (provider === 'prodia') {
    // Prodia â€” free, no key needed
    return 'https://api.prodia.com/generate?new=true&prompt=' + enc +
      '&model=sdv1_4.ckpt&sampler=DPM%2B%2B+2M+Karras&steps=20&cfg_scale=7&seed=' + seed +
      '&width=' + Math.min(w,1024) + '&height=' + Math.min(h,1024) + '&aspect_ratio=square';
  }
  if (provider === 'prodia_job') {
    return 'https://api.prodia.com/job';
  }
  return null;
}

// Prodia uses a 2-step job API
async function _imgGenProdia(promptText, w, h, seed) {
  var enc = encodeURIComponent(promptText);
  var jobResp = await fetch('https://api.prodia.com/generate?new=true&prompt=' + enc +
    '&model=sdv1_4.ckpt&sampler=DPM%2B%2B+2M+Karras&steps=20&cfg_scale=7&seed=' + seed +
    '&width=' + Math.min(w,512) + '&height=' + Math.min(h,512), { method: 'GET' });
  if (!jobResp.ok) throw new Error('Prodia job error ' + jobResp.status);
  var job = await jobResp.json();
  var jobId = job.job;
  if (!jobId) throw new Error('No Prodia job ID');
  // Poll until done (max 30s)
  for (var i = 0; i < 15; i++) {
    await new Promise(function(r){ setTimeout(r, 2000); });
    var statusResp = await fetch('https://api.prodia.com/job/' + jobId);
    var status = await statusResp.json();
    if (status.status === 'succeeded') {
      // Fetch the image
      return await _imgFetchAsDataURL('https://images.prodia.xyz/' + jobId + '.png', 1);
    }
    if (status.status === 'failed') throw new Error('Prodia generation failed');
  }
  throw new Error('Prodia timeout');
}

async function _imgFetchWithProviderFallback(promptText, w, h, seed, style) {
  var enc = encodeURIComponent(promptText);

  // Provider chain â€” try each in order, fall back to canvas on total failure
  var providers = [
    { id: 'pollinations_flux',  label: 'Flux (Pollinations)' },
    { id: 'pollinations_turbo', label: 'Turbo (Pollinations)' },
    { id: 'pollinations_sc',    label: 'SD 3.5 (Pollinations)' },
    { id: 'prodia',             label: 'Prodia' },
  ];

  // Check if a specific model is pinned by the user
  var pinnedModel = null;
  try { pinnedModel = localStorage.getItem('tv_img_model') || null; } catch(e) {}
  if (pinnedModel) {
    providers = providers.filter(function(p){ return p.id === pinnedModel; }).concat(
      providers.filter(function(p){ return p.id !== pinnedModel; })
    );
  }

  var lastErr = null;
  for (var pi = 0; pi < providers.length; pi++) {
    var prov = providers[pi];
    try {
      var url = _imgUrlFor(prov.id, enc, promptText, w, h, seed);
      if (!url) continue;
      if (prov.id === 'prodia') {
        var dataUrl2 = await _imgGenProdia(promptText, w, h, seed);
        return { dataUrl: dataUrl2, url: url, provider: prov.label };
      }
      var dataUrl = await _imgFetchAsDataURL(url, 1);
      return { dataUrl: dataUrl, url: url, provider: prov.label };
    } catch(e) {
      lastErr = e;
      console.warn('[TrendVid IMG] ' + prov.label + ' failed:', e.message, 'â€” trying nextâ€¦');
    }
  }

  // All network providers failed â€” fall back to canvas renderer
  console.warn('[TrendVid IMG] All providers failed, using canvas renderer. Last error:', lastErr && lastErr.message);
  var canvasDataUrl = _imgRenderCanvas(promptText, w, h, seed || Math.floor(Math.random()*99999999), style);
  return { dataUrl: canvasDataUrl, url: 'canvas-render', provider: 'Canvas Renderer' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UNIFIED CANVAS IMAGE ENGINE â€” keyword-driven scene renderer, zero network
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function _imgRenderCanvas(promptText, W, H, seed, style) {
  var c = document.createElement('canvas');
  c.width = W || 1280; c.height = H || 720;
  var ctx = c.getContext('2d');
  var rng = _vtvSeededRng(seed || Math.floor(Math.random()*99999999));
  var p = (promptText || '').toLowerCase();

  // â”€â”€ KEYWORD MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Each entry: [category, regex]  â€” first match wins for palette/scene
  var KW = {
    // Nature & landscape
    forest:    /forest|jungle|woods|woodland|canopy|rainforest|trees?|pine|oak|birch|cedar|bamboo/i,
    desert:    /desert|sand|dune|sahara|arid|cactus|drought|barren|wasteland/i,
    mountain:  /mountain|peak|summit|cliff|canyon|valley|alpine|glacier|volcano|eruption|rockslide/i,
    snow:      /snow|ice|winter|frost|frozen|blizzard|arctic|tundra|avalanche|iceberg|polar/i,
    rain:      /rain|storm|thunder|lightning|cloud|overcast|drizzle|flood|hurricane|typhoon|monsoon/i,
    nature:    /nature|outdoor|park|garden|field|meadow|grass|floral|flower|bloom|petal|botanical/i,
    ocean:     /ocean|sea|wave|beach|coast|shore|tide|coral|reef|marine|underwater|diving|surf|sail/i,
    river:     /river|stream|waterfall|lake|pond|creek|brook|dam|flood|rapids|spring/i,
    sunset:    /sunset|sunrise|dawn|dusk|twilight|horizon|golden\s*hour|glow/i,
    sky:       /sky|cloud|atmosphere|horizon|aerial|birds?\s*eye|overhead/i,

    // Space & cosmic
    space:     /space|galaxy|cosmos|universe|nebula|asteroid|comet|void|orbit|solar\s*system/i,
    planet:    /planet|mars|saturn|jupiter|venus|mercury|earth|moon|lunar|crater|alien|extraterrestrial/i,
    stars:     /star|constellation|milky\s*way|astronomy|telescope|quasar|pulsar|wormhole/i,
    night:     /night|dark|midnight|shadow|dusk|after\s*dark|nocturnal|blackout|dim/i,

    // Urban & architecture
    city:      /city|town|metropolis|downtown|skyline|skyscraper|urban|avenue|boulevard|district/i,
    street:    /street|road|highway|traffic|intersection|pedestrian|sidewalk|alley|lane|crossroad/i,
    building:  /building|tower|office|skyscraper|architecture|facade|apartment|complex|structure/i,
    bridge:    /bridge|overpass|viaduct|suspension\s*bridge|tunnel/i,
    interior:  /room|interior|inside|hallway|corridor|lobby|studio|office\s*space|bedroom|kitchen/i,
    suburb:    /suburb|neighborhood|residential|house|home|yard|garden|fence|driveway/i,
    market:    /market|mall|store|shop|bazaar|vendor|stall|commerce|retail/i,

    // People & social
    crowd:     /crowd|people|audience|group|mob|gathering|protest|rally|festival|concert|stadium/i,
    person:    /person|human|man|woman|child|kid|teenager|elderly|portrait|face|silhouette/i,
    team:      /team|colleague|meeting|boardroom|collaboration|workforce|staff|crew|squad/i,
    dance:     /dance|ballet|performance|stage|theater|show|spotlight|choreography/i,
    wedding:   /wedding|bride|groom|ceremony|celebration|party|anniversary|engagement/i,
    sport:     /sport|athlete|race|run|gym|fitness|workout|training|competition|trophy|medal/i,

    // Technology & digital
    tech:      /tech|software|hardware|device|gadget|computer|laptop|keyboard|monitor|circuit/i,
    ai:        /ai|artificial\s*intelligence|machine\s*learning|neural|algorithm|robot|automation|bot/i,
    data:      /data|database|analytics|chart|graph|statistics|metrics|dashboard|visualization/i,
    internet:  /internet|network|web|wifi|cloud\s*computing|server|broadband|streaming|online/i,
    phone:     /phone|smartphone|mobile|app|screen|swipe|notification|social\s*media|tiktok|instagram/i,
    vr:        /vr|virtual\s*reality|augmented|hologram|metaverse|3d|immersive|headset/i,
    cyber:     /cyber|hacker|code|programming|script|binary|matrix|firewall|encrypt|glitch/i,
    future:    /future|futuristic|sci.?fi|dystopia|utopia|2\d\d\d|nano|quantum|plasma/i,

    // Fire & energy
    fire:      /fire|flame|burn|blaze|inferno|combustion|spark|ember|smoke|ash|wildfire/i,
    explosion: /explosion|blast|boom|shockwave|detonation|impact|collision|crash/i,
    electric:  /electric|lightning|volt|spark|neon|glow|luminous|radiant|fluorescent/i,
    nuclear:   /nuclear|atomic|radiation|fallout|reactor|meltdown/i,

    // Money & business
    money:     /money|cash|dollar|currency|wealth|rich|luxury|profit|revenue|income|salary|finance/i,
    business:  /business|corporate|startup|entrepreneur|brand|logo|marketing|strategy|growth|deal/i,
    stock:     /stock|market|crypto|bitcoin|trading|investment|portfolio|bull|bear|chart|index/i,
    bank:      /bank|vault|safe|transaction|payment|economy|inflation|recession/i,

    // Food & drink
    food:      /food|meal|cuisine|restaurant|kitchen|cooking|chef|recipe|ingredient|feast|dine/i,
    coffee:    /coffee|cafe|espresso|latte|cappuccino|barista|beans|brew|tea|matcha/i,
    alcohol:   /wine|beer|cocktail|bar|pub|drinks?|alcohol|bottle|glass|toast/i,

    // Health & science
    health:    /health|medicine|hospital|doctor|nurse|patient|surgery|wellness|mental\s*health/i,
    science:   /science|lab|laboratory|experiment|research|microscope|chemical|element|formula/i,
    biology:   /biology|cell|dna|gene|virus|bacteria|evolution|organism|anatomy|body/i,
    brain:     /brain|mind|neuron|consciousness|psychology|mental|cognitive|memory|thought/i,

    // Art & creativity
    art:       /art|painting|canvas|gallery|museum|sculpture|portrait|sketch|design|aesthetic/i,
    music:     /music|song|beat|rhythm|melody|concert|guitar|piano|drum|orchestra|producer|studio/i,
    film:      /film|movie|cinema|director|camera|scene|set|actor|screenplay|hollywood|netflix/i,
    photo:     /photo|photograph|camera|lens|exposure|portrait|landscape|shoot|capture/i,
    abstract:  /abstract|surreal|psychedelic|dream|fantasy|imagine|concept|metaphor|symbol/i,

    // Motion & speed
    speed:     /speed|fast|racing|velocity|momentum|rush|sprint|chase|escape|flight|launch/i,
    travel:    /travel|journey|adventure|explore|map|compass|destination|trip|voyage|nomad/i,
    flight:    /fly|flight|airplane|airport|jet|rocket|spacecraft|drone|helicopter|pilot/i,

    // Emotions & themes
    fear:      /fear|horror|scary|dark|creepy|ghost|haunted|nightmare|terror|panic/i,
    love:      /love|romance|heart|passion|intimate|couple|kiss|affection|tender/i,
    hope:      /hope|inspire|dream|aspire|ambition|goal|vision|believe|faith|spirit/i,
    war:       /war|battle|military|soldier|weapon|conflict|army|combat|siege|victory/i,
    peace:     /peace|calm|serene|tranquil|quiet|still|harmony|balance|zen|meditate/i,

    // Materials & textures
    metal:     /metal|steel|iron|chrome|silver|gold|copper|rust|industrial|machinery/i,
    stone:     /stone|rock|marble|granite|concrete|brick|wall|ancient|ruin|monument/i,
    wood:      /wood|timber|log|wooden|rustic|cabin|vintage|antique/i,
    glass:     /glass|crystal|transparent|reflection|mirror|prism|refraction/i,

    // Misc vivid
    rainbow:   /rainbow|colorful|vibrant|spectrum|multicolor|prism|palette/i,
    vintage:   /vintage|retro|oldschool|nostalgic|80s|90s|vhs|polaroid|film\s*grain/i,
    horror:    /horror|gore|zombie|vampire|monster|demon|skull|death|grave|cemetery/i,
    royal:     /royal|king|queen|crown|throne|palace|castle|medieval|knight|empire/i,
    underwater:/underwater|deep\s*sea|submarine|ocean\s*floor|bioluminescent|mermaid/i,
    smoke:     /smoke|fog|mist|haze|vapor|steam|cloud\s*of/i,
  };

  // â”€â”€ PALETTE MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var PALETTES = {
    forest:    {a:'#071200',b:'#0f2900',c:'#2d7a00',d:'#66cc00',e:'#aaff44'},
    desert:    {a:'#1a0e00',b:'#4d2800',c:'#cc7700',d:'#ffaa33',e:'#ffe599'},
    mountain:  {a:'#0a0a12',b:'#1a1a2e',c:'#5566aa',d:'#99aacc',e:'#ddeeff'},
    snow:      {a:'#050810',b:'#0a1428',c:'#4488cc',d:'#aaccff',e:'#eef5ff'},
    rain:      {a:'#030810',b:'#0a1a2e',c:'#224488',d:'#4477bb',e:'#88aadd'},
    nature:    {a:'#071200',b:'#0f2200',c:'#2d7a00',d:'#55bb00',e:'#99ee44'},
    ocean:     {a:'#001226',b:'#003366',c:'#0088cc',d:'#00ccff',e:'#66eeff'},
    river:     {a:'#001a14',b:'#003322',c:'#007755',d:'#00bb88',e:'#55ddcc'},
    sunset:    {a:'#0f0300',b:'#330d00',c:'#cc4400',d:'#ff7700',e:'#ffcc44'},
    sky:       {a:'#040814',b:'#082040',c:'#1155aa',d:'#3388dd',e:'#88ccff'},
    space:     {a:'#000008',b:'#080020',c:'#4400cc',d:'#aa00ff',e:'#ff44ff'},
    planet:    {a:'#030010',b:'#0a0030',c:'#5500bb',d:'#9944ff',e:'#cc88ff'},
    stars:     {a:'#000005',b:'#050010',c:'#330066',d:'#6600cc',e:'#cc00ff'},
    night:     {a:'#010108',b:'#05051a',c:'#222255',d:'#4444aa',e:'#8888dd'},
    city:      {a:'#080818',b:'#1a0033',c:'#cc0066',d:'#ff3399',e:'#ff9900'},
    street:    {a:'#0a0808',b:'#1a1010',c:'#883300',d:'#cc5500',e:'#ffaa44'},
    building:  {a:'#080810',b:'#101020',c:'#334488',d:'#5566bb',e:'#99aadd'},
    bridge:    {a:'#050510',b:'#0f0f20',c:'#334466',d:'#6677aa',e:'#aabbcc'},
    interior:  {a:'#100800',b:'#261500',c:'#8b5e1a',d:'#cc9944',e:'#ffddaa'},
    suburb:    {a:'#050a00',b:'#0f1a00',c:'#336600',d:'#669933',e:'#aacc66'},
    market:    {a:'#0f0500',b:'#261000',c:'#883300',d:'#cc6600',e:'#ffbb44'},
    crowd:     {a:'#050010',b:'#15002a',c:'#660099',d:'#aa33cc',e:'#ff66ee'},
    person:    {a:'#080408',b:'#1a0a18',c:'#882266',d:'#cc44aa',e:'#ff88dd'},
    team:      {a:'#000a14',b:'#001a28',c:'#005599',d:'#0088cc',e:'#44bbff'},
    dance:     {a:'#080010',b:'#180022',c:'#770099',d:'#cc00ff',e:'#ff66ff'},
    wedding:   {a:'#0a0508',b:'#1f0f1a',c:'#993366',d:'#cc66aa',e:'#ffddee'},
    sport:     {a:'#0a0400',b:'#221000',c:'#993300',d:'#cc5500',e:'#ff8844'},
    tech:      {a:'#000d1a',b:'#001a33',c:'#0055aa',d:'#00aaff',e:'#00ffcc'},
    ai:        {a:'#000d14',b:'#001f2e',c:'#005577',d:'#00aacc',e:'#00ffee'},
    data:      {a:'#000814',b:'#001428',c:'#003388',d:'#0055cc',e:'#4499ff'},
    internet:  {a:'#000a10',b:'#001a20',c:'#004466',d:'#0077aa',e:'#00ccee'},
    phone:     {a:'#050810',b:'#0a1420',c:'#224477',d:'#4488bb',e:'#88ccff'},
    vr:        {a:'#050010',b:'#100028',c:'#5500aa',d:'#aa44ff',e:'#ee99ff'},
    cyber:     {a:'#000d08',b:'#001a10',c:'#00661a',d:'#00cc44',e:'#44ff88'},
    future:    {a:'#000814',b:'#001028',c:'#002266',d:'#0044cc',e:'#3399ff'},
    fire:      {a:'#220800',b:'#661100',c:'#ff5500',d:'#ffcc00',e:'#ff2200'},
    explosion: {a:'#1a0800',b:'#552200',c:'#cc6600',d:'#ffaa00',e:'#ff5500'},
    electric:  {a:'#000814',b:'#001428',c:'#0033aa',d:'#3366ff',e:'#88aaff'},
    nuclear:   {a:'#050a00',b:'#0a1400',c:'#336600',d:'#66cc00',e:'#aaff00'},
    money:     {a:'#0a0a00',b:'#1a1a00',c:'#666600',d:'#cccc00',e:'#ffff44'},
    business:  {a:'#080810',b:'#101020',c:'#334466',d:'#6688aa',e:'#aaccdd'},
    stock:     {a:'#000a08',b:'#001a14',c:'#005533',d:'#00aa66',e:'#44ffaa'},
    bank:      {a:'#080a08',b:'#141a10',c:'#445533',d:'#778855',e:'#aabb88'},
    food:      {a:'#0f0500',b:'#261000',c:'#993300',d:'#dd6600',e:'#ffaa55'},
    coffee:    {a:'#0a0500',b:'#1f0f00',c:'#5c3300',d:'#aa6600',e:'#ddaa55'},
    alcohol:   {a:'#080010',b:'#18002a',c:'#660055',d:'#aa0088',e:'#ee44bb'},
    health:    {a:'#001410',b:'#00261e',c:'#008855',d:'#00cc88',e:'#55ffcc'},
    science:   {a:'#000814',b:'#001428',c:'#002288',d:'#0055cc',e:'#44aaff'},
    biology:   {a:'#001408',b:'#002814',c:'#007733',d:'#00cc66',e:'#55ffaa'},
    brain:     {a:'#0a0014',b:'#18002e',c:'#660088',d:'#bb44cc',e:'#ff88ff'},
    art:       {a:'#0a0808',b:'#200f0a',c:'#882244',d:'#cc5566',e:'#ff99aa'},
    music:     {a:'#080010',b:'#150022',c:'#660099',d:'#9933cc',e:'#dd77ff'},
    film:      {a:'#050505',b:'#100f10',c:'#443344',d:'#886688',e:'#ccaacc'},
    photo:     {a:'#050505',b:'#0f0f10',c:'#334455',d:'#667788',e:'#aabbcc'},
    abstract:  {a:'#050010',b:'#100028',c:'#5500bb',d:'#aa44ff',e:'#ff88ff'},
    speed:     {a:'#0a0000',b:'#1f0000',c:'#880000',d:'#cc2200',e:'#ff6644'},
    travel:    {a:'#050810',b:'#0a1428',c:'#1155aa',d:'#3388dd',e:'#88ccff'},
    flight:    {a:'#030810',b:'#081828',c:'#0a3366',d:'#1166cc',e:'#55aaff'},
    fear:      {a:'#030305',b:'#080810',c:'#221133',d:'#440066',e:'#882299'},
    love:      {a:'#0f0008',b:'#280018',c:'#880044',d:'#cc2266',e:'#ff66aa'},
    hope:      {a:'#050810',b:'#0a1828',c:'#1a5588',d:'#3399cc',e:'#88ddff'},
    war:       {a:'#0a0500',b:'#1f0f00',c:'#663300',d:'#aa5500',e:'#cc8844'},
    peace:     {a:'#050a0a',b:'#0f1e1e',c:'#1a6666',d:'#33aaaa',e:'#77dddd'},
    metal:     {a:'#080808',b:'#141414',c:'#445566',d:'#778899',e:'#aabbcc'},
    stone:     {a:'#080808',b:'#161410',c:'#443c2e',d:'#887766',e:'#bbaa99'},
    wood:      {a:'#0a0500',b:'#1f0f00',c:'#5c3300',d:'#996633',e:'#ccaa77'},
    glass:     {a:'#050810',b:'#0a1428',c:'#224466',d:'#4488aa',e:'#aaddee'},
    rainbow:   {a:'#050505',b:'#0f0f10',c:'#663399',d:'#ff3366',e:'#ffdd00'},
    vintage:   {a:'#0f0a05',b:'#1f180a',c:'#664400',d:'#aa8833',e:'#ddbb77'},
    horror:    {a:'#030305',b:'#08080f',c:'#330011',d:'#660022',e:'#cc0033'},
    royal:     {a:'#050010',b:'#100028',c:'#330077',d:'#6600cc',e:'#cc99ff'},
    underwater:{a:'#001420',b:'#002a40',c:'#006688',d:'#00aacc',e:'#44ddee'},
    smoke:     {a:'#080808',b:'#141414',c:'#3a3a4a',d:'#6a6a7a',e:'#aaaacc'},
  };

  // â”€â”€ SCENE DRAW MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Each scene drawer fn(ctx, W, H, rng, palette)
  var SCENES = {
    forest:    _scForest,
    nature:    _scForest,
    desert:    _scDesert,
    mountain:  _scMountain,
    snow:      _scSnow,
    rain:      _scRain,
    ocean:     _scOcean,
    river:     _scOcean,
    underwater:_scUnderwater,
    sunset:    _scSunset,
    sky:       _scSky,
    space:     _scSpace,
    planet:    _scSpace,
    stars:     _scStars,
    night:     _scStars,
    city:      _scCity,
    street:    _scCity,
    building:  _scCity,
    crowd:     _scCrowd,
    fire:      _scFire,
    explosion: _scFire,
    electric:  _scElectric,
    tech:      _scTech,
    ai:        _scTech,
    data:      _scTech,
    internet:  _scTech,
    cyber:     _scCyber,
    future:    _scTech,
    vr:        _scAbstract,
    money:     _scMoney,
    stock:     _scStock,
    music:     _scMusic,
    abstract:  _scAbstract,
    rainbow:   _scRainbow,
    horror:    _scHorror,
    royal:     _scRoyal,
    snow2:     _scSnow,
    vintage:   _scVintage,
    smoke:     _scSmoke,
    mountain2: _scMountain,
    war:       _scFire,
    peace:     _scForest,
    love:      _scAbstract,
    hope:      _scSky,
    brain:     _scAbstract,
    art:       _scAbstract,
    flight:    _scFlight,
    speed:     _scSpeed,
    wedding:   _scAbstract,
    dance:     _scMusic,
    film:      _scFilm,
    glass:     _scGlass,
    metal:     _scMetal,
    stone:     _scMetal,
  };

  // â”€â”€ DETECT WHICH CATEGORY MATCHES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var matchedCat = null;
  var matchedWords = [];
  var allWords = p.match(/[a-z]+/g) || [];

  // Priority order for scene detection
  var priority = [
    'fire','explosion','horror','space','planet','stars','underwater','ocean','river',
    'desert','mountain','snow','rain','forest','nature','sunset','sky','night',
    'city','street','building','crowd','cyber','electric','nuclear',
    'tech','ai','data','internet','phone','vr','future',
    'money','stock','bank','business',
    'music','dance','film','art','abstract','rainbow','vintage',
    'food','coffee','alcohol','health','science','biology','brain',
    'sport','wedding','love','fear','hope','war','peace',
    'metal','stone','wood','glass','smoke','speed','flight','travel',
    'person','team','bridge','interior','suburb','market',
    'royal','electric','building',
  ];

  for (var pi = 0; pi < priority.length; pi++) {
    var cat = priority[pi];
    if (KW[cat] && KW[cat].test(p)) {
      matchedCat = cat;
      break;
    }
  }

  // â”€â”€ UNKNOWN WORD FALLBACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // If no keyword matched, extract the most distinctive word from the prompt
  // and use it as a seed for a unique abstract scene + palette
  var unknownWord = null;
  if (!matchedCat) {
    // Filter out common stop words
    var stopWords = new Set(['a','an','the','in','on','at','of','to','for','and','or',
      'but','with','from','into','by','as','is','are','was','were','be','been','being',
      'have','has','had','do','does','did','will','would','could','should','may','might',
      'cinematic','wide','shot','dramatic','lighting','high','detail','ultra','realistic',
      'view','style','type','show','make','create','generate','image','photo','picture',
      'background','scene','concept','idea','about','this','that','very','just','its',
      'also','more','some','any','all','each','most','than','then','when','where','how',
      'what','who','which','there','here','now','time','long','great','good','new','old']);
    var candidates = allWords.filter(function(w){ return w.length > 4 && !stopWords.has(w); });
    if (candidates.length > 0) {
      // Pick the longest / most unusual word
      candidates.sort(function(a,b){ return b.length - a.length; });
      unknownWord = candidates[0];
    }
    // Use a hash of the unknown word to pick a "personality"
    var wordHash = 0;
    (unknownWord || p || 'default').split('').forEach(function(ch){ wordHash = (wordHash*31 + ch.charCodeAt(0)) & 0xfffffff; });
    var abstractStyles = ['abstract','rainbow','glass','electric','royal','vr','brain','music','art','love','hope','film','glass','metal'];
    matchedCat = abstractStyles[wordHash % abstractStyles.length];
  }

  // Style overrides
  if (style === 'cyberpunk')    matchedCat = 'cyber';
  if (style === 'watercolor')   matchedCat = matchedCat || 'nature';
  if (style === 'cartoon')      matchedCat = 'rainbow';
  if (style === 'oil-painting') matchedCat = matchedCat || 'sunset';
  if (style === 'photorealistic') {} // keep matched

  var palette = PALETTES[matchedCat] || PALETTES['abstract'];

  // â”€â”€ BACKGROUND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var bg = ctx.createRadialGradient(W*0.35,H*0.3,0, W*0.5,H*0.55, W*0.92);
  bg.addColorStop(0, palette.b);
  bg.addColorStop(0.55, palette.a);
  bg.addColorStop(1, '#000000');
  ctx.fillStyle = bg; ctx.fillRect(0,0,W,H);

  // Atmospheric glow
  var atm = ctx.createRadialGradient(W*0.62,H*0.38,0, W*0.62,H*0.38, W*0.52);
  atm.addColorStop(0, palette.c+'28'); atm.addColorStop(1,'transparent');
  ctx.fillStyle = atm; ctx.fillRect(0,0,W,H);

  // â”€â”€ DRAW SCENE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var drawFn = SCENES[matchedCat];
  if (drawFn) drawFn(ctx, W, H, rng, palette);

  // â”€â”€ PARTICLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  for (var pt=0;pt<45;pt++){
    ctx.globalAlpha=rng()*0.28+0.04;
    ctx.fillStyle=[palette.c,palette.d,palette.e][Math.floor(rng()*3)];
    ctx.beginPath(); ctx.arc(rng()*W,rng()*H,rng()*3+0.4,0,Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha=1;

  // â”€â”€ LIGHT RAYS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  for (var lr=0;lr<5;lr++){
    var lx=W*(0.12+lr*0.19);
    var rg2=ctx.createLinearGradient(lx,0,lx+90,H);
    rg2.addColorStop(0,palette.c+'14'); rg2.addColorStop(1,'transparent');
    ctx.fillStyle=rg2; ctx.save();
    ctx.translate(lx,0); ctx.rotate((lr-2)*0.065);
    ctx.fillRect(0,0,55,H); ctx.restore();
  }

  // â”€â”€ VIGNETTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var vig=ctx.createRadialGradient(W/2,H/2,H*0.18,W/2,H/2,W*0.82);
  vig.addColorStop(0,'transparent'); vig.addColorStop(1,'rgba(0,0,0,0.72)');
  ctx.fillStyle=vig; ctx.fillRect(0,0,W,H);

  // â”€â”€ LABEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var label = unknownWord
    ? '"' + unknownWord + '" â€” ' + matchedCat
    : matchedCat;
  ctx.save();
  ctx.font='700 13px DM Sans,sans-serif';
  ctx.fillStyle=palette.d; ctx.globalAlpha=0.4;
  ctx.textAlign='right';
  ctx.fillText(label.substring(0,60), W-18, H-18);
  ctx.restore();

  return c.toDataURL('image/jpeg', 0.88);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCENE ELEMENT FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function _scForest(ctx,W,H,rng,pal){
  // Ground
  var gr=ctx.createLinearGradient(0,H*0.58,0,H);
  gr.addColorStop(0,'#1a4400');gr.addColorStop(1,'#06100a');
  ctx.fillStyle=gr;ctx.fillRect(0,H*0.58,W,H*0.42);
  // Trees
  for(var t=0;t<11;t++){
    var tx=(t/10)*W*0.95+W*0.025+rng()*18-9;
    var th=110+rng()*130,ty=H*0.58-th;
    ctx.fillStyle='#0a1800';ctx.fillRect(tx-7,ty+th*0.5,14,th*0.5);
    [pal.a,pal.b,pal.c].forEach(function(col,ci){
      ctx.fillStyle=col; ctx.globalAlpha=0.9-ci*0.1;
      ctx.beginPath();ctx.arc(tx,ty+th*(0.32-ci*0.04),th*(0.4-ci*0.04),0,Math.PI*2);ctx.fill();
    });
  }
  ctx.globalAlpha=1;
  // Sun rays through canopy
  var sg=ctx.createRadialGradient(W*0.5,H*0.1,0,W*0.5,H*0.1,W*0.6);
  sg.addColorStop(0,pal.d+'22');sg.addColorStop(1,'transparent');
  ctx.fillStyle=sg;ctx.fillRect(0,0,W,H);
}

function _scDesert(ctx,W,H,rng,pal){
  // Sky gradient
  var sky=ctx.createLinearGradient(0,0,0,H*0.55);
  sky.addColorStop(0,'#1a0800');sky.addColorStop(1,pal.c+'88');
  ctx.fillStyle=sky;ctx.fillRect(0,0,W,H*0.55);
  // Sand dunes
  ctx.fillStyle=pal.b;
  ctx.beginPath();ctx.moveTo(0,H*0.55);
  for(var d=0;d<=W;d+=60) ctx.quadraticCurveTo(d+30,H*(0.42+rng()*0.18),d+60,H*(0.5+rng()*0.1));
  ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();ctx.fill();
  ctx.fillStyle=pal.c+'44';
  ctx.beginPath();ctx.moveTo(0,H*0.68);
  for(var d2=0;d2<=W;d2+=80) ctx.quadraticCurveTo(d2+40,H*(0.6+rng()*0.12),d2+80,H*(0.65+rng()*0.08));
  ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();ctx.fill();
  // Heat shimmer lines
  ctx.strokeStyle=pal.d+'30';ctx.lineWidth=1;
  for(var s=0;s<5;s++){var sy=H*(0.55+s*0.04);ctx.beginPath();ctx.moveTo(0,sy);ctx.lineTo(W,sy);ctx.stroke();}
  // Sun
  var sg2=ctx.createRadialGradient(W*0.78,H*0.12,0,W*0.78,H*0.12,70);
  sg2.addColorStop(0,pal.e);sg2.addColorStop(0.5,pal.d+'88');sg2.addColorStop(1,'transparent');
  ctx.fillStyle=sg2;ctx.fillRect(0,0,W,H);
}

function _scMountain(ctx,W,H,rng,pal){
  // Sky
  var sky=ctx.createLinearGradient(0,0,0,H*0.6);
  sky.addColorStop(0,pal.a);sky.addColorStop(1,pal.b);
  ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);
  // Back range
  ctx.fillStyle=pal.b+'cc';
  ctx.beginPath();ctx.moveTo(0,H*0.6);
  var pts2=[0.1,0.25,0.18,0.35,0.15,0.45,0.22,0.32,0.28,0.42,0.35,0.2,0.42,0.38,0.5,0.12,0.58,0.3,0.65,0.45,0.72,0.22,0.8,0.4,0.88,0.28,0.95,0.5,1.0,0.6];
  for(var m=0;m<pts2.length;m+=2) ctx.lineTo(pts2[m]*W,pts2[m+1]*H);
  ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();ctx.fill();
  // Front peaks
  ctx.fillStyle=pal.a;
  ctx.beginPath();ctx.moveTo(0,H*0.75);
  var fp=[0.05,0.7,0.12,0.5,0.2,0.68,0.28,0.4,0.38,0.62,0.48,0.3,0.58,0.55,0.68,0.35,0.78,0.58,0.88,0.42,0.96,0.65,1,0.75];
  for(var fi=0;fi<fp.length;fi+=2) ctx.lineTo(fp[fi]*W,fp[fi+1]*H);
  ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();ctx.fill();
  // Snow caps
  ctx.fillStyle='rgba(220,235,255,0.7)';
  [[0.28,0.4,0.05],[0.48,0.3,0.04],[0.68,0.35,0.035],[0.88,0.42,0.03]].forEach(function(peak){
    ctx.beginPath();
    ctx.moveTo(peak[0]*W,peak[1]*H);
    ctx.lineTo((peak[0]-peak[2])*W,(peak[1]+peak[2]*1.5)*H);
    ctx.lineTo((peak[0]+peak[2])*W,(peak[1]+peak[2]*1.5)*H);
    ctx.closePath();ctx.fill();
  });
}

function _scSnow(ctx,W,H,rng,pal){
  // Ground
  var sg3=ctx.createLinearGradient(0,H*0.6,0,H);
  sg3.addColorStop(0,'#c8ddf0');sg3.addColorStop(1,'#8aadcc');
  ctx.fillStyle=sg3;ctx.fillRect(0,H*0.6,W,H*0.4);
  // Snow particles
  for(var s2=0;s2<200;s2++){
    ctx.globalAlpha=rng()*0.7+0.2;
    ctx.fillStyle='#ffffff';
    ctx.beginPath();ctx.arc(rng()*W,rng()*H,rng()*2.5+0.3,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;
  // Ice crystals
  for(var ic=0;ic<8;ic++){
    var ix=rng()*W,iy=H*0.1+rng()*H*0.5,il=20+rng()*40;
    ctx.strokeStyle=pal.e+'88';ctx.lineWidth=1.5;
    for(var ia=0;ia<6;ia++){
      var angle=ia*Math.PI/3;
      ctx.beginPath();ctx.moveTo(ix,iy);
      ctx.lineTo(ix+Math.cos(angle)*il,iy+Math.sin(angle)*il);ctx.stroke();
    }
  }
}

function _scRain(ctx,W,H,rng,pal){
  // Rain streaks
  ctx.strokeStyle=pal.c+'55';ctx.lineWidth=1;
  for(var r=0;r<150;r++){
    var rx=rng()*W*1.3-W*0.15,ry=rng()*H;
    ctx.beginPath();ctx.moveTo(rx,ry);ctx.lineTo(rx-8,ry+25);ctx.stroke();
  }
  // Lightning
  if(rng()>0.5){
    ctx.strokeStyle=pal.e+'cc';ctx.lineWidth=2.5;
    ctx.beginPath();
    var lx2=W*(0.3+rng()*0.4),ly=0;
    ctx.moveTo(lx2,ly);
    for(var ls=0;ls<8;ls++){lx2+=rng()*40-20;ly+=H/8;ctx.lineTo(lx2,ly);}
    ctx.stroke();
    ctx.strokeStyle='#ffffff44';ctx.lineWidth=6;ctx.stroke();
  }
  // Puddle reflections
  ctx.fillStyle=pal.c+'22';
  for(var p2=0;p2<6;p2++) ctx.fillRect(rng()*W,H*0.7+rng()*H*0.25,40+rng()*120,4);
}

function _scOcean(ctx,W,H,rng,pal){
  // Ocean gradient
  var og=ctx.createLinearGradient(0,H*0.35,0,H);
  og.addColorStop(0,pal.c+'99');og.addColorStop(0.4,pal.b);og.addColorStop(1,'#000b1a');
  ctx.fillStyle=og;ctx.fillRect(0,H*0.35,W,H*0.65);
  // Horizon glow
  var hg=ctx.createRadialGradient(W*0.5,H*0.38,0,W*0.5,H*0.38,W*0.4);
  hg.addColorStop(0,pal.d+'44');hg.addColorStop(1,'transparent');
  ctx.fillStyle=hg;ctx.fillRect(0,0,W,H);
  // Waves
  ctx.lineWidth=2;
  for(var w=0;w<9;w++){
    var wy=H*(0.4+w*0.065);
    ctx.strokeStyle=pal.e+(w<4?'44':'22');
    ctx.beginPath();ctx.moveTo(0,wy);
    for(var wx=0;wx<W;wx+=45) ctx.quadraticCurveTo(wx+22,wy-7+rng()*9,wx+45,wy+rng()*4-2);
    ctx.stroke();
  }
}

function _scUnderwater(ctx,W,H,rng,pal){
  // Depth gradient
  var dg=ctx.createLinearGradient(0,0,0,H);
  dg.addColorStop(0,pal.c+'88');dg.addColorStop(1,pal.a);
  ctx.fillStyle=dg;ctx.fillRect(0,0,W,H);
  // Light shafts from surface
  for(var sh=0;sh<6;sh++){
    var shg=ctx.createLinearGradient(W*(0.1+sh*0.15),0,W*(0.1+sh*0.15)+40,H);
    shg.addColorStop(0,pal.d+'33');shg.addColorStop(1,'transparent');
    ctx.fillStyle=shg;ctx.save();
    ctx.translate(W*(0.1+sh*0.15),0);ctx.rotate((sh-2.5)*0.05);
    ctx.fillRect(0,0,35,H);ctx.restore();
  }
  // Bubbles
  for(var b3=0;b3<40;b3++){
    var br=rng()*8+2;
    ctx.strokeStyle=pal.e+'55';ctx.lineWidth=1;ctx.globalAlpha=0.6;
    ctx.beginPath();ctx.arc(rng()*W,rng()*H,br,0,Math.PI*2);ctx.stroke();
  }
  ctx.globalAlpha=1;
  // Coral shapes
  ctx.fillStyle=pal.c+'88';
  for(var co=0;co<5;co++){
    var cx2=rng()*W,cy2=H*0.75;
    for(var cb=0;cb<5;cb++){
      ctx.beginPath();ctx.ellipse(cx2+(rng()-0.5)*30,cy2-rng()*60,5+rng()*10,20+rng()*30,rng()*0.5-0.25,0,Math.PI*2);ctx.fill();
    }
  }
}

function _scSunset(ctx,W,H,rng,pal){
  // Sky bands
  var bands=[
    [0,'#0a0520'],[0.15,pal.a],[0.35,pal.b],[0.55,pal.c],[0.7,pal.d],[0.82,pal.e],[1,pal.d]
  ];
  var sk=ctx.createLinearGradient(0,0,0,H*0.7);
  bands.forEach(function(b4){sk.addColorStop(b4[0],b4[1]);});
  ctx.fillStyle=sk;ctx.fillRect(0,0,W,H*0.7);
  // Horizon line
  ctx.fillStyle='#000';ctx.fillRect(0,H*0.68,W,H*0.32);
  // Sun disc
  var sd=ctx.createRadialGradient(W*0.5,H*0.68,0,W*0.5,H*0.68,80);
  sd.addColorStop(0,'#ffffff');sd.addColorStop(0.3,pal.e);sd.addColorStop(0.7,pal.d+'88');sd.addColorStop(1,'transparent');
  ctx.fillStyle=sd;ctx.fillRect(0,0,W,H);
  // Clouds
  ctx.fillStyle=pal.c+'44';
  for(var cl=0;cl<6;cl++){
    var cx3=rng()*W,cy3=H*(0.2+rng()*0.35),cr=60+rng()*100;
    ctx.beginPath();ctx.ellipse(cx3,cy3,cr,cr*0.35,0,0,Math.PI*2);ctx.fill();
  }
  // Reflection
  ctx.fillStyle=pal.d+'22';ctx.fillRect(W*0.3,H*0.68,W*0.4,H*0.32);
}

function _scSky(ctx,W,H,rng,pal){
  var sk2=ctx.createLinearGradient(0,0,0,H);
  sk2.addColorStop(0,pal.a);sk2.addColorStop(0.5,pal.b);sk2.addColorStop(1,pal.c+'88');
  ctx.fillStyle=sk2;ctx.fillRect(0,0,W,H);
  // Clouds
  for(var c2=0;c2<8;c2++){
    var ccx=rng()*W*1.1-W*0.05,ccy=H*(0.1+rng()*0.5);
    var cw=80+rng()*200,ch2=20+rng()*50;
    ctx.fillStyle='rgba(255,255,255,0.12)';
    ctx.beginPath();ctx.ellipse(ccx,ccy,cw,ch2,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.07)';
    ctx.beginPath();ctx.ellipse(ccx+30,ccy-15,cw*0.7,ch2*0.7,0,0,Math.PI*2);ctx.fill();
  }
  // Birds
  ctx.strokeStyle=pal.c+'88';ctx.lineWidth=2;
  for(var bi=0;bi<7;bi++){
    var bx=rng()*W,by=H*(0.1+rng()*0.4);
    ctx.beginPath();ctx.moveTo(bx-10,by);ctx.quadraticCurveTo(bx,by-6,bx+10,by);ctx.stroke();
  }
}

function _scSpace(ctx,W,H,rng,pal){
  // Stars
  for(var s3=0;s3<280;s3++){
    ctx.globalAlpha=rng()*0.9+0.1;ctx.fillStyle='#fff';
    ctx.beginPath();ctx.arc(rng()*W,rng()*H,rng()*2+0.2,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;
  // Nebula
  for(var nb=0;nb<7;nb++){
    var ng2=ctx.createRadialGradient(rng()*W,rng()*H*0.8,0,rng()*W,rng()*H*0.8,100+rng()*200);
    ng2.addColorStop(0,pal.d+'33');ng2.addColorStop(1,'transparent');
    ctx.fillStyle=ng2;ctx.fillRect(0,0,W,H);
  }
  // Planet
  var pr2=50+rng()*50,px2=W*(0.65+rng()*0.2),py2=H*(0.15+rng()*0.2);
  var pg2=ctx.createRadialGradient(px2-pr2*0.3,py2-pr2*0.3,pr2*0.05,px2,py2,pr2);
  pg2.addColorStop(0,pal.e);pg2.addColorStop(0.5,pal.d);pg2.addColorStop(1,pal.b);
  ctx.fillStyle=pg2;ctx.globalAlpha=0.9;
  ctx.beginPath();ctx.arc(px2,py2,pr2,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;
  // Rings
  ctx.strokeStyle=pal.c+'66';ctx.lineWidth=3;
  ctx.beginPath();ctx.ellipse(px2,py2,pr2*1.8,pr2*0.4,0.3,0,Math.PI*2);ctx.stroke();
}

function _scStars(ctx,W,H,rng,pal){
  // Dense starfield
  for(var s4=0;s4<350;s4++){
    var ss=rng()*2.2+0.2;
    ctx.globalAlpha=rng()*0.9+0.1;
    ctx.fillStyle=ss>1.5?pal.e:'#ffffff';
    ctx.beginPath();ctx.arc(rng()*W,rng()*H,ss,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;
  // Milky way streak
  var mw=ctx.createLinearGradient(0,H*0.2,W,H*0.8);
  mw.addColorStop(0,'transparent');mw.addColorStop(0.4,pal.c+'18');mw.addColorStop(0.6,pal.d+'22');mw.addColorStop(1,'transparent');
  ctx.fillStyle=mw;ctx.fillRect(0,0,W,H);
  // Shooting star
  ctx.strokeStyle='#ffffff99';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.moveTo(W*0.2,H*0.1);ctx.lineTo(W*0.45,H*0.35);ctx.stroke();
}

function _scCity(ctx,W,H,rng,pal){
  // Sky glow
  var cg=ctx.createRadialGradient(W*0.5,H*0.5,0,W*0.5,H*0.5,W*0.7);
  cg.addColorStop(0,pal.c+'22');cg.addColorStop(1,'transparent');
  ctx.fillStyle=cg;ctx.fillRect(0,0,W,H);
  // Buildings
  for(var b5=0;b5<26;b5++){
    var bx2=(b5/25)*W-15+rng()*20;
    var bw=25+rng()*55,bh=70+rng()*300;
    // Building body
    var bg2=ctx.createLinearGradient(bx2,H-bh,bx2,H);
    bg2.addColorStop(0,pal.b+'ee');bg2.addColorStop(1,'rgba(0,0,0,0.9)');
    ctx.fillStyle=bg2;ctx.fillRect(bx2,H-bh,bw,bh);
    // Windows
    for(var wr=0;wr<Math.floor(bh/18);wr++){
      for(var wc=0;wc<Math.floor(bw/12);wc++){
        if(rng()>0.35){
          ctx.globalAlpha=rng()*0.7+0.1;
          ctx.fillStyle=rng()>0.7?pal.e:pal.d;
          ctx.fillRect(bx2+wc*12+3,H-bh+wr*18+4,4,6);
        }
      }
    }
    ctx.globalAlpha=1;
  }
  // Street lights
  for(var sl=0;sl<8;sl++){
    var slx=rng()*W;
    ctx.strokeStyle=pal.d+'66';ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(slx,H);ctx.lineTo(slx,H*0.6);ctx.stroke();
    var slg=ctx.createRadialGradient(slx,H*0.6,0,slx,H*0.6,40);
    slg.addColorStop(0,pal.e+'55');slg.addColorStop(1,'transparent');
    ctx.fillStyle=slg;ctx.fillRect(0,0,W,H);
  }
}

function _scCrowd(ctx,W,H,rng,pal){
  // Stage lights from above
  for(var sl2=0;sl2<5;sl2++){
    var slg2=ctx.createRadialGradient(W*(0.1+sl2*0.2),0,0,W*(0.1+sl2*0.2),H*0.8,W*0.2);
    slg2.addColorStop(0,[pal.c,pal.d,pal.e,pal.d,pal.c][sl2]+'44');slg2.addColorStop(1,'transparent');
    ctx.fillStyle=slg2;ctx.fillRect(0,0,W,H);
  }
  // Silhouettes
  var colors=['#111','#181818','#0f0f0f'];
  for(var cr=0;cr<4;cr++){
    for(var cc=0;cc<Math.floor(W/22);cc++){
      var ph=40+rng()*60,px3=cc*22+rng()*8,py3=H*(0.55+cr*0.12)-ph;
      ctx.fillStyle=colors[Math.floor(rng()*3)];
      // Head
      ctx.beginPath();ctx.arc(px3,py3,8+rng()*4,0,Math.PI*2);ctx.fill();
      // Body
      ctx.fillRect(px3-6,py3,12,ph);
    }
  }
  // Raised hands / glow sticks
  ctx.fillStyle=pal.d+'88';
  for(var rh=0;rh<30;rh++){
    ctx.globalAlpha=0.5+rng()*0.4;
    ctx.fillRect(rng()*W,H*(0.35+rng()*0.25),3,15+rng()*20);
  }
  ctx.globalAlpha=1;
}

function _scFire(ctx,W,H,rng,pal){
  // Embers on ground
  var eg=ctx.createLinearGradient(0,H*0.7,0,H);
  eg.addColorStop(0,pal.b);eg.addColorStop(1,'#000');
  ctx.fillStyle=eg;ctx.fillRect(0,H*0.7,W,H*0.3);
  // Flames
  for(var f=0;f<35;f++){
    var fx=W*(0.05+rng()*0.9),fh=80+rng()*300;
    var fg=ctx.createLinearGradient(fx,H,fx,H-fh);
    fg.addColorStop(0,pal.c+'bb');fg.addColorStop(0.4,pal.d+'77');fg.addColorStop(0.7,pal.e+'44');fg.addColorStop(1,'transparent');
    ctx.fillStyle=fg;ctx.globalAlpha=0.5+rng()*0.45;
    var fw=15+rng()*35;
    ctx.beginPath();ctx.ellipse(fx,H-fh*0.4,fw,fh*0.55,rng()*0.4-0.2,0,Math.PI*2);ctx.fill();
  }
  // Embers floating
  ctx.fillStyle=pal.e;
  for(var em=0;em<50;em++){
    ctx.globalAlpha=rng()*0.8+0.1;
    ctx.beginPath();ctx.arc(rng()*W,H*(0.1+rng()*0.8),rng()*3+0.5,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;
}

function _scElectric(ctx,W,H,rng,pal){
  // Electric arcs
  for(var arc=0;arc<12;arc++){
    ctx.strokeStyle=[pal.c,pal.d,pal.e,pal.e,'#ffffff'][Math.floor(rng()*5)];
    ctx.lineWidth=rng()*2+0.5;ctx.globalAlpha=rng()*0.7+0.2;
    var ax=rng()*W,ay=rng()*H;
    ctx.beginPath();ctx.moveTo(ax,ay);
    for(var as=0;as<8;as++){ax+=rng()*80-40;ay+=rng()*60-30;ctx.lineTo(ax,ay);}
    ctx.stroke();
  }
  ctx.globalAlpha=1;
  // Glow nodes
  for(var nd=0;nd<8;nd++){
    var nx=rng()*W,ny=rng()*H;
    var ng3=ctx.createRadialGradient(nx,ny,0,nx,ny,30+rng()*50);
    ng3.addColorStop(0,pal.e+'88');ng3.addColorStop(1,'transparent');
    ctx.fillStyle=ng3;ctx.fillRect(0,0,W,H);
  }
}

function _scTech(ctx,W,H,rng,pal){
  // Grid
  ctx.strokeStyle=pal.c+'1a';ctx.lineWidth=1;
  for(var gx=0;gx<W;gx+=68){ctx.beginPath();ctx.moveTo(gx,0);ctx.lineTo(gx,H);ctx.stroke();}
  for(var gy=0;gy<H;gy+=68){ctx.beginPath();ctx.moveTo(0,gy);ctx.lineTo(W,gy);ctx.stroke();}
  // Nodes + connections
  var nodes=[];
  for(var n=0;n<20;n++) nodes.push([Math.round(rng()*16)*68,Math.round(rng()*9)*68]);
  ctx.strokeStyle=pal.c+'44';ctx.lineWidth=1.5;
  nodes.forEach(function(n2,i){
    if(i>0&&rng()>0.3){
      ctx.beginPath();ctx.moveTo(n2[0],n2[1]);ctx.lineTo(nodes[i-1][0],nodes[i-1][1]);ctx.stroke();
    }
  });
  nodes.forEach(function(n3){
    var ng4=ctx.createRadialGradient(n3[0],n3[1],0,n3[0],n3[1],12);
    ng4.addColorStop(0,pal.e+'cc');ng4.addColorStop(1,'transparent');
    ctx.fillStyle=ng4;ctx.fillRect(n3[0]-12,n3[1]-12,24,24);
  });
  // Data stream lines
  ctx.strokeStyle=pal.d+'33';ctx.lineWidth=2;
  for(var ds=0;ds<6;ds++){
    var dy=H*(0.1+ds*0.15);
    ctx.beginPath();ctx.moveTo(0,dy);
    for(var dx=0;dx<W;dx+=30) ctx.lineTo(dx,dy+(rng()-0.5)*10);
    ctx.stroke();
  }
}

function _scCyber(ctx,W,H,rng,pal){
  // Matrix rain
  ctx.font='bold 12px monospace';
  var chars='01ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ABCDEF0123456789';
  for(var mc=0;mc<80;mc++){
    ctx.fillStyle=pal.d;ctx.globalAlpha=rng()*0.5+0.05;
    ctx.fillText(chars[Math.floor(rng()*chars.length)],rng()*W,rng()*H);
  }
  ctx.globalAlpha=1;
  // Scan lines
  for(var sl3=0;sl3<H;sl3+=4){
    ctx.fillStyle='rgba(0,0,0,0.2)';ctx.fillRect(0,sl3,W,2);
  }
  // Hex grid
  ctx.strokeStyle=pal.c+'22';ctx.lineWidth=1;
  for(var hx=0;hx<W;hx+=60){
    for(var hy=0;hy<H;hy+=52){
      var hoff=Math.floor(hy/52)%2===0?0:30;
      ctx.beginPath();
      for(var ha=0;ha<6;ha++){
        var angle2=ha*Math.PI/3;
        if(ha===0)ctx.moveTo(hx+hoff+Math.cos(angle2)*20,hy+Math.sin(angle2)*20);
        else ctx.lineTo(hx+hoff+Math.cos(angle2)*20,hy+Math.sin(angle2)*20);
      }
      ctx.closePath();ctx.stroke();
    }
  }
  _scElectric(ctx,W,H,rng,pal);
}

function _scMoney(ctx,W,H,rng,pal){
  // Gold coins
  for(var gc=0;gc<20;gc++){
    var gx2=rng()*W,gy2=H*(0.3+rng()*0.6),gr2=15+rng()*30;
    var gg=ctx.createRadialGradient(gx2-gr2*0.3,gy2-gr2*0.3,0,gx2,gy2,gr2);
    gg.addColorStop(0,'#ffee88');gg.addColorStop(0.6,pal.d);gg.addColorStop(1,pal.b);
    ctx.fillStyle=gg;ctx.globalAlpha=0.7;
    ctx.beginPath();ctx.arc(gx2,gy2,gr2,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle=pal.e+'88';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(gx2,gy2,gr2,0,Math.PI*2);ctx.stroke();
  }
  ctx.globalAlpha=1;
  // Dollar signs floating
  ctx.font='bold 28px sans-serif';ctx.fillStyle=pal.d;
  for(var ds2=0;ds2<8;ds2++){
    ctx.globalAlpha=rng()*0.4+0.1;
    ctx.fillText('$',rng()*W,rng()*H);
  }
  ctx.globalAlpha=1;
  // Rising bars chart
  ctx.fillStyle=pal.c+'55';
  for(var bar=0;bar<12;bar++){
    var bh2=30+rng()*150;
    ctx.fillRect(W*(0.05+bar*0.077),H*0.85-bh2,W*0.055,bh2);
  }
  // Up arrow
  ctx.strokeStyle=pal.e;ctx.lineWidth=3;
  ctx.beginPath();ctx.moveTo(W*0.7,H*0.75);ctx.lineTo(W*0.85,H*0.45);ctx.stroke();
  ctx.beginPath();ctx.moveTo(W*0.8,H*0.45);ctx.lineTo(W*0.85,H*0.45);ctx.lineTo(W*0.85,H*0.52);ctx.stroke();
}

function _scStock(ctx,W,H,rng,pal){
  // Candlestick chart
  var prices=[50,55,48,60,58,65,62,70,68,72,65,78,75,80,77,85,83,90,88,95];
  var barW=W/prices.length*0.6;
  prices.forEach(function(price,i){
    var up=i>0&&price>prices[i-1];
    var h2=price*(H*0.007);
    ctx.fillStyle=up?pal.d:pal.c;ctx.globalAlpha=0.8;
    ctx.fillRect(W*(i/prices.length)+barW*0.2,H*0.85-h2,barW,h2);
  });
  ctx.globalAlpha=1;
  // Moving average line
  ctx.strokeStyle=pal.e+'99';ctx.lineWidth=2;
  ctx.beginPath();
  prices.forEach(function(price,i){
    var x=W*(i/prices.length)+barW*0.5,y=H*0.85-price*(H*0.007);
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.stroke();
  // Grid lines
  ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.lineWidth=1;
  for(var g=0;g<5;g++){ctx.beginPath();ctx.moveTo(0,H*(0.2+g*0.15));ctx.lineTo(W,H*(0.2+g*0.15));ctx.stroke();}
}

function _scMusic(ctx,W,H,rng,pal){
  // Sound wave
  ctx.strokeStyle=pal.d;ctx.lineWidth=3;
  for(var ch=0;ch<3;ch++){
    ctx.globalAlpha=0.6-ch*0.15;
    ctx.beginPath();ctx.moveTo(0,H*0.5);
    for(var mx=0;mx<W;mx+=4){
      var amp=80*(1-ch*0.25)*Math.sin(mx*0.03+(ch*Math.PI*0.66));
      ctx.lineTo(mx,H*0.5+amp);
    }
    ctx.stroke();
  }
  ctx.globalAlpha=1;
  // Music notes
  ctx.font='bold 36px serif';ctx.fillStyle=pal.e;
  ['â™©','â™ª','â™«','â™¬','â™©','â™ª'].forEach(function(note,i){
    ctx.globalAlpha=0.3+rng()*0.5;
    ctx.fillText(note,rng()*W,H*(0.15+rng()*0.65));
  });
  ctx.globalAlpha=1;
  // Equalizer bars
  for(var eq=0;eq<32;eq++){
    var eh=20+rng()*H*0.4;
    ctx.fillStyle=pal.c;ctx.globalAlpha=0.5+rng()*0.4;
    ctx.fillRect(W*(eq/32)+1,H*0.9-eh,W/32-3,eh);
  }
  ctx.globalAlpha=1;
}

function _scAbstract(ctx,W,H,rng,pal){
  // Geometric shapes
  for(var gs=0;gs<15;gs++){
    var sides=3+Math.floor(rng()*5);
    var gx3=rng()*W,gy3=rng()*H,gr3=30+rng()*100;
    ctx.strokeStyle=[pal.c,pal.d,pal.e][Math.floor(rng()*3)];
    ctx.lineWidth=rng()*3+0.5;ctx.globalAlpha=rng()*0.5+0.1;
    ctx.beginPath();
    for(var gv=0;gv<=sides;gv++){
      var ga=gv*Math.PI*2/sides-Math.PI/2+rng()*0.3;
      gv===0?ctx.moveTo(gx3+Math.cos(ga)*gr3,gy3+Math.sin(ga)*gr3):ctx.lineTo(gx3+Math.cos(ga)*gr3,gy3+Math.sin(ga)*gr3);
    }
    ctx.closePath();ctx.stroke();
  }
  // Gradient blobs
  for(var gb=0;gb<8;gb++){
    var blobg=ctx.createRadialGradient(rng()*W,rng()*H,0,rng()*W,rng()*H,60+rng()*150);
    blobg.addColorStop(0,[pal.c,pal.d,pal.e][Math.floor(rng()*3)]+'44');blobg.addColorStop(1,'transparent');
    ctx.fillStyle=blobg;ctx.globalAlpha=1;ctx.fillRect(0,0,W,H);
  }
  ctx.globalAlpha=1;
}

function _scRainbow(ctx,W,H,rng,pal){
  // Rainbow arcs
  var colors2=['#ff0000','#ff8800','#ffff00','#00ff44','#0088ff','#8800ff','#ff00cc'];
  colors2.forEach(function(col,i){
    ctx.strokeStyle=col;ctx.lineWidth=22-i*1.5;ctx.globalAlpha=0.5;
    ctx.beginPath();ctx.arc(W*0.5,H*1.1,(200+i*45),Math.PI,Math.PI*2);ctx.stroke();
  });
  ctx.globalAlpha=1;
  // Colorful floating orbs
  for(var orb=0;orb<20;orb++){
    var og2=ctx.createRadialGradient(rng()*W,rng()*H,0,rng()*W,rng()*H,20+rng()*60);
    og2.addColorStop(0,colors2[Math.floor(rng()*7)]+'88');og2.addColorStop(1,'transparent');
    ctx.fillStyle=og2;ctx.fillRect(0,0,W,H);
  }
}

function _scHorror(ctx,W,H,rng,pal){
  // Dark fog
  for(var fg=0;fg<8;fg++){
    var fgg=ctx.createRadialGradient(rng()*W,H*0.5+rng()*H*0.4,0,rng()*W,H*0.6,150+rng()*200);
    fgg.addColorStop(0,'rgba(20,0,8,0.6)');fgg.addColorStop(1,'transparent');
    ctx.fillStyle=fgg;ctx.fillRect(0,0,W,H);
  }
  // Cracks
  ctx.strokeStyle=pal.d+'88';ctx.lineWidth=2;
  for(var cr2=0;cr2<5;cr2++){
    var cx4=rng()*W,cy4=rng()*H;
    ctx.beginPath();ctx.moveTo(cx4,cy4);
    for(var cs=0;cs<8;cs++){cx4+=rng()*50-25;cy4+=rng()*40-20;ctx.lineTo(cx4,cy4);}
    ctx.stroke();
  }
  // Red drips
  for(var dr=0;dr<8;dr++){
    var dx=rng()*W,dh=20+rng()*80;
    var dg=ctx.createLinearGradient(dx,0,dx,dh);
    dg.addColorStop(0,'#cc000088');dg.addColorStop(1,'transparent');
    ctx.fillStyle=dg;ctx.fillRect(dx-2,0,4,dh);
  }
  // Glowing eyes
  for(var eye=0;eye<3;eye++){
    var ex=W*(0.15+rng()*0.7),ey=H*(0.2+rng()*0.5);
    var eg2=ctx.createRadialGradient(ex,ey,0,ex,ey,12);
    eg2.addColorStop(0,'#ff0000cc');eg2.addColorStop(1,'transparent');
    ctx.fillStyle=eg2;ctx.fillRect(0,0,W,H);
  }
}

function _scRoyal(ctx,W,H,rng,pal){
  // Palace columns
  for(var col=0;col<6;col++){
    var cx5=W*(0.1+col*0.16);
    var cg2=ctx.createLinearGradient(cx5,0,cx5+30,0);
    cg2.addColorStop(0,pal.b);cg2.addColorStop(0.5,pal.c+'88');cg2.addColorStop(1,pal.b);
    ctx.fillStyle=cg2;ctx.fillRect(cx5,H*0.3,28,H*0.7);
    // Capital
    ctx.fillStyle=pal.d+'aa';ctx.fillRect(cx5-8,H*0.28,44,16);
  }
  // Crown
  ctx.strokeStyle=pal.e;ctx.lineWidth=3;ctx.fillStyle=pal.d+'55';
  ctx.beginPath();
  var cpts=[[0.35,0.18],[0.38,0.12],[0.41,0.08],[0.44,0.12],[0.47,0.07],[0.5,0.12],[0.53,0.07],[0.56,0.12],[0.59,0.08],[0.62,0.12],[0.65,0.18],[0.65,0.25],[0.35,0.25]];
  ctx.moveTo(cpts[0][0]*W,cpts[0][1]*H);
  cpts.forEach(function(pt){ctx.lineTo(pt[0]*W,pt[1]*H);});
  ctx.closePath();ctx.fill();ctx.stroke();
  // Gems
  [pal.c,pal.d,pal.e,pal.d,pal.c].forEach(function(gem,i){
    ctx.fillStyle=gem;ctx.beginPath();
    var gx4=W*(0.38+i*0.06),gy4=H*0.21;
    ctx.arc(gx4,gy4,5,0,Math.PI*2);ctx.fill();
  });
}

function _scVintage(ctx,W,H,rng,pal){
  // Film grain
  var gd=ctx.createLinearGradient(0,0,W,H);
  gd.addColorStop(0,pal.b);gd.addColorStop(0.5,pal.c+'44');gd.addColorStop(1,pal.a);
  ctx.fillStyle=gd;ctx.fillRect(0,0,W,H);
  // Film scratches
  ctx.strokeStyle=pal.d+'33';ctx.lineWidth=1;
  for(var sc=0;sc<8;sc++){
    var sx=rng()*W;ctx.beginPath();ctx.moveTo(sx,0);ctx.lineTo(sx+rng()*10-5,H);ctx.stroke();
  }
  // Sepia tone overlay
  ctx.fillStyle='rgba(80,40,0,0.2)';ctx.fillRect(0,0,W,H);
  // Scan lines
  for(var sl4=0;sl4<H;sl4+=3){ctx.fillStyle='rgba(0,0,0,0.15)';ctx.fillRect(0,sl4,W,1);}
  // Vignette (extra strong)
  var vv=ctx.createRadialGradient(W/2,H/2,H*0.1,W/2,H/2,W*0.7);
  vv.addColorStop(0,'transparent');vv.addColorStop(1,'rgba(0,0,0,0.6)');
  ctx.fillStyle=vv;ctx.fillRect(0,0,W,H);
  // Film sprocket holes
  [0.02,0.96].forEach(function(side){
    for(var sh2=0;sh2<9;sh2++){ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(side*W,H*(0.05+sh2*0.1),W*0.015,W*0.015);}
  });
}

function _scSmoke(ctx,W,H,rng,pal){
  for(var sm=0;sm<20;sm++){
    var sg4=ctx.createRadialGradient(W*(0.1+rng()*0.8),H*(0.2+rng()*0.7),0,W*(0.1+rng()*0.8),H*(0.2+rng()*0.7),80+rng()*180);
    sg4.addColorStop(0,pal.d+'22');sg4.addColorStop(1,'transparent');
    ctx.fillStyle=sg4;ctx.fillRect(0,0,W,H);
  }
  ctx.strokeStyle=pal.c+'18';ctx.lineWidth=40;
  for(var sc2=0;sc2<6;sc2++){
    ctx.globalAlpha=0.15;
    ctx.beginPath();
    var sx2=W*(0.1+rng()*0.8),sy=H;
    ctx.moveTo(sx2,sy);
    for(var ss=0;ss<8;ss++){sx2+=rng()*60-30;sy-=H/8+rng()*20;ctx.lineTo(sx2,sy);}
    ctx.stroke();
  }
  ctx.globalAlpha=1;
}

function _scFlight(ctx,W,H,rng,pal){
  _scSky(ctx,W,H,rng,pal);
  // Airplane silhouette
  var ax=W*0.4,ay=H*0.35;
  ctx.fillStyle='rgba(0,0,0,0.7)';ctx.save();ctx.translate(ax,ay);ctx.rotate(-0.15);
  ctx.fillRect(-60,0,120,12);// body
  ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(-15,-10);ctx.lineTo(15,-10);ctx.closePath();ctx.fill();//nose
  ctx.fillRect(-80,2,160,6);// wings
  ctx.fillRect(30,-5,40,4);// tail
  ctx.restore();
  // Contrail
  ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.lineWidth=6;
  ctx.beginPath();ctx.moveTo(ax+70,ay+4);ctx.lineTo(W*0.95,H*0.4);ctx.stroke();
  ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=18;ctx.stroke();
}

function _scSpeed(ctx,W,H,rng,pal){
  // Motion blur streaks
  for(var ms=0;ms<60;ms++){
    var mlen=100+rng()*400,my=rng()*H;
    ctx.strokeStyle=[pal.c,pal.d,pal.e][Math.floor(rng()*3)];
    ctx.lineWidth=rng()*2+0.3;ctx.globalAlpha=rng()*0.4+0.05;
    ctx.beginPath();ctx.moveTo(W,my);ctx.lineTo(W-mlen,my+rng()*20-10);ctx.stroke();
  }
  ctx.globalAlpha=1;
  // Speed lines from center
  var sc3=ctx.createRadialGradient(W*0.3,H*0.5,10,W*0.3,H*0.5,W*0.6);
  sc3.addColorStop(0,pal.e+'33');sc3.addColorStop(1,'transparent');
  ctx.fillStyle=sc3;ctx.fillRect(0,0,W,H);
}

function _scFilm(ctx,W,H,rng,pal){
  // Film strip frame
  ctx.fillStyle='rgba(0,0,0,0.6)';ctx.fillRect(0,0,W,H*0.08);ctx.fillRect(0,H*0.92,W,H*0.08);
  // Sprocket holes
  for(var sp=0;sp<14;sp++){
    ctx.fillStyle='rgba(30,30,30,0.9)';
    ctx.fillRect(sp*(W/14)+4,4,W/14-8,H*0.065);
    ctx.fillRect(sp*(W/14)+4,H*0.927,W/14-8,H*0.065);
  }
  // Cinematic scene inside
  _scCity(ctx,W*0.9,H*0.84,rng,pal);
  // Film grain
  for(var fg2=0;fg2<300;fg2++){
    ctx.fillStyle='rgba(255,255,255,0.03)';
    ctx.fillRect(rng()*W,rng()*H,1,1);
  }
}

function _scGlass(ctx,W,H,rng,pal){
  // Refraction effect â€” layered transparent polygons
  for(var gl=0;gl<18;gl++){
    var points=[];
    for(var gp=0;gp<5;gp++) points.push([rng()*W,rng()*H]);
    ctx.fillStyle=[pal.c,pal.d,pal.e][Math.floor(rng()*3)]+'15';
    ctx.strokeStyle=[pal.c,pal.d,pal.e][Math.floor(rng()*3)]+'44';
    ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(points[0][0],points[0][1]);
    points.forEach(function(pt){ctx.lineTo(pt[0],pt[1]);});
    ctx.closePath();ctx.fill();ctx.stroke();
  }
  // Caustic light patterns
  for(var ca=0;ca<12;ca++){
    var cag=ctx.createRadialGradient(rng()*W,rng()*H,0,rng()*W,rng()*H,30+rng()*80);
    cag.addColorStop(0,pal.e+'33');cag.addColorStop(1,'transparent');
    ctx.fillStyle=cag;ctx.fillRect(0,0,W,H);
  }
}

function _scMetal(ctx,W,H,rng,pal){
  // Brushed metal texture
  for(var bm=0;bm<H;bm+=2){
    ctx.fillStyle=bm%4===0?pal.c+'12':pal.d+'08';
    ctx.fillRect(0,bm,W,1);
  }
  // Rivet/bolt pattern
  ctx.fillStyle=pal.d+'88';
  for(var rv=0;rv<30;rv++){
    ctx.globalAlpha=0.6;
    ctx.beginPath();ctx.arc(rng()*W,rng()*H,4+rng()*4,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle=pal.e+'55';ctx.lineWidth=1;ctx.beginPath();ctx.arc(rng()*W,rng()*H,4+rng()*4,0,Math.PI*2);ctx.stroke();
  }
  ctx.globalAlpha=1;
  // Metallic sheen
  var ms2=ctx.createLinearGradient(0,0,W,H);
  ms2.addColorStop(0,'transparent');ms2.addColorStop(0.4,pal.e+'22');ms2.addColorStop(0.6,pal.d+'11');ms2.addColorStop(1,'transparent');
  ctx.fillStyle=ms2;ctx.fillRect(0,0,W,H);
}

async function imageGenGenerate() {
  var promptEl  = document.getElementById('imgPrompt');
  var negEl     = document.getElementById('imgNegative');
  var countEl   = document.getElementById('imgCount');
  var seedEl    = document.getElementById('imgSeed');
  var btn       = document.getElementById('imgGenBtn');
  var resultEl  = document.getElementById('imgGenResult');

  var prompt = promptEl ? promptEl.value.trim() : '';
  if (!prompt) { notify('Please describe your image first!', 'error', 'âœï¸'); if(promptEl) promptEl.focus(); return; }

  var negative = negEl   ? negEl.value.trim()                          : '';
  var count    = parseInt((countEl ? countEl.value : '2') || '2');
  var seed     = seedEl && seedEl.value ? parseInt(seedEl.value) : Math.floor(Math.random() * 99999999);
  var style    = window._imgStyle || 'photorealistic';
  var ratio    = window._imgRatio || '1:1';

  var dims = {'1:1':{w:1024,h:1024},'16:9':{w:1280,h:720},'9:16':{w:720,h:1280},'4:3':{w:1024,h:768},'3:4':{w:768,h:1024},'21:9':{w:1512,h:648}};
  var d = dims[ratio] || dims['1:1'];

  var styleMap = {
    'photorealistic': ', ultra-realistic photography, 8K, professional DSLR, sharp focus, natural lighting',
    'cinematic'     : ', cinematic film still, anamorphic lens, golden hour, dramatic lighting, movie quality',
    'digital-art'   : ', vibrant digital illustration, concept art, detailed, trending on ArtStation',
    'anime'         : ', anime art style, Studio Ghibli, clean lines, beautiful coloring, manga inspired',
    '3d-render'     : ', 3D render, CGI, octane render, subsurface scattering, raytracing, photorealistic 3D',
    'watercolor'    : ', watercolor painting, soft washes, paper texture, artistic, loose brushwork',
    'minimalist'    : ', minimalist design, clean composition, white space, simple shapes, modern',
    'neon-cyberpunk': ', neon cyberpunk, synthwave, glowing lights, rain-slicked streets, futuristic dystopia',
    'vintage'       : ', vintage film photography, film grain, muted tones, kodachrome, retro aesthetic',
    'flat-design'   : ', flat design illustration, bold solid colours, geometric shapes, vector art style',
  };
  var fullPrompt = prompt + (styleMap[style] || '');
  if (negative) fullPrompt += ' --no ' + negative;

  if (btn) { btn.disabled = true; btn.innerHTML = '<div class="spinner spinner-sm" style="display:inline-block;margin-right:6px;vertical-align:middle"></div> Generating ' + count + ' image' + (count > 1 ? 's' : '') + 'â€¦'; }

  // Show skeleton loading grid
  if (resultEl) {
    var skels = '';
    for (var si = 0; si < count; si++) {
      skels += '<div style="border-radius:14px;background:var(--surface2);border:1px solid var(--border);overflow:hidden;position:relative;aspect-ratio:' + d.w + '/' + d.h + ';display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px">' +
        '<div style="font-size:32px;animation:pulse 1.4s ease infinite ' + (si * 0.25) + 's">ðŸŽ¨</div>' +
        '<div style="font-size:11px;color:var(--muted)">Generating via AIâ€¦ may take 10-30s</div>' +
        '<div style="position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--teal))"></div>' +
      '</div>';
    }
    resultEl.style.display = 'block';
    resultEl.innerHTML = '<div style="display:grid;grid-template-columns:repeat(' + Math.min(count, 2) + ',1fr);gap:12px;margin-bottom:14px">' + skels + '</div>';
  }

  var results = [];
  var errors  = 0;

  // Generate images one at a time, update each slot live as it arrives
  for (var j = 0; j < count; j++) {
    var thisSeed  = seed + j;
    var primaryUrl = _imgBuildUrl(fullPrompt, d.w, d.h, thisSeed, 'flux');
    var dataUrl   = null;
    var errorMsg  = null;

    try {
      var imgResult = await _imgFetchWithProviderFallback(fullPrompt, d.w, d.h, thisSeed, style);
      dataUrl = imgResult.dataUrl;
      primaryUrl = imgResult.url;
    } catch(e1) {
      errorMsg = (e1 && e1.message) ? e1.message : 'Generation failed';
      console.error('[TrendVid IMG] Final error:', errorMsg);
      errors++;
    }

    results.push({ dataUrl: dataUrl, url: primaryUrl, seed: thisSeed, ok: !!dataUrl, error: errorMsg });

    // Update the grid slot for this image
    if (resultEl) {
      var slots = resultEl.querySelectorAll('div[style*="aspect-ratio"]');
      var slot = slots[j];
      if (slot) {
        if (dataUrl) {
          var imgSrc = (dataUrl && dataUrl.indexOf('__imgurl__') === 0) ? dataUrl.replace('__imgurl__','') : dataUrl;
          slot.innerHTML =
            '<img src="' + imgSrc + '" style="width:100%;display:block;aspect-ratio:' + d.w + '/' + d.h + ';object-fit:cover" alt="Generated image" crossorigin="anonymous">' +
            '<div style="position:absolute;bottom:0;left:0;right:0;padding:10px 12px;background:linear-gradient(to top,rgba(0,0,0,0.85),transparent);display:flex;gap:6px;align-items:center">' +
              '<span style="font-size:10px;color:rgba(255,255,255,0.6);flex:1">Seed ' + thisSeed + '</span>' +
              '<button onclick="imageGenDownload(' + j + ')" style="background:var(--accent);border:none;color:#fff;padding:4px 12px;border-radius:7px;font-size:10px;font-weight:800;cursor:pointer">â¬‡ï¸ Save</button>' +
              '<button onclick="imageGenEnlargeData(' + j + ')" style="background:rgba(255,255,255,0.15);border:none;color:#fff;padding:4px 10px;border-radius:7px;font-size:10px;cursor:pointer">ðŸ”</button>' +
            '</div>';
          slot.style.cursor = 'pointer';
          slot.onclick = (function(idx){ return function(){ imageGenEnlargeData(idx); }; })(j);
        } else {
          slot.innerHTML =
            '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:8px;padding:20px;text-align:center">' +
              '<span style="font-size:28px">âŒ</span>' +
              '<span style="font-size:11px;color:var(--muted);word-break:break-word;max-width:200px;display:block">' + (errorMsg || 'Failed') + '</span>' +
              '<button onclick="imageGenGenerate()" style="background:var(--accent);border:none;color:#fff;padding:5px 14px;border-radius:8px;font-size:10px;font-weight:800;cursor:pointer;margin-top:4px">â†º Try Again</button>' +
            '</div>';
        }
      }
    }
  }

  // Store for download/enlarge
  window._imgGenResults = results;
  window._imgGenDims    = d;

  // Save successful ones to history
  var history = [];
  try { history = JSON.parse(localStorage.getItem('tv_image_history') || '[]'); } catch(e) {}
  for (var hi = 0; hi < results.length; hi++) {
    if (results[hi].ok && results[hi].dataUrl) {
      history.push({ dataUrl: results[hi].dataUrl, url: results[hi].url, prompt: prompt, style: style, ratio: ratio, seed: results[hi].seed, createdAt: Date.now() });
    }
  }
  if (history.length > 48) history = history.slice(history.length - 48);
  try { localStorage.setItem('tv_image_history', JSON.stringify(history)); } catch(e) {}
  // Auto-save to image library
  for (var _li = 0; _li < results.length; _li++) {
    if (results[_li].ok && results[_li].dataUrl) tvImgLibSave(results[_li].dataUrl, prompt, 'image-gen');
  }

  if (typeof awardXP === 'function') awardXP(5, 'Generated images');

  var successCount = results.length - errors;
  if (btn) { btn.disabled = false; btn.innerHTML = 'âœ¨ Generate Image'; }

  if (successCount > 0) {
    notify('ðŸ–¼ï¸ ' + successCount + ' image' + (successCount > 1 ? 's' : '') + ' generated!', 'success', 'âœ…');
  } else {
    var errDetail = (results[0] && results[0].error) ? results[0].error : 'check your connection';
    notify('Generation failed â€” open F12 Console for details', 'error', 'âŒ');
    console.error('[TrendVid IMG] Generation failed. Detail:', errDetail);
  }

  setTimeout(renderImageGenHistory, 50);
}

function imageGenDownload(idx) {
  var r = window._imgGenResults && window._imgGenResults[idx];
  if (!r || !r.dataUrl) { notify('Image not available', 'error', 'âŒ'); return; }
  var a = document.createElement('a');
  a.href = r.dataUrl;
  a.download = 'trendvid-image-' + (r.seed || idx) + '.png';
  a.click();
}

function imageGenEnlargeData(idx) {
  var r = window._imgGenResults && window._imgGenResults[idx];
  if (!r || !r.dataUrl) { notify('Image not available', 'error', 'âŒ'); return; }
  imageGenEnlargeUrl(r.dataUrl);
}

function renderImageGenHistory() {
  var histEl = document.getElementById('imgGenHistory');
  if (!histEl) return;
  var history = [];
  try { history = JSON.parse(localStorage.getItem('tv_image_history') || '[]'); } catch(e) {}
  if (!history.length) { histEl.innerHTML = ''; return; }
  var recent = history.slice().reverse().slice(0, 24);
  histEl.innerHTML =
    '<div style="font-size:11px;font-weight:900;letter-spacing:1.5px;color:var(--muted);margin-bottom:12px;margin-top:28px;font-family:var(--font-display)">RECENT GENERATIONS (' + history.length + ')</div>' +
    '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px">' +
    recent.map(function(img) {
      var imgSrc = img.dataUrl || img.url || '';
      if (!imgSrc) return '';
      return '<div style="border-radius:12px;overflow:hidden;border:1px solid var(--border);cursor:pointer;position:relative;aspect-ratio:1" onclick="imageGenEnlargeUrl(\'' + imgSrc.substring(0,50) + '\')">' +
        '<img src="' + imgSrc + '" style="width:100%;height:100%;object-fit:cover;display:block" loading="lazy" onerror="this.parentNode.style.display=\'none\'">' +
        '<div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top,rgba(0,0,0,0.75),transparent);padding:6px 8px;font-size:9px;color:rgba(255,255,255,0.7);overflow:hidden;white-space:nowrap;text-overflow:ellipsis">' + (img.prompt || '') + '</div>' +
      '</div>';
    }).join('') +
    '</div>';
}



function imageGenEnlargeUrl(url) {
  var modal = document.getElementById('imgEnlargeModal');
  var img = document.getElementById('imgEnlargeImg');
  var dl = document.getElementById('imgEnlargeDownload');
  if (!modal || !img) return;
  img.src = url;
  dl.href = url;
  modal.style.display = 'flex';
}

function imageGenEnlargeHistory(idx) {
  var history = [];
  try { history = JSON.parse(localStorage.getItem('tv_image_history') || '[]'); } catch(e) {}
  var item = history[idx];
  if (item) imageGenEnlargeUrl(item.url);
}

function imageGenCloseEnlarge() {
  var modal = document.getElementById('imgEnlargeModal');
  if (modal) modal.style.display = 'none';
}

function imageGenReuse(idx) {
  var history = [];
  try { history = JSON.parse(localStorage.getItem('tv_image_history') || '[]'); } catch(e) {}
  var item = history[idx];
  if (!item) return;
  navTo('imagegen');
  setTimeout(function() {
    var el = document.getElementById('imgPrompt');
    if (el) el.value = item.prompt;
    if (item.style) imageGenSelectStyle(item.style);
    if (item.ratio) imageGenSelectRatio(item.ratio);
    var seedEl = document.getElementById('imgSeed');
    if (seedEl && item.seed) seedEl.value = item.seed;
  }, 100);
}


// ============================================================
// SHARE YOUR WIN â€” Twitter/X share modal for key moments
// ============================================================
function shareWin(type, topic, score) {
  var msgs = {
    script: 'Just generated a viral script for "' + topic + '" using TrendVid AI ðŸš€ Viral score: ' + score + '/100. Try it free ðŸ‘‡\nhttps://trendvid.ai',
    viral:  'My TrendVid AI viral score for "' + topic + '" is ' + score + '/100 ðŸ”¥ Getting my content dialled in. Free to try ðŸ‘‡\nhttps://trendvid.ai',
    stats:  topic, // pre-formatted message passed in
    badge:  'Just earned the ' + topic + ' badge on TrendVid AI ðŸ… Level up your content creation ðŸ‘‡\nhttps://trendvid.ai',
  };
  var msg = msgs[type] || topic;
  var url = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(msg);

  // Show mini modal with preview + open Twitter
  var existing = document.getElementById('shareWinModal');
  if (existing) existing.remove();

  var modal = document.createElement('div');
  modal.id = 'shareWinModal';
  modal.style.cssText = 'position:fixed;inset:0;z-index:99995;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.2s ease';
  modal.innerHTML =
    '<div style="background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:28px;max-width:420px;width:100%;box-shadow:0 24px 80px rgba(0,0,0,0.5);animation:slideUp 0.3s ease">' +
      '<div style="display:flex;align-items:center;gap:10px;margin-bottom:18px">' +
        '<div style="width:40px;height:40px;background:#1da1f2;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;font-weight:900;font-family:serif">ð•</div>' +
        '<div><div style="font-size:15px;font-weight:800">Share your win</div><div style="font-size:11px;color:var(--muted)">Let your followers know what you\'re building</div></div>' +
      '</div>' +
      '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:14px;font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:18px;white-space:pre-wrap">' + esc(msg) + '</div>' +
      '<div style="display:flex;gap:8px">' +
        '<button onclick="window.open(\'' + url.replace(/'/g,"\\'") + '\',\'_blank\');document.getElementById(\'shareWinModal\').remove()" style="flex:1;background:#1da1f2;color:#fff;border:none;border-radius:12px;padding:12px;font-size:13px;font-weight:800;cursor:pointer;font-family:inherit">ð• Post to Twitter</button>' +
        '<button onclick="safeCopy(\''+esc(msg).replace(/'/g,"\\'")+'\',\'Copied!\',\'ðŸ“‹\')" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:12px;padding:12px 16px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">ðŸ“‹ Copy</button>' +
        '<button onclick="document.getElementById(\'shareWinModal\').remove()" style="background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:12px;padding:12px 14px;font-size:13px;cursor:pointer">âœ•</button>' +
      '</div>' +
    '</div>';
  modal.addEventListener('click', function(e){ if(e.target===modal) modal.remove(); });
  document.body.appendChild(modal);
}

// ============================================================
// CREATOR STATS CARD â€” shareable card generator
// ============================================================
function showCreatorStatsCard() {
  var d = getXPData();
  var badge = getCurrentBadge(d.level);
  var scripts = []; try { scripts = JSON.parse(localStorage.getItem('tv_scripts')||'[]'); } catch(e) {}
  var favs = []; try { favs = JSON.parse(localStorage.getItem('tv_favs')||'[]'); } catch(e) {}
  var calData = {}; try { calData = JSON.parse(localStorage.getItem('tv_calendar')||'{}'); } catch(e) {}
  var calDays = Object.values(calData).filter(Boolean).length;
  var actionsComplete = 0;
  if (typeof XP_ACTIONS !== 'undefined') {
    XP_ACTIONS.forEach(function(a){ if(localStorage.getItem('tv_check_'+a.key)) actionsComplete++; });
  }
  var userName = (currentUser && currentUser.name) ? currentUser.name : 'Creator';
  var plan = (currentUser && currentUser.plan) ? currentUser.plan.toUpperCase() : 'FREE';
  var planColors = {FREE:'#6b7280',STARTER:'#10b981',PRO:'#ff3058',GOLD:'#fbbf24',ELITE:'#c084fc'};
  var planColor = planColors[plan] || '#6b7280';
  var badgeEmoji = badge ? badge.emoji : 'ðŸŒ±';
  var badgeLabel = badge ? badge.badge : 'Seedling';

  // Build the shareable card HTML (opens in new window for screenshot/save)
  var cardHtml = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>TrendVid Creator Card</title>' +
    '<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800;900&family=DM+Sans:wght@400;600;700&display=swap" rel="stylesheet">' +
    '<style>*{margin:0;padding:0;box-sizing:border-box;}body{width:600px;height:340px;overflow:hidden;background:#060810;font-family:"DM Sans",sans-serif;display:flex;align-items:center;justify-content:center;}' +
    '.card{width:560px;height:300px;border-radius:24px;background:linear-gradient(135deg,#0d1020,#111827);border:1px solid rgba(255,255,255,0.1);padding:32px;display:flex;flex-direction:column;justify-content:space-between;position:relative;overflow:hidden;}' +
    '.glow{position:absolute;top:-40px;right:-40px;width:200px;height:200px;background:radial-gradient(circle,rgba(255,48,88,0.25),transparent 70%);pointer-events:none;}' +
    '.glow2{position:absolute;bottom:-40px;left:-20px;width:160px;height:160px;background:radial-gradient(circle,rgba(0,229,176,0.15),transparent 70%);pointer-events:none;}' +
    '.top{display:flex;align-items:center;justify-content:space-between;}' +
    '.logo{font-family:"Syne",sans-serif;font-size:14px;font-weight:900;letter-spacing:3px;color:rgba(255,255,255,0.4);}' +
    '.logo span{color:#ff3058;}' +
    '.plan{background:'+planColor+';color:#fff;padding:4px 12px;border-radius:20px;font-family:"Syne",sans-serif;font-size:11px;font-weight:900;letter-spacing:1px;}' +
    '.mid{display:flex;align-items:center;gap:20px;}' +
    '.badge-box{width:72px;height:72px;border-radius:18px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-size:38px;flex-shrink:0;}' +
    '.name{font-family:"Syne",sans-serif;font-size:28px;font-weight:900;color:#fff;letter-spacing:-0.5px;}' +
    '.title{font-size:13px;color:rgba(255,255,255,0.5);margin-top:4px;font-weight:600;}' +
    '.level{font-family:"Syne",sans-serif;font-size:13px;font-weight:900;color:#ff3058;margin-top:6px;letter-spacing:1px;}' +
    '.stats{display:flex;gap:0;border-top:1px solid rgba(255,255,255,0.08);padding-top:18px;}' +
    '.stat{flex:1;text-align:center;border-right:1px solid rgba(255,255,255,0.08);}' +
    '.stat:last-child{border-right:none;}' +
    '.stat-num{font-family:"Syne",sans-serif;font-size:22px;font-weight:900;color:#fff;}' +
    '.stat-label{font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:1px;margin-top:3px;font-weight:600;}' +
    '.print-btn{position:fixed;top:16px;right:16px;background:#ff3058;color:#fff;border:none;padding:10px 20px;border-radius:10px;font-size:13px;font-weight:800;cursor:pointer;font-family:"Syne",sans-serif;}' +
    '@media print{.print-btn{display:none;}body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}}' +
    '</style></head><body>' +
    '<button class="print-btn" onclick="window.print()">ðŸ’¾ Save as Image</button>' +
    '<div class="card">' +
      '<div class="glow"></div><div class="glow2"></div>' +
      '<div class="top"><div class="logo">TREND<span>VID</span> AI</div><div class="plan">'+plan+'</div></div>' +
      '<div class="mid">' +
        '<div class="badge-box">'+badgeEmoji+'</div>' +
        '<div><div class="name">'+esc(userName)+'</div><div class="title">'+badgeLabel+' Creator</div><div class="level">â­ LEVEL '+d.level+' Â· '+d.xp+' XP</div></div>' +
      '</div>' +
      '<div class="stats">' +
        '<div class="stat"><div class="stat-num">'+scripts.length+'</div><div class="stat-label">Scripts</div></div>' +
        '<div class="stat"><div class="stat-num">'+calDays+'</div><div class="stat-label">Cal Days</div></div>' +
        '<div class="stat"><div class="stat-num">'+favs.length+'</div><div class="stat-label">Saved</div></div>' +
        '<div class="stat"><div class="stat-num">'+actionsComplete+'</div><div class="stat-label">Missions</div></div>' +
      '</div>' +
    '</div>' +
    '</body></html>';

  var blob = new Blob([cardHtml], {type:'text/html'});
  var cardUrl = URL.createObjectURL(blob);
  window.open(cardUrl, '_blank');

  // Also show share modal
  var shareMsg = badgeEmoji + ' My TrendVid AI Creator Card:\n' +
    'ðŸ‘¤ ' + userName + ' Â· Level ' + d.level + ' ' + badgeLabel + '\n' +
    'âœï¸ ' + scripts.length + ' scripts written\n' +
    'ðŸ“… ' + calDays + ' content days planned\n' +
    'Start yours free ðŸ‘‡ https://trendvid.ai';

  setTimeout(function() { shareWin('stats', shareMsg, 0); }, 300);
  awardXP('shared_card');
}

// ============================================================
// NPS / CHURN SURVEY â€” shown after 7 days of inactivity
// ============================================================
function checkShowNPSSurvey() {
  try {
    if (!currentUser || currentUser.isAdmin) return;
    var lastSeen = parseInt(localStorage.getItem('tv_last_active') || '0');
    var dismissed = parseInt(localStorage.getItem('tv_nps_dismissed') || '0');
    var now = Date.now();
    var sevenDays = 7 * 24 * 60 * 60 * 1000;
    var thirtyDays = 30 * 24 * 60 * 60 * 1000;

    // Update last active timestamp
    localStorage.setItem('tv_last_active', String(now));

    // Don't show if dismissed within 30 days, or if last active was recent
    if (dismissed && (now - dismissed) < thirtyDays) return;
    if (!lastSeen || (now - lastSeen) < sevenDays) return;

    setTimeout(function() {
      var existing = document.getElementById('npsSurveyModal');
      if (existing) return;

      var modal = document.createElement('div');
      modal.id = 'npsSurveyModal';
      modal.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:99985;width:340px;background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:20px;box-shadow:0 16px 60px rgba(0,0,0,0.5);animation:slideUp 0.4s ease';
      modal.innerHTML =
        '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">' +
          '<div style="font-size:14px;font-weight:800">Quick question ðŸ‘‹</div>' +
          '<button onclick="localStorage.setItem(\'tv_nps_dismissed\',\''+now+'\');document.getElementById(\'npsSurveyModal\').remove()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px">âœ•</button>' +
        '</div>' +
        '<div style="font-size:12px;color:var(--muted);margin-bottom:14px;line-height:1.5">Welcome back! We missed you. How likely are you to recommend TrendVid to a creator friend?</div>' +
        '<div style="display:flex;gap:4px;margin-bottom:14px" id="npsScores">' +
          [0,1,2,3,4,5,6,7,8,9,10].map(function(n) {
            var col = n>=9?'var(--teal)':n>=7?'var(--gold)':'var(--muted)';
            return '<button onclick="submitNPS('+n+')" style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:7px 2px;font-size:11px;font-weight:700;color:'+col+';cursor:pointer;font-family:inherit;transition:all 0.1s" onmouseover="this.style.background=\'var(--surface3)\'" onmouseout="this.style.background=\'var(--surface2)\'>'+n+'</button>';
          }).join('') +
        '</div>' +
        '<div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted)">' +
          '<span>Not likely</span><span>Very likely</span>' +
        '</div>';
      document.body.appendChild(modal);
    }, 4000);
  } catch(e) {}
}

function submitNPS(score) {
  localStorage.setItem('tv_nps_dismissed', String(Date.now()));
  // Save score to admin records
  var npsData = []; try { npsData = JSON.parse(localStorage.getItem('tv_nps_scores')||'[]'); } catch(e) {}
  npsData.push({score:score, email:currentUser?currentUser.email:'', at:Date.now()});
  localStorage.setItem('tv_nps_scores', JSON.stringify(npsData.slice(0,200)));

  var modal = document.getElementById('npsSurveyModal');
  if (!modal) return;
  if (score >= 9) {
    modal.innerHTML = '<div style="text-align:center;padding:16px"><div style="font-size:32px;margin-bottom:10px">ðŸŽ‰</div><div style="font-size:14px;font-weight:800;margin-bottom:6px">You\'re amazing!</div><div style="font-size:12px;color:var(--muted);margin-bottom:14px">Would you share TrendVid with your creator friends?</div><div style="display:flex;gap:8px"><button onclick="shareWin(\'stats\',\'Just discovered TrendVid AI â€” best AI tool for content creators. Viral scripts, trend radar, thumbnail AI and more. Free to start ðŸ‘‡ https://trendvid.ai\',0);document.getElementById(\'npsSurveyModal\').remove()" style="flex:1;background:#1da1f2;color:#fff;border:none;border-radius:10px;padding:10px;font-size:12px;font-weight:800;cursor:pointer;font-family:inherit">ð• Share it</button><button onclick="document.getElementById(\'npsSurveyModal\').remove()" style="background:var(--surface2);border:1px solid var(--border);color:var(--muted);border-radius:10px;padding:10px 14px;font-size:12px;cursor:pointer">Later</button></div></div>';
  } else if (score <= 6) {
    modal.innerHTML = '<div style="text-align:center;padding:16px"><div style="font-size:32px;margin-bottom:10px">ðŸ’¬</div><div style="font-size:14px;font-weight:800;margin-bottom:6px">Thanks for the honest feedback</div><div style="font-size:12px;color:var(--muted);margin-bottom:14px">What\'s the #1 thing we should improve?</div><textarea id="npsFeedbackText" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px;color:var(--text);font-family:inherit;font-size:12px;resize:none;margin-bottom:10px" rows="3" placeholder="Tell us what would make TrendVid a 10/10 for you..."></textarea><div style="display:flex;gap:8px"><button onclick="var t=document.getElementById(\'npsFeedbackText\');if(t&&t.value){var fb=JSON.parse(localStorage.getItem(\'tv_nps_feedback\')||\'[]\');fb.push({score:'+score+',feedback:t.value,at:Date.now()});localStorage.setItem(\'tv_nps_feedback\',JSON.stringify(fb));notify(\'Thanks! Your feedback helps us improve ðŸ™\',\'success\',\'ðŸ’¬\');}document.getElementById(\'npsSurveyModal\').remove()" style="flex:1;background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px;font-size:12px;font-weight:800;cursor:pointer;font-family:inherit">Send feedback</button><button onclick="document.getElementById(\'npsSurveyModal\').remove()" style="background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:10px;padding:10px 14px;font-size:12px;cursor:pointer">Skip</button></div></div>';
  } else {
    modal.innerHTML = '<div style="text-align:center;padding:16px"><div style="font-size:32px;margin-bottom:10px">ðŸ‘</div><div style="font-size:14px;font-weight:800;margin-bottom:6px">Thanks for the rating!</div><div style="font-size:12px;color:var(--muted)">We\'re always working to make TrendVid better for you.</div><button onclick="document.getElementById(\'npsSurveyModal\').remove()" style="margin-top:14px;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:9px 20px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit">Close</button></div>';
  }
}

// ============================================================
// PUBLIC CHANGELOG PAGE â€” shown on landing & in-app
// ============================================================


function updateEarlyAccessNav() {
  var existing = document.getElementById('earlyAccessNavBtn');
  var userIsEA = isEarlyAccessUser();
  var tabActive = earlyAccessTabActive();

  if (userIsEA && tabActive) {
    if (!existing) {
      // Insert after the changelog nav item
      var changelogBtn = document.querySelector('[data-page="changelog"]');
      if (changelogBtn) {
        var btn = document.createElement('button');
        btn.className = 'nav-item';
        btn.id = 'earlyAccessNavBtn';
        btn.dataset.page = 'earlyaccess';
        btn.setAttribute('onclick', "navTo('earlyaccess')");
        btn.style.cssText = 'background:linear-gradient(135deg,rgba(0,229,176,0.1),rgba(167,139,250,0.07));border:1px solid rgba(0,229,176,0.3);color:var(--teal)';
        btn.innerHTML = '<span class="icon">&#x26A1;</span>Early Access<span class="nav-badge" style="background:linear-gradient(135deg,#00e5b0,#a78bfa);color:#000;font-weight:900">NEW</span>';
        changelogBtn.insertAdjacentElement('afterend', btn);
      }
      // Also add to mobile nav if exists
      var mobChangelog = document.getElementById('mob-changelog');
      if (mobChangelog) {
        var mobBtn = document.createElement('button');
        mobBtn.className = 'mob-nav-btn';
        mobBtn.id = 'mob-earlyaccess';
        mobBtn.setAttribute('onclick', "navTo('earlyaccess')");
        mobBtn.innerHTML = '<span>&#x26A1;</span><span>Early</span>';
        mobChangelog.insertAdjacentElement('afterend', mobBtn);
      }
    }
  } else {
    // Remove the nav button â€” 7 days up or not EA
    if (existing) existing.remove();
    var mobEa = document.getElementById('mob-earlyaccess');
    if (mobEa) mobEa.remove();
  }
}


function navToPage(p) { navTo(p); }

function renderEarlyAccessPage() {
  var pc = document.getElementById('pageContent');
  if (!pc) return;

  var rel       = getLatestRelease();
  var releasedAt = rel ? (rel.releasedAt || rel.at || 0) : 0;
  var ageMs      = releasedAt ? (Date.now() - releasedAt) : EARLY_ACCESS_WINDOW_MS;
  var daysLeft   = Math.max(0, Math.ceil((EARLY_ACCESS_WINDOW_MS - ageMs) / (24 * 60 * 60 * 1000)));
  var pctGone    = Math.min(100, Math.round((ageMs / EARLY_ACCESS_WINDOW_MS) * 100));
  var userIsEA   = isEarlyAccessUser();

  // Build added pages list from the release
  var addedPages    = (rel && rel.addedPages)    || [];
  var addedFeatures = (rel && rel.addedFeatures) || [];
  var highlights    = (rel && rel.highlights)    || [];

  // Header badge
  var eaBadge = userIsEA
    ? '<span style="background:linear-gradient(135deg,#00e5b0,#a78bfa);color:#000;font-size:10px;font-weight:900;padding:3px 10px;border-radius:20px;letter-spacing:0.5px;vertical-align:middle">&#x26A1; EARLY ACCESS</span>'
    : '<span style="background:rgba(255,138,0,0.2);color:#ff8a00;font-size:10px;font-weight:900;padding:3px 10px;border-radius:20px;letter-spacing:0.5px;vertical-align:middle">PREVIEW</span>';

  // Countdown bar
  var countdownBar =
    '<div class="card" style="margin-bottom:20px;padding:18px 20px;background:linear-gradient(135deg,rgba(0,229,176,0.06),rgba(167,139,250,0.04));border:1px solid rgba(0,229,176,0.2)">' +
      '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">' +
        '<div style="font-size:13px;font-weight:800">' + (userIsEA ? '&#x26A1; You have early access' : '&#x23F1; Early Access Window') + '</div>' +
        (daysLeft > 0
          ? '<div style="font-size:12px;font-weight:900;color:var(--teal)">' + daysLeft + ' day' + (daysLeft !== 1 ? 's' : '') + ' left</div>'
          : '<div style="font-size:12px;font-weight:900;color:var(--muted)">Released to everyone</div>') +
      '</div>' +
      '<div style="height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin-bottom:8px">' +
        '<div style="height:100%;width:' + pctGone + '%;background:linear-gradient(90deg,var(--teal),var(--purple));border-radius:4px;transition:width 0.4s"></div>' +
      '</div>' +
      '<div style="font-size:11px;color:var(--muted)">' +
        (userIsEA
          ? 'You get instant access to all new features. Other users unlock them after 7 days.'
          : (daysLeft > 0
              ? 'These features unlock for everyone in ' + daysLeft + ' day' + (daysLeft !== 1 ? 's' : '') + '. Want instant access? Ask your admin about Early Access.'
              : 'The early access window has ended. All features are now available to everyone.')) +
      '</div>' +
    '</div>';

  // What's new this release
  var releaseCard = (rel)
    ? '<div class="card" style="margin-bottom:16px;padding:18px 20px">' +
        '<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">' +
          '<div style="font-size:26px">&#x1F680;</div>' +
          '<div>' +
            '<div style="font-size:15px;font-weight:900">' + (rel.title || (APP_VERSION + ' Update')) + '</div>' +
            '<div style="font-size:11px;color:var(--muted)">' + APP_VERSION + ' &middot; ' + (APP_FEATURE_MANIFEST.buildDate || '') + '</div>' +
          '</div>' +
          eaBadge +
        '</div>' +
        '<div style="font-size:13px;line-height:1.6;color:var(--text2);margin-bottom:12px">' + (rel.message || '') + '</div>' +
        (highlights.length
          ? '<ul style="margin:0;padding:0 0 0 18px;font-size:12px;color:var(--muted);line-height:2">' +
              highlights.map(function(h){ return '<li>' + h + '</li>'; }).join('') +
            '</ul>'
          : '') +
      '</div>'
    : '';

  // New pages grid â€” only shown if there are added pages
  var pagesGrid = '';
  if (addedPages.length > 0 || addedFeatures.length > 0) {
    var items = addedPages.map(function(p) {
      var title = (typeof pageTitles !== 'undefined' && pageTitles[p]) || p;
      var accessible = userIsEA || ageMs >= EARLY_ACCESS_WINDOW_MS;
      return '<div class="card" style="padding:14px 16px;cursor:' + (accessible ? 'pointer' : 'default') + ';opacity:' + (accessible ? '1' : '0.5') + ';border:1px solid ' + (accessible ? 'rgba(0,229,176,0.25)' : 'var(--border)') + '" ' +
        (accessible ? 'onclick="navToPage(\'' + p + '\')"' : '') + '>' +
        '<div style="font-size:20px;margin-bottom:6px">&#x2728;</div>' +
        '<div style="font-size:13px;font-weight:800;margin-bottom:4px">' + title + '</div>' +
        (accessible
          ? '<div style="font-size:11px;color:var(--teal);font-weight:700">Open &#x2192;</div>'
          : '<div style="font-size:11px;color:var(--muted)">Unlocks in ' + daysLeft + 'd</div>') +
      '</div>';
    });
    // Also show feature names that aren't pages
    addedFeatures.filter(function(f){ return addedPages.indexOf(f) === -1; }).slice(0, 4).forEach(function(f) {
      items.push(
        '<div class="card" style="padding:14px 16px;border:1px solid rgba(167,139,250,0.2)">' +
          '<div style="font-size:20px;margin-bottom:6px">&#x1F4A1;</div>' +
          '<div style="font-size:13px;font-weight:800;margin-bottom:4px">' + f + '</div>' +
          '<div style="font-size:11px;color:var(--muted)">Enhancement</div>' +
        '</div>'
      );
    });
    if (items.length) {
      pagesGrid =
        '<div style="font-size:11px;font-weight:900;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px">WHAT\' S NEW IN ' + APP_VERSION + '</div>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-bottom:20px">' +
          items.join('') +
        '</div>';
    }
  }

  // Changelog history
  var changelog = [];
  try { changelog = JSON.parse(localStorage.getItem('tv_changelog') || '[]'); } catch(e) {}
  var histRows = changelog.filter(function(c){ return c.autoGenerated; }).slice(0, 8).map(function(c) {
    return '<div style="display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">' +
      '<span style="font-size:16px;flex-shrink:0">&#x1F4CB;</span>' +
      '<div style="flex:1;min-width:0">' +
        '<div style="display:flex;align-items:center;gap:6px;margin-bottom:2px">' +
          '<span style="font-size:11px;font-weight:900;color:var(--teal)">' + (c.version || '') + '</span>' +
          '<span style="font-size:10px;color:var(--muted)">' + (c.date || '') + '</span>' +
        '</div>' +
        '<div style="font-size:12px;color:var(--text2)">' + (c.note || '') + '</div>' +
      '</div>' +
    '</div>';
  }).join('') || '<div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">No release history yet.</div>';

  pc.innerHTML =
    '<div style="max-width:720px;margin:0 auto">' +
      '<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">' +
        '<div>' +
          '<div style="font-family:var(--font-display);font-size:22px;font-weight:900">&#x26A1; Early Access</div>' +
          '<div style="font-size:12px;color:var(--muted);margin-top:2px">New features, first.</div>' +
        '</div>' +
      '</div>' +
      countdownBar +
      releaseCard +
      pagesGrid +
      '<div class="card" style="padding:16px 20px">' +
        '<div style="font-size:11px;font-weight:900;letter-spacing:1.5px;color:var(--muted);margin-bottom:12px">RELEASE HISTORY</div>' +
        histRows +
      '</div>' +
    '</div>';
}


function renderPublicChangelog() {
  var defaultLog = (typeof APP_FEATURE_MANIFEST !== 'undefined') ? APP_FEATURE_MANIFEST.changelog : [];
  var savedLog = []; try { savedLog = JSON.parse(localStorage.getItem('tv_changelog')||'[]'); } catch(e) {}
  var all = savedLog.concat(defaultLog.map(function(c) {
    var parts = c.split(': ');
    return {version: parts[0]||'', note: parts.slice(1).join(': ')||c, type:'feature', date:'2026'};
  }));
  var pc = document.getElementById('pageContent');
  if (!pc) return;
  var typeColors = {feature:'var(--teal)',fix:'var(--gold)',breaking:'var(--accent)'};
  pc.innerHTML =
    '<div style="max-width:700px;margin:0 auto">' +
    '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px">' +
      '<div><div style="font-family:var(--font-display);font-size:22px;font-weight:900">ðŸ“‹ What\'s New</div>' +
      '<div style="font-size:12px;color:var(--muted);margin-top:3px">TrendVid AI Â· Current build: <span style="color:var(--teal);font-weight:800">'+(typeof APP_VERSION!=='undefined'?APP_VERSION:'v15')+'</span></div></div>' +
      '<button onclick="shareWin(\'stats\',\'TrendVid AI just dropped '+(typeof APP_VERSION!=='undefined'?APP_VERSION:'v15')+' ðŸš€ Check out all the new features for creators! https://trendvid.ai\',0)" style="background:rgba(29,161,242,0.1);border:1px solid rgba(29,161,242,0.3);color:#1da1f2;border-radius:10px;padding:8px 16px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit">ð• Share update</button>' +
    '</div>' +
    '<div style="display:flex;flex-direction:column;gap:10px">' +
    all.slice(0,20).map(function(c) {
      var col = typeColors[c.type]||'var(--teal)';
      var typeLabel = c.type||'feature';
      return '<div class="card" style="display:flex;gap:14px;padding:16px">' +
        '<div style="flex-shrink:0;width:52px;text-align:right">' +
          '<div style="font-size:12px;font-weight:800;font-family:var(--font-display);color:var(--text)">'+esc(c.version||'')+'</div>' +
          '<div style="font-size:10px;color:var(--muted)">'+esc(c.date||'')+'</div>' +
        '</div>' +
        '<div style="width:2px;border-radius:1px;background:'+col+';flex-shrink:0"></div>' +
        '<div style="flex:1">' +
          '<span style="font-size:9px;font-weight:900;padding:2px 8px;border-radius:6px;text-transform:uppercase;letter-spacing:1px;background:rgba(0,229,176,0.1);color:'+col+'">'+typeLabel+'</span>' +
          '<div style="font-size:13px;color:var(--text2);margin-top:5px;line-height:1.5">'+esc(c.note||'')+'</div>' +
        '</div>' +
      '</div>';
    }).join('') +
    '</div>' +
    '<div style="text-align:center;margin-top:24px;font-size:12px;color:var(--muted)">Built with â¤ï¸ for creators Â· <a href="#" onclick="showSignup();return false" style="color:var(--accent);text-decoration:none">Start free at trendvid.ai</a></div>' +
    '</div>';
}

// ============================================================
// EMBED TREND WIDGET â€” self-contained iframe snippet
// ============================================================
function showEmbedWidget() {
  var existing = document.getElementById('embedWidgetModal');
  if (existing) { existing.remove(); return; }

  // Build the embeddable widget HTML
  var widgetHtml = '<!DOCTYPE html><html><head><meta charset="UTF-8">' +
    '<link href="https://fonts.googleapis.com/css2?family=Syne:wght@800;900&family=DM+Sans:wght@400;600&display=swap" rel="stylesheet">' +
    '<style>*{margin:0;padding:0;box-sizing:border-box;}body{font-family:"DM Sans",sans-serif;background:#060810;color:#fff;width:300px;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,0.1);}' +
    '.header{padding:14px 16px;background:linear-gradient(135deg,rgba(255,48,88,0.15),rgba(251,191,36,0.05));border-bottom:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:space-between;}' +
    '.logo{font-family:"Syne",sans-serif;font-size:13px;font-weight:900;letter-spacing:2px;color:rgba(255,255,255,0.9);}' +
    '.logo span{color:#ff3058;}' +
    '.badge{font-size:9px;font-weight:900;padding:3px 8px;background:rgba(255,48,88,0.2);color:#ff3058;border-radius:20px;letter-spacing:1px;}' +
    '.topic{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.06);display:flex;align-items:center;gap:10px;transition:background 0.15s;}' +
    '.topic:hover{background:rgba(255,255,255,0.04);}' +
    '.emoji{font-size:18px;width:28px;text-align:center;flex-shrink:0;}' +
    '.ttitle{font-size:12px;font-weight:700;line-height:1.3;color:rgba(255,255,255,0.9);}' +
    '.platform{font-size:10px;color:rgba(255,255,255,0.4);margin-top:2px;font-weight:600;}' +
    '.momentum{font-size:10px;padding:1px 7px;border-radius:10px;font-weight:800;margin-left:auto;flex-shrink:0;}' +
    '.hot{background:rgba(255,48,88,0.15);color:#ff3058;}' +
    '.rising{background:rgba(0,229,176,0.12);color:#00e5b0;}' +
    '.footer{padding:10px 16px;text-align:center;font-size:10px;color:rgba(255,255,255,0.3);border-top:1px solid rgba(255,255,255,0.06);}' +
    '.footer a{color:#ff3058;text-decoration:none;font-weight:700;}' +
    '</style></head><body>' +
    '<div class="header"><div class="logo">TREND<span>VID</span></div><div class="badge">ðŸ”¥ TRENDING</div></div>' +
    '<div class="topic"><div class="emoji">ðŸ“±</div><div><div class="ttitle">AI Tools for Creators</div><div class="platform">YouTube Â· Tech</div></div><div class="momentum hot">ðŸ”¥ Exploding</div></div>' +
    '<div class="topic"><div class="emoji">ðŸ’¸</div><div><div class="ttitle">Side Hustle Ideas 2026</div><div class="platform">TikTok Â· Finance</div></div><div class="momentum hot">ðŸ”¥ Hot</div></div>' +
    '<div class="topic"><div class="emoji">ðŸŽ®</div><div><div class="ttitle">Beginner Gaming Setup</div><div class="platform">YouTube Â· Gaming</div></div><div class="momentum rising">ðŸ“ˆ Rising</div></div>' +
    '<div class="topic"><div class="emoji">ðŸ³</div><div><div class="ttitle">5-Min Meal Prep Videos</div><div class="platform">Instagram Â· Food</div></div><div class="momentum rising">ðŸ“ˆ Rising</div></div>' +
    '<div class="topic"><div class="emoji">ðŸ§ </div><div><div class="ttitle">Productivity Hacks</div><div class="platform">TikTok Â· Lifestyle</div></div><div class="momentum hot">ðŸ”¥ Hot</div></div>' +
    '<div class="footer">Powered by <a href="https://trendvid.ai" target="_blank">TrendVid AI</a> Â· Free for creators</div>' +
    '</div></body></html>';

  var widgetBlob = new Blob([widgetHtml], {type:'text/html'});
  var widgetUrl = URL.createObjectURL(widgetBlob);
  var iframeSrc = widgetUrl;
  var embedCode = '<iframe src="https://trendvid.ai/widget/trends" width="300" height="295" frameborder="0" style="border-radius:16px;border:none" title="TrendVid Trending Topics"></iframe>';

  var modal = document.createElement('div');
  modal.id = 'embedWidgetModal';
  modal.style.cssText = 'position:fixed;inset:0;z-index:99990;background:rgba(0,0,0,0.75);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.2s ease';
  modal.innerHTML =
    '<div style="background:var(--surface);border:1px solid var(--border);border-radius:22px;padding:28px;max-width:700px;width:100%;box-shadow:0 24px 80px rgba(0,0,0,0.5);animation:slideUp 0.3s ease;max-height:90vh;overflow-y:auto">' +
      '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">' +
        '<div><div style="font-size:16px;font-weight:800">ðŸŒ Embed TrendVid Widget</div>' +
        '<div style="font-size:12px;color:var(--muted);margin-top:2px">Add a live trending topics widget to your website, blog or newsletter</div></div>' +
        '<button onclick="document.getElementById(\'embedWidgetModal\').remove()" style="background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:10px;padding:8px 14px;cursor:pointer;font-size:14px">âœ•</button>' +
      '</div>' +
      '<div style="display:grid;grid-template-columns:auto 1fr;gap:24px;align-items:start">' +
        '<div>' +
          '<div style="font-size:11px;font-weight:800;color:var(--muted);letter-spacing:1px;margin-bottom:8px">PREVIEW</div>' +
          '<iframe src="'+iframeSrc+'" width="300" height="295" frameborder="0" style="border-radius:16px;border:1px solid var(--border);display:block"></iframe>' +
        '</div>' +
        '<div>' +
          '<div style="font-size:11px;font-weight:800;color:var(--muted);letter-spacing:1px;margin-bottom:8px">EMBED CODE</div>' +
          '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;font-family:monospace;font-size:11px;color:var(--text2);word-break:break-all;line-height:1.6;margin-bottom:10px">'+esc(embedCode)+'</div>' +
          '<button onclick="safeCopy(\''+embedCode.replace(/'/g,"\\'").replace(/\n/g,'')+'\',\'Embed code copied!\',\'ðŸ“‹\')" class="btn btn-primary btn-sm" style="width:100%;margin-bottom:8px">ðŸ“‹ Copy Embed Code</button>' +
          '<div style="font-size:12px;color:var(--muted);line-height:1.6;margin-top:14px">' +
            '<div style="font-weight:800;color:var(--text);margin-bottom:8px">ðŸ“Œ Where to use it:</div>' +
            '<div style="display:flex;flex-direction:column;gap:6px">' +
              '<div style="display:flex;align-items:center;gap:8px"><span>ðŸ“</span><span>Your creator blog or website sidebar</span></div>' +
              '<div style="display:flex;align-items:center;gap:8px"><span>ðŸ“§</span><span>Newsletter footer (most ESPs support iframes)</span></div>' +
              '<div style="display:flex;align-items:center;gap:8px"><span>ðŸ’¬</span><span>Discord server info channel</span></div>' +
              '<div style="display:flex;align-items:center;gap:8px"><span>ðŸ”—</span><span>Linktree / bio link page</span></div>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>' +
    '</div>';
  modal.addEventListener('click', function(e){ if(e.target===modal) modal.remove(); });
  document.body.appendChild(modal);
}

// ============================================================
// CERTIFIED CREATOR BADGE â€” downloadable badge at XP milestones
// ============================================================
function showCertifiedBadge() {
  var d = getXPData();
  var badge = getCurrentBadge(d.level);
  var userName = (currentUser && currentUser.name) ? currentUser.name : 'Creator';
  var badgeEmoji = badge ? badge.emoji : 'ðŸŒ±';
  var badgeLabel = badge ? badge.badge : 'Seedling';
  var plan = (currentUser && currentUser.plan) ? currentUser.plan : 'free';

  // Determine certification tier
  var certTier = d.level >= 50 ? 'ELITE' : d.level >= 20 ? 'PRO' : d.level >= 10 ? 'ADVANCED' : 'CERTIFIED';
  var certColor = d.level >= 50 ? '#c084fc' : d.level >= 20 ? '#ff3058' : d.level >= 10 ? '#fbbf24' : '#00e5b0';

  var badgeHtml = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>TrendVid Certified Creator Badge</title>' +
    '<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800;900&display=swap" rel="stylesheet">' +
    '<style>*{margin:0;padding:0;box-sizing:border-box;}body{width:400px;height:160px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:transparent;}' +
    '.badge{width:380px;height:140px;border-radius:16px;background:linear-gradient(135deg,#0d1020,#111827);border:2px solid '+certColor+';display:flex;align-items:center;padding:20px 24px;gap:18px;position:relative;overflow:hidden;}' +
    '.glow{position:absolute;inset:0;background:radial-gradient(circle at 20% 50%,rgba('+certColor.replace('#','').match(/.{2}/g).map(h=>parseInt(h,16)).join(',') + ',0.12),transparent 60%);}' +
    '.emoji{font-size:42px;flex-shrink:0;position:relative;z-index:1;}' +
    '.info{position:relative;z-index:1;flex:1;}' +
    '.cert{font-size:10px;font-weight:900;letter-spacing:3px;color:'+certColor+';font-family:"Syne",sans-serif;text-transform:uppercase;}' +
    '.name{font-family:"Syne",sans-serif;font-size:20px;font-weight:900;color:#fff;line-height:1.1;margin-top:4px;}' +
    '.sub{font-size:11px;color:rgba(255,255,255,0.5);margin-top:4px;font-weight:600;}' +
    '.logo{position:absolute;right:20px;top:50%;transform:translateY(-50%);text-align:right;z-index:1;}' +
    '.logo-text{font-family:"Syne",sans-serif;font-size:13px;font-weight:900;letter-spacing:2px;color:rgba(255,255,255,0.4);}' +
    '.logo-text span{color:#ff3058;}' +
    '.logo-sub{font-size:9px;color:rgba(255,255,255,0.25);font-weight:600;margin-top:2px;letter-spacing:1px;}' +
    '.print-btn{position:fixed;top:10px;right:10px;background:'+certColor+';color:#000;border:none;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:800;cursor:pointer;font-family:"Syne",sans-serif;}' +
    '@media print{.print-btn{display:none;}body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}}' +
    '</style></head><body>' +
    '<button class="print-btn" onclick="window.print()">ðŸ’¾ Save Badge</button>' +
    '<div class="badge"><div class="glow"></div>' +
      '<div class="emoji">'+badgeEmoji+'</div>' +
      '<div class="info">' +
        '<div class="cert">âœ“ TrendVid '+certTier+' Creator</div>' +
        '<div class="name">'+esc(userName)+'</div>' +
        '<div class="sub">Level '+d.level+' Â· '+d.xp+' XP Â· '+badgeLabel+'</div>' +
      '</div>' +
      '<div class="logo"><div class="logo-text">TREND<span>VID</span></div><div class="logo-sub">AI STUDIO</div></div>' +
    '</div>' +
    '</body></html>';

  var blob = new Blob([badgeHtml], {type:'text/html'});
  window.open(URL.createObjectURL(blob), '_blank');
  notify('ðŸ… Badge opened â€” use Print â†’ Save as PDF to download!', 'success', 'ðŸŽ‰');
  shareWin('badge', badgeLabel, 0);
}

function renderLeaderboard() {
  var entries = getLeaderboardData();
  var pc = document.getElementById('pageContent');
  if (!pc) return;

  // Check if current user is #1
  var myPos = -1;
  if (currentUser) {
    entries.forEach(function(e, i) { if (e.email === currentUser.email) myPos = i; });
  }

  var topThreeHtml = '';
  var podium = entries.slice(0, 3);
  var medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
  var podiumColors = [
    'linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,215,0,0.05))',
    'linear-gradient(135deg,rgba(192,192,210,0.12),rgba(192,192,210,0.04))',
    'linear-gradient(135deg,rgba(180,120,40,0.12),rgba(180,120,40,0.04))'
  ];
  var podiumBorders = [
    'rgba(255,215,0,0.4)',
    'rgba(192,192,210,0.3)',
    'rgba(180,120,40,0.3)'
  ];

  // Podium (top 3) - centered display
  topThreeHtml = '<div style="display:flex;gap:10px;justify-content:center;margin-bottom:20px;flex-wrap:wrap">';
  // Pad podium to always show 3 slots
  while (podium.length < 3) {
    podium.push({name:'???', xp:0, level:1, badge:{emoji:'ðŸ‘¤',badge:'Empty'}, plan:'free', streak:0, isYou:false, empty:true});
  }
  podium.forEach(function(e, i) {
    if (e.empty) {
      topThreeHtml += '<div style="flex:1;min-width:140px;max-width:200px;background:rgba(255,255,255,0.02);border:2px dashed var(--border);border-radius:16px;padding:16px;text-align:center;opacity:0.4">';
      topThreeHtml += '<div style="font-size:28px;margin-bottom:4px">' + medals[i] + '</div>';
      topThreeHtml += '<div style="font-size:22px;margin-bottom:8px">ðŸ‘¤</div>';
      topThreeHtml += '<div style="font-weight:700;font-size:12px;color:var(--muted)">Empty slot</div>';
      topThreeHtml += '<div style="font-size:11px;color:var(--muted);margin-top:4px">Earn XP to claim</div>';
      topThreeHtml += '</div>';
      return;
    }
    var streak = e.streak > 0 ? '<div style="font-size:10px;color:var(--gold);margin-top:4px">ðŸ”¥ ' + e.streak + ' week streak</div>' : '';
    topThreeHtml += '<div style="flex:1;min-width:140px;max-width:200px;background:' + podiumColors[i] + ';border:2px solid ' + podiumBorders[i] + ';border-radius:16px;padding:16px;text-align:center;position:relative' + (e.isYou ? ';box-shadow:0 0 0 2px var(--accent)' : '') + '">';
    topThreeHtml += '<div style="font-size:28px;margin-bottom:4px">' + medals[i] + '</div>';
    topThreeHtml += '<div style="font-size:22px;margin-bottom:4px">' + (e.badge ? e.badge.emoji : 'ðŸŒ±') + '</div>';
    topThreeHtml += '<div style="font-weight:900;font-size:13px;margin-bottom:2px" title="' + e.email + '">' + (e.name.length > 14 ? e.name.substring(0,13)+'â€¦' : e.name) + (e.isYou ? ' ðŸ‘ˆ' : '') + '</div>';
    topThreeHtml += '<div style="font-size:11px;color:var(--muted)">' + (e.badge ? e.badge.badge : 'Seedling') + '</div>';
    topThreeHtml += '<div style="font-family:var(--font-display);font-size:18px;font-weight:900;margin-top:6px;color:' + (i===0?'#ffd700':i===1?'#c0c0d2':'#b47828') + '">' + e.xp.toLocaleString() + ' XP</div>';
    topThreeHtml += '<div style="font-size:10px;color:var(--muted)">LVL ' + e.level + '</div>';
    topThreeHtml += streak;
    topThreeHtml += '</div>';
  });
  topThreeHtml += '</div>';

  // Full leaderboard table
  var tableRows = '';
  entries.slice(0, 50).forEach(function(e, i) {
    var rankEmoji = i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : '#' + (i + 1);
    var streakBadge = e.streak >= 4 ? ' <span style="font-size:10px;background:rgba(255,215,0,0.15);color:var(--gold);padding:2px 6px;border-radius:6px;font-weight:700">ðŸ† CHAMPION</span>' : 
                       e.streak >= 2 ? ' <span style="font-size:10px;background:rgba(255,138,0,0.12);color:#ff8a00;padding:2px 6px;border-radius:6px">ðŸ”¥ ' + e.streak + 'wk</span>' : '';
    tableRows += '<tr style="border-bottom:1px solid var(--border);' + (e.isYou ? 'background:rgba(255,48,88,0.04);' : '') + '">';
    tableRows += '<td style="padding:10px 12px;font-size:13px;font-weight:700;color:' + (i<3?'var(--gold)':'var(--muted)') + ';text-align:center;width:36px">' + rankEmoji + '</td>';
    tableRows += '<td style="padding:10px 8px"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">' + (e.badge ? e.badge.emoji : 'ðŸŒ±') + '</span><div><div style="font-size:13px;font-weight:700">' + (e.name.length > 20 ? e.name.substring(0,19)+'â€¦' : e.name) + (e.isYou ? ' <span style="font-size:10px;color:var(--accent);font-weight:700">YOU</span>' : '') + streakBadge + '</div><div style="font-size:11px;color:var(--muted)">' + (e.badge ? e.badge.badge : 'Seedling') + ' Â· LVL ' + e.level + '</div></div></div></td>';
    tableRows += '<td style="padding:10px 8px;text-align:right;font-family:var(--font-display);font-size:15px;font-weight:900;color:var(--accent2)">' + e.xp.toLocaleString() + '</td>';
    tableRows += '<td style="padding:10px 8px;text-align:right"><span class="tier-badge tier-' + (e.plan||'free') + '">' + (e.plan||'free').toUpperCase() + '</span></td>';
    tableRows += '</tr>';
  });

  // My position callout (if not in top 50)
  var myCallout = '';
  if (myPos >= 50 && currentUser) {
    var me = entries[myPos];
    myCallout = '<div class="card" style="margin-top:12px;background:rgba(255,48,88,0.05);border-color:rgba(255,48,88,0.2);text-align:center">' +
      '<div style="font-size:12px;color:var(--muted);margin-bottom:4px">YOUR POSITION</div>' +
      '<div style="font-size:20px;font-weight:900;font-family:var(--font-display)">#' + (myPos+1) + '</div>' +
      '<div style="font-size:12px;color:var(--muted)">' + (me ? me.xp : 0) + ' XP Â· Keep going to climb the board! ðŸš€</div>' +
    '</div>';
  }

  pc.innerHTML = 
    '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px">' +
      '<div>' +
        '<div class="section-label" style="margin-bottom:2px">ðŸ† GLOBAL LEADERBOARD</div>' +
        '<div style="font-size:12px;color:var(--muted)">Top creators ranked by total XP Â· Updates live</div>' +
      '</div>' +
      '<div style="display:flex;gap:8px">' +
        '<button class="btn btn-ghost btn-sm" onclick="renderLeaderboard()" title="Refresh">ðŸ”„ Refresh</button>' +
        '<button class="btn btn-primary btn-sm" onclick="navTo(\&quot;xp\&quot;)">â­ My XP</button>' +
      '</div>' +
    '</div>' +
    (entries.length < 2 ? 
      '<div class="card" style="text-align:center;padding:40px">' +
        '<div style="font-size:48px;margin-bottom:12px">ðŸ†</div>' +
        '<div style="font-size:16px;font-weight:800;margin-bottom:8px">Leaderboard Coming Soon!</div>' +
        '<div style="font-size:13px;color:var(--muted);max-width:300px;margin:0 auto">More creators need to join to build the leaderboard. Earn XP now to claim your spot at the top!</div>' +
        '<button class="btn btn-primary" style="margin-top:16px" onclick="navTo(\&quot;xp\&quot;)">â­ Earn XP Now â†’</button>' +
      '</div>'
      :
      topThreeHtml +
      '<div class="card" style="padding:0;overflow:hidden">' +
        '<div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">' +
          '<div style="font-size:12px;font-weight:700;color:var(--muted);letter-spacing:1px">ALL CREATORS (' + entries.length + ')</div>' +
          '<div style="font-size:11px;color:var(--muted)">Top 50 shown</div>' +
        '</div>' +
        '<div style="overflow-x:auto">' +
          '<table style="width:100%;border-collapse:collapse">' +
            '<thead><tr style="border-bottom:1px solid var(--border)">' +
              '<th style="padding:8px 12px;text-align:center;font-size:10px;color:var(--muted);font-weight:700">#</th>' +
              '<th style="padding:8px;text-align:left;font-size:10px;color:var(--muted);font-weight:700">CREATOR</th>' +
              '<th style="padding:8px;text-align:right;font-size:10px;color:var(--muted);font-weight:700">XP</th>' +
              '<th style="padding:8px;text-align:right;font-size:10px;color:var(--muted);font-weight:700">PLAN</th>' +
            '</tr></thead>' +
            '<tbody>' + tableRows + '</tbody>' +
          '</table>' +
        '</div>' +
      '</div>' +
      myCallout
    );
}

// ============================================================
// 4-WEEK #1 STREAK TRACKER + ADMIN NOTIFICATION
// ============================================================
function checkLeaderboardRewards() {
  if (!currentUser) return;
  var entries = getLeaderboardData();
  if (entries.length < 2) return;

  var topUser = entries[0];
  var isFirst = topUser.email === currentUser.email;

  var streaks = {};
  try { streaks = JSON.parse(localStorage.getItem('tv_lb_streaks') || '{}'); } catch(e) {}

  var weekKey = 'week_' + getWeekNumber();
  var myKey = currentUser.email;
  
  if (isFirst) {
    if (!streaks[weekKey]) streaks[weekKey] = {};
    streaks[weekKey][myKey] = (streaks[weekKey][myKey] || 0) + 1;
  }
  
  // Count consecutive weeks at #1
  var consecutiveWeeks = 0;
  var now = new Date();
  for (var w = 0; w < 52; w++) {
    var d = new Date(now);
    d.setDate(d.getDate() - w * 7);
    var wk = 'week_' + getWeekNumberForDate(d);
    if (streaks[wk] && streaks[wk][myKey]) {
      consecutiveWeeks++;
    } else {
      break;
    }
  }

  // Save streak to user record
  var users = [];
  try { users = JSON.parse(localStorage.getItem('tv_all_users') || '[]'); } catch(e) {}
  var userRec = users.find(function(u) { return u.email === currentUser.email; });
  if (userRec) {
    userRec.leaderboard_streak = consecutiveWeeks;
    if (isFirst) userRec.leaderboard_first_at = Date.now();
    try { localStorage.setItem('tv_all_users', JSON.stringify(users)); } catch(e) {}
  }

  try { localStorage.setItem('tv_lb_streaks', JSON.stringify(streaks)); } catch(e) {}

  // Check for 4-week reward
  var rewardKey = 'tv_lb_reward_' + getWeekNumber();
  if (consecutiveWeeks >= 4 && !localStorage.getItem(rewardKey)) {
    localStorage.setItem(rewardKey, '1');
    // Grant reward: +500 XP bonus
    var bonusXP = parseInt(localStorage.getItem('tv_xp_bonus') || '0') + 500;
    localStorage.setItem('tv_xp_bonus', bonusXP.toString());
    // Show reward notification
    setTimeout(function() {
      showChampionReward(consecutiveWeeks);
    }, 1500);
    // Log admin notification
    var adminNotifs = [];
    try { adminNotifs = JSON.parse(localStorage.getItem('tv_admin_notifs') || '[]'); } catch(e) {}
    adminNotifs.unshift({
      type: 'champion_streak',
      user: currentUser.email,
      name: currentUser.name,
      weeks: consecutiveWeeks,
      at: new Date().toISOString(),
      read: false
    });
    try { localStorage.setItem('tv_admin_notifs', JSON.stringify(adminNotifs.slice(0, 100))); } catch(e) {}
    // Update admin notification badge
    updateAdminNotifBadge();
  }

  if (consecutiveWeeks >= 4) updateAdminNotifBadge();
}

function showChampionReward(weeks) {
  var existing = document.getElementById('championRewardModal');
  if (existing) existing.remove();
  var modal = document.createElement('div');
  modal.id = 'championRewardModal';
  modal.className = 'modal-overlay show';
  modal.innerHTML = '<div class="modal-box" style="max-width:420px;text-align:center">' +
    '<div style="font-size:60px;margin-bottom:8px;animation:pulse 1s ease infinite">ðŸ†</div>' +
    '<div style="font-family:var(--font-display);font-size:24px;font-weight:900;background:linear-gradient(135deg,var(--gold),#ff8a00);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px">LEADERBOARD CHAMPION!</div>' +
    '<div style="font-size:14px;color:var(--muted);margin-bottom:20px">You\'ve been #1 for <strong>' + weeks + ' weeks straight</strong> ðŸ”¥</div>' +
    '<div style="background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,138,0,0.08));border:2px solid rgba(255,215,0,0.4);border-radius:14px;padding:20px;margin-bottom:20px">' +
      '<div style="font-size:12px;color:var(--gold);font-weight:700;letter-spacing:1px;margin-bottom:8px">ðŸŽ CHAMPION REWARD UNLOCKED</div>' +
      '<div style="font-size:28px;font-weight:900;font-family:var(--font-display)">+500 XP</div>' +
      '<div style="font-size:12px;color:var(--muted)">Bonus XP added to your account</div>' +
    '</div>' +
    '<div style="font-size:12px;color:var(--muted);margin-bottom:16px">Keep it up! Rewards increase for longer streaks.</div>' +
    '<button class="btn btn-primary" style="width:100%" onclick="document.getElementById(\&quot;championRewardModal\&quot;).remove()">Let\'s Go! ðŸš€</button>' +
  '</div>';
  document.body.appendChild(modal);
  updateXPSidebarChip();
}

function adminClearNotifs() {
  localStorage.removeItem('tv_admin_notifs');
  renderAdmin();
}


function updateAdminNotifBadge() {
  var notifs = [];
  try { notifs = JSON.parse(localStorage.getItem('tv_admin_notifs') || '[]'); } catch(e) {}
  var unread = notifs.filter(function(n) { return !n.read; }).length;
  ['adminNotifBadge','adminNotifBadgeMobile'].forEach(function(id) {
    var badge = document.getElementById(id);
    if (badge) {
      badge.textContent = unread > 0 ? unread : '';
      badge.style.display = unread > 0 ? 'inline-flex' : 'none';
    }
  });
}

function getWeekNumber() {
  return getWeekNumberForDate(new Date());
}

function getWeekNumberForDate(d) {
  var date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7));
  var yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
  return date.getUTCFullYear() + '_W' + String(Math.ceil((((date - yearStart) / 86400000) + 1) / 7)).padStart(2, '0');
}

// Save XP total to user record every time XP changes (for leaderboard)
function syncXPToUserRecord() {
  if (!currentUser) return;
  var xpData = getXPData();
  var users = [];
  try { users = JSON.parse(localStorage.getItem('tv_all_users') || '[]'); } catch(e) {}
  var found = false;
  for (var i = 0; i < users.length; i++) {
    if (users[i].email === currentUser.email) {
      users[i].xp_total = xpData.xp;
      users[i].level = xpData.level;
      found = true;
      break;
    }
  }
  if (!found) {
    users.unshift({
      email: currentUser.email,
      name: currentUser.name || 'Creator',
      plan: currentUser.plan || 'free',
      xp_total: xpData.xp,
      level: xpData.level,
      leaderboard_streak: 0,
      joinedAt: Date.now()
    });
  }
  try { localStorage.setItem('tv_all_users', JSON.stringify(users.slice(0, 500))); } catch(e) {}
}

// ============================================================
// ADMIN: XP MANAGEMENT + LEVELS + BADGES
// Extends existing renderAdmin with new 'xp' and 'levels' tabs
// ============================================================

// Admin: adjust any user's XP
function adminXPRowAdjust(btn, setMode) {
  var row = btn.closest('tr');
  if (!row) return;
  var inp = row.querySelector('.xp-row-input');
  if (!inp) return;
  var email = inp.dataset.email;
  var val = parseInt(inp.value || '0');
  if (!email) { notify('No email found', 'error', 'âš ï¸'); return; }
  adminSetUserXP(email, setMode ? 0 : val, setMode ? val : undefined);
  renderAdmin();
}

function adminXPQuickAdjust(setMode) {
  var em = (document.getElementById('xpAdminUser') || {}).value;
  var val = parseInt(((document.getElementById('xpAdminAmount') || {}).value) || '0');
  if (!em) { notify('Select a user', 'error', 'âš ï¸'); return; }
  adminSetUserXP(em, setMode ? 0 : val, setMode ? val : undefined);
  renderAdmin();
}


function adminSetUserXP(email, delta, absolute) {
  var users = [];
  try { users = JSON.parse(localStorage.getItem('tv_all_users') || '[]'); } catch(e) {}
  var user = users.find(function(u) { return u.email === email; });
  if (!user) { notify('User not found: ' + email, 'error', 'âš ï¸'); return; }

  var current = user.xp_total || 0;
  if (absolute) {
    user.xp_total = Math.max(0, parseInt(absolute));
  } else {
    user.xp_total = Math.max(0, current + parseInt(delta));
  }
  user.level = Math.max(1, Math.floor(user.xp_total / XP_PER_LEVEL) + 1);

  try { localStorage.setItem('tv_all_users', JSON.stringify(users)); } catch(e) {}

  // If it's the current user, also update bonus XP to sync
  if (currentUser && currentUser.email === email) {
    // Recalculate bonus: bonusXP = total - earned
    var earnedXP = 0;
    XP_ACTIONS.forEach(function(a) { if(localStorage.getItem('tv_check_'+a.key)) earnedXP += a.xp; });
    var scripts = []; try { scripts = JSON.parse(localStorage.getItem('tv_scripts')||'[]'); } catch(e2) {}
    if(scripts.length >= 10) earnedXP += 30;
    if(scripts.length >= 50) earnedXP += 100;
    var newBonus = user.xp_total - earnedXP;
    localStorage.setItem('tv_xp_bonus', Math.max(0, newBonus).toString());
    updateXPSidebarChip();
  }

  var fb = document.getElementById('xpAdminFeedback');
  if (fb) fb.textContent = 'âœ… ' + email + ' XP set to ' + user.xp_total + ' (Level ' + user.level + ')';
  notify(email + ' â†’ ' + user.xp_total + ' XP (Lvl ' + user.level + ')', 'success', 'â­');
}

// Admin: manage custom levels and badges
var _customLevels = null;
function getCustomLevels() {
  if (_customLevels) return _customLevels;
  try {
    var saved = localStorage.getItem('tv_custom_levels');
    if (saved) {
      _customLevels = JSON.parse(saved);
      return _customLevels;
    }
  } catch(e) {}
  _customLevels = JSON.parse(JSON.stringify(XP_LEVELS)); // deep copy
  return _customLevels;
}

function saveCustomLevels(levels) {
  _customLevels = levels;
  try { localStorage.setItem('tv_custom_levels', JSON.stringify(levels)); } catch(e) {}
}

function adminAddLevel() {
  var levels = getCustomLevels();
  var maxLevel = levels.reduce(function(m, l) { return Math.max(m, l.level); }, 0);
  var newLevel = {
    level: maxLevel + 1,
    emoji: document.getElementById('newLevelEmoji') ? document.getElementById('newLevelEmoji').value || 'â­' : 'â­',
    badge: document.getElementById('newLevelBadge') ? document.getElementById('newLevelBadge').value || 'New Badge' : 'New Badge',
    title: document.getElementById('newLevelTitle') ? document.getElementById('newLevelTitle').value || 'Custom Level' : 'Custom Level',
    desc: document.getElementById('newLevelDesc') ? document.getElementById('newLevelDesc').value || '' : '',
    glow: 'rgba(255,48,88,0.4)',
    color: '#ff3058'
  };
  levels.push(newLevel);
  saveCustomLevels(levels);
  notify('Level ' + newLevel.level + ' added: ' + newLevel.badge, 'success', 'â­');
  window._adminTab = 'levels';
  renderAdmin();
}

function adminLevelFieldChange(input) {
  var level = parseInt(input.dataset.level);
  var field  = input.dataset.field;
  var value  = input.value;
  if (typeof adminEditLevelField === 'function') adminEditLevelField(level, field, value);
}


function adminEditLevelField(level, field, value) {
  var levels = getCustomLevels();
  var lev = levels.find(function(l) { return l.level === level; });
  if (lev) {
    lev[field] = value;
    saveCustomLevels(levels);
  }
}

function adminDeleteLevel(level) {
  if (!confirm('Delete Level ' + level + '? This cannot be undone.')) return;
  var levels = getCustomLevels();
  levels = levels.filter(function(l) { return l.level !== level; });
  saveCustomLevels(levels);
  window._adminTab = 'levels';
  renderAdmin();
}

// ============================================================
// PATCHED renderAdmin â€” adds XP, Levels, Notifications tabs
// ============================================================



function updateProviderUI(providerType) {
  var pills = document.querySelectorAll('.ai-status-pill span');
  var dot = document.querySelector('.ai-status-dot');
  var provName = providerType === 'gemini' ? 'Gemini AI' : 'Groq AI';
  var provColor = providerType === 'gemini' ? '#a78bfa' : 'var(--teal)';
  pills.forEach(function(p) { if (p.textContent.includes('AI')) p.textContent = provName + ' Â· Active'; });
  if (dot) dot.style.background = provColor;
}

// ============================================================
// RELEASE HELPERS
// ============================================================
function showPrivacyPolicy() {
  document.getElementById('privacyModal').classList.add('show');
}
function showTermsOfService() {
  document.getElementById('termsModal').classList.add('show');
}

// Cookie consent check on load
function initCookieBanner() {
  if (!localStorage.getItem('tv_cookies_ok') && !localStorage.getItem('tv_cookies_declined')) {
    // Only show on landing page
    setTimeout(function() {
      var banner = document.getElementById('cookieBanner');
      if (banner && document.getElementById('landingPage').style.display !== 'none') {
        banner.style.display = 'block';
      }
    }, 2000);
  }
}

// showSignup â€” alias for showLogin but pre-selects signup tab
// Escape to close modals handled by main keydown listener


// ============================================================
// FIRST-TIME ONBOARDING TOUR
// ============================================================
var _tourSteps = [
  {target:'dashboard', emoji:'ðŸ ', title:'Your Dashboard',        body:'This is your command centre. See your stats, recent scripts, trending topics, and quick actions â€” all in one place.'},
  {target:'trends',    emoji:'ðŸ“ˆ', title:'Trend Radar',           body:'Scan YouTube, TikTok & Instagram for what\'s going viral right now. Click any trend to instantly generate a full script.'},
  {target:'script',    emoji:'âœï¸', title:'Script Generator',      body:'Generate complete, ready-to-film video scripts in seconds. Enter any topic and let AI do the heavy lifting.'},
  {target:'thumbnail', emoji:'ðŸŽ¨', title:'Thumbnail AI',          body:'Create eye-catching thumbnails with AI. Upload your face or use generated imagery to match your brand.'},
  {target:'calendar',  emoji:'ðŸ“…', title:'Content Calendar',      body:'Plan your uploads weeks ahead. Drag-and-drop scheduling keeps you consistent and on-trend.'},
  {target:'xp',        emoji:'â­', title:'XP & Levels',           body:'Every action earns XP. Level up to unlock badges, titles, and leaderboard glory. Compete with creators worldwide!'},
  {target:'settings',  emoji:'âš™ï¸', title:'Power Up with AI Keys', body:'Add your free Gemini or Groq API key in Settings to unlock full AI power. Takes 30 seconds and it\'s completely free.'},
  {target:'dashboard', emoji:'ðŸ¤–', title:'AI Self-Heal is ON',    body:'The ðŸ¤– orb at the bottom-right runs silently in the background, auto-fixing any broken buttons or bugs for you â€” no action needed!'},
];
var _tourIdx = 0;
var _tourEl = null;

function startTour() {
  _tourIdx = 0;
  showTourStep();
}

// Full-screen tutorial modal for first-time users
function showAppTutorial(userName) {
  if (localStorage.getItem('tv_tutorial_done')) return;
  if (window.currentUser && window.currentUser.isAdmin) return;
  var steps = _tourSteps;
  var idx = 0;

  function render() {
    var existing = document.getElementById('tvTutorialOverlay');
    if (existing) existing.remove();

    var step = steps[idx];
    var overlay = document.createElement('div');
    overlay.id = 'tvTutorialOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:99998;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(14px);animation:fadeIn 0.3s ease;';

    var dots = steps.map(function(s, i) {
      return '<div style="width:' + (i===idx?'22px':'7px') + ';height:7px;border-radius:4px;background:' + (i===idx?'var(--teal)':i<idx?'rgba(0,229,176,0.35)':'rgba(255,255,255,0.15)') + ';transition:all 0.3s;"></div>';
    }).join('');

    var isLast = idx === steps.length - 1;
    overlay.innerHTML =
      '<div style="background:var(--surface);border:1px solid var(--border2);border-radius:28px;padding:44px 40px;width:100%;max-width:500px;margin:16px;text-align:center;animation:slideUp 0.4s cubic-bezier(0.34,1.56,0.64,1);position:relative;box-shadow:0 24px 80px rgba(0,0,0,0.7);">' +
        '<button onclick="document.getElementById(\'tvTutorialOverlay\').remove();localStorage.setItem(\'tv_tutorial_done\',\'1\');if(typeof navTo===\'function\')navTo(\'dashboard\');" ' +
          'style="position:absolute;top:16px;right:16px;background:rgba(255,255,255,0.05);border:1px solid var(--border);color:var(--muted);border-radius:8px;width:28px;height:28px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;">âœ•</button>' +
        '<div style="font-size:58px;margin-bottom:14px;animation:float 3s ease infinite;">' + step.emoji + '</div>' +
        '<div style="font-family:var(--font-display);font-size:26px;font-weight:900;letter-spacing:-0.5px;margin-bottom:10px;">' + step.title + '</div>' +
        '<div style="font-size:15px;color:var(--text2);line-height:1.7;margin-bottom:30px;max-width:360px;margin-left:auto;margin-right:auto;">' + step.body + '</div>' +
        '<div style="display:flex;gap:8px;justify-content:center;margin-bottom:28px;">' + dots + '</div>' +
        '<div style="display:flex;gap:10px;justify-content:center;">' +
          (idx > 0 ? '<button onclick="window._tvTutIdx=Math.max(0,window._tvTutIdx-1);window._tvTutRender();" style="background:var(--surface2);border:1px solid var(--border);color:var(--text2);padding:12px 24px;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;">â† Back</button>' : '') +
          '<button onclick="window._tvTutIdx++;if(window._tvTutIdx<' + steps.length + '){window._tvTutRender();}else{document.getElementById(\'tvTutorialOverlay\').remove();localStorage.setItem(\'tv_tutorial_done\',\'1\');if(typeof navTo===\'function\')navTo(\'dashboard\');notify(\'You\'re all set, ' + (userName||'Creator') + '! Let\'s go viral ðŸš€\',\'success\',\'ðŸŽ‰\');}" ' +
            'style="background:linear-gradient(135deg,var(--teal),var(--purple));border:none;color:#fff;padding:12px 32px;border-radius:12px;font-size:14px;font-weight:900;cursor:pointer;font-family:var(--font-display);box-shadow:0 4px 20px rgba(0,229,176,0.35);">' +
            (isLast ? 'ðŸš€ Let\'s Go!' : 'Next â†’') +
          '</button>' +
        '</div>' +
        '<div style="margin-top:18px;font-size:11px;color:var(--muted);">' + (idx+1) + ' of ' + steps.length + ' Â· <span style="cursor:pointer;text-decoration:underline;" onclick="document.getElementById(\'tvTutorialOverlay\').remove();localStorage.setItem(\'tv_tutorial_done\',\'1\');if(typeof navTo===\'function\')navTo(\'dashboard\');">Skip tour</span></div>' +
      '</div>';

    // Navigate to the page this step shows
    if (typeof navTo === 'function') navTo(step.target);
    document.body.appendChild(overlay);
  }

  window._tvTutIdx = 0;
  window._tvTutRender = function() {
    idx = window._tvTutIdx;
    render();
  };
  render();
}

function showTourStep() {
  if (_tourEl) _tourEl.remove();
  if (_tourIdx >= _tourSteps.length) {
    endTour();
    return;
  }
  var step = _tourSteps[_tourIdx];
  var totalSteps = _tourSteps.length;

  _tourEl = document.createElement('div');
  _tourEl.id = 'tourTooltip';
  _tourEl.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:99997;background:var(--surface);border:1px solid rgba(0,229,176,0.4);border-radius:16px;padding:20px;box-shadow:0 8px 40px rgba(0,0,0,0.5);max-width:320px;width:90%;animation:slideDown 0.3s ease';
  _tourEl.innerHTML = 
    '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">' +
      '<div style="font-size:15px;font-weight:800">' + step.title + '</div>' +
      '<button onclick="endTour()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;padding:0;line-height:1;flex-shrink:0;margin-left:8px">âœ•</button>' +
    '</div>' +
    '<div style="font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:16px">' + step.body + '</div>' +
    '<div style="display:flex;align-items:center;justify-content:space-between">' +
      '<div style="font-size:11px;color:var(--muted)">' + (_tourIdx+1) + ' / ' + totalSteps + '</div>' +
      '<div style="display:flex;gap:8px">' +
        (_tourIdx > 0 ? '<button class="btn btn-ghost btn-sm" onclick="tourBack()">â† Back</button>' : '') +
        '<button class="btn btn-primary btn-sm" onclick="tourNext()">' + (_tourIdx === totalSteps-1 ? "Let us go! ðŸš€" : 'Next â†’') + '</button>' +
      '</div>' +
    '</div>' +
    '<div style="display:flex;gap:4px;margin-top:12px;justify-content:center">' +
      _tourSteps.map(function(s,i) {
        return '<div style="width:' + (i===_tourIdx?'20px':'6px') + ';height:6px;border-radius:3px;background:' + (i===_tourIdx?'var(--teal)':'var(--border2)') + ';transition:all 0.3s"></div>';
      }).join('') +
    '</div>';
  document.body.appendChild(_tourEl);

  // Navigate to the step's target page
  if (typeof navTo === 'function') navTo(step.target);
}

function tourNext() {
  _tourIdx++;
  showTourStep();
}

function tourBack() {
  _tourIdx = Math.max(0, _tourIdx - 1);
  showTourStep();
}

function endTour() {
  if (_tourEl) { _tourEl.remove(); _tourEl = null; }
  localStorage.setItem('tv_tour_done', '1');
  notify('Tour complete! You\'re all set ðŸŽ‰', 'success', 'ðŸš€');
}

function maybeStartTour() {
  if (!localStorage.getItem('tv_tour_done') && !localStorage.getItem('tv_tutorial_done') && currentUser && !currentUser.isAdmin) {
    // For returning users who haven't seen the tutorial yet (they already entered their name)
    var isNew = !(currentUser.name && currentUser.name !== 'Creator' && currentUser.name !== 'Demo Creator');
    if (!isNew) {
      // Returning user who somehow missed the tutorial â€” show it after a short delay
      setTimeout(function() { if (typeof showAppTutorial === 'function') showAppTutorial(currentUser.name); }, 2500);
    }
    // Mark old tour as done so it doesn't fire the small tooltip version
    localStorage.setItem('tv_tour_done', '1');
  }
}


// ============================================================
// KEYBOARD SHORTCUTS
// ============================================================
document.addEventListener('keydown', function(e) {
  // Only when app is active, not typing in an input
  if (!currentUser) return;
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
  if (e.ctrlKey || e.metaKey) {
    switch(e.key) {
      case 'k': e.preventDefault(); navTo('script'); break;        // Ctrl+K = Script
      case 't': e.preventDefault(); navTo('trends'); break;        // Ctrl+T = Trends
      case 'l': e.preventDefault(); navTo('library'); break;       // Ctrl+L = Library
      case 'd': e.preventDefault(); navTo('dashboard'); break;     // Ctrl+D = Dashboard
      case ',': e.preventDefault(); navTo('settings'); break;      // Ctrl+, = Settings
    }
  }
});


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMMAND PALETTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _CMD_PAGES = [
  {icon:'ðŸ ', label:'Dashboard',          page:'dashboard'},
  {icon:'ðŸ†', label:'Leaderboard',        page:'leaderboard'},
  {icon:'ðŸ“ˆ', label:'Trend Radar',         page:'trends'},
  {icon:'âœï¸', label:'Script Generator',   page:'script'},
  {icon:'ðŸŽ¨', label:'Thumbnail AI',        page:'thumbnail'},
  {icon:'ðŸ“š', label:'Script Library',      page:'library'},
  {icon:'ðŸ“…', label:'Content Calendar',    page:'calendar'},
  {icon:'â­', label:'Favourites',          page:'favourites'},
  {icon:'ðŸŒ', label:'Multi-Language',      page:'multilang'},
  {icon:'ðŸŽ™ï¸', label:'Voice to Script',    page:'voice'},
  {icon:'ðŸ“º', label:'Teleprompter',        page:'teleprompter'},
  {icon:'#ï¸âƒ£', label:'Hashtag & SEO',      page:'hashtags'},
  {icon:'âš¡', label:'Hook Tester',         page:'hooktester'},
  {icon:'â™»ï¸', label:'Script Repurposer',   page:'repurpose'},
  {icon:'ðŸŽ¨', label:'Brand Kit',           page:'brandkit'},
  {icon:'ðŸ””', label:'Trend Alerts',        page:'alerts'},
  {icon:'ðŸ†š', label:'A/B Title Tester',    page:'abtitle'},
  {icon:'ðŸ”­', label:'Content Gap Finder',  page:'gapfinder'},
  {icon:'ðŸš€', label:'Viral Score',         page:'viral'},
  {icon:'ðŸ“Š', label:'Channel Health',      page:'health'},
  {icon:'ðŸŽ¬', label:'B-Roll Ideas',        page:'broll'},
  {icon:'ðŸŽµ', label:'Music Picks',         page:'music'},
  {icon:'ðŸ’¬', label:'Caption Generator',   page:'captions'},
  {icon:'ðŸ’­', label:'Comment Replies',     page:'comments'},
  {icon:'âœ¨', label:'Script Improver',     page:'improver'},
  {icon:'ðŸŽ', label:'Gift Codes',          page:'giftcodes'},
  {icon:'ðŸŽµ', label:'Soundtrack Finder',   page:'soundtrack'},
  {icon:'ðŸ“¦', label:'Bundle Deals',        page:'bundles'},
  {icon:'ðŸ“º', label:'YouTube Analyser',    page:'ytanalyse'},
  {icon:'ðŸ“', label:'Description Gen',     page:'descgen'},
  {icon:'ðŸ†š', label:'Thumbnail A/B',       page:'thumbab'},
  {icon:'ðŸ¤', label:'Collab Finder',       page:'collab'},
  {icon:'ðŸ—“ï¸', label:'Post Scheduler',      page:'scheduler'},
  {icon:'ðŸ’Ž', label:'Plans & Pricing',     page:'pricing'},
  {icon:'â­', label:'XP & Levels',         page:'xp'},
  {icon:'âš™ï¸', label:'Settings',            page:'settings'},
  {icon:'ðŸ’¬', label:'Help & AI Chat',      page:'help'},
  {icon:'ðŸ›¡ï¸', label:'Admin Panel',         page:'admin', adminOnly:true},
  // Actions
  {icon:'ðŸšª', label:'Log Out',             action:'logout'},
  {icon:'ðŸŒ™', label:'Toggle Dark/Light Mode', action:'toggleTheme'},
  {icon:'ðŸ›', label:'Report a Bug',        action:'reportBug'},
];

var _cmdSelectedIdx = 0;

function openCmdPalette() {
  var el = document.getElementById('cmdPalette');
  if (!el) return;
  el.style.display = 'flex';
  var inp = document.getElementById('cmdInput');
  if (inp) { inp.value = ''; inp.focus(); }
  filterCmd('');
}

function closeCmdPalette() {
  var el = document.getElementById('cmdPalette');
  if (el) el.style.display = 'none';
}

function filterCmd(q) {
  q = q.toLowerCase().trim();
  var items = _CMD_PAGES.filter(function(p) {
    if (p.adminOnly && (!currentUser || !currentUser.isAdmin)) return false;
    return !q || p.label.toLowerCase().includes(q) || (p.page && p.page.includes(q));
  });
  _cmdSelectedIdx = 0;
  var res = document.getElementById('cmdResults');
  if (!res) return;
  if (!items.length) {
    res.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted);font-size:13px">No results for "' + q + '"</div>';
    return;
  }
  res.innerHTML = items.slice(0, 10).map(function(item, i) {
    return '<div class="cmd-item" data-idx="' + i + '" onclick="runCmd(&quot; + JSON.stringify(item) + &quot;)" style="display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:10px;cursor:pointer;transition:background 0.1s;' + (i===0?'background:var(--surface2)':'') + '" onmouseover="highlightCmd(this,' + i + ')" onmouseout="if(_cmdSelectedIdx!=='+i+')this.style.background=\'\'"><span style="font-size:18px;width:24px;text-align:center">' + item.icon + '</span><span style="font-size:13px;font-weight:600">' + item.label + '</span>' + (item.page ? '<span style="margin-left:auto;font-size:10px;color:var(--muted);background:var(--surface3);padding:2px 8px;border-radius:6px">' + item.page + '</span>' : '') + '</div>';
  }).join('');
}

function highlightCmd(el, idx) {
  _cmdSelectedIdx = idx;
  document.querySelectorAll('.cmd-item').forEach(function(e, i) {
    e.style.background = i === idx ? 'var(--surface2)' : '';
  });
}

function cmdKeyNav(e) {
  var items = document.querySelectorAll('.cmd-item');
  if (e.key === 'ArrowDown') { e.preventDefault(); _cmdSelectedIdx = Math.min(_cmdSelectedIdx+1, items.length-1); items.forEach(function(el,i){el.style.background=i===_cmdSelectedIdx?'var(--surface2)':''}); }
  if (e.key === 'ArrowUp')   { e.preventDefault(); _cmdSelectedIdx = Math.max(_cmdSelectedIdx-1, 0); items.forEach(function(el,i){el.style.background=i===_cmdSelectedIdx?'var(--surface2)':''}); }
  if (e.key === 'Enter')     { e.preventDefault(); var sel = items[_cmdSelectedIdx]; if(sel) sel.click(); }
  if (e.key === 'Escape')    { closeCmdPalette(); }
}

function runCmd(item) {
  closeCmdPalette();
  if (item.page) { navTo(item.page); return; }
  if (item.action === 'logout') { logout(); return; }
  if (item.action === 'toggleTheme') { toggleTheme(); return; }
  if (item.action === 'reportBug') { document.getElementById('errorReportModal').classList.add('show'); return; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAILY LOGIN STREAK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkDailyStreak() {
  if (!currentUser) return;
  var today = new Date().toDateString();
  var last  = localStorage.getItem('tv_last_login_day') || '';
  var streak = parseInt(localStorage.getItem('tv_daily_streak') || '0');

  if (last === today) return; // already checked today

  var yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  var wasYesterday = (last === yesterday.toDateString());

  streak = wasYesterday ? streak + 1 : 1;
  localStorage.setItem('tv_daily_streak', streak);
  localStorage.setItem('tv_last_login_day', today);

  // XP bonus: 10 base + 5 per 7-day milestone
  var bonusXP = 10 + (streak % 7 === 0 ? 25 : 0);
  var cur = parseInt(localStorage.getItem('tv_xp_bonus') || '0');
  localStorage.setItem('tv_xp_bonus', cur + bonusXP);
  syncXPToUserRecord();
  updateXPSidebarChip();

  // Show streak modal
  var emoji = streak >= 30 ? 'ðŸ†' : streak >= 14 ? 'ðŸ’Ž' : streak >= 7 ? 'ðŸ”¥' : 'â­';
  var title = streak >= 30 ? streak + '-Day Legend!' : streak >= 7 ? streak + '-Day Streak!' : 'Welcome back!';
  var body  = streak >= 7
    ? 'You\'ve been creating for ' + streak + ' days straight. You\'re on fire! ðŸ”¥'
    : 'Day ' + streak + ' â€” keep showing up and watch your XP grow!';

  var modal = document.getElementById('streakModal');
  if (!modal) return;
  document.getElementById('streakEmoji').textContent = emoji;
  document.getElementById('streakTitle').textContent = title;
  document.getElementById('streakBody').textContent  = body;
  document.getElementById('streakXP').textContent    = '+' + bonusXP + ' XP' + (streak % 7 === 0 ? ' ðŸŽ‰ 7-day bonus!' : '');

  setTimeout(function() { modal.classList.add('show'); }, 2000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT SCRIPT AS .TXT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportScriptTxt(title, body) {
  var text = '='.repeat(60) + '\n';
  text += 'TRENDVID AI â€” Script Export\n';
  text += '='.repeat(60) + '\n\n';
  text += 'Title: ' + (title || 'Untitled') + '\n';
  text += 'Generated: ' + new Date().toLocaleDateString('en-GB', {weekday:'long',year:'numeric',month:'long',day:'numeric'}) + '\n\n';
  text += '-'.repeat(60) + '\n\n';
  text += (body || '').replace(/<[^>]+>/g, '') + '\n\n';
  text += '-'.repeat(60) + '\n';
  text += 'Generated by TrendVid AI â€” trendvid.ai\n';

  var blob = new Blob([text], {type:'text/plain'});
  var a    = document.createElement('a');
  a.href   = URL.createObjectURL(blob);
  a.download = (title || 'script').replace(/[^a-z0-9]/gi,'_').toLowerCase() + '_trendvid.txt';
  a.click();
  URL.revokeObjectURL(a.href);
  notify('Script exported as .txt âœ…', 'success', 'ðŸ“„');
  awardXP('exported_script');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SKELETON LOADING HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function skeletonLoader(lines) {
  lines = lines || 4;
  var html = '<div style="animation:pulse 1.5s ease infinite">';
  for (var i = 0; i < lines; i++) {
    var w = [90,75,85,60,80,70][i % 6];
    html += '<div style="height:14px;background:var(--surface2);border-radius:6px;margin-bottom:10px;width:' + w + '%"></div>';
  }
  html += '</div>';
  return html;
}

function showPageLoading() {
  var pc = document.getElementById('pageContent');
  if (pc) pc.innerHTML = '<div style="padding:32px 0">' + skeletonLoader(6) + '</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD SHORTCUTS â€” update to include Ctrl+K for palette
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', function(e) {
  if (!currentUser) return;
  // Open palette: Ctrl/Cmd + K
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    var palette = document.getElementById('cmdPalette');
    if (palette && palette.style.display !== 'none') { closeCmdPalette(); }
    else { openCmdPalette(); }
    return;
  }
  // Close palette on Escape
  if (e.key === 'Escape') {
    var palette2 = document.getElementById('cmdPalette');
    if (palette2 && palette2.style.display !== 'none') { closeCmdPalette(); return; }
  }
  // Other shortcuts â€” only when not typing
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
  if (e.ctrlKey || e.metaKey) {
    if (e.key === 't') { e.preventDefault(); navTo('trends'); }
    if (e.key === 'l') { e.preventDefault(); navTo('library'); }
    if (e.key === 'd') { e.preventDefault(); navTo('dashboard'); }
    if (e.key === ',') { e.preventDefault(); navTo('settings'); }
  }
});

// â”€â”€â”€ IMAGE LIBRARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var TV_LIB_KEY = 'tv_img_library';
var TV_LIB_MAX = 200;

function tvImgLibSave(dataUrl, prompt, source) {
  if (!dataUrl) return;
  try {
    var lib = JSON.parse(localStorage.getItem(TV_LIB_KEY) || '[]');
    // Avoid duplicates (same dataUrl within last 5 items)
    var recent = lib.slice(-5).map(function(x){ return x.dataUrl; });
    if (recent.indexOf(dataUrl) !== -1) return;
    lib.push({
      id: Date.now() + '_' + Math.floor(Math.random() * 9999),
      dataUrl: dataUrl,
      prompt: (prompt || '').substring(0, 120),
      source: source || 'unknown',
      createdAt: Date.now()
    });
    if (lib.length > TV_LIB_MAX) lib = lib.slice(lib.length - TV_LIB_MAX);
    localStorage.setItem(TV_LIB_KEY, JSON.stringify(lib));
    // Update nav button badge count
    var badge = document.getElementById('tvLibBadge');
    if (badge) badge.textContent = lib.length;
  } catch(e) { console.warn('[IMG LIB] Save failed:', e.message); }
}

function tvImgLibOpen() {
  if (!window.currentUser || !window.currentUser.isAdmin) {
    notify('Image Library is admin-only', 'error', 'ðŸ”’');
    return;
  }
  var lib;
  try { lib = JSON.parse(localStorage.getItem(TV_LIB_KEY) || '[]'); } catch(e) { lib = []; }
  if (!lib.length) { notify('No images saved yet â€” generate some first!', 'info', '\ud83d\uddbc\ufe0f'); return; }
  var blob = new Blob([tvImgLibHTML()], { type: 'text/html' });
  var url  = URL.createObjectURL(blob);
  var win  = window.open(url, '_blank');
  if (!win) notify('Pop-up blocked â€” please allow pop-ups for this page', 'error', '\ud83d\udeab');
  setTimeout(function(){ URL.revokeObjectURL(url); }, 15000);
}

function tvImgLibHTML() {
  // Build the gallery page as a self-contained HTML string.
  // Reads library data live from window.opener.localStorage on load.
  var S = '<scri' + 'pt>';
  var E = '</scri' + 'pt>';
  var h = '';
  h += '<!DOCTYPE html><html lang="en"><head>';
  h += '<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">';
  h += '<title>TrendVid Image Library</title>';
  h += '<style>';
  h += '*{box-sizing:border-box;margin:0;padding:0}';
  h += 'body{background:#060810;color:#eef2ff;font-family:system-ui,sans-serif;min-height:100vh}';
  h += '.hdr{background:#0c0f1a;border-bottom:1px solid #1e2538;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}';
  h += '.logo{font-size:18px;font-weight:900;color:#ff7b00}';
  h += '.btns{display:flex;gap:8px}';
  h += 'button{padding:7px 14px;border-radius:9px;border:none;cursor:pointer;font-size:12px;font-weight:700;transition:all .15s}';
  h += '.bp{background:linear-gradient(135deg,#ff3058,#ff7b00);color:#fff}';
  h += '.bg{background:rgba(255,255,255,.08);color:#eef2ff;border:1px solid rgba(255,255,255,.12)}';
  h += 'button:hover{filter:brightness(1.12);transform:translateY(-1px)}';
  h += '.bar{padding:10px 24px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;border-bottom:1px solid #1e2538;background:#0a0d16}';
  h += 'input{background:#111520;border:1px solid #1e2538;color:#eef2ff;padding:7px 12px;border-radius:9px;font-size:12px;min-width:200px;outline:none}';
  h += 'select{background:#111520;border:1px solid #1e2538;color:#eef2ff;padding:7px 11px;border-radius:9px;font-size:12px;cursor:pointer}';
  h += '.cnt{font-size:11px;color:#566380;margin-left:auto}';
  h += '.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;padding:18px 24px}';
  h += '.card{background:#0c0f1a;border:1px solid #1e2538;border-radius:12px;overflow:hidden;position:relative;transition:all .15s}';
  h += '.card:hover{border-color:#2a3350;transform:translateY(-2px);box-shadow:0 10px 36px rgba(0,0,0,.55)}';
  h += '.card img{width:100%;display:block;aspect-ratio:16/9;object-fit:cover;cursor:pointer}';
  h += '.info{padding:9px 11px}';
  h += '.ptxt{font-size:11px;color:#a8b8d8;line-height:1.45;margin-bottom:5px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}';
  h += '.row{display:flex;align-items:center;justify-content:space-between}';
  h += '.tag{font-size:10px;font-weight:700;padding:2px 7px;border-radius:5px}';
  h += '.t-ig{background:rgba(255,48,88,.15);color:#ff7088}';
  h += '.t-vs{background:rgba(0,229,176,.12);color:#00e5b0}';
  h += '.t-uk{background:rgba(120,120,140,.15);color:#999}';
  h += '.date{font-size:10px;color:#566380}';
  h += '.ov{position:absolute;top:6px;right:6px;display:flex;gap:5px;opacity:0;transition:opacity .15s}';
  h += '.card:hover .ov{opacity:1}';
  h += '.ob{width:28px;height:28px;border-radius:7px;border:none;cursor:pointer;font-size:12px;background:rgba(0,0,0,.75);color:#fff;display:flex;align-items:center;justify-content:center}';
  h += '.ob:hover{transform:scale(1.12)}';
  h += '.empty{text-align:center;padding:80px;color:#566380}';
  h += '.empty p{margin-top:10px;font-size:14px}';
  h += '.lb{display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:200;align-items:center;justify-content:center}';
  h += '.lb.on{display:flex}';
  h += '.lb img{max-width:92vw;max-height:88vh;object-fit:contain;border-radius:10px}';
  h += '.lx{position:fixed;top:16px;right:16px;width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.1);border:none;color:#fff;font-size:16px;cursor:pointer}';
  h += '.lx:hover{background:rgba(255,48,88,.4)}';
  h += '.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#0c0f1a;border:1px solid rgba(0,229,176,.4);color:#00e5b0;padding:9px 18px;border-radius:9px;font-size:12px;font-weight:700;z-index:500;opacity:0;transition:opacity .2s;pointer-events:none}';
  h += '.toast.on{opacity:1}';
  h += '</style></head><body>';
  h += '<div class="hdr">';
  h += '  <span class="logo">&#x1F5BC; TrendVid Image Library</span>';
  h += '  <div class="btns">';
  h += '    <button class="bg" onclick="doExport()">&#x2B07; Export All</button>';
  h += '    <button class="bg" onclick="doClear()">&#x1F5D1; Clear All</button>';
  h += '    <button class="bp" onclick="window.close()">&#x2715; Close</button>';
  h += '  </div>';
  h += '</div>';
  h += '<div class="bar">';
  h += '  <input id="q" type="text" placeholder="Search prompts..." oninput="render()">';
  h += '  <select id="src" onchange="render()">';
  h += '    <option value="">All Sources</option>';
  h += '    <option value="image-gen">Image Generator</option>';
  h += '    <option value="video-scene">Video Scenes</option>';
  h += '  </select>';
  h += '  <select id="ord" onchange="render()">';
  h += '    <option value="new">Newest First</option>';
  h += '    <option value="old">Oldest First</option>';
  h += '  </select>';
  h += '  <span class="cnt" id="cnt"></span>';
  h += '</div>';
  h += '<div class="grid" id="grid"></div>';
  h += '<div class="empty" id="emp" style="display:none">';
  h += '  <div style="font-size:52px">&#x1F4ED;</div><p>No images found</p>';
  h += '</div>';
  h += '<div class="lb" id="lb" onclick="if(event.target===this)clb()">';
  h += '  <button class="lx" onclick="clb()">&#x2715;</button>';
  h += '  <img id="lbimg" src="" alt="">';
  h += '</div>';
  h += '<div class="toast" id="toast"></div>';
  h += S;
  h += 'var KEY="tv_img_library",imgs=[],view=[];';
  h += 'function load(){try{var s=(window.opener&&window.opener.localStorage&&window.opener.localStorage.getItem(KEY))||localStorage.getItem(KEY)||"[]";imgs=JSON.parse(s)||[];}catch(e){imgs=[];}}';
  h += 'function save(){try{var d=JSON.stringify(imgs);if(window.opener&&window.opener.localStorage)window.opener.localStorage.setItem(KEY,d);localStorage.setItem(KEY,d);}catch(e){}}';
  h += 'function render(){load();';
  h += '  var q=document.getElementById("q").value.toLowerCase();';
  h += '  var sr=document.getElementById("src").value;';
  h += '  var od=document.getElementById("ord").value;';
  h += '  view=imgs.filter(function(x){return(!sr||x.source===sr)&&(!q||(x.prompt||"").toLowerCase().indexOf(q)>-1);});';
  h += '  if(od==="new")view=view.slice().reverse();';
  h += '  document.getElementById("cnt").textContent=view.length+" / "+imgs.length+" images";';
  h += '  var el=document.getElementById("grid"),em=document.getElementById("emp");';
  h += '  if(!view.length){el.innerHTML="";em.style.display="block";return;}';
  h += '  em.style.display="none";';
  h += '  el.innerHTML=view.map(function(x,i){';
  h += '    var tc=x.source==="image-gen"?"t-ig":x.source==="video-scene"?"t-vs":"t-uk";';
  h += '    var tl=x.source==="image-gen"?"Image Gen":x.source==="video-scene"?"Scene":"Other";';
  h += '    var dt=x.createdAt?new Date(x.createdAt).toLocaleDateString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"";';
  h += '    var p=(x.prompt||"").replace(/</g,"&lt;").substring(0,90);';
  h += '    return "<div class=\"card\">" +';
  h += '      "<img src=\""+x.dataUrl+"\" loading=\"lazy\" onclick=\"olb("+i+")\">" +';
  h += '      "<div class=\"ov\">" +';
  h += '        "<div class=\"ob\" onclick=\"dl("+i+")\" title=\"Download\">&#x2B07;</div>" +';
  h += '        "<div class=\"ob\" onclick=\"olb("+i+")\" title=\"Fullscreen\">&#x1F50D;</div>" +';
  h += '        "<div class=\"ob\" data-del=\""+x.id+"\" onclick=\"del(this.dataset.del)\" title=\"Delete\">&#x1F5D1;</div>" +';
  h += '      "</div>" +';
  h += '      "<div class=\"info\"><div class=\"ptxt\">"+p+"</div>" +';
  h += '      "<div class=\"row\"><span class=\"tag "+tc+"\">"+tl+"</span>" +';
  h += '      "<span class=\"date\">"+dt+"</span></div></div></div>";';
  h += '  }).join("");';
  h += '}';
  h += 'function olb(i){var x=view[i];if(!x)return;document.getElementById("lbimg").src=x.dataUrl;document.getElementById("lb").classList.add("on");}';
  h += 'function clb(){document.getElementById("lb").classList.remove("on");}';
  h += 'document.addEventListener("keydown",function(e){if(e.key==="Escape")clb();});';
  h += 'function dl(i){var x=view[i];if(!x)return;var a=document.createElement("a");a.href=x.dataUrl;a.download="trendvid-"+(x.source||"img")+"-"+(x.id||Date.now())+".jpg";document.body.appendChild(a);a.click();document.body.removeChild(a);toast("Downloaded!");}';
  h += 'function del(id){if(!confirm("Delete this image?"))return;imgs=imgs.filter(function(x){return x.id!==id;});save();render();toast("Deleted");}';
  h += 'function doExport(){if(!view.length){toast("Nothing to export");return;}';
  h += '  var htm="<html><head><style>body{background:#000;display:flex;flex-wrap:wrap;gap:10px;padding:16px;font-family:sans-serif} div{width:300px} img{width:100%;border-radius:8px} p{color:#aaa;font-size:11px;margin:4px 0 10px}</style></head><body>";';
  h += '  view.forEach(function(x){htm+="<div><img src=\""+x.dataUrl+"\" style=\"width:100%;border-radius:8px\"><p style=\"color:#aaa;font-size:11px;margin:4px 0 10px\">"+(x.prompt||"").substring(0,80)+"</p></div>";});';
  h += '  htm+="</body></html>";';
  h += '  var a=document.createElement("a");a.href=URL.createObjectURL(new Blob([htm],{type:"text/html"}));a.download="trendvid-images-export.html";document.body.appendChild(a);a.click();document.body.removeChild(a);';
  h += '  toast("Exported "+view.length+" images!");}';
  h += 'function doClear(){if(!confirm("Clear ALL "+imgs.length+" images from library? Cannot be undone."))return;imgs=[];save();render();toast("Cleared");}';
  h += 'function toast(m){var t=document.getElementById("toast");t.textContent=m;t.classList.add("on");setTimeout(function(){t.classList.remove("on");},2200);}';
  h += 'render();';
  h += 'setInterval(function(){render();},3000);';
  h += E;
  h += '</body></html>';
  return h;
}

// â”€â”€ Inject "Image Library" nav button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function injectLibNav() {
  function inject() {
    if (!window.currentUser || !window.currentUser.isAdmin) return;
    if (document.getElementById('tvLibNavBtn')) return;
    var allNavBtns = document.querySelectorAll('.nav-item[data-page]');
    var imgBtn = null;
    allNavBtns.forEach(function(b) { if (b.dataset.page === 'imagegen') imgBtn = b; });
    if (!imgBtn) return;
    var count = 0;
    try { count = JSON.parse(localStorage.getItem(TV_LIB_KEY) || '[]').length; } catch(e) {}
    var btn = document.createElement('button');
    btn.id = 'tvLibNavBtn';
    btn.className = 'nav-item';
    btn.setAttribute('data-page', '_library');
    btn.style.cssText = 'background:linear-gradient(135deg,rgba(255,123,0,.07),rgba(255,48,88,.05));border:1px solid rgba(255,123,0,.18)';
    btn.innerHTML = '<span class="icon">&#x1F5BC;</span>Image Library <span id="tvLibBadge" class="nav-badge" style="background:linear-gradient(135deg,#ff7b00,#ff3058);color:#fff;font-weight:900">' + (count || '') + '</span>';
    btn.onclick = tvImgLibOpen;
    imgBtn.parentNode.insertBefore(btn, imgBtn.nextSibling);
    // Also inject into mobile nav if present
    var mobileNav = document.querySelectorAll('[onclick*="navTo"]');
    mobileNav.forEach(function(mb) {
      if (mb.parentNode && !mb.parentNode.querySelector('[id="tvLibNavBtnM"]')) {
        var mb2 = btn.cloneNode(true);
        mb2.id = 'tvLibNavBtnM';
        mb2.onclick = tvImgLibOpen;
        mb.parentNode.insertBefore(mb2, mb.nextSibling);
      }
    });
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', inject);
  else inject();
  setTimeout(inject, 500);
  setTimeout(inject, 1500);
})();



</script>

<!-- STRIPE CONFIG SEED (pre-populated links) -->
<script>
(function(){
  try {
    var existing = JSON.parse(localStorage.getItem('tv_stripe_cfg') || '{}');
    if (!existing.links) existing.links = {};
    if (!existing.links.starter) existing.links.starter = 'https://buy.stripe.com/test_4gMdRa4su0Ozc8HgMY2ZO00';
    if (!existing.links.pro) existing.links.pro = 'https://buy.stripe.com/test_14A9AU7EGcxh8WvfIU2ZO01';
    if (!existing.links.gold) existing.links.gold = 'https://buy.stripe.com/test_fZu6oI0ce40Lb4DeEQ2ZO02';
    if (!existing.links.elite) existing.links.elite = 'https://buy.stripe.com/test_8x24gA1giap94GfaoA2ZO03';
    if (!existing.links.starter_annual) existing.links.starter_annual = 'https://buy.stripe.com/test_14A4gA6ACap9fkTbsE2ZO04';
    if (!existing.links.pro_annual) existing.links.pro_annual = 'https://buy.stripe.com/test_3cI14oaQS7cX5KjeEQ2ZO05';
    if (!existing.links.gold_annual) existing.links.gold_annual = 'https://buy.stripe.com/test_9B614o6ACap97SrgMY2ZO06';
    if (!existing.links.elite_annual) existing.links.elite_annual = 'https://buy.stripe.com/test_5kQ3cwgbc7cX5KjfIU2ZO07';
    if (!existing.creditLink1) existing.creditLink1 = 'https://buy.stripe.com/test_cNi28s5wybtd3Cb9kw2ZO0i';
    if (!existing.creditLink10) existing.creditLink10 = 'https://buy.stripe.com/test_00waEY2kmdBldcL0O02ZO0j';
    if (!existing.creditLink25) existing.creditLink25 = 'https://buy.stripe.com/test_9B6bJ29MO54P2y70O02ZO0k';
    if (!existing.uploadCreditLink5) existing.uploadCreditLink5 = 'https://buy.stripe.com/test_00w9AU1gi2WH6OnbsE2ZO0l';
    if (!existing.uploadCreditLink15) existing.uploadCreditLink15 = 'https://buy.stripe.com/test_bJe14o7EG40L3Cb8gs2ZO0m';
    if (!existing.uploadCreditLink50) existing.uploadCreditLink50 = 'https://buy.stripe.com/test_8x23cw6AC9l50pZeEQ2ZO0p';
    if (!existing.uploadCreditLink100) existing.uploadCreditLink100 = 'https://buy.stripe.com/test_7sY28sbUWdBl6On54g2ZO0n';
    if (!existing.uploadCreditLink500) existing.uploadCreditLink500 = 'https://buy.stripe.com/test_bJe7sM1gi40L3Cb54g2ZO0o';
    localStorage.setItem('tv_stripe_cfg', JSON.stringify(existing));
  } catch(e) {}
})();
</script>

<!-- COOKIE CONSENT BANNER -->
<div id="cookieBanner" style="display:none;position:fixed;bottom:0;left:0;right:0;z-index:99999;background:var(--surface);border-top:1px solid var(--border);padding:14px 20px;box-shadow:0 -8px 32px rgba(0,0,0,0.4)">
  <div style="max-width:900px;margin:0 auto;display:flex;align-items:center;gap:16px;flex-wrap:wrap">
    <div style="flex:1;min-width:200px">
      <div style="font-size:13px;font-weight:700;margin-bottom:3px">ðŸª We use cookies</div>
      <div style="font-size:12px;color:var(--muted)">We use essential cookies to keep you logged in and remember your preferences. No tracking, no ads. <a href="#" onclick="showPrivacyPolicy();return false" style="color:var(--accent)">Privacy Policy</a></div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('cookieBanner').style.display='none';localStorage.setItem('tv_cookies_declined','1')">Decline</button>
      <button class="btn btn-primary btn-sm" onclick="document.getElementById('cookieBanner').style.display='none';localStorage.setItem('tv_cookies_ok','1')">Accept All âœ“</button>
    </div>
  </div>
</div>

<!-- PRIVACY POLICY MODAL -->
<div class="modal-overlay" id="privacyModal" style="z-index:99998">
  <div class="modal-box" style="max-width:600px;max-height:80vh;overflow-y:auto">
    <div style="font-size:24px;font-weight:900;font-family:var(--font-display);margin-bottom:4px">Privacy Policy</div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:20px">Last updated: January 2025</div>
    <div style="font-size:13px;color:var(--text2);line-height:1.8">
      <p style="font-weight:700;color:var(--text);margin-bottom:8px">Data Storage</p>
      <p style="margin-bottom:16px">All your data â€” scripts, preferences, settings â€” is stored locally on your device using localStorage. We do not upload your content to any server.</p>
      <p style="font-weight:700;color:var(--text);margin-bottom:8px">AI Processing</p>
      <p style="margin-bottom:16px">When you use AI features, your prompts are sent to Groq (llama-3.3-70b) or Google Gemini via their APIs. These providers have their own privacy policies. We do not store your prompts on our servers.</p>
      <p style="font-weight:700;color:var(--text);margin-bottom:8px">Cookies</p>
      <p style="margin-bottom:16px">We use only essential localStorage for app functionality. No advertising or tracking cookies.</p>
      <p style="font-weight:700;color:var(--text);margin-bottom:8px">Your Rights</p>
      <p style="margin-bottom:16px">You can clear all your data at any time from Settings â†’ Clear Data. Email <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="28404d444447685c5a4d464c5e414c064941">[email&#160;protected]</a> for any data requests.</p>
      <p style="font-weight:700;color:var(--text);margin-bottom:8px">Contact</p>
      <p><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d7bfb2bbbbb897a3a5b2b9b3a1beb3f9b6be">[email&#160;protected]</a></p>
    </div>
    <button class="btn btn-primary" style="width:100%;margin-top:20px" onclick="document.getElementById('privacyModal').classList.remove('show')">Close</button>
  </div>
</div>

<!-- TERMS OF SERVICE MODAL -->
<div class="modal-overlay" id="termsModal" style="z-index:99998">
  <div class="modal-box" style="max-width:600px;max-height:80vh;overflow-y:auto">
    <div style="font-size:24px;font-weight:900;font-family:var(--font-display);margin-bottom:4px">Terms of Service</div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:20px">Last updated: January 2025</div>
    <div style="font-size:13px;color:var(--text2);line-height:1.8">
      <p style="font-weight:700;color:var(--text);margin-bottom:8px">Use of Service</p>
      <p style="margin-bottom:16px">TrendVid AI is provided for content creation purposes. You agree not to use it to generate spam, harmful, or illegal content.</p>
      <p style="font-weight:700;color:var(--text);margin-bottom:8px">Content Ownership</p>
      <p style="margin-bottom:16px">All scripts, ideas and content you generate belong to you. TrendVid claims no ownership over your outputs.</p>
      <p style="font-weight:700;color:var(--text);margin-bottom:8px">AI Accuracy</p>
      <p style="margin-bottom:16px">AI-generated content may contain errors. Always review scripts before publishing. TrendVid is not liable for inaccuracies.</p>
      <p style="font-weight:700;color:var(--text);margin-bottom:8px">Subscriptions</p>
      <p style="margin-bottom:16px">Paid plans are billed monthly or annually. Cancel anytime. No refunds for partial billing periods.</p>
      <p style="font-weight:700;color:var(--text);margin-bottom:8px">Termination</p>
      <p>We reserve the right to suspend accounts that violate these terms.</p>
    </div>
    <button class="btn btn-primary" style="width:100%;margin-top:20px" onclick="document.getElementById('termsModal').classList.remove('show')">Close</button>
  </div>
</div>


<!-- COMMAND PALETTE -->
<div id="cmdPalette" style="display:none;position:fixed;inset:0;z-index:99990;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)" onclick="if(event.target===this)closeCmdPalette()">
  <div style="position:absolute;top:15%;left:50%;transform:translateX(-50%);width:90%;max-width:520px;background:var(--surface);border:1px solid var(--border2);border-radius:20px;box-shadow:0 24px 80px rgba(0,0,0,0.7);overflow:hidden">
    <div style="display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--border)">
      <span style="font-size:18px;color:var(--muted)">ðŸ”</span>
      <input id="cmdInput" placeholder="Search pages, tools, actionsâ€¦" autocomplete="off" style="flex:1;background:none;border:none;outline:none;font-size:15px;color:var(--text);font-family:inherit" oninput="filterCmd(this.value)" onkeydown="cmdKeyNav(event)">
      <span style="font-size:11px;color:var(--muted);background:var(--surface2);padding:2px 8px;border-radius:6px;border:1px solid var(--border)">ESC</span>
    </div>
    <div id="cmdResults" style="max-height:340px;overflow-y:auto;padding:8px"></div>
  </div>
</div>

<!-- ===== PUSH NOTIFICATIONS SYSTEM ===== -->
<div class="modal-overlay" id="notifPermModal">
  <div class="modal-box" style="max-width:400px;text-align:center">
    <div style="font-size:54px;margin-bottom:12px">ðŸ””</div>
    <div style="font-family:var(--font-display);font-size:22px;font-weight:900;margin-bottom:8px">Stay in the Loop!</div>
    <div style="font-size:13px;color:var(--text2);margin-bottom:20px;line-height:1.6">Get notified about viral trend alerts, your daily content reminders, XP milestones, and new AI features â€” right on your device.</div>
    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;text-align:left">
      <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--surface2);border-radius:12px;border:1px solid var(--border)">
        <span style="font-size:20px">ðŸ”¥</span>
        <div>
          <div style="font-size:13px;font-weight:700">Daily Trend Alerts</div>
          <div style="font-size:11px;color:var(--muted)">Get notified when a new viral trend hits</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--surface2);border-radius:12px;border:1px solid var(--border)">
        <span style="font-size:20px">â­</span>
        <div>
          <div style="font-size:13px;font-weight:700">XP & Level-Up Alerts</div>
          <div style="font-size:11px;color:var(--muted)">Celebrate every milestone you hit</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--surface2);border-radius:12px;border:1px solid var(--border)">
        <span style="font-size:20px">ðŸ“…</span>
        <div>
          <div style="font-size:13px;font-weight:700">Content Calendar Reminders</div>
          <div style="font-size:11px;color:var(--muted)">Never miss a scheduled post</div>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" style="flex:1" onclick="denyNotifPerm()">Not Now</button>
      <button class="btn btn-primary" style="flex:1" onclick="requestNotifPerm()">ðŸ”” Enable Alerts</button>
    </div>
  </div>
</div>

<!-- Notification Settings Panel (inside Settings page, injected dynamically) -->
<script>
// ============================================================
// TRENDVID NOTIFICATION SYSTEM
// ============================================================
(function(){
  'use strict';

  const TV_NOTIF_KEY = 'tv_notif_settings';

  // Default settings
  function getNotifSettings() {
    try {
      return JSON.parse(localStorage.getItem(TV_NOTIF_KEY) || '{}');
    } catch(e) { return {}; }
  }
  function saveNotifSettings(s) {
    try { localStorage.setItem(TV_NOTIF_KEY, JSON.stringify(s)); } catch(e) {}
  }

  // ---- Admin-only gate ----
  function isAdminUser() {
    return !!(window.currentUser && window.currentUser.isAdmin);
  }

  // ---- Permission helpers ----
  window.requestNotifPerm = async function() {
    if (!isAdminUser()) return; // admin only
    document.getElementById('notifPermModal').classList.remove('show');
    if (!('Notification' in window)) {
      tvToast('âš ï¸ Your browser does not support notifications.', 'error');
      return;
    }
    const result = await Notification.requestPermission();
    if (result === 'granted') {
      const s = getNotifSettings();
      s.enabled = true;
      s.trends = true;
      s.xp = true;
      s.calendar = true;
      s.dailyHour = 9; // 9 AM
      saveNotifSettings(s);
      tvToast('ðŸ”” Notifications enabled! You\'re all set.', 'success');
      scheduleAllNotifications();
    } else {
      tvToast('Notifications blocked. You can enable them in browser settings.', 'warning');
    }
  };

  window.denyNotifPerm = function() {
    if (!isAdminUser()) return;
    document.getElementById('notifPermModal').classList.remove('show');
    const s = getNotifSettings();
    s.dismissed = true;
    saveNotifSettings(s);
  };

  // ---- Show the permission prompt (admin only) ----
  function maybePromptForNotifications() {
    if (!isAdminUser()) return;
    if (!('Notification' in window)) return;
    const s = getNotifSettings();
    if (s.enabled || s.dismissed) return;
    if (Notification.permission === 'granted') {
      s.enabled = true;
      saveNotifSettings(s);
      scheduleAllNotifications();
      return;
    }
    if (Notification.permission === 'denied') return;
    // Show our custom prompt after 30 seconds of using the app
    setTimeout(() => {
      if (!isAdminUser()) return; // double-check at trigger time
      document.getElementById('notifPermModal').classList.add('show');
    }, 30000);
  }

  // ---- Fire a notification ----
  function fireNotification(title, body, icon, tag) {
    if (!('Notification' in window) || Notification.permission !== 'granted') return;
    const s = getNotifSettings();
    if (!s.enabled) return;
    try {
      const n = new Notification(title, {
        body: body,
        icon: icon || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="22" fill="%23060810"/><text y=".9em" font-size="80" x="10">ðŸŽ¬</text></svg>',
        badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="22" fill="%23ff3058"/><text y=".9em" font-size="60" x="20">T</text></svg>',
        tag: tag || 'trendvid',
        requireInteraction: false,
        silent: false
      });
      n.onclick = function() { window.focus(); n.close(); };
    } catch(e) { console.warn('Notification error:', e); }
  }

  // ---- Trend alert (fires immediately as demo, then scheduled) ----
  const TREND_MESSAGES = [
    { title: 'ðŸ”¥ Trending NOW on TikTok!', body: '"Grocery store challenge" is exploding â€” script it in TrendVid before it peaks!' },
    { title: 'ðŸ“ˆ YouTube Trend Alert', body: '"Day in the life" vlogs are surging this week. Tap to generate your script!' },
    { title: 'âš¡ Viral Opportunity', body: 'AI reaction videos are up 340% â€” get ahead of the curve with TrendVid AI!' },
    { title: 'ðŸŽ¯ Trending Topic Detected', body: '"Budget travel hacks" is trending on 3 platforms. Create your content now!' },
    { title: 'ðŸš€ Breakout Trend Alert', body: 'Short-form storytelling formats are going viral. Don\'t miss the wave!' },
  ];

  function fireTrendNotification() {
    const s = getNotifSettings();
    if (!s.trends) return;
    const msg = TREND_MESSAGES[Math.floor(Math.random() * TREND_MESSAGES.length)];
    fireNotification(msg.title, msg.body, null, 'tv-trend');
  }

  // ---- XP / milestone notifications ----
  window.tvNotifyXP = function(xpAmount, newTotal) {
    if (!isAdminUser()) return;
    const s = getNotifSettings();
    if (!s.enabled || !s.xp) return;
    if (document.visibilityState === 'visible') return; // only notify when app is in background
    fireNotification(
      'â­ XP Earned!',
      `You just earned ${xpAmount} XP on TrendVid! Total: ${newTotal} XP. Keep creating!`,
      null, 'tv-xp'
    );
  };

  window.tvNotifyLevelUp = function(newLevel, title) {
    if (!isAdminUser()) return;
    const s = getNotifSettings();
    if (!s.enabled || !s.xp) return;
    fireNotification(
      'ðŸŽ‰ Level Up! You\'re now Level ' + newLevel,
      `New title unlocked: "${title}" â€” keep up the momentum on TrendVid!`,
      null, 'tv-levelup'
    );
  };

  // ---- Daily reminder ----
  function fireDailyReminder() {
    const s = getNotifSettings();
    if (!s.calendar) return;
    const msgs = [
      "ðŸ“… Time to create! Your content calendar is waiting â€” what are you posting today?",
      "ðŸŽ¬ Daily creator check-in! Open TrendVid and knock out today's script.",
      "ðŸ”¥ Don't break your streak! Log in to TrendVid and earn your daily XP bonus.",
      "ðŸ’¡ Fresh AI trends are ready for you. Tap to see what's viral today!"
    ];
    fireNotification(
      'ðŸ“… TrendVid Daily Reminder',
      msgs[Math.floor(Math.random() * msgs.length)],
      null, 'tv-daily'
    );
  }

  // ---- Scheduler using setTimeout loops ----
  function msUntilHour(hour) {
    const now = new Date();
    const target = new Date();
    target.setHours(hour, 0, 0, 0);
    if (target <= now) target.setDate(target.getDate() + 1);
    return target - now;
  }

  function scheduleDailyReminder() {
    const s = getNotifSettings();
    if (!s.enabled) return;
    const hour = (typeof s.dailyHour === 'number') ? s.dailyHour : 9;
    const ms = msUntilHour(hour);
    setTimeout(function loop() {
      fireDailyReminder();
      setTimeout(loop, 24 * 60 * 60 * 1000);
    }, ms);
  }

  function scheduleTrendAlerts() {
    const s = getNotifSettings();
    if (!s.enabled || !s.trends) return;
    // Fire trend alerts every ~6 hours (spread randomly Â±30 min)
    function loop() {
      const delay = (6 * 60 * 60 * 1000) + (Math.random() * 60 - 30) * 60 * 1000;
      setTimeout(() => { fireTrendNotification(); loop(); }, delay);
    }
    // First trend alert after 2 hours
    setTimeout(() => { fireTrendNotification(); loop(); }, 2 * 60 * 60 * 1000);
  }

  window.scheduleAllNotifications = function() {
    scheduleDailyReminder();
    scheduleTrendAlerts();
  };

  // ---- Test notification (callable from settings) ----
  window.sendTestNotification = function() {
    if (!isAdminUser()) { tvToast('Admin access required.', 'error'); return; }
    if (!('Notification' in window)) { tvToast('Notifications not supported in this browser.', 'error'); return; }
    if (Notification.permission !== 'granted') {
      tvToast('Please enable notifications first.', 'warning');
      return;
    }
    fireNotification(
      'ðŸ”” TrendVid Test Notification',
      'Notifications are working! You\'ll get trend alerts, XP updates, and daily reminders.',
      null, 'tv-test'
    );
    tvToast('Test notification sent! Check your device.', 'success');
  };

  // ---- Toggle helpers for settings UI ----
  window.toggleNotifSetting = function(key, checked) {
    if (!isAdminUser()) return;
    const s = getNotifSettings();
    s[key] = checked;
    saveNotifSettings(s);
    if (key === 'enabled') {
      if (checked) {
        if (Notification.permission !== 'granted') {
          requestNotifPerm();
        } else {
          scheduleAllNotifications();
          tvToast('ðŸ”” Notifications enabled!', 'success');
        }
      } else {
        tvToast('Notifications turned off.', 'info');
      }
    }
  };

  window.setNotifHour = function(val) {
    if (!isAdminUser()) return;
    const s = getNotifSettings();
    s.dailyHour = parseInt(val);
    saveNotifSettings(s);
    tvToast('Daily reminder time updated!', 'success');
  };

  window.getNotifSettings = getNotifSettings;

  // ---- Inject notification settings into the settings panel ----
  function injectNotifSettingsPanel() {
    // Find a good injection point: look for a settings section container
    const settingsContent = document.querySelector('#page-settings .settings-section, #settingsPage .settings-section, [data-page="settings"] .settings-section');
    if (!settingsContent) return; // page not rendered yet

    if (document.getElementById('tvNotifSettingsBlock')) return; // already injected

    const s = getNotifSettings();
    const isEnabled = s.enabled && Notification.permission === 'granted';
    const hour = typeof s.dailyHour === 'number' ? s.dailyHour : 9;
    const hourLabel = (h) => {
      const ampm = h < 12 ? 'AM' : 'PM';
      const h12 = h === 0 ? 12 : h > 12 ? h - 12 : h;
      return `${h12}:00 ${ampm}`;
    };

    const block = document.createElement('div');
    block.id = 'tvNotifSettingsBlock';
    block.style.cssText = 'margin-top:24px;';
    block.innerHTML = `
      <div class="settings-section-title" style="font-family:var(--font-display);font-size:15px;font-weight:800;margin-bottom:14px;display:flex;align-items:center;gap:8px;">ðŸ”” Push Notifications</div>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:16px;padding:18px;display:flex;flex-direction:column;gap:14px;">

        <div style="display:flex;align-items:center;justify-content:space-between;">
          <div>
            <div style="font-size:13px;font-weight:700;">Enable Notifications</div>
            <div style="font-size:11px;color:var(--muted);">Get alerts even when the tab is in the background</div>
          </div>
          <label class="toggle-switch" style="position:relative;display:inline-block;width:44px;height:24px;cursor:pointer;">
            <input type="checkbox" ${isEnabled?'checked':''} style="opacity:0;width:0;height:0;" onchange="toggleNotifSetting('enabled',this.checked)">
            <span style="position:absolute;inset:0;background:${isEnabled?'var(--accent)':'var(--border2)'};border-radius:24px;transition:0.2s;"></span>
            <span style="position:absolute;top:3px;left:${isEnabled?'23px':'3px'};width:18px;height:18px;background:#fff;border-radius:50%;transition:0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.3);"></span>
          </label>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:0;">

        <div style="display:flex;align-items:center;justify-content:space-between;">
          <div>
            <div style="font-size:13px;font-weight:700;">ðŸ”¥ Trend Alerts</div>
            <div style="font-size:11px;color:var(--muted);">Viral trend notifications every few hours</div>
          </div>
          <label class="toggle-switch" style="position:relative;display:inline-block;width:44px;height:24px;cursor:pointer;">
            <input type="checkbox" ${s.trends!==false?'checked':''} style="opacity:0;width:0;height:0;" onchange="toggleNotifSetting('trends',this.checked)">
            <span style="position:absolute;inset:0;background:${s.trends!==false?'var(--accent)':'var(--border2)'};border-radius:24px;transition:0.2s;"></span>
            <span style="position:absolute;top:3px;left:${s.trends!==false?'23px':'3px'};width:18px;height:18px;background:#fff;border-radius:50%;transition:0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.3);"></span>
          </label>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;">
          <div>
            <div style="font-size:13px;font-weight:700;">â­ XP & Level-Up Alerts</div>
            <div style="font-size:11px;color:var(--muted);">Know when you earn XP or level up</div>
          </div>
          <label class="toggle-switch" style="position:relative;display:inline-block;width:44px;height:24px;cursor:pointer;">
            <input type="checkbox" ${s.xp!==false?'checked':''} style="opacity:0;width:0;height:0;" onchange="toggleNotifSetting('xp',this.checked)">
            <span style="position:absolute;inset:0;background:${s.xp!==false?'var(--accent)':'var(--border2)'};border-radius:24px;transition:0.2s;"></span>
            <span style="position:absolute;top:3px;left:${s.xp!==false?'23px':'3px'};width:18px;height:18px;background:#fff;border-radius:50%;transition:0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.3);"></span>
          </label>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;">
          <div>
            <div style="font-size:13px;font-weight:700;">ðŸ“… Daily Reminder</div>
            <div style="font-size:11px;color:var(--muted);">A nudge to keep your streak alive</div>
          </div>
          <label class="toggle-switch" style="position:relative;display:inline-block;width:44px;height:24px;cursor:pointer;">
            <input type="checkbox" ${s.calendar!==false?'checked':''} style="opacity:0;width:0;height:0;" onchange="toggleNotifSetting('calendar',this.checked)">
            <span style="position:absolute;inset:0;background:${s.calendar!==false?'var(--accent)':'var(--border2)'};border-radius:24px;transition:0.2s;"></span>
            <span style="position:absolute;top:3px;left:${s.calendar!==false?'23px':'3px'};width:18px;height:18px;background:#fff;border-radius:50%;transition:0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.3);"></span>
          </label>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <div>
            <div style="font-size:13px;font-weight:700;">â° Daily Reminder Time</div>
            <div style="font-size:11px;color:var(--muted);">When to send your daily nudge</div>
          </div>
          <select class="form-input form-select" style="width:auto;min-width:110px;font-size:12px;padding:6px 10px;" onchange="setNotifHour(this.value)">
            ${[6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21].map(h=>`<option value="${h}" ${h===hour?'selected':''}>${hourLabel(h)}</option>`).join('')}
          </select>
        </div>

        <button class="btn btn-ghost btn-sm" style="align-self:flex-start;font-size:12px;" onclick="sendTestNotification()">ðŸ”” Send Test Notification</button>

        ${Notification.permission==='denied'?`<div style="background:rgba(255,48,88,0.08);border:1px solid rgba(255,48,88,0.3);border-radius:10px;padding:10px 12px;font-size:11px;color:var(--text2);">âš ï¸ Notifications are <strong>blocked</strong> in your browser. To enable them, click the lock/info icon in your browser's address bar and allow notifications for this site, then reload.</div>`:''}
      </div>
    `;

    // Inject after the first settings section
    settingsContent.parentNode.insertBefore(block, settingsContent.nextSibling);
  }

  // Watch for settings page to become visible (admin only)
  const observer = new MutationObserver(() => {
    if (!isAdminUser()) return;
    const settingsEl = document.querySelector('#page-settings, #settingsPage, [data-page="settings"]');
    if (settingsEl && (settingsEl.style.display !== 'none' && !settingsEl.hidden)) {
      injectNotifSettingsPanel();
    }
  });
  observer.observe(document.body, { childList: true, subtree: true, attributes: true, attributeFilter: ['style','class'] });

  // ---- Init on load ----
  window.addEventListener('load', () => {
    if (!isAdminUser()) return; // notifications are admin-only
    const s = getNotifSettings();
    if (s.enabled && Notification.permission === 'granted') {
      scheduleAllNotifications();
    } else {
      maybePromptForNotifications();
    }
  });

  // Expose for external use
  window.tvNotifications = {
    fire: function(title, body) { fireNotification(title, body); },
    trendAlert: fireTrendNotification,
    settings: getNotifSettings
  };

})();
</script>
<!-- ===== END PUSH NOTIFICATIONS SYSTEM ===== -->


<script>
// Admin-only nav visibility
(function() {
  function applyAdminNav() {
    var isAdmin = !!(window.currentUser && window.currentUser.isAdmin);
    var btn = document.getElementById('imagegenNavBtn');
    if (btn) btn.style.display = isAdmin ? '' : 'none';
    var libBtn = document.getElementById('tvLibNavBtn');
    if (libBtn) libBtn.style.display = isAdmin ? '' : 'none';
  }
  window.addEventListener('load', function() { setTimeout(applyAdminNav, 800); setTimeout(applyAdminNav, 2000); });
  var _applied = false;
  var obs = new MutationObserver(function() {
    if (window.currentUser && !_applied) { _applied = true; applyAdminNav(); }
  });
  obs.observe(document.body, { childList: true, subtree: true });
  window._applyAdminNav = applyAdminNav;
})();
</script>

<!-- WELCOME BANNER -->
<div id="welcomeBanner" style="display:none;position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9999;background:linear-gradient(135deg,var(--surface),var(--surface2));border:1px solid rgba(0,212,170,0.35);border-radius:14px;padding:14px 20px;box-shadow:0 8px 32px rgba(0,0,0,0.4);display:flex;align-items:center;gap:14px;min-width:320px;max-width:480px;animation:slideDown 0.4s ease">
  <div style="font-size:26px" id="welcomeBannerEmoji">ðŸ‘‹</div>
  <div style="flex:1">
    <div style="font-weight:800;font-size:14px;font-family:var(--font-display)" id="welcomeBannerTitle">Hey, Creator!</div>
    <div style="font-size:12px;color:var(--muted)" id="welcomeBannerSub">Welcome to TrendVid. Let's go viral ðŸš€</div>
  </div>
  <button onclick="dismissWelcomeBanner()" style="background:none;border:none;cursor:pointer;color:var(--muted);font-size:18px;padding:0;line-height:1;flex-shrink:0" title="Dismiss">âœ•</button>
</div>


<!-- TRENDVID BRANDED WATERMARK TOAST -->
<div id="tvWatermarkToast" style="display:none;position:fixed;bottom:80px;right:20px;z-index:8888;background:linear-gradient(135deg,#0d0f1a,#1a1e2e);border:1px solid rgba(255,48,88,0.4);border-radius:12px;padding:12px 16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);animation:slideUp 0.4s ease;max-width:240px">
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
    <div style="font-size:16px;font-family:var(--font-display);font-weight:900;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent">TREND<span style="-webkit-text-fill-color:var(--teal)">VID</span></div>
    <div style="font-size:9px;color:var(--muted);font-weight:700;letter-spacing:1px">MADE WITH</div>
  </div>
  <div style="font-size:11px;color:var(--muted)">Find us at <span style="color:var(--accent)">trendvid.ai</span></div>
</div>


<!-- ERROR REPORT MODAL -->
<div class="modal-overlay" id="errorReportModal">
  <div class="modal-box" style="max-width:440px">
    <div style="font-size:28px;margin-bottom:8px">ðŸ›</div>
    <div class="modal-title" style="margin-bottom:4px">Report an Issue</div>
    <div class="modal-sub">Your report goes directly to the TrendVid team</div>
    <div class="form-field" style="margin-top:16px">
      <label>What went wrong?</label>
      <select class="form-input form-select" id="reportType">
        <option value="ai_wrong">AI gave wrong/bad response</option>
        <option value="ai_down">AI stopped working</option>
        <option value="ui_bug">UI/display bug</option>
        <option value="feature_broken">Feature not working</option>
        <option value="other">Other</option>
      </select>
    </div>
    <div class="form-field">
      <label>Describe what happened</label>
      <textarea class="form-input" id="reportDesc" rows="4" placeholder="e.g. The script generator returned empty output when I clicked Generate..."></textarea>
    </div>
    <div class="form-field" style="margin-bottom:20px">
      <label>Your email (optional â€” for follow-up)</label>
      <input class="form-input" id="reportEmail" type="email" placeholder="you@email.com">
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-primary" style="flex:1" onclick="submitErrorReport()">ðŸ“¤ Send Report</button>
      <button class="btn btn-ghost" onclick="document.getElementById('errorReportModal').classList.remove('show')">Cancel</button>
    </div>
  </div>
</div>


<!-- YOUTUBE API AUTO-SEED (pre-populated credentials) -->
<script>
(function(){
  try {
    var auCfg = JSON.parse(localStorage.getItem('tv_autoupload_cfg') || '{}');
    if(!auCfg.youtube) auCfg.youtube = {};
    // Auto-inject the YouTube OAuth Client ID if not already set by admin
    if(!auCfg.youtube.clientId) {
      auCfg.youtube.clientId = '887174058350-2hvp00joohr5m5lmi6sfc72opk2d8647.apps.googleusercontent.com';
    }
    localStorage.setItem('tv_autoupload_cfg', JSON.stringify(auCfg));
  } catch(e) {}
})();
</script>
<!-- DAILY STREAK MODAL -->
<div class="modal-overlay" id="streakModal">
  <div class="modal-box" style="max-width:360px;text-align:center">
    <div style="font-size:56px;margin-bottom:8px" id="streakEmoji">ðŸ”¥</div>
    <div style="font-family:var(--font-display);font-size:22px;font-weight:900;margin-bottom:6px" id="streakTitle">Day Streak!</div>
    <div style="font-size:14px;color:var(--muted);margin-bottom:20px" id="streakBody">Keep coming back every day to earn bonus XP!</div>
    <div style="background:rgba(255,138,0,0.1);border:1px solid rgba(255,138,0,0.35);border-radius:12px;padding:12px 20px;margin-bottom:20px">
      <div id="streakXP" style="font-family:var(--font-display);font-size:20px;font-weight:900;color:var(--accent2)">+10 XP</div>
      <div style="font-size:11px;color:var(--muted);margin-top:2px">Daily login bonus</div>
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="document.getElementById('streakModal').classList.remove('show')">ðŸ”¥ Keep It Up!</button>
  </div>
</div>

<!-- ===== AI SELF-HEALING SYSTEM v2 ===== -->
<script>
(function() {
  'use strict';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  SHARED STATE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var LOG        = [];
  var COOLDOWNS  = {};       // key â†’ timestamp
  var TOTAL_FIXED = 0;
  var BUSY       = {};       // agentId â†’ bool
  var _badge     = null;
  var _panel     = null;
  var MODEL      = 'claude-sonnet-4-20250514';

  function ts() {
    var d=new Date(); var p=function(n){return n<10?'0'+n:n;};
    return p(d.getHours())+':'+p(d.getMinutes())+':'+p(d.getSeconds());
  }
  function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function onCooldown(key,ms){ var t=COOLDOWNS[key]; return t && (Date.now()-t)<(ms||20000); }
  function setCooldown(key){ COOLDOWNS[key]=Date.now(); }

  function log(type,agent,label,detail){
    LOG.push({type:type,agent:agent,label:label,detail:String(detail||'').substring(0,160),time:ts()});
    if(LOG.length>60) LOG.shift();
    if(type==='fix') TOTAL_FIXED++;
    refreshPanel();
  }

  // â”€â”€ Anthropic API helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function ai(prompt, maxTokens) {
    var r = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:MODEL,max_tokens:maxTokens||600,
        messages:[{role:'user',content:prompt}]})
    });
    if(!r.ok) throw new Error('API '+r.status);
    var d=await r.json();
    return (d.content||[]).map(function(c){return c.text||'';}).join('').trim();
  }

  async function aiJSON(prompt, maxTokens) {
    var text = await ai(prompt, maxTokens);
    text = text.replace(/^```[\w]*\n?/,'').replace(/\n?```$/,'').trim();
    return JSON.parse(text);
  }

  function safeExec(code) {
    (new Function(code))();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  BADGE + PANEL UI
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var AGENT_META = {
    btn:   { icon:'ðŸ”§', color:'#00e5b0', label:'Button Fixer'     },
    perf:  { icon:'âš¡', color:'#a78bfa', label:'Perf Monitor'     },
    ls:    { icon:'ðŸ’¾', color:'#fbbf24', label:'Storage Guard'    },
    ui:    { icon:'ðŸŽ¨', color:'#f472b6', label:'UI Doctor'        },
    nav:   { icon:'ðŸ§­', color:'#60a5fa', label:'Nav Watchdog'     },
    err:   { icon:'ðŸ›¡ï¸', color:'#fb923c', label:'Error Shield'     }
  };
  var _activeAgents = {};  // agentId â†’ 'idle'|'working'|'fixed'

  // â”€â”€â”€ CSS for pre-login Fix button (injected once) â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (function injectHealCSS(){
    if(document.getElementById('tvHealCSS')) return;
    var s=document.createElement('style');
    s.id='tvHealCSS';
    s.textContent=
      '@keyframes tvHealPulseRing{0%{transform:scale(1);opacity:0.6}70%{transform:scale(1.55);opacity:0}100%{transform:scale(1.55);opacity:0}}'+
      '@keyframes tvHealShimmer{0%{background-position:-200% center}100%{background-position:200% center}}'+
      '@keyframes tvHealBounceIn{0%{opacity:0;transform:scale(0.5) translateY(20px)}60%{transform:scale(1.08) translateY(-4px)}100%{opacity:1;transform:scale(1) translateY(0)}}'+
      '@keyframes tvHealShrink{0%{opacity:1;transform:scale(1) translateY(0)}100%{opacity:0;transform:scale(0.4) translateY(24px)}}'+
      '@keyframes tvHealOrbIn{0%{opacity:0;transform:scale(0.3) translateY(20px)}60%{transform:scale(1.12) translateY(-4px)}100%{opacity:1;transform:scale(1) translateY(0)}}'+
      '#tvHealFixBtn{position:fixed;bottom:20px;right:20px;z-index:99995;cursor:pointer;user-select:none;display:flex;align-items:center;gap:10px;'+
        'background:linear-gradient(135deg,#060810 0%,#111520 100%);'+
        'border:1.5px solid rgba(0,229,176,0.45);'+
        'border-radius:50px;padding:12px 20px 12px 14px;'+
        'box-shadow:0 8px 32px rgba(0,0,0,0.6),0 0 0 0 rgba(0,229,176,0.3);'+
        'animation:tvHealBounceIn 0.55s cubic-bezier(0.34,1.56,0.64,1) both;'+
        'transition:transform 0.18s ease,box-shadow 0.18s ease,border-color 0.18s ease;}'+
      '#tvHealFixBtn:hover{transform:translateY(-3px) scale(1.03);box-shadow:0 12px 40px rgba(0,0,0,0.7),0 0 24px rgba(0,229,176,0.25);border-color:rgba(0,229,176,0.75);}'+
      '#tvHealFixBtn:active{transform:translateY(0) scale(0.97);}'+
      '#tvHealFixBtn .tv-fix-icon{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#00e5b0,#a78bfa);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;box-shadow:0 2px 10px rgba(0,229,176,0.4);}'+
      '#tvHealFixBtn .tv-fix-ring{position:absolute;width:34px;height:34px;border-radius:50%;background:rgba(0,229,176,0.25);animation:tvHealPulseRing 2.2s ease-out infinite;pointer-events:none;}'+
      '#tvHealFixBtn .tv-fix-label{display:flex;flex-direction:column;gap:1px;}'+
      '#tvHealFixBtn .tv-fix-title{font-family:"Syne",sans-serif;font-size:13px;font-weight:900;letter-spacing:0.3px;color:#eef2ff;line-height:1;}'+
      '#tvHealFixBtn .tv-fix-sub{font-size:10px;color:rgba(0,229,176,0.75);font-weight:700;letter-spacing:0.2px;line-height:1;}'+
      '#tvHealFixBtn.working{border-color:rgba(255,138,0,0.6);}'+
      '#tvHealFixBtn.working .tv-fix-icon{background:linear-gradient(135deg,#ff3058,#ff7b00);}'+
      '#tvHealFixBtn.done{border-color:rgba(0,229,176,0.8);}'+
      '#tvHealBadge{position:fixed;bottom:20px;right:20px;z-index:99995;cursor:pointer;user-select:none;display:none;}'+
      '#tvHealBadge.visible{display:block;animation:tvHealOrbIn 0.5s cubic-bezier(0.34,1.56,0.64,1) both;}';
    document.head.appendChild(s);
  })();

  // â”€â”€â”€ Pre-login "Fix Everything" button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function ensureFixBtn() {
    if(document.getElementById('tvHealFixBtn')) return;
    var btn = document.createElement('div');
    btn.id = 'tvHealFixBtn';
    btn.innerHTML =
      '<div class="tv-fix-ring"></div>'+
      '<div class="tv-fix-icon">âœ¨</div>'+
      '<div class="tv-fix-label">'+
        '<div class="tv-fix-title">Fix Everything</div>'+
        '<div class="tv-fix-sub">AI Self-Heal Â· Ready</div>'+
      '</div>';
    btn.onclick = function() {
      if(btn.classList.contains('working')) return;
      btn.classList.add('working');
      btn.querySelector('.tv-fix-icon').textContent = 'âš¡';
      btn.querySelector('.tv-fix-title').textContent = 'Fixingâ€¦';
      btn.querySelector('.tv-fix-sub').textContent = 'Running all agents';
      // Fire all agents
      var agents = [agentButtonFixer, agentNavWatchdog, agentStorageGuard, agentUIDoctor, agentErrorShield];
      Promise.allSettled(agents.map(function(a){ return a(); })).then(function() {
        btn.classList.remove('working');
        btn.classList.add('done');
        btn.querySelector('.tv-fix-icon').textContent = 'âœ…';
        btn.querySelector('.tv-fix-title').textContent = 'All Fixed!';
        btn.querySelector('.tv-fix-sub').textContent = (TOTAL_FIXED > 0 ? TOTAL_FIXED + ' issue' + (TOTAL_FIXED > 1 ? 's' : '') + ' patched' : 'Everything looks great');
        setTimeout(function() {
          btn.classList.remove('done');
          btn.querySelector('.tv-fix-icon').textContent = 'âœ¨';
          btn.querySelector('.tv-fix-title').textContent = 'Fix Everything';
          btn.querySelector('.tv-fix-sub').textContent = 'AI Self-Heal Â· Ready';
        }, 3500);
      });
    };
    document.body.appendChild(btn);
  }

  // â”€â”€â”€ Post-login orb â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function ensureBadge() {
    if(_badge) return;
    _badge = document.createElement('div');
    _badge.id = 'tvHealBadge';
    _badge.innerHTML =
      '<div id="tvHealOrb" style="width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,#00e5b0,#a78bfa);display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 20px rgba(0,229,176,0.4);border:2px solid rgba(255,255,255,0.15);transition:all 0.3s;">ðŸ¤–</div>'+
      '<div id="tvHealCount" style="position:absolute;top:-4px;right:-4px;min-width:18px;height:18px;background:#ff3058;border-radius:9px;font-size:10px;font-weight:900;color:#fff;display:none;align-items:center;justify-content:center;font-family:var(--font-display,sans-serif);padding:0 4px;border:2px solid #060810;"></div>';
    _badge.onclick = function() {
      if (window.currentUser && window.currentUser.isAdmin) {
        if (typeof navTo === 'function') navTo('admin');
        setTimeout(function() { window._adminTab = 'selfheal'; if (typeof renderAdmin === 'function') renderAdmin(); }, 300);
      } else {
        var fixes = TOTAL_FIXED;
        var msg = fixes > 0
          ? 'ðŸ¤– AI Self-Heal: ' + fixes + ' issue' + (fixes > 1 ? 's' : '') + ' fixed automatically âœ…'
          : 'ðŸ¤– AI Self-Heal is actively monitoring the app ðŸ‘€';
        if (typeof notify === 'function') notify(msg, fixes > 0 ? 'success' : 'info', 'ðŸ¤–');
      }
    };
    document.body.appendChild(_badge);
  }

  // â”€â”€â”€ Switch from Fix-btn â†’ orb on login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window._tvHealSwitchToOrb = function() {
    var fixBtn = document.getElementById('tvHealFixBtn');
    if(fixBtn) {
      fixBtn.style.animation = 'tvHealShrink 0.35s cubic-bezier(0.4,0,0.2,1) both';
      setTimeout(function(){ fixBtn.remove(); }, 360);
    }
    ensureBadge();
    setTimeout(function(){
      var b = document.getElementById('tvHealBadge');
      if(b) b.classList.add('visible');
    }, 380);
  };

  function setOrb(state, agentId) {
    var orb = document.getElementById('tvHealOrb');
    if(!orb) return;
    if(agentId) _activeAgents[agentId] = state;
    var anyWorking = Object.values(_activeAgents).indexOf('working') !== -1;
    var anyFixed   = !anyWorking && Object.values(_activeAgents).indexOf('fixed') !== -1;
    if(anyWorking){
      orb.style.background='linear-gradient(135deg,#ff3058,#ff7b00)';
      orb.style.boxShadow='0 4px 24px rgba(255,48,88,0.6)';
      orb.innerHTML='<div style="width:18px;height:18px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 0.7s linear infinite"></div>';
    } else if(anyFixed){
      orb.style.background='linear-gradient(135deg,#00e5b0,#00c990)';
      orb.style.boxShadow='0 4px 24px rgba(0,229,176,0.6)';
      orb.innerHTML='âœ…';
      setTimeout(function(){ setOrb('idle'); }, 2500);
    } else {
      orb.style.background='linear-gradient(135deg,#00e5b0,#a78bfa)';
      orb.style.boxShadow='0 4px 20px rgba(0,229,176,0.35)';
      orb.innerHTML='ðŸ¤–';
      Object.keys(_activeAgents).forEach(function(k){ _activeAgents[k]='idle'; });
    }
    var cnt = document.getElementById('tvHealCount');
    if(cnt){ if(TOTAL_FIXED>0){cnt.style.display='flex';cnt.textContent=TOTAL_FIXED;}else{cnt.style.display='none';} }
  }

  function togglePanel() {
    if(_panel && document.body.contains(_panel)){ _panel.remove();_panel=null;return; }
    buildPanel();
  }

  function buildPanel() {
    if(_panel) _panel.remove();
    _panel=document.createElement('div');
    _panel.id='tvHealPanel';
    _panel.style.cssText='position:fixed;bottom:76px;right:18px;z-index:99994;width:360px;max-height:500px;overflow-y:auto;background:var(--surface,#0c0f1a);border:1px solid var(--border2,#2a3350);border-radius:18px;padding:18px;box-shadow:0 16px 48px rgba(0,0,0,0.7);font-family:DM Sans,sans-serif;font-size:12px;color:var(--text,#eef2ff);';

    // Agent status row
    var agentRow = Object.keys(AGENT_META).map(function(id){
      var m=AGENT_META[id]; var st=_activeAgents[id]||'idle';
      var glow = st==='working'?'box-shadow:0 0 8px '+m.color+';':'';
      return '<div title="'+m.label+'" style="display:flex;flex-direction:column;align-items:center;gap:3px;padding:6px 4px;border-radius:10px;border:1px solid '+(st==='working'?m.color:'rgba(255,255,255,0.06)')+';background:'+(st==='working'?'rgba(0,0,0,0.3)':'transparent')+';'+glow+'">'
        +'<span style="font-size:15px">'+m.icon+'</span>'
        +'<span style="font-size:8px;color:'+(st==='working'?m.color:'var(--muted,#566380)')+';font-weight:700;text-align:center;line-height:1.2">'+m.label.split(' ')[0]+'</span>'
        +'<span style="width:6px;height:6px;border-radius:50%;background:'+(st==='working'?m.color:st==='fixed'?'#00e5b0':'rgba(255,255,255,0.15)')+';"></span>'
        +'</div>';
    }).join('');

    var logHtml = LOG.length ? LOG.slice().reverse().map(function(e){
      var m=AGENT_META[e.agent]||{icon:'ðŸ”¹',color:'#a78bfa'};
      var col = e.type==='fix'?'#00e5b0':e.type==='error'?'#ff3058':e.type==='warn'?'#fbbf24':m.color;
      return '<div style="display:flex;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.04)">'
        +'<span style="font-size:13px;flex-shrink:0">'+m.icon+'</span>'
        +'<div style="flex:1;min-width:0"><div style="color:'+col+';font-weight:700;font-size:11px;margin-bottom:1px">'+esc(e.label)+'</div>'
        +'<div style="color:var(--muted,#566380);font-size:10px;line-height:1.4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+esc(e.detail)+'</div></div>'
        +'<div style="color:var(--muted,#566380);font-size:9px;white-space:nowrap;flex-shrink:0">'+e.time+'</div></div>';
    }).join('') : '<div style="color:var(--muted,#566380);text-align:center;padding:24px 0;font-size:11px">All agents monitoring... ðŸ‘€</div>';

    _panel.innerHTML =
      '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">'
        +'<div style="font-weight:900;font-size:14px;background:linear-gradient(135deg,#00e5b0,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">ðŸ¤– AI Self-Heal v2</div>'
        +'<div style="display:flex;gap:8px;align-items:center">'
          +'<span style="font-size:10px;color:var(--muted,#566380)">'+TOTAL_FIXED+' fixed</span>'
          +'<button onclick="tvSelfHeal&&tvSelfHeal.panel()" style="background:none;border:none;color:var(--muted,#566380);cursor:pointer;font-size:18px;line-height:1;padding:0">&#x2715;</button>'
        +'</div></div>'
      +'<div style="display:grid;grid-template-columns:repeat(6,1fr);gap:5px;margin-bottom:14px">'+agentRow+'</div>'
      +'<div style="border-top:1px solid rgba(255,255,255,0.06);padding-top:10px">'+logHtml+'</div>';
    document.body.appendChild(_panel);
  }

  function refreshPanel(){ if(_panel && document.body.contains(_panel)){ buildPanel(); } }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  AGENT 1 â€” BUTTON FIXER  (existing, enhanced)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function agentButtonFixer() {
    if(BUSY.btn) return; BUSY.btn=true;
    try {
      var buttons = Array.from(document.querySelectorAll('button,[onclick],.btn,.nav-item'));
      var broken = [];
      buttons.forEach(function(el){
        if(el.disabled) return;
        var onclick = el.getAttribute('onclick')||'';
        if(!onclick) return;
        var m = onclick.match(/^([a-zA-Z_$][\w$]*)\s*\(/);
        if(m && typeof window[m[1]] !== 'function'){
          var key='btn_'+m[1];
          if(!onCooldown(key)) broken.push({key:key,text:(el.textContent||'').trim().substring(0,30),fn:m[1],onclick:onclick});
        }
      });
      // Critical functions check
      ['navTo','renderDashboard','renderScript','renderTrends','aiCall','notify'].forEach(function(fn){
        var key='fn_'+fn;
        if(typeof window[fn]!=='function' && !onCooldown(key)) broken.push({key:key,text:'[system]',fn:fn,onclick:null});
      });
      if(!broken.length){BUSY.btn=false;return;}
      // Deduplicate
      var seen={}; broken=broken.filter(function(b){if(seen[b.fn])return false;seen[b.fn]=true;return true;});
      setOrb('working','btn');
      log('info','btn','Broken buttons: '+broken.length, broken.map(function(b){return b.fn;}).join(', '));
      var avail=Object.keys(window).filter(function(k){return typeof window[k]==='function'&&/^[a-z]/.test(k)&&k.length<40;}).slice(0,60);
      var fixes = await aiJSON(
        'TrendVid app button fixer. Broken buttons:\n'+JSON.stringify(broken)+'\nAvailable window fns: '+avail.join(',')+
        '\nReturn ONLY JSON array: [{"fn":"name","fixCode":"window.name=function(){...};","explanation":"why"}]',800);
      var applied=0;
      (fixes||[]).forEach(function(fix){
        if(!fix||!fix.fixCode) return;
        try{ safeExec(fix.fixCode); log('fix','btn','Fixed: '+fix.fn,fix.explanation||''); setCooldown(fix.key||'btn_'+fix.fn); applied++; }
        catch(e){ log('error','btn','Fix failed: '+fix.fn,e.message); }
      });
      setOrb(applied?'fixed':'idle','btn');
      if(applied && typeof notify==='function') notify('ðŸ”§ Button fixer: repaired '+applied+' function'+(applied>1?'s':''),'success','ðŸ¤–');
    } catch(e){ log('error','btn','Agent error',e.message); setOrb('idle','btn'); }
    BUSY.btn=false;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  AGENT 2 â€” PERFORMANCE MONITOR
  //  Detects slow renders, janky loops, memory leaks
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var _perfSamples=[];
  var _longTaskCount=0;
  async function agentPerfMonitor() {
    if(BUSY.perf) return; BUSY.perf=true;
    try {
      // Sample page render time
      var t0=performance.now();
      await new Promise(function(r){requestAnimationFrame(function(){requestAnimationFrame(r);})});
      var frameMs = performance.now()-t0;
      _perfSamples.push(frameMs);
      if(_perfSamples.length>20) _perfSamples.shift();
      var avgFrame = _perfSamples.reduce(function(a,b){return a+b;},0)/_perfSamples.length;

      // Check for leaked intervals/timeouts (heuristic: count via a flag)
      var domNodes = document.querySelectorAll('*').length;
      var issues=[];
      if(avgFrame>100) issues.push('Slow frame time: '+Math.round(avgFrame)+'ms avg (target <16ms)');
      if(domNodes>8000) issues.push('DOM bloat: '+domNodes+' nodes (high)');

      // Check if any localStorage keys are enormous
      var lsSize=0; try{Object.keys(localStorage).forEach(function(k){lsSize+=(localStorage.getItem(k)||'').length;});}catch(e){}
      if(lsSize>2000000) issues.push('localStorage huge: '+Math.round(lsSize/1024)+'KB');

      if(!issues.length){BUSY.perf=false;return;}
      if(onCooldown('perf_'+issues[0].substring(0,20),60000)){BUSY.perf=false;return;}

      setOrb('working','perf');
      log('info','perf','Perf issues: '+issues.length,issues[0]);
      var advice = await ai(
        'TrendVid app performance issues:\n'+issues.join('\n')+'\n\n'
        +'Suggest ONE short JavaScript fix (max 3 lines) to improve performance. '
        +'Respond with ONLY a JSON object: {"fixCode":"...","explanation":"...","severity":"low|medium|high"}',400);
      advice=advice.replace(/^```[\w]*\n?/,'').replace(/\n?```$/,'').trim();
      var fix=JSON.parse(advice);
      if(fix.fixCode && fix.severity!=='low'){
        try{ safeExec(fix.fixCode); log('fix','perf','Perf fix applied',fix.explanation); setCooldown('perf_fix'); setOrb('fixed','perf'); }
        catch(e){ log('warn','perf','Perf fix skipped',e.message); setOrb('idle','perf'); }
      } else {
        log('warn','perf','Perf issue noted',fix.explanation);
        setCooldown('perf_'+issues[0].substring(0,20),60000);
        setOrb('idle','perf');
      }
    } catch(e){ log('error','perf','Agent error',e.message); setOrb('idle','perf'); }
    BUSY.perf=false;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  AGENT 3 â€” STORAGE GUARD
  //  Detects & repairs corrupted localStorage keys
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var TV_LS_SCHEMAS = {
    tv_scripts:    'array',
    tv_favs:       'array',
    tv_calendar:   'object',
    tv_user:       'object',
    tv_img_library:'array',
    tv_calendar_events:'array',
    tv_brand_kit:  'object',
    tv_hashtags:   'array'
  };
  async function agentStorageGuard() {
    if(BUSY.ls) return; BUSY.ls=true;
    try {
      var corrupted=[];
      Object.keys(TV_LS_SCHEMAS).forEach(function(key){
        var raw=localStorage.getItem(key);
        if(!raw) return;
        try {
          var val=JSON.parse(raw);
          var expected=TV_LS_SCHEMAS[key];
          if(expected==='array'&&!Array.isArray(val)) corrupted.push({key:key,expected:expected,got:typeof val,raw:raw.substring(0,60)});
          if(expected==='object'&&(typeof val!=='object'||Array.isArray(val)||val===null)) corrupted.push({key:key,expected:expected,got:typeof val,raw:raw.substring(0,60)});
        } catch(e){ corrupted.push({key:key,expected:TV_LS_SCHEMAS[key],got:'invalid JSON',raw:raw.substring(0,60)}); }
      });

      if(!corrupted.length){BUSY.ls=false;return;}
      if(onCooldown('ls_corrupt',30000)){BUSY.ls=false;return;}
      setOrb('working','ls');
      log('info','ls','Corrupted storage keys: '+corrupted.length,corrupted.map(function(c){return c.key;}).join(', '));

      var repairs = await aiJSON(
        'TrendVid localStorage corruption. Corrupted keys:\n'+JSON.stringify(corrupted)+'\n\n'
        +'For each key, generate a safe repair. Return ONLY JSON array: '
        +'[{"key":"...","fixCode":"localStorage.setItem(\'key\',JSON.stringify(...));","explanation":"..."}]',500);
      var applied=0;
      (repairs||[]).forEach(function(r){
        if(!r||!r.fixCode) return;
        try{ safeExec(r.fixCode); log('fix','ls','Storage repaired: '+r.key,r.explanation||''); applied++; }
        catch(e){ log('error','ls','Repair failed: '+r.key,e.message); }
      });
      setCooldown('ls_corrupt');
      setOrb(applied?'fixed':'idle','ls');
    } catch(e){ log('error','ls','Agent error',e.message); setOrb('idle','ls'); }
    BUSY.ls=false;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  AGENT 4 â€” UI DOCTOR
  //  Detects broken/invisible UI elements, z-index traps,
  //  stuck loading spinners, empty rendered pages
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function agentUIDoctor() {
    if(BUSY.ui) return; BUSY.ui=true;
    try {
      var issues=[];

      // Stuck spinners (visible for > 30s â€” we track with dataset)
      document.querySelectorAll('.spinner,.ai-thinking').forEach(function(el){
        if(!el.dataset.tvHealSeen){ el.dataset.tvHealSeen=Date.now(); return; }
        var age=Date.now()-parseInt(el.dataset.tvHealSeen);
        if(age>30000) issues.push({type:'stuck_spinner',selector:el.className,age:Math.round(age/1000)+'s'});
      });

      // Empty main content area
      var pc=document.getElementById('pageContent')||document.getElementById('page-content');
      if(pc && pc.innerHTML.trim().length<40 && document.body.classList.contains('app-loaded')){
        issues.push({type:'empty_page',html:pc.innerHTML.substring(0,60)});
      }

      // Broken images (src='' or onerror fired)
      var brokenImgs=Array.from(document.querySelectorAll('img')).filter(function(i){return i.complete&&i.naturalWidth===0&&i.src&&!i.src.startsWith('data:');});
      if(brokenImgs.length>3) issues.push({type:'broken_images',count:brokenImgs.length});

      // Modal stuck open (has .show class but no close btn visible)
      document.querySelectorAll('.modal-overlay.show,.modal.show').forEach(function(m){
        if(!m.dataset.tvHealSeen){ m.dataset.tvHealSeen=Date.now(); return; }
        var age=Date.now()-parseInt(m.dataset.tvHealSeen);
        if(age>60000) issues.push({type:'stuck_modal',id:m.id,age:Math.round(age/1000)+'s'});
      });

      if(!issues.length){BUSY.ui=false;return;}
      if(onCooldown('ui_'+issues[0].type,45000)){BUSY.ui=false;return;}

      setOrb('working','ui');
      log('info','ui','UI issues: '+issues.length, issues[0].type);

      var fix = await aiJSON(
        'TrendVid UI issues:\n'+JSON.stringify(issues)+'\n\n'
        +'Generate ONE JavaScript fix. The app uses navTo(page), notify(msg,type,icon). '
        +'Return ONLY JSON: {"fixCode":"...","explanation":"..."}',400);
      if(fix&&fix.fixCode){
        try{ safeExec(fix.fixCode); log('fix','ui','UI fixed: '+issues[0].type,fix.explanation||''); setCooldown('ui_'+issues[0].type); setOrb('fixed','ui'); }
        catch(e){ log('error','ui','UI fix failed',e.message); setOrb('idle','ui'); }
      } else { setOrb('idle','ui'); }
    } catch(e){ log('error','ui','Agent error',e.message); setOrb('idle','ui'); }
    BUSY.ui=false;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  AGENT 5 â€” NAV WATCHDOG
  //  Verifies every nav button leads to a working page,
  //  re-registers missing page renderers
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function agentNavWatchdog() {
    if(BUSY.nav) return; BUSY.nav=true;
    try {
      var navBtns=Array.from(document.querySelectorAll('.nav-item[data-page]'));
      var dead=[];
      navBtns.forEach(function(btn){
        var page=btn.dataset.page;
        if(!page||page==='_library') return;
        // Check render fn exists
        var renderFn='render'+page.charAt(0).toUpperCase()+page.slice(1);
        var altFns={dashboard:'renderDashboard',script:'renderScript',trends:'renderTrends',admin:'renderAdmin',imagegen:'renderImageGen'};
        var fn=altFns[page]||renderFn;
        if(typeof window[fn]!=='function' && typeof window[renderFn]!=='function'){
          var key='nav_'+page;
          if(!onCooldown(key)) dead.push({page:page,expectedFn:fn,key:key});
        }
      });

      if(!dead.length){BUSY.nav=false;return;}
      setOrb('working','nav');
      log('info','nav','Dead nav pages: '+dead.length, dead.map(function(d){return d.page;}).join(', '));

      var fixes = await aiJSON(
        'TrendVid nav pages with missing render functions:\n'+JSON.stringify(dead)+'\n\n'
        +'For each page, create a stub render function that shows a placeholder UI using the pageContent div. '
        +'Use document.getElementById("pageContent") and navTo() is available. '
        +'Return ONLY JSON array: [{"page":"...","fn":"...","fixCode":"window.fn=function(){...};","explanation":"..."}]',600);
      var applied=0;
      (fixes||[]).forEach(function(fix){
        if(!fix||!fix.fixCode) return;
        try{ safeExec(fix.fixCode); log('fix','nav','Nav restored: '+fix.page,fix.explanation||''); setCooldown(fix.key||'nav_'+fix.page); applied++; }
        catch(e){ log('error','nav','Nav fix failed: '+(fix.page||''),e.message); }
      });
      setOrb(applied?'fixed':'idle','nav');
    } catch(e){ log('error','nav','Agent error',e.message); setOrb('idle','nav'); }
    BUSY.nav=false;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  AGENT 6 â€” ERROR SHIELD
  //  Intercepts console errors, uncaught promises, and
  //  generates proactive patches before users notice
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var _errQueue=[];
  var _errProcessing=false;

  // Patch console.error
  var _origConsoleError=console.error;
  console.error=function(){
    _origConsoleError.apply(console,arguments);
    var msg=Array.from(arguments).map(function(a){return String(a);}).join(' ');
    if(msg.length<5||msg.indexOf('tvHeal')!==-1) return;
    _errQueue.push({type:'console',msg:msg.substring(0,200),time:Date.now()});
  };

  // Patch unhandledrejection
  window.addEventListener('unhandledrejection',function(e){
    var msg=e.reason&&e.reason.message?e.reason.message:String(e.reason||'');
    _errQueue.push({type:'promise',msg:msg.substring(0,200),time:Date.now()});
  });

  // Patch window.onerror
  var _origOnError=window.onerror;
  window.onerror=function(msg,src,line,col,err){
    if(String(msg).indexOf('tvHeal')===-1){
      _errQueue.push({type:'error',msg:String(msg).substring(0,200),src:(src||'').split('/').pop(),line:line,time:Date.now()});
      // Trigger immediate button heal if it's a missing function
      var fnMatch=String(msg).match(/"?([\w$]+)"? is not (defined|a function)/);
      if(fnMatch && !BUSY.btn){ setTimeout(agentButtonFixer,80); }
    }
    if(typeof _origOnError==='function') return _origOnError.apply(this,arguments);
    return false;
  };

  async function agentErrorShield() {
    if(BUSY.err||_errProcessing) return;
    // Drain queue â€” collect errors from last 10s
    var cutoff=Date.now()-10000;
    var recent=_errQueue.filter(function(e){return e.time>cutoff;});
    _errQueue=_errQueue.filter(function(e){return e.time>cutoff;}); // keep recent only
    if(!recent.length){BUSY.err=false;return;}
    BUSY.err=true; _errProcessing=true;

    // Deduplicate similar errors
    var seen={}; var unique=recent.filter(function(e){
      var k=e.msg.substring(0,50); if(seen[k]) return false; seen[k]=true; return true;
    });
    if(onCooldown('err_'+unique[0].msg.substring(0,20),25000)){BUSY.err=false;_errProcessing=false;return;}

    setOrb('working','err');
    log('info','err','Errors caught: '+unique.length,unique[0].msg.substring(0,80));
    try {
      var avail=Object.keys(window).filter(function(k){return typeof window[k]==='function'&&/^[a-z]/.test(k)&&k.length<40;}).slice(0,50);
      var fix = await aiJSON(
        'TrendVid runtime errors:\n'+JSON.stringify(unique)+'\n\nAvailable fns: '+avail.join(',')+'\n\n'
        +'Generate a proactive JavaScript patch to prevent these errors recurring. '
        +'Return ONLY JSON: {"fixCode":"...","explanation":"...","confidence":0-100}',500);
      if(fix&&fix.fixCode&&(fix.confidence||0)>=60){
        try{ safeExec(fix.fixCode); log('fix','err','Error patched',fix.explanation||''); setCooldown('err_'+unique[0].msg.substring(0,20)); setOrb('fixed','err'); }
        catch(e){ log('error','err','Patch failed',e.message); setOrb('idle','err'); }
      } else {
        log('warn','err','Error logged (low confidence fix)',fix&&fix.explanation||unique[0].msg.substring(0,60));
        setCooldown('err_'+unique[0].msg.substring(0,20));
        setOrb('idle','err');
      }
    } catch(e){ log('error','err','Shield error',e.message); setOrb('idle','err'); }
    BUSY.err=false; _errProcessing=false;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  SCHEDULER â€” stagger agents to avoid API bursts
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  window.addEventListener('load',function(){
    ensureFixBtn();  // Pre-login: show "Fix Everything" pill
    log('info','btn','Self-Heal v2 online','6 agents active: Button, Perf, Storage, UI, Nav, Error Shield');

    // Staggered initial scans
    setTimeout(agentButtonFixer,   3000);
    setTimeout(agentNavWatchdog,   5000);
    setTimeout(agentStorageGuard,  7000);
    setTimeout(agentUIDoctor,      9000);
    setTimeout(agentPerfMonitor,  12000);

    // Recurring intervals (staggered so they don't all fire at once)
    setInterval(function(){ if(!document.hidden) agentButtonFixer();  },  8000);
    setInterval(function(){ if(!document.hidden) agentNavWatchdog();  }, 15000);
    setInterval(function(){ if(!document.hidden) agentStorageGuard(); }, 30000);
    setInterval(function(){ if(!document.hidden) agentUIDoctor();     }, 20000);
    setInterval(function(){ if(!document.hidden) agentPerfMonitor();  }, 25000);
    setInterval(function(){ if(!document.hidden) agentErrorShield();  },  6000);

    // DOM mutation â†’ re-scan buttons & nav
    var _t=null;
    new MutationObserver(function(muts){
      if(muts.some(function(m){return Array.from(m.addedNodes).some(function(n){return n.nodeType===1&&(n.tagName==='BUTTON'||n.querySelector&&n.querySelector('button,[onclick]'));});})){
        clearTimeout(_t); _t=setTimeout(agentButtonFixer,1200);
      }
    }).observe(document.body,{childList:true,subtree:true});
  });

  // â”€â”€â”€ Public API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.tvSelfHeal = {
    scan:    agentButtonFixer,
    panel:   togglePanel,
    log:     function(){ return LOG.slice(); },
    fixes:   function(){ return TOTAL_FIXED; },
    agents:  { btn:agentButtonFixer, perf:agentPerfMonitor, ls:agentStorageGuard, ui:agentUIDoctor, nav:agentNavWatchdog, err:agentErrorShield }
  };

})();
</script>
<!-- ===== END AI SELF-HEALING SYSTEM ===== -->

</body>
</html>
